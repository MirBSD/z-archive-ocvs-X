head	1.17;
access;
symbols;
locks; strict;
comment	@# @;


1.17
date	2003.03.23.20.20.52;	author tg;	state dead;
branches;
next	1.16;

1.16
date	2003.03.22.22.33.25;	author tg;	state Exp;
branches;
next	1.15;

1.15
date	2003.03.07.18.06.48;	author tg;	state Exp;
branches;
next	1.14;

1.14
date	2003.03.04.16.52.26;	author tg;	state Exp;
branches;
next	1.13;

1.13
date	2003.03.02.01.08.32;	author tg;	state Exp;
branches;
next	1.12;

1.12
date	2003.03.01.13.40.21;	author tg;	state Exp;
branches;
next	1.11;

1.11
date	2003.03.01.13.16.05;	author tg;	state Exp;
branches;
next	1.10;

1.10
date	2003.03.01.10.05.33;	author tg;	state Exp;
branches;
next	1.9;

1.9
date	2003.03.01.00.08.27;	author tg;	state Exp;
branches;
next	1.8;

1.8
date	2003.02.28.18.22.09;	author tg;	state Exp;
branches;
next	1.7;

1.7
date	2003.02.24.21.32.06;	author tg;	state Exp;
branches;
next	1.6;

1.6
date	2003.02.23.22.04.07;	author tg;	state Exp;
branches;
next	1.5;

1.5
date	2003.02.23.20.05.15;	author tg;	state Exp;
branches;
next	1.4;

1.4
date	2003.02.23.17.59.43;	author tg;	state Exp;
branches;
next	1.3;

1.3
date	2003.02.23.16.13.25;	author tg;	state Exp;
branches;
next	1.2;

1.2
date	2003.02.23.16.03.21;	author tg;	state Exp;
branches;
next	1.1;

1.1
date	2003.02.23.16.00.18;	author tg;	state Exp;
branches;
next	;


desc
@@


1.17
log
@sync everything over to MirBSD-new
@
text
@Index: src/sys/arch/i386/conf/DISKLESS
===================================================================
RCS file: /cvs/src/sys/arch/i386/conf/DISKLESS,v
retrieving revision 1.48
diff -u -r1.48 DISKLESS
--- src/sys/arch/i386/conf/DISKLESS	10 Dec 2002 23:36:41 -0000	1.48
+++ src/sys/arch/i386/conf/DISKLESS	7 Mar 2003 16:59:34 -0000
@@@@ -1,3 +1,4 @@@@
+#	$MirBSD: obsd.kernel,v 1.16 2003/03/22 22:33:25 tg Exp $
 #	$OpenBSD: DISKLESS,v 1.48 2002/12/10 23:37:03 miod Exp $
 #	$NetBSD: DISKLESS,v 1.26 1996/05/20 18:17:16 mrg Exp $
 #
@@@@ -12,7 +13,7 @@@@
 option		I486_CPU
 option		I586_CPU
 option		I686_CPU
-option		GPL_MATH_EMULATE	# floating point emulation
+#option		GPL_MATH_EMULATE	# floating point emulation, taints the kernel
 
 #option		VM86		# Virtual 8086 emulation
 #option		USER_LDT	# user-settable LDT; used by WINE
@@@@ -23,6 +24,7 @@@@
 
 option		BOOT_CONFIG	# add support for boot -c
 #option		DUMMY_NOPS	# speed hack; recommended
+option		INCLUDE_CONFIG_FILE	# store this file in the kernel
 #makeoptions	DEBUG="-g"	# compile full symbol table
 #makeoptions	PROF="-pg"	# build profiled kernel
 #option		GPROF		# kernel profiling, kgmon(8)
@@@@ -173,7 +175,7 @@@@
 aue*	at uhub? port ?			# ADMtek AN986 Pegasus Ethernet
 cue*	at uhub? port ?			# CATC USB-EL1201A based Ethernet
 kue*	at uhub? port ?			# Kawasaki KL5KUSB101B based Ethernet
-upl*	at uhub? port ?			# Prolific PL2301/PL2302 host-to-host `network'
+upl*	at uhub? port ?			# Prolific PL2301/PL2302 host-to-host 'network'
 urio*	at uhub? port ?			# Diamond Multimedia Rio 500
 uscanner* at uhub? port ?		# USB Scanners
 usscanner* at uhub? port ?		# USB SCSI scanners, e.g., HP5300
@@@@ -312,6 +314,7 @@@@
 
 fdc0	at isa? disable port 0x3f0 irq 6 drq 2	# standard PC floppy controllers
 fdc1	at isa? disable port 0x370 irq ? drq ?
+fd0	at fdc0 drive 0 flags 0x20	# always attach fd0 even when !probed
 fd*	at fdc? drive ?
 
 #mcd0	at isa? port 0x300 irq 10	# Mitsumi CD-ROM drives
Index: src/sys/arch/i386/conf/GENERIC
===================================================================
RCS file: /cvs/src/sys/arch/i386/conf/GENERIC,v
retrieving revision 1.330
diff -u -r1.330 GENERIC
--- src/sys/arch/i386/conf/GENERIC	6 Mar 2003 22:21:29 -0000	1.330
+++ src/sys/arch/i386/conf/GENERIC	7 Mar 2003 16:54:33 -0000
@@@@ -1,3 +1,4 @@@@
+#	$MirBSD: obsd.kernel,v 1.16 2003/03/22 22:33:25 tg Exp $
 #	$OpenBSD: GENERIC,v 1.330 2003/03/06 22:21:51 markus Exp $
 #	$NetBSD: GENERIC,v 1.48 1996/05/20 18:17:23 mrg Exp $
 #
@@@@ -8,16 +9,16 @@@@
 
 include "../../../conf/GENERIC"
 
-option		I386_CPU	# CPU classes; at least one is REQUIRED
-option		I486_CPU
+#option		I386_CPU	# CPU classes; at least one is REQUIRED
+#option		I486_CPU
 option		I586_CPU
 option		I686_CPU
-option		GPL_MATH_EMULATE	# floating point emulation.
+#option		GPL_MATH_EMULATE	# floating point emulation, taints the kernel
 
 option		USER_PCICONF	# user-space PCI configuration
 
-#option		VM86		# Virtual 8086 emulation
-#option		USER_LDT	# user-settable LDT; see i386_set_ldt(2)
+option		VM86		# Virtual 8086 emulation
+option		USER_LDT	# user-settable LDT; see i386_set_ldt(2)
 option		APERTURE	# in-kernel aperture driver for XFree86
 
 #option		KGDB		# Remote debugger support; exclusive of DDB
@@@@ -25,12 +26,15 @@@@
 
 #option		DUMMY_NOPS	# speed hack; recommended
 
-option		COMPAT_SVR4	# binary compatibility with SVR4
-option		COMPAT_IBCS2	# binary compatibility with SCO and ISC
+#option		COMPAT_SVR4	# binary compatibility with SVR4
+#option		COMPAT_IBCS2	# binary compatibility with SCO and ISC
 option		COMPAT_LINUX	# binary compatibility with Linux
 option		COMPAT_FREEBSD	# binary compatibility with FreeBSD
 option		COMPAT_BSDOS	# binary compatibility with BSD/OS
 
+option		INCLUDE_CONFIG_FILE	# store this file in the kernel
+#option		SYSCALL_DEBUG		# by drahn@@
+
 maxusers	32		# estimated number of users
 
 config		bsd	swap generic
@@@@ -122,7 +126,7 @@@@
 aue*	at uhub? port ?			# ADMtek AN986 Pegasus Ethernet
 cue*	at uhub? port ?			# CATC USB-EL1201A based Ethernet
 kue*	at uhub? port ?			# Kawasaki KL5KUSB101B based Ethernet
-upl*	at uhub? port ?			# Prolific PL2301/PL2302 host-to-host `network'
+upl*	at uhub? port ?			# Prolific PL2301/PL2302 host-to-host 'network'
 url*	at uhub? port ?			# Realtek RTL8150L based adapters
 urio*	at uhub? port ?			# Diamond Multimedia Rio 500
 uscanner* at uhub? port ?		# USB Scanners
@@@@ -156,7 +160,7 @@@@
 
 option	WSDISPLAY_COMPAT_USL		# VT handling
 option	WSDISPLAY_COMPAT_RAWKBD		# can get raw scancodes
-option	WSDISPLAY_DEFAULTSCREENS=6
+option	WSDISPLAY_DEFAULTSCREENS=7	# number of virtual consoles
 option	WSDISPLAY_COMPAT_PCVT		# emulate some ioctls
 
 pckbc0		at isa?			# PC keyboard controller
@@@@ -285,7 +289,8 @@@@
 uk*	at scsibus? target ? lun ?	# unknown SCSI
 
 fdc0	at isa? port 0x3f0 irq 6 drq 2	# standard PC floppy controllers
-#fdc1	at isa? port 0x370 irq ? drq ?
+fdc1	at isa? disable port 0x370 irq ? drq ?
+fd0	at fdc0 drive 0 flags 0x20	# always attach fd0 even when !probed
 fd*	at fdc? drive ? flags 0x00
 
 #mcd0	at isa? port 0x300 irq 10	# Mitsumi CD-ROM drives
@@@@ -453,7 +458,7 @@@@
 midi*	at autri?
 
 # The spkr driver provides a simple tone interface to the built in speaker.
-#spkr0	at pcppi?		# PC speaker
+spkr0	at pcppi?		# PC speaker
 
 #Audio Support
 audio*	at sb?
@@@@ -523,6 +528,7 @@@@
 pseudo-device	mtrr		1	# Memory range attributes control
 pseudo-device	sequencer	1
 #pseudo-device	raid		4	# RAIDframe disk driver
+#option		RAIDDEBUG		# be verbose about what it does
 pseudo-device	bio		1	# ioctl multiplexing device
 
 # mouse & keyboard multiplexor pseudo-devices
Index: src/sys/arch/i386/conf/Makefile.i386
===================================================================
RCS file: /cvs/src/sys/arch/i386/conf/Makefile.i386,v
retrieving revision 1.33
diff -u -r1.33 Makefile.i386
--- src/sys/arch/i386/conf/Makefile.i386	25 Dec 2002 21:10:04 -0000	1.33
+++ src/sys/arch/i386/conf/Makefile.i386	4 Mar 2003 16:52:47 -0000
@@@@ -1,12 +1,13 @@@@
+#	$MirBSD: obsd.kernel,v 1.16 2003/03/22 22:33:25 tg Exp $
 #	$OpenBSD: Makefile.i386,v 1.33 2002/12/25 21:10:26 miod Exp $
 #	$NetBSD: Makefile.i386,v 1.67 1996/05/11 16:12:11 mycroft Exp $
 
-# Makefile for OpenBSD
+# Makefile for OpenBSD-mirabile aka MirBSD
 #
 # This makefile is constructed from a machine description:
 #	config machineid
 # Most changes should be made in the machine description
-#	/sys/arch/i386/conf/``machineid''
+#	/sys/arch/i386/conf/MACHINEID
 # after which you should do
 #	config machineid
 # Machine generic makefile changes should be made in
@@@@ -24,7 +25,7 @@@@
 
 .include <bsd.own.mk>
 
-MKDEP?=	mkdep
+MKDEP?=	CC="${CC}" mkdep
 SIZE?=	size
 STRIP?=	strip
 
@@@@ -47,9 +48,9 @@@@
 CMACHFLAGS+=	-fno-stack-protector
 
 COPTS?=		-O2
-CFLAGS=		${DEBUG} ${CDIAGFLAGS} ${CMACHFLAGS} ${COPTS} ${PIPE}
+CFLAGS=		${DEBUG} ${CDIAGFLAGS} ${CMACHFLAGS} ${COPTS} ${PIPE} ${CKERNFLAGS}
 AFLAGS=		-x assembler-with-cpp -traditional-cpp -D_LOCORE
-LINKFLAGS=	-z -Ttext D0100000 -e start
+LINKFLAGS=	-Ttext 0xD0100120 -e start -N
 STRIPFLAGS=	-d
 
 HOSTCC= ${CC}
Index: src/sys/arch/i386/conf/RAMDISK
===================================================================
RCS file: /cvs/src/sys/arch/i386/conf/RAMDISK,v
retrieving revision 1.116
diff -u -r1.116 RAMDISK
--- src/sys/arch/i386/conf/RAMDISK	2 Dec 2002 09:00:32 -0000	1.116
+++ src/sys/arch/i386/conf/RAMDISK	7 Mar 2003 16:59:35 -0000
@@@@ -1,3 +1,4 @@@@
+#	$MirBSD: obsd.kernel,v 1.16 2003/03/22 22:33:25 tg Exp $
 #	$OpenBSD: RAMDISK,v 1.116 2002/12/02 09:00:54 deraadt Exp $
 
 machine		i386		# architecture, used by config; REQUIRED
@@@@ -5,15 +6,16 @@@@
 option		SCSITERSE
 option		APM_NOPRINT
 
-option		I386_CPU	# CPU classes; at least one is REQUIRED
-option		I486_CPU
+#option		I386_CPU	# CPU classes; at least one is REQUIRED
+#option		I486_CPU
 option		I586_CPU
 option		I686_CPU
-option		GPL_MATH_EMULATE	# floating point emulation
+#option		GPL_MATH_EMULATE	# floating point emulation, taints the kernel
 
 option		SMALL_KERNEL
 
 #option		DUMMY_NOPS	# speed hack; recommended
+option		INCLUDE_CONFIG_FILE	# store this file in the kernel
 
 maxusers	4		# estimated number of users
 option		TIMEZONE=0	# time zone to adjust RTC time by
@@@@ -158,6 +160,7 @@@@
 
 fdc0	at isa? port 0x3f0 irq 6 drq 2	# standard PC floppy controllers
 #fdc1	at isa? port 0x370 irq ? drq ?
+fd0	at fdc0 drive 0 flags 0x20	# always attach fd0 even when !probed
 fd*	at fdc? drive ?
 
 #mcd0	at isa? port 0x300 irq 10	# Mitsumi CD-ROM drives
Index: src/sys/arch/i386/conf/RAMDISKB
===================================================================
RCS file: /cvs/src/sys/arch/i386/conf/RAMDISKB,v
retrieving revision 1.57
diff -u -r1.57 RAMDISKB
--- src/sys/arch/i386/conf/RAMDISKB	12 Jan 2003 18:04:39 -0000	1.57
+++ src/sys/arch/i386/conf/RAMDISKB	7 Mar 2003 16:59:34 -0000
@@@@ -1,3 +1,4 @@@@
+#	$MirBSD: obsd.kernel,v 1.16 2003/03/22 22:33:25 tg Exp $
 #	$OpenBSD: RAMDISKB,v 1.57 2003/01/12 18:05:01 deraadt Exp $
 
 machine		i386		# architecture, used by config; REQUIRED
@@@@ -9,11 +10,12 @@@@
 option		I486_CPU
 option		I586_CPU
 option		I686_CPU
-option		GPL_MATH_EMULATE	# floating point emulation
+#option		GPL_MATH_EMULATE	# floating point emulation, taints the kernel
 
 option		SMALL_KERNEL
 
 #option		DUMMY_NOPS	# speed hack; recommended
+option		INCLUDE_CONFIG_FILE	# store this file in the kernel
 
 maxusers	4		# estimated number of users
 option		TIMEZONE=0	# time zone to adjust RTC time by
@@@@ -174,6 +176,7 @@@@
 
 fdc0	at isa? port 0x3f0 irq 6 drq 2	# standard PC floppy controllers
 #fdc1	at isa? port 0x370 irq ? drq ?
+fd0	at fdc0 drive 0 flags 0x20	# always attach fd0 even when !probed
 fd*	at fdc? drive ?
 
 #mcd0	at isa? port 0x300 irq 10	# Mitsumi CD-ROM drives
Index: src/sys/arch/i386/conf/RAMDISKC
===================================================================
RCS file: /cvs/src/sys/arch/i386/conf/RAMDISKC,v
retrieving revision 1.29
diff -u -r1.29 RAMDISKC
--- src/sys/arch/i386/conf/RAMDISKC	3 Sep 2002 16:42:51 -0000	1.29
+++ src/sys/arch/i386/conf/RAMDISKC	7 Mar 2003 16:59:35 -0000
@@@@ -1,3 +1,4 @@@@
+#	$MirBSD: obsd.kernel,v 1.16 2003/03/22 22:33:25 tg Exp $
 #	$OpenBSD: RAMDISKC,v 1.29 2002/09/03 16:43:13 mickey Exp $
 
 machine		i386		# architecture, used by config; REQUIRED
@@@@ -9,11 +10,12 @@@@
 option		I486_CPU
 option		I586_CPU
 option		I686_CPU
-option		GPL_MATH_EMULATE	# floating point emulation
+#option		GPL_MATH_EMULATE	# floating point emulation, taints the kernel
 
 option		SMALL_KERNEL
 
 #option		DUMMY_NOPS	# speed hack; recommended
+option		INCLUDE_CONFIG_FILE	# store this file in the kernel
 
 maxusers	4		# estimated number of users
 option		TIMEZONE=0	# time zone to adjust RTC time by
@@@@ -168,6 +170,7 @@@@
 
 fdc0	at isa? port 0x3f0 irq 6 drq 2	# standard PC floppy controllers
 #fdc1	at isa? port 0x370 irq ? drq ?
+fd0	at fdc0 drive 0 flags 0x20	# always attach fd0 even when !probed
 fd*	at fdc? drive ?
 
 #mcd0	at isa? port 0x300 irq 10	# Mitsumi CD-ROM drives
Index: src/sys/arch/i386/conf/RAMDISK_CD
===================================================================
RCS file: /cvs/src/sys/arch/i386/conf/RAMDISK_CD,v
retrieving revision 1.60
diff -u -r1.60 RAMDISK_CD
--- src/sys/arch/i386/conf/RAMDISK_CD	24 Sep 2002 19:07:52 -0000	1.60
+++ src/sys/arch/i386/conf/RAMDISK_CD	7 Mar 2003 16:59:33 -0000
@@@@ -1,3 +1,4 @@@@
+#	$MirBSD: obsd.kernel,v 1.16 2003/03/22 22:33:25 tg Exp $
 #	$OpenBSD: RAMDISK_CD,v 1.60 2002/09/24 19:08:14 nate Exp $
 
 machine		i386		# architecture, used by config; REQUIRED
@@@@ -9,9 +10,10 @@@@
 option		I486_CPU
 option		I586_CPU
 option		I686_CPU
-option		GPL_MATH_EMULATE	# floating point emulation
+#option		GPL_MATH_EMULATE	# floating point emulation, taints the kernel
 
 #option		DUMMY_NOPS	# speed hack; recommended
+option		INCLUDE_CONFIG_FILE	# store this file in the kernel
 
 maxusers	4		# estimated number of users
 option		TIMEZONE=0	# time zone to adjust RTC time by
@@@@ -221,6 +223,7 @@@@
 
 fdc0	at isa? port 0x3f0 irq 6 drq 2	# standard PC floppy controllers
 #fdc1	at isa? port 0x370 irq ? drq ?
+fd0	at fdc0 drive 0 flags 0x20	# always attach fd0 even when !probed
 fd*	at fdc? drive ?
 
 #mcd0	at isa? port 0x300 irq 10	# Mitsumi CD-ROM drives
Index: src/sys/arch/i386/i386/bios.c
===================================================================
RCS file: /cvs/src/sys/arch/i386/i386/bios.c,v
retrieving revision 1.49
diff -u -r1.49 bios.c
--- src/sys/arch/i386/i386/bios.c	20 May 2002 16:37:39 -0000	1.49
+++ src/sys/arch/i386/i386/bios.c	4 Mar 2003 16:52:47 -0000
@@@@ -171,7 +171,7 @@@@
 
 			bios32_entry.segment = GSEL(GCODE_SEL, SEL_KPL);
 			bios32_entry.offset = (u_int32_t)ISA_HOLE_VADDR(h->entry);
-			printf(", BIOS32 rev. %d @@ 0x%lx", h->rev, h->entry);
+			printf(", BIOS32 rev. %d @@ 0x%x", h->rev, h->entry);
 			break;
 		}
 	}
Index: src/sys/arch/i386/i386/db_magic.s
===================================================================
RCS file: /cvs/src/sys/arch/i386/i386/db_magic.s,v
retrieving revision 1.1
diff -u -r1.1 db_magic.s
--- src/sys/arch/i386/i386/db_magic.s	4 May 1996 14:32:40 -0000	1.1
+++ src/sys/arch/i386/i386/db_magic.s	4 Mar 2003 16:52:47 -0000
@@@@ -112,50 +112,50 @@@@
  */
 ENTRY(dr0)
       movl    S_ARG0, %eax
-      movl    %eax,_dr_addr
+      movl    %eax,_C_LABEL(dr_addr)
       movl    %eax, %db0
       movl    $0, %ecx
       jmp     0f
 ENTRY(dr1)
       movl    S_ARG0, %eax
-      movl    %eax,_dr_addr+1*4
+      movl    %eax,_C_LABEL(dr_addr)+1*4
       movl    %eax, %db1
       movl    $2, %ecx
       jmp     0f
 ENTRY(dr2)
       movl    S_ARG0, %eax
-      movl    %eax,_dr_addr+2*4
+      movl    %eax,_C_LABEL(dr_addr)+2*4
       movl    %eax, %db2
       movl    $4, %ecx
       jmp     0f
 ENTRY(dr3)
       movl    S_ARG0, %eax
-      movl    %eax,_dr_addr+3*4
+      movl    %eax,_C_LABEL(dr_addr)+3*4
       movl    %eax, %db3
       movl    $6, %ecx
 0:
       pushl   %ebp
       movl    %esp, %ebp
       movl    %db7, %edx
-      movl    %edx,_dr_addr+4*4
+      movl    %edx,_C_LABEL(dr_addr)+4*4
       andl    dr_msk(,%ecx,2),%edx    /* clear out new entry */
-      movl    %edx,_dr_addr+5*4
+      movl    %edx,_C_LABEL(dr_addr)+5*4
       movzbl  B_ARG3, %eax
       andb    $3, %al
       shll    %cl, %eax
       orl     %eax, %edx
       movzbl  B_ARG1, %eax
       andb    $3, %al
-      addb    $0x10, %ecx
+      add     $0x10, %ecx
       shll    %cl, %eax
       orl     %eax, %edx
       movzbl  B_ARG2, %eax
       andb    $3, %al
-      addb    $0x2, %ecx
+      add     $0x2, %ecx
       shll    %cl, %eax
       orl     %eax, %edx
       movl    %edx, %db7
-      movl    %edx,_dr_addr+7*4
+      movl    %edx,_C_LABEL(dr_addr)+7*4
       movl    %edx, %eax
       leave
       ret
Index: src/sys/arch/i386/i386/in_cksum.s
===================================================================
RCS file: /cvs/src/sys/arch/i386/i386/in_cksum.s,v
retrieving revision 1.5
diff -u -r1.5 in_cksum.s
--- src/sys/arch/i386/i386/in_cksum.s	4 Jul 2001 08:57:25 -0000	1.5
+++ src/sys/arch/i386/i386/in_cksum.s	4 Mar 2003 16:52:47 -0000
@@@@ -180,13 +180,17 @@@@
 
 in_cksum49:	pushl	%edi			# len - bytes checksummed
 		pushl	$warning		# push warning string
-		call	_printf			# printf()
+		call	_C_LABEL(printf)	# printf()
 		leal	8(%esp), %esp		#
 		jmp	in_cksum48		#
 
 		.data
 
+#ifdef __ELF__
+		.align	4
+#else
 		.align	2
+#endif
 
 table1:		.long	in_cksum8		# 4-byte aligned
 		.long	in_cksum4		# checksum 3 bytes
Index: src/sys/arch/i386/i386/locore.s
===================================================================
RCS file: /cvs/src/sys/arch/i386/i386/locore.s,v
retrieving revision 1.68
diff -u -r1.68 locore.s
--- src/sys/arch/i386/i386/locore.s	9 Jan 2003 22:26:47 -0000	1.68
+++ src/sys/arch/i386/i386/locore.s	4 Mar 2003 16:52:47 -0000
@@@@ -70,9 +70,15 @@@@
 /*
  * override user-land alignment before including asm.h
  */
+#ifdef __ELF__
+#define	ALIGN_DATA	.align	4
+#define	ALIGN_TEXT	.align	4,0x90	/* 4-byte boundaries, NOP-filled */
+#define	SUPERALIGN_TEXT	.align	16,0x90	/* 16-byte boundaries better for 486 */
+#else
 #define	ALIGN_DATA	.align	2
 #define	ALIGN_TEXT	.align	2,0x90	/* 4-byte boundaries, NOP-filled */
 #define	SUPERALIGN_TEXT	.align	4,0x90	/* 16-byte boundaries better for 486 */
+#endif
 #define _ALIGN_TEXT	ALIGN_TEXT
 #include <machine/asm.h>
 
@@@@ -100,8 +106,8 @@@@
 	pushl	%ds		; \
 	pushl	%es		; \
 	movl	$GSEL(GDATA_SEL, SEL_KPL),%eax	; \
-	movl	%ax,%ds		; \
-	movl	%ax,%es
+	movw	%ax,%ds		; \
+	movw	%ax,%es
 #define	INTRFASTEXIT \
 	popl	%es		; \
 	popl	%ds		; \
@@@@ -591,14 +597,14 @@@@
 
 	/* Clear segment registers; always null in proc0. */
 	xorl	%ecx,%ecx
-	movl	%cx,%fs
-	movl	%cx,%gs
+	movw	%cx,%fs
+	movw	%cx,%gs
 
 	call	_C_LABEL(main)
 
 NENTRY(proc_trampoline)
 	pushl	%ebx
-	call	%esi
+	call	*%esi
 	addl	$4,%esp
 	INTRFASTEXIT
 	/* NOTREACHED */
@@@@ -609,7 +615,7 @@@@
  * Signal trampoline; copied to top of user stack.
  */
 NENTRY(sigcode)
-	call	SIGF_HANDLER(%esp)
+	call	*SIGF_HANDLER(%esp)
 	leal	SIGF_SC(%esp),%eax	# scp (the call may have clobbered the
 					# copy at SIGF_SCP(%esp))
 #ifdef VM86
@@@@ -618,8 +624,8 @@@@
 #endif
 	movl	SC_FS(%eax),%ecx
 	movl	SC_GS(%eax),%edx
-	movl	%cx,%fs
-	movl	%dx,%gs
+	movw	%cx,%fs
+	movw	%dx,%gs
 1:	pushl	%eax
 	pushl	%eax			# junk to fake return address
 	movl	$SYS_sigreturn,%eax
@@@@ -633,7 +639,7 @@@@
 
 #ifdef COMPAT_SVR4
 NENTRY(svr4_sigcode)
-	call	SVR4_SIGF_HANDLER(%esp)
+	call	*SVR4_SIGF_HANDLER(%esp)
 	leal	SVR4_SIGF_UC(%esp),%eax	# ucp (the call may have clobbered the
 					# copy at SIGF_UCP(%esp))
 #ifdef VM86
@@@@ -642,8 +648,8 @@@@
 #endif
 	movl	SVR4_UC_FS(%eax),%ecx
 	movl	SVR4_UC_GS(%eax),%edx
-	movl	%cx,%fs
-	movl	%dx,%gs
+	movw	%cx,%fs
+	movw	%dx,%gs
 1:	pushl	%eax
 	pushl	$1			# setcontext(p) == syscontext(1, p)
 	pushl	%eax			# junk to fake return address
@@@@ -662,7 +668,7 @@@@
  * Signal trampoline; copied to top of user stack.
  */
 NENTRY(linux_sigcode)
-	call	LINUX_SIGF_HANDLER(%esp)
+	call	*LINUX_SIGF_HANDLER(%esp)
 	leal	LINUX_SIGF_SC(%esp),%ebx # scp (the call may have clobbered the
 					# copy at SIGF_SCP(%esp))
 #ifdef VM86
@@@@ -671,8 +677,8 @@@@
 #endif
 	movl	LINUX_SC_FS(%ebx),%ecx
 	movl	LINUX_SC_GS(%ebx),%edx
-	movl	%cx,%fs
-	movl	%dx,%gs
+	movw	%cx,%fs
+	movw	%dx,%gs
 1:	pushl	%eax			# junk to fake return address
 	movl	$LINUX_SYS_sigreturn,%eax
 	int	$0x80			# enter kernel with args on stack
@@@@ -689,7 +695,7 @@@@
  * Signal trampoline; copied to top of user stack.
  */
 NENTRY(freebsd_sigcode)
-	call	FREEBSD_SIGF_HANDLER(%esp)
+	call	*FREEBSD_SIGF_HANDLER(%esp)
 	leal	FREEBSD_SIGF_SC(%esp),%eax # scp (the call may have clobbered
 					# the copy at SIGF_SCP(%esp))
 	pushl	%eax
@@@@ -1277,9 +1283,9 @@@@
 	nop
 1:	/* Reload "stale" selectors. */
 	movl	$GSEL(GDATA_SEL, SEL_KPL),%eax
-	movl	%ax,%ds
-	movl	%ax,%es
-	movl	%ax,%ss
+	movw	%ax,%ds
+	movw	%ax,%es
+	movw	%ax,%ss
 	/* Reload code selector by doing intersegment return. */
 	popl	%eax
 	pushl	$GSEL(GCODE_SEL, SEL_KPL)
@@@@ -1527,8 +1533,8 @@@@
 	xorl	%eax, %eax
 	xorl	%ecx, %ecx
 #endif
-	movl	%fs,%ax
-	movl	%gs,%cx
+	movw	%fs,%ax
+	movw	%gs,%cx
 	movl	%eax,PCB_FS(%esi)
 	movl	%ecx,PCB_GS(%esi)
 
@@@@ -1587,8 +1593,8 @@@@
 	/* Restore segment registers. */
 	movl	PCB_FS(%esi),%eax
 	movl	PCB_GS(%esi),%ecx
-	movl	%ax,%fs
-	movl	%cx,%gs
+	movw	%ax,%fs
+	movw	%cx,%gs
 
 switch_restored:
 	/* Restore cr0 (including FPU state). */
@@@@ -1651,8 +1657,8 @@@@
 
 	/* Clear segment registers; always null in proc0. */
 	xorl	%ecx,%ecx
-	movl	%cx,%fs
-	movl	%cx,%gs
+	movw	%cx,%fs
+	movw	%cx,%gs
 
 	/* Restore cr0 (including FPU state). */
 	movl	PCB_CR0(%esi),%ecx
@@@@ -1688,8 +1694,8 @@@@
 	xorl	%eax, %eax
 	xorl	%ecx, %ecx
 #endif
-	movl	%fs,%ax
-	movl	%gs,%cx
+	movw	%fs,%ax
+	movw	%gs,%cx
 	movl	%eax,PCB_FS(%edx)
 	movl	%ecx,PCB_GS(%edx)
 
@@@@ -1714,7 +1720,11 @@@@
  * XXX - debugger traps are now interrupt gates so at least bdb doesn't lose
  * control.  The sti's give the standard losing behaviour for ddb and kgdb.
  */
+#ifdef __ELF__
+#define	IDTVEC(name)	ALIGN_TEXT; .globl X/**/name; X/**/name:
+#else
 #define	IDTVEC(name)	ALIGN_TEXT; .globl _X/**/name; _X/**/name:
+#endif
 
 #define	TRAP(a)		pushl $(a) ; jmp _C_LABEL(alltraps)
 #define	ZTRAP(a)	pushl $0 ; TRAP(a)
@@@@ -1820,7 +1830,7 @@@@
 	ZTRAP(T_PROTFLT)
 NENTRY(resume_pop_ds)
 	movl	$GSEL(GDATA_SEL, SEL_KPL),%eax
-	movl	%ax,%es
+	movw	%ax,%es
 NENTRY(resume_pop_es)
 	movl	$T_PROTFLT,TF_TRAPNO(%esp)
 	jmp	calltrap
Index: src/sys/arch/i386/i386/machdep.c
===================================================================
RCS file: /cvs/src/sys/arch/i386/i386/machdep.c,v
retrieving revision 1.220
diff -u -r1.220 machdep.c
--- src/sys/arch/i386/i386/machdep.c	16 Jan 2003 19:39:01 -0000	1.220
+++ src/sys/arch/i386/i386/machdep.c	4 Mar 2003 16:52:48 -0000
@@@@ -392,7 +392,7 @@@@
 	phys_map = uvm_km_suballoc(kernel_map, &minaddr, &maxaddr,
 				   VM_PHYS_SIZE, 0, FALSE, NULL);
 
-	printf("avail mem = %lu (%uK)\n", ptoa(uvmexp.free),
+	printf("avail mem = %lu (%luK)\n", ptoa(uvmexp.free),
 	    ptoa(uvmexp.free)/1024);
 	printf("using %d buffers containing %u bytes (%uK) of memory\n",
 		nbuf, bufpages * PAGE_SIZE, bufpages * PAGE_SIZE / 1024);
@@@@ -1187,7 +1187,7 @@@@
 	const char *name, *modifier, *vendorname, *token;
 	const char *cpu_device = "cpu0";
 	int class = CPUCLASS_386, vendor, i, max;
-	int family, model, step, modif, cachesize;
+	int family = 0, model, step, modif, cachesize;
 	const struct cpu_cpuid_nameclass *cpup = NULL;
 	void (*cpu_setup)(const char *, int, int);
 
@@@@ -2203,8 +2203,9 @@@@
 
 			if (extent_alloc_region(iomem_ex, a, e - a, EX_NOWAIT))
 				/* XXX What should we do? */
-				printf("\nWARNING: CAN'T ALLOCATE RAM (%x-%x)"
-				    " FROM IOMEM EXTENT MAP!\n", a, e);
+				printf("\nWARNING: CAN'T ALLOCATE RAM (%lx-%lx)"
+				    " FROM IOMEM EXTENT MAP!\n", (unsigned long) a,
+				    (unsigned long) e);
 
 			physmem += atop(e - a);
 			dumpmem[i].start = atop(a);
Index: src/sys/arch/i386/i386/microtime.s
===================================================================
RCS file: /cvs/src/sys/arch/i386/i386/microtime.s,v
retrieving revision 1.16
diff -u -r1.16 microtime.s
--- src/sys/arch/i386/i386/microtime.s	24 Sep 2002 00:06:00 -0000	1.16
+++ src/sys/arch/i386/i386/microtime.s	4 Mar 2003 16:52:48 -0000
@@@@ -49,7 +49,7 @@@@
 ENTRY(microtime)
 
 #if defined(I586_CPU) || defined(I686_CPU)
-	movl	_pentium_mhz, %ecx
+	movl	_C_LABEL(pentium_mhz), %ecx
 	testl	%ecx, %ecx
 	jne	pentium_microtime
 #else
@@@@ -97,7 +97,7 @@@@
 
 	movl	$11932,%edx	# counter limit
 
-	testb	$IRQ_BIT(0),_ipending + IRQ_BYTE(0)
+	testb	$IRQ_BIT(0),_C_LABEL(ipending) + IRQ_BYTE(0)
 	jnz	1f
 
 	cmpl	$12,%ecx	# check for potential overflow
@@@@ -123,8 +123,8 @@@@
 	shrl	$12,%eax		# a = a/4096 = 3433d/4096
 
 common_microtime:
-	movl	_time,%edx	# get time.tv_sec
-	addl	_time+4,%eax	# add time.tv_usec
+	movl	_C_LABEL(time),%edx	# get time.tv_sec
+	addl	_C_LABEL(time)+4,%eax	# add time.tv_usec
 
 	popfl			# enable interrupts
 	
@@@@ -141,8 +141,8 @@@@
 
 #if defined(I586_CPU) || defined(I686_CPU)
 	.data
-	.globl	_pentium_base_tsc
-	.comm	_pentium_base_tsc,8
+	.globl	_C_LABEL(pentium_base_tsc)
+	.comm	_C_LABEL(pentium_base_tsc),8
 	.text
 
 	.align	2, 0x90
@@@@ -150,8 +150,8 @@@@
 	pushfl
 	cli
 	.byte	0x0f, 0x31	# RDTSC
-	subl	_pentium_base_tsc,%eax
-	sbbl	_pentium_base_tsc+4,%edx
+	subl	_C_LABEL(pentium_base_tsc),%eax
+	sbbl	_C_LABEL(pentium_base_tsc)+4,%edx
 	/*
 	 * correct the high word first so we won't
 	 * receive a result overflow aka div/0 fault
Index: src/sys/arch/i386/i386/random.s
===================================================================
RCS file: /cvs/src/sys/arch/i386/i386/random.s,v
retrieving revision 1.3
diff -u -r1.3 random.s
--- src/sys/arch/i386/i386/random.s	4 Jul 2001 08:57:25 -0000	1.3
+++ src/sys/arch/i386/i386/random.s	4 Mar 2003 16:52:48 -0000
@@@@ -45,20 +45,20 @@@@
 #include <machine/asm.h>
 
 	.data
-	.globl	__randseed
-__randseed:
+	.globl	_C_LABEL(_randseed)
+_C_LABEL(_randseed):
 	.long	1
 	.text
 ENTRY(random)
 	movl	$16807,%eax
-	imull	__randseed
+	imull	_C_LABEL(_randseed)
 	shld	$1,%eax,%edx
 	andl	$0x7fffffff,%eax
 	addl	%edx,%eax
 	js	1f
-	movl	%eax,__randseed
+	movl	%eax,_C_LABEL(_randseed)
 	ret
 1:
 	subl	$0x7fffffff,%eax
-	movl	%eax,__randseed
+	movl	%eax,_C_LABEL(_randseed)
 	ret
Index: src/sys/arch/i386/include/asm.h
===================================================================
RCS file: /cvs/src/sys/arch/i386/include/asm.h,v
retrieving revision 1.5
diff -u -r1.5 asm.h
--- src/sys/arch/i386/include/asm.h	5 Sep 2001 08:22:14 -0000	1.5
+++ src/sys/arch/i386/include/asm.h	4 Mar 2003 16:52:48 -0000
@@@@ -16,10 +16,6 @@@@
  * 2. Redistributions in binary form must reproduce the above copyright
  *    notice, this list of conditions and the following disclaimer in the
  *    documentation and/or other materials provided with the distribution.
- * 3. All advertising materials mentioning features or use of this software
- *    must display the following acknowledgement:
- *	This product includes software developed by the University of
- *	California, Berkeley and its contributors.
  * 4. Neither the name of the University nor the names of its contributors
  *    may be used to endorse or promote products derived from this software
  *    without specific prior written permission.
@@@@ -45,10 +41,10 @@@@
 #ifdef PIC
 #define PIC_PROLOGUE	\
 	pushl	%ebx;	\
-	call	1f;	\
-1:			\
+	call	666f;	\
+666:			\
 	popl	%ebx;	\
-	addl	$__GLOBAL_OFFSET_TABLE_+[.-1b], %ebx
+	addl	$_C_LABEL(_GLOBAL_OFFSET_TABLE_)+[.-666b], %ebx
 #define PIC_EPILOGUE	\
 	popl	%ebx
 #define PIC_PLT(x)	x@@PLT
@@@@ -62,12 +58,25 @@@@
 #define PIC_GOTOFF(x)	x
 #endif
 
-#ifdef __STDC__
-# define _C_LABEL(x)	_ ## x
-#else
-# define _C_LABEL(x)	_/**/x
-#endif
+#define _C_LABEL(name)	name
 #define	_ASM_LABEL(x)	x
+
+/*
+ * WEAK ALIAS: create a weak alias (ELF only)
+ */
+#ifdef __ELF__
+#define WEAK_ALIAS(alias,sym) \
+	.weak alias; \
+	alias = sym
+#endif
+
+/*
+ * WARN_REFERENCES: create a warning if the specified symbol is referenced
+ * (ELF only).
+ */
+#ifdef __ELF__
+	.section .gnu.warning. ## _sym ; .ascii _msg ; .text
+#endif /* __ELF__ */
 
 /* let kernels and others override entrypoint alignment */
 #ifndef _ALIGN_TEXT
Index: src/sys/arch/i386/include/biosvar.h
===================================================================
RCS file: /cvs/src/sys/arch/i386/include/biosvar.h,v
retrieving revision 1.40
diff -u -r1.40 biosvar.h
--- src/sys/arch/i386/include/biosvar.h	14 Mar 2002 01:26:11 -0000	1.40
+++ src/sys/arch/i386/include/biosvar.h	4 Mar 2003 16:52:48 -0000
@@@@ -204,7 +204,7 @@@@
 #else
 #define	DOINT(n)	"int $0x20+(" #n ")"
 
-extern struct BIOS_regs {
+extern volatile struct BIOS_regs {
 	u_int32_t	biosr_ax;
 	u_int32_t	biosr_cx;
 	u_int32_t	biosr_dx;
Index: src/sys/arch/i386/include/bus.h
===================================================================
RCS file: /cvs/src/sys/arch/i386/include/bus.h,v
retrieving revision 1.34
diff -u -r1.34 bus.h
--- src/sys/arch/i386/include/bus.h	16 Jan 2003 04:15:38 -0000	1.34
+++ src/sys/arch/i386/include/bus.h	4 Mar 2003 16:52:48 -0000
@@@@ -639,9 +639,9 @@@@
 	int _port1 = (h1)+(o1); int _port2 = (h2)+(o2); int _cnt=(cnt);	\
 	if ((t) == I386_BUS_SPACE_IO) {					\
 		__asm __volatile("					\
-		1:	movl %w1,%%dx				;	\
+		1:	movl %w1,%%edx				;	\
 			inb  %%dx,%%al				;	\
-			movl %w0,%%dx				;	\
+			movl %w0,%%edx				;	\
 			outb %%al,%%dx				;	\
 			incl %0					;	\
 			incl %1					;	\
@@@@ -656,14 +656,14 @@@@
 	int _port1 = (h1)+(o1); int _port2 = (h2)+(o2); int _cnt=(cnt);	\
 	if ((t) == I386_BUS_SPACE_IO) {					\
 		__asm __volatile("					\
-		1:	movl %w1,%%dx				;	\
+		1:	movl %k1,%%edx				;	\
 			inw  %%dx,%%ax				;	\
-			movl %w0,%%dx				;	\
+			movl %k0,%%edx				;	\
 			outw %%ax,%%dx				;	\
 			addl $2, %0				;	\
 			addl $2, %1				;	\
 			loop 1b"				:	\
-		    "+D" (_port2), "+S" (_port1), "+c" ((_cnt))	::	\
+		    "+D" (_port2), "+ES" (_port1), "+c" ((_cnt))	::	\
 		    "%edx", "%eax", "cc");				\
 	} else								\
 		i386_space_copy(_port1, _port2, 2, _cnt);		\
@@@@ -673,14 +673,14 @@@@
 	int _port1 = (h1)+(o1); int _port2 = (h2)+(o2); int _cnt=(cnt);	\
 	if ((t) == I386_BUS_SPACE_IO) {					\
 		__asm __volatile("					\
-		1:	movl %w1,%%dx				;	\
+		1:f	movl %w1,%%edx				;	\
 			inl  %%dx,%%eax				;	\
-			movl %w0,%%dx				;	\
+			movl %w0,%%edx				;	\
 			outl %%eax,%%dx				;	\
 			addl $4, %0				;	\
 			addl $4, %1				;	\
 			loop 1b"				:	\
-		    "+D" (_port2), "+S" (_port1), "+c" ((_cnt))	::	\
+		    "+D" (_port2), "+ES" (_port1), "+c" ((_cnt))	::	\
 		    "%edx", "%eax", "cc");				\
 	} else								\
 		i386_space_copy(_port1, _port2, 4, _cnt);		\
Index: src/sys/arch/i386/include/cdefs.h
===================================================================
RCS file: /cvs/src/sys/arch/i386/include/cdefs.h,v
retrieving revision 1.7
diff -u -r1.7 cdefs.h
--- src/sys/arch/i386/include/cdefs.h	18 Aug 2001 02:34:44 -0000	1.7
+++ src/sys/arch/i386/include/cdefs.h	4 Mar 2003 16:52:48 -0000
@@@@ -9,34 +9,11 @@@@
 #ifndef	_MACHINE_CDEFS_H_
 #define	_MACHINE_CDEFS_H_
 
-#ifndef	_C_LABEL
-#ifdef __STDC__
-#define _C_LABEL(x)	__STRING(_ ## x)
-#else
-#define _C_LABEL(x)	__STRING(_/**/x)
-#endif
-#endif /* _C_LABEL */
-
-#ifdef __GNUC__
-#ifdef __STDC__
-#define __indr_reference(sym,alias)	\
-	__asm__(".stabs \"_" #alias "\",11,0,0,0");	\
-	__asm__(".stabs \"_" #sym "\",1,0,0,0")
-#define __warn_references(sym,msg)	\
-	__asm__(".stabs \"" msg "\",30,0,0,0");		\
-	__asm__(".stabs \"_" #sym "\",1,0,0,0")
-#define __weak_alias(alias,sym)				\
-	__asm__(".weak _" #alias "; _" #alias "= _" __STRING(sym))
-#else
-#define __indr_reference(sym,alias)	\
-	__asm__(".stabs \"_/**/alias\",11,0,0,0");	\
-	__asm__(".stabs \"_/**/sym\",1,0,0,0")
-#define __warn_references(sym,msg)	\
-	__asm__(".stabs msg,30,0,0,0");			\
-	__asm__(".stabs \"_/**/sym\",1,0,0,0")
-#define __weak_alias(alias,sym)				\
-	__asm__(".weak _/**/alias; _/**/alias = _/**/sym")
-#endif
+#if defined(__GNUC__) && defined(__STDC__)
+#define __weak_alias(alias,sym)						\
+	__asm__(".weak " __STRING(alias) " ; " __STRING(alias) " = " __STRING(sym))
+#define __warn_references(sym,msg)					\
+	__asm__(".section .gnu.warning." __STRING(sym) " ; .ascii \"" msg "\" ; .text")
 #else
 #define __indr_reference(sym,alias)
 #define __warn_references(sym,msg)
Index: src/sys/arch/i386/include/db_machdep.h
===================================================================
RCS file: /cvs/src/sys/arch/i386/include/db_machdep.h,v
retrieving revision 1.7
diff -u -r1.7 db_machdep.h
--- src/sys/arch/i386/include/db_machdep.h	14 Mar 2002 01:26:11 -0000	1.7
+++ src/sys/arch/i386/include/db_machdep.h	4 Mar 2003 16:52:48 -0000
@@@@ -97,6 +97,8 @@@@
 #define DB_TASK_NAME_TITLE	"COMMAND                "
 #define DB_TASK_NAME_LEN	23
 #define DB_NULL_TASK_NAME	"?                      "
+#define DB_ELF_SYMBOLS
+#define DB_ELFSIZE		32
 
 /*
  * Constants for KGDB.
Index: src/sys/arch/i386/include/exec.h
===================================================================
RCS file: /cvs/src/sys/arch/i386/include/exec.h,v
retrieving revision 1.8
diff -u -r1.8 exec.h
--- src/sys/arch/i386/include/exec.h	22 Jan 2001 14:50:42 -0000	1.8
+++ src/sys/arch/i386/include/exec.h	4 Mar 2003 16:52:48 -0000
@@@@ -34,6 +34,7 @@@@
 #define __LDPGSZ	4096
 
 /* Relocation format. */
+#ifndef __ELF__
 struct relocation_info_i386 {
 	int r_address;			/* offset in text or data segment */
 	unsigned int r_symbolnum : 24,	/* ordinal number of add symbol */
@@@@ -46,6 +47,9 @@@@
 			  r_copy :  1;	/* run time copy */
 };
 #define relocation_info	relocation_info_i386
+#endif
+
+#define NATIVE_EXEC_ELF
 
 #define ARCH_ELFSIZE		32
 
@@@@ -58,9 +62,6 @@@@
 #define _NLIST_DO_ELF
 
 #define _KERN_DO_AOUT
-#if defined(COMPAT_LINUX) || defined(COMPAT_SVR4) || defined(COMPAT_FREEBSD) || \
-    !defined(_KERNEL)
 #define _KERN_DO_ELF
-#endif
 
 #endif  /* _I386_EXEC_H_ */
Index: src/sys/arch/i386/include/intr.h
===================================================================
RCS file: /cvs/src/sys/arch/i386/include/intr.h,v
retrieving revision 1.18
diff -u -r1.18 intr.h
--- src/sys/arch/i386/include/intr.h	11 Dec 2002 07:15:49 -0000	1.18
+++ src/sys/arch/i386/include/intr.h	4 Mar 2003 16:52:48 -0000
@@@@ -226,7 +226,8 @@@@
 softintr(mask)
 	int mask;
 {
-	__asm __volatile("orl %0,_ipending" : : "ir" (mask));
+	__asm __volatile("orl %1, %0" : "=m"(ipending) : "ir" (mask));
+
 }
 
 #define	setsoftast()	(astpending = 1)
Index: src/sys/arch/i386/include/param.h
===================================================================
RCS file: /cvs/src/sys/arch/i386/include/param.h,v
retrieving revision 1.21
diff -u -r1.21 param.h
--- src/sys/arch/i386/include/param.h	26 Jun 2002 08:42:17 -0000	1.21
+++ src/sys/arch/i386/include/param.h	4 Mar 2003 16:52:48 -0000
@@@@ -61,9 +61,15 @@@@
  * Round p (pointer or byte index) up to a correctly-aligned value
  * for all data types (int, long, ...).   The result is u_int and
  * must be cast to any desired pointer type.
+ *
+ * ALIGNED_POINTER is a boolean macro that checks whether an address
+ * is valid to fetch data elements of type t from on this architecture.
+ * This does not reflect the optimal alignment, just the possibility
+ * (within reasonable limits). 
  */
 #define ALIGNBYTES	(sizeof(int) - 1)
 #define ALIGN(p)	(((u_int)(p) + ALIGNBYTES) &~ ALIGNBYTES)
+#define ALIGNED_POINTER(p,t)   1
 
 #define	PGSHIFT		12		/* LOG2(NBPG) */
 #define	NBPG		(1 << PGSHIFT)	/* bytes/page */
Index: src/sys/arch/i386/isa/clock.c
===================================================================
RCS file: /cvs/src/sys/arch/i386/isa/clock.c,v
retrieving revision 1.28
diff -u -r1.28 clock.c
--- src/sys/arch/i386/isa/clock.c	6 Jul 2002 19:13:58 -0000	1.28
+++ src/sys/arch/i386/isa/clock.c	4 Mar 2003 16:52:48 -0000
@@@@ -198,7 +198,7 @@@@
 
 	/* Check diagnostic status */
 	if ((s = mc146818_read(NULL, NVRAM_DIAG)) != 0)	/* XXX softc */
-		printf("RTC BIOS diagnostic error %b\n", (unsigned int) s, 
+		printf("RTC BIOS diagnostic error %d %s\n", (unsigned int) s,
 		    NVRAM_DIAG_BITS);
 }
 
Index: src/sys/arch/i386/isa/icu.s
===================================================================
RCS file: /cvs/src/sys/arch/i386/isa/icu.s,v
retrieving revision 1.18
diff -u -r1.18 icu.s
--- src/sys/arch/i386/isa/icu.s	4 Dec 2001 00:00:14 -0000	1.18
+++ src/sys/arch/i386/isa/icu.s	4 Mar 2003 16:52:48 -0000
@@@@ -139,7 +139,7 @@@@
 	call	_C_LABEL(comsoft)
 	movl	%ebx,_C_LABEL(cpl)
 #endif
-	jmp	%esi
+	jmp	*%esi
 
 #define DONETISR(s, c) \
 	.globl  _C_LABEL(c)	;\
@@@@ -155,7 +155,7 @@@@
 	xchgl	_C_LABEL(netisr),%edi
 #include <net/netisr_dispatch.h>
 	movl	%ebx,_C_LABEL(cpl)
-	jmp	%esi
+	jmp	*%esi
 #undef DONETISR
 
 IDTVEC(softclock)
@@@@ -163,5 +163,5 @@@@
 	movl	%eax,_C_LABEL(cpl)
 	call	_C_LABEL(softclock)
 	movl	%ebx,_C_LABEL(cpl)
-	jmp	%esi
+	jmp	*%esi
 
Index: src/sys/arch/i386/isa/npx.c
===================================================================
RCS file: /cvs/src/sys/arch/i386/isa/npx.c,v
retrieving revision 1.25
diff -u -r1.25 npx.c
--- src/sys/arch/i386/isa/npx.c	14 Mar 2002 01:26:11 -0000	1.25
+++ src/sys/arch/i386/isa/npx.c	4 Mar 2003 16:52:48 -0000
@@@@ -145,6 +145,11 @@@@
 extern int i386_fpu_exception;
 extern int i386_fpu_fdivbug;
 
+#ifdef __ELF__
+#define AOUT_UNDERSCORE ""
+#else
+#define AOUT_UNDERSCORE "_"
+#endif
 /*
  * Special interrupt handlers.  Someday intr0-intr15 will be used to count
  * interrupts.  We'll still need a special exception 16 handler.  The busy
@@@@ -152,9 +157,9 @@@@
  */
 void probeintr(void);
 asm (".text\n\t"
-"_probeintr:\n\t"
+AOUT_UNDERSCORE "probeintr:\n\t"
 	"ss\n\t"
-	"incl	_npx_intrs_while_probing\n\t"
+	"incl	" AOUT_UNDERSCORE "npx_intrs_while_probing\n\t"
 	"pushl	%eax\n\t"
 	"movb	$0x20,%al	# EOI (asm in strings loses cpp features)\n\t"
 	"outb	%al,$0xa0	# IO_ICU2\n\t"
@@@@ -166,9 +171,9 @@@@
 
 void probetrap(void);
 asm (".text\n\t"
-"_probetrap:\n\t"
+AOUT_UNDERSCORE "probetrap:\n\t"
 	"ss\n\t"
-	"incl	_npx_traps_while_probing\n\t"
+	"incl	" AOUT_UNDERSCORE "npx_traps_while_probing\n\t"
 	"fnclex\n\t"
 	"iret\n\t");
 
@@@@ -307,7 +312,7 @@@@
 
 int npx586bug1(int, int);
 asm (".text\n\t"
-"_npx586bug1:\n\t"
+AOUT_UNDERSCORE "npx586bug1:\n\t"
 	"fildl	4(%esp)		# x\n\t"
 	"fildl	8(%esp)		# y\n\t"
 	"fld	%st(1)\n\t"
Index: src/sys/arch/i386/isa/pccom.c
===================================================================
RCS file: /cvs/src/sys/arch/i386/isa/pccom.c,v
retrieving revision 1.42
diff -u -r1.42 pccom.c
--- src/sys/arch/i386/isa/pccom.c	14 Mar 2002 01:26:11 -0000	1.42
+++ src/sys/arch/i386/isa/pccom.c	4 Mar 2003 16:52:48 -0000
@@@@ -911,7 +911,7 @@@@
 #endif
 		if (ISSET(sc->sc_hwflags, COM_HW_FIFO)) {
 			u_int8_t fifo = FIFO_ENABLE|FIFO_RCV_RST|FIFO_XMT_RST;
-			u_int8_t lcr;
+			u_int8_t lcr = 0;
 
 			switch (sc->sc_uarttype) {
 			case COM_UART_ST16650V2:
@@@@ -1377,7 +1377,7 @@@@
 		if (!ISSET(sc->sc_hwflags, COM_HW_HAYESP) &&
 		    ISSET(sc->sc_hwflags, COM_HW_FIFO)) {
 			u_int8_t fifo = FIFO_ENABLE;
-			u_int8_t lcr2;
+			u_int8_t lcr2 = 0;
 
 			switch (sc->sc_uarttype) {
 			case COM_UART_ST16650V2:
Index: src/sys/arch/i386/isa/vector.s
===================================================================
RCS file: /cvs/src/sys/arch/i386/isa/vector.s,v
retrieving revision 1.15
diff -u -r1.15 vector.s
--- src/sys/arch/i386/isa/vector.s	6 Dec 2001 21:08:51 -0000	1.15
+++ src/sys/arch/i386/isa/vector.s	4 Mar 2003 16:52:48 -0000
@@@@ -85,16 +85,16 @@@@
 #ifdef ICU_HARDWARE_MASK
 
 #define	MASK(irq_num, icu) \
-	movb	_imen + IRQ_BYTE(irq_num),%al				;\
+	movb	_C_LABEL(imen) + IRQ_BYTE(irq_num),%al				;\
 	orb	$IRQ_BIT(irq_num),%al					;\
-	movb	%al,_imen + IRQ_BYTE(irq_num)				;\
+	movb	%al,_C_LABEL(imen) + IRQ_BYTE(irq_num)				;\
 	FASTER_NOP							;\
 	outb	%al,$(icu+1)
 #define	UNMASK(irq_num, icu) \
 	cli								;\
-	movb	_imen + IRQ_BYTE(irq_num),%al				;\
+	movb	_C_LABEL(imen) + IRQ_BYTE(irq_num),%al				;\
 	andb	$~IRQ_BIT(irq_num),%al					;\
-	movb	%al,_imen + IRQ_BYTE(irq_num)				;\
+	movb	%al,_C_LABEL(imen) + IRQ_BYTE(irq_num)				;\
 	FASTER_NOP							;\
 	outb	%al,$(icu+1)						;\
 	sti
@@@@ -130,7 +130,7 @@@@
  * scattered cld's?
  */
 
-	.globl	_isa_strayintr
+	.globl	_C_LABEL(isa_strayintr)
 
 /*
  * Normal vectors.
@@@@ -154,7 +154,7 @@@@
 	pushl	%cs							;\
 	pushl	%esi							;\
 	cli								;\
-_Xintr/**/irq_num/**/:							;\
+_C_LABEL(Xintr)/**/irq_num/**/:						;\
 	pushl	$0			/* dummy error code */		;\
 	pushl	$T_ASTFLT		/* trap # for doing ASTs */	;\
 	INTRENTRY							;\
@@@@ -162,26 +162,26 @@@@
 	MASK(irq_num, icu)		/* mask it in hardware */	;\
 	ack(irq_num)			/* and allow other intrs */	;\
 	incl	MY_COUNT+V_INTR		/* statistical info */		;\
-	movl	_C_LABEL(iminlevel) + (irq_num) * 4, %eax			;\
+	movl	_C_LABEL(iminlevel) + (irq_num) * 4, %eax		;\
 	movzbl	_C_LABEL(cpl),%ebx					;\
 	cmpl	%eax,%ebx						;\
 	jae	_C_LABEL(Xhold/**/irq_num)/* currently masked; hold it */;\
-_Xresume/**/irq_num/**/:						;\
+_C_LABEL(Xresume)/**/irq_num/**/:					;\
 	movzbl	_C_LABEL(cpl),%eax	/* cpl to restore on exit */	;\
 	pushl	%eax							;\
-	movl	_C_LABEL(imaxlevel) + (irq_num) * 4,%eax			;\
+	movl	_C_LABEL(imaxlevel) + (irq_num) * 4,%eax		;\
 	movl	%eax,_C_LABEL(cpl)	/* block enough for this irq */	;\
 	sti				/* safe to take intrs now */	;\
-	movl	_intrhand + (irq_num) * 4,%ebx	/* head of chain */	;\
+	movl	_C_LABEL(intrhand) + (irq_num) * 4,%ebx	/* head of chain */	;\
 	testl	%ebx,%ebx						;\
-	jz	_Xstray/**/irq_num	/* no handlears; we're stray */	;\
+	jz	_C_LABEL(Xstray)/**/irq_num	/* no handlears; we're stray */	;\
 	STRAY_INITIALIZE		/* nobody claimed it yet */	;\
 7:	movl	IH_ARG(%ebx),%eax	/* get handler arg */		;\
 	testl	%eax,%eax						;\
 	jnz	4f							;\
 	movl	%esp,%eax		/* 0 means frame pointer */	;\
 4:	pushl	%eax							;\
-	call	IH_FUN(%ebx)		/* call it */			;\
+	call	*IH_FUN(%ebx)		/* call it */			;\
 	addl	$4,%esp			/* toss the arg */		;\
 	STRAY_INTEGRATE			/* maybe he claimed it */	;\
 	orl	%eax,%eax		/* should it be counted? */	;\
@@@@ -192,14 +192,14 @@@@
 	jnz	7b							;\
 	STRAY_TEST			/* see if it's a stray */	;\
 6:	UNMASK(irq_num, icu)		/* unmask it in hardware */	;\
-	jmp	_Xdoreti		/* lower spl and do ASTs */	;\
+	jmp	_C_LABEL(Xdoreti)	/* lower spl and do ASTs */	;\
 IDTVEC(stray/**/irq_num)						;\
 	pushl	$irq_num						;\
-	call	_isa_strayintr						;\
+	call	_C_LABEL(isa_strayintr)					;\
 	addl	$4,%esp							;\
 	jmp	6b							;\
 IDTVEC(hold/**/irq_num)							;\
-	orb	$IRQ_BIT(irq_num),_ipending + IRQ_BYTE(irq_num)		;\
+	orb	$IRQ_BIT(irq_num),_C_LABEL(ipending) + IRQ_BYTE(irq_num)	;\
 	INTRFASTEXIT
 
 #if defined(DEBUG) && defined(notdef)
@@@@ -209,7 +209,7 @@@@
 	orl	%eax,%esi
 #define	STRAY_TEST \
 	testl	%esi,%esi						;\
-	jz	_Xstray/**/irq_num
+	jz	_C_LABEL(Xstray)/**/irq_num
 #else /* !DEBUG */
 #define	STRAY_INITIALIZE
 #define	STRAY_INTEGRATE
@@@@ -245,37 +245,51 @@@@
  */
 /* interrupt service routine entry points */
 IDTVEC(intr)
-	.long   _Xintr0, _Xintr1, _Xintr2, _Xintr3, _Xintr4, _Xintr5, _Xintr6
-	.long   _Xintr7, _Xintr8, _Xintr9, _Xintr10, _Xintr11, _Xintr12
-	.long   _Xintr13, _Xintr14, _Xintr15
+	.long   _C_LABEL(Xintr0), _C_LABEL(Xintr1), _C_LABEL(Xintr2)
+	.long	_C_LABEL(Xintr3), _C_LABEL(Xintr4), _C_LABEL(Xintr5)
+	.long	_C_LABEL(Xintr6), _C_LABEL(Xintr7), _C_LABEL(Xintr8)
+	.long	_C_LABEL(Xintr9), _C_LABEL(Xintr10), _C_LABEL(Xintr11)
+	.long	_C_LABEL(Xintr12), _C_LABEL(Xintr13)
+	.long	_C_LABEL(Xintr14), _C_LABEL(Xintr15)
 
 /*
  * These tables are used by Xdoreti() and Xspllower().
  */
 /* resume points for suspended interrupts */
 IDTVEC(resume)
-	.long   _Xresume0, _Xresume1, _Xresume2, _Xresume3, _Xresume4
-	.long   _Xresume5, _Xresume6, _Xresume7, _Xresume8, _Xresume9
-	.long   _Xresume10, _Xresume11, _Xresume12, _Xresume13, _Xresume14
-	.long   _Xresume15
+	.long	_C_LABEL(Xresume0), _C_LABEL(Xresume1)
+	.long	_C_LABEL(Xresume2), _C_LABEL(Xresume3)
+	.long	_C_LABEL(Xresume4), _C_LABEL(Xresume5)
+	.long	_C_LABEL(Xresume6), _C_LABEL(Xresume7)
+	.long	_C_LABEL(Xresume8), _C_LABEL(Xresume9)
+	.long	_C_LABEL(Xresume10), _C_LABEL(Xresume11)
+	.long	_C_LABEL(Xresume12), _C_LABEL(Xresume13)
+	.long	_C_LABEL(Xresume14), _C_LABEL(Xresume15)
 	/* for soft interrupts */
 	.long	0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
-	.long	_Xsofttty, _Xsoftnet, _Xsoftclock
+	.long	_C_LABEL(Xsofttty), _C_LABEL(Xsoftnet)
+	.long	_C_LABEL(Xsoftclock)
 /* fake interrupts to resume from splx() */
 IDTVEC(recurse)
-	.long   _Xrecurse0, _Xrecurse1, _Xrecurse2, _Xrecurse3, _Xrecurse4
-	.long   _Xrecurse5, _Xrecurse6, _Xrecurse7, _Xrecurse8, _Xrecurse9
-	.long   _Xrecurse10, _Xrecurse11, _Xrecurse12, _Xrecurse13, _Xrecurse14
-	.long   _Xrecurse15
+	.long	_C_LABEL(Xrecurse0), _C_LABEL(Xrecurse1)
+	.long	_C_LABEL(Xrecurse2), _C_LABEL(Xrecurse3)
+	.long	_C_LABEL(Xrecurse4), _C_LABEL(Xrecurse5)
+	.long	_C_LABEL(Xrecurse6), _C_LABEL(Xrecurse7)
+	.long	_C_LABEL(Xrecurse8), _C_LABEL(Xrecurse9)
+	.long	_C_LABEL(Xrecurse10), _C_LABEL(Xrecurse11)
+	.long	_C_LABEL(Xrecurse12), _C_LABEL(Xrecurse13)
+	.long	_C_LABEL(Xrecurse14), _C_LABEL(Xrecurse15)
 	/* for soft interrupts */
 	.long	0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
-	.long	_Xsofttty, _Xsoftnet, _Xsoftclock
+	.long	_C_LABEL(Xsofttty), _C_LABEL(Xsoftnet)
+	.long	_C_LABEL(Xsoftclock)
 
 /* Some bogus data, to keep vmstat happy, for now. */
-	.globl	_intrnames, _eintrnames, _intrcnt, _eintrcnt
-_intrnames:
+	.globl	_C_LABEL(intrnames), _C_LABEL(eintrnames)
+	.globl	_C_LABEL(intrcnt), _C_LABEL(eintrcnt)
+_C_LABEL(intrnames):
 	.long	0
-_eintrnames:
-_intrcnt:
+_C_LABEL(eintrnames):
+_C_LABEL(intrcnt):
 	.long	0
-_eintrcnt:
+_C_LABEL(eintrcnt):
Index: src/sys/arch/i386/pci/pchb.c
===================================================================
RCS file: /cvs/src/sys/arch/i386/pci/pchb.c,v
retrieving revision 1.38
diff -u -r1.38 pchb.c
--- src/sys/arch/i386/pci/pchb.c	8 Jan 2003 01:45:45 -0000	1.38
+++ src/sys/arch/i386/pci/pchb.c	4 Mar 2003 16:52:48 -0000
@@@@ -362,7 +362,7 @@@@
 			timersub(&tv2, &tv1, &tv1);
 			if (tv1.tv_sec)
 				tv1.tv_usec += 1000000 * tv1.tv_sec;
-			printf(": rng active, %dKb/sec",
+			printf(": rng active, %ld Kb/sec",
 			    8 * 1000000 / tv1.tv_usec);
 
 			timeout_set(&sc->sc_tmo, pchb_rnd, sc);
Index: src/sys/arch/i386/pci/pci_addr_fixup.c
===================================================================
RCS file: /cvs/src/sys/arch/i386/pci/pci_addr_fixup.c,v
retrieving revision 1.14
diff -u -r1.14 pci_addr_fixup.c
--- src/sys/arch/i386/pci/pci_addr_fixup.c	14 Jun 2002 21:34:36 -0000	1.14
+++ src/sys/arch/i386/pci/pci_addr_fixup.c	4 Mar 2003 16:52:48 -0000
@@@@ -131,8 +131,9 @@@@
 		start = PCIADDR_ISAMEM_RESERVE;
 	sc->mem_alloc_start = (start + 0x100000 + 1) & ~(0x100000 - 1);
 	sc->port_alloc_start = PCIADDR_ISAPORT_RESERVE;
-	PCIBIOS_PRINTV((" Physical memory end: 0x%08x\n PCI memory mapped I/O "
-	    "space start: 0x%08x\n", avail_end, sc->mem_alloc_start));
+	PCIBIOS_PRINTV((" Physical memory end: 0x%08lx\n PCI memory mapped I/O "
+	    "space start: 0x%08lx\n", (unsigned long) avail_end,
+	    (unsigned long) sc->mem_alloc_start));
 
 	if (sc->nbogus == 0)
 		return; /* no need to fixup */
@@@@ -308,11 +309,11 @@@@
 
 	if (pciaddr_ioaddr(pci_conf_read(pc, tag, mapreg)) != *addr) {
 		pci_conf_write(pc, tag, mapreg, 0); /* clear */
-		printf("fixup failed. (new address=%#x)\n", *addr);
+		printf("fixup failed. (new address=%#lx)\n", *addr);
 		return (1);
 	}
 	if (!pcibios_flags & PCIBIOS_VERBOSE)
-		printf("new address 0x%08x\n", *addr);
+		printf("new address 0x%08lx\n", *addr);
 
 	return (0);
 }
Index: src/sys/arch/i386/pci/pcibios.c
===================================================================
RCS file: /cvs/src/sys/arch/i386/pci/pcibios.c,v
retrieving revision 1.27
diff -u -r1.27 pcibios.c
--- src/sys/arch/i386/pci/pcibios.c	12 Jul 2002 21:16:44 -0000	1.27
+++ src/sys/arch/i386/pci/pcibios.c	4 Mar 2003 16:52:48 -0000
@@@@ -164,9 +164,10 @@@@
 	rv = bios32_service(PCIBIOS_SIGNATURE, &pcibios_entry,
 		&pcibios_entry_info);
 
-	PCIBIOS_PRINTV(("pcibiosprobe: 0x%lx:0x%lx at 0x%lx[0x%lx]\n",
+	PCIBIOS_PRINTV(("pcibiosprobe: 0x%x:0x%x at 0x%lx[0x%lx]\n",
 	    pcibios_entry.segment, pcibios_entry.offset,
-	    pcibios_entry_info.bei_base, pcibios_entry_info.bei_size));
+	    (unsigned long) pcibios_entry_info.bei_base,
+	    (unsigned long) pcibios_entry_info.bei_size));
 
 	return rv &&
 	    pcibios_get_status(NULL, &rev_maj, &rev_min, &mech1, &mech2,
Index: src/sys/arch/i386/stand/Makefile.inc
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/Makefile.inc,v
retrieving revision 1.30
diff -u -r1.30 Makefile.inc
--- src/sys/arch/i386/stand/Makefile.inc	2 Dec 2002 09:00:01 -0000	1.30
+++ src/sys/arch/i386/stand/Makefile.inc	4 Mar 2003 16:52:48 -0000
@@@@ -1,7 +1,7 @@@@
 #	$OpenBSD: Makefile.inc,v 1.30 2002/12/02 09:00:23 miod Exp $
 
 CFLAGS=${DEBUG} -Os -Wall -Werror
-CFLAGS+=	-fno-stack-protector
+CFLAGS+=	-fno-stack-protector ${CKERNFLAGS}
 CPPFLAGS+=-I${S} -I${SADIR}/libsa -I. -I${.CURDIR}
 SACFLAGS=-D_STANDALONE
 DEBUGLIBS=no
@@@@ -15,7 +15,7 @@@@
 # DEBUGFLAGS+=-DUNIX_DEBUG
 # DEBUGFLAGS+=-DBOOTP_DEBUG -DNETIF_DEBUG -DETHER_DEBUG
 # DEBUGFLAGS+=-DNFS_DEBUG -DRPC_DEBUG -DRARP_DEBUG
-LINKADDR=0x40000
+LINKADDR=0x40120
 LOADADDR=0x40000
 HEAP_LIMIT=0x90000
 BOOTREL=0x60000
Index: src/sys/arch/i386/stand/biosboot/Makefile
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/biosboot/Makefile,v
retrieving revision 1.20
diff -u -r1.20 Makefile
--- src/sys/arch/i386/stand/biosboot/Makefile	8 Jun 2000 00:55:45 -0000	1.20
+++ src/sys/arch/i386/stand/biosboot/Makefile	4 Mar 2003 16:52:48 -0000
@@@@ -15,7 +15,7 @@@@
 	$(LD) $(LDFLAGS) -o $(PROG) $(OBJS) $(LDADD)
 	@@size $(PROG)
 
-CPPFLAGS+=-DLOADADDR=$(LOADADDR) -DBOOTMAGIC=$(BOOTMAGIC)
+CPPFLAGS+=-DLOADADDR=$(LOADADDR) -DLINKADDR=$(LINKADDR) -DBOOTMAGIC=$(BOOTMAGIC)
 CPPFLAGS+=${DEBUGFLAGS}
 #AFLAGS+=-Wa,-a
 .else
Index: src/sys/arch/i386/stand/biosboot/biosboot.S
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/biosboot/biosboot.S,v
retrieving revision 1.32
diff -u -r1.32 biosboot.S
--- src/sys/arch/i386/stand/biosboot/biosboot.S	28 Aug 2002 20:15:12 -0000	1.32
+++ src/sys/arch/i386/stand/biosboot/biosboot.S	4 Mar 2003 16:52:48 -0000
@@@@ -36,40 +36,35 @@@@
 #include <machine/asm.h>
 #include <assym.h>
 
-#define addr32  .byte 0x67
-#define data32  .byte 0x66
-
-#define	BLKCNT	12
+#define	BLKCNT	52
 
 #define BOOTSEG		0x07c0	/* boot loaded here */
 #define BOOTSTACK	0xfffc	/* stack starts here */
-#define ZMAGIC		0x0b01	/* ZMAGIC */
+#define LFMAGIC		0x464c  /* LFMAGIC (only uses two bytes of \7fELF */
 
 
 /* Clobbers %al - maybe more */
 #define putc(c)			\
 	movb	$c, %al;	\
-	.byte	0xe8;		\
-	.word	Lchr - . - 2
+	call	Lchr;
 
 /* Clobbers %esi - maybe more */
 #define	puts(s)			\
-	data32;			\
-	movl	$s, %esi;	\
-	.byte	0xe8;		\
-	.word	Lmessage - . - 2
+	mov	$s, %si;	\
+	call	Lmessage
 
 
 	.text
-	.globl	start
-start:
+	.code16
+	.globl	_start
+_start:
 	jmp	1f
 	nop
 
-	. = start + 3
+	. = _start + 3
 	.asciz	"OpenBSD"
 	/* BPB */
-	. = start + 0x0b
+	. = _start + 0x0b
 bpb:	.word	DEV_BSIZE	/* sector size */
 	.byte	1		/* sectors/cluster */
 	.word	0		/* reserved sectors */
@@@@ -82,7 +77,7 @@@@
 	.word	0		/* # of heads */
 
 	/* EBPB */
-	. = start + 0x1c
+	. = _start + 0x1c
 ebpb:	.long	16		/* hidden sectors */
 	.long	0		/* large sectors */
 	.word	0		/* physical disk */
@@@@ -92,12 +87,11 @@@@
 	.asciz	"UFS 4.4"
 
 	/* boot code */
-	. = start + 0x3e
+	. = _start + 0x3e
 
 1:
 	/* Fix up %cs just in case */
-	data32
-	ljmp	$BOOTSEG, $1f
+	data32 ljmp	$BOOTSEG, $1f
 
 load_msg:
 	.asciz	"reading boot"
@@@@ -105,32 +99,25 @@@@
 1:
 	/* set up stack (%ss:%esp) */
 	cli			/* disable interrupts w/o stack */
-	xorl	%ax, %ax
-	movl	%ax, %ss
-	data32
+	xor	%ax, %ax
+	mov	%ax, %ss
 	movl	$BOOTSTACK, %esp
 	sti			/* we have stack, do ints */
 
 	/* Set up other segment regs */
-	# movw	$BOOTSEG, %ax
-	.byte	0xb8
-	.word	BOOTSEG
-	movl	%ax, %ds
-	movl	%ax, %es
-	movl	%ax, %fs
-	movl	%ax, %gs
+	mov	$BOOTSEG, %ax
+	mov	%ax, %ds
+	mov	%ax, %es
+	mov	%ax, %fs
+	mov	%ax, %gs
 
 #ifdef SERIAL
 	# Initialize the serial port to 9600 baud, 8N1.
-	pushl	%dx
-	# movw	$0x00e3, %ax
-	.byte	0xb8
-	.word	0x00e3
-	# movw	SERIAL, %dx
-	.byte	0xba
-	.word	SERIAL
+	push	%dx
+	mov	$0x00e3, %ax
+	mov	SERIAL, %dx
 	int	$0x14
-	popl	%dx
+	pop	%dx
 #endif
 
 #ifdef BDEBUG
@@@@ -141,31 +128,25 @@@@
 	puts(load_msg)
 
 	/* set up %es, (where we will load /boot to) */
-	# movw	$(LOADADDR >> 4), %ax
-	.byte	0xb8
-	.word	LOADADDR >> 4
-	movl	%ax, %es
+	mov	$(LOADADDR >> 4), %ax
+	mov	%ax, %es
 
-	data32
 	xorl	%ebx, %ebx		/* put it at %es:0 */
-	addr32
-	movb	_block_count, %cl	/* how many to read */
+	movb	block_count, %cl	/* how many to read */
 	movzbl	%cl, %ecx
-	# movw	$_block_table, %si
-	.byte	0xbe
-	.word	_block_table
+	movw	$block_table, %si
 
 1:
-	pushl	%cx
+	push	%cx
 	putc('.')		/* show progress indicator */
 	cld
-	lodsl	/* word */	/* cylinder/sector */
-	movl	%ax, %cx
+	lodsw	/* word */	/* cylinder/sector */
+	mov	%ax, %cx
 	lodsb			/* head */
 	movb	%al, %dh
 	lodsb			/* # of sectors to load */
 	movb	$0x2, %ah
-	pushl	%ax
+	push	%ax
 	int	$0x13
 	jnc	3f
 
@@@@ -176,29 +157,28 @@@@
 
 3:	/* read next block */
 
-	popl	%ax
-	data32
+	pop	%ax
 	movzbl	%al, %eax
-	shll	$9, %ax		/* 512 bytes sectors */
-	addl	%ax, %bx
-	popl	%cx
+	shl	$9, %ax		/* 512 bytes sectors */
+	add	%ax, %bx
+	pop	%cx
 	loop	1b
 
 	puts(2f)
 
-	xorl	%si, %si
+	xor	%si, %si
 	cld
 	/* check /boot magic */
-	es;lodsl;es;lodsl	/* no need for high word */
-	# cmpw	$ZMAGIC, %ax
-	.byte	0x3d
-	.word	ZMAGIC
+	es;lodsw;es;lodsw	/* no need for high word */
+	cmp	$LFMAGIC, %ax
 	je	3f
 
 	puts(1f)
 halt:
 	cli
+99:
 	hlt
+	jmp 99b
 1:	.ascii	"Bad magic"
 2:	.asciz	"\r\n"
 
@@@@ -212,40 +192,6 @@@@
 	putc('P')
 #endif
 
-	/* change to protected mode */
-	/* guarantee that interrupts are disabled when in prot mode */
-	cli
-
-	/* load the gdtr */
-	addr32
-	data32
-	lgdt	Gdtr
-
-	/* set the PE bit of CR0 */
-	movl	%cr0, %eax
-	data32
-	orl	$CR0_PE, %eax
-	movl	%eax, %cr0 
-
-	/*
-	 * make intrasegment jump to flush the processor pipeline and
-	 * reload CS register
-	 */
-	data32
-	ljmp	$8, $(BOOTSEG << 4) + 1f
-
-1:	/*
-	 * 32bit mode
-	 * set up %ds, %ss, %es, etc
-	 */
-	movl	$0x10, %eax
-	movl	%ax, %ds
-	movl	%ax, %ss
-	movl	%ax, %es
-	movl	%ax, %fs
-	movl	%ax, %gs
-	movl	$BOOTSTACK, %esp
-
 #ifdef	BDEBUG
 	movl	$0xb8004, %ebx
 	movl	$0x074f0747, (%ebx)
@@@@ -256,84 +202,59 @@@@
 	pushl	$BOOTMAGIC	/* use some magic */
 
 	/* jmp	/boot */
-	ljmp	$8, $(LOADADDR + 0x20)
+	/* data32 */
+	ljmp $(LINKADDR >> 4), $0
 	/* not reached */
 
 /*
  * Display string
  */
 Lmessage:
-	data32
-	pushl	%eax
+	push	%ax
 	cld
 1:
 	lodsb			# load a byte into %al
 	testb	%al, %al
 	jz	1f
-	# call	Lchr
-	.byte	0xe8
-	.word	Lchr - . - 2
+	call	Lchr
 	jmp	1b
 
 #
 #	Lchr: write the character in %al to console
 #
 Lchr:
-	data32
-	pushl	%eax
+	push	%ax
 
 #ifndef SERIAL
-	data32
-	pushl	%ebx
+	push	%bx
 	movb	$0x0e, %ah
-	xorl	%bx, %bx
-	incl	%bx		/* movw $0x01, %bx */
+	xor	%bx, %bx
+	inc	%bx		/* movw $0x01, %bx */
 	int	$0x10
-	data32
-	popl	%ebx
+	pop	%bx
 #else
-	data32
-	pushl	%edx
+	push	%dx
 	movb	$0x01, %ah
-	xorl	%dx, %dx
+	xor	%dx, %dx
 	movb	SERIAL, %dl
 	int	$0x14
-	data32
-	popl	%edx
+	pop	%dx
 #endif
 1:
-	data32
-	popl	%eax
+	pop	%ax
 	ret
 
-	.align	3
-1:		/* 0x00 : null */
-	.long	0, 0
-		/* 0x08 : flat code */
-	.word	0xFFFF			# lolimit
-	.word	0			# lobase
-	.byte	0			# midbase
-	.byte	SDT_MEMERAC | 0 | 0x80	# RWXAC, dpl = 0, present
-	.byte	0xf | 0 | 0x40 | 0x80	# hilimit, xx, 32bit, 4k granularity
-	.byte	0			# hibase
-		/* 0x10 : flat data */
-	.word	0xFFFF			# lolimit
-	.word	0			# lobase
-	.byte	0			# midbase
-	.byte	SDT_MEMRWA | 0 | 0x80	# RWA, dpl = 0, present
-	.byte	0xf | 0 | 0x40 | 0x80	# hilimit, xx, 32bit, 4k granularity
-	.byte	0			# hibase
-Gdtr:	.word	. - 1b
-	.long	(BOOTSEG << 4) + 1b
-
-	.globl	_block_table, _block_count
-_block_count:
-	.byte	BLKCNT	/* entries in _block_table */
-_block_table:
+	#.data
+	.globl	block_table, block_count
+	.type block_count, @@function
+	.type block_table, @@function
+block_count:
+	.byte	BLKCNT	/* entries in block_table */
+block_table:
 	.word	0	/* cylinder/sector */
 	.byte	0	/* head */
 	.byte	0	/* nsect */
-	. = _block_table + BLKCNT*4
+	. = block_table + BLKCNT*4
 
 	. = 0x200 - 2
 	/* a little signature */
Index: src/sys/arch/i386/stand/boot/Makefile
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/boot/Makefile,v
retrieving revision 1.29
diff -u -r1.29 Makefile
--- src/sys/arch/i386/stand/boot/Makefile	19 Oct 2000 17:13:39 -0000	1.29
+++ src/sys/arch/i386/stand/boot/Makefile	4 Mar 2003 16:52:48 -0000
@@@@ -15,12 +15,12 @@@@
 CLEANFILES+=	srt0.o
 SRCS=	crt0.c
 .else
-LDFLAGS+=-Ttext $(LINKADDR) -z -x
+LDFLAGS+=-Ttext $(LINKADDR) -N -x -noinhibit-exec
 CLEANFILES+=	crt0.o
 SRCS=	srt0.S
 .endif
 
-SRCS+=	boot.c cmd.c vars.c bootarg.c conf.c
+SRCS+=	boot_loadfile.c cmd.c vars.c bootarg.c conf.c
 S	=${.CURDIR}/../../../..
 SADIR=	${.CURDIR}/..
 
@@@@ -29,9 +29,12 @@@@
 
 .PATH:	${S}/stand/boot
 
+boot.bin: boot
+	objcopy -v -O binary ${PROG} boot.bin
+
 ${PROG}: $(OBJS) $(DPADD)
-	$(LD) $(LDFLAGS) -o $(PROG) $(OBJS) $(LDADD)
-	@@$(SIZE) $(PROG)
+	$(LD) $(LDFLAGS) -o ${PROG} $(OBJS) $(LDADD)
+	@@$(SIZE) ${PROG}
 
 .else
 NOPROG=
@@@@ -40,6 +43,7 @@@@
 .include <bsd.prog.mk>
 
 CPPFLAGS+=-DBOOTMAGIC=$(BOOTMAGIC) ${DEBUGFLAGS}
+CPPFLAGS+=-DLINKADDR=${LINKADDR}
 CFLAGS+=$(SACFLAGS)
 #AFLAGS+=-Wa,-R
 # AFLAGS+=-Wa,-a
Index: src/sys/arch/i386/stand/boot/conf.c
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/boot/conf.c,v
retrieving revision 1.19
diff -u -r1.19 conf.c
--- src/sys/arch/i386/stand/boot/conf.c	21 Jun 2002 21:02:35 -0000	1.19
+++ src/sys/arch/i386/stand/boot/conf.c	4 Mar 2003 16:52:48 -0000
@@@@ -2,6 +2,7 @@@@
 
 /*
  * Copyright (c) 1996 Michael Shalayeff
+ * Copyright (c) 2002 by Thorsten "mirabile" Glaser <x86@@ePost.de>
  * All rights reserved.
  *
  * Redistribution and use in source and binary forms, with or without
@@@@ -18,7 +19,7 @@@@
  * 4. The name of the author may not be used to endorse or promote products
  *    derived from this software without specific prior written permission.
  *
- * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR 
+ * THIS SOFTWARE IS PROVIDED BY THE AUTHOR "AS IS" AND ANY EXPRESS OR 
  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
@@@@ -48,13 +49,16 @@@@
 #include <dev/cons.h>
 #include <lib/libsa/exec.h>
 
-const char version[] = "1.29";
+const char version[] = "2.00p1";
 int	debug = 1;
 
+#if 0
 const struct x_sw execsw[] = {
 	{ "aout", aout_probe, aout_load, aout_ldsym },
+	{ "elf", elf_probe, elf_load, elf_ldsym },
 	{ "",     NULL,       NULL,      NULL       },
 };
+#endif
 
 struct fs_ops file_system[] = {
 	{ ufs_open,    ufs_close,    ufs_read,    ufs_write,    ufs_seek,
@@@@ -103,4 +107,3 @@@@
 	{ NULL }
 };
 struct consdev *cn_tab = constab;
-
Index: src/sys/arch/i386/stand/boot/srt0.S
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/boot/srt0.S,v
retrieving revision 1.10
diff -u -r1.10 srt0.S
--- src/sys/arch/i386/stand/boot/srt0.S	14 May 1998 20:58:51 -0000	1.10
+++ src/sys/arch/i386/stand/boot/srt0.S	4 Mar 2003 16:52:48 -0000
@@@@ -32,33 +32,55 @@@@
  *
  */
 #include <machine/asm.h>
+#include <assym.h>
+
+#define BOOTSTACK 0xfffc
 
 	.globl	_C_LABEL(end)
 	.globl	_C_LABEL(edata)
 	.globl	_C_LABEL(boot)
 	.globl	_C_LABEL(_rtt)
 	.globl	_ASM_LABEL(pmm_init)
+	.globl	Gdtr
 
 	.text
-	.globl	start
-start:
+	.code16
+	.globl	_start
+_start:
+	popl %eax
+	cmpl $BOOTMAGIC, %eax
+	je	1f
 #ifdef DEBUG
 	movl	$0xb80a0, %ebx
 	movl	$0x07420742, (%ebx)
 #endif
+1:
+	popl %edx
+	cli
+	pushl	%cs
+	popl	%ds
+	addr32 data32 lgdt	(Gdtr - LINKADDR)
+	movl	%cr0, %eax
+	orl $CR0_PE, %eax
+	data32 movl %eax, %cr0
+	data32 ljmp $8, $1f
+1:
+	.code32
+	movl	$0x10,%eax
+	mov	%ax,%ds
+	mov	%ax,%ss
+	mov	%ax,%es
+	mov	%ax,%fs
+	mov	%ax,%gs
+	movl	$BOOTSTACK,%esp
+	pushl	%edx
+
+	/* Now do it all */
 	call	_ASM_LABEL(pmm_init)
 #ifdef DEBUG
 	movl	$0xb80a4, %ebx
 	movl	$0x07520752, (%ebx)
 #endif
-	popl	%eax
-	cmpl	$BOOTMAGIC, %eax
-	je	1f
-#ifdef DEBUG
-	movl	$0xb80a8, %ebx
-	movl	$0xcf41cf4d, (%ebx)
-#endif
-1:
 	/* zero .bss */
 	xorl	%eax, %eax
 	movl	$_C_LABEL(end), %ecx
Index: src/sys/arch/i386/stand/installboot/installboot.c
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/installboot/installboot.c,v
retrieving revision 1.37
diff -u -r1.37 installboot.c
--- src/sys/arch/i386/stand/installboot/installboot.c	3 May 2002 13:58:46 -0000	1.37
+++ src/sys/arch/i386/stand/installboot/installboot.c	4 Mar 2003 16:52:48 -0000
@@@@ -52,6 +52,7 @@@@
 
 #include <err.h>
 #include <a.out.h>
+#include <sys/exec_elf.h>
 #include <fcntl.h>
 #include <nlist.h>
 #include <stdlib.h>
@@@@ -170,7 +171,7 @@@@
 
 	/* XXX - Paranoia: Make sure size is aligned! */
 	if (protosize & (DEV_BSIZE - 1))
-		err(1, "proto bootblock bad size=%ld", protosize);
+		err(1, "proto %s bad size=%ld", proto, protosize);
 
 	/* Write patched proto bootblocks into the superblock */
 	if (protosize > SBSIZE - DEV_BSIZE)
@@@@ -258,7 +259,9 @@@@
 	size_t	tdsize;		/* text+data size */
 	char	*bp;
 	struct	nlist *nlp;
-	struct	exec eh;
+	Elf_Ehdr eh;
+	Elf_Word phsize;
+	Elf_Phdr *ph;
 
 	fd = -1;
 	bp = NULL;
@@@@ -270,8 +273,9 @@@@
 	}
 	/* Validate symbol types (global data). */
 	for (nlp = nl; nlp->n_un.n_name; nlp++) {
-		if (nlp->n_type != (N_TEXT | N_EXT)) {
-			warnx("nlist: %s: wrong type", nlp->n_un.n_name);
+		if (nlp->n_type != (N_TEXT)) {
+			warnx("nlist: %s: wrong type %x", nlp->n_un.n_name,
+			nlp->n_type);
 			return NULL;
 		}
 	}
@@@@ -284,16 +288,35 @@@@
 		warn("read: %s", fname);
 		goto bad;
 	}
-	if (N_GETMAGIC(eh) != OMAGIC) {
-		warn("bad magic: 0x%x", eh.a_midmag);
-		goto bad;
+	if (!IS_ELF(eh)) {
+		errx(1, "%s: bad magic: 0x%02x%02x%02x%02x",
+		boot,
+		eh.e_ident[EI_MAG0], eh.e_ident[EI_MAG1],
+		eh.e_ident[EI_MAG2], eh.e_ident[EI_MAG3]);
 	}
 	/*
 	 * We have to include the exec header in the beginning of
 	 * the buffer, and leave extra space at the end in case
 	 * the actual write to disk wants to skip the header.
 	 */
-	tdsize = eh.a_text + eh.a_data;
+
+	/* program load header */
+	if (eh.e_phnum != 1) {
+		errx(1, "%s: only supports one ELF load section\n", boot);
+	}
+	phsize = eh.e_phnum * sizeof(Elf_Phdr);
+	ph = malloc(phsize);
+	if (ph == NULL) {
+		errx(1, "%s: unable to allocate program header space\n",
+		    boot);
+	}
+	lseek(fd,  eh.e_phoff, SEEK_SET);
+
+	if (read(fd, ph, phsize) != phsize) {
+		errx(1, "%s: unable to read program header space\n", boot);
+	}
+
+	tdsize = ph->p_filesz;
 
 	/*
 	 * Allocate extra space here because the caller may copy
@@@@ -305,6 +328,7 @@@@
 		goto bad;
 	}
 	/* Read the rest of the file. */
+	lseek(fd, ph->p_offset, SEEK_SET);
 	if (read(fd, bp, tdsize) != tdsize) {
 		warn("read: %s", fname);
 		goto bad;
@@@@ -318,7 +342,7 @@@@
 	maxblocknum = *block_count_p;
 
 	if (verbose) {
-		fprintf(stderr, "%s: entry point %#x\n", fname, eh.a_entry);
+		fprintf(stderr, "%s: entry point %#x\n", fname, eh.e_entry);
 		fprintf(stderr, "proto bootblock size %ld\n", *size);
 		fprintf(stderr, "room for %d filesystem blocks at %#lx\n",
 			maxblocknum, nl[X_BLOCK_TABLE].n_value);
@@@@ -368,7 +392,9 @@@@
 	struct dinode	*ip;
 	int		ndb;
 	u_int8_t	*bt;
-	struct exec	eh;
+#if 0
+	Elf_Ehdr	eh;
+#endif
 	int mib[4];
 	size_t		size;
 	dev_t dev;
@@@@ -392,13 +418,18 @@@@
 		errx(1, "%s: must be on an FFS filesystem", boot);
 	}
 
+#if 0
 	if (read(fd, &eh, sizeof(eh)) != sizeof(eh)) {
 		errx(1, "read: %s", boot);
 	}
 
-	if (N_GETMAGIC(eh) != ZMAGIC) {
-		errx(1, "%s: bad magic: 0x%x", boot, eh.a_midmag);
+	if (!IS_ELF(eh)) {
+		errx(1, "%s: bad magic: 0x%02x%02x%02x%02x",
+		boot,
+		eh.e_ident[EI_MAG0], eh.e_ident[EI_MAG1],
+		eh.e_ident[EI_MAG2], eh.e_ident[EI_MAG3]);
 	}
+#endif
 
 	if (fsync(fd) != 0)
 		err(1, "fsync: %s", boot);
Index: src/sys/arch/i386/stand/libsa/Makefile
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/libsa/Makefile,v
retrieving revision 1.39
diff -u -r1.39 Makefile
--- src/sys/arch/i386/stand/libsa/Makefile	20 Jun 2002 20:22:36 -0000	1.39
+++ src/sys/arch/i386/stand/libsa/Makefile	4 Mar 2003 16:52:48 -0000
@@@@ -10,7 +10,7 @@@@
 DIR_KERN=$S/lib/libkern
 
 # i386 stuff (so, it will possibly load in the same 64k)
-SRCS+=	machdep.c dev_i386.c exec_i386.c cmd_i386.c
+SRCS+=	machdep.c dev_i386.c exec_i386.c cmd_i386.c loadfile.c
 
 .if defined(DEBUGFLAGS) && !empty(DEBUGFLAGS:M-D_TEST)
 SRCS+=	unixdev.c unixsys.S nullfs.c memprobe.c
@@@@ -29,7 +29,7 @@@@
 # stand routines
 SRCS+=	alloc.c exit.c getfile.c gets.c globals.c strcmp.c strlen.c \
 	strncmp.c memcmp.c memcpy.c memset.c printf.c strerror.c strncpy.c \
-	strtol.c ctime.c exec.new.c exec_aout.c
+	strtol.c ctime.c
 
 # io routines
 SRCS+=	close.c closeall.c dev.c disklabel.c dkcksum.c fstat.c ioctl.c lseek.c \
Index: src/sys/arch/i386/stand/libsa/alloca.S
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/libsa/alloca.S,v
retrieving revision 1.2
diff -u -r1.2 alloca.S
--- src/sys/arch/i386/stand/libsa/alloca.S	24 Feb 1998 22:06:22 -0000	1.2
+++ src/sys/arch/i386/stand/libsa/alloca.S	4 Mar 2003 16:52:48 -0000
@@@@ -55,4 +55,4 @@@@
 	pushl	4(%ecx)
 	pushl	0(%ecx)
 	pushl	%eax		/* dummy to pop at callsite */
-	jmp	%edx		/* "return" */
+	jmp	*%edx		/* "return" */
Index: src/sys/arch/i386/stand/libsa/apmprobe.c
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/libsa/apmprobe.c,v
retrieving revision 1.9
diff -u -r1.9 apmprobe.c
--- src/sys/arch/i386/stand/libsa/apmprobe.c	20 Jun 2002 20:22:36 -0000	1.9
+++ src/sys/arch/i386/stand/libsa/apmprobe.c	4 Mar 2003 16:52:48 -0000
@@@@ -68,6 +68,8 @@@@
 
 extern int debug;
 
+static int apm_is_connected;
+
 static __inline u_int
 apm_check()
 {
@@@@ -101,6 +103,7 @@@@
 			 : "=a" (rv)
 			 : "0" (APM_DISCONNECT), "b" (APM_DEV_APM_BIOS)
 			 : "%ecx", "%edx", "cc");
+	if (!(rv & 0xff)) apm_is_connected = 0;
 	return (rv & 0xff)? rv >> 8 : 0;
 }
 
@@@@ -145,6 +148,7 @@@@
 			ai->apm_code16_base, ai->apm_code16_len,
 			ai->apm_data_base,   ai->apm_data_len);
 #endif
+	apm_is_connected = 2;
 	/* inform apm bios about our driver version */
 	__asm __volatile (DOINT(0x15) "\n\t"
 			  "setc %b1\n\t"
@@@@ -158,8 +162,61 @@@@
 	return 0;
 }
 
+static __inline int
+apm_driver_version(v)
+{
+	register u_int16_t rv;
+	__asm __volatile(DOINT(0x15) "\n\t"
+			 "setc %b0"
+			 : "=a" (rv)
+			 : "0" (APM_DRIVER_VERSION), "b" (APM_DEV_APM_BIOS), "c" (v)
+			 : "%edx", "cc");
+	return (rv & 0xff)? rv >> 8 : 0;
+}
+
+static __inline int
+apm_connect_real(ai)
+	bios_apminfo_t *ai;
+{
+	register u_int16_t f;
+	__asm __volatile (DOINT(0x15) "\n\t"
+			  "setc %b1\n\t"
+			  "movb %%ah, %h1\n\t"
+			  "movzwl %%ax, %%eax\n\tshll $4, %0\n\t"
+			  "movzwl %%cx, %%ecx\n\tshll $4, %2\n\t"
+			  "movzwl %%dx, %%edx\n\tshll $4, %3\n\t"
+			  : "=a" (ai->apm_code32_base),
+			    "=b" (f),
+			    "=c" (ai->apm_code16_base),
+			    "=d" (ai->apm_data_base)
+			  : "0" (APM_REAL_CONNECT), "1" (APM_DEV_APM_BIOS)
+			  : "cc");
+	ai->apm_entry    = BIOS_regs.biosr_bx;
+#if 0
+	ai->apm_code_len = BIOS_regs.biosr_si & 0xffff;
+	ai->apm_data_len = BIOS_regs.biosr_di & 0xffff;
+#else
+	ai->apm_code_len = 0x10000;
+	ai->apm_data_len = 0x10000;
+#endif
+	if (!(f & 0xff)) apm_is_connected = 1;
+	return (f & 0xff)? f >> 8 : 0;
+}
+
 static bios_apminfo_t ai;
 
+static __inline int
+apm_set_power_state(devices, how)
+{
+	register u_int16_t rv;
+	__asm __volatile(DOINT(0x15) "\n\t"
+			 "setc %b0"
+			 : "=a" (rv)
+			 : "0" (APM_SET_PWR_STATE), "b" (devices), "c" (how)
+			 : "%edx", "cc");
+	return (rv & 0xff)? rv >> 8 : 0;
+}
+
 void
 apmprobe()
 {
@@@@ -171,13 +228,12 @@@@
 #ifdef DEBUG
 		if (debug)
 			printf("apm[%x cs=%x[%x]/%x[%x] ds=%x[%x] @@ %x]",
-			       ai.apm_detail,
-			       ai.apm_code32_base, ai.apm_code_len,
-			       ai.apm_code16_base, ai.apm_code16_len,
-			       ai.apm_data_base, ai.apm_data_len,
-			       ai.apm_entry);
-		else
-			printf(" apm");
+			    ai.apm_detail,
+			    ai.apm_code32_base, ai.apm_code_len,
+			    ai.apm_code16_base, ai.apm_code16_len,
+			    ai.apm_data_base, ai.apm_data_len,
+			    ai.apm_entry);
+		  else	printf(" apm");
 #else
 		printf(" apm");
 #endif
@@@@ -196,3 +252,48 @@@@
 			i386_round_page(ai.apm_data_base + ai.apm_data_len));
 }
 
+void
+apmturnoff(a1,a2)
+	int a1, a2;
+{
+	bios_apminfo_t ai;
+	int f;
+
+	if (a1 == -1) a1 = APM_DEV_ALLDEVS;
+	if (a2 == -1) a2 = APM_SYS_OFF;
+	if ((ai.apm_detail = apm_check())) {
+
+		apm_disconnect();
+		if (apm_connect_real(&ai) != 0)
+			printf("apmturnoff: connect error\n");
+		else {
+			f = apm_driver_version(0x0102);
+			if (f) {
+				f = apm_driver_version(0x0101);
+				if (f)
+					printf ("apmturnoff: driver_version returned %x\n", f);
+				  else	printf ("apmturnoff: 1.1 connection\n");
+			}
+
+			f = apm_set_power_state(a1, a2);
+			printf ("apmturnoff: apm_set_power_state returned %x\n",
+				 f);
+			printf ("apmturnoff: detail=%x\n",
+				ai.apm_detail);
+		}
+	} else
+		printf ("apmturnoff: apm_check returned 0\n");
+}
+
+/*
+ *	if we are booting into DOS, we should not
+ *	leave apm connected in "real mode".  Try to
+ *	leave apm in the "reset" state.
+ */
+
+void
+apm_reset()
+{
+	if (apm_is_connected)
+		apm_disconnect();
+}
Index: src/sys/arch/i386/stand/libsa/bioscons.c
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/libsa/bioscons.c,v
retrieving revision 1.21
diff -u -r1.21 bioscons.c
--- src/sys/arch/i386/stand/libsa/bioscons.c	17 Jan 2003 20:58:05 -0000	1.21
+++ src/sys/arch/i386/stand/libsa/bioscons.c	4 Mar 2003 16:52:48 -0000
@@@@ -183,7 +183,7 @@@@
 		err = -err;
 	if (err > COM_TOLERANCE)
 		return -1;
-#undef  divrnd(n, q)
+#undef  divrnd
 
 	if (cn_tab && cn_tab->cn_dev == dev && com_speed != sp)
 	{
Index: src/sys/arch/i386/stand/libsa/biosdev.c
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/libsa/biosdev.c,v
retrieving revision 1.54
diff -u -r1.54 biosdev.c
--- src/sys/arch/i386/stand/libsa/biosdev.c	14 Mar 2002 03:15:32 -0000	1.54
+++ src/sys/arch/i386/stand/libsa/biosdev.c	4 Mar 2003 16:52:48 -0000
@@@@ -2,6 +2,7 @@@@
 
 /*
  * Copyright (c) 1996 Michael Shalayeff
+ * Copyright (c) 2002 by Thorsten "mirabile" Glaser <x86@@ePost.de>
  * All rights reserved.
  *
  * Redistribution and use in source and binary forms, with or without
@@@@ -18,7 +19,7 @@@@
  * 4. The name of the author may not be used to endorse or promote products
  *    derived from this software without specific prior written permission.
  *
- * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR 
+ * THIS SOFTWARE IS PROVIDED BY THE AUTHOR "AS IS" AND ANY EXPRESS OR 
  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
@@@@ -189,7 +190,7 @@@@
 			  "xchgb %%ch, %%cl\n\t"
 			  "rorb  $2, %%cl\n\t"
 			  "orb %b5, %%cl\n\t"
-			  "incl %%cx\n\t"
+			  "inc %%cx\n\t"
 			  DOINT(0x13) "\n\t"
 			  "setc %b0"
 			  : "=a" (rv)
@@@@ -453,12 +454,13 @@@@
 #endif
 
 	/* Try for disklabel again (might be removable media) */
-	if(dip->bios_info.flags & BDI_BADLABEL){
-		const char *st = bios_getdisklabel((void *)biosdev, &dip->disklabel);
-		if (debug && st)
+	if(dip->bios_info.flags & BDI_BADLABEL) {
+		const char *st = bios_getdisklabel(&dip->bios_info, &dip->disklabel);
+		if (st != NULL) {
 			printf("%s\n", st);
-
-		return ERDLAB;
+			return ERDLAB;
+		}
+		dip->bios_info.flags &= !BDI_BADLABEL;
 	}
 
 	f->f_devdata = dip;
@@@@ -618,4 +620,3 @@@@
 {
 	return 0;
 }
-
Index: src/sys/arch/i386/stand/libsa/cmd_i386.c
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/libsa/cmd_i386.c,v
retrieving revision 1.24
diff -u -r1.24 cmd_i386.c
--- src/sys/arch/i386/stand/libsa/cmd_i386.c	14 Mar 2002 03:15:32 -0000	1.24
+++ src/sys/arch/i386/stand/libsa/cmd_i386.c	4 Mar 2003 16:52:48 -0000
@@@@ -50,6 +50,7 @@@@
 int Xdiskinfo(void);
 int Xmemory(void);
 int Xregs(void);
+int Xturnoff (void);
 
 /* From gidt.S */
 int bootbuf(void *, int);
@@@@ -61,6 +62,7 @@@@
 #ifdef DEBUG
 	{ "regs",     CMDT_CMD, Xregs },
 #endif
+	{ "off",	CMDT_CMD, Xturnoff },
 	{ NULL, 0 }
 };
 
@@@@ -83,6 +85,27 @@@@
 #endif
 
 int
+Xturnoff()
+{
+	int a1, a2;
+	a1 = a2 = -1;
+	switch(cmd.argc)
+	{
+	case 0:
+		printf("machine off [dev [how] ]\n");
+		return 0;
+	case 1:
+		break;
+	case 3:
+		a2 = strtol(cmd.argv[2], NULL, 0);
+	case 2:
+		a1 = strtol(cmd.argv[1], NULL, 0);
+	}
+	apmturnoff(a1, a2);
+	return 0;
+}
+
+int
 Xboot()
 {
 #ifndef _TEST
@@@@ -112,7 +135,7 @@@@
 	dev += (cmd.argv[1][2] - '0');
 	part = (cmd.argv[1][3] - 'a');
 
-	if (part > 0)
+	if (part >= 0)
 		printf("[%x,%d]\n", dev, part);
 	else
 		printf("[%x]\n", dev);
@@@@ -122,7 +145,7 @@@@
 	if(st) goto bad;
 
 	/* Frob boot flag in buffer from HD */
-	if((dev & 0x80) && (part > 0)){
+	if((dev & 0x80) && (part >= 0)) {
 		int i, j;
 
 		for(i = 0, j = DOSPARTOFF; i < 4; i++, j += 16)
@@@@ -131,6 +154,7 @@@@
 			else
 				buf[j] &= ~0x80;
 	}
+	apm_reset();
 
 	/* Load %dl, ljmp */
 	bcopy(buf, dest, DEV_BSIZE);
Index: src/sys/arch/i386/stand/libsa/debug_i386.S
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/libsa/debug_i386.S,v
retrieving revision 1.9
diff -u -r1.9 debug_i386.S
--- src/sys/arch/i386/stand/libsa/debug_i386.S	18 Apr 1998 07:39:25 -0000	1.9
+++ src/sys/arch/i386/stand/libsa/debug_i386.S	4 Mar 2003 16:52:48 -0000
@@@@ -89,9 +89,9 @@@@
 	movl	$0x47334732, (%edi)
 #endif
 	movl	$0x10, %eax
-	movl	%ax, %ds
-	movl	%ax, %es
-	movl	$_reg, %edi
+	mov	%ax, %ds
+	mov	%ax, %es
+	movl	$reg, %edi
 	cld
 	movl	0x0c*4(%esp), %eax; stosl /* %eax	*/
 	movl	0x0b*4(%esp), %eax; stosl /* %ecx	*/
@@@@ -104,7 +104,7 @@@@
 	movl	0x0f*4(%esp), %eax; stosl /* %eip	*/
 	movl	0x11*4(%esp), %eax; stosl /* %eflags	*/
 	movl	0x10*4(%esp), %eax; stosl /* %cs	*/
-	movl		%ss,  %ax ; stosl /* %ss	*/
+	mov		%ss,  %ax ; stosl /* %ss	*/
 	movl	0x04*4(%esp), %eax; stosl /* %ds	*/
 	movl	0x03*4(%esp), %eax; stosl /* %es	*/
 	movl	0x02*4(%esp), %eax; stosl /* %fs	*/
Index: src/sys/arch/i386/stand/libsa/diskprobe.c
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/libsa/diskprobe.c,v
retrieving revision 1.18
diff -u -r1.18 diskprobe.c
--- src/sys/arch/i386/stand/libsa/diskprobe.c	14 Mar 2002 01:26:12 -0000	1.18
+++ src/sys/arch/i386/stand/libsa/diskprobe.c	4 Mar 2003 16:52:48 -0000
@@@@ -2,6 +2,7 @@@@
 
 /*
  * Copyright (c) 1997 Tobias Weingartner
+ * Copyright (c) 2002 by Thorsten "mirabile" Glaser <x86@@ePost.de>
  * All rights reserved.
  *
  * Redistribution and use in source and binary forms, with or without
@@@@ -18,7 +19,7 @@@@
  * 4. The name of the author may not be used to endorse or promote products
  *    derived from this software without specific prior written permission.
  *
- * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR 
+ * THIS SOFTWARE IS PROVIDED BY THE AUTHOR "AS IS" AND ANY EXPRESS OR 
  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
@@@@ -84,10 +85,8 @@@@
 
 		/* Fill out best we can - (fd?) */
 		dip->bios_info.bsd_dev = MAKEBOOTDEV(2, 0, 0, i, RAW_PART);
-		if((bios_getdisklabel(&dip->bios_info, &dip->disklabel)) != 0) 
-			dip->bios_info.flags |= BDI_BADLABEL;
-		else
-			dip->bios_info.flags |= BDI_GOODLABEL;
+		/* Defer disklabel lookup until it is needed -mirabile */
+		dip->bios_info.flags |= BDI_BADLABEL;
 
 		/* Add to queue of disks */
 		TAILQ_INSERT_TAIL(&disklist, dip, list);
@@@@ -121,7 +120,7 @@@@
 		printf(" hd%u%s", i&0x7f, (dip->bios_info.bios_edd > 0?"+":""));
 
 		/* Try to find the label, to figure out device type */
-		if((bios_getdisklabel(&dip->bios_info, &dip->disklabel)) ) {
+		if (bios_getdisklabel(&dip->bios_info, &dip->disklabel) != NULL) {
 			printf("*");
 			bsdunit = ide++;
 			type = 0;	/* XXX let it be IDE */
@@@@ -304,4 +303,3 @@@@
 
 	return (reprobe);
 }
-
Index: src/sys/arch/i386/stand/libsa/exec_i386.c
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/libsa/exec_i386.c,v
retrieving revision 1.26
diff -u -r1.26 exec_i386.c
--- src/sys/arch/i386/stand/libsa/exec_i386.c	5 Mar 2000 18:40:37 -0000	1.26
+++ src/sys/arch/i386/stand/libsa/exec_i386.c	4 Mar 2003 16:52:48 -0000
@@@@ -41,17 +41,15 @@@@
 #include <sys/disklabel.h>
 #include "disk.h"
 #include "libsa.h"
-#include <lib/libsa/exec.h>
+#include <lib/libsa/loadfile.h>
 
 typedef void (*startfuncp)(int, int, int, int, int, int, int, int)
 	__attribute__ ((noreturn));
 
 void
-machdep_exec(xp, howto, loadaddr)
-	struct x_param *xp;
-	int howto;
-	void *loadaddr;
+run_loadfile(u_long *marks, int howto)
 {
+	u_long entry;
 #ifndef _TEST
 #ifdef EXEC_DEBUG
 	extern int debug;
@@@@ -71,25 +69,12 @@@@
 
 	makebootargs(av, &ac);
 
-#ifdef EXEC_DEBUG
-	if (debug) {
-		struct exec *x = (void *)loadaddr;
-		printf("exec {\n\ta_midmag = %x\n\ta_text = %x\n\ta_data = %x\n"
-		       "\ta_bss = %x\n\ta_syms = %x\n\ta_entry = %x\n"
-		       "\ta_trsize = %x\n\ta_drsize = %x\n}\n",
-		       x->a_midmag, x->a_text, x->a_data, x->a_bss, x->a_syms,
-		       x->a_entry, x->a_trsize, x->a_drsize);
-
-		printf("/bsd(%x,%u,%p)\n", BOOTARG_APIVER, ac, av);
-		getchar();
-	}
-#endif
-	xp->xp_entry &= 0xffffff;
+	entry = marks[MARK_ENTRY] & 0x0fffffff;
 
-	printf("entry point at 0x%x\n", xp->xp_entry);
+	printf("entry point at 0x%x\n", (int) entry);
 	/* stack and the gung is ok at this point, so, no need for asm setup */
-	(*(startfuncp)xp->xp_entry)(howto, bootdev, BOOTARG_APIVER,
-		xp->xp_end, extmem, cnvmem, ac, (int)av);
+	(*(startfuncp)entry)(howto, bootdev, BOOTARG_APIVER,
+		marks[MARK_END], extmem, cnvmem, ac, (int)av);
 	/* not reached */
 #endif
 }
Index: src/sys/arch/i386/stand/libsa/gidt.S
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/libsa/gidt.S,v
retrieving revision 1.24
diff -u -r1.24 gidt.S
--- src/sys/arch/i386/stand/libsa/gidt.S	17 Sep 2001 13:09:47 -0000	1.24
+++ src/sys/arch/i386/stand/libsa/gidt.S	4 Mar 2003 16:52:48 -0000
@@@@ -41,9 +41,6 @@@@
 #undef _LOCORE
 #include <assym.h>
 
-#define addr32  .byte 0x67
-#define data32  .byte 0x66
-
 #define	SNULL	0x00
 #define S32TEXT	0x08
 #define	S32DATA	0x10
@@@@ -52,26 +49,17 @@@@
 
 #ifdef GIDT_DEBUG
 #define	gidt_debug0		; \
-	movl	$0xb8000, %eax	; \
-	movl	$0x47314730, (%eax)
+	mov	$0xb8000, %eax	; \
+	mov	$0x47314730, (%eax)
 #define	gidt_debug1		; \
-	data32			; \
-	movl	$(0xb8000 - LINKADDR), %eax	; \
-	data32			; \
-	addr32			; \
-	movl	$0x4f314f30, (%eax)
+	mov	$(0xb8000 - LINKADDR), %eax	; \
+	mov	$0x4f314f30, (%eax)
 #define	gidt_debug2		; \
-	data32			; \
-	movl	$0xb8004, %eax	; \
-	data32			; \
-	addr32			; \
-	movl	$0x47334732, (%eax)
+	mov	$0xb8004, %eax	; \
+	mov	$0x47334732, (%eax)
 #define	gidt_debug3		; \
-	data32			; \
-	movl	$0xb8004, %eax	; \
-	data32			; \
-	addr32			; \
-	movl	$0x4f334f32, (%eax)
+	mov	$0xb8004, %eax	; \
+	mov	$0x4f334f32, (%eax)
 #define gidt_debug4		; \
 	movl	$0xb8008, %eax	; \
 	movl	$0x47344733, (%eax)
@@@@ -86,58 +74,47 @@@@
 #define prot2real						\
 	gidt_debug0;						\
 								\
-	movl	$S16DATA, %ax;					\
-	/* ljmp	$S16TEXT, $1f */;				\
-	.byte	0xea;		/* Change to 16bit mode */	\
-	.long	1f - LINKADDR;					\
-	.word	S16TEXT;					\
+	ljmp	$S16TEXT, $1f - LINKADDR;			\
 1:								\
-	movl	%ax, %ds;					\
-	movl	%ax, %es;					\
+	.code16;						\
+	movw	$S16DATA, %ax;					\
+	mov	%ax, %ds;					\
+	mov	%ax, %es;					\
 	gidt_debug1;						\
 								\
 	movl	%cr0, %eax;	/* disable pmmm */		\
-	data32;							\
 	andl 	$~CR0_PE, %eax;					\
 	movl	%eax, %cr0;					\
 								\
-	/* ljmp	(LINKADDR >> 4), $1f */;			\
-	.byte	0xea;		/* load real mode cs:ip */	\
-	.word	1f;						\
-	.word	(LINKADDR >> 4);				\
+	/* reload real cs:ip */					\
+	data32 ljmp	$(LINKADDR >> 4), $1f - LINKADDR;	\
 1:								\
-	data32;							\
-	xorl	%eax, %eax;	/* setup: %ds, %es, %ss */	\
-	movl	%ax, %ds;					\
-	movl	%ax, %es;					\
-	movl	%ax, %ss;					\
+	xor	%ax, %ax;	/* setup: %ds, %es, %ss */	\
+	mov	%ax, %ds;					\
+	mov	%ax, %es;					\
+	mov	%ax, %ss;					\
 								\
 	gidt_debug2;						\
 								\
-	addr32;							\
-	data32;							\
-	lidt	Idtr_real;	/* load idtr for real mode */
+	data32 addr32 lidt Idtr_real;	/* load idtr for real mode */
 
 #define real2prot						\
 	gidt_debug3;						\
 								\
-	addr32;							\
-	data32;							\
-	lgdt	Gdtr;		/* load the gdtr */		\
+	data32 addr32 lgdt Gdtr;	/* load the gdtr */	\
 								\
 	movl	%cr0, %eax;	/* enable pmmm */		\
-	data32;							\
 	orl	$CR0_PE, %eax;					\
 	movl	%eax, %cr0;					\
 								\
-	data32;							\
-	ljmp	$S32TEXT, $1f;   /* reload %cs,flush pipeline */\
+	data32 ljmp	$S32TEXT, $1f;   /* reload %cs,flush pipeline */\
 1:								\
+	.code32;						\
 	/* reload 32bit %ds, %ss, %es */			\
-	movl	$S32DATA, %eax;					\
-	movl	%ax, %ds;					\
-	movl	%ax, %ss;					\
-	movl	%ax, %es;					\
+	mov	$S32DATA, %eax;					\
+	mov	%ax, %ds;					\
+	mov	%ax, %ss;					\
+	mov	%ax, %es;					\
 								\
 	gidt_debug4;						\
 								\
@@@@ -148,6 +125,7 @@@@
 	.globl	_C_LABEL(BIOS_regs)
 
 	.text
+	.code32
 	.globl	_ASM_LABEL(pmm_init)
 	.globl	_C_LABEL(_rtt)
 
@@@@ -187,30 +165,21 @@@@
 	movl	$0, %esp	/* segment violation */
 	ret
 
-	.align	3, 0x90
+	.align	8, 0x90
 pmm_init:
-	/* reload new gdt */
-	lgdt	Gdtr
-	ljmp	$S32TEXT, $1f
-1:	
-	movl	$S32DATA, %eax
-	movl	%eax, %ds
-	movl	%eax, %ss
-	movl	%eax, %es
-	movl	%eax, %fs
-	movl	%eax, %gs
-
 	/* load idtr for interrupts */
 	lidt	Idtr
 	ret
 
+
 #define IPROC(n)	X/**/n
 #define IEMU(n)		IPROC(emu/**/n)
-	.align 3
+	.align 8, 0x90
 idt:
 #define idte(e)	\
-	.word IPROC(e), S32TEXT, (0x80|SDT_SYS386TGT) << 8, (LINKADDR >> 16)
-		/* internal (0-31) */
+	.short	IPROC(e); .short (S32TEXT); \
+	.short	((0x80|SDT_SYS386TGT) << 8); .short (LINKADDR >> 16)
+/* internal (0-31) */
 	idte(de); idte(db); idte(nmi); idte(bp); idte(of); idte(br)
 	idte(ud); idte(nm); idte(df);  idte(fo); idte(ts); idte(np)
 	idte(ss); idte(gp); idte(pf);  idte(xx); idte(mf); idte(ac)
@@@@ -235,15 +204,15 @@@@
 	.long	idt
 	.word	0
 
-	.align	3
+	.align	8
 Idtr_real:	.word	1023
 		.long	0
 		.word	0
 
-	.align	3
+	.align	8
 Idtr_reset:	.long	0, 0
 
-	.align	3
+	.align	8
 gdt:
 		/* 0x00 : null */
 	.space	8
@@@@ -276,6 +245,7 @@@@
 	.byte	0xf | 0 | 0 | 0		# hilimit, xx, 16bit, byte granularity
 	.byte	(LINKADDR >> 20) & 0xff	# hibase
 
+.globl Gdtr
 Gdtr:	.word	. - gdt - 1
 	.long	gdt
 	.word	0
@@@@ -344,109 +314,100 @@@@
  *
  */
 	.globl	EMUh
-	.align	3, 0x90
+	.align	8, 0x90
 EMUh:
 	/* save %eax */
-	movl	%eax, 3f
-	popl	%eax
+	mov	%eax, 3f
+	pop	%eax
 
-	pushal
-	pushl	%ds
-	pushl	%es
-	pushl	%fs
-	pushl	%gs
+	pusha
+	push	%ds
+	push	%es
+	push	%fs
+	push	%gs
 
 	/* save BIOS int vector */
-	movb	%al, intno
+	mov	%al, intno
 
 	prot2real
 
-	pushl	%ds
+	push	%ds
 
-	addr32
-	movl	_C_LABEL(BIOS_regs)+(BIOSR_ES), %eax
-	movl	%ax, %es
-	addr32
-	movl	_C_LABEL(BIOS_regs)+(BIOSR_DS), %eax
-	movl	%ax, %ds
-
-	data32
-	# movl	$Leax, %eax
-	.byte	0xb8
-3:	.long	0x90909090	/* restore %eax */
+	addr32  mov _C_LABEL(BIOS_regs)+(BIOSR_ES), %eax
+	mov	%ax, %es
+	addr32  mov _C_LABEL(BIOS_regs)+(BIOSR_DS), %eax
+	mov	%ax, %ds
+
+	# data32 movl $Leax, %eax
+	.byte	0x66, 0xb8
+3:	.long	0x90909090
 
 	;sti
 	int	$0
 intno	= . - 1
 	;cli
 
-	popl	%ds
+	pop	%ds
 
-	addr32
-	data32
-	movl	%ebx, _C_LABEL(BIOS_regs)+(BIOSR_BX)
-	movl	%es, %bx
-	addr32
-	movl	%bx, _C_LABEL(BIOS_regs)+(BIOSR_ES)
-	movb	%ah, %bh	/* save flags to return to caller */
+	addr32 mov %ebx, _C_LABEL(BIOS_regs)+(BIOSR_BX)
+	mov	%es, %bx
+	addr32 mov %ebx, _C_LABEL(BIOS_regs)+(BIOSR_ES)
+	movb	%ah, %bh
 	lahf
 	xchgb	%ah, %bh
 
-	addr32
-	data32
-	movl	%eax, 2f	/* save %eax */
+	addr32 mov %eax, 2f
 
 	real2prot
 
-	# movl	$Leax, %eax
-	.byte	0xb8
-2:	.long	0x90909090	/* eax */
+	# movl $Leax, %eax
+	.byte 0xb8
+2:	.long 0x90909090
 
 	/* pass BIOS return values back to caller */
-	movl	%eax, 0xb*4(%esp)
-	movl	%ecx, 0xa*4(%esp)
-	movl	%edx, 0x9*4(%esp)
+	mov	%eax, 0xb*4(%esp)
+	mov	%ecx, 0xa*4(%esp)
+	mov	%edx, 0x9*4(%esp)
 	movb	%bh , 0xe*4(%esp)
 
 	/* clear NT flag in eflags */
 	/* Martin Fredriksson <martin@@gbg.netman.se> */
 	pushf
-	popl	%eax
-	andl	$0xffffbfff, %eax
-	pushl	%eax
+	pop	%eax
+	and	$0xffffbfff, %eax
+	push	%eax
 	popf
 
 	/* save registers into save area */
-	movl	%eax, _C_LABEL(BIOS_regs)+BIOSR_AX
-	movl	%ecx, _C_LABEL(BIOS_regs)+BIOSR_CX
-	movl	%edx, _C_LABEL(BIOS_regs)+BIOSR_DX
-	movl	%ebp, _C_LABEL(BIOS_regs)+BIOSR_BP
-	movl	%esi, _C_LABEL(BIOS_regs)+BIOSR_SI
-	movl	%edi, _C_LABEL(BIOS_regs)+BIOSR_DI
-
-	popl	%gs
-	popl	%fs
-	popl	%es
-	popl	%ds
-	popal
+	mov	%eax, _C_LABEL(BIOS_regs)+BIOSR_AX
+	mov	%ecx, _C_LABEL(BIOS_regs)+BIOSR_CX
+	mov	%edx, _C_LABEL(BIOS_regs)+BIOSR_DX
+	mov	%ebp, _C_LABEL(BIOS_regs)+BIOSR_BP
+	mov	%esi, _C_LABEL(BIOS_regs)+BIOSR_SI
+	mov	%edi, _C_LABEL(BIOS_regs)+BIOSR_DI
+
+	pop	%gs
+	pop	%fs
+	pop	%es
+	pop	%ds
+	popa
 	iret
 
 /* Call buffer at 07c0:0000 in real mode to simulate a BIOS boot */
 ENTRY(bootbuf)
-	popl	%eax		/* Don't need return address */
-	popl	%esi		/* Buffer */
-	popl	%edx		/* Device */
+	pop	%eax		/* Don't need return address */
+	pop	%esi		/* Buffer */
+	pop	%edx		/* Device */
 	prot2real		/* Switch */
 
 	/* Set up stack */
 	cli
-	xorl	%ax, %ax
-	movl	%ax, %ss
-	data32
-	movl	$0xfffc, %esp
+	xor	%ax, %ax
+	mov	%ax, %ss
+	mov	$0xfffc, %esp
 	sti
 
 	/* Jump to buffer */
-	addr32
 	ljmp $0x0, $0x7c00
 
+	.end
Index: src/sys/arch/i386/stand/libsa/libsa.h
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/libsa/libsa.h,v
retrieving revision 1.35
diff -u -r1.35 libsa.h
--- src/sys/arch/i386/stand/libsa/libsa.h	20 Jun 2002 20:22:36 -0000	1.35
+++ src/sys/arch/i386/stand/libsa/libsa.h	4 Mar 2003 16:52:48 -0000
@@@@ -35,8 +35,10 @@@@
 #include <machine/biosvar.h>
 
 #define	EXEC_AOUT
+#define	EXEC_ELF
 
 #define	DEFAULT_KERNEL_ADDRESS	0x100000
+#define	ELF_LOAD_MASK 0x0fffffff
 
 void gateA20(int);
 
@@@@ -56,6 +58,12 @@@@
 
 void *getSYSCONFaddr(void);
 void *getEBDAaddr(void);
+
+void apmturnoff (int, int);
+void apm_reset (void);
+
+void devboot (dev_t, char *);
+void machdep (void);
 
 extern const char bdevs[][4];
 extern const int nbdevs;
Index: src/sys/arch/i386/stand/libsa/machdep.c
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/libsa/machdep.c,v
retrieving revision 1.31
diff -u -r1.31 machdep.c
--- src/sys/arch/i386/stand/libsa/machdep.c	18 Aug 2001 15:33:55 -0000	1.31
+++ src/sys/arch/i386/stand/libsa/machdep.c	4 Mar 2003 16:52:48 -0000
@@@@ -37,7 +37,7 @@@@
 #include "debug.h"
 #include "ps2probe.h"
 
-struct BIOS_regs	BIOS_regs;
+volatile struct BIOS_regs	BIOS_regs;
 
 #if defined(DEBUG) && !defined(_TEST)
 #define CKPT(c)	(*(u_int16_t*)0xb8148 = 0x4700 + (c))
Index: src/sys/arch/i386/stand/libsa/smpprobe.c
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/libsa/smpprobe.c,v
retrieving revision 1.3
diff -u -r1.3 smpprobe.c
--- src/sys/arch/i386/stand/libsa/smpprobe.c	27 Sep 1998 17:41:46 -0000	1.3
+++ src/sys/arch/i386/stand/libsa/smpprobe.c	4 Mar 2003 16:52:48 -0000
@@@@ -53,9 +53,7 @@@@
 
 
 static __inline int
-mp_checksum(ptr, len)
-	u_int8_t *ptr;
-	int len;
+mp_checksum(u_int8_t *ptr, int len)
 {
 	register int i, sum = 0;
 
@@@@ -91,7 +89,7 @@@@
 			break;
 		}
 		if((tmp->signature == MP_FLOAT_SIG) &&
-			mp_checksum(tmp, tmp->length*16)){
+			mp_checksum((u_int8_t *)tmp, tmp->length*16)) {
 #ifdef DEBUG
 			if (debug)
 				printf("Found valid MP signature at: %p\n", ptr);
Index: src/sys/arch/i386/stand/mbr/Makefile
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/mbr/Makefile,v
retrieving revision 1.13
diff -u -r1.13 Makefile
--- src/sys/arch/i386/stand/mbr/Makefile	8 Jun 2000 00:55:46 -0000	1.13
+++ src/sys/arch/i386/stand/mbr/Makefile	4 Mar 2003 16:52:48 -0000
@@@@ -21,7 +21,7 @@@@
 	$(LD) $(LDFLAGS) -o $(PROG) $(OBJS) $(LDADD)
 	@@size $(PROG)
 	@@if [ -x ${.OBJDIR}/${PROG} ]; then \
-		dd if=${.OBJDIR}/${PROG} of=${.OBJDIR}/.tmp ibs=32 skip=1 2>/dev/null; \
+		objcopy -O binary ${PROG} ${.OBJDIR}/.tmp;\
 		mv -f ${.OBJDIR}/.tmp ${.OBJDIR}/${PROG}; \
 		ls -l ${.OBJDIR}/${PROG}; \
 	fi
Index: src/sys/arch/i386/stand/mbr/mbr.S
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/mbr/mbr.S,v
retrieving revision 1.16
diff -u -r1.16 mbr.S
--- src/sys/arch/i386/stand/mbr/mbr.S	8 Jan 2002 23:14:29 -0000	1.16
+++ src/sys/arch/i386/stand/mbr/mbr.S	4 Mar 2003 16:52:49 -0000
@@@@ -83,21 +83,21 @@@@
 	ljmp 	$BOOTBIOS, $1f
 1:
 	/* Set up stack */
-	movl	%cs, %ax
+	movl	%cs, %eax
 	cli
-	movl	%ax, %ss
+	mov	%ax, %ss
 	data32
 	movl	$0xfffc, %esp
 	sti
 
 	/* Set up data segment */
-	movl	%ax, %ds
+	mov	%ax, %ds
 	DBGMSG(CHAR_S)
 
 	/* Relocate 512 bytes so we can load PBS here  */
 	data32
 	movl	$BOOTRELOC, %eax
-	movl	%ax, %es
+	movl	%eax, %es
 	data32
 	xorl	%esi, %esi
 	data32
@@@@ -133,7 +133,7 @@@@
 	 *
 	 * --Toby.
 	 */
-	xorl	%ax, %ax
+	xorl	%eax, %eax
 	movb	$0xe3, %ax
 	data32
 	movl	$SERIAL, %dx
@@@@ -185,7 +185,7 @@@@
 	 * can recover anyways.  The message might be nice
 	 * for the (l)user though.
 	 */
-1:	xorl	%bx, %bx
+1:	xor	%bx, %bx
 	# cmpw	$DOSMBR_SIGNATURE, (%bx)
 	.byte	0x81, 0xbf
 	.word	signature
@@@@ -227,25 +227,25 @@@@
 	/* Found bootable partition */
 found:
 	DBGMSG(CHAR_B)
-	pushl	%ax
+	pushl	%eax
 	/* Save drive and partition */
-	movl	%dx, %ax
-	andl	$0x0F, %ax
-	orl	$0x30, %ax
+	movl	%edx, %eax
+	andl	$0x0F, %eax
+	orl	$0x30, %eax
 	#movb	%al, adrive
 	.byte	0xA2
 	.word	adrive
 
-	movl	%cx, %ax
-	decl	%ax
-	xor	$0x03, %ax
-	andl	$0x0F, %ax
-	orl	$0x30, %ax
+	movl	%ecx, %eax
+	decl	%eax
+	xorl	$0x03, %eax
+	andl	$0x0F, %eax
+	orl	$0x30, %eax
 	#movb	%al, aprtn
 	.byte	0xA2
 	.word	aprtn
 
-	popl	%ax
+	popl	%eax
 
 	/* Load values from active partition table entry */
 	# movb	1(%si), %dh	# head
@@@@ -269,7 +269,7 @@@@
 */
 	data32
 	movl	$0x200 | 1, %eax	/* number of blocks */
-	xorl	%bx, %bx		/* put it at %es:0 */
+	xor	%bx, %bx		/* put it at %es:0 */
 	int	$0x13
 	jnc	1f
 	puts(eread)
@@@@ -308,8 +308,8 @@@@
 #ifndef SERIAL
 	pushl	%ebx
 	movb	$0x0e, %ah
-	xorl	%bx, %bx
-	incl	%bx		/* movw $0x01, %bx */
+	xor	%bx, %bx
+	inc	%bx		/* movw $0x01, %bx */
 	int	$0x10
 	popl	%ebx
 #else
Index: src/sys/conf/GENERIC
===================================================================
RCS file: /cvs/src/sys/conf/GENERIC,v
retrieving revision 1.93
diff -u -r1.93 GENERIC
--- src/sys/conf/GENERIC	28 Feb 2003 21:28:46 -0000	1.93
+++ src/sys/conf/GENERIC	4 Mar 2003 16:52:49 -0000
@@@@ -1,3 +1,4 @@@@
+#	$MirBSD: obsd.kernel,v 1.16 2003/03/22 22:33:25 tg Exp $
 #	$OpenBSD: GENERIC,v 1.93 2003/02/28 21:29:08 tedu Exp $
 #
 #	Machine-independent option; used by all architectures for their
@@@@ -24,22 +25,24 @@@@
 option		UVM_SWAP_ENCRYPT# support encryption of pages going to swap
 
 #option		COMPAT_23	# Kernel compatibility with OpenBSD 2.3,
-option		COMPAT_25	# 2.5,
-option		COMPAT_43	# and 4.3BSD
+#option		COMPAT_25	# 2.5,
+#option		COMPAT_43	# and 4.3BSD
 #option		TCP_COMPAT_42	# TCP bug compatibility with 4.2BSD
 
 option		LKM		# loadable kernel modules
 
 option		FFS		# UFS
 option		FFS_SOFTUPDATES	# Soft updates
+#option		UFS_EXTATTR	# support for extended attributes
 option		QUOTA		# UFS quotas
 option		EXT2FS		# Second Extended Filesystem
+option		EXT2FS_SYSTEM_FLAGS
 option		MFS		# memory file system
 #option		XFS		# xfs filesystem
 
 option		TCP_SACK	# Selective Acknowledgements for TCP
 option		TCP_ECN		# Explicit Congestion Notification for TCP
-#option		TCP_FACK	# Forward Acknowledgements for TCP
+option		TCP_FACK	# Forward Acknowledgements for TCP
 #option		TCP_SIGNATURE	# TCP MD5 Signatures, for BGP routing sessions
 
 option		NFSCLIENT	# Network File System client
@@@@ -63,11 +66,11 @@@@
 option		INET6		# IPv6 (needs INET)
 option		PULLDOWN_TEST	# use m_pulldown for IPv6 packet parsing
 option		IPSEC		# IPsec
-#option		KEY		# PF_KEY (implied by IPSEC)
+option		KEY		# PF_KEY (implied by IPSEC)
 #option		NS		# XNS
 #option		NSIP		# XNS tunneling over IP
-#option		IPX		# IPX+SPX
-#option		IPXIP		# IPX tunneling over IP
+option		IPX		# IPX+SPX
+option		IPXIP		# IPX tunneling over IP
 #option		ISO,TPIP	# OSI
 #option		EON		# OSI tunneling over IP
 #option		NETATALK	# AppleTalk
Index: src/sys/conf/newvers.sh
===================================================================
RCS file: /cvs/src/sys/conf/newvers.sh,v
retrieving revision 1.51
diff -u -r1.51 newvers.sh
--- src/sys/conf/newvers.sh	4 Mar 2003 18:34:44 -0000	1.51
+++ src/sys/conf/newvers.sh	7 Mar 2003 16:55:23 -0000
@@@@ -1,5 +1,19 @@@@
 #!/bin/sh -
 #
+#	$MirBSD: obsd.kernel,v 1.16 2003/03/22 22:33:25 tg Exp $
+#
+# Copyright (c) 1982-2003 by Thorsten "mirabile" Glaser <x86@@ePost.de>
+#
+# I hereby permit everyone who obtained a copy of this work to distri-
+# bute, sell, give away, modify, sublicense, merge and use it, freely.
+# I retain the right to be known as an author of the work.
+#
+# The work is provided "as is", with no explicit or implicit warranty.
+# Use at your own risk. Neither author nor any contributor may be held
+# liable for any damage, directly or indirectly, which originated thru
+# creation or modification of this work. Because computing devices are
+# error-prone, flawless behaviour cannot be expected.
+
 #	$OpenBSD: newvers.sh,v 1.51 2003/03/04 18:35:06 deraadt Exp $
 #	$NetBSD: newvers.sh,v 1.17.2.1 1995/10/12 05:17:11 jtc Exp $
 #
@@@@ -14,10 +28,6 @@@@
 # 2. Redistributions in binary form must reproduce the above copyright
 #    notice, this list of conditions and the following disclaimer in the
 #    documentation and/or other materials provided with the distribution.
-# 3. All advertising materials mentioning features or use of this software
-#    must display the following acknowledgement:
-#	This product includes software developed by the University of
-#	California, Berkeley and its contributors.
 # 4. Neither the name of the University nor the names of its contributors
 #    may be used to endorse or promote products derived from this software
 #    without specific prior written permission.
@@@@ -36,14 +46,11 @@@@
 #
 #	@@(#)newvers.sh	8.1 (Berkeley) 4/20/94
 
-if [ ! -r version -o ! -s version ]
-then
-	echo 0 > version
-fi
+[ -r version -o -s version ] || echo 0 > version
 
 touch version
-v=`cat version` u=${USER-root} d=`pwd` h=`hostname` t=`date`
-id=`basename ${d}`
+v=$(cat version) u=${USER-root} d=$(pwd) h=$(hostname) t=$(date)
+id=$(basename ${d})
 
 # additional things which need version number upgrades:
 #	src/sys/sys/param.h:
@@@@ -66,15 +73,20 @@@@
 
 ost="OpenBSD"
 osr="3.3"
+ospl="$(echo '\$Date: 2003/03/22 22:33:25 $' | sed -e 's,^.*: ,,' -e 's,/,,g' -e 's, .*$,,')"
 
-cat >vers.c <<eof
+cat >vers.c <<EOF
+#ifdef INCLUDE_CONFIG_FILE
+#include "config_file.h"
+#endif
 const char ostype[] = "${ost}";
 const char osrelease[] = "${osr}";
+const char ospatchlevel[] = "${ospl}";
 const char osversion[] = "${id}#${v}";
 const char sccs[] =
-    "    @@(#)${ost} ${osr} (${id}) #${v}: ${t}\n";
+    "    @@(#)MirBSD from ${ost} ${osr} (${id}) #${v}: ${t}\n	@@(#)\$MirBSD: obsd.kernel,v 1.16 2003/03/22 22:33:25 tg Exp $\n";
 const char version[] =
-    "${ost} ${osr} (${id}) #${v}: ${t}\n    ${u}@@${h}:${d}\n";
-eof
+    "MirBSD ${osr}-${ospl} (${id}) #${v}: ${t}\n    ${u}@@${h}:${d}\n    patchlevel:\$MirBSD: obsd.kernel,v 1.16 2003/03/22 22:33:25 tg Exp $\n";
+EOF
 
 expr ${v} + 1 > version
Index: src/sys/ddb/db_trap.c
===================================================================
RCS file: /cvs/src/sys/ddb/db_trap.c,v
retrieving revision 1.10
diff -u -r1.10 db_trap.c
--- src/sys/ddb/db_trap.c	6 Nov 2001 19:52:56 -0000	1.10
+++ src/sys/ddb/db_trap.c	4 Mar 2003 16:52:49 -0000
@@@@ -48,12 +48,16 @@@@
 #include <ddb/db_sym.h>
 #include <ddb/db_extern.h>
 
+extern label_t		*db_recover;
 void
 db_trap(type, code)
 	int	type, code;
 {
 	boolean_t	bkpt;
 	boolean_t	watchpt;
+	label_t		db_jmpbuf;
+	label_t         *savejmp;
+
 
 	bkpt = IS_BREAKPOINT_TRAP(type, code);
 	watchpt = IS_WATCHPOINT_TRAP(type, code);
@@@@ -71,7 +75,14 @@@@
 		else
 			db_printf("Stopped at\t");
 		db_dot = PC_REGS(DDB_REGS);
-		db_print_loc_and_inst(db_dot);
+
+
+		savejmp = db_recover;
+		db_recover = &db_jmpbuf;
+		if (setjmp(&db_jmpbuf) == 0)
+			db_print_loc_and_inst(db_dot);
+
+		db_recover = savejmp;
 
 		if (panicstr != NULL) {
 			if (db_print_position() != 0)
Index: src/sys/dev/ccd.c
===================================================================
RCS file: /cvs/src/sys/dev/ccd.c,v
retrieving revision 1.50
diff -u -r1.50 ccd.c
--- src/sys/dev/ccd.c	10 Nov 2002 21:22:47 -0000	1.50
+++ src/sys/dev/ccd.c	4 Mar 2003 16:52:49 -0000
@@@@ -835,7 +835,7 @@@@
 	struct ccdbuf *cbp;
 	daddr_t cbn, cboff, sblk;
 	int ccdisk, off;
-	long old_bcount, cnt;
+	long old_bcount = 0, cnt;
 	struct ccdiinfo *ii;
 	struct buf *nbp;
 
Index: src/sys/dev/systrace.c
===================================================================
RCS file: /cvs/src/sys/dev/systrace.c,v
retrieving revision 1.28
diff -u -r1.28 systrace.c
--- src/sys/dev/systrace.c	20 Feb 2003 22:03:09 -0000	1.28
+++ src/sys/dev/systrace.c	4 Mar 2003 16:52:49 -0000
@@@@ -242,7 +242,7 @@@@
 	int ret = 0;
 	struct fsystrace *fst = (struct fsystrace *)fp->f_data;
 	struct filedesc *fdp;
-	struct str_process *strp;
+	struct str_process *strp = NULL;
 	pid_t pid = 0;
 
 	switch (cmd) {
Index: src/sys/dev/ic/dc.c
===================================================================
RCS file: /cvs/src/sys/dev/ic/dc.c,v
retrieving revision 1.55
diff -u -r1.55 dc.c
--- src/sys/dev/ic/dc.c	25 Feb 2003 17:28:47 -0000	1.55
+++ src/sys/dev/ic/dc.c	4 Mar 2003 16:52:49 -0000
@@@@ -638,6 +638,7 @@@@
 	struct dc_softc		*sc = (struct dc_softc *)self;
 	int			i, rval, phy_reg;
 
+	phy_reg = 0;
 	bzero((char *)&frame, sizeof(frame));
 
 	/*
@@@@ -730,7 +731,6 @@@@
 			printf("dc%d: phy_read: bad phy register %x\n",
 			    sc->dc_unit, reg);
 			return(0);
-			break;
 		}
 
 		rval = CSR_READ_4(sc, phy_reg) & 0x0000FFFF;
@@@@ -761,6 +761,7 @@@@
 	struct dc_mii_frame	frame;
 	int			i, phy_reg;
 
+	phy_reg = 0;
 	bzero((char *)&frame, sizeof(frame));
 
 	if (DC_IS_ADMTEK(sc) && phy != DC_ADMTEK_PHYADDR)
@@@@ -1615,7 +1616,7 @@@@
 	struct dc_softc *sc;
 {
 	struct ifnet		*ifp;
-	int			error = 0, mac_offset, tmp, i;
+	int			error = 0, mac_offset, tmp = 0, i;
 
 	/*
 	 * Get station address from the EEPROM.
Index: src/sys/dev/ic/if_wi.c
===================================================================
RCS file: /cvs/src/sys/dev/ic/if_wi.c,v
retrieving revision 1.93
diff -u -r1.93 if_wi.c
--- src/sys/dev/ic/if_wi.c	13 Feb 2003 20:44:47 -0000	1.93
+++ src/sys/dev/ic/if_wi.c	4 Mar 2003 16:52:49 -0000
@@@@ -977,7 +977,7 @@@@
 {
 	u_int8_t		*ptr;
 	int			len, code;
-	struct wi_ltv_gen	*oltv, p2ltv;
+	struct wi_ltv_gen	*oltv = NULL, p2ltv;
 
 	if (sc->sc_firmware_type != WI_LUCENT) {
 		oltv = ltv;
Index: src/sys/dev/ic/if_wi_hostap.c
===================================================================
RCS file: /cvs/src/sys/dev/ic/if_wi_hostap.c,v
retrieving revision 1.24
diff -u -r1.24 if_wi_hostap.c
--- src/sys/dev/ic/if_wi_hostap.c	15 Feb 2003 17:49:17 -0000	1.24
+++ src/sys/dev/ic/if_wi_hostap.c	4 Mar 2003 16:52:49 -0000
@@@@ -190,7 +190,8 @@@@
 	struct wihap_info *whi = &sc->wi_hostap_info;
 
 	if (sc->sc_arpcom.ac_if.if_flags & IFF_DEBUG)
-		printf("wihap_init: sc=0x%x whi=0x%x\n", sc, whi);
+		printf("wihap_init: sc=0x%lx whi=0x%lx\n", (unsigned long) sc,
+		    (unsigned long) whi);
 
 	bzero(whi, sizeof(struct wihap_info));
 
@@@@ -277,7 +278,8 @@@@
 	int i, s;
 
 	if (sc->sc_arpcom.ac_if.if_flags & IFF_DEBUG)
-		printf("wihap_shutdown: sc=0x%x whi=0x%x\n", sc, whi);
+		printf("wihap_shutdown: sc=0x%lx whi=0x%lx\n",
+		    (unsigned long) sc, (unsigned long) whi);
 
 	if (!(whi->apflags & WIHAPFL_ACTIVE))
 		return;
@@@@ -293,7 +295,8 @@@@
 	    sta != TAILQ_END(&whi->sta_list); sta = next) {
 		timeout_del(&sta->tmo);
 		if (sc->sc_arpcom.ac_if.if_flags & IFF_DEBUG)
-			printf("wihap_shutdown: FREE(sta=0x%x)\n", sta);
+			printf("wihap_shutdown: FREE(sta=0x%lx)\n",
+			    (unsigned long) sta);
 		next = TAILQ_NEXT(sta, list);
 		if (sta->challenge)
 			FREE(sta->challenge, M_TEMP);
Index: src/sys/dev/ic/ne2000.c
===================================================================
RCS file: /cvs/src/sys/dev/ic/ne2000.c,v
retrieving revision 1.12
diff -u -r1.12 ne2000.c
--- src/sys/dev/ic/ne2000.c	14 Mar 2002 01:26:33 -0000	1.12
+++ src/sys/dev/ic/ne2000.c	4 Mar 2003 16:52:49 -0000
@@@@ -169,6 +169,8 @@@@
 	case NE2000_TYPE_DL10022:
 		memsize = 8192 * 2;
 		break;
+	default:
+		memsize = 8192;		/* safe default */
 	}
 
 	/*
Index: src/sys/dev/ic/rtl80x9.c
===================================================================
RCS file: /cvs/src/sys/dev/ic/rtl80x9.c,v
retrieving revision 1.6
diff -u -r1.6 rtl80x9.c
--- src/sys/dev/ic/rtl80x9.c	12 Mar 2001 05:36:36 -0000	1.6
+++ src/sys/dev/ic/rtl80x9.c	4 Mar 2003 16:52:49 -0000
@@@@ -206,6 +206,8 @@@@
 		else
 			defmedia = IFM_ETHER|IFM_10_T;
 		break;
+	default:
+		defmedia = IFM_ETHER|IFM_AUTO;
 	}
 
 	/* Set NIC to page 0 registers. */
Index: src/sys/dev/ic/rtl81x9.c
===================================================================
RCS file: /cvs/src/sys/dev/ic/rtl81x9.c,v
retrieving revision 1.20
diff -u -r1.20 rtl81x9.c
--- src/sys/dev/ic/rtl81x9.c	11 Feb 2003 19:20:05 -0000	1.20
+++ src/sys/dev/ic/rtl81x9.c	4 Mar 2003 16:52:49 -0000
@@@@ -1384,10 +1384,8 @@@@
 		case MII_ANLPAR:
 			rl8139_reg = RL_LPAR;
 			break;
-		case MII_PHYIDR1:
-		case MII_PHYIDR2:
+		default:
 			return (0);
-			break;
 		}
 		return (CSR_READ_2(sc, rl8139_reg));
 	}
Index: src/sys/dev/isa/if_we.c
===================================================================
RCS file: /cvs/src/sys/dev/isa/if_we.c,v
retrieving revision 1.10
diff -u -r1.10 if_we.c
--- src/sys/dev/isa/if_we.c	14 Mar 2002 01:26:34 -0000	1.10
+++ src/sys/dev/isa/if_we.c	4 Mar 2003 16:52:49 -0000
@@@@ -686,9 +686,6 @@@@
 				    *(u_int16_t *)savebyte);
 				buf += 2;
 				leftover = 0;
-#ifdef i386
-#define ALIGNED_POINTER(p,t)	1
-#endif
 #ifdef alpha
 #define ALIGNED_POINTER(p,t)	((((u_long)(p)) & (sizeof(t)-1)) == 0)
 #endif
Index: src/sys/dev/isa/spkr.c
===================================================================
RCS file: /cvs/src/sys/dev/isa/spkr.c,v
retrieving revision 1.7
diff -u -r1.7 spkr.c
--- src/sys/dev/isa/spkr.c	14 Mar 2002 01:26:34 -0000	1.7
+++ src/sys/dev/isa/spkr.c	4 Mar 2003 16:52:49 -0000
@@@@ -1,3 +1,4 @@@@
+/*	$MirBSD: obsd.kernel,v 1.16 2003/03/22 22:33:25 tg Exp $	*/
 /*	$OpenBSD: spkr.c,v 1.7 2002/03/14 01:26:56 millert Exp $	*/
 /*	$NetBSD: spkr.c,v 1.1 1998/04/15 20:26:18 drochner Exp $	*/
 
@@@@ -5,6 +6,7 @@@@
  * Copyright (c) 1990 Eric S. Raymond (esr@@snark.thyrsus.com)
  * Copyright (c) 1990 Andrew A. Chernov (ache@@astral.msk.su)
  * Copyright (c) 1990 Lennart Augustsson (lennart@@augustsson.net)
+ * Copyright (c) 2002 by Thorsten "mirabile" Glaser <x86@@ePost.de>
  * All rights reserved.
  *
  * Redistribution and use in source and binary forms, with or without
@@@@ -21,7 +23,7 @@@@
  * 4. The name of the author may not be used to endorse or promote products
  *    derived from this software without specific prior written permission.
  *
- * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
+ * THIS SOFTWARE IS PROVIDED BY THE AUTHOR "AS IS" AND ANY EXPRESS OR
  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
  * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,
@@@@ -90,18 +92,16 @@@@
 static void playtone(int, int, int);
 static void playstring(char *, int);
 
-static
-void tone(hz, ticks)
 /* emit tone of frequency hz for given number of ticks */
-    u_int hz, ticks;
+static
+void tone(u_int hz, u_int ticks)
 {
 	pcppi_bell(ppicookie, hz, ticks, PCPPI_BELL_SLEEP);
 }
 
-static void
-rest(ticks)
 /* rest for given number of ticks */
-    int	ticks;
+static void
+rest(int ticks)
 {
     /*
      * Set timeout to endrest function, then give up the timeslice.
@@@@ -179,7 +179,7 @@@@
 #define NOCTAVES (sizeof(pitchtab) / sizeof(pitchtab[0]) / OCTAVE_NOTES)
 
 static void
-playinit()
+playinit(void)
 {
     octave = DFLT_OCTAVE;
     whole = (hz * SECS_PER_MIN * WHOLE_NOTE) / DFLT_TEMPO;
@@@@ -189,24 +189,23 @@@@
     octprefix = TRUE;	/* act as though there was an initial O(n) */
 }
 
-static void
-playtone(pitch, value, sustain)
 /* play tone of proper duration for current rhythm signature */
-    int	pitch, value, sustain;
+static void
+playtone(int pitch, int value, int sustain)
 {
-    register int	sound, silence, snum = 1, sdenom = 1;
+    int sound, silence, snum = 1, sdenom = 1;
+
+    if (!value) return;
 
     /* this weirdness avoids floating-point arithmetic */
-    for (; sustain; sustain--)
-    {
+    while (sustain--) {
 	snum *= NUM_MULT;
 	sdenom *= DENOM_MULT;
     }
 
     if (pitch == -1)
 	rest(whole * snum / (value * sdenom));
-    else if (pitch >= 0 && pitch < (sizeof(pitchtab) / sizeof(pitchtab[0])))
-    {
+    else if ((pitch>=0)&&(pitch < (sizeof(pitchtab)/sizeof(pitchtab[0])) )) {
 	sound = (whole * snum) / (value * sdenom)
 		- (whole * (FILLTIME - fill)) / (value * FILLTIME);
 	silence = whole * (FILLTIME-fill) * snum / (FILLTIME * value * sdenom);
@@@@ -222,41 +221,35 @@@@
     }
 }
 
-static void
-playstring(cp, slen)
 /* interpret and play an item from a notation string */
-    char	*cp;
-    int		slen;
+static void
+playstring(char *cp, int slen)
 {
-    int		pitch, lastpitch = OCTAVE_NOTES * DFLT_OCTAVE;
+    int pitch, lastpitch = OCTAVE_NOTES * DFLT_OCTAVE;
 
-#define GETNUM(cp, v)	for(v=0; slen > 0 && isdigit(cp[1]); ) \
-				{v = v * 10 + (*++cp - '0'); slen--;}
-    for (; slen--; cp++)
-    {
-	int		sustain, timeval, tempo;
-	register char	c = toupper(*cp);
+#define GETNUM(cp, v)	for(v=0; slen > 0 && isdigit(cp[1]); slen--) \
+				v = v * 10 + (*++cp - '0');
+    for (; slen--; cp++) {
+	int sustain, timeval, tempo;
+	char c = toupper(*cp);
 
 #ifdef SPKRDEBUG
 	printf("playstring: %c (%x)\n", c, c);
 #endif /* SPKRDEBUG */
 
-	switch (c)
-	{
-	case 'A':  case 'B': case 'C': case 'D': case 'E': case 'F': case 'G':
+	switch (c) {
+	  case 'A':  case 'B':  case 'C':  case 'D':
+	  case 'E':  case 'F':  case 'G':
 
 	    /* compute pitch */
 	    pitch = notetab[c - 'A'] + octave * OCTAVE_NOTES;
 
 	    /* this may be followed by an accidental sign */
-	    if (slen > 0 && (cp[1] == '#' || cp[1] == '+'))
-	    {
+	    if (slen > 0 && (cp[1] == '#' || cp[1] == '+')) {
 		++pitch;
 		++cp;
 		slen--;
-	    }
-	    else if (slen > 0 && cp[1] == '-')
-	    {
+	    } else if (slen > 0 && cp[1] == '-') {
 		--pitch;
 		++cp;
 		slen--;
@@@@ -267,16 +260,13 @@@@
 	     * setting prefix, find the version of the current letter note
 	     * closest to the last regardless of octave.
 	     */
-	    if (octtrack && !octprefix)
-	    {
-		if (abs(pitch-lastpitch) > abs(pitch+OCTAVE_NOTES-lastpitch))
-		{
+	    if (octtrack && !octprefix) {
+		if (abs(pitch-lastpitch) > abs(pitch+OCTAVE_NOTES-lastpitch)) {
 		    ++octave;
 		    pitch += OCTAVE_NOTES;
 		}
 
-		if (abs(pitch-lastpitch) > abs((pitch-OCTAVE_NOTES)-lastpitch))
-		{
+		if (abs(pitch-lastpitch) > abs((pitch-OCTAVE_NOTES)-lastpitch)) {
 		    --octave;
 		    pitch -= OCTAVE_NOTES;
 		}
@@@@ -285,13 +275,12 @@@@
 	    lastpitch = pitch;
 
 	    /* ...which may in turn be followed by an override time value */
-	    GETNUM(cp, timeval);
+	    GETNUM(cp, timeval)
 	    if (timeval <= 0 || timeval > MIN_VALUE)
 		timeval = value;
 
 	    /* ...and/or sustain dots */
-	    for (sustain = 0; slen > 0 && cp[1] == '.'; cp++)
-	    {
+	    for (sustain = 0; slen > 0 && cp[1] == '.'; cp++) {
 		slen--;
 		sustain++;
 	    }
@@@@ -301,21 +290,16 @@@@
 	    break;
 
 	case 'O':
-	    if (slen > 0 && (cp[1] == 'N' || cp[1] == 'n'))
-	    {
+	    if (slen > 0 && (cp[1] == 'N' || cp[1] == 'n')) {
 		octprefix = octtrack = FALSE;
 		++cp;
 		slen--;
-	    }
-	    else if (slen > 0 && (cp[1] == 'L' || cp[1] == 'l'))
-	    {
+	    } else if (slen > 0 && (cp[1] == 'L' || cp[1] == 'l')) {
 		octtrack = TRUE;
 		++cp;
 		slen--;
-	    }
-	    else
-	    {
-		GETNUM(cp, octave);
+	    } else if (slen > 0) {
+		GETNUM(cp, octave)
 		if (octave >= NOCTAVES)
 		    octave = DFLT_OCTAVE;
 		octprefix = TRUE;
@@@@ -335,9 +319,8 @@@@
 	    break;
 
 	case 'N':
-	    GETNUM(cp, pitch);
-	    for (sustain = 0; slen > 0 && cp[1] == '.'; cp++)
-	    {
+	    GETNUM(cp, pitch)
+	    for (sustain = 0; slen > 0 && cp[1] == '.'; cp++) {
 		slen--;
 		sustain++;
 	    }
@@@@ -345,19 +328,17 @@@@
 	    break;
 
 	case 'L':
-	    GETNUM(cp, value);
-	    if (value <= 0 || value > MIN_VALUE)
+	    GETNUM(cp, value)
+	    if (!value || value > MIN_VALUE)
 		value = DFLT_VALUE;
 	    break;
 
-	case 'P':
-	case '~':
+	case 'P':  case '~':
 	    /* this may be followed by an override time value */
-	    GETNUM(cp, timeval);
-	    if (timeval <= 0 || timeval > MIN_VALUE)
+	    GETNUM(cp, timeval)
+	    if (!timeval || timeval > MIN_VALUE)
 		timeval = value;
-	    for (sustain = 0; slen > 0 && cp[1] == '.'; cp++)
-	    {
+	    for (sustain = 0; slen > 0 && cp[1] == '.'; cp++) {
 		slen--;
 		sustain++;
 	    }
@@@@ -365,31 +346,27 @@@@
 	    break;
 
 	case 'T':
-	    GETNUM(cp, tempo);
+	    GETNUM(cp, tempo)
 	    if (tempo < MIN_TEMPO || tempo > MAX_TEMPO)
 		tempo = DFLT_TEMPO;
 	    whole = (hz * SECS_PER_MIN * WHOLE_NOTE) / tempo;
 	    break;
 
 	case 'M':
-	    if (slen > 0 && (cp[1] == 'N' || cp[1] == 'n'))
-	    {
+	    if (slen > 0 && (cp[1] == 'N' || cp[1] == 'n')) {
 		fill = NORMAL;
 		++cp;
 		slen--;
-	    }
-	    else if (slen > 0 && (cp[1] == 'L' || cp[1] == 'l'))
-	    {
+	    } else if (slen > 0 && (cp[1] == 'L' || cp[1] == 'l')) {
 		fill = LEGATO;
 		++cp;
 		slen--;
-	    }
-	    else if (slen > 0 && (cp[1] == 'S' || cp[1] == 's'))
-	    {
+	    } else if (slen > 0 && (cp[1] == 'S' || cp[1] == 's')) {
 		fill = STACCATO;
 		++cp;
 		slen--;
 	    }
+	    /* intentionally no support for MF/MB (Foreground/Background) */
 	    break;
 	}
     }
@@@@ -407,23 +384,17 @@@@
 static int spkr_attached = 0;
 
 int
-spkrprobe (parent, match, aux)
-	struct device *parent;
 #ifdef __BROKEN_INDIRECT_CONFIG
-	void *match;
+spkrprobe (struct device *parent, void *match, void *aux)
 #else
-	struct cfdata *match;
+spkrprobe (struct device *parent, struct cfdata *match, void *aux)
 #endif
-	void *aux;
 {
 	return (!spkr_attached);
 }
 
 void
-spkrattach(parent, self, aux)
-	struct device *parent;
-	struct device *self;
-	void *aux;
+spkrattach(struct device *parent, struct device *self, void *aux)
 {
 	printf("\n");
 	ppicookie = ((struct pcppi_attach_args *)aux)->pa_cookie;
@@@@ -431,36 +402,28 @@@@
 }
 
 int
-spkropen(dev, flags, mode, p)
-    dev_t dev;
-    int	flags;
-    int mode;
-    struct proc *p;
+spkropen(dev_t dev, int flags, int mode, struct proc *p)
 {
 #ifdef SPKRDEBUG
     printf("spkropen: entering with dev = %x\n", dev);
 #endif /* SPKRDEBUG */
 
     if (minor(dev) != 0 || !spkr_attached)
-	return(ENXIO);
+	return (ENXIO);
     else if (spkr_active)
-	return(EBUSY);
-    else
-    {
+	return (EBUSY);
+    else {
 	playinit();
 	spkr_inbuf = malloc(DEV_BSIZE, M_DEVBUF, M_WAITOK);
 	spkr_active = 1;
     }
-    return(0);
+    return (0);
 }
 
 int
-spkrwrite(dev, uio, flags)
-    dev_t dev;
-    struct uio *uio;
-    int flags;
+spkrwrite(dev_t dev, struct uio *uio, int flags)
 {
-    register int n;
+    int n;
     int error;
 #ifdef SPKRDEBUG
     printf("spkrwrite: entering with dev = %x, count = %d\n",
@@@@ -468,81 +431,61 @@@@
 #endif /* SPKRDEBUG */
 
     if (minor(dev) != 0)
-	return(ENXIO);
-    else
-    {
+	return (ENXIO);
+    else {
 	n = min(DEV_BSIZE, uio->uio_resid);
 	error = uiomove(spkr_inbuf, n, uio);
 	if (!error)
 		playstring((char *)spkr_inbuf, n);
-	return(error);
+	return (error);
     }
 }
 
-int spkrclose(dev, flags, mode, p)
-    dev_t	dev;
-    int flags;
-    int mode;
-    struct proc *p;
+int spkrclose(dev_t dev, int flags, int mode, struct proc *p)
 {
 #ifdef SPKRDEBUG
     printf("spkrclose: entering with dev = %x\n", dev);
 #endif /* SPKRDEBUG */
 
     if (minor(dev) != 0)
-	return(ENXIO);
-    else
-    {
+	return (ENXIO);
+    else {
 	tone(0, 0);
 	free(spkr_inbuf, M_DEVBUF);
 	spkr_active = 0;
     }
-    return(0);
+    return (0);
 }
 
-int spkrioctl(dev, cmd, data, flag, p)
-    dev_t dev;
-    u_long cmd;
-    caddr_t data;
-    int	flag;
-    struct proc *p;
+int spkrioctl(dev_t dev, u_long cmd, caddr_t data, int flag, struct proc *p)
 {
 #ifdef SPKRDEBUG
     printf("spkrioctl: entering with dev = %x, cmd = %lx\n", dev, cmd);
 #endif /* SPKRDEBUG */
 
     if (minor(dev) != 0)
-	return(ENXIO);
-    else if (cmd == SPKRTONE)
-    {
+	return (ENXIO);
+    else if (cmd == SPKRTONE) {
 	tone_t	*tp = (tone_t *)data;
-
-	if (tp->frequency == 0)
+	if (!tp->frequency)
 	    rest(tp->duration);
-	else
-	    tone(tp->frequency, tp->duration);
-    }
-    else if (cmd == SPKRTUNE)
-    {
-	tone_t  *tp = (tone_t *)(*(caddr_t *)data);
+	else tone(tp->frequency, tp->duration);
+    } else if (cmd == SPKRTUNE) {
+	tone_t *tp = (tone_t *)(*(caddr_t *)data);
 	tone_t ttp;
 	int error;
 
 	for (; ; tp++) {
 	    error = copyin(tp, &ttp, sizeof(tone_t));
 	    if (error)
-		    return(error);
-	    if (ttp.duration == 0)
+		    return (error);
+	    if (!ttp.duration)
 		    break;
-	    if (ttp.frequency == 0)
+	    if (!ttp.frequency)
 		rest(ttp.duration);
-	    else
-		tone(ttp.frequency, ttp.duration);
+	    else tone(ttp.frequency, ttp.duration);
 	}
-    }
-    else
-	return(EINVAL);
-    return(0);
+    } else
+	return (EINVAL);
+    return (0);
 }
-
-/* spkr.c ends here */
Index: src/sys/dev/microcode/aic7xxx/Makefile
===================================================================
RCS file: /cvs/src/sys/dev/microcode/aic7xxx/Makefile,v
retrieving revision 1.5
diff -u -r1.5 Makefile
--- src/sys/dev/microcode/aic7xxx/Makefile	30 Jun 2002 18:25:36 -0000	1.5
+++ src/sys/dev/microcode/aic7xxx/Makefile	4 Mar 2003 16:52:49 -0000
@@@@ -20,7 +20,7 @@@@
 DEPENDFILE=
 .endif
 
-CFLAGS+= -I/usr/include -I.
+CFLAGS+= -I/usr/include -I. -I${.CURDIR}
 YFLAGS= ${.TARGET:M*macro*:S/$(.TARGET)/-p mm/} -d
 LFLAGS+= ${.TARGET:M*macro*:S/$(.TARGET)/-olex.yy.c/} ${.TARGET:M*macro*:S/$(.TARGET)/-Pmm/}
 NOMAN=	noman
Index: src/sys/dev/mii/bmtphy.c
===================================================================
RCS file: /cvs/src/sys/dev/mii/bmtphy.c,v
retrieving revision 1.5
diff -u -r1.5 bmtphy.c
--- src/sys/dev/mii/bmtphy.c	14 Mar 2002 01:26:35 -0000	1.5
+++ src/sys/dev/mii/bmtphy.c	4 Mar 2003 16:52:49 -0000
@@@@ -93,11 +93,16 @@@@
 	struct mii_data *mii = ma->mii_data;
 	char *model;
 
-	if (MII_MODEL(ma->mii_id2) == MII_MODEL_BROADCOM_BCM5201)
+	switch (MII_MODEL(ma->mii_id2)) {
+    case MII_MODEL_BROADCOM_BCM5201:
 		model = MII_STR_BROADCOM_BCM5201;
-	else if (MII_MODEL(ma->mii_id2) == MII_MODEL_BROADCOM_BCM5221)
+		break;
+    case MII_MODEL_BROADCOM_BCM5221:
 		model = MII_STR_BROADCOM_BCM5221;
-
+		break;
+    default:
+	model = "unknown";
+    }
 	printf(": %s, rev. %d\n", model, MII_REV(ma->mii_id2));
 
 	sc->mii_inst = mii->mii_instance;
Index: src/sys/dev/pci/if_bge.c
===================================================================
RCS file: /cvs/src/sys/dev/pci/if_bge.c,v
retrieving revision 1.19
diff -u -r1.19 if_bge.c
--- src/sys/dev/pci/if_bge.c	11 Feb 2003 19:20:05 -0000	1.19
+++ src/sys/dev/pci/if_bge.c	4 Mar 2003 16:52:49 -0000
@@@@ -562,7 +562,8 @@@@
 		return (ENOBUFS);
 	}
 	sc->bge_cdata.bge_jumbo_buf = (caddr_t)kva;
-	DPRINTFN(1,("bge_jumbo_buf = 0x%08X\n", sc->bge_cdata.bge_jumbo_buf));
+	DPRINTFN(1,("bge_jumbo_buf = 0x%08X\n", (unsigned int)
+	    sc->bge_cdata.bge_jumbo_buf));
 
 	LIST_INIT(&sc->bge_jfree_listhead);
 	LIST_INIT(&sc->bge_jinuse_listhead);
@@@@ -1424,7 +1425,7 @@@@
 	u_int32_t		mac_addr = 0;
 	u_int32_t		command;
 	struct ifnet		*ifp;
-	int			unit, error = 0;
+	int			error = 0;
 	caddr_t			kva;
 
 	s = splimp();
@@@@ -1489,7 +1490,7 @@@@
 	bge_reset(sc);
 
 	if (bge_chipinit(sc)) {
-		printf("%s: chip initializatino failed\n",
+		printf("%s: chip initialization failed\n",
 		    sc->bge_dev.dv_xname);
 		bge_release_resources(sc);
 		error = ENXIO;
@@@@ -1510,7 +1511,7 @@@@
 		sc->arpcom.ac_enaddr[5] = (u_char)mac_addr;
 	} else if (bge_read_eeprom(sc, (caddr_t)&sc->arpcom.ac_enaddr,
 	    BGE_EE_MAC_OFFSET + 2, ETHER_ADDR_LEN)) {
-		printf("bge%d: failed to read station address\n", unit);
+		printf("%s: failed to read station address\n", sc->bge_dev.dv_xname);
 		bge_release_resources(sc);
 		error = ENXIO;
 		goto fail;
Index: src/sys/dev/pci/if_sf.c
===================================================================
RCS file: /cvs/src/sys/dev/pci/if_sf.c,v
retrieving revision 1.19
diff -u -r1.19 if_sf.c
--- src/sys/dev/pci/if_sf.c	15 Jan 2003 06:31:02 -0000	1.19
+++ src/sys/dev/pci/if_sf.c	4 Mar 2003 16:52:49 -0000
@@@@ -717,7 +717,7 @@@@
 	sc->sf_ldata_ptr = malloc(sizeof(struct sf_list_data) + 8,
 				M_DEVBUF, M_NOWAIT);
 	if (sc->sf_ldata_ptr == NULL) {
-		printf("%s: no memory for list buffers!\n", sc->sf_unit);
+		printf("%d: no memory for list buffers!\n", sc->sf_unit);
 		goto fail;
 	}
 
Index: src/sys/dev/pci/if_ste.c
===================================================================
RCS file: /cvs/src/sys/dev/pci/if_ste.c,v
retrieving revision 1.18
diff -u -r1.18 if_ste.c
--- src/sys/dev/pci/if_ste.c	15 Jan 2003 06:31:02 -0000	1.18
+++ src/sys/dev/pci/if_ste.c	4 Mar 2003 16:52:49 -0000
@@@@ -963,7 +963,7 @@@@
 	sc->ste_ldata_ptr = malloc(sizeof(struct ste_list_data) + 8,
 				M_DEVBUF, M_NOWAIT);
 	if (sc->ste_ldata_ptr == NULL) {
-		printf("%s: no memory for list buffers!\n", sc->ste_unit);
+		printf("%d: no memory for list buffers!\n", sc->ste_unit);
 		goto fail;
 	}
 
Index: src/sys/dev/pci/pciide.c
===================================================================
RCS file: /cvs/src/sys/dev/pci/pciide.c,v
retrieving revision 1.117
diff -u -r1.117 pciide.c
--- src/sys/dev/pci/pciide.c	6 Mar 2003 11:48:58 -0000	1.117
+++ src/sys/dev/pci/pciide.c	7 Mar 2003 16:36:44 -0000
@@@@ -3784,7 +3784,7 @@@@
 	struct pci_attach_args *pa;
 {
 	struct pciide_channel *cp;
-	int i, compatchan, revision;
+	int i, compatchan = 0, revision;
 	pcireg_t interface;
 	bus_size_t cmdsize, ctlsize;
 
@@@@ -4084,7 +4084,7 @@@@
 {
 	struct pciide_channel *cp;
 	int channel;
-	pcireg_t interface, st, mode;
+	pcireg_t interface, st = 0, mode;
 	bus_size_t cmdsize, ctlsize;
 
 	if (!PDC_IS_268(sc)) {
Index: src/sys/dev/wscons/wsdisplay.c
===================================================================
RCS file: /cvs/src/sys/dev/wscons/wsdisplay.c,v
retrieving revision 1.50
diff -u -r1.50 wsdisplay.c
--- src/sys/dev/wscons/wsdisplay.c	23 Feb 2003 19:07:49 -0000	1.50
+++ src/sys/dev/wscons/wsdisplay.c	4 Mar 2003 16:52:50 -0000
@@@@ -2281,7 +2281,7 @@@@
 int
 ctrl_event(u_int type, int value, struct wsdisplay_softc *ws_sc, struct proc *p)
 {
-	int i, error;
+	int i, error = 0;
 
 	if (type == WSCONS_EVENT_WSMOUSED_ON) {
 		if (!ws_sc->sc_accessops->getchar)
Index: src/sys/kern/kern_exec.c
===================================================================
RCS file: /cvs/src/sys/kern/kern_exec.c,v
retrieving revision 1.75
diff -u -r1.75 kern_exec.c
--- src/sys/kern/kern_exec.c	11 Dec 2002 00:07:46 -0000	1.75
+++ src/sys/kern/kern_exec.c	4 Mar 2003 16:52:50 -0000
@@@@ -1,3 +1,4 @@@@
+/*	$MirBSD: obsd.kernel,v 1.16 2003/03/22 22:33:25 tg Exp $	*/
 /*	$OpenBSD: kern_exec.c,v 1.75 2002/12/11 00:08:08 miod Exp $	*/
 /*	$NetBSD: kern_exec.c,v 1.75 1996/02/09 18:59:28 christos Exp $	*/
 
@@@@ -138,6 +139,9 @@@@
 		error = EACCES;
 		goto bad1;
 	}
+
+	/* fork count, for bomb defusion code */
+	nFork = 0;
 
 	if ((vp->v_mount->mnt_flag & MNT_NOSUID))
 		epp->ep_vap->va_mode &= ~(VSUID | VSGID);
Index: src/sys/kern/kern_fork.c
===================================================================
RCS file: /cvs/src/sys/kern/kern_fork.c,v
retrieving revision 1.59
diff -u -r1.59 kern_fork.c
--- src/sys/kern/kern_fork.c	31 Oct 2002 01:33:05 -0000	1.59
+++ src/sys/kern/kern_fork.c	4 Mar 2003 16:52:50 -0000
@@@@ -1,3 +1,4 @@@@
+/*	$MirBSD: obsd.kernel,v 1.16 2003/03/22 22:33:25 tg Exp $	*/
 /*	$OpenBSD: kern_fork.c,v 1.59 2002/10/31 01:33:27 art Exp $	*/
 /*	$NetBSD: kern_fork.c,v 1.29 1996/02/09 18:59:34 christos Exp $	*/
 
@@@@ -18,10 +19,6 @@@@
  * 2. Redistributions in binary form must reproduce the above copyright
  *    notice, this list of conditions and the following disclaimer in the
  *    documentation and/or other materials provided with the distribution.
- * 3. All advertising materials mentioning features or use of this software
- *    must display the following acknowledgement:
- *	This product includes software developed by the University of
- *	California, Berkeley and its contributors.
  * 4. Neither the name of the University nor the names of its contributors
  *    may be used to endorse or promote products derived from this software
  *    without specific prior written permission.
@@@@ -140,13 +137,35 @@@@
 	extern void endtsleep(void *);
 	extern void realitexpire(void *);
 
+	uid = p1->p_cred->p_ruid;
+
+	/*
+	 * If we are in a secure environment and a process appears to have
+	 * forked up to 50% of the remaining free process space, we'll
+	 * consider it forkbomb and terminate quietly. If we're not root
+	 * set NOACCESS or not set as NOCKILL, we'll consider it a forkbomb
+	 * at 12.5%.
+	 */
+	if ((securelevel>0) && (!uid) && (nFork>=((maxproc-nprocs)/2))) {
+		if (p1->p_pid != 1) {
+			nFork = 0;
+			gsignal(p1->p_pgrp->pg_id, SIGKILL);
+			return (EAGAIN);
+		}
+	} else if ((securelevel>0) && uid && (nFork>=((maxproc-nprocs)/8))) {
+		if (p1->p_pid != 1) {
+			nFork = 0;
+			gsignal(p1->p_pgrp->pg_id, SIGKILL);
+			return (EPERM);
+		}
+	}
+
 	/*
 	 * Although process entries are dynamically created, we still keep
 	 * a global limit on the maximum number we will create. We reserve
 	 * the last 5 processes to root. The variable nprocs is the current
 	 * number of processes, maxproc is the limit.
 	 */
-	uid = p1->p_cred->p_ruid;
 	if ((nprocs >= maxproc - 5 && uid != 0) || nprocs >= maxproc) {
 		tablefull("proc");
 		return (EAGAIN);
@@@@ -212,6 +231,7 @@@@
 		startprofclock(p2);
 	p2->p_flag |= (p1->p_flag & (P_SUGID | P_SUGIDEXEC));
 	p2->p_cred = pool_get(&pcred_pool, PR_WAITOK);
+	++nFork;
 	bcopy(p1->p_cred, p2->p_cred, sizeof(*p2->p_cred));
 	p2->p_cred->p_refcnt = 1;
 	crhold(p1->p_ucred);
Index: src/sys/kern/kern_sig.c
===================================================================
RCS file: /cvs/src/sys/kern/kern_sig.c,v
retrieving revision 1.61
diff -u -r1.61 kern_sig.c
--- src/sys/kern/kern_sig.c	1 Oct 2002 17:33:17 -0000	1.61
+++ src/sys/kern/kern_sig.c	4 Mar 2003 16:52:50 -0000
@@@@ -83,7 +83,6 @@@@
 	{ 0, filt_sigattach, filt_sigdetach, filt_signal };
 
 void proc_stop(struct proc *p);
-void killproc(struct proc *, char *);
 int cansignal(struct proc *, struct pcred *, struct proc *, int);
 
 struct pool sigacts_pool;	/* memory pool for sigacts structures */
@@@@ -1228,20 +1227,6 @@@@
 }
 
 /*
- * Kill the current process for stated reason.
- */
-void
-killproc(p, why)
-	struct proc *p;
-	char *why;
-{
-
-	log(LOG_ERR, "pid %d was killed: %s\n", p->p_pid, why);
-	uprintf("sorry, pid %d was killed: %s\n", p->p_pid, why);
-	psignal(p, SIGKILL);
-}
-
-/*
  * Force the current process to exit with the specified signal, dumping core
  * if appropriate.  We bypass the normal tests for masked and caught signals,
  * allowing unrecoverable failures to terminate the process without changing
@@@@ -1254,6 +1239,36 @@@@
 	register struct proc *p;
 	int signum;
 {
+    switch (signum) {
+    case 0:
+    case SIGKILL:
+    case SIGINT:
+    case SIGTERM:
+    case SIGALRM:
+    case SIGSTOP:
+    case SIGTTIN:
+    case SIGTTOU:
+    case SIGTSTP:
+    case SIGHUP:
+    case SIGUSR1:
+    case SIGUSR2:
+	break;
+    default:
+	if (p->p_pptr != NULL)
+		log(LOG_INFO, "signal %d received by (%.32s:%d) UID(%lu) "
+		    "EUID(%lu), parent (%.32s:%d) UID(%lu) EUID(%lu)\n",
+		    signum, p->p_comm, p->p_pid,
+		    (unsigned long) p->p_cred->p_ruid,
+		    (unsigned long) p->p_ucred->cr_uid,
+		    p->p_pptr->p_comm, p->p_pptr->p_pid,
+		    (unsigned long) p->p_pptr->p_cred->p_ruid,
+		    (unsigned long) p->p_pptr->p_ucred->cr_uid);
+	  else
+		log(LOG_INFO, "signal %d received by (%.32s:%d) UID(%lu) "
+		    "EUID(%lu), zombie\n", signum, p->p_comm, p->p_pid,
+		    (unsigned long) p->p_cred->p_ruid,
+		    (unsigned long) p->p_ucred->cr_uid);
+    }
 
 	/* Mark process as going away */
 	p->p_flag |= P_WEXIT;
@@@@ -1309,7 +1324,7 @@@@
 	cred->cr_uid = p->p_cred->p_ruid;
 	cred->cr_gid = p->p_cred->p_rgid;
 
-	sprintf(name, "%s.core", p->p_comm);
+	snprintf(name, sizeof(name), "%s.core", p->p_comm);
 	NDINIT(&nd, LOOKUP, NOFOLLOW, UIO_SYSSPACE, name, p);
 
 	error = vn_open(&nd, O_CREAT | FWRITE | O_NOFOLLOW, S_IRUSR | S_IWUSR);
@@@@ -1394,6 +1409,13 @@@@
 	crfree(cred);
 	if (error == 0)
 		error = error1;
+    if (!error)
+	log(LOG_WARNING, "core dumped for pid %d (%s)\n",
+	    p->p_pid, p->p_comm);
+    else
+	log(LOG_WARNING, "error %d while dumping core for pid %d (%s)\n",
+	    error, p->p_pid, p->p_comm);
+
 	return (error);
 }
 
Index: src/sys/kern/kern_synch.c
===================================================================
RCS file: /cvs/src/sys/kern/kern_synch.c,v
retrieving revision 1.46
diff -u -r1.46 kern_synch.c
--- src/sys/kern/kern_synch.c	15 Oct 2002 20:17:00 -0000	1.46
+++ src/sys/kern/kern_synch.c	4 Mar 2003 16:52:50 -0000
@@@@ -737,6 +737,20 @@@@
 			if (rlim->rlim_cur < rlim->rlim_max)
 				rlim->rlim_cur += 5;
 		}
+	  } else {
+		rlim = &p->p_rlimit[RLIMIT_TIME];
+		if (rlim->rlim_cur != RLIM_INFINITY) {
+			s = time.tv_sec - p->p_stats->p_start.tv_sec;
+			if (s >= rlim->rlim_cur) {
+				if (s >= rlim->rlim_max)
+					psignal(p, SIGKILL);
+				 else {
+					psignal(p, SIGXCPU);
+					if (rlim->rlim_cur < rlim->rlim_max)
+						rlim->rlim_cur += 5;
+				}
+			}
+		}
 	}
 	if (s > 10 * 60 && p->p_ucred->cr_uid && p->p_nice == NZERO) {
 		p->p_nice = NZERO + 4;
Index: src/sys/kern/kern_sysctl.c
===================================================================
RCS file: /cvs/src/sys/kern/kern_sysctl.c,v
retrieving revision 1.79
diff -u -r1.79 kern_sysctl.c
--- src/sys/kern/kern_sysctl.c	21 Jan 2003 16:59:01 -0000	1.79
+++ src/sys/kern/kern_sysctl.c	4 Mar 2003 16:52:50 -0000
@@@@ -231,6 +231,7 @@@@
 #else
 int securelevel;
 #endif
+int allowpsa = 1, allowpse = 1;
 
 /*
  * kernel related system variables.
@@@@ -281,6 +282,8 @@@@
 		return (sysctl_rdstring(oldp, oldlenp, newp, ostype));
 	case KERN_OSRELEASE:
 		return (sysctl_rdstring(oldp, oldlenp, newp, osrelease));
+	case KERN_OSPATCHLEVEL:
+		return (sysctl_rdstring(oldp, oldlenp, newp, ospatchlevel));
 	case KERN_OSREV:
 		return (sysctl_rdint(oldp, oldlenp, newp, OpenBSD));
 	case KERN_OSVERSION:
@@@@ -484,6 +487,12 @@@@
 	case KERN_WATCHDOG:
 		return (sysctl_wdog(name + 1, namelen - 1, oldp, oldlenp,
 		    newp, newlen));
+	case KERN_ALLOWPSA:
+		return (sysctl_int(oldp, oldlenp, newp, newlen,
+		    &allowpsa));
+	case KERN_ALLOWPSE:
+		return (sysctl_int(oldp, oldlenp, newp, newlen,
+		    &allowpse));
 	default:
 		return (EOPNOTSUPP);
 	}
@@@@ -895,9 +904,9 @@@@
 	char *where;
 	size_t *sizep;
 {
-	register struct proc *p;
-	register struct kinfo_proc *dp = (struct kinfo_proc *)where;
-	register int needed = 0;
+	struct proc *p, *cur = curproc;
+	struct kinfo_proc *dp = (struct kinfo_proc *)where;
+	int needed = 0;
 	int buflen = where != NULL ? *sizep : 0;
 	int doingzomb;
 	struct eproc eproc;
@@@@ -916,6 +925,14 @@@@
 		if (p->p_stat == SIDL)
 			continue;
 		/*
+		 * Skip processes with different real uid
+		 */
+		if ((!allowpsa) &&
+		    (cur->p_cred->p_ruid != p->p_cred->p_ruid) &&
+		    (cur->p_cred->p_rgid))
+			continue;
+
+		/*
 		 * TODO - make more efficient (see notes below).
 		 * do by session.
 		 */
@@@@ -1048,7 +1065,7 @@@@
 sysctl_proc_args(int *name, u_int namelen, void *oldp, size_t *oldlenp,
     struct proc *cp)
 {
-	struct proc *vp;
+	struct proc *vp, *cur = curproc;
 	pid_t pid;
 	int op;
 	struct ps_strings pss;
@@@@ -1082,6 +1099,11 @@@@
 	if ((vp = pfind(pid)) == NULL)
 		return (ESRCH);
 
+	if ((!allowpse) &&
+	    (cur->p_cred->p_ruid != vp->p_cred->p_ruid) &&
+	    (cur->p_cred->p_rgid))
+		return (EPERM);
+
 	if (P_ZOMBIE(vp) || (vp->p_flag & P_SYSTEM))
 		return (EINVAL);
 
@@@@ -1322,13 +1344,13 @@@@
 	size_t *sizep;
 {
 #ifdef SYSVMSG
-	struct msg_sysctl_info *msgsi;
+	struct msg_sysctl_info *msgsi = NULL;
 #endif
 #ifdef SYSVSEM
-	struct sem_sysctl_info *semsi;
+	struct sem_sysctl_info *semsi = NULL;
 #endif
 #ifdef SYSVSHM
-	struct shm_sysctl_info *shmsi;
+	struct shm_sysctl_info *shmsi = NULL;
 #endif
 	size_t infosize, dssize, tsize, buflen;
 	int i, nds, error, ret;
@@@@ -1383,7 +1405,9 @@@@
 		*sizep = 0;
 		return (ENOMEM);
 	}
-	buf = malloc(min(tsize, buflen), M_TEMP, M_WAITOK);
+	if ((buf = malloc(min(tsize, buflen), M_TEMP, M_WAITOK)) == NULL) {
+	return (ENOMEM);
+    }
 	bzero(buf, min(tsize, buflen));
 
 	switch (*name) { 
Index: src/sys/kern/subr_userconf.c
===================================================================
RCS file: /cvs/src/sys/kern/subr_userconf.c,v
retrieving revision 1.31
diff -u -r1.31 subr_userconf.c
--- src/sys/kern/subr_userconf.c	29 Jul 2002 23:18:35 -0000	1.31
+++ src/sys/kern/subr_userconf.c	4 Mar 2003 16:52:53 -0000
@@@@ -482,7 +482,7 @@@@
 		}
 
 		if (c == 'y' || c == 'Y') {
-			int share = 0, i, *lk;
+			int share = 0, i, *lk = NULL;
 
 			/* XXX add cmd 'c' <devno> */
 			userconf_hist_cmd('c');
@@@@ -1059,7 +1059,7 @@@@
 {
 	int i = 0, found = 0;
 	struct cfdata new;
-	int  val, max_unit, star_unit, orig;
+	int  val, max_unit, star_unit, orig = 0;
 
 	bzero(&new, sizeof(struct cfdata));
 
Index: src/sys/kern/sys_generic.c
===================================================================
RCS file: /cvs/src/sys/kern/sys_generic.c,v
retrieving revision 1.41
diff -u -r1.41 sys_generic.c
--- src/sys/kern/sys_generic.c	12 Aug 2002 14:32:22 -0000	1.41
+++ src/sys/kern/sys_generic.c	4 Mar 2003 16:52:53 -0000
@@@@ -657,7 +657,7 @@@@
 	} */ *uap = v;
 	fd_set bits[6], *pibits[3], *pobits[3];
 	struct timeval atv;
-	int s, ncoll, error = 0, timo;
+	int s, ncoll, error = 0, timo = 0;
 	u_int nd, ni;
 
 	nd = SCARG(uap, nd);
@@@@ -926,7 +926,7 @@@@
 	struct pollfd pfds[4], *pl = pfds;
 	int msec = SCARG(uap, timeout);
 	struct timeval atv;
-	int timo, ncoll, i, s, error, error2;
+	int timo = 0, ncoll, i, s, error, error2;
 	extern int nselcoll, selwait;
 	u_int nfds = SCARG(uap, nfds);
 
Index: src/sys/kern/vfs_syscalls.c
===================================================================
RCS file: /cvs/src/sys/kern/vfs_syscalls.c,v
retrieving revision 1.98
diff -u -r1.98 vfs_syscalls.c
--- src/sys/kern/vfs_syscalls.c	2 Oct 2002 21:56:08 -0000	1.98
+++ src/sys/kern/vfs_syscalls.c	4 Mar 2003 16:52:53 -0000
@@@@ -109,7 +109,7 @@@@
 	char fspath[MNAMELEN];
 	struct vattr va;
 	struct nameidata nd;
-	struct vfsconf *vfsp;
+	struct vfsconf *vfsp = NULL;
 	struct timeval tv;
 
 	if (usermount == 0 && (error = suser(p->p_ucred, &p->p_acflag)))
Index: src/sys/lib/libkern/arch/i386/Makefile.inc
===================================================================
RCS file: /cvs/src/sys/lib/libkern/arch/i386/Makefile.inc,v
retrieving revision 1.7
diff -u -r1.7 Makefile.inc
--- src/sys/lib/libkern/arch/i386/Makefile.inc	18 Dec 2000 18:40:24 -0000	1.7
+++ src/sys/lib/libkern/arch/i386/Makefile.inc	4 Mar 2003 16:52:53 -0000
@@@@ -1,3 +1,4 @@@@
+#	$MirBSD: obsd.kernel,v 1.16 2003/03/22 22:33:25 tg Exp $
 #	$OpenBSD: Makefile.inc,v 1.7 2000/12/18 18:40:46 provos Exp $
 #	$NetBSD: Makefile.inc,v 1.10 1996/04/13 01:17:41 cgd Exp $
 
@@@@ -5,5 +6,5 @@@@
 	memchr.S memcmp.S \
 	bcmp.S ffs.S memset.S strcat.S strcmp.S strcpy.S strlcat.c strlcpy.c \
 	strlen.S strncmp.c \
-	strncpy.c scanc.S skpc.S locc.S htonl.S htons.S ntohl.S ntohs.S \
+	strncpy.c scanc.S skpc.S locc.S htonl.S htons.S \
 	strncasecmp.c
Index: src/sys/lib/libkern/arch/i386/htonl.S
===================================================================
RCS file: /cvs/src/sys/lib/libkern/arch/i386/htonl.S,v
retrieving revision 1.2
diff -u -r1.2 htonl.S
--- src/sys/lib/libkern/arch/i386/htonl.S	27 Sep 1996 06:47:25 -0000	1.2
+++ src/sys/lib/libkern/arch/i386/htonl.S	4 Mar 2003 16:52:53 -0000
@@@@ -1,49 +1,23 @@@@
-/*	$OpenBSD: htonl.S,v 1.2 1996/09/27 06:47:45 mickey Exp $	*/
-
 /*-
- * Copyright (c) 1990 The Regents of the University of California.
- * All rights reserved.
- *
- * This code is derived from software contributed to Berkeley by
- * William Jolitz.
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions
- * are met:
- * 1. Redistributions of source code must retain the above copyright
- *    notice, this list of conditions and the following disclaimer.
- * 2. Redistributions in binary form must reproduce the above copyright
- *    notice, this list of conditions and the following disclaimer in the
- *    documentation and/or other materials provided with the distribution.
- * 3. All advertising materials mentioning features or use of this software
- *    must display the following acknowledgement:
- *	This product includes software developed by the University of
- *	California, Berkeley and its contributors.
- * 4. Neither the name of the University nor the names of its contributors
- *    may be used to endorse or promote products derived from this software
- *    without specific prior written permission.
+ * Copyright (c) 1982-2003 by Thorsten "mirabile" Glaser <x86@@ePost.de>
  *
- * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
- * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
- * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
- * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
- * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
- * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
- * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
- * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
- * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
- * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
- * SUCH DAMAGE.
+ * I hereby permit everyone who obtained a copy of this work to distri-
+ * bute, sell, give away, modify, sublicense, merge and use it, freely.
+ * I retain the right to be known as an author of the work.
  *
- *	from: @@(#)htonl.s	5.3 (Berkeley) 12/17/90
+ * The work is provided "as is", with no explicit or implicit warranty.
+ * Use at your own risk. Neither author nor any contributor may be held
+ * liable for any damage, directly or indirectly, which originated thru
+ * creation or modification of this work. Because computing devices are
+ * error-prone, flawless behaviour cannot be expected.
  */
 
 #include <machine/asm.h>
 
-/* netorder = htonl(hostorder) */
+ENTRY(ntohl)
 ENTRY(htonl)
 	movl	4(%esp),%eax
-	rorw	$8,%ax
+	xchgb	%ah,%al
 	roll	$16,%eax
-	rorw	$8,%ax
+	xchgb	%ah,%al
 	ret
Index: src/sys/lib/libkern/arch/i386/htons.S
===================================================================
RCS file: /cvs/src/sys/lib/libkern/arch/i386/htons.S,v
retrieving revision 1.2
diff -u -r1.2 htons.S
--- src/sys/lib/libkern/arch/i386/htons.S	27 Sep 1996 06:47:26 -0000	1.2
+++ src/sys/lib/libkern/arch/i386/htons.S	4 Mar 2003 16:52:53 -0000
@@@@ -1,47 +1,21 @@@@
-/*	$OpenBSD: htons.S,v 1.2 1996/09/27 06:47:46 mickey Exp $	*/
-
 /*-
- * Copyright (c) 1990 The Regents of the University of California.
- * All rights reserved.
- *
- * This code is derived from software contributed to Berkeley by
- * William Jolitz.
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions
- * are met:
- * 1. Redistributions of source code must retain the above copyright
- *    notice, this list of conditions and the following disclaimer.
- * 2. Redistributions in binary form must reproduce the above copyright
- *    notice, this list of conditions and the following disclaimer in the
- *    documentation and/or other materials provided with the distribution.
- * 3. All advertising materials mentioning features or use of this software
- *    must display the following acknowledgement:
- *	This product includes software developed by the University of
- *	California, Berkeley and its contributors.
- * 4. Neither the name of the University nor the names of its contributors
- *    may be used to endorse or promote products derived from this software
- *    without specific prior written permission.
+ * Copyright (c) 1982-2003 by Thorsten "mirabile" Glaser <x86@@ePost.de>
  *
- * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
- * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
- * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
- * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
- * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
- * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
- * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
- * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
- * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
- * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
- * SUCH DAMAGE.
+ * I hereby permit everyone who obtained a copy of this work to distri-
+ * bute, sell, give away, modify, sublicense, merge and use it, freely.
+ * I retain the right to be known as an author of the work.
  *
- *	from: @@(#)htons.s	5.2 (Berkeley) 12/17/90
+ * The work is provided "as is", with no explicit or implicit warranty.
+ * Use at your own risk. Neither author nor any contributor may be held
+ * liable for any damage, directly or indirectly, which originated thru
+ * creation or modification of this work. Because computing devices are
+ * error-prone, flawless behaviour cannot be expected.
  */
 
 #include <machine/asm.h>
 
-/* netorder = htons(hostorder) */
+ENTRY(ntohs)
 ENTRY(htons)
 	movzwl	4(%esp),%eax
-	rorw	$8,%ax
+	xchgb	%ah,%al
 	ret
Index: src/sys/lib/libsa/exec_elf.c
===================================================================
RCS file: /cvs/src/sys/lib/libsa/exec_elf.c,v
retrieving revision 1.6
diff -u -r1.6 exec_elf.c
--- src/sys/lib/libsa/exec_elf.c	9 Jul 2002 01:45:25 -0000	1.6
+++ src/sys/lib/libsa/exec_elf.c	4 Mar 2003 16:52:53 -0000
@@@@ -35,6 +35,11 @@@@
 #include <sys/exec_elf.h>
 #include <ddb/db_aout.h>
 
+#ifndef ELF_LOAD_MASK
+#define ELF_LOAD_MASK ~0
+#endif
+
+#define EXEC_DEBUG
 int
 elf_probe(fd, hdr)
 	int fd;
@@@@ -42,6 +47,7 @@@@
 {
 	return IS_ELF(hdr->x_elf);
 }
+int debug;
 
 int
 elf_load(fd, xp)
@@@@ -55,6 +61,7 @@@@
 	register u_int pa;
 
 #ifdef EXEC_DEBUG
+	debug=1;
 	if (debug)
 		printf("id=%x.%c%c%c.%x.%x, type=%x, mach=%x, ver=%x, size=%d\n"
 		       "\tep=%x, flgs=%x, ph=%x[%dx%d], sh=%x[%dx%d], str=%x\n",
@@@@ -90,18 +97,22 @@@@
 	for (ph = phdr; ph < &phdr[ehdr->e_phnum]; ph++) {
 #ifdef EXEC_DEBUG
 		if (debug)
-			printf("ph%d: type=%x, off=%d, va=%x, fs=%d, ms=%d, "
+			printf("ph%d: type=%x, off=%d, va=%x, rpa %x, fs=%d, ms=%d, "
 			       "flags=%x\n", (ph - phdr), ph->p_type,
-			       ph->p_offset, ph->p_vaddr, ph->p_filesz,
+			       ph->p_offset, ph->p_vaddr,
+			       (ph->p_vaddr & ELF_LOAD_MASK),
+			       ph->p_filesz,
 			       ph->p_memsz, ph->p_flags);
 #endif
 		if (ph->p_filesz && ph->p_flags & PF_X) {
+			/*
 			pa = ph->p_vaddr;
-			xp->text.addr = ph->p_vaddr;
+			*/
+			xp->text.addr = ph->p_vaddr & ELF_LOAD_MASK; 
 			xp->text.size = ph->p_filesz;
 			xp->text.foff = ph->p_offset;
 		} else if (ph->p_filesz && ph->p_flags & PF_W) {
-			xp->data.addr = ph->p_vaddr;
+			xp->data.addr = ph->p_vaddr & ELF_LOAD_MASK;
 			xp->data.size = ph->p_filesz;
 			xp->data.foff = ph->p_offset;
 			if (ph->p_filesz < ph->p_memsz) {
@@@@ -110,7 +121,7 @@@@
 				xp->bss.foff = 0;
 			}
 		} else if (!ph->p_filesz) {
-			xp->bss.addr = ph->p_vaddr;
+			xp->bss.addr = ph->p_vaddr & ELF_LOAD_MASK;
 			xp->bss.size = ph->p_memsz;
 			xp->bss.foff = 0;
 		}
Index: src/sys/lib/libsa/loadfile.c
===================================================================
RCS file: /cvs/src/sys/lib/libsa/loadfile.c,v
retrieving revision 1.3
diff -u -r1.3 loadfile.c
--- src/sys/lib/libsa/loadfile.c	11 Nov 2002 00:04:08 -0000	1.3
+++ src/sys/lib/libsa/loadfile.c	4 Mar 2003 16:52:53 -0000
@@@@ -103,7 +103,9 @@@@
 static int elf_exec(int, Elf_Ehdr *, u_long *, int);
 #endif
 #ifdef BOOT_AOUT
+/*
 #include <sys/exec_aout.h>
+*/
 static int aout_exec(int, struct exec *, u_long *, int);
 #endif
 
@@@@ -486,7 +488,7 @@@@
 	 * Read in the text segment.
 	 */
 	if (flags & LOAD_TEXT) {
-		PROGRESS(("%ld", x->a_text));
+		PROGRESS(("%d", x->a_text));
 
 		if (READ(fd, maxp, x->a_text - sub) != x->a_text - sub) {
 			WARN(("read text"));
@@@@ -520,7 +522,7 @@@@
 	 * Read in the data segment.
 	 */
 	if (flags & LOAD_DATA) {
-		PROGRESS(("+%ld", x->a_data));
+		PROGRESS(("+%d", x->a_data));
 
 		if (READ(fd, maxp, x->a_data) != x->a_data) {
 			WARN(("read data"));
@@@@ -541,7 +543,7 @@@@
 	 * (Kernel doesn't care, but do it anyway.)
 	 */
 	if (flags & LOAD_BSS) {
-		PROGRESS(("+%ld", x->a_bss));
+		PROGRESS(("+%d", x->a_bss));
 
 		BZERO(maxp, x->a_bss);
 	}
@@@@ -565,7 +567,7 @@@@
 		/* Symbol table and string table length word. */
 
 		if (flags & LOAD_SYM) {
-			PROGRESS(("+[%ld", x->a_syms));
+			PROGRESS(("+[%d", x->a_syms));
 
 			if (READ(fd, maxp, x->a_syms) != x->a_syms) {
 				WARN(("read symbols"));
Index: src/sys/lib/libz/Makefile
===================================================================
RCS file: /cvs/src/sys/lib/libz/Makefile,v
retrieving revision 1.3
diff -u -r1.3 Makefile
--- src/sys/lib/libz/Makefile	8 Sep 1998 04:07:25 -0000	1.3
+++ src/sys/lib/libz/Makefile	4 Mar 2003 16:52:53 -0000
@@@@ -5,7 +5,7 @@@@
 NOPIC=
 NOPROFILE=
 
-CPPFLAGS+=	-I. ${ZCPPFLAGS} -D_ZLIB_PRIVATE
+CPPFLAGS+=	-I. -I${.CURDIR} ${ZCPPFLAGS} -D_ZLIB_PRIVATE
 
 # files to be copied down from libz.
 LIBZSRCS= adler32.c crc32.c infblock.c infcodes.c inffast.c \
Index: src/sys/miscfs/procfs/procfs_vnops.c
===================================================================
RCS file: /cvs/src/sys/miscfs/procfs/procfs_vnops.c,v
retrieving revision 1.27
diff -u -r1.27 procfs_vnops.c
--- src/sys/miscfs/procfs/procfs_vnops.c	31 Jan 2003 17:37:28 -0000	1.27
+++ src/sys/miscfs/procfs/procfs_vnops.c	4 Mar 2003 16:52:53 -0000
@@@@ -746,7 +746,7 @@@@
 	struct vnode *dvp = ap->a_dvp;
 	char *pname = cnp->cn_nameptr;
 	struct proc *curp = curproc;
-	struct proc_target *pt;
+	struct proc_target *pt = NULL;
 	struct vnode *fvp;
 	pid_t pid;
 	struct pfsnode *pfs;
Index: src/sys/miscfs/union/union_vnops.c
===================================================================
RCS file: /cvs/src/sys/miscfs/union/union_vnops.c,v
retrieving revision 1.19
diff -u -r1.19 union_vnops.c
--- src/sys/miscfs/union/union_vnops.c	8 Jun 2002 18:43:12 -0000	1.19
+++ src/sys/miscfs/union/union_vnops.c	4 Mar 2003 16:52:53 -0000
@@@@ -1097,7 +1097,7 @@@@
 	int error = 0;
 	struct union_node *dun;
 	struct vnode *dvp;
-	struct vnode *vp;
+	struct vnode *vp = NULL;
 	struct proc *p = ap->a_cnp->cn_proc;
 
 	dun = VTOUNION(ap->a_dvp);
Index: src/sys/net/if_bridge.c
===================================================================
RCS file: /cvs/src/sys/net/if_bridge.c,v
retrieving revision 1.112
diff -u -r1.112 if_bridge.c
--- src/sys/net/if_bridge.c	21 Feb 2003 21:49:15 -0000	1.112
+++ src/sys/net/if_bridge.c	4 Mar 2003 16:52:53 -0000
@@@@ -2116,7 +2116,7 @@@@
 	struct tdb *tdb;
 	u_int32_t spi;
 	u_int16_t cpi;
-	int error, off;
+	int error, off = 0;
 	u_int8_t proto = 0;
 #ifdef INET
 	struct ip *ip;
Index: src/sys/net/if_vlan.c
===================================================================
RCS file: /cvs/src/sys/net/if_vlan.c,v
retrieving revision 1.34
diff -u -r1.34 if_vlan.c
--- src/sys/net/if_vlan.c	1 Feb 2003 00:14:18 -0000	1.34
+++ src/sys/net/if_vlan.c	4 Mar 2003 16:52:53 -0000
@@@@ -376,7 +376,7 @@@@
 		 */
 		ifv->ifv_if.if_mtu = p->if_mtu - EVL_ENCAPLEN;
 #ifdef DIAGNOSTIC
-		printf("%s: initialized with non-standard mtu %d (parent %s)\n",
+		printf("%s: initialized with non-standard mtu %ld (parent %s)\n",
 		    ifv->ifv_if.if_xname, ifv->ifv_if.if_mtu,
 		    ifv->ifv_p->if_xname);
 #endif
Index: src/sys/net/pf.c
===================================================================
RCS file: /cvs/src/sys/net/pf.c,v
retrieving revision 1.326
diff -u -r1.326 pf.c
--- src/sys/net/pf.c	4 Mar 2003 11:23:21 -0000	1.326
+++ src/sys/net/pf.c	7 Mar 2003 16:37:03 -0000
@@@@ -949,6 +949,7 @@@@
 	u_int32_t	opc;
 	u_int16_t	oip = *ip;
 
+	opc = 0U;
 	PF_ACPY(&oia, ia, af);
 	PF_ACPY(&ooa, oa, af);
 
@@@@ -1030,12 +1031,12 @@@@
 	struct m_tag	*mtag;
 	int		 len;
 #ifdef INET
-	struct ip	*h2;
+	struct ip	*h2 = NULL;
 #endif /* INET */
 #ifdef INET6
-	struct ip6_hdr	*h2_6;
+	struct ip6_hdr	*h2_6 = NULL;
 #endif /* INET6 */
-	struct tcphdr	*th2;
+	struct tcphdr	*th2 = NULL;
 
 	switch (af) {
 #ifdef INET
@@@@ -1048,6 +1049,8 @@@@
 		len = sizeof(struct ip6_hdr) + sizeof(struct tcphdr);
 		break;
 #endif /* INET6 */
+    default:
+	printf("panic: trying to send RST to an unhandled address family\n");
 	}
 
 	/* don't reply to RST packets */
@@@@ -2417,6 +2420,8 @@@@
 			state_icmp++;
 		break;
 #endif /* INET6 */
+	default:
+		return (PF_DROP);
 	}
 
 	if (direction == PF_OUT) {
@@@@ -3261,6 +3266,8 @@@@
 			state_icmp++;
 		break;
 #endif /* INET6 */
+		default:
+			return (PF_DROP);
 	}
 
 	if (!state_icmp) {
@@@@ -3429,6 +3436,8 @@@@
 			} while (!terminal);
 			break;
 #endif /* INET6 */
+		default:
+			return (PF_DROP);
 		}
 
 		switch (pd2.proto) {
@@@@ -4441,8 +4450,9 @@@@
 			r0.ifp = ifp;
 			r0.action = action;
 			r0.nr = -1;
-			PFLOG_PACKET(ifp, h, m, AF_INET, dir, reason, &r0);
-		} else
+			if (h != NULL)
+				PFLOG_PACKET(ifp, h, m, AF_INET, dir, reason, &r0);
+		} else if (h != NULL)
 			PFLOG_PACKET(ifp, h, m, AF_INET, dir, reason, r);
 	}
 
Index: src/sys/net/pfkeyv2.c
===================================================================
RCS file: /cvs/src/sys/net/pfkeyv2.c,v
retrieving revision 1.87
diff -u -r1.87 pfkeyv2.c
--- src/sys/net/pfkeyv2.c	16 Feb 2003 21:29:51 -0000	1.87
+++ src/sys/net/pfkeyv2.c	4 Mar 2003 16:52:53 -0000
@@@@ -768,7 +768,7 @@@@
 
 	struct tdb sa, *sa2 = NULL;
 
-	struct sadb_msg *smsg;
+	struct sadb_msg *smsg = NULL;
 	struct sadb_spirange *sprng;
 	struct sadb_sa *ssa;
 	struct sadb_supported *ssup;
Index: src/sys/netinet/ip_ah.c
===================================================================
RCS file: /cvs/src/sys/netinet/ip_ah.c,v
retrieving revision 1.72
diff -u -r1.72 ip_ah.c
--- src/sys/netinet/ip_ah.c	28 Feb 2003 21:42:34 -0000	1.72
+++ src/sys/netinet/ip_ah.c	4 Mar 2003 16:52:53 -0000
@@@@ -684,7 +684,7 @@@@
 int
 ah_input_cb(void *op)
 {
-	int s, roff, rplen, error, skip, protoff;
+	int s, roff, rplen, error = 0, skip, protoff;
 	unsigned char calc[AH_ALEN_MAX];
 	struct mbuf *m1, *m0, *m;
 	struct cryptodesc *crd;
@@@@ -1216,7 +1216,7 @@@@
 int
 ah_output_cb(void *op)
 {
-	int skip, protoff, error;
+	int skip, protoff, error = 0;
 	struct tdb_crypto *tc;
 	struct cryptop *crp;
 	struct tdb *tdb;
Index: src/sys/netinet/ip_esp.c
===================================================================
RCS file: /cvs/src/sys/netinet/ip_esp.c,v
retrieving revision 1.80
diff -u -r1.80 ip_esp.c
--- src/sys/netinet/ip_esp.c	28 Feb 2003 21:42:34 -0000	1.80
+++ src/sys/netinet/ip_esp.c	4 Mar 2003 16:52:53 -0000
@@@@ -455,7 +455,7 @@@@
 esp_input_cb(void *op)
 {
 	u_int8_t lastthree[3], aalg[AH_HMAC_HASHLEN];
-	int s, hlen, roff, skip, protoff, error;
+	int s, hlen, roff, skip, protoff, error = 0;
 	struct mbuf *m1, *mo, *m;
 	struct auth_hash *esph;
 	struct tdb_crypto *tc;
@@@@ -976,7 +976,7 @@@@
 	struct tdb_crypto *tc;
 	struct tdb *tdb;
 	struct mbuf *m;
-	int error, s;
+	int error = 0, s;
 
 	tc = (struct tdb_crypto *) crp->crp_opaque;
 	m = (struct mbuf *) crp->crp_buf;
Index: src/sys/netinet/ip_ipcomp.c
===================================================================
RCS file: /cvs/src/sys/netinet/ip_ipcomp.c,v
retrieving revision 1.11
diff -u -r1.11 ip_ipcomp.c
--- src/sys/netinet/ip_ipcomp.c	18 Feb 2003 18:47:18 -0000	1.11
+++ src/sys/netinet/ip_ipcomp.c	4 Mar 2003 16:52:53 -0000
@@@@ -209,7 +209,7 @@@@
 ipcomp_input_cb(op)
 	void *op;
 {
-	int error, s, skip, protoff, roff, hlen = IPCOMP_HLENGTH, clen;
+	int error = 0, s, skip, protoff, roff, hlen = IPCOMP_HLENGTH, clen;
 	u_int8_t nproto;
 	struct mbuf *m, *m1, *mo;
 	struct cryptodesc *crd;
@@@@ -612,7 +612,7 @@@@
 	struct tdb_crypto *tc;
 	struct tdb *tdb;
 	struct mbuf *m;
-	int error, s, skip, rlen;
+	int error = 0, s, skip, rlen;
 #ifdef INET
 	struct ip *ip;
 #endif
Index: src/sys/netinet/ip_ipsp.c
===================================================================
RCS file: /cvs/src/sys/netinet/ip_ipsp.c,v
retrieving revision 1.150
diff -u -r1.150 ip_ipsp.c
--- src/sys/netinet/ip_ipsp.c	19 Nov 2002 18:34:19 -0000	1.150
+++ src/sys/netinet/ip_ipsp.c	4 Mar 2003 16:52:53 -0000
@@@@ -867,7 +867,7 @@@@
 	    ntohl(tdb->tdb_spi), ipsp_address(tdb->tdb_dst), tdb->tdb_sproto);
 
 	l += sprintf(buffer + l, "\tEstablished %d seconds ago\n",
-	    time.tv_sec - tdb->tdb_established);
+	    (int) (time.tv_sec - tdb->tdb_established));
 
 	l += sprintf(buffer + l, "\tSource = %s", ipsp_address(tdb->tdb_src));
 
Index: src/sys/netinet/ip_output.c
===================================================================
RCS file: /cvs/src/sys/netinet/ip_output.c,v
retrieving revision 1.151
diff -u -r1.151 ip_output.c
--- src/sys/netinet/ip_output.c	31 Jan 2003 17:26:41 -0000	1.151
+++ src/sys/netinet/ip_output.c	4 Mar 2003 16:52:53 -0000
@@@@ -100,24 +100,24 @@@@
 ip_output(struct mbuf *m0, ...)
 {
 	struct ip *ip;
-	struct ifnet *ifp;
+	struct ifnet *ifp = NULL;
 	struct mbuf *m = m0;
 	int hlen = sizeof (struct ip);
 	int len, error = 0;
 	struct route iproute;
-	struct sockaddr_in *dst;
-	struct in_ifaddr *ia;
+	struct sockaddr_in *dst = NULL;
+	struct in_ifaddr *ia ;
 	struct mbuf *opt;
 	struct route *ro;
 	int flags;
 	struct ip_moptions *imo;
 	va_list ap;
 	u_int8_t sproto = 0, donerouting = 0;
-	u_long mtu;
+	u_long mtu = 0;
 #ifdef IPSEC
 	u_int32_t icmp_mtu = 0;
 	union sockaddr_union sdst;
-	u_int32_t sspi;
+	u_int32_t sspi = 0;
 	struct m_tag *mtag;
 	struct tdb_ident *tdbi;
 
Index: src/sys/netinet/ipsec_output.c
===================================================================
RCS file: /cvs/src/sys/netinet/ipsec_output.c,v
retrieving revision 1.26
diff -u -r1.26 ipsec_output.c
--- src/sys/netinet/ipsec_output.c	19 Feb 2003 19:14:51 -0000	1.26
+++ src/sys/netinet/ipsec_output.c	4 Mar 2003 16:52:53 -0000
@@@@ -65,15 +65,15 @@@@
 ipsp_process_packet(struct mbuf *m, struct tdb *tdb, int af, int tunalready)
 {
 	struct timeval tv;
-	int i, off, error;
+	int i = 0, off = 0, error;
 	struct mbuf *mp;
 
 #ifdef INET
 	int setdf = 0;
-	struct ip *ip;
+	struct ip *ip = NULL;
 #endif /* INET */
 #ifdef INET6
-	struct ip6_hdr *ip6;
+	struct ip6_hdr *ip6 = NULL;
 #endif /* INET6 */
 
 	/* Check that the transform is allowed by the administrator. */
@@@@ -326,11 +326,11 @@@@
 ipsp_process_done(struct mbuf *m, struct tdb *tdb)
 {
 #ifdef INET
-	struct ip *ip;
+	struct ip *ip = NULL;
 #endif /* INET */
 
 #ifdef INET6
-	struct ip6_hdr *ip6;
+	struct ip6_hdr *ip6 = NULL;
 #endif /* INET6 */
 
 	struct tdb_ident *tdbi;
Index: src/sys/netinet/tcp_input.c
===================================================================
RCS file: /cvs/src/sys/netinet/tcp_input.c,v
retrieving revision 1.125
diff -u -r1.125 tcp_input.c
--- src/sys/netinet/tcp_input.c	14 Feb 2003 17:54:24 -0000	1.125
+++ src/sys/netinet/tcp_input.c	4 Mar 2003 16:52:54 -0000
@@@@ -432,7 +432,7 @@@@
 #endif /* IPSEC */
 	int af;
 #ifdef TCP_ECN
-	u_char iptos;
+	u_char iptos = 0;
 #endif
 
 	va_start(ap, m);
Index: src/sys/netinet/tcp_output.c
===================================================================
RCS file: /cvs/src/sys/netinet/tcp_output.c,v
retrieving revision 1.54
diff -u -r1.54 tcp_output.c
--- src/sys/netinet/tcp_output.c	25 Jan 2003 15:27:07 -0000	1.54
+++ src/sys/netinet/tcp_output.c	4 Mar 2003 16:52:54 -0000
@@@@ -220,8 +220,8 @@@@
 	register struct tcpcb *tp;
 {
 	register struct socket *so = tp->t_inpcb->inp_socket;
-	register long len, win, txmaxseg;
-	int off, flags, error;
+	register long len = 0, win, txmaxseg;
+	int off, flags, error = 0;
 	register struct mbuf *m;
 	register struct tcphdr *th;
 	u_char opt[MAX_TCPOPTLEN];
@@@@ -229,7 +229,7 @@@@
 	int idle, sendalot = 0;
 #ifdef TCP_SACK
 	int i, sack_rxmit = 0;
-	struct sackhole *p;
+	struct sackhole *p = NULL;
 #endif
 #if defined(TCP_SACK)
 	int maxburst = TCP_MAXBURST;
Index: src/sys/netinet/tcp_subr.c
===================================================================
RCS file: /cvs/src/sys/netinet/tcp_subr.c,v
retrieving revision 1.65
diff -u -r1.65 tcp_subr.c
--- src/sys/netinet/tcp_subr.c	28 Aug 2002 15:42:41 -0000	1.65
+++ src/sys/netinet/tcp_subr.c	4 Mar 2003 16:52:54 -0000
@@@@ -134,7 +134,7 @@@@
 #endif
 int	tcp_do_sack = TCP_DO_SACK;		/* RFC 2018 selective ACKs */
 int	tcp_ack_on_push = 0;	/* set to enable immediate ACK-on-PUSH */
-int	tcp_do_ecn = 0;		/* RFC3168 ECN enabled/disabled? */
+int	tcp_do_ecn = 1;		/* RFC3168 ECN enabled/disabled? */
 
 #ifndef TCBHASHSIZE
 #define	TCBHASHSIZE	128
@@@@ -212,7 +212,7 @@@@
 	if ((m = tp->t_template) == 0) {
 		m = m_get(M_DONTWAIT, MT_HEADER);
 		if (m == NULL)
-			return (0);
+			return (NULL);
 
 		switch (tp->pf) {
 		case 0:	/*default to PF_INET*/
@@@@ -287,6 +287,8 @@@@
 		}
 		break;
 #endif /* INET6 */
+    default:
+	return (NULL);
 	}
 
 	th->th_sport = inp->inp_lport;
@@@@ -392,6 +394,8 @@@@
 			xchg(ti->ti_dst.s_addr, ti->ti_src.s_addr, u_int32_t);
 			th = (void *)((caddr_t)ti + sizeof(struct ip));
 			break;
+	default:
+	    return;
 		}
 		xchg(th->th_dport, th->th_sport, u_int16_t);
 #undef xchg
@@@@ -408,6 +412,8 @@@@
 		tlen += sizeof (struct tcpiphdr);
 		th = (struct tcphdr *)((caddr_t)ti + sizeof(struct ip));
 		break;
+    default:
+	return;
 	}
 
 	m->m_len = tlen;
@@@@ -808,6 +814,7 @@@@
 	} else {
 		m = NULL;
 		ip6 = NULL;
+	off = 0;
 		sa6_src = &sa6_any;
 	}
 
Index: src/sys/netinet/tcp_usrreq.c
===================================================================
RCS file: /cvs/src/sys/netinet/tcp_usrreq.c,v
retrieving revision 1.68
diff -u -r1.68 tcp_usrreq.c
--- src/sys/netinet/tcp_usrreq.c	12 Feb 2003 14:40:46 -0000	1.68
+++ src/sys/netinet/tcp_usrreq.c	4 Mar 2003 16:52:54 -0000
@@@@ -785,10 +785,10 @@@@
 {
 	int error = 0, s;
 	struct tcp_ident_mapping tir;
-	struct inpcb *inp;
-	struct sockaddr_in *fin, *lin;
+	struct inpcb *inp = NULL;
+	struct sockaddr_in *fin = NULL, *lin = NULL;
 #ifdef INET6
-	struct sockaddr_in6 *fin6, *lin6;
+	struct sockaddr_in6 *fin6 = NULL, *lin6 = NULL;
 	struct in6_addr f6, l6;
 #endif
 
Index: src/sys/netinet/udp_usrreq.c
===================================================================
RCS file: /cvs/src/sys/netinet/udp_usrreq.c,v
retrieving revision 1.86
diff -u -r1.86 udp_usrreq.c
--- src/sys/netinet/udp_usrreq.c	28 Aug 2002 15:42:41 -0000	1.86
+++ src/sys/netinet/udp_usrreq.c	4 Mar 2003 16:52:54 -0000
@@@@ -714,6 +714,7 @@@@
 		m = NULL;
 		ip6 = NULL;
 		cmdarg = NULL;
+		off = 0;
 		/* XXX: translate addresses into internal form */
 		sa6 = *(struct sockaddr_in6 *)sa;
 #ifndef SCOPEDROUTING
Index: src/sys/netinet6/in6_ifattach.c
===================================================================
RCS file: /cvs/src/sys/netinet6/in6_ifattach.c,v
retrieving revision 1.32
diff -u -r1.32 in6_ifattach.c
--- src/sys/netinet6/in6_ifattach.c	12 Sep 2002 01:11:32 -0000	1.32
+++ src/sys/netinet6/in6_ifattach.c	4 Mar 2003 16:52:54 -0000
@@@@ -674,12 +674,13 @@@@
 	nd6_purge(ifp);
 
 	/* nuke any of IPv6 addresses we have */
-	for (ifa = ifp->if_addrlist.tqh_first; ifa; ifa = next)
-	{
+	ifa = ifp->if_addrlist.tqh_first;
+	while (ifa) {
 		next = ifa->ifa_list.tqe_next;
 		if (ifa->ifa_addr->sa_family != AF_INET6)
 			continue;
 		in6_purgeaddr(ifa);
+		ifa = next;
 	}
 
 	/* undo everything done by in6_ifattach(), just in case */
@@@@ -734,6 +735,7 @@@@
 		}
 
 		IFAFREE(&oia->ia_ifa);
+		ifa = next;
 	}
 
 	/* cleanup multicast address kludge table, if there is any */
Index: src/sys/netinet6/ip6_forward.c
===================================================================
RCS file: /cvs/src/sys/netinet6/ip6_forward.c,v
retrieving revision 1.24
diff -u -r1.24 ip6_forward.c
--- src/sys/netinet6/ip6_forward.c	9 Jun 2002 14:38:17 -0000	1.24
+++ src/sys/netinet6/ip6_forward.c	4 Mar 2003 16:52:54 -0000
@@@@ -88,7 +88,7 @@@@
 	struct ip6_hdr *ip6 = mtod(m, struct ip6_hdr *);
 	struct sockaddr_in6 *dst;
 	struct rtentry *rt;
-	int error, type = 0, code = 0;
+	int error = 0, type = 0, code = 0;
 	struct mbuf *mcopy = NULL;
 	long time_second = time.tv_sec;
 	struct ifnet *origifp;	/* maybe unnecessary */
Index: src/sys/netinet6/ip6_output.c
===================================================================
RCS file: /cvs/src/sys/netinet6/ip6_output.c,v
retrieving revision 1.73
diff -u -r1.73 ip6_output.c
--- src/sys/netinet6/ip6_output.c	31 Oct 2002 18:02:05 -0000	1.73
+++ src/sys/netinet6/ip6_output.c	4 Mar 2003 16:52:54 -0000
@@@@ -168,7 +168,7 @@@@
 	struct m_tag *mtag;
 	union sockaddr_union sdst;
 	struct tdb_ident *tdbi;
-	u_int32_t sspi;
+	u_int32_t sspi = 0;
 	struct inpcb *inp;
 	struct tdb *tdb;
 	int s;
Index: src/sys/netinet6/raw_ip6.c
===================================================================
RCS file: /cvs/src/sys/netinet6/raw_ip6.c,v
retrieving revision 1.17
diff -u -r1.17 raw_ip6.c
--- src/sys/netinet6/raw_ip6.c	11 Sep 2002 03:27:08 -0000	1.17
+++ src/sys/netinet6/raw_ip6.c	4 Mar 2003 16:52:54 -0000
@@@@ -378,7 +378,8 @@@@
 	int error = 0;
 	struct ip6_pktopts opt, *optp = NULL, *origoptp;
 	struct ifnet *oifp = NULL;
-	int type, code;		/* for ICMPv6 output statistics only */
+	/* for ICMPv6 output statistics only */
+	int type = 0, code = 0;
 	int priv = 0;
 	va_list ap;
 	int flags;
Index: src/sys/nfs/nfsproto.h
===================================================================
RCS file: /cvs/src/sys/nfs/nfsproto.h,v
retrieving revision 1.4
diff -u -r1.4 nfsproto.h
--- src/sys/nfs/nfsproto.h	28 Jan 2002 22:35:57 -0000	1.4
+++ src/sys/nfs/nfsproto.h	4 Mar 2003 16:52:54 -0000
@@@@ -54,18 +54,18 @@@@
  * Specification"
  */
 
-#define NFS_PORT	2049
+#define	NFS_PORT	2049
 #define	NFS_PROG	100003
-#define NFS_VER2	2
+#define	NFS_VER2	2
 #define	NFS_VER3	3
-#define NFS_VER4        4
-#define NFS_V2MAXDATA	8192
-#define	NFS_MAXDGRAMDATA 16384
+#define	NFS_VER4        4
+#define	NFS_V2MAXDATA	8192
+#define	NFS_MAXDGRAMDATA 32768
 #define	NFS_MAXDATA	32768
 #define	NFS_MAXPATHLEN	1024
 #define	NFS_MAXNAMLEN	255
 #define	NFS_MAXPKTHDR	404
-#define NFS_MAXPACKET	(NFS_MAXPKTHDR + NFS_MAXDATA)
+#define	NFS_MAXPACKET	(NFS_MAXPKTHDR + NFS_MAXDATA)
 #define	NFS_MINPACKET	20
 #define	NFS_FABLKSIZE	512	/* Size in bytes of a block wrt fa_blocks */
 
@@@@ -100,12 +100,12 @@@@
 #define	NFSERR_SERVERFAULT	10006
 #define	NFSERR_BADTYPE		10007
 #define	NFSERR_JUKEBOX		10008
-#define NFSERR_TRYLATER		NFSERR_JUKEBOX
+#define	NFSERR_TRYLATER		NFSERR_JUKEBOX
 #define	NFSERR_STALEWRITEVERF	30001	/* Fake return for nfs_commit() */
 
-#define NFSERR_RETVOID		0x20000000 /* Return void, not error */
-#define NFSERR_AUTHERR		0x40000000 /* Mark an authentication error */
-#define NFSERR_RETERR		0x80000000 /* Mark an error return for V3 */
+#define	NFSERR_RETVOID		0x20000000 /* Return void, not error */
+#define	NFSERR_AUTHERR		0x40000000 /* Mark an authentication error */
+#define	NFSERR_RETERR		0x80000000 /* Mark an error return for V3 */
 
 /* Sizes in bytes of various nfs rpc components */
 #define	NFSX_UNSIGNED	4
@@@@ -115,38 +115,38 @@@@
 #define	NFSX_V2FATTR	68
 #define	NFSX_V2SATTR	32
 #define	NFSX_V2COOKIE	4
-#define NFSX_V2STATFS	20
+#define	NFSX_V2STATFS	20
 
 /* specific to NFS Version 3 */
-#define NFSX_V3FH		(sizeof (fhandle_t)) /* size this server uses */
+#define	NFSX_V3FH		(sizeof (fhandle_t)) /* size this server uses */
 #define	NFSX_V3FHMAX		64	/* max. allowed by protocol */
-#define NFSX_V3FATTR		84
-#define NFSX_V3SATTR		60	/* max. all fields filled in */
-#define NFSX_V3SRVSATTR		(sizeof (struct nfsv3_sattr))
-#define NFSX_V3POSTOPATTR	(NFSX_V3FATTR + NFSX_UNSIGNED)
-#define NFSX_V3WCCDATA		(NFSX_V3POSTOPATTR + 8 * NFSX_UNSIGNED)
-#define NFSX_V3COOKIEVERF 	8
-#define NFSX_V3WRITEVERF 	8
-#define NFSX_V3CREATEVERF	8
-#define NFSX_V3STATFS		52
-#define NFSX_V3FSINFO		48
-#define NFSX_V3PATHCONF		24
+#define	NFSX_V3FATTR		84
+#define	NFSX_V3SATTR		60	/* max. all fields filled in */
+#define	NFSX_V3SRVSATTR		(sizeof (struct nfsv3_sattr))
+#define	NFSX_V3POSTOPATTR	(NFSX_V3FATTR + NFSX_UNSIGNED)
+#define	NFSX_V3WCCDATA		(NFSX_V3POSTOPATTR + 8 * NFSX_UNSIGNED)
+#define	NFSX_V3COOKIEVERF 	8
+#define	NFSX_V3WRITEVERF 	8
+#define	NFSX_V3CREATEVERF	8
+#define	NFSX_V3STATFS		52
+#define	NFSX_V3FSINFO		48
+#define	NFSX_V3PATHCONF		24
 
 /* variants for both versions */
-#define NFSX_FH(v3)		((v3) ? (NFSX_V3FHMAX + NFSX_UNSIGNED) : \
+#define	NFSX_FH(v3)		((v3) ? (NFSX_V3FHMAX + NFSX_UNSIGNED) : \
 					NFSX_V2FH)
-#define NFSX_SRVFH(v3)		((v3) ? NFSX_V3FH : NFSX_V2FH)
+#define	NFSX_SRVFH(v3)		((v3) ? NFSX_V3FH : NFSX_V2FH)
 #define	NFSX_FATTR(v3)		((v3) ? NFSX_V3FATTR : NFSX_V2FATTR)
-#define NFSX_PREOPATTR(v3)	((v3) ? (7 * NFSX_UNSIGNED) : 0)
-#define NFSX_POSTOPATTR(v3)	((v3) ? (NFSX_V3FATTR + NFSX_UNSIGNED) : 0)
-#define NFSX_POSTOPORFATTR(v3)	((v3) ? (NFSX_V3FATTR + NFSX_UNSIGNED) : \
+#define	NFSX_PREOPATTR(v3)	((v3) ? (7 * NFSX_UNSIGNED) : 0)
+#define	NFSX_POSTOPATTR(v3)	((v3) ? (NFSX_V3FATTR + NFSX_UNSIGNED) : 0)
+#define	NFSX_POSTOPORFATTR(v3)	((v3) ? (NFSX_V3FATTR + NFSX_UNSIGNED) : \
 					NFSX_V2FATTR)
-#define NFSX_WCCDATA(v3)	((v3) ? NFSX_V3WCCDATA : 0)
-#define NFSX_WCCORFATTR(v3)	((v3) ? NFSX_V3WCCDATA : NFSX_V2FATTR)
+#define	NFSX_WCCDATA(v3)	((v3) ? NFSX_V3WCCDATA : 0)
+#define	NFSX_WCCORFATTR(v3)	((v3) ? NFSX_V3WCCDATA : NFSX_V2FATTR)
 #define	NFSX_SATTR(v3)		((v3) ? NFSX_V3SATTR : NFSX_V2SATTR)
 #define	NFSX_COOKIEVERF(v3)	((v3) ? NFSX_V3COOKIEVERF : 0)
 #define	NFSX_WRITEVERF(v3)	((v3) ? NFSX_V3WRITEVERF : 0)
-#define NFSX_READDIR(v3)	((v3) ? (5 * NFSX_UNSIGNED) : \
+#define	NFSX_READDIR(v3)	((v3) ? (5 * NFSX_UNSIGNED) : \
 					(2 * NFSX_UNSIGNED))
 #define	NFSX_STATFS(v3)		((v3) ? NFSX_V3STATFS : NFSX_V2STATFS)
 
@@@@ -174,7 +174,7 @@@@
 #define	NFSPROC_PATHCONF	20
 #define	NFSPROC_COMMIT		21
 
-#define NFSPROC_NOOP		25
+#define	NFSPROC_NOOP		25
 #define	NFS_NPROCS		26
 
 /* Actual Version 2 procedure numbers */
@@@@ -201,35 +201,35 @@@@
 /*
  * Constants used by the Version 3 protocol for various RPCs
  */
-#define NFSV3SATTRTIME_DONTCHANGE	0
-#define NFSV3SATTRTIME_TOSERVER		1
-#define NFSV3SATTRTIME_TOCLIENT		2
-
-#define NFSV3ACCESS_READ		0x01
-#define NFSV3ACCESS_LOOKUP		0x02
-#define NFSV3ACCESS_MODIFY		0x04
-#define NFSV3ACCESS_EXTEND		0x08
-#define NFSV3ACCESS_DELETE		0x10
-#define NFSV3ACCESS_EXECUTE		0x20
-
-#define NFSV3WRITE_UNSTABLE		0
-#define NFSV3WRITE_DATASYNC		1
-#define NFSV3WRITE_FILESYNC		2
-
-#define NFSV3CREATE_UNCHECKED		0
-#define NFSV3CREATE_GUARDED		1
-#define NFSV3CREATE_EXCLUSIVE		2
-
-#define NFSV3FSINFO_LINK		0x01
-#define NFSV3FSINFO_SYMLINK		0x02
-#define NFSV3FSINFO_HOMOGENEOUS		0x08
-#define NFSV3FSINFO_CANSETTIME		0x10
+#define	NFSV3SATTRTIME_DONTCHANGE	0
+#define	NFSV3SATTRTIME_TOSERVER		1
+#define	NFSV3SATTRTIME_TOCLIENT		2
+
+#define	NFSV3ACCESS_READ		0x01
+#define	NFSV3ACCESS_LOOKUP		0x02
+#define	NFSV3ACCESS_MODIFY		0x04
+#define	NFSV3ACCESS_EXTEND		0x08
+#define	NFSV3ACCESS_DELETE		0x10
+#define	NFSV3ACCESS_EXECUTE		0x20
+
+#define	NFSV3WRITE_UNSTABLE		0
+#define	NFSV3WRITE_DATASYNC		1
+#define	NFSV3WRITE_FILESYNC		2
+
+#define	NFSV3CREATE_UNCHECKED		0
+#define	NFSV3CREATE_GUARDED		1
+#define	NFSV3CREATE_EXCLUSIVE		2
+
+#define	NFSV3FSINFO_LINK		0x01
+#define	NFSV3FSINFO_SYMLINK		0x02
+#define	NFSV3FSINFO_HOMOGENEOUS		0x08
+#define	NFSV3FSINFO_CANSETTIME		0x10
 
 /* Conversion macros */
 #define	vtonfsv2_mode(t,m) \
 		txdr_unsigned(((t) == VFIFO) ? MAKEIMODE(VCHR, (m)) : \
 				MAKEIMODE((t), (m)))
-#define vtonfsv3_mode(m)	txdr_unsigned((m) & 07777)
+#define	vtonfsv3_mode(m)	txdr_unsigned((m) & 07777)
 #define	nfstov_mode(a)		(fxdr_unsigned(u_int16_t, (a))&07777)
 #define	vtonfsv2_type(a)	txdr_unsigned(nfsv2_type[((int32_t)(a))])
 #define	vtonfsv3_type(a)	txdr_unsigned(nfsv3_type[((int32_t)(a))])
@@@@ -249,7 +249,7 @@@@
  * NFS_SMALLFH should be in the range of 32 to 64 and be divisible by 4.
  */
 #ifndef NFS_SMALLFH
-#define NFS_SMALLFH	64
+#define	NFS_SMALLFH	64
 #endif
 union nfsfh {
 	fhandle_t fh_generic;
@@@@ -400,18 +400,18 @@@@
 	} sf_un;
 };
 
-#define sf_tsize	sf_un.sf_nfsv2.nfsv2sf_tsize
-#define sf_bsize	sf_un.sf_nfsv2.nfsv2sf_bsize
-#define sf_blocks	sf_un.sf_nfsv2.nfsv2sf_blocks
-#define sf_bfree	sf_un.sf_nfsv2.nfsv2sf_bfree
-#define sf_bavail	sf_un.sf_nfsv2.nfsv2sf_bavail
-#define sf_tbytes	sf_un.sf_nfsv3.nfsv3sf_tbytes
-#define sf_fbytes	sf_un.sf_nfsv3.nfsv3sf_fbytes
-#define sf_abytes	sf_un.sf_nfsv3.nfsv3sf_abytes
-#define sf_tfiles	sf_un.sf_nfsv3.nfsv3sf_tfiles
-#define sf_ffiles	sf_un.sf_nfsv3.nfsv3sf_ffiles
-#define sf_afiles	sf_un.sf_nfsv3.nfsv3sf_afiles
-#define sf_invarsec	sf_un.sf_nfsv3.nfsv3sf_invarsec
+#define	sf_tsize	sf_un.sf_nfsv2.nfsv2sf_tsize
+#define	sf_bsize	sf_un.sf_nfsv2.nfsv2sf_bsize
+#define	sf_blocks	sf_un.sf_nfsv2.nfsv2sf_blocks
+#define	sf_bfree	sf_un.sf_nfsv2.nfsv2sf_bfree
+#define	sf_bavail	sf_un.sf_nfsv2.nfsv2sf_bavail
+#define	sf_tbytes	sf_un.sf_nfsv3.nfsv3sf_tbytes
+#define	sf_fbytes	sf_un.sf_nfsv3.nfsv3sf_fbytes
+#define	sf_abytes	sf_un.sf_nfsv3.nfsv3sf_abytes
+#define	sf_tfiles	sf_un.sf_nfsv3.nfsv3sf_tfiles
+#define	sf_ffiles	sf_un.sf_nfsv3.nfsv3sf_ffiles
+#define	sf_afiles	sf_un.sf_nfsv3.nfsv3sf_afiles
+#define	sf_invarsec	sf_un.sf_nfsv3.nfsv3sf_invarsec
 
 struct nfsv3_fsinfo {
 	u_int32_t fs_rtmax;
Index: src/sys/stand/boot/cmd.c
===================================================================
RCS file: /cvs/src/sys/stand/boot/cmd.c,v
retrieving revision 1.48
diff -u -r1.48 cmd.c
--- src/sys/stand/boot/cmd.c	14 Jul 2002 09:18:55 -0000	1.48
+++ src/sys/stand/boot/cmd.c	4 Mar 2003 16:52:54 -0000
@@@@ -86,8 +86,19 @@@@
 {
 	cmd.cmd = NULL;
 
-	if (!readline(cmd_buf, sizeof(cmd_buf), cmd.timeout))
+	switch (readline(cmd_buf, sizeof(cmd_buf), cmd.timeout))
+	{
+	default:
+		cmd.timeout = 0;
+		break;
+	case 0:
+		cmd.timeout = 0;
 		cmd.cmd = cmd_table;
+		break;
+	case -1:
+		strncpy(cmd_buf, "boot", 5);
+		break;
+	}
 
 	return docmd();
 }
@@@@ -238,11 +249,16 @@@@
 			if (!(i++ % 1000) && (getsecs() >= tt))
 				break;
 
+#if 0
 		if (!cnischar()) {
 			strncpy(buf, "boot", 5);
 			putchar('\n');
 			return strlen(buf);
 		}
+#else
+		if (!cnischar())
+			return -1;
+#endif
 	} else
 		while (!cnischar()) ;
 
@@@@ -499,4 +515,3 @@@@
 	exit();
 	return 0; /* just in case */
 }
-
Index: src/sys/sys/proc.h
===================================================================
RCS file: /cvs/src/sys/sys/proc.h,v
retrieving revision 1.62
diff -u -r1.62 proc.h
--- src/sys/sys/proc.h	20 Jul 2002 19:24:35 -0000	1.62
+++ src/sys/sys/proc.h	4 Mar 2003 16:52:54 -0000
@@@@ -1,3 +1,4 @@@@
+/*	$MirBSD: obsd.kernel,v 1.16 2003/03/22 22:33:25 tg Exp $	*/
 /*	$OpenBSD: proc.h,v 1.62 2002/07/20 19:24:57 art Exp $	*/
 /*	$NetBSD: proc.h,v 1.44 1996/04/22 01:23:21 christos Exp $	*/
 
@@@@ -18,10 +19,6 @@@@
  * 2. Redistributions in binary form must reproduce the above copyright
  *    notice, this list of conditions and the following disclaimer in the
  *    documentation and/or other materials provided with the distribution.
- * 3. All advertising materials mentioning features or use of this software
- *    must display the following acknowledgement:
- *	This product includes software developed by the University of
- *	California, Berkeley and its contributors.
  * 4. Neither the name of the University nor the names of its contributors
  *    may be used to endorse or promote products derived from this software
  *    without specific prior written permission.
@@@@ -396,6 +393,7 @@@@
 void	exit2(struct proc *);
 int	fork1(struct proc *, int, int, void *, size_t, void (*)(void *),
 	    void *, register_t *);
+u_int	nFork;
 void	rqinit(void);
 int	groupmember(gid_t, struct ucred *);
 #if !defined(cpu_switch)
Index: src/sys/sys/resource.h
===================================================================
RCS file: /cvs/src/sys/sys/resource.h,v
retrieving revision 1.4
diff -u -r1.4 resource.h
--- src/sys/sys/resource.h	14 Mar 2002 01:26:52 -0000	1.4
+++ src/sys/sys/resource.h	4 Mar 2003 16:52:54 -0000
@@@@ -89,8 +89,9 @@@@
 #define	RLIMIT_MEMLOCK	6		/* locked-in-memory address space */
 #define	RLIMIT_NPROC	7		/* number of processes */
 #define	RLIMIT_NOFILE	8		/* number of open files */
+#define	RLIMIT_TIME	9		/* user time */
 
-#define	RLIM_NLIMITS	9		/* number of resource limits */
+#define	RLIM_NLIMITS	10		/* number of resource limits */
 
 #define	RLIM_INFINITY	(((u_quad_t)1 << 63) - 1)
 
Index: src/sys/sys/sysctl.h
===================================================================
RCS file: /cvs/src/sys/sys/sysctl.h,v
retrieving revision 1.62
diff -u -r1.62 sysctl.h
--- src/sys/sys/sysctl.h	21 Jan 2003 16:59:01 -0000	1.62
+++ src/sys/sys/sysctl.h	4 Mar 2003 16:52:54 -0000
@@@@ -1,3 +1,4 @@@@
+/*	$MirBSD: obsd.kernel,v 1.16 2003/03/22 22:33:25 tg Exp $	*/
 /*	$OpenBSD: sysctl.h,v 1.62 2003/01/21 16:59:23 markus Exp $	*/
 /*	$NetBSD: sysctl.h,v 1.16 1996/04/09 20:55:36 cgd Exp $	*/
 
@@@@ -16,10 +17,6 @@@@
  * 2. Redistributions in binary form must reproduce the above copyright
  *    notice, this list of conditions and the following disclaimer in the
  *    documentation and/or other materials provided with the distribution.
- * 3. All advertising materials mentioning features or use of this software
- *    must display the following acknowledgement:
- *	This product includes software developed by the University of
- *	California, Berkeley and its contributors.
  * 4. Neither the name of the University nor the names of its contributors
  *    may be used to endorse or promote products derived from this software
  *    without specific prior written permission.
@@@@ -141,7 +138,7 @@@@
 #define	KERN_DOMAINNAME		22	/* string: (YP) domainname */
 #define	KERN_MAXPARTITIONS	23	/* int: number of partitions/disk */
 #define	KERN_RAWPARTITION	24	/* int: raw partition number */
-/*define gap			25	*/
+#define	KERN_OSPATCHLEVEL	25	/* string: system mirabile patchlevel */
 /*define gap			26	*/
 #define	KERN_OSVERSION		27	/* string: kernel build version */
 #define	KERN_SOMAXCONN		28	/* int: listen queue maximum */
@@@@ -179,9 +176,11 @@@@
 #define KERN_USERASYMCRYPTO	60	/* int: usercrypto */
 #define	KERN_SEMINFO		61	/* struct: SysV struct seminfo */
 #define	KERN_SHMINFO		62	/* struct: SysV struct shminfo */
-#define KERN_INTRCNT		63	/* node: interrupt counters */
+#define	KERN_INTRCNT		63	/* node: interrupt counters */
 #define	KERN_WATCHDOG		64	/* node: watchdog */
-#define	KERN_MAXID		65	/* number of valid kern ids */
+#define	KERN_ALLOWPSA		65	/* int: allow user "ps a" */
+#define	KERN_ALLOWPSE		66	/* int: allow user "ps e" */
+#define	KERN_MAXID		67	/* number of valid kern ids */
 
 #define	CTL_KERN_NAMES { \
 	{ 0, 0 }, \
@@@@ -209,7 +208,7 @@@@
 	{ "domainname", CTLTYPE_STRING }, \
 	{ "maxpartitions", CTLTYPE_INT }, \
 	{ "rawpartition", CTLTYPE_INT }, \
-	{ "gap", 0 }, \
+	{ "ospatchlevel", CTLTYPE_STRING }, \
 	{ "gap", 0 }, \
 	{ "osversion", CTLTYPE_STRING }, \
 	{ "somaxconn", CTLTYPE_INT }, \
@@@@ -249,6 +248,8 @@@@
 	{ "shminfo", CTLTYPE_STRUCT }, \
 	{ "intrcnt", CTLTYPE_NODE }, \
  	{ "watchdog", CTLTYPE_NODE }, \
+	{ "allowpsa", CTLTYPE_INT }, \
+	{ "allowpse", CTLTYPE_INT }, \
 }
 
 /*
Index: src/sys/sys/systm.h
===================================================================
RCS file: /cvs/src/sys/sys/systm.h,v
retrieving revision 1.54
diff -u -r1.54 systm.h
--- src/sys/sys/systm.h	21 Jan 2003 16:59:01 -0000	1.54
+++ src/sys/sys/systm.h	4 Mar 2003 16:52:54 -0000
@@@@ -80,6 +80,7 @@@@
 extern const char copyright[];	/* system copyright */
 extern const char ostype[];
 extern const char osversion[];
+extern const char ospatchlevel[];
 extern const char osrelease[];
 extern int cold;		/* cold start flag initialized in locore */
 
Index: src/sys/sys/utsname.h
===================================================================
RCS file: /cvs/src/sys/sys/utsname.h,v
retrieving revision 1.4
diff -u -r1.4 utsname.h
--- src/sys/sys/utsname.h	14 Mar 2002 01:26:52 -0000	1.4
+++ src/sys/sys/utsname.h	4 Mar 2003 16:52:54 -0000
@@@@ -1,3 +1,4 @@@@
+/*	$MirBSD: obsd.kernel,v 1.16 2003/03/22 22:33:25 tg Exp $	*/
 /*	$OpenBSD: utsname.h,v 1.4 2002/03/14 01:27:14 millert Exp $	*/
 /*	$NetBSD: utsname.h,v 1.6 1994/06/29 06:46:11 cgd Exp $	*/
 
@@@@ -16,10 +17,6 @@@@
  * 2. Redistributions in binary form must reproduce the above copyright
  *    notice, this list of conditions and the following disclaimer in the
  *    documentation and/or other materials provided with the distribution.
- * 3. All advertising materials mentioning features or use of this software
- *    must display the following acknowledgement:
- *	This product includes software developed by the University of
- *	California, Berkeley and its contributors.
  * 4. Neither the name of the University nor the names of its contributors
  *    may be used to endorse or promote products derived from this software
  *    without specific prior written permission.
@@@@ -50,6 +47,7 @@@@
 	char	release[SYS_NMLN];	/* Release level. */
 	char	version[SYS_NMLN];	/* Version level. */
 	char	machine[SYS_NMLN];	/* Hardware type. */
+	char	patchlevel[SYS_NMLN];	/* Patch level. */
 };
 
 #include <sys/cdefs.h>
Index: src/sys/ufs/ffs/ffs_softdep.c
===================================================================
RCS file: /cvs/src/sys/ufs/ffs/ffs_softdep.c,v
retrieving revision 1.42
diff -u -r1.42 ffs_softdep.c
--- src/sys/ufs/ffs/ffs_softdep.c	12 Oct 2002 01:09:23 -0000	1.42
+++ src/sys/ufs/ffs/ffs_softdep.c	4 Mar 2003 16:52:54 -0000
@@@@ -327,7 +327,7 @@@@
 	struct sema *semap;
 	struct lockit *interlock;
 {
-	int s;
+	int s = 0;
 
 	if (semap->value++ > 0) {
 		if (interlock != NULL)
Index: src/sys/ufs/ffs/ffs_vfsops.c
===================================================================
RCS file: /cvs/src/sys/ufs/ffs/ffs_vfsops.c,v
retrieving revision 1.54
diff -u -r1.54 ffs_vfsops.c
--- src/sys/ufs/ffs/ffs_vfsops.c	1 Aug 2002 16:41:11 -0000	1.54
+++ src/sys/ufs/ffs/ffs_vfsops.c	4 Mar 2003 16:52:57 -0000
@@@@ -167,7 +167,7 @@@@
 	struct ufsmount *ump = NULL;
 	register struct fs *fs;
 	int error = 0, flags;
-	int ronly;
+	int ronly = 0;
 	mode_t accessmode;
 	size_t size;
 
Index: src/sys/uvm/uvm_amap.c
===================================================================
RCS file: /cvs/src/sys/uvm/uvm_amap.c,v
retrieving revision 1.27
diff -u -r1.27 uvm_amap.c
--- src/sys/uvm/uvm_amap.c	9 May 2002 14:13:56 -0000	1.27
+++ src/sys/uvm/uvm_amap.c	4 Mar 2003 16:52:57 -0000
@@@@ -1007,7 +1007,7 @@@@
 	struct vm_amap *amap;
 	int slotoff, slots;
 {
-	int byanon, lcv, stop, curslot, ptr, slotend;
+	int byanon, lcv, stop, curslot, ptr, slotend = 0;
 	struct vm_anon *anon;
 
 	/*
Index: src/sys/uvm/uvm_map.c
===================================================================
RCS file: /cvs/src/sys/uvm/uvm_map.c,v
retrieving revision 1.56
diff -u -r1.56 uvm_map.c
--- src/sys/uvm/uvm_map.c	9 Dec 2002 02:34:59 -0000	1.56
+++ src/sys/uvm/uvm_map.c	4 Mar 2003 16:52:58 -0000
@@@@ -304,9 +304,10 @@@@
 
 	RB_FOREACH(tmp, uvm_tree, &map->rbhead) {
 		if (tmp->ownspace != uvm_rb_space(map, tmp)) {
-			printf("%s: %d/%d ownspace %x != %x %s\n",
+			printf("%s: %d/%d ownspace %lx != %lx %s\n",
 			    name, n + 1, map->nentries,
-			    tmp->ownspace, uvm_rb_space(map, tmp),
+			    (unsigned long) tmp->ownspace,
+		   (unsigned long) uvm_rb_space(map, tmp),
 			    tmp->next == &map->header ? "(last)" : "");
 			goto error;
 		}
@@@@ -314,13 +315,14 @@@@
 	trtmp = NULL;
 	RB_FOREACH(tmp, uvm_tree, &map->rbhead) {
 		if (tmp->space != uvm_rb_subtree_space(tmp)) {
-			printf("%s: space %d != %d\n",
+			printf("%s: space %ld != %d\n",
 			    name, tmp->space, uvm_rb_subtree_space(tmp));
 			goto error;
 		}
 		if (trtmp != NULL && trtmp->start >= tmp->start) {
-			printf("%s: corrupt: %p >= %p\n",
-			    name, trtmp->start, tmp->start);
+			printf("%s: corrupt: %lu >= %lu\n",
+			    name, (unsigned long) trtmp->start,
+			    (unsigned long) tmp->start);
 			goto error;
 		}
 		n++;
Index: src/sys/uvm/uvm_meter.c
===================================================================
RCS file: /cvs/src/sys/uvm/uvm_meter.c,v
retrieving revision 1.17
diff -u -r1.17 uvm_meter.c
--- src/sys/uvm/uvm_meter.c	14 Mar 2002 01:26:56 -0000	1.17
+++ src/sys/uvm/uvm_meter.c	4 Mar 2003 16:52:58 -0000
@@@@ -61,6 +61,8 @@@@
 int maxslp = MAXSLP;	/* patchable ... */
 struct loadavg averunnable;
 
+extern int allowpse;
+
 /*
  * constants for averages over 1, 5, and 15 minutes when sampling at
  * 5 second intervals.
@@@@ -134,6 +136,7 @@@@
 	struct vmtotal vmtotals;
 	int rv, t;
 	struct _ps_strings _ps = { PS_STRINGS };
+	struct proc *cur = curproc;
 
 	switch (name[0]) {
 	case VM_SWAPENCRYPT:
@@@@ -168,6 +171,11 @@@@
 		return (sysctl_rdint(oldp, oldlenp, newp, nkmempages));
 
 	case VM_PSSTRINGS:
+		if ((!allowpse) &&
+		    (cur->p_cred->p_ruid != p->p_cred->p_ruid) &&
+		    (cur->p_cred->p_rgid))
+			return (EPERM);
+
 		return (sysctl_rdstruct(oldp, oldlenp, newp, &_ps,
 		    sizeof(_ps)));
 	case VM_ANONMIN:
Index: src/sys/uvm/uvm_pager.c
===================================================================
RCS file: /cvs/src/sys/uvm/uvm_pager.c,v
retrieving revision 1.33
diff -u -r1.33 uvm_pager.c
--- src/sys/uvm/uvm_pager.c	29 Oct 2002 18:29:59 -0000	1.33
+++ src/sys/uvm/uvm_pager.c	4 Mar 2003 16:52:58 -0000
@@@@ -795,7 +795,7 @@@@
 	struct vm_page *pg, *pgs[npages];
 	struct uvm_object *uobj;
 	int i, error;
-	boolean_t write, swap;
+	boolean_t write, swap = FALSE;
 	UVMHIST_FUNC("uvm_aio_aiodone"); UVMHIST_CALLED(ubchist);
 	UVMHIST_LOG(ubchist, "bp %p", bp, 0,0,0);
 
Index: src/sys/uvm/uvm_swap.c
===================================================================
RCS file: /cvs/src/sys/uvm/uvm_swap.c,v
retrieving revision 1.55
diff -u -r1.55 uvm_swap.c
--- src/sys/uvm/uvm_swap.c	12 Oct 2002 01:09:23 -0000	1.55
+++ src/sys/uvm/uvm_swap.c	4 Mar 2003 16:52:58 -0000
@@@@ -1813,7 +1813,7 @@@@
 #ifdef UVM_SWAP_ENCRYPT
 	vaddr_t dstkva;
 	struct vm_page *tpps[MAXBSIZE >> PAGE_SHIFT];
-	struct swapdev *sdp;
+	struct swapdev *sdp = NULL;
 	int	encrypt = 0;
 #endif
 	UVMHIST_FUNC("uvm_swap_io"); UVMHIST_CALLED(pdhist);
index: src/sys/arch/i386/include/loadfile_machdep.h
===================================================================
RCS file: /cvs/src/sys/arch/i386/include/loadfile_machdep.h,v
retrieving revision DEAD
--- /dev/null	Fri Mar  7 18:01:23 2003
+++ src/sys/arch/i386/include/loadfile_machdep.h	Tue Mar  4 16:52:58 2003
@@@@ -0,0 +1,65 @@@@
+/*	$OpenBSD: loadfile_machdep.h,v 1.1 2001/09/01 15:49:06 drahn Exp $	*/
+/*	$NetBSD: loadfile_machdep.h,v 1.1 1999/04/29 03:17:12 tsubai Exp $	*/
+
+/*-
+ * Copyright (c) 1999 The NetBSD Foundation, Inc.
+ * All rights reserved.
+ *
+ * This code is derived from software contributed to The NetBSD Foundation
+ * by Christos Zoulas.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ * 1. Redistributions of source code must retain the above copyright
+ *    notice, this list of conditions and the following disclaimer.
+ * 2. Redistributions in binary form must reproduce the above copyright
+ *    notice, this list of conditions and the following disclaimer in the
+ *    documentation and/or other materials provided with the distribution.
+ * 3. All advertising materials mentioning features or use of this software
+ *    must display the following acknowledgement:
+ *        This product includes software developed by the NetBSD
+ *        Foundation, Inc. and its contributors.
+ * 4. Neither the name of The NetBSD Foundation nor the names of its
+ *    contributors may be used to endorse or promote products derived
+ *    from this software without specific prior written permission.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE NETBSD FOUNDATION, INC. AND CONTRIBUTORS
+ * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
+ * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
+ * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE FOUNDATION OR CONTRIBUTORS
+ * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
+ * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
+ * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
+ * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
+ * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
+ * POSSIBILITY OF SUCH DAMAGE.
+ */
+
+#ifndef	_LOADFILE_MACHDEP_H
+#define	_LOADFILE_MACHDEP_H
+
+#define BOOT_ELF
+#define BOOT_AOUT
+#define ELFSIZE 32
+
+#define LOAD_KERNEL	(LOAD_ALL & ~LOAD_TEXTA)
+#define COUNT_KERNEL	(COUNT_ALL & ~COUNT_TEXTA)
+
+#define LOADADDR(a)		((((u_long)(a)) + offset)&0xfffffff)
+#define ALIGNENTRY(a)		((u_long)(a))
+#define READ(f, b, c)		read((f), (void *)LOADADDR(b), (c))
+#define BCOPY(s, d, c)		memcpy((void *)LOADADDR(d), (void *)(s), (c))
+#define BZERO(d, c)		memset((void *)LOADADDR(d), 0, (c))
+#define	WARN(a)			(void)(printf a, \
+				    printf((errno ? ": %s\n" : "\n"), \
+				    strerror(errno)))
+#define PROGRESS(a)		(void) printf a
+#define ALLOC(a)		alloc(a)
+#define FREE(a, b)		free(a, b)
+#define OKMAGIC(a)		((a) == OMAGIC)
+
+void run_loadfile(u_long *, int);
+
+#endif
index: src/sys/arch/i386/include/reloc.h
===================================================================
RCS file: /cvs/src/sys/arch/i386/include/reloc.h,v
retrieving revision DEAD
--- /dev/null	Fri Mar  7 18:01:24 2003
+++ src/sys/arch/i386/include/reloc.h	Tue Mar  4 16:52:58 2003
@@@@ -0,0 +1,49 @@@@
+/*	$OpenBSD$	*/
+
+/*
+ * Copyright (c) 2002,2003 Dale Rahn
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ * 1. Redistributions of source code must retain the above copyright
+ *    notice, this list of conditions and the following disclaimer.
+ * 2. Redistributions in binary form must reproduce the above copyright
+ *    notice, this list of conditions and the following disclaimer in the
+ *    documentation and/or other materials provided with the distribution.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE AUTHOR "AS IS" AND ANY EXPRESS
+ * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
+ * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY
+ * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
+ * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
+ * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+ * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
+ * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
+ * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
+ * SUCH DAMAGE.
+ */
+
+#ifndef	_MACH_RELOC_H 
+#define	_MACH_RELOC_H 
+
+#define	R_TYPE(X)	__CONCAT(RELOC_,X)
+
+#define	RELOC_NONE	0    /* No reloc */
+#define	RELOC_32	1    /* Direct 32 bit  */
+#define	RELOC_PC32	2    /* PC relative 32 bit */
+#define	RELOC_GOT32	3    /* 32 bit GOT entry */
+#define	RELOC_PLT32	4    /* 32 bit PLT address */
+#define	RELOC_COPY	5    /* Copy symbol at runtime */
+#define	RELOC_GLOB_DAT	6    /* Create GOT entry */
+#define	RELOC_JUMP_SLOT	7    /* Create PLT entry */
+#define	RELOC_RELATIVE	8    /* Adjust by program base */
+#define	RELOC_GOTOFF	9    /* 32 bit offset to GOT */
+#define	RELOC_GOTPC	10   /* 32 bit PC relative offset to GOT */
+#define	RELOC_16	20
+#define	RELOC_PC16	21
+#define	RELOC_8		22
+#define	RELOC_PC8	23
+
+#endif	/* _MACH_RELOC_H */
index: src/sys/stand/boot/boot_loadfile.c
===================================================================
RCS file: /cvs/src/sys/stand/boot/boot_loadfile.c,v
retrieving revision DEAD
--- /dev/null	Fri Mar  7 18:01:24 2003
+++ src/sys/stand/boot/boot_loadfile.c	Tue Mar  4 16:52:58 2003
@@@@ -0,0 +1,119 @@@@
+/*	$OpenBSD: boot.c,v 1.23 2000/12/29 19:24:44 mickey Exp $	*/
+
+/*
+ * Copyright (c) 2003 Dale Rahn
+ * Copyright (c) 1997,1998 Michael Shalayeff
+ * All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ * 1. Redistributions of source code must retain the above copyright
+ *    notice, this list of conditions and the following disclaimer.
+ * 2. Redistributions in binary form must reproduce the above copyright
+ *    notice, this list of conditions and the following disclaimer in the
+ *    documentation and/or other materials provided with the distribution.
+ * 3. All advertising materials mentioning features or use of this software
+ *    must display the following acknowledgement:
+ *	This product includes software developed by Michael Shalayeff.
+ * 4. The name of the author may not be used to endorse or promote products
+ *    derived from this software without specific prior written permission.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR 
+ * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
+ * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
+ * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
+ * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
+ * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+ * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
+ * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
+ * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
+ * SUCH DAMAGE.
+ *
+ */
+
+#include <sys/param.h>
+#include <sys/reboot.h>
+#include <sys/stat.h>
+#include <libsa.h>
+#include <lib/libsa/loadfile.h>
+
+#include "cmd.h"
+
+
+static const char *const kernels[] = {
+	"/bsd",
+	"/obsd",
+	"/bsd.old",
+	NULL
+};
+
+extern	const char version[];
+struct cmd_state cmd;
+
+void
+boot(bootdev)
+	dev_t	bootdev;
+{
+	register const char *bootfile = kernels[0];
+	register int i = 0, try = 0, st;
+	u_long marks[MARK_MAX];
+
+printf("bootdev %x\n", bootdev);
+	machdep();
+
+	printf(">> OpenBSD/" MACHINE " BOOT %s\n", version);
+
+	devboot(bootdev, cmd.bootdev);
+	strncpy(cmd.image, bootfile, sizeof(cmd.image));
+	cmd.boothowto = 0;
+	cmd.conf = "/etc/boot.conf";
+	cmd.addr = (void *)DEFAULT_KERNEL_ADDRESS;
+	cmd.timeout = 5;
+
+	st = read_conf();
+
+	while (1) {
+		if (st <= 0) /* no boot.conf, or no boot cmd in there */
+			do {
+				printf("boot> ");
+			} while(!getcmd());
+		st = 0;
+
+		printf("booting %s: ", cmd.path);
+		marks[MARK_START] = 0;
+		if (loadfile(cmd.path, marks, LOAD_ALL) >= 0)
+			break;
+
+		if (kernels[++i] == NULL) {
+			try += 1;
+			bootfile = kernels[i=0];
+		} else
+			bootfile = kernels[i];
+		strncpy(cmd.image, bootfile, sizeof(cmd.image));
+		printf(" failed(%d). will try %s\n", errno, bootfile);
+
+		if (try < 2)
+			cmd.timeout++;
+		else {
+			if (cmd.timeout)
+				printf("Turning timeout off.\n");
+			cmd.timeout = 0;
+		}
+	}
+
+	/* exec */
+	run_loadfile(marks, cmd.boothowto);
+
+	/* panic?? */
+}
+
+#ifdef _TEST
+int
+main()
+{
+	boot(0);
+	return 0;
+}
+#endif

@


1.16
log
@- sync with repo
- rm fixed stuff
- tmp""ly add file list (for reference)
@
text
@d9 1
a9 1
+#	$MirBSD: obsd.kernel,v 1.15 2003/03/07 18:06:48 tg Exp $
d55 1
a55 1
+#	$MirBSD: obsd.kernel,v 1.15 2003/03/07 18:06:48 tg Exp $
d152 1
a152 1
+#	$MirBSD: obsd.kernel,v 1.15 2003/03/07 18:06:48 tg Exp $
d196 1
a196 1
+#	$MirBSD: obsd.kernel,v 1.15 2003/03/07 18:06:48 tg Exp $
d236 1
a236 1
+#	$MirBSD: obsd.kernel,v 1.15 2003/03/07 18:06:48 tg Exp $
d270 1
a270 1
+#	$MirBSD: obsd.kernel,v 1.15 2003/03/07 18:06:48 tg Exp $
d304 1
a304 1
+#	$MirBSD: obsd.kernel,v 1.15 2003/03/07 18:06:48 tg Exp $
d3158 1
a3158 1
+#	$MirBSD: obsd.kernel,v 1.15 2003/03/07 18:06:48 tg Exp $
d3215 1
a3215 1
+#	$MirBSD: obsd.kernel,v 1.15 2003/03/07 18:06:48 tg Exp $
d3265 1
a3265 1
+ospl="$(echo '\$Date: 2003/03/07 18:06:48 $' | sed -e 's,^.*: ,,' -e 's,/,,g' -e 's, .*$,,')"
d3278 1
a3278 1
+    "    @@(#)MirBSD from ${ost} ${osr} (${id}) #${v}: ${t}\n	@@(#)\$MirBSD: obsd.kernel,v 1.15 2003/03/07 18:06:48 tg Exp $\n";
d3282 1
a3282 1
+    "MirBSD ${osr}-${ospl} (${id}) #${v}: ${t}\n    ${u}@@${h}:${d}\n    patchlevel:\$MirBSD: obsd.kernel,v 1.15 2003/03/07 18:06:48 tg Exp $\n";
d3527 1
a3527 1
+/*	$MirBSD: obsd.kernel,v 1.15 2003/03/07 18:06:48 tg Exp $	*/
d4146 1
a4146 1
+/*	$MirBSD: obsd.kernel,v 1.15 2003/03/07 18:06:48 tg Exp $	*/
d4168 1
a4168 1
+/*	$MirBSD: obsd.kernel,v 1.15 2003/03/07 18:06:48 tg Exp $	*/
d4540 1
a4540 1
+#	$MirBSD: obsd.kernel,v 1.15 2003/03/07 18:06:48 tg Exp $
d5648 1
a5648 1
+/*	$MirBSD: obsd.kernel,v 1.15 2003/03/07 18:06:48 tg Exp $	*/
d5697 1
a5697 1
+/*	$MirBSD: obsd.kernel,v 1.15 2003/03/07 18:06:48 tg Exp $	*/
d5776 1
a5776 1
+/*	$MirBSD: obsd.kernel,v 1.15 2003/03/07 18:06:48 tg Exp $	*/
@


1.15
log
@intermediate; should work tho

sync ports
pull in new egcs-propolice 3.2.2-2 by etoh
www/lynx fallback to active ftp is pasv doesnt work & vice-versa
tinyirc update
stuff compiles with -Wall -Werror -pedantic
@
text
@a0 27
>> http://templeofhate.com/tglaser/MirBSD/index.php
>> MirBSD is a modified version of OpenBSD (http://www.OpenBSD.org/)

Copyright (c) 1982-2003 by Thorsten "mirabile" Glaser <x86@@ePost.de>
Copyright  1968-2003 NOP by the authors of and contributors to AT&T
    UNIX; the "C" Language, xBSD/Berkeley Unix; 386BSD, NetBSD 1.1,
    OpenBSD and MirBSD. The licence conditions of specific files be-
    fore patching also applies to the patched unless the file is re-
    placed in its entirety.

I hereby permit everyone who obtained a copy of this work to distri-
bute, sell, give away, modify, sublicense, merge and use it, freely.
I retain the right to be known as an author of the work.

The work is provided "as is", with no explicit or implicit warranty.
Use at your own risk. Neither author nor any contributor may be held
liable for any damage, directly or indirectly, which originated thru
creation or modification of this work. Because computing devices are
error-prone, flawless behaviour cannot be expected.


This diff, ID $MirBSD: regen-obsdp.sh,v 1.14 2003/03/01 22:12:48 tg Exp $
(/usr/ports/mystuff/kernel-metafiles to obsd.kernel) is made
against CTM on Fri Mar  7 18:01:04 UTC 2003.

### GENERATOR: @@(#)_MirBSD: regen-obsdp.sh,v 1.14 2003/03/01 22:12:48 tg Exp $
### CTM OpenBSD-cvs 3094
d9 1
a9 1
+#	$MirBSD: obsd.kernel,v 1.14 2003/03/04 16:52:26 tg Exp $
d55 1
a55 1
+#	$MirBSD: obsd.kernel,v 1.14 2003/03/04 16:52:26 tg Exp $
d152 1
a152 1
+#	$MirBSD: obsd.kernel,v 1.14 2003/03/04 16:52:26 tg Exp $
d196 1
a196 1
+#	$MirBSD: obsd.kernel,v 1.14 2003/03/04 16:52:26 tg Exp $
d236 1
a236 1
+#	$MirBSD: obsd.kernel,v 1.14 2003/03/04 16:52:26 tg Exp $
d270 1
a270 1
+#	$MirBSD: obsd.kernel,v 1.14 2003/03/04 16:52:26 tg Exp $
d304 1
a304 1
+#	$MirBSD: obsd.kernel,v 1.14 2003/03/04 16:52:26 tg Exp $
d3158 1
a3158 1
+#	$MirBSD: obsd.kernel,v 1.14 2003/03/04 16:52:26 tg Exp $
d3215 1
a3215 1
+#	$MirBSD: obsd.kernel,v 1.14 2003/03/04 16:52:26 tg Exp $
d3265 1
a3265 1
+ospl="$(echo '\$Date: 2003/03/04 16:52:26 $' | sed -e 's,^.*: ,,' -e 's,/,,g' -e 's, .*$,,')"
d3278 1
a3278 1
+    "    @@(#)MirBSD from ${ost} ${osr} (${id}) #${v}: ${t}\n	@@(#)\$MirBSD: obsd.kernel,v 1.14 2003/03/04 16:52:26 tg Exp $\n";
d3282 1
a3282 1
+    "MirBSD ${osr}-${ospl} (${id}) #${v}: ${t}\n    ${u}@@${h}:${d}\n    patchlevel:\$MirBSD: obsd.kernel,v 1.14 2003/03/04 16:52:26 tg Exp $\n";
d3527 1
a3527 1
+/*	$MirBSD: obsd.kernel,v 1.14 2003/03/04 16:52:26 tg Exp $	*/
d4146 1
a4146 1
+/*	$MirBSD: obsd.kernel,v 1.14 2003/03/04 16:52:26 tg Exp $	*/
d4168 1
a4168 1
+/*	$MirBSD: obsd.kernel,v 1.14 2003/03/04 16:52:26 tg Exp $	*/
d4540 1
a4540 1
+#	$MirBSD: obsd.kernel,v 1.14 2003/03/04 16:52:26 tg Exp $
d5648 1
a5648 1
+/*	$MirBSD: obsd.kernel,v 1.14 2003/03/04 16:52:26 tg Exp $	*/
d5697 1
a5697 1
+/*	$MirBSD: obsd.kernel,v 1.14 2003/03/04 16:52:26 tg Exp $	*/
d5776 1
a5776 1
+/*	$MirBSD: obsd.kernel,v 1.14 2003/03/04 16:52:26 tg Exp $	*/
a6207 137
Index: ports/mystuff/kernel-metafiles (meta file)
===================================================================
ports/mystuff/kernel-metafiles	.
ports/mystuff/kernel-patchfiles	.
ports/mystuff/kernel-addedfiles	.
ports/mystuff/kernel-notes	.
Index: ports/mystuff/kernel-patchfiles (meta file)
===================================================================
src/sys/arch/i386/conf/DISKLESS			see below...
src/sys/arch/i386/conf/GENERIC			adjust settings; INCLUDE_CONFIG_FILE, don't taint GPL
src/sys/arch/i386/conf/Makefile.i386		kernelcflags; ELF
src/sys/arch/i386/conf/RAMDISK			adjust settings
src/sys/arch/i386/conf/RAMDISKB			adjust settings
src/sys/arch/i386/conf/RAMDISKC			adjust settings
src/sys/arch/i386/conf/RAMDISK_CD		adjust settings
src/sys/arch/i386/i386/bios.c
src/sys/arch/i386/i386/db_magic.s		ELF
src/sys/arch/i386/i386/in_cksum.s		ELF
src/sys/arch/i386/i386/locore.s			ELF
src/sys/arch/i386/i386/machdep.c
src/sys/arch/i386/i386/microtime.s		ELF
src/sys/arch/i386/i386/random.s			ELF
src/sys/arch/i386/include/asm.h			ELF
src/sys/arch/i386/include/biosvar.h		hmm
src/sys/arch/i386/include/bus.h			ELF
src/sys/arch/i386/include/cdefs.h		ELF
src/sys/arch/i386/include/db_machdep.h		ELF
src/sys/arch/i386/include/exec.h		exec ELF support
src/sys/arch/i386/include/intr.h		ELF
src/sys/arch/i386/include/param.h		ELF
src/sys/arch/i386/isa/clock.c
src/sys/arch/i386/isa/icu.s			ELF
src/sys/arch/i386/isa/npx.c			ELF
src/sys/arch/i386/isa/pccom.c
src/sys/arch/i386/isa/vector.s			ELF
src/sys/arch/i386/pci/pchb.c
src/sys/arch/i386/pci/pci_addr_fixup.c
src/sys/arch/i386/pci/pcibios.c
src/sys/arch/i386/stand/Makefile.inc		kernelcflags
src/sys/arch/i386/stand/biosboot/Makefile	ELF
src/sys/arch/i386/stand/biosboot/biosboot.S	ELF
src/sys/arch/i386/stand/boot/Makefile		ELF
src/sys/arch/i386/stand/boot/conf.c		bump version
src/sys/arch/i386/stand/boot/srt0.S		ELF
src/sys/arch/i386/stand/installboot/installboot.c	ELF
src/sys/arch/i386/stand/libsa/Makefile		ELF
src/sys/arch/i386/stand/libsa/alloca.S		ELF
src/sys/arch/i386/stand/libsa/apmprobe.c	mwatts+KNF
src/sys/arch/i386/stand/libsa/bioscons.c	ansi/etc fixes
src/sys/arch/i386/stand/libsa/biosdev.c		ELF; fix deferred disklabel lookup
src/sys/arch/i386/stand/libsa/cmd_i386.c	mwatts
src/sys/arch/i386/stand/libsa/debug_i386.S	ELF
src/sys/arch/i386/stand/libsa/diskprobe.c	defer disklabel lookup; KNF
src/sys/arch/i386/stand/libsa/exec_i386.c	ELF
src/sys/arch/i386/stand/libsa/gidt.S		ansi C fixes; ELF
src/sys/arch/i386/stand/libsa/libsa.h		mwatts; ELF
src/sys/arch/i386/stand/libsa/machdep.c		ELF
src/sys/arch/i386/stand/libsa/smpprobe.c	ansi/etc fixes
src/sys/arch/i386/stand/mbr/Makefile		ELF
src/sys/arch/i386/stand/mbr/mbr.S		ELF
src/sys/conf/GENERIC				adjust settings
src/sys/conf/newvers.sh				s,-current,-mirabile, and INCLUDE_CONFIG_FILE
src/sys/ddb/db_trap.c				ELF
src/sys/dev/ccd.c
src/sys/dev/ic/dc.c
src/sys/dev/ic/if_wi.c
src/sys/dev/ic/if_wi_hostap.c
src/sys/dev/ic/ne2000.c
src/sys/dev/ic/rtl80x9.c
src/sys/dev/ic/rtl81x9.c
src/sys/dev/isa/if_we.c				ELF
src/sys/dev/isa/spkr.c				KNF, ...
src/sys/dev/microcode/aic7xxx/Makefile		$.curdir
src/sys/dev/mii/bmtphy.c
src/sys/dev/pci/if_bge.c
src/sys/dev/pci/if_sf.c
src/sys/dev/pci/if_ste.c
src/sys/dev/pci/pciide.c
src/sys/dev/systrace.c				; after :
src/sys/dev/wscons/wsdisplay.c
src/sys/kern/kern_exec.c			BDSM fork bomb defusion
src/sys/kern/kern_fork.c			BDSM fork bomb defusion
src/sys/kern/kern_sig.c
src/sys/kern/kern_synch.c
src/sys/kern/kern_sysctl.c			os patchlevel; ps ae disabler
src/sys/kern/subr_userconf.c
src/sys/kern/sys_generic.c
src/sys/kern/vfs_syscalls.c
src/sys/lib/libkern/arch/i386/Makefile.inc	ntoh[sl] -> hton[sl]
src/sys/lib/libkern/arch/i386/htonl.S		smaller (me!)
src/sys/lib/libkern/arch/i386/htons.S		smaller (me!)
src/sys/lib/libsa/exec_elf.c			ELF
src/sys/lib/libsa/loadfile.c			ELF
src/sys/lib/libz/Makefile			$.curdir
src/sys/miscfs/procfs/procfs_vnops.c
src/sys/miscfs/union/union_vnops.c
src/sys/net/if_bridge.c
src/sys/net/if_vlan.c
src/sys/net/pf.c
src/sys/net/pfkeyv2.c
src/sys/netinet/ip_ah.c
src/sys/netinet/ip_esp.c
src/sys/netinet/ip_ipcomp.c
src/sys/netinet/ip_ipsp.c
src/sys/netinet/ip_output.c
src/sys/netinet/ipsec_output.c
src/sys/netinet/tcp_input.c
src/sys/netinet/tcp_output.c
src/sys/netinet/tcp_subr.c			ECN on by default
src/sys/netinet/tcp_usrreq.c
src/sys/netinet/udp_usrreq.c
src/sys/netinet6/in6_ifattach.c
src/sys/netinet6/ip6_forward.c
src/sys/netinet6/ip6_output.c
src/sys/netinet6/raw_ip6.c
src/sys/nfs/nfsproto.h				higher default block sizes
src/sys/stand/boot/cmd.c			mwatts
src/sys/sys/proc.h				BDSM fork bomb defusion
src/sys/sys/resource.h				humantime
src/sys/sys/sysctl.h				os patchlevel; ps ae disabler
src/sys/sys/systm.h				os patchlevel
src/sys/sys/utsname.h				os patchlevel
src/sys/ufs/ffs/ffs_softdep.c
src/sys/ufs/ffs/ffs_vfsops.c
src/sys/uvm/uvm_amap.c
src/sys/uvm/uvm_map.c
src/sys/uvm/uvm_meter.c				todd@@ - ps ae
src/sys/uvm/uvm_pager.c
src/sys/uvm/uvm_swap.c
Index: ports/mystuff/kernel-addedfiles (meta file)
===================================================================
src/sys/arch/i386/include/loadfile_machdep.h	ELF
src/sys/arch/i386/include/reloc.h		ELF
src/sys/stand/boot/boot_loadfile.c		ELF
Index: ports/mystuff/kernel-notes (meta file)
===================================================================
/sys diffs and files
@


1.14
log
@the usual sync/update post-release
pre-build
@
text
@d24 1
a24 1
against CTM on Tue Mar  4 16:47:46 UTC 2003.
d27 1
a27 1
### CTM OpenBSD-cvs 3085
d34 7
a40 2
+++ src/sys/arch/i386/conf/DISKLESS	2 Mar 2003 01:08:51 -0000
@@@@ -12,7 +12,7 @@@@
d49 9
a57 1
@@@@ -173,7 +173,7 @@@@
d66 1
a66 1
@@@@ -312,6 +312,7 @@@@
d77 4
a80 4
retrieving revision 1.329
diff -u -r1.329 GENERIC
--- src/sys/arch/i386/conf/GENERIC	10 Feb 2003 22:32:11 -0000	1.329
+++ src/sys/arch/i386/conf/GENERIC	2 Mar 2003 01:08:51 -0000
d82 2
a83 2
+#	$MirBSD: obsd.kernel,v 1.13 2003/03/02 01:08:32 tg Exp $
 #	$OpenBSD: GENERIC,v 1.329 2003/02/10 22:32:33 jason Exp $
d177 1
a177 1
+++ src/sys/arch/i386/conf/Makefile.i386	2 Mar 2003 01:08:51 -0000
d179 1
a179 1
+#	$MirBSD: obsd.kernel,v 1.13 2003/03/02 01:08:32 tg Exp $
d221 7
a227 2
+++ src/sys/arch/i386/conf/RAMDISK	2 Mar 2003 01:08:51 -0000
@@@@ -5,11 +5,11 @@@@
d242 6
a247 1
@@@@ -158,6 +158,7 @@@@
d261 7
a267 2
+++ src/sys/arch/i386/conf/RAMDISKB	2 Mar 2003 01:08:51 -0000
@@@@ -9,7 +9,7 @@@@
d276 6
a281 1
@@@@ -174,6 +174,7 @@@@
d295 7
a301 2
+++ src/sys/arch/i386/conf/RAMDISKC	2 Mar 2003 01:08:51 -0000
@@@@ -9,7 +9,7 @@@@
d310 6
a315 1
@@@@ -168,6 +168,7 @@@@
d329 7
a335 2
+++ src/sys/arch/i386/conf/RAMDISK_CD	2 Mar 2003 01:08:51 -0000
@@@@ -9,7 +9,7 @@@@
d343 1
d345 3
a347 1
@@@@ -221,6 +221,7 @@@@
d361 1
a361 1
+++ src/sys/arch/i386/i386/bios.c	2 Mar 2003 01:08:51 -0000
d377 1
a377 1
+++ src/sys/arch/i386/i386/db_magic.s	2 Mar 2003 01:08:51 -0000
d444 1
a444 1
+++ src/sys/arch/i386/i386/in_cksum.s	2 Mar 2003 01:08:51 -0000
d470 1
a470 1
+++ src/sys/arch/i386/i386/locore.s	2 Mar 2003 01:08:51 -0000
d669 1
a669 1
+++ src/sys/arch/i386/i386/machdep.c	2 Mar 2003 01:08:51 -0000
d706 1
a706 1
+++ src/sys/arch/i386/i386/microtime.s	2 Mar 2003 01:08:51 -0000
d764 1
a764 1
+++ src/sys/arch/i386/i386/random.s	2 Mar 2003 01:08:51 -0000
d797 1
a797 1
+++ src/sys/arch/i386/include/asm.h	2 Mar 2003 01:08:51 -0000
d860 1
a860 1
+++ src/sys/arch/i386/include/biosvar.h	2 Mar 2003 01:08:51 -0000
d876 1
a876 1
+++ src/sys/arch/i386/include/bus.h	2 Mar 2003 01:08:51 -0000
d931 1
a931 1
+++ src/sys/arch/i386/include/cdefs.h	2 Mar 2003 01:08:51 -0000
d978 1
a978 1
+++ src/sys/arch/i386/include/db_machdep.h	2 Mar 2003 01:08:51 -0000
d994 1
a994 1
+++ src/sys/arch/i386/include/exec.h	2 Mar 2003 01:08:51 -0000
d1029 1
a1029 1
+++ src/sys/arch/i386/include/intr.h	2 Mar 2003 01:08:51 -0000
d1046 1
a1046 1
+++ src/sys/arch/i386/include/param.h	2 Mar 2003 01:08:51 -0000
d1069 1
a1069 1
+++ src/sys/arch/i386/isa/clock.c	2 Mar 2003 01:08:51 -0000
d1085 1
a1085 1
+++ src/sys/arch/i386/isa/icu.s	2 Mar 2003 01:08:51 -0000
d1117 1
a1117 1
+++ src/sys/arch/i386/isa/npx.c	2 Mar 2003 01:08:51 -0000
d1169 1
a1169 1
+++ src/sys/arch/i386/isa/pccom.c	2 Mar 2003 01:08:51 -0000
d1194 1
a1194 1
+++ src/sys/arch/i386/isa/vector.s	2 Mar 2003 01:08:51 -0000
d1370 1
a1370 1
+++ src/sys/arch/i386/pci/pchb.c	2 Mar 2003 01:08:51 -0000
d1386 1
a1386 1
+++ src/sys/arch/i386/pci/pci_addr_fixup.c	2 Mar 2003 01:08:51 -0000
d1419 1
a1419 1
+++ src/sys/arch/i386/pci/pcibios.c	2 Mar 2003 01:08:51 -0000
d1439 1
a1439 1
+++ src/sys/arch/i386/stand/Makefile.inc	2 Mar 2003 01:08:52 -0000
d1464 1
a1464 1
+++ src/sys/arch/i386/stand/biosboot/Makefile	2 Mar 2003 01:08:52 -0000
d1480 1
a1480 1
+++ src/sys/arch/i386/stand/biosboot/biosboot.S	2 Mar 2003 01:08:52 -0000
d1832 1
a1832 1
+++ src/sys/arch/i386/stand/boot/Makefile	2 Mar 2003 01:08:52 -0000
d1877 1
a1877 1
+++ src/sys/arch/i386/stand/boot/conf.c	2 Mar 2003 01:08:52 -0000
d1924 1
a1924 1
+++ src/sys/arch/i386/stand/boot/srt0.S	2 Mar 2003 01:08:52 -0000
d1997 1
a1997 1
+++ src/sys/arch/i386/stand/installboot/installboot.c	2 Mar 2003 01:08:52 -0000
d2133 1
a2133 1
+++ src/sys/arch/i386/stand/libsa/Makefile	2 Mar 2003 01:08:52 -0000
d2158 1
a2158 1
+++ src/sys/arch/i386/stand/libsa/alloca.S	2 Mar 2003 01:08:52 -0000
d2171 1
a2171 1
+++ src/sys/arch/i386/stand/libsa/apmprobe.c	2 Mar 2003 01:08:52 -0000
d2334 1
a2334 1
+++ src/sys/arch/i386/stand/libsa/bioscons.c	2 Mar 2003 01:08:52 -0000
d2350 1
a2350 1
+++ src/sys/arch/i386/stand/libsa/biosdev.c	2 Mar 2003 01:08:52 -0000
d2407 1
a2407 1
+++ src/sys/arch/i386/stand/libsa/cmd_i386.c	2 Mar 2003 01:08:52 -0000
d2484 1
a2484 1
+++ src/sys/arch/i386/stand/libsa/debug_i386.S	2 Mar 2003 01:08:52 -0000
d2513 1
a2513 1
+++ src/sys/arch/i386/stand/libsa/diskprobe.c	2 Mar 2003 01:08:52 -0000
d2564 1
a2564 1
+++ src/sys/arch/i386/stand/libsa/exec_i386.c	2 Mar 2003 01:08:52 -0000
d2622 1
a2622 1
+++ src/sys/arch/i386/stand/libsa/gidt.S	2 Mar 2003 01:08:52 -0000
d2986 1
a2986 1
+++ src/sys/arch/i386/stand/libsa/libsa.h	2 Mar 2003 01:08:52 -0000
d3017 1
a3017 1
+++ src/sys/arch/i386/stand/libsa/machdep.c	2 Mar 2003 01:08:52 -0000
d3033 1
a3033 1
+++ src/sys/arch/i386/stand/libsa/smpprobe.c	2 Mar 2003 01:08:52 -0000
d3060 1
a3060 1
+++ src/sys/arch/i386/stand/mbr/Makefile	2 Mar 2003 01:08:52 -0000
d3076 1
a3076 1
+++ src/sys/arch/i386/stand/mbr/mbr.S	2 Mar 2003 01:08:52 -0000
d3183 1
a3183 1
+++ src/sys/conf/GENERIC	2 Mar 2003 01:08:53 -0000
d3185 1
a3185 1
+#	$MirBSD: obsd.kernel,v 1.13 2003/03/02 01:08:32 tg Exp $
d3235 4
a3238 4
retrieving revision 1.50
diff -u -r1.50 newvers.sh
--- src/sys/conf/newvers.sh	13 Feb 2003 19:51:08 -0000	1.50
+++ src/sys/conf/newvers.sh	2 Mar 2003 01:08:55 -0000
d3242 1
a3242 1
+#	$MirBSD: obsd.kernel,v 1.13 2003/03/02 01:08:32 tg Exp $
d3256 1
a3256 1
 #	$OpenBSD: newvers.sh,v 1.50 2003/02/13 19:51:30 deraadt Exp $
d3292 1
a3292 1
+ospl="$(echo '\$Date: 2003/03/02 01:08:32 $' | sed -e 's,^.*: ,,' -e 's,/,,g' -e 's, .*$,,')"
d3304 2
a3305 2
-    "    @@(#)${ost} ${osr}-beta (${id}) #${v}: ${t}\n";
+    "    @@(#)MirBSD from ${ost} ${osr}-beta (${id}) #${v}: ${t}\n	@@(#)\$MirBSD: obsd.kernel,v 1.13 2003/03/02 01:08:32 tg Exp $\n";
d3307 1
a3307 1
-    "${ost} ${osr}-beta (${id}) #${v}: ${t}\n    ${u}@@${h}:${d}\n";
d3309 1
a3309 1
+    "MirBSD ${osr}-${ospl} (${id}) #${v}: ${t}\n    ${u}@@${h}:${d}\n    patchlevel:\$MirBSD: obsd.kernel,v 1.13 2003/03/02 01:08:32 tg Exp $\n";
d3319 1
a3319 1
+++ src/sys/ddb/db_trap.c	2 Mar 2003 01:08:55 -0000
d3359 1
a3359 1
+++ src/sys/dev/ccd.c	2 Mar 2003 01:08:55 -0000
d3375 1
a3375 1
+++ src/sys/dev/systrace.c	2 Mar 2003 01:08:55 -0000
d3391 1
a3391 1
+++ src/sys/dev/ic/dc.c	2 Mar 2003 01:08:56 -0000
d3431 1
a3431 1
+++ src/sys/dev/ic/if_wi.c	2 Mar 2003 01:08:56 -0000
d3447 1
a3447 1
+++ src/sys/dev/ic/if_wi_hostap.c	2 Mar 2003 01:08:56 -0000
d3484 1
a3484 1
+++ src/sys/dev/ic/ne2000.c	2 Mar 2003 01:08:56 -0000
d3500 1
a3500 1
+++ src/sys/dev/ic/rtl80x9.c	2 Mar 2003 01:08:56 -0000
d3516 1
a3516 1
+++ src/sys/dev/ic/rtl81x9.c	2 Mar 2003 01:08:56 -0000
d3535 1
a3535 1
+++ src/sys/dev/isa/if_we.c	2 Mar 2003 01:08:56 -0000
d3552 1
a3552 1
+++ src/sys/dev/isa/spkr.c	2 Mar 2003 01:08:56 -0000
d3554 1
a3554 1
+/*	$MirBSD: obsd.kernel,v 1.13 2003/03/02 01:08:32 tg Exp $	*/
d4011 1
a4011 1
+++ src/sys/dev/microcode/aic7xxx/Makefile	2 Mar 2003 01:08:56 -0000
d4027 1
a4027 1
+++ src/sys/dev/mii/bmtphy.c	2 Mar 2003 01:08:56 -0000
d4054 1
a4054 1
+++ src/sys/dev/pci/if_bge.c	2 Mar 2003 01:08:56 -0000
d4098 1
a4098 1
+++ src/sys/dev/pci/if_sf.c	2 Mar 2003 01:08:56 -0000
d4114 1
a4114 1
+++ src/sys/dev/pci/if_ste.c	2 Mar 2003 01:08:56 -0000
d4127 5
a4131 5
retrieving revision 1.116
diff -u -r1.116 pciide.c
--- src/sys/dev/pci/pciide.c	24 Feb 2003 20:53:53 -0000	1.116
+++ src/sys/dev/pci/pciide.c	2 Mar 2003 01:08:56 -0000
@@@@ -3780,7 +3780,7 @@@@
d4140 1
a4140 1
@@@@ -4080,7 +4080,7 @@@@
d4155 1
a4155 1
+++ src/sys/dev/wscons/wsdisplay.c	2 Mar 2003 01:08:56 -0000
d4171 1
a4171 1
+++ src/sys/kern/kern_exec.c	2 Mar 2003 01:08:57 -0000
d4173 1
a4173 1
+/*	$MirBSD: obsd.kernel,v 1.13 2003/03/02 01:08:32 tg Exp $	*/
d4193 1
a4193 1
+++ src/sys/kern/kern_fork.c	2 Mar 2003 01:08:57 -0000
d4195 1
a4195 1
+/*	$MirBSD: obsd.kernel,v 1.13 2003/03/02 01:08:32 tg Exp $	*/
d4261 1
a4261 1
+++ src/sys/kern/kern_sig.c	2 Mar 2003 01:08:57 -0000
d4357 1
a4357 1
+++ src/sys/kern/kern_synch.c	2 Mar 2003 01:08:57 -0000
d4385 1
a4385 1
+++ src/sys/kern/kern_sysctl.c	2 Mar 2003 01:08:57 -0000
d4499 1
a4499 1
+++ src/sys/kern/subr_userconf.c	2 Mar 2003 01:08:57 -0000
d4524 1
a4524 1
+++ src/sys/kern/sys_generic.c	2 Mar 2003 01:08:57 -0000
d4549 1
a4549 1
+++ src/sys/kern/vfs_syscalls.c	2 Mar 2003 01:08:57 -0000
d4565 1
a4565 1
+++ src/sys/lib/libkern/arch/i386/Makefile.inc	2 Mar 2003 01:08:57 -0000
d4567 1
a4567 1
+#	$MirBSD: obsd.kernel,v 1.13 2003/03/02 01:08:32 tg Exp $
d4584 1
a4584 1
+++ src/sys/lib/libkern/arch/i386/htonl.S	2 Mar 2003 01:08:57 -0000
d4653 1
a4653 1
+++ src/sys/lib/libkern/arch/i386/htons.S	2 Mar 2003 01:08:57 -0000
d4719 1
a4719 1
+++ src/sys/lib/libsa/exec_elf.c	2 Mar 2003 01:08:57 -0000
d4790 1
a4790 1
+++ src/sys/lib/libsa/loadfile.c	2 Mar 2003 01:08:57 -0000
d4843 1
a4843 1
+++ src/sys/lib/libz/Makefile	2 Mar 2003 01:08:57 -0000
d4859 1
a4859 1
+++ src/sys/miscfs/procfs/procfs_vnops.c	2 Mar 2003 01:08:58 -0000
d4875 1
a4875 1
+++ src/sys/miscfs/union/union_vnops.c	2 Mar 2003 01:09:01 -0000
d4891 1
a4891 1
+++ src/sys/net/if_bridge.c	2 Mar 2003 01:09:01 -0000
d4907 1
a4907 1
+++ src/sys/net/if_vlan.c	2 Mar 2003 01:09:01 -0000
d4920 4
a4923 4
retrieving revision 1.325
diff -u -r1.325 pf.c
--- src/sys/net/pf.c	2 Mar 2003 12:00:17 -0000	1.325
+++ src/sys/net/pf.c	4 Mar 2003 16:16:52 -0000
d4957 1
a4957 1
@@@@ -2400,6 +2403,8 @@@@
d4966 1
a4966 1
@@@@ -3244,6 +3249,8 @@@@
d4975 1
a4975 1
@@@@ -3412,6 +3419,8 @@@@
d4984 1
a4984 1
@@@@ -4424,8 +4433,9 @@@@
d5002 1
a5002 1
+++ src/sys/net/pfkeyv2.c	2 Mar 2003 01:09:01 -0000
d5018 1
a5018 1
+++ src/sys/netinet/ip_ah.c	2 Mar 2003 01:09:01 -0000
d5043 1
a5043 1
+++ src/sys/netinet/ip_esp.c	2 Mar 2003 01:09:01 -0000
d5068 1
a5068 1
+++ src/sys/netinet/ip_ipcomp.c	2 Mar 2003 01:09:01 -0000
d5093 1
a5093 1
+++ src/sys/netinet/ip_ipsp.c	2 Mar 2003 01:09:01 -0000
d5109 1
a5109 1
+++ src/sys/netinet/ip_output.c	2 Mar 2003 01:09:01 -0000
d5146 1
a5146 1
+++ src/sys/netinet/ipsec_output.c	2 Mar 2003 01:09:01 -0000
d5186 1
a5186 1
+++ src/sys/netinet/tcp_input.c	2 Mar 2003 01:09:01 -0000
d5202 1
a5202 1
+++ src/sys/netinet/tcp_output.c	2 Mar 2003 01:09:01 -0000
d5229 1
a5229 1
+++ src/sys/netinet/tcp_subr.c	2 Mar 2003 01:09:01 -0000
d5289 1
a5289 1
+++ src/sys/netinet/tcp_usrreq.c	2 Mar 2003 01:09:01 -0000
d5310 1
a5310 1
+++ src/sys/netinet/udp_usrreq.c	2 Mar 2003 01:09:01 -0000
d5325 1
a5325 1
+++ src/sys/netinet6/in6_ifattach.c	2 Mar 2003 01:09:01 -0000
d5356 1
a5356 1
+++ src/sys/netinet6/ip6_forward.c	2 Mar 2003 01:09:01 -0000
d5372 1
a5372 1
+++ src/sys/netinet6/ip6_output.c	2 Mar 2003 01:09:01 -0000
d5388 1
a5388 1
+++ src/sys/netinet6/raw_ip6.c	2 Mar 2003 01:09:01 -0000
d5405 1
a5405 1
+++ src/sys/nfs/nfsproto.h	2 Mar 2003 01:09:01 -0000
d5623 1
a5623 1
+++ src/sys/stand/boot/cmd.c	2 Mar 2003 01:09:01 -0000
d5673 1
a5673 1
+++ src/sys/sys/proc.h	2 Mar 2003 01:09:01 -0000
d5675 1
a5675 1
+/*	$MirBSD: obsd.kernel,v 1.13 2003/03/02 01:08:32 tg Exp $	*/
d5704 1
a5704 1
+++ src/sys/sys/resource.h	2 Mar 2003 01:09:01 -0000
d5722 1
a5722 1
+++ src/sys/sys/sysctl.h	2 Mar 2003 01:09:01 -0000
d5724 1
a5724 1
+/*	$MirBSD: obsd.kernel,v 1.13 2003/03/02 01:08:32 tg Exp $	*/
d5786 1
a5786 1
+++ src/sys/sys/systm.h	2 Mar 2003 01:09:01 -0000
d5801 1
a5801 1
+++ src/sys/sys/utsname.h	2 Mar 2003 01:09:01 -0000
d5803 1
a5803 1
+/*	$MirBSD: obsd.kernel,v 1.13 2003/03/02 01:08:32 tg Exp $	*/
d5832 1
a5832 1
+++ src/sys/ufs/ffs/ffs_softdep.c	2 Mar 2003 01:09:02 -0000
d5848 1
a5848 1
+++ src/sys/ufs/ffs/ffs_vfsops.c	2 Mar 2003 01:09:02 -0000
d5864 1
a5864 1
+++ src/sys/uvm/uvm_amap.c	2 Mar 2003 01:09:02 -0000
d5880 1
a5880 1
+++ src/sys/uvm/uvm_map.c	2 Mar 2003 01:09:02 -0000
d5918 1
a5918 1
+++ src/sys/uvm/uvm_meter.c	2 Mar 2003 01:09:02 -0000
d5954 1
a5954 1
+++ src/sys/uvm/uvm_pager.c	2 Mar 2003 01:09:02 -0000
d5970 1
a5970 1
+++ src/sys/uvm/uvm_swap.c	2 Mar 2003 01:09:02 -0000
d5984 2
a5985 2
--- /dev/null	Tue Mar  4 16:46:20 2003
+++ src/sys/arch/i386/include/loadfile_machdep.h	Sun Mar  2 01:09:02 2003
d6056 2
a6057 2
--- /dev/null	Tue Mar  4 16:46:20 2003
+++ src/sys/arch/i386/include/reloc.h	Sun Mar  2 01:09:02 2003
d6112 2
a6113 2
--- /dev/null	Tue Mar  4 16:46:20 2003
+++ src/sys/stand/boot/boot_loadfile.c	Sun Mar  2 01:09:02 2003
@


1.13
log
@pre-build Sn#3-RC2

1914 KiB
@
text
@d24 1
a24 1
against anoncvs@@anoncvs.comstyle.com:/cvs on Sat Mar  1 20:45:58 UTC 2003.
d27 1
d33 2
a34 2
--- src/sys/arch/i386/conf/DISKLESS	2002/12/10 23:37:03	1.48
+++ src/sys/arch/i386/conf/DISKLESS	2003/03/02 01:00:01
d66 2
a67 2
--- src/sys/arch/i386/conf/GENERIC	2003/02/10 22:32:33	1.329
+++ src/sys/arch/i386/conf/GENERIC	2003/03/02 01:00:01
d69 1
a69 1
+#	$MirBSD: obsd.kernel,v 1.12 2003/03/01 13:40:21 tg Exp $
d163 2
a164 2
--- src/sys/arch/i386/conf/Makefile.i386	2002/12/25 21:10:26	1.33
+++ src/sys/arch/i386/conf/Makefile.i386	2003/03/02 01:00:01
d166 1
a166 1
+#	$MirBSD: obsd.kernel,v 1.12 2003/03/01 13:40:21 tg Exp $
d207 2
a208 2
--- src/sys/arch/i386/conf/RAMDISK	2002/12/02 09:00:54	1.116
+++ src/sys/arch/i386/conf/RAMDISK	2003/03/02 01:00:01
d237 2
a238 2
--- src/sys/arch/i386/conf/RAMDISKB	2003/01/12 18:05:01	1.57
+++ src/sys/arch/i386/conf/RAMDISKB	2003/03/02 01:00:01
d261 2
a262 2
--- src/sys/arch/i386/conf/RAMDISKC	2002/09/03 16:43:13	1.29
+++ src/sys/arch/i386/conf/RAMDISKC	2003/03/02 01:00:01
d285 2
a286 2
--- src/sys/arch/i386/conf/RAMDISK_CD	2002/09/24 19:08:14	1.60
+++ src/sys/arch/i386/conf/RAMDISK_CD	2003/03/02 01:00:02
d309 2
a310 2
--- src/sys/arch/i386/i386/bios.c	2002/05/20 16:38:01	1.49
+++ src/sys/arch/i386/i386/bios.c	2003/03/02 01:00:02
d325 2
a326 2
--- src/sys/arch/i386/i386/db_magic.s	1996/05/04 14:33:00	1.1
+++ src/sys/arch/i386/i386/db_magic.s	2003/03/02 01:00:02
d392 2
a393 2
--- src/sys/arch/i386/i386/in_cksum.s	2001/07/04 08:57:47	1.5
+++ src/sys/arch/i386/i386/in_cksum.s	2003/03/02 01:00:02
d418 2
a419 2
--- src/sys/arch/i386/i386/locore.s	2003/01/09 22:27:09	1.68
+++ src/sys/arch/i386/i386/locore.s	2003/03/02 01:00:03
d617 2
a618 2
--- src/sys/arch/i386/i386/machdep.c	2003/01/16 19:39:23	1.220
+++ src/sys/arch/i386/i386/machdep.c	2003/03/02 01:00:06
d654 2
a655 2
--- src/sys/arch/i386/i386/microtime.s	2002/09/24 00:06:22	1.16
+++ src/sys/arch/i386/i386/microtime.s	2003/03/02 01:00:06
d712 2
a713 2
--- src/sys/arch/i386/i386/random.s	2001/07/04 08:57:47	1.3
+++ src/sys/arch/i386/i386/random.s	2003/03/02 01:00:06
d745 2
a746 2
--- src/sys/arch/i386/include/asm.h	2001/09/05 08:22:36	1.5
+++ src/sys/arch/i386/include/asm.h	2003/03/02 01:00:06
d808 2
a809 2
--- src/sys/arch/i386/include/biosvar.h	2002/03/14 01:26:33	1.40
+++ src/sys/arch/i386/include/biosvar.h	2003/03/02 01:00:06
d824 2
a825 2
--- src/sys/arch/i386/include/bus.h	2003/01/16 04:16:00	1.34
+++ src/sys/arch/i386/include/bus.h	2003/03/02 01:00:06
d879 2
a880 2
--- src/sys/arch/i386/include/cdefs.h	2001/08/18 02:35:06	1.7
+++ src/sys/arch/i386/include/cdefs.h	2003/03/02 01:00:06
d926 2
a927 2
--- src/sys/arch/i386/include/db_machdep.h	2002/03/14 01:26:33	1.7
+++ src/sys/arch/i386/include/db_machdep.h	2003/03/02 01:00:06
d942 2
a943 2
--- src/sys/arch/i386/include/exec.h	2001/01/22 14:51:04	1.8
+++ src/sys/arch/i386/include/exec.h	2003/03/02 01:00:06
d977 2
a978 2
--- src/sys/arch/i386/include/intr.h	2002/12/11 07:16:11	1.18
+++ src/sys/arch/i386/include/intr.h	2003/03/02 01:00:07
d994 2
a995 2
--- src/sys/arch/i386/include/param.h	2002/06/26 08:42:39	1.21
+++ src/sys/arch/i386/include/param.h	2003/03/02 01:00:07
d1017 2
a1018 2
--- src/sys/arch/i386/isa/clock.c	2002/07/06 19:14:20	1.28
+++ src/sys/arch/i386/isa/clock.c	2003/03/02 01:00:07
d1033 2
a1034 2
--- src/sys/arch/i386/isa/icu.s	2001/12/04 00:00:36	1.18
+++ src/sys/arch/i386/isa/icu.s	2003/03/02 01:00:07
d1065 2
a1066 2
--- src/sys/arch/i386/isa/npx.c	2002/03/14 01:26:33	1.25
+++ src/sys/arch/i386/isa/npx.c	2003/03/02 01:00:08
d1117 2
a1118 2
--- src/sys/arch/i386/isa/pccom.c	2002/03/14 01:26:33	1.42
+++ src/sys/arch/i386/isa/pccom.c	2003/03/02 01:00:08
d1142 2
a1143 2
--- src/sys/arch/i386/isa/vector.s	2001/12/06 21:09:13	1.15
+++ src/sys/arch/i386/isa/vector.s	2003/03/02 01:00:09
d1318 2
a1319 2
--- src/sys/arch/i386/pci/pchb.c	2003/01/08 01:46:07	1.38
+++ src/sys/arch/i386/pci/pchb.c	2003/03/02 01:00:09
d1334 2
a1335 2
--- src/sys/arch/i386/pci/pci_addr_fixup.c	2002/06/14 21:34:58	1.14
+++ src/sys/arch/i386/pci/pci_addr_fixup.c	2003/03/02 01:00:09
d1367 2
a1368 2
--- src/sys/arch/i386/pci/pcibios.c	2002/07/12 21:17:06	1.27
+++ src/sys/arch/i386/pci/pcibios.c	2003/03/02 01:00:09
d1387 2
a1388 2
--- src/sys/arch/i386/stand/Makefile.inc	2002/12/02 09:00:23	1.30
+++ src/sys/arch/i386/stand/Makefile.inc	2003/03/02 01:00:09
d1412 2
a1413 2
--- src/sys/arch/i386/stand/biosboot/Makefile	2000/06/08 00:56:07	1.20
+++ src/sys/arch/i386/stand/biosboot/Makefile	2003/03/02 01:00:09
d1428 2
a1429 2
--- src/sys/arch/i386/stand/biosboot/biosboot.S	2002/08/28 20:15:34	1.32
+++ src/sys/arch/i386/stand/biosboot/biosboot.S	2003/03/02 01:00:09
d1436 2
a1439 2
-#define	BLKCNT	12
-
d1780 2
a1781 2
--- src/sys/arch/i386/stand/boot/Makefile	2000/10/19 17:14:01	1.29
+++ src/sys/arch/i386/stand/boot/Makefile	2003/03/02 01:00:09
d1825 2
a1826 2
--- src/sys/arch/i386/stand/boot/conf.c	2002/06/21 21:02:57	1.19
+++ src/sys/arch/i386/stand/boot/conf.c	2003/03/02 01:00:09
d1872 2
a1873 2
--- src/sys/arch/i386/stand/boot/srt0.S	1998/05/14 20:59:12	1.10
+++ src/sys/arch/i386/stand/boot/srt0.S	2003/03/02 01:00:11
d1879 2
a1881 2
+#define BOOTSTACK 0xfffc
+
d1945 2
a1946 2
--- src/sys/arch/i386/stand/installboot/installboot.c	2002/05/03 13:59:08	1.37
+++ src/sys/arch/i386/stand/installboot/installboot.c	2003/03/02 01:00:11
d2081 2
a2082 2
--- src/sys/arch/i386/stand/libsa/Makefile	2002/06/20 20:22:58	1.39
+++ src/sys/arch/i386/stand/libsa/Makefile	2003/03/02 01:00:11
d2106 2
a2107 2
--- src/sys/arch/i386/stand/libsa/alloca.S	1998/02/24 22:06:43	1.2
+++ src/sys/arch/i386/stand/libsa/alloca.S	2003/03/02 01:00:11
d2119 2
a2120 2
--- src/sys/arch/i386/stand/libsa/apmprobe.c	2002/06/20 20:22:58	1.9
+++ src/sys/arch/i386/stand/libsa/apmprobe.c	2003/03/02 01:00:11
d2282 2
a2283 2
--- src/sys/arch/i386/stand/libsa/bioscons.c	2003/01/17 20:58:27	1.21
+++ src/sys/arch/i386/stand/libsa/bioscons.c	2003/03/02 01:00:11
d2298 2
a2299 2
--- src/sys/arch/i386/stand/libsa/biosdev.c	2002/03/14 03:15:54	1.54
+++ src/sys/arch/i386/stand/libsa/biosdev.c	2003/03/02 01:00:11
d2355 2
a2356 2
--- src/sys/arch/i386/stand/libsa/cmd_i386.c	2002/03/14 03:15:54	1.24
+++ src/sys/arch/i386/stand/libsa/cmd_i386.c	2003/03/02 01:00:12
d2432 2
a2433 2
--- src/sys/arch/i386/stand/libsa/debug_i386.S	1998/04/18 07:39:46	1.9
+++ src/sys/arch/i386/stand/libsa/debug_i386.S	2003/03/02 01:00:12
d2461 2
a2462 2
--- src/sys/arch/i386/stand/libsa/diskprobe.c	2002/03/14 01:26:34	1.18
+++ src/sys/arch/i386/stand/libsa/diskprobe.c	2003/03/02 01:00:12
d2512 2
a2513 2
--- src/sys/arch/i386/stand/libsa/exec_i386.c	2000/03/05 18:40:59	1.26
+++ src/sys/arch/i386/stand/libsa/exec_i386.c	2003/03/02 01:00:12
d2570 2
a2571 2
--- src/sys/arch/i386/stand/libsa/gidt.S	2001/09/17 13:10:09	1.24
+++ src/sys/arch/i386/stand/libsa/gidt.S	2003/03/02 01:00:12
d2934 2
a2935 2
--- src/sys/arch/i386/stand/libsa/libsa.h	2002/06/20 20:22:58	1.35
+++ src/sys/arch/i386/stand/libsa/libsa.h	2003/03/02 01:00:12
d2965 2
a2966 2
--- src/sys/arch/i386/stand/libsa/machdep.c	2001/08/18 15:34:17	1.31
+++ src/sys/arch/i386/stand/libsa/machdep.c	2003/03/02 01:00:12
d2981 2
a2982 2
--- src/sys/arch/i386/stand/libsa/smpprobe.c	1998/09/27 17:42:07	1.3
+++ src/sys/arch/i386/stand/libsa/smpprobe.c	2003/03/02 01:00:12
d3008 2
a3009 2
--- src/sys/arch/i386/stand/mbr/Makefile	2000/06/08 00:56:08	1.13
+++ src/sys/arch/i386/stand/mbr/Makefile	2003/03/02 01:00:12
d3024 2
a3025 2
--- src/sys/arch/i386/stand/mbr/mbr.S	2002/01/08 23:14:51	1.16
+++ src/sys/arch/i386/stand/mbr/mbr.S	2003/03/02 01:00:12
d3131 2
a3132 2
--- src/sys/conf/GENERIC	2003/02/28 21:29:08	1.93
+++ src/sys/conf/GENERIC	2003/03/02 01:00:12
d3134 1
a3134 1
+#	$MirBSD: obsd.kernel,v 1.12 2003/03/01 13:40:21 tg Exp $
d3186 2
a3187 2
--- src/sys/conf/newvers.sh	2003/02/13 19:51:30	1.50
+++ src/sys/conf/newvers.sh	2003/03/02 01:00:12
d3191 1
a3191 1
+#	$MirBSD: obsd.kernel,v 1.12 2003/03/01 13:40:21 tg Exp $
d3241 1
a3241 1
+ospl="$(echo '\$Date: 2003/03/01 13:40:21 $' | sed -e 's,^.*: ,,' -e 's,/,,g' -e 's, .*$,,')"
d3254 1
a3254 1
+    "    @@(#)MirBSD from ${ost} ${osr}-beta (${id}) #${v}: ${t}\n	@@(#)\$MirBSD: obsd.kernel,v 1.12 2003/03/01 13:40:21 tg Exp $\n";
d3258 1
a3258 1
+    "MirBSD ${osr}-${ospl} (${id}) #${v}: ${t}\n    ${u}@@${h}:${d}\n    patchlevel:\$MirBSD: obsd.kernel,v 1.12 2003/03/01 13:40:21 tg Exp $\n";
d3267 3
a3269 3
--- src/sys/ddb/db_trap.c	2001/11/06 19:53:18	1.10
+++ src/sys/ddb/db_trap.c	2003/03/02 01:00:13
@@@@ -48,13 +48,17 @@@@
d3282 1
a3283 1
+
a3285 1
 
d3307 2
a3308 2
--- src/sys/dev/ccd.c	2002/11/10 21:23:09	1.50
+++ src/sys/dev/ccd.c	2003/03/02 01:00:13
d3323 2
a3324 2
--- src/sys/dev/systrace.c	2003/02/20 22:03:31	1.28
+++ src/sys/dev/systrace.c	2003/03/02 01:00:15
d3339 2
a3340 2
--- src/sys/dev/ic/dc.c	2003/02/25 17:29:09	1.55
+++ src/sys/dev/ic/dc.c	2003/03/02 01:00:16
d3379 2
a3380 2
--- src/sys/dev/ic/if_wi.c	2003/02/13 20:45:09	1.93
+++ src/sys/dev/ic/if_wi.c	2003/03/02 01:00:18
d3395 2
a3396 2
--- src/sys/dev/ic/if_wi_hostap.c	2003/02/15 17:49:39	1.24
+++ src/sys/dev/ic/if_wi_hostap.c	2003/03/02 01:00:18
d3432 2
a3433 2
--- src/sys/dev/ic/ne2000.c	2002/03/14 01:26:55	1.12
+++ src/sys/dev/ic/ne2000.c	2003/03/02 01:00:20
d3448 2
a3449 2
--- src/sys/dev/ic/rtl80x9.c	2001/03/12 05:36:58	1.6
+++ src/sys/dev/ic/rtl80x9.c	2003/03/02 01:00:20
d3464 2
a3465 2
--- src/sys/dev/ic/rtl81x9.c	2003/02/11 19:20:27	1.20
+++ src/sys/dev/ic/rtl81x9.c	2003/03/02 01:00:20
d3483 2
a3484 2
--- src/sys/dev/isa/if_we.c	2002/03/14 01:26:56	1.10
+++ src/sys/dev/isa/if_we.c	2003/03/02 01:00:21
d3500 2
a3501 2
--- src/sys/dev/isa/spkr.c	2002/03/14 01:26:56	1.7
+++ src/sys/dev/isa/spkr.c	2003/03/02 01:00:21
d3503 1
a3503 1
+/*	$MirBSD: obsd.kernel,v 1.12 2003/03/01 13:40:21 tg Exp $	*/
d3959 2
a3960 2
--- src/sys/dev/microcode/aic7xxx/Makefile	2002/06/30 18:25:58	1.5
+++ src/sys/dev/microcode/aic7xxx/Makefile	2003/03/02 01:00:21
d3975 2
a3976 2
--- src/sys/dev/mii/bmtphy.c	2002/03/14 01:26:57	1.5
+++ src/sys/dev/mii/bmtphy.c	2003/03/02 01:00:21
d4002 2
a4003 2
--- src/sys/dev/pci/if_bge.c	2003/02/11 19:20:27	1.19
+++ src/sys/dev/pci/if_bge.c	2003/03/02 01:00:23
d4046 2
a4047 2
--- src/sys/dev/pci/if_sf.c	2003/01/15 06:31:24	1.19
+++ src/sys/dev/pci/if_sf.c	2003/03/02 01:00:23
d4062 2
a4063 2
--- src/sys/dev/pci/if_ste.c	2003/01/15 06:31:24	1.18
+++ src/sys/dev/pci/if_ste.c	2003/03/02 01:00:25
d4078 2
a4079 2
--- src/sys/dev/pci/pciide.c	2003/02/24 20:54:15	1.116
+++ src/sys/dev/pci/pciide.c	2003/03/02 01:00:27
d4103 2
a4104 2
--- src/sys/dev/wscons/wsdisplay.c	2003/02/23 19:08:11	1.50
+++ src/sys/dev/wscons/wsdisplay.c	2003/03/02 01:00:28
d4119 2
a4120 2
--- src/sys/kern/kern_exec.c	2002/12/11 00:08:08	1.75
+++ src/sys/kern/kern_exec.c	2003/03/02 01:00:28
d4122 1
a4122 1
+/*	$MirBSD: obsd.kernel,v 1.12 2003/03/01 13:40:21 tg Exp $	*/
d4141 2
a4142 2
--- src/sys/kern/kern_fork.c	2002/10/31 01:33:27	1.59
+++ src/sys/kern/kern_fork.c	2003/03/02 01:00:30
d4144 1
a4144 1
+/*	$MirBSD: obsd.kernel,v 1.12 2003/03/01 13:40:21 tg Exp $	*/
d4209 2
a4210 2
--- src/sys/kern/kern_sig.c	2002/10/01 17:33:39	1.61
+++ src/sys/kern/kern_sig.c	2003/03/02 01:00:30
d4305 2
a4306 2
--- src/sys/kern/kern_synch.c	2002/10/15 20:17:22	1.46
+++ src/sys/kern/kern_synch.c	2003/03/02 01:00:31
d4333 2
a4334 2
--- src/sys/kern/kern_sysctl.c	2003/01/21 16:59:23	1.79
+++ src/sys/kern/kern_sysctl.c	2003/03/02 01:00:32
d4447 2
a4448 2
--- src/sys/kern/subr_userconf.c	2002/07/29 23:18:57	1.31
+++ src/sys/kern/subr_userconf.c	2003/03/02 01:00:32
d4472 2
a4473 2
--- src/sys/kern/sys_generic.c	2002/08/12 14:32:44	1.41
+++ src/sys/kern/sys_generic.c	2003/03/02 01:00:32
d4497 2
a4498 2
--- src/sys/kern/vfs_syscalls.c	2002/10/02 21:56:30	1.98
+++ src/sys/kern/vfs_syscalls.c	2003/03/02 01:00:33
d4513 2
a4514 2
--- src/sys/lib/libkern/arch/i386/Makefile.inc	2000/12/18 18:40:46	1.7
+++ src/sys/lib/libkern/arch/i386/Makefile.inc	2003/03/02 01:00:33
d4516 1
a4516 1
+#	$MirBSD: obsd.kernel,v 1.12 2003/03/01 13:40:21 tg Exp $
d4532 2
a4533 2
--- src/sys/lib/libkern/arch/i386/htonl.S	1996/09/27 06:47:45	1.2
+++ src/sys/lib/libkern/arch/i386/htonl.S	2003/03/02 01:00:33
d4601 2
a4602 2
--- src/sys/lib/libkern/arch/i386/htons.S	1996/09/27 06:47:46	1.2
+++ src/sys/lib/libkern/arch/i386/htons.S	2003/03/02 01:00:33
d4667 2
a4668 2
--- src/sys/lib/libsa/exec_elf.c	2002/07/09 01:45:47	1.6
+++ src/sys/lib/libsa/exec_elf.c	2003/03/02 01:00:33
d4738 2
a4739 2
--- src/sys/lib/libsa/loadfile.c	2002/11/11 00:04:30	1.3
+++ src/sys/lib/libsa/loadfile.c	2003/03/02 01:00:35
d4791 2
a4792 2
--- src/sys/lib/libz/Makefile	1998/09/08 04:07:46	1.3
+++ src/sys/lib/libz/Makefile	2003/03/02 01:00:35
d4807 2
a4808 2
--- src/sys/miscfs/procfs/procfs_vnops.c	2003/01/31 17:37:50	1.27
+++ src/sys/miscfs/procfs/procfs_vnops.c	2003/03/02 01:00:35
d4823 2
a4824 2
--- src/sys/miscfs/union/union_vnops.c	2002/06/08 18:43:34	1.19
+++ src/sys/miscfs/union/union_vnops.c	2003/03/02 01:00:36
d4839 2
a4840 2
--- src/sys/net/if_bridge.c	2003/02/21 21:49:37	1.112
+++ src/sys/net/if_bridge.c	2003/03/02 01:00:37
d4855 2
a4856 2
--- src/sys/net/if_vlan.c	2003/02/01 00:14:40	1.34
+++ src/sys/net/if_vlan.c	2003/03/02 01:00:37
d4869 4
a4872 4
retrieving revision 1.324
diff -u -r1.324 pf.c
--- src/sys/net/pf.c	2003/02/27 13:35:57	1.324
+++ src/sys/net/pf.c	2003/03/02 01:00:40
d4933 1
a4933 1
@@@@ -4421,8 +4430,9 @@@@
d4950 2
a4951 2
--- src/sys/net/pfkeyv2.c	2003/02/16 21:30:13	1.87
+++ src/sys/net/pfkeyv2.c	2003/03/02 01:00:41
d4966 2
a4967 2
--- src/sys/netinet/ip_ah.c	2003/02/28 21:42:56	1.72
+++ src/sys/netinet/ip_ah.c	2003/03/02 01:00:41
d4991 2
a4992 2
--- src/sys/netinet/ip_esp.c	2003/02/28 21:42:56	1.80
+++ src/sys/netinet/ip_esp.c	2003/03/02 01:00:41
d5016 2
a5017 2
--- src/sys/netinet/ip_ipcomp.c	2003/02/18 18:47:40	1.11
+++ src/sys/netinet/ip_ipcomp.c	2003/03/02 01:00:42
d5041 2
a5042 2
--- src/sys/netinet/ip_ipsp.c	2002/11/19 18:34:41	1.150
+++ src/sys/netinet/ip_ipsp.c	2003/03/02 01:00:42
d5057 2
a5058 2
--- src/sys/netinet/ip_output.c	2003/01/31 17:27:03	1.151
+++ src/sys/netinet/ip_output.c	2003/03/02 01:00:44
d5094 2
a5095 2
--- src/sys/netinet/ipsec_output.c	2003/02/19 19:15:13	1.26
+++ src/sys/netinet/ipsec_output.c	2003/03/02 01:00:44
d5134 2
a5135 2
--- src/sys/netinet/tcp_input.c	2003/02/14 17:54:46	1.125
+++ src/sys/netinet/tcp_input.c	2003/03/02 01:00:46
d5150 2
a5151 2
--- src/sys/netinet/tcp_output.c	2003/01/25 15:27:29	1.54
+++ src/sys/netinet/tcp_output.c	2003/03/02 01:00:47
d5177 2
a5178 2
--- src/sys/netinet/tcp_subr.c	2002/08/28 15:43:03	1.65
+++ src/sys/netinet/tcp_subr.c	2003/03/02 01:00:47
d5237 2
a5238 2
--- src/sys/netinet/tcp_usrreq.c	2003/02/12 14:41:08	1.68
+++ src/sys/netinet/tcp_usrreq.c	2003/03/02 01:00:49
d5258 2
a5259 2
--- src/sys/netinet/udp_usrreq.c	2002/08/28 15:43:03	1.86
+++ src/sys/netinet/udp_usrreq.c	2003/03/02 01:00:49
d5273 2
a5274 2
--- src/sys/netinet6/in6_ifattach.c	2002/09/12 01:11:54	1.32
+++ src/sys/netinet6/in6_ifattach.c	2003/03/02 01:00:50
d5304 2
a5305 2
--- src/sys/netinet6/ip6_forward.c	2002/06/09 14:38:39	1.24
+++ src/sys/netinet6/ip6_forward.c	2003/03/02 01:00:50
d5320 2
a5321 2
--- src/sys/netinet6/ip6_output.c	2002/10/31 18:02:27	1.73
+++ src/sys/netinet6/ip6_output.c	2003/03/02 01:00:51
d5336 2
a5337 2
--- src/sys/netinet6/raw_ip6.c	2002/09/11 03:27:30	1.17
+++ src/sys/netinet6/raw_ip6.c	2003/03/02 01:00:52
d5353 2
a5354 2
--- src/sys/nfs/nfsproto.h	2002/01/28 22:36:19	1.4
+++ src/sys/nfs/nfsproto.h	2003/03/02 01:00:52
d5571 2
a5572 2
--- src/sys/stand/boot/cmd.c	2002/07/14 09:19:17	1.48
+++ src/sys/stand/boot/cmd.c	2003/03/02 01:00:52
d5621 2
a5622 2
--- src/sys/sys/proc.h	2002/07/20 19:24:57	1.62
+++ src/sys/sys/proc.h	2003/03/02 01:00:52
d5624 1
a5624 1
+/*	$MirBSD: obsd.kernel,v 1.12 2003/03/01 13:40:21 tg Exp $	*/
d5652 2
a5653 2
--- src/sys/sys/resource.h	2002/03/14 01:27:14	1.4
+++ src/sys/sys/resource.h	2003/03/02 01:00:52
d5670 2
a5671 2
--- src/sys/sys/sysctl.h	2003/01/21 16:59:23	1.62
+++ src/sys/sys/sysctl.h	2003/03/02 01:00:54
d5673 1
a5673 1
+/*	$MirBSD: obsd.kernel,v 1.12 2003/03/01 13:40:21 tg Exp $	*/
d5711 1
a5711 1
@@@@ -209,8 +208,8 @@@@
d5715 1
a5717 1
-	{ "gap", 0 }, \
a5719 1
 	{ "sominconn", CTLTYPE_INT }, \
d5734 2
a5735 2
--- src/sys/sys/systm.h	2003/01/21 16:59:23	1.54
+++ src/sys/sys/systm.h	2003/03/02 01:00:54
d5749 2
a5750 2
--- src/sys/sys/utsname.h	2002/03/14 01:27:14	1.4
+++ src/sys/sys/utsname.h	2003/03/02 01:00:54
d5752 1
a5752 1
+/*	$MirBSD: obsd.kernel,v 1.12 2003/03/01 13:40:21 tg Exp $	*/
d5780 2
a5781 2
--- src/sys/ufs/ffs/ffs_softdep.c	2002/10/12 01:09:45	1.42
+++ src/sys/ufs/ffs/ffs_softdep.c	2003/03/02 01:00:58
d5796 2
a5797 2
--- src/sys/ufs/ffs/ffs_vfsops.c	2002/08/01 16:41:33	1.54
+++ src/sys/ufs/ffs/ffs_vfsops.c	2003/03/02 01:00:58
d5812 2
a5813 2
--- src/sys/uvm/uvm_amap.c	2002/05/09 14:14:18	1.27
+++ src/sys/uvm/uvm_amap.c	2003/03/02 01:00:59
d5828 2
a5829 2
--- src/sys/uvm/uvm_map.c	2002/12/09 02:35:21	1.56
+++ src/sys/uvm/uvm_map.c	2003/03/02 01:01:01
d5866 2
a5867 2
--- src/sys/uvm/uvm_meter.c	2002/03/14 01:27:18	1.17
+++ src/sys/uvm/uvm_meter.c	2003/03/02 01:01:01
d5902 2
a5903 2
--- src/sys/uvm/uvm_pager.c	2002/10/29 18:30:21	1.33
+++ src/sys/uvm/uvm_pager.c	2003/03/02 01:01:01
d5918 2
a5919 2
--- src/sys/uvm/uvm_swap.c	2002/10/12 01:09:45	1.55
+++ src/sys/uvm/uvm_swap.c	2003/03/02 01:01:02
d5933 2
a5934 2
--- /dev/null	Sun Mar  2 00:56:39 2003
+++ src/sys/arch/i386/include/loadfile_machdep.h	Sat Mar  1 13:40:48 2003
d6005 2
a6006 2
--- /dev/null	Sun Mar  2 00:56:39 2003
+++ src/sys/arch/i386/include/reloc.h	Sat Mar  1 13:40:48 2003
d6061 2
a6062 2
--- /dev/null	Sun Mar  2 00:56:39 2003
+++ src/sys/stand/boot/boot_loadfile.c	Sat Mar  1 13:40:48 2003
@


1.12
log
@document all changes
:)
@
text
@d9 1
a9 1
    placed in its entirety (not easily distinguishable in the diff).
d22 1
a22 1
This diff, ID $MirBSD: regen-obsdp.sh,v 1.13 2003/02/28 22:52:54 tg Exp $
d24 1
a24 1
against CTM on Sat Mar  1 13:38:10 UTC 2003.
d26 1
a26 2
### GENERATOR: @@(#)_MirBSD: regen-obsdp.sh,v 1.13 2003/02/28 22:52:54 tg Exp $
### CTM OpenBSD-cvs 3075
d32 2
a33 2
--- src/sys/arch/i386/conf/DISKLESS	10 Dec 2002 23:36:41 -0000	1.48
+++ src/sys/arch/i386/conf/DISKLESS	1 Mar 2003 13:37:53 -0000
d65 2
a66 2
--- src/sys/arch/i386/conf/GENERIC	10 Feb 2003 22:32:11 -0000	1.329
+++ src/sys/arch/i386/conf/GENERIC	1 Mar 2003 13:37:53 -0000
d68 1
a68 1
+#	$MirBSD: obsd.kernel,v 1.11 2003/03/01 13:16:05 tg Exp $
d162 2
a163 2
--- src/sys/arch/i386/conf/Makefile.i386	25 Dec 2002 21:10:04 -0000	1.33
+++ src/sys/arch/i386/conf/Makefile.i386	1 Mar 2003 13:37:53 -0000
d165 1
a165 1
+#	$MirBSD: obsd.kernel,v 1.11 2003/03/01 13:16:05 tg Exp $
d206 2
a207 2
--- src/sys/arch/i386/conf/RAMDISK	2 Dec 2002 09:00:32 -0000	1.116
+++ src/sys/arch/i386/conf/RAMDISK	1 Mar 2003 13:37:53 -0000
d236 2
a237 2
--- src/sys/arch/i386/conf/RAMDISKB	12 Jan 2003 18:04:39 -0000	1.57
+++ src/sys/arch/i386/conf/RAMDISKB	1 Mar 2003 13:37:53 -0000
d260 2
a261 2
--- src/sys/arch/i386/conf/RAMDISKC	3 Sep 2002 16:42:51 -0000	1.29
+++ src/sys/arch/i386/conf/RAMDISKC	1 Mar 2003 13:37:53 -0000
d284 2
a285 2
--- src/sys/arch/i386/conf/RAMDISK_CD	24 Sep 2002 19:07:52 -0000	1.60
+++ src/sys/arch/i386/conf/RAMDISK_CD	1 Mar 2003 13:37:53 -0000
d308 2
a309 2
--- src/sys/arch/i386/i386/bios.c	20 May 2002 16:37:39 -0000	1.49
+++ src/sys/arch/i386/i386/bios.c	1 Mar 2003 13:37:53 -0000
d324 2
a325 2
--- src/sys/arch/i386/i386/db_magic.s	4 May 1996 14:32:40 -0000	1.1
+++ src/sys/arch/i386/i386/db_magic.s	1 Mar 2003 13:37:53 -0000
d391 2
a392 2
--- src/sys/arch/i386/i386/in_cksum.s	4 Jul 2001 08:57:25 -0000	1.5
+++ src/sys/arch/i386/i386/in_cksum.s	1 Mar 2003 13:37:53 -0000
d417 2
a418 2
--- src/sys/arch/i386/i386/locore.s	9 Jan 2003 22:26:47 -0000	1.68
+++ src/sys/arch/i386/i386/locore.s	1 Mar 2003 13:37:53 -0000
d616 2
a617 2
--- src/sys/arch/i386/i386/machdep.c	16 Jan 2003 19:39:01 -0000	1.220
+++ src/sys/arch/i386/i386/machdep.c	1 Mar 2003 13:37:53 -0000
d653 2
a654 2
--- src/sys/arch/i386/i386/microtime.s	24 Sep 2002 00:06:00 -0000	1.16
+++ src/sys/arch/i386/i386/microtime.s	1 Mar 2003 13:37:53 -0000
d711 2
a712 2
--- src/sys/arch/i386/i386/random.s	4 Jul 2001 08:57:25 -0000	1.3
+++ src/sys/arch/i386/i386/random.s	1 Mar 2003 13:37:53 -0000
d744 2
a745 2
--- src/sys/arch/i386/include/asm.h	5 Sep 2001 08:22:14 -0000	1.5
+++ src/sys/arch/i386/include/asm.h	1 Mar 2003 13:37:53 -0000
d807 2
a808 2
--- src/sys/arch/i386/include/biosvar.h	14 Mar 2002 01:26:11 -0000	1.40
+++ src/sys/arch/i386/include/biosvar.h	1 Mar 2003 13:37:53 -0000
d823 2
a824 2
--- src/sys/arch/i386/include/bus.h	16 Jan 2003 04:15:38 -0000	1.34
+++ src/sys/arch/i386/include/bus.h	1 Mar 2003 13:37:53 -0000
d878 2
a879 2
--- src/sys/arch/i386/include/cdefs.h	18 Aug 2001 02:34:44 -0000	1.7
+++ src/sys/arch/i386/include/cdefs.h	1 Mar 2003 13:37:53 -0000
d925 2
a926 2
--- src/sys/arch/i386/include/db_machdep.h	14 Mar 2002 01:26:11 -0000	1.7
+++ src/sys/arch/i386/include/db_machdep.h	1 Mar 2003 13:37:53 -0000
d941 2
a942 2
--- src/sys/arch/i386/include/exec.h	22 Jan 2001 14:50:42 -0000	1.8
+++ src/sys/arch/i386/include/exec.h	1 Mar 2003 13:37:53 -0000
d976 2
a977 2
--- src/sys/arch/i386/include/intr.h	11 Dec 2002 07:15:49 -0000	1.18
+++ src/sys/arch/i386/include/intr.h	1 Mar 2003 13:37:53 -0000
d993 2
a994 2
--- src/sys/arch/i386/include/param.h	26 Jun 2002 08:42:17 -0000	1.21
+++ src/sys/arch/i386/include/param.h	1 Mar 2003 13:37:53 -0000
d1016 2
a1017 2
--- src/sys/arch/i386/isa/clock.c	6 Jul 2002 19:13:58 -0000	1.28
+++ src/sys/arch/i386/isa/clock.c	1 Mar 2003 13:37:53 -0000
d1032 2
a1033 2
--- src/sys/arch/i386/isa/icu.s	4 Dec 2001 00:00:14 -0000	1.18
+++ src/sys/arch/i386/isa/icu.s	1 Mar 2003 13:37:53 -0000
d1064 2
a1065 2
--- src/sys/arch/i386/isa/npx.c	14 Mar 2002 01:26:11 -0000	1.25
+++ src/sys/arch/i386/isa/npx.c	1 Mar 2003 13:37:54 -0000
d1116 2
a1117 2
--- src/sys/arch/i386/isa/pccom.c	14 Mar 2002 01:26:11 -0000	1.42
+++ src/sys/arch/i386/isa/pccom.c	1 Mar 2003 13:37:54 -0000
d1141 2
a1142 2
--- src/sys/arch/i386/isa/vector.s	6 Dec 2001 21:08:51 -0000	1.15
+++ src/sys/arch/i386/isa/vector.s	1 Mar 2003 13:37:54 -0000
d1317 2
a1318 2
--- src/sys/arch/i386/pci/pchb.c	8 Jan 2003 01:45:45 -0000	1.38
+++ src/sys/arch/i386/pci/pchb.c	1 Mar 2003 13:37:54 -0000
d1333 2
a1334 2
--- src/sys/arch/i386/pci/pci_addr_fixup.c	14 Jun 2002 21:34:36 -0000	1.14
+++ src/sys/arch/i386/pci/pci_addr_fixup.c	1 Mar 2003 13:37:54 -0000
d1366 2
a1367 2
--- src/sys/arch/i386/pci/pcibios.c	12 Jul 2002 21:16:44 -0000	1.27
+++ src/sys/arch/i386/pci/pcibios.c	1 Mar 2003 13:37:54 -0000
d1386 2
a1387 2
--- src/sys/arch/i386/stand/Makefile.inc	2 Dec 2002 09:00:01 -0000	1.30
+++ src/sys/arch/i386/stand/Makefile.inc	1 Mar 2003 13:37:54 -0000
d1411 2
a1412 2
--- src/sys/arch/i386/stand/biosboot/Makefile	8 Jun 2000 00:55:45 -0000	1.20
+++ src/sys/arch/i386/stand/biosboot/Makefile	1 Mar 2003 13:37:54 -0000
d1427 2
a1428 2
--- src/sys/arch/i386/stand/biosboot/biosboot.S	28 Aug 2002 20:15:12 -0000	1.32
+++ src/sys/arch/i386/stand/biosboot/biosboot.S	1 Mar 2003 13:37:54 -0000
a1434 2
-
-#define	BLKCNT	12
d1437 2
d1779 2
a1780 2
--- src/sys/arch/i386/stand/boot/Makefile	19 Oct 2000 17:13:39 -0000	1.29
+++ src/sys/arch/i386/stand/boot/Makefile	1 Mar 2003 13:37:54 -0000
d1824 2
a1825 2
--- src/sys/arch/i386/stand/boot/conf.c	21 Jun 2002 21:02:35 -0000	1.19
+++ src/sys/arch/i386/stand/boot/conf.c	1 Mar 2003 13:37:54 -0000
d1871 2
a1872 2
--- src/sys/arch/i386/stand/boot/srt0.S	14 May 1998 20:58:51 -0000	1.10
+++ src/sys/arch/i386/stand/boot/srt0.S	1 Mar 2003 13:37:54 -0000
d1878 2
a1880 2
+#define BOOTSTACK 0xfffc
 
d1944 2
a1945 2
--- src/sys/arch/i386/stand/installboot/installboot.c	3 May 2002 13:58:46 -0000	1.37
+++ src/sys/arch/i386/stand/installboot/installboot.c	1 Mar 2003 13:37:54 -0000
d2080 2
a2081 2
--- src/sys/arch/i386/stand/libsa/Makefile	20 Jun 2002 20:22:36 -0000	1.39
+++ src/sys/arch/i386/stand/libsa/Makefile	1 Mar 2003 13:37:54 -0000
d2105 2
a2106 2
--- src/sys/arch/i386/stand/libsa/alloca.S	24 Feb 1998 22:06:22 -0000	1.2
+++ src/sys/arch/i386/stand/libsa/alloca.S	1 Mar 2003 13:37:54 -0000
d2118 2
a2119 2
--- src/sys/arch/i386/stand/libsa/apmprobe.c	20 Jun 2002 20:22:36 -0000	1.9
+++ src/sys/arch/i386/stand/libsa/apmprobe.c	1 Mar 2003 13:37:54 -0000
d2281 2
a2282 2
--- src/sys/arch/i386/stand/libsa/bioscons.c	17 Jan 2003 20:58:05 -0000	1.21
+++ src/sys/arch/i386/stand/libsa/bioscons.c	1 Mar 2003 13:37:54 -0000
d2297 2
a2298 2
--- src/sys/arch/i386/stand/libsa/biosdev.c	14 Mar 2002 03:15:32 -0000	1.54
+++ src/sys/arch/i386/stand/libsa/biosdev.c	1 Mar 2003 13:37:54 -0000
d2354 2
a2355 2
--- src/sys/arch/i386/stand/libsa/cmd_i386.c	14 Mar 2002 03:15:32 -0000	1.24
+++ src/sys/arch/i386/stand/libsa/cmd_i386.c	1 Mar 2003 13:37:54 -0000
d2431 2
a2432 2
--- src/sys/arch/i386/stand/libsa/debug_i386.S	18 Apr 1998 07:39:25 -0000	1.9
+++ src/sys/arch/i386/stand/libsa/debug_i386.S	1 Mar 2003 13:37:54 -0000
d2460 2
a2461 2
--- src/sys/arch/i386/stand/libsa/diskprobe.c	14 Mar 2002 01:26:12 -0000	1.18
+++ src/sys/arch/i386/stand/libsa/diskprobe.c	1 Mar 2003 13:37:54 -0000
d2511 2
a2512 2
--- src/sys/arch/i386/stand/libsa/exec_i386.c	5 Mar 2000 18:40:37 -0000	1.26
+++ src/sys/arch/i386/stand/libsa/exec_i386.c	1 Mar 2003 13:37:54 -0000
d2569 2
a2570 2
--- src/sys/arch/i386/stand/libsa/gidt.S	17 Sep 2001 13:09:47 -0000	1.24
+++ src/sys/arch/i386/stand/libsa/gidt.S	1 Mar 2003 13:37:54 -0000
d2933 2
a2934 2
--- src/sys/arch/i386/stand/libsa/libsa.h	20 Jun 2002 20:22:36 -0000	1.35
+++ src/sys/arch/i386/stand/libsa/libsa.h	1 Mar 2003 13:37:54 -0000
d2964 2
a2965 2
--- src/sys/arch/i386/stand/libsa/machdep.c	18 Aug 2001 15:33:55 -0000	1.31
+++ src/sys/arch/i386/stand/libsa/machdep.c	1 Mar 2003 13:37:54 -0000
d2980 2
a2981 2
--- src/sys/arch/i386/stand/libsa/smpprobe.c	27 Sep 1998 17:41:46 -0000	1.3
+++ src/sys/arch/i386/stand/libsa/smpprobe.c	1 Mar 2003 13:37:54 -0000
d3007 2
a3008 2
--- src/sys/arch/i386/stand/mbr/Makefile	8 Jun 2000 00:55:46 -0000	1.13
+++ src/sys/arch/i386/stand/mbr/Makefile	1 Mar 2003 13:37:54 -0000
d3023 2
a3024 2
--- src/sys/arch/i386/stand/mbr/mbr.S	8 Jan 2002 23:14:29 -0000	1.16
+++ src/sys/arch/i386/stand/mbr/mbr.S	1 Mar 2003 13:37:54 -0000
d3130 2
a3131 2
--- src/sys/conf/GENERIC	28 Feb 2003 21:28:46 -0000	1.93
+++ src/sys/conf/GENERIC	1 Mar 2003 13:37:54 -0000
d3133 1
a3133 1
+#	$MirBSD: obsd.kernel,v 1.11 2003/03/01 13:16:05 tg Exp $
d3185 2
a3186 2
--- src/sys/conf/newvers.sh	13 Feb 2003 19:51:08 -0000	1.50
+++ src/sys/conf/newvers.sh	1 Mar 2003 13:37:54 -0000
d3190 1
a3190 1
+#	$MirBSD: obsd.kernel,v 1.11 2003/03/01 13:16:05 tg Exp $
d3240 1
a3240 1
+ospl="$(echo '\$Date: 2003/03/01 13:16:05 $' | sed -e 's,^.*: ,,' -e 's,/,,g' -e 's, .*$,,')"
d3253 1
a3253 1
+    "    @@(#)MirBSD from ${ost} ${osr}-beta (${id}) #${v}: ${t}\n	@@(#)\$MirBSD: obsd.kernel,v 1.11 2003/03/01 13:16:05 tg Exp $\n";
d3257 1
a3257 1
+    "MirBSD ${osr}-${ospl} (${id}) #${v}: ${t}\n    ${u}@@${h}:${d}\n    patchlevel:\$MirBSD: obsd.kernel,v 1.11 2003/03/01 13:16:05 tg Exp $\n";
d3266 3
a3268 3
--- src/sys/ddb/db_trap.c	6 Nov 2001 19:52:56 -0000	1.10
+++ src/sys/ddb/db_trap.c	28 Feb 2003 20:26:13 -0000
@@@@ -48,12 +48,16 @@@@
d3281 1
a3282 1
 
d3285 1
d3307 2
a3308 2
--- src/sys/dev/ccd.c	10 Nov 2002 21:22:47 -0000	1.50
+++ src/sys/dev/ccd.c	1 Mar 2003 13:37:55 -0000
d3323 2
a3324 2
--- src/sys/dev/systrace.c	20 Feb 2003 22:03:09 -0000	1.28
+++ src/sys/dev/systrace.c	1 Mar 2003 13:37:55 -0000
d3339 2
a3340 2
--- src/sys/dev/ic/dc.c	25 Feb 2003 17:28:47 -0000	1.55
+++ src/sys/dev/ic/dc.c	1 Mar 2003 13:37:55 -0000
d3379 2
a3380 2
--- src/sys/dev/ic/if_wi.c	13 Feb 2003 20:44:47 -0000	1.93
+++ src/sys/dev/ic/if_wi.c	1 Mar 2003 13:37:55 -0000
d3395 2
a3396 2
--- src/sys/dev/ic/if_wi_hostap.c	15 Feb 2003 17:49:17 -0000	1.24
+++ src/sys/dev/ic/if_wi_hostap.c	1 Mar 2003 13:37:55 -0000
d3432 2
a3433 2
--- src/sys/dev/ic/ne2000.c	14 Mar 2002 01:26:33 -0000	1.12
+++ src/sys/dev/ic/ne2000.c	1 Mar 2003 13:37:55 -0000
d3448 2
a3449 2
--- src/sys/dev/ic/rtl80x9.c	12 Mar 2001 05:36:36 -0000	1.6
+++ src/sys/dev/ic/rtl80x9.c	1 Mar 2003 13:37:55 -0000
d3464 2
a3465 2
--- src/sys/dev/ic/rtl81x9.c	11 Feb 2003 19:20:05 -0000	1.20
+++ src/sys/dev/ic/rtl81x9.c	1 Mar 2003 13:37:55 -0000
d3483 2
a3484 2
--- src/sys/dev/isa/if_we.c	14 Mar 2002 01:26:34 -0000	1.10
+++ src/sys/dev/isa/if_we.c	1 Mar 2003 13:37:55 -0000
d3500 2
a3501 2
--- src/sys/dev/isa/spkr.c	14 Mar 2002 01:26:34 -0000	1.7
+++ src/sys/dev/isa/spkr.c	1 Mar 2003 13:37:55 -0000
d3503 1
a3503 1
+/*	$MirBSD: obsd.kernel,v 1.11 2003/03/01 13:16:05 tg Exp $	*/
d3959 2
a3960 2
--- src/sys/dev/microcode/aic7xxx/Makefile	30 Jun 2002 18:25:36 -0000	1.5
+++ src/sys/dev/microcode/aic7xxx/Makefile	1 Mar 2003 13:37:55 -0000
d3975 2
a3976 2
--- src/sys/dev/mii/bmtphy.c	14 Mar 2002 01:26:35 -0000	1.5
+++ src/sys/dev/mii/bmtphy.c	1 Mar 2003 13:37:55 -0000
d4002 2
a4003 2
--- src/sys/dev/pci/if_bge.c	11 Feb 2003 19:20:05 -0000	1.19
+++ src/sys/dev/pci/if_bge.c	1 Mar 2003 13:37:55 -0000
d4046 2
a4047 2
--- src/sys/dev/pci/if_sf.c	15 Jan 2003 06:31:02 -0000	1.19
+++ src/sys/dev/pci/if_sf.c	1 Mar 2003 13:37:55 -0000
d4062 2
a4063 2
--- src/sys/dev/pci/if_ste.c	15 Jan 2003 06:31:02 -0000	1.18
+++ src/sys/dev/pci/if_ste.c	1 Mar 2003 13:37:55 -0000
d4078 2
a4079 2
--- src/sys/dev/pci/pciide.c	24 Feb 2003 20:53:53 -0000	1.116
+++ src/sys/dev/pci/pciide.c	1 Mar 2003 13:37:55 -0000
d4103 2
a4104 2
--- src/sys/dev/wscons/wsdisplay.c	23 Feb 2003 19:07:49 -0000	1.50
+++ src/sys/dev/wscons/wsdisplay.c	1 Mar 2003 13:37:56 -0000
d4119 2
a4120 2
--- src/sys/kern/kern_exec.c	11 Dec 2002 00:07:46 -0000	1.75
+++ src/sys/kern/kern_exec.c	1 Mar 2003 13:37:56 -0000
d4122 1
a4122 1
+/*	$MirBSD: obsd.kernel,v 1.11 2003/03/01 13:16:05 tg Exp $	*/
d4141 2
a4142 2
--- src/sys/kern/kern_fork.c	31 Oct 2002 01:33:05 -0000	1.59
+++ src/sys/kern/kern_fork.c	1 Mar 2003 13:37:56 -0000
d4144 1
a4144 1
+/*	$MirBSD: obsd.kernel,v 1.11 2003/03/01 13:16:05 tg Exp $	*/
d4209 2
a4210 2
--- src/sys/kern/kern_sig.c	1 Oct 2002 17:33:17 -0000	1.61
+++ src/sys/kern/kern_sig.c	1 Mar 2003 13:37:56 -0000
d4305 2
a4306 2
--- src/sys/kern/kern_synch.c	15 Oct 2002 20:17:00 -0000	1.46
+++ src/sys/kern/kern_synch.c	1 Mar 2003 13:37:56 -0000
d4333 2
a4334 2
--- src/sys/kern/kern_sysctl.c	21 Jan 2003 16:59:01 -0000	1.79
+++ src/sys/kern/kern_sysctl.c	1 Mar 2003 13:37:56 -0000
d4447 2
a4448 2
--- src/sys/kern/subr_userconf.c	29 Jul 2002 23:18:35 -0000	1.31
+++ src/sys/kern/subr_userconf.c	1 Mar 2003 13:37:56 -0000
d4472 2
a4473 2
--- src/sys/kern/sys_generic.c	12 Aug 2002 14:32:22 -0000	1.41
+++ src/sys/kern/sys_generic.c	1 Mar 2003 13:37:56 -0000
d4497 2
a4498 2
--- src/sys/kern/vfs_syscalls.c	2 Oct 2002 21:56:08 -0000	1.98
+++ src/sys/kern/vfs_syscalls.c	1 Mar 2003 13:37:56 -0000
d4513 2
a4514 2
--- src/sys/lib/libkern/arch/i386/Makefile.inc	18 Dec 2000 18:40:24 -0000	1.7
+++ src/sys/lib/libkern/arch/i386/Makefile.inc	1 Mar 2003 13:37:56 -0000
d4516 1
a4516 1
+#	$MirBSD: obsd.kernel,v 1.11 2003/03/01 13:16:05 tg Exp $
d4532 2
a4533 2
--- src/sys/lib/libkern/arch/i386/htonl.S	27 Sep 1996 06:47:25 -0000	1.2
+++ src/sys/lib/libkern/arch/i386/htonl.S	1 Mar 2003 13:37:56 -0000
d4601 2
a4602 2
--- src/sys/lib/libkern/arch/i386/htons.S	27 Sep 1996 06:47:26 -0000	1.2
+++ src/sys/lib/libkern/arch/i386/htons.S	1 Mar 2003 13:37:56 -0000
d4667 2
a4668 2
--- src/sys/lib/libsa/exec_elf.c	9 Jul 2002 01:45:25 -0000	1.6
+++ src/sys/lib/libsa/exec_elf.c	1 Mar 2003 13:37:56 -0000
d4738 2
a4739 2
--- src/sys/lib/libsa/loadfile.c	11 Nov 2002 00:04:08 -0000	1.3
+++ src/sys/lib/libsa/loadfile.c	28 Feb 2003 20:26:13 -0000
d4791 2
a4792 2
--- src/sys/lib/libz/Makefile	8 Sep 1998 04:07:25 -0000	1.3
+++ src/sys/lib/libz/Makefile	1 Mar 2003 13:37:56 -0000
d4807 2
a4808 2
--- src/sys/miscfs/procfs/procfs_vnops.c	31 Jan 2003 17:37:28 -0000	1.27
+++ src/sys/miscfs/procfs/procfs_vnops.c	1 Mar 2003 13:37:56 -0000
d4823 2
a4824 2
--- src/sys/miscfs/union/union_vnops.c	8 Jun 2002 18:43:12 -0000	1.19
+++ src/sys/miscfs/union/union_vnops.c	1 Mar 2003 13:37:57 -0000
d4839 2
a4840 2
--- src/sys/net/if_bridge.c	21 Feb 2003 21:49:15 -0000	1.112
+++ src/sys/net/if_bridge.c	1 Mar 2003 13:37:57 -0000
d4855 2
a4856 2
--- src/sys/net/if_vlan.c	1 Feb 2003 00:14:18 -0000	1.34
+++ src/sys/net/if_vlan.c	1 Mar 2003 13:37:57 -0000
d4871 2
a4872 2
--- src/sys/net/pf.c	27 Feb 2003 13:35:35 -0000	1.324
+++ src/sys/net/pf.c	1 Mar 2003 13:37:57 -0000
d4950 2
a4951 2
--- src/sys/net/pfkeyv2.c	16 Feb 2003 21:29:51 -0000	1.87
+++ src/sys/net/pfkeyv2.c	1 Mar 2003 13:37:57 -0000
d4966 2
a4967 2
--- src/sys/netinet/ip_ah.c	28 Feb 2003 21:42:34 -0000	1.72
+++ src/sys/netinet/ip_ah.c	1 Mar 2003 13:37:57 -0000
d4991 2
a4992 2
--- src/sys/netinet/ip_esp.c	28 Feb 2003 21:42:34 -0000	1.80
+++ src/sys/netinet/ip_esp.c	1 Mar 2003 13:37:57 -0000
d5016 2
a5017 2
--- src/sys/netinet/ip_ipcomp.c	18 Feb 2003 18:47:18 -0000	1.11
+++ src/sys/netinet/ip_ipcomp.c	1 Mar 2003 13:37:57 -0000
d5041 2
a5042 2
--- src/sys/netinet/ip_ipsp.c	19 Nov 2002 18:34:19 -0000	1.150
+++ src/sys/netinet/ip_ipsp.c	1 Mar 2003 13:37:57 -0000
d5057 2
a5058 2
--- src/sys/netinet/ip_output.c	31 Jan 2003 17:26:41 -0000	1.151
+++ src/sys/netinet/ip_output.c	1 Mar 2003 13:37:57 -0000
d5094 2
a5095 2
--- src/sys/netinet/ipsec_output.c	19 Feb 2003 19:14:51 -0000	1.26
+++ src/sys/netinet/ipsec_output.c	1 Mar 2003 13:37:57 -0000
d5134 2
a5135 2
--- src/sys/netinet/tcp_input.c	14 Feb 2003 17:54:24 -0000	1.125
+++ src/sys/netinet/tcp_input.c	1 Mar 2003 13:37:57 -0000
d5150 2
a5151 2
--- src/sys/netinet/tcp_output.c	25 Jan 2003 15:27:07 -0000	1.54
+++ src/sys/netinet/tcp_output.c	1 Mar 2003 13:37:57 -0000
d5177 2
a5178 2
--- src/sys/netinet/tcp_subr.c	28 Aug 2002 15:42:41 -0000	1.65
+++ src/sys/netinet/tcp_subr.c	1 Mar 2003 13:37:57 -0000
d5237 2
a5238 2
--- src/sys/netinet/tcp_usrreq.c	12 Feb 2003 14:40:46 -0000	1.68
+++ src/sys/netinet/tcp_usrreq.c	1 Mar 2003 13:37:57 -0000
d5258 2
a5259 2
--- src/sys/netinet/udp_usrreq.c	28 Aug 2002 15:42:41 -0000	1.86
+++ src/sys/netinet/udp_usrreq.c	1 Mar 2003 13:37:57 -0000
d5273 2
a5274 2
--- src/sys/netinet6/in6_ifattach.c	12 Sep 2002 01:11:32 -0000	1.32
+++ src/sys/netinet6/in6_ifattach.c	1 Mar 2003 13:37:57 -0000
d5304 2
a5305 2
--- src/sys/netinet6/ip6_forward.c	9 Jun 2002 14:38:17 -0000	1.24
+++ src/sys/netinet6/ip6_forward.c	1 Mar 2003 13:37:57 -0000
d5320 2
a5321 2
--- src/sys/netinet6/ip6_output.c	31 Oct 2002 18:02:05 -0000	1.73
+++ src/sys/netinet6/ip6_output.c	1 Mar 2003 13:37:58 -0000
d5336 2
a5337 2
--- src/sys/netinet6/raw_ip6.c	11 Sep 2002 03:27:08 -0000	1.17
+++ src/sys/netinet6/raw_ip6.c	1 Mar 2003 13:37:58 -0000
d5353 2
a5354 2
--- src/sys/nfs/nfsproto.h	28 Jan 2002 22:35:57 -0000	1.4
+++ src/sys/nfs/nfsproto.h	1 Mar 2003 13:37:59 -0000
d5571 2
a5572 2
--- src/sys/stand/boot/cmd.c	14 Jul 2002 09:18:55 -0000	1.48
+++ src/sys/stand/boot/cmd.c	1 Mar 2003 13:37:59 -0000
d5621 2
a5622 2
--- src/sys/sys/proc.h	20 Jul 2002 19:24:35 -0000	1.62
+++ src/sys/sys/proc.h	1 Mar 2003 13:37:59 -0000
d5624 1
a5624 1
+/*	$MirBSD: obsd.kernel,v 1.11 2003/03/01 13:16:05 tg Exp $	*/
d5652 2
a5653 2
--- src/sys/sys/resource.h	14 Mar 2002 01:26:52 -0000	1.4
+++ src/sys/sys/resource.h	1 Mar 2003 13:37:59 -0000
d5670 2
a5671 2
--- src/sys/sys/sysctl.h	21 Jan 2003 16:59:01 -0000	1.62
+++ src/sys/sys/sysctl.h	1 Mar 2003 13:37:59 -0000
d5673 1
a5673 1
+/*	$MirBSD: obsd.kernel,v 1.11 2003/03/01 13:16:05 tg Exp $	*/
d5711 1
a5711 1
@@@@ -209,7 +208,7 @@@@
a5714 1
-	{ "gap", 0 }, \
d5717 1
d5720 1
d5735 2
a5736 2
--- src/sys/sys/systm.h	21 Jan 2003 16:59:01 -0000	1.54
+++ src/sys/sys/systm.h	1 Mar 2003 13:37:59 -0000
d5750 2
a5751 2
--- src/sys/sys/utsname.h	14 Mar 2002 01:26:52 -0000	1.4
+++ src/sys/sys/utsname.h	1 Mar 2003 13:37:59 -0000
d5753 1
a5753 1
+/*	$MirBSD: obsd.kernel,v 1.11 2003/03/01 13:16:05 tg Exp $	*/
d5781 2
a5782 2
--- src/sys/ufs/ffs/ffs_softdep.c	12 Oct 2002 01:09:23 -0000	1.42
+++ src/sys/ufs/ffs/ffs_softdep.c	1 Mar 2003 13:37:59 -0000
d5797 2
a5798 2
--- src/sys/ufs/ffs/ffs_vfsops.c	1 Aug 2002 16:41:11 -0000	1.54
+++ src/sys/ufs/ffs/ffs_vfsops.c	1 Mar 2003 13:37:59 -0000
d5813 2
a5814 2
--- src/sys/uvm/uvm_amap.c	9 May 2002 14:13:56 -0000	1.27
+++ src/sys/uvm/uvm_amap.c	1 Mar 2003 13:37:59 -0000
d5829 2
a5830 2
--- src/sys/uvm/uvm_map.c	9 Dec 2002 02:34:59 -0000	1.56
+++ src/sys/uvm/uvm_map.c	1 Mar 2003 13:37:59 -0000
d5867 2
a5868 2
--- src/sys/uvm/uvm_meter.c	14 Mar 2002 01:26:56 -0000	1.17
+++ src/sys/uvm/uvm_meter.c	1 Mar 2003 13:37:59 -0000
d5903 2
a5904 2
--- src/sys/uvm/uvm_pager.c	29 Oct 2002 18:29:59 -0000	1.33
+++ src/sys/uvm/uvm_pager.c	1 Mar 2003 13:37:59 -0000
d5919 2
a5920 2
--- src/sys/uvm/uvm_swap.c	12 Oct 2002 01:09:23 -0000	1.55
+++ src/sys/uvm/uvm_swap.c	1 Mar 2003 13:37:59 -0000
d5930 1
a5930 1
Index: src/sys/arch/i386/include/loadfile_machdep.h
d5934 2
a5935 2
--- /dev/null	Sat Mar  1 13:09:38 2003
+++ src/sys/arch/i386/include/loadfile_machdep.h	Sat Mar  1 13:38:02 2003
d6002 1
a6002 1
Index: src/sys/arch/i386/include/reloc.h
d6006 2
a6007 2
--- /dev/null	Sat Mar  1 13:09:38 2003
+++ src/sys/arch/i386/include/reloc.h	Sat Mar  1 13:38:02 2003
d6058 1
a6058 1
Index: src/sys/stand/boot/boot_loadfile.c
d6062 2
a6063 2
--- /dev/null	Sat Mar  1 13:09:38 2003
+++ src/sys/stand/boot/boot_loadfile.c	Fri Feb 28 20:26:14 2003
@


1.11
log
@pre-build

fix ELF, file lists, domain, misc. stuff
@
text
@d24 1
a24 1
against CTM on Sat Mar  1 13:11:49 UTC 2003.
d34 1
a34 1
+++ src/sys/arch/i386/conf/DISKLESS	1 Mar 2003 13:10:27 -0000
d67 1
a67 1
+++ src/sys/arch/i386/conf/GENERIC	1 Mar 2003 13:10:28 -0000
d69 1
a69 1
+#	$MirBSD: obsd.kernel,v 1.10 2003/03/01 10:05:33 tg Exp $
d164 1
a164 1
+++ src/sys/arch/i386/conf/Makefile.i386	1 Mar 2003 13:10:28 -0000
d166 1
a166 1
+#	$MirBSD: obsd.kernel,v 1.10 2003/03/01 10:05:33 tg Exp $
d208 1
a208 1
+++ src/sys/arch/i386/conf/RAMDISK	1 Mar 2003 13:10:28 -0000
d238 1
a238 1
+++ src/sys/arch/i386/conf/RAMDISKB	1 Mar 2003 13:10:28 -0000
d262 1
a262 1
+++ src/sys/arch/i386/conf/RAMDISKC	1 Mar 2003 13:10:28 -0000
d286 1
a286 1
+++ src/sys/arch/i386/conf/RAMDISK_CD	1 Mar 2003 13:10:28 -0000
d310 1
a310 1
+++ src/sys/arch/i386/i386/bios.c	1 Mar 2003 13:10:28 -0000
d326 1
a326 1
+++ src/sys/arch/i386/i386/db_magic.s	1 Mar 2003 13:10:28 -0000
d393 1
a393 1
+++ src/sys/arch/i386/i386/in_cksum.s	1 Mar 2003 13:10:28 -0000
d419 1
a419 1
+++ src/sys/arch/i386/i386/locore.s	1 Mar 2003 13:10:28 -0000
d618 1
a618 1
+++ src/sys/arch/i386/i386/machdep.c	1 Mar 2003 13:10:29 -0000
d655 1
a655 1
+++ src/sys/arch/i386/i386/microtime.s	1 Mar 2003 13:10:29 -0000
d713 1
a713 1
+++ src/sys/arch/i386/i386/random.s	1 Mar 2003 13:10:29 -0000
d746 1
a746 1
+++ src/sys/arch/i386/include/asm.h	1 Mar 2003 13:10:29 -0000
d809 1
a809 1
+++ src/sys/arch/i386/include/biosvar.h	1 Mar 2003 13:10:25 -0000
d825 1
a825 1
+++ src/sys/arch/i386/include/bus.h	1 Mar 2003 13:10:29 -0000
d880 1
a880 1
+++ src/sys/arch/i386/include/cdefs.h	1 Mar 2003 13:10:29 -0000
d927 1
a927 1
+++ src/sys/arch/i386/include/db_machdep.h	1 Mar 2003 13:10:29 -0000
d943 1
a943 1
+++ src/sys/arch/i386/include/exec.h	1 Mar 2003 13:10:29 -0000
d978 1
a978 1
+++ src/sys/arch/i386/include/intr.h	1 Mar 2003 13:10:29 -0000
d995 1
a995 1
+++ src/sys/arch/i386/include/param.h	1 Mar 2003 13:10:29 -0000
d1018 1
a1018 1
+++ src/sys/arch/i386/isa/clock.c	1 Mar 2003 13:10:29 -0000
d1034 1
a1034 1
+++ src/sys/arch/i386/isa/icu.s	1 Mar 2003 13:10:29 -0000
d1066 1
a1066 1
+++ src/sys/arch/i386/isa/npx.c	1 Mar 2003 13:10:29 -0000
d1118 1
a1118 1
+++ src/sys/arch/i386/isa/pccom.c	1 Mar 2003 13:10:29 -0000
d1143 1
a1143 1
+++ src/sys/arch/i386/isa/vector.s	1 Mar 2003 13:10:29 -0000
d1319 1
a1319 1
+++ src/sys/arch/i386/pci/pchb.c	1 Mar 2003 13:10:29 -0000
d1335 1
a1335 1
+++ src/sys/arch/i386/pci/pci_addr_fixup.c	1 Mar 2003 13:10:29 -0000
d1368 1
a1368 1
+++ src/sys/arch/i386/pci/pcibios.c	1 Mar 2003 13:10:29 -0000
d1388 1
a1388 1
+++ src/sys/arch/i386/stand/Makefile.inc	1 Mar 2003 13:10:29 -0000
d1413 1
a1413 1
+++ src/sys/arch/i386/stand/biosboot/Makefile	1 Mar 2003 13:10:29 -0000
d1429 1
a1429 1
+++ src/sys/arch/i386/stand/biosboot/biosboot.S	1 Mar 2003 13:10:29 -0000
d1781 1
a1781 1
+++ src/sys/arch/i386/stand/boot/Makefile	1 Mar 2003 13:10:29 -0000
d1826 1
a1826 1
+++ src/sys/arch/i386/stand/boot/conf.c	1 Mar 2003 13:10:29 -0000
d1873 1
a1873 1
+++ src/sys/arch/i386/stand/boot/srt0.S	1 Mar 2003 13:10:29 -0000
d1946 1
a1946 1
+++ src/sys/arch/i386/stand/installboot/installboot.c	1 Mar 2003 13:10:29 -0000
d2082 1
a2082 1
+++ src/sys/arch/i386/stand/libsa/Makefile	1 Mar 2003 13:10:29 -0000
d2107 1
a2107 1
+++ src/sys/arch/i386/stand/libsa/alloca.S	1 Mar 2003 13:10:29 -0000
d2120 1
a2120 1
+++ src/sys/arch/i386/stand/libsa/apmprobe.c	1 Mar 2003 13:10:29 -0000
d2283 1
a2283 1
+++ src/sys/arch/i386/stand/libsa/bioscons.c	1 Mar 2003 13:10:29 -0000
d2299 1
a2299 1
+++ src/sys/arch/i386/stand/libsa/biosdev.c	1 Mar 2003 13:10:29 -0000
d2356 1
a2356 1
+++ src/sys/arch/i386/stand/libsa/cmd_i386.c	1 Mar 2003 13:10:29 -0000
d2433 1
a2433 1
+++ src/sys/arch/i386/stand/libsa/debug_i386.S	1 Mar 2003 13:10:29 -0000
d2462 1
a2462 1
+++ src/sys/arch/i386/stand/libsa/diskprobe.c	1 Mar 2003 13:10:29 -0000
d2513 1
a2513 1
+++ src/sys/arch/i386/stand/libsa/exec_i386.c	1 Mar 2003 13:10:29 -0000
d2571 1
a2571 1
+++ src/sys/arch/i386/stand/libsa/gidt.S	1 Mar 2003 13:10:29 -0000
d2935 1
a2935 1
+++ src/sys/arch/i386/stand/libsa/libsa.h	1 Mar 2003 13:10:29 -0000
d2966 1
a2966 1
+++ src/sys/arch/i386/stand/libsa/machdep.c	1 Mar 2003 13:10:29 -0000
d2982 1
a2982 1
+++ src/sys/arch/i386/stand/libsa/smpprobe.c	1 Mar 2003 13:10:29 -0000
d3009 1
a3009 1
+++ src/sys/arch/i386/stand/mbr/Makefile	1 Mar 2003 13:10:29 -0000
d3025 1
a3025 1
+++ src/sys/arch/i386/stand/mbr/mbr.S	1 Mar 2003 13:10:29 -0000
d3132 1
a3132 1
+++ src/sys/conf/GENERIC	1 Mar 2003 13:10:29 -0000
d3134 1
a3134 1
+#	$MirBSD: obsd.kernel,v 1.9 2003/03/01 00:08:27 tg Exp $
d3187 1
a3187 1
+++ src/sys/conf/newvers.sh	1 Mar 2003 13:10:29 -0000
d3191 1
a3191 1
+#	$MirBSD: obsd.kernel,v 1.9 2003/03/01 00:08:27 tg Exp $
d3241 1
a3241 1
+ospl="$(echo '\$Date: 2003/03/01 00:08:27 $' | sed -e 's,^.*: ,,' -e 's,/,,g' -e 's, .*$,,')"
d3254 1
a3254 1
+    "    @@(#)MirBSD from ${ost} ${osr}-beta (${id}) #${v}: ${t}\n	@@(#)\$MirBSD: obsd.kernel,v 1.9 2003/03/01 00:08:27 tg Exp $\n";
d3258 1
a3258 1
+    "MirBSD ${osr}-${ospl} (${id}) #${v}: ${t}\n    ${u}@@${h}:${d}\n    patchlevel:\$MirBSD: obsd.kernel,v 1.9 2003/03/01 00:08:27 tg Exp $\n";
d3262 40
d3308 1
a3308 1
+++ src/sys/dev/ccd.c	1 Mar 2003 13:10:29 -0000
d3324 1
a3324 1
+++ src/sys/dev/systrace.c	1 Mar 2003 13:10:29 -0000
d3340 1
a3340 1
+++ src/sys/dev/ic/dc.c	1 Mar 2003 13:10:30 -0000
d3380 1
a3380 1
+++ src/sys/dev/ic/if_wi.c	1 Mar 2003 13:10:30 -0000
d3396 1
a3396 1
+++ src/sys/dev/ic/if_wi_hostap.c	1 Mar 2003 13:10:30 -0000
d3433 1
a3433 1
+++ src/sys/dev/ic/ne2000.c	1 Mar 2003 13:10:30 -0000
d3449 1
a3449 1
+++ src/sys/dev/ic/rtl80x9.c	1 Mar 2003 13:10:30 -0000
d3465 1
a3465 1
+++ src/sys/dev/ic/rtl81x9.c	1 Mar 2003 13:10:30 -0000
d3484 1
a3484 1
+++ src/sys/dev/isa/if_we.c	1 Mar 2003 13:10:30 -0000
d3501 1
a3501 1
+++ src/sys/dev/isa/spkr.c	1 Mar 2003 13:10:30 -0000
d3503 1
a3503 1
+/*	$MirBSD: obsd.kernel,v 1.9 2003/03/01 00:08:27 tg Exp $	*/
d3960 1
a3960 1
+++ src/sys/dev/microcode/aic7xxx/Makefile	1 Mar 2003 13:10:30 -0000
d3976 1
a3976 1
+++ src/sys/dev/mii/bmtphy.c	1 Mar 2003 13:10:30 -0000
d4003 1
a4003 1
+++ src/sys/dev/pci/if_bge.c	1 Mar 2003 13:10:30 -0000
d4047 1
a4047 1
+++ src/sys/dev/pci/if_sf.c	1 Mar 2003 13:10:30 -0000
d4063 1
a4063 1
+++ src/sys/dev/pci/if_ste.c	1 Mar 2003 13:10:30 -0000
d4079 1
a4079 1
+++ src/sys/dev/pci/pciide.c	1 Mar 2003 13:10:30 -0000
d4104 1
a4104 1
+++ src/sys/dev/wscons/wsdisplay.c	1 Mar 2003 13:10:33 -0000
d4120 1
a4120 1
+++ src/sys/kern/kern_exec.c	1 Mar 2003 13:10:34 -0000
d4122 1
a4122 1
+/*	$MirBSD: obsd.kernel,v 1.9 2003/03/01 00:08:27 tg Exp $	*/
d4142 1
a4142 1
+++ src/sys/kern/kern_fork.c	1 Mar 2003 13:10:34 -0000
d4144 1
a4144 1
+/*	$MirBSD: obsd.kernel,v 1.9 2003/03/01 00:08:27 tg Exp $	*/
d4210 1
a4210 1
+++ src/sys/kern/kern_sig.c	1 Mar 2003 13:10:34 -0000
d4306 1
a4306 1
+++ src/sys/kern/kern_synch.c	1 Mar 2003 13:10:34 -0000
d4334 1
a4334 1
+++ src/sys/kern/kern_sysctl.c	1 Mar 2003 13:10:34 -0000
d4448 1
a4448 1
+++ src/sys/kern/subr_userconf.c	1 Mar 2003 13:10:34 -0000
d4473 1
a4473 1
+++ src/sys/kern/sys_generic.c	1 Mar 2003 13:10:34 -0000
d4498 1
a4498 1
+++ src/sys/kern/vfs_syscalls.c	1 Mar 2003 13:10:34 -0000
d4514 1
a4514 1
+++ src/sys/lib/libkern/arch/i386/Makefile.inc	1 Mar 2003 13:10:34 -0000
d4516 1
a4516 1
+#	$MirBSD: obsd.kernel,v 1.9 2003/03/01 00:08:27 tg Exp $
d4533 1
a4533 1
+++ src/sys/lib/libkern/arch/i386/htonl.S	1 Mar 2003 13:10:34 -0000
d4602 1
a4602 1
+++ src/sys/lib/libkern/arch/i386/htons.S	1 Mar 2003 13:10:34 -0000
d4668 1
a4668 1
+++ src/sys/lib/libsa/exec_elf.c	1 Mar 2003 13:10:34 -0000
d4733 53
d4792 1
a4792 1
+++ src/sys/lib/libz/Makefile	1 Mar 2003 13:10:34 -0000
d4808 1
a4808 1
+++ src/sys/miscfs/procfs/procfs_vnops.c	1 Mar 2003 13:10:34 -0000
d4824 1
a4824 1
+++ src/sys/miscfs/union/union_vnops.c	1 Mar 2003 13:10:34 -0000
d4840 1
a4840 1
+++ src/sys/net/if_bridge.c	1 Mar 2003 13:10:34 -0000
d4856 1
a4856 1
+++ src/sys/net/if_vlan.c	1 Mar 2003 13:10:34 -0000
d4872 1
a4872 1
+++ src/sys/net/pf.c	1 Mar 2003 13:10:34 -0000
d4951 1
a4951 1
+++ src/sys/net/pfkeyv2.c	1 Mar 2003 13:10:34 -0000
d4967 1
a4967 1
+++ src/sys/netinet/ip_ah.c	1 Mar 2003 13:10:35 -0000
d4992 1
a4992 1
+++ src/sys/netinet/ip_esp.c	1 Mar 2003 13:10:35 -0000
d5017 1
a5017 1
+++ src/sys/netinet/ip_ipcomp.c	1 Mar 2003 13:10:35 -0000
d5042 1
a5042 1
+++ src/sys/netinet/ip_ipsp.c	1 Mar 2003 13:10:35 -0000
d5058 1
a5058 1
+++ src/sys/netinet/ip_output.c	1 Mar 2003 13:10:35 -0000
d5095 1
a5095 1
+++ src/sys/netinet/ipsec_output.c	1 Mar 2003 13:10:35 -0000
d5135 1
a5135 1
+++ src/sys/netinet/tcp_input.c	1 Mar 2003 13:10:35 -0000
d5151 1
a5151 1
+++ src/sys/netinet/tcp_output.c	1 Mar 2003 13:10:35 -0000
d5178 1
a5178 1
+++ src/sys/netinet/tcp_subr.c	1 Mar 2003 13:10:35 -0000
d5238 1
a5238 1
+++ src/sys/netinet/tcp_usrreq.c	1 Mar 2003 13:10:35 -0000
d5259 1
a5259 1
+++ src/sys/netinet/udp_usrreq.c	1 Mar 2003 13:10:35 -0000
d5274 1
a5274 1
+++ src/sys/netinet6/in6_ifattach.c	1 Mar 2003 13:10:35 -0000
d5305 1
a5305 1
+++ src/sys/netinet6/ip6_forward.c	1 Mar 2003 13:10:35 -0000
d5321 1
a5321 1
+++ src/sys/netinet6/ip6_output.c	1 Mar 2003 13:10:35 -0000
d5337 1
a5337 1
+++ src/sys/netinet6/raw_ip6.c	1 Mar 2003 13:10:38 -0000
d5354 1
a5354 1
+++ src/sys/nfs/nfsproto.h	1 Mar 2003 13:10:38 -0000
d5572 1
a5572 1
+++ src/sys/stand/boot/cmd.c	1 Mar 2003 13:10:38 -0000
d5622 1
a5622 1
+++ src/sys/sys/proc.h	1 Mar 2003 13:10:38 -0000
d5624 1
a5624 1
+/*	$MirBSD: obsd.kernel,v 1.9 2003/03/01 00:08:27 tg Exp $	*/
d5653 1
a5653 1
+++ src/sys/sys/resource.h	1 Mar 2003 13:10:38 -0000
d5671 1
a5671 1
+++ src/sys/sys/sysctl.h	1 Mar 2003 13:10:38 -0000
d5673 1
a5673 1
+/*	$MirBSD: obsd.kernel,v 1.9 2003/03/01 00:08:27 tg Exp $	*/
d5735 1
a5735 1
+++ src/sys/sys/systm.h	1 Mar 2003 13:10:38 -0000
d5750 1
a5750 1
+++ src/sys/sys/utsname.h	1 Mar 2003 13:10:38 -0000
d5752 1
a5752 1
+/*	$MirBSD: obsd.kernel,v 1.9 2003/03/01 00:08:27 tg Exp $	*/
d5781 1
a5781 1
+++ src/sys/ufs/ffs/ffs_softdep.c	1 Mar 2003 13:10:38 -0000
d5797 1
a5797 1
+++ src/sys/ufs/ffs/ffs_vfsops.c	1 Mar 2003 13:10:38 -0000
d5813 1
a5813 1
+++ src/sys/uvm/uvm_amap.c	1 Mar 2003 13:10:38 -0000
d5829 1
a5829 1
+++ src/sys/uvm/uvm_map.c	1 Mar 2003 13:10:38 -0000
d5867 1
a5867 1
+++ src/sys/uvm/uvm_meter.c	1 Mar 2003 13:10:38 -0000
d5903 1
a5903 1
+++ src/sys/uvm/uvm_pager.c	1 Mar 2003 13:10:38 -0000
d5919 1
a5919 1
+++ src/sys/uvm/uvm_swap.c	1 Mar 2003 13:10:38 -0000
d5934 1
a5934 1
+++ src/sys/arch/i386/include/loadfile_machdep.h	Sat Mar  1 13:10:25 2003
d6006 1
a6006 1
+++ src/sys/arch/i386/include/reloc.h	Sat Mar  1 13:10:25 2003
d6057 126
d6246 1
d6276 1
d6317 1
@


1.10
log
@post-build developer

I'm not sure if egcs builds now...
@
text
@d24 1
a24 1
against CTM on Sat Mar  1 10:03:45 UTC 2003.
d27 1
a27 1
### CTM OpenBSD-cvs 3073
d34 1
a34 1
+++ src/sys/arch/i386/conf/DISKLESS	1 Mar 2003 00:08:51 -0000
d67 1
a67 1
+++ src/sys/arch/i386/conf/GENERIC	1 Mar 2003 00:08:51 -0000
d69 1
a69 1
+#	$MirBSD: obsd.kernel,v 1.9 2003/03/01 00:08:27 tg Exp $
d108 1
a108 1
+option		SYSCALL_DEBUG		# by drahn@@
d164 1
a164 1
+++ src/sys/arch/i386/conf/Makefile.i386	1 Mar 2003 00:08:51 -0000
d166 1
a166 1
+#	$MirBSD: obsd.kernel,v 1.9 2003/03/01 00:08:27 tg Exp $
d208 1
a208 1
+++ src/sys/arch/i386/conf/RAMDISK	1 Mar 2003 00:08:52 -0000
d238 1
a238 1
+++ src/sys/arch/i386/conf/RAMDISKB	1 Mar 2003 00:08:53 -0000
d262 1
a262 1
+++ src/sys/arch/i386/conf/RAMDISKC	1 Mar 2003 00:08:53 -0000
d286 1
a286 1
+++ src/sys/arch/i386/conf/RAMDISK_CD	1 Mar 2003 00:08:53 -0000
d310 1
a310 1
+++ src/sys/arch/i386/i386/bios.c	1 Mar 2003 00:08:53 -0000
d326 1
a326 1
+++ src/sys/arch/i386/i386/db_magic.s	1 Mar 2003 00:08:53 -0000
d393 1
a393 1
+++ src/sys/arch/i386/i386/in_cksum.s	1 Mar 2003 00:08:53 -0000
d419 1
a419 1
+++ src/sys/arch/i386/i386/locore.s	1 Mar 2003 00:08:53 -0000
d618 1
a618 1
+++ src/sys/arch/i386/i386/machdep.c	1 Mar 2003 00:08:54 -0000
d655 1
a655 1
+++ src/sys/arch/i386/i386/microtime.s	1 Mar 2003 00:08:54 -0000
d713 1
a713 1
+++ src/sys/arch/i386/i386/random.s	1 Mar 2003 00:08:54 -0000
d746 1
a746 1
+++ src/sys/arch/i386/include/asm.h	1 Mar 2003 00:08:54 -0000
d803 16
d825 1
a825 1
+++ src/sys/arch/i386/include/bus.h	1 Mar 2003 00:08:54 -0000
d880 1
a880 1
+++ src/sys/arch/i386/include/cdefs.h	1 Mar 2003 00:08:54 -0000
d927 1
a927 1
+++ src/sys/arch/i386/include/db_machdep.h	1 Mar 2003 00:08:54 -0000
d943 1
a943 1
+++ src/sys/arch/i386/include/exec.h	1 Mar 2003 00:08:54 -0000
d978 1
a978 1
+++ src/sys/arch/i386/include/intr.h	1 Mar 2003 00:08:54 -0000
d995 1
a995 1
+++ src/sys/arch/i386/include/param.h	1 Mar 2003 00:08:54 -0000
d1018 1
a1018 1
+++ src/sys/arch/i386/isa/clock.c	1 Mar 2003 00:08:55 -0000
d1034 1
a1034 1
+++ src/sys/arch/i386/isa/icu.s	1 Mar 2003 00:08:55 -0000
d1066 1
a1066 1
+++ src/sys/arch/i386/isa/npx.c	1 Mar 2003 00:08:55 -0000
d1118 1
a1118 1
+++ src/sys/arch/i386/isa/pccom.c	1 Mar 2003 00:08:55 -0000
d1143 1
a1143 1
+++ src/sys/arch/i386/isa/vector.s	1 Mar 2003 00:08:55 -0000
d1319 1
a1319 1
+++ src/sys/arch/i386/pci/pchb.c	1 Mar 2003 00:08:55 -0000
d1335 1
a1335 1
+++ src/sys/arch/i386/pci/pci_addr_fixup.c	1 Mar 2003 00:08:55 -0000
d1368 1
a1368 1
+++ src/sys/arch/i386/pci/pcibios.c	1 Mar 2003 00:08:55 -0000
d1388 1
a1388 1
+++ src/sys/arch/i386/stand/Makefile.inc	1 Mar 2003 00:08:56 -0000
d1407 16
d1429 1
a1429 1
+++ src/sys/arch/i386/stand/biosboot/biosboot.S	1 Mar 2003 00:08:56 -0000
d1781 1
a1781 1
+++ src/sys/arch/i386/stand/boot/Makefile	1 Mar 2003 00:08:56 -0000
d1826 1
a1826 1
+++ src/sys/arch/i386/stand/boot/conf.c	1 Mar 2003 00:08:56 -0000
d1867 209
d2082 1
a2082 1
+++ src/sys/arch/i386/stand/libsa/Makefile	1 Mar 2003 00:08:56 -0000
d2107 1
a2107 1
+++ src/sys/arch/i386/stand/libsa/alloca.S	1 Mar 2003 00:08:56 -0000
d2120 1
a2120 1
+++ src/sys/arch/i386/stand/libsa/apmprobe.c	1 Mar 2003 00:08:56 -0000
d2283 1
a2283 1
+++ src/sys/arch/i386/stand/libsa/bioscons.c	1 Mar 2003 00:08:57 -0000
d2299 1
a2299 1
+++ src/sys/arch/i386/stand/libsa/biosdev.c	1 Mar 2003 00:08:57 -0000
d2356 1
a2356 1
+++ src/sys/arch/i386/stand/libsa/cmd_i386.c	1 Mar 2003 00:08:57 -0000
d2433 1
a2433 1
+++ src/sys/arch/i386/stand/libsa/debug_i386.S	1 Mar 2003 00:08:57 -0000
d2462 1
a2462 1
+++ src/sys/arch/i386/stand/libsa/diskprobe.c	1 Mar 2003 00:08:57 -0000
d2507 58
d2571 1
a2571 1
+++ src/sys/arch/i386/stand/libsa/gidt.S	1 Mar 2003 00:08:57 -0000
d2935 1
a2935 1
+++ src/sys/arch/i386/stand/libsa/libsa.h	1 Mar 2003 00:08:57 -0000
d2960 16
d2982 1
a2982 1
+++ src/sys/arch/i386/stand/libsa/smpprobe.c	1 Mar 2003 00:08:57 -0000
d3003 16
d3025 1
a3025 1
+++ src/sys/arch/i386/stand/mbr/mbr.S	1 Mar 2003 00:08:57 -0000
d3126 2838
d5988 1
d6004 1
d6008 2
d6018 1
d6021 1
d6023 1
d6094 2
d6098 1
a6098 1
/sys diffs
@


1.9
log
@auditing diffs
if gcc doesnt build now... i dunno
@
text
@d24 1
a24 1
against CTM on Sat Mar  1 00:05:54 UTC 2003.
d34 1
a34 1
+++ src/sys/arch/i386/conf/DISKLESS	1 Mar 2003 00:01:07 -0000
d67 1
a67 1
+++ src/sys/arch/i386/conf/GENERIC	1 Mar 2003 00:01:07 -0000
d69 1
a69 1
+#	$MirBSD: obsd.kernel,v 1.8 2003/02/28 18:22:09 tg Exp $
d164 1
a164 1
+++ src/sys/arch/i386/conf/Makefile.i386	1 Mar 2003 00:01:07 -0000
d166 1
a166 1
+#	$MirBSD: obsd.kernel,v 1.8 2003/02/28 18:22:09 tg Exp $
d208 1
a208 1
+++ src/sys/arch/i386/conf/RAMDISK	1 Mar 2003 00:01:07 -0000
d238 1
a238 1
+++ src/sys/arch/i386/conf/RAMDISKB	1 Mar 2003 00:01:07 -0000
d262 1
a262 1
+++ src/sys/arch/i386/conf/RAMDISKC	1 Mar 2003 00:01:07 -0000
d286 1
a286 1
+++ src/sys/arch/i386/conf/RAMDISK_CD	1 Mar 2003 00:01:08 -0000
d310 1
a310 1
+++ src/sys/arch/i386/i386/bios.c	1 Mar 2003 00:01:08 -0000
d326 1
a326 1
+++ src/sys/arch/i386/i386/db_magic.s	1 Mar 2003 00:01:08 -0000
d393 1
a393 1
+++ src/sys/arch/i386/i386/in_cksum.s	1 Mar 2003 00:01:08 -0000
d419 1
a419 1
+++ src/sys/arch/i386/i386/locore.s	1 Mar 2003 00:01:08 -0000
d618 1
a618 1
+++ src/sys/arch/i386/i386/machdep.c	1 Mar 2003 00:01:08 -0000
d655 1
a655 1
+++ src/sys/arch/i386/i386/microtime.s	1 Mar 2003 00:01:09 -0000
d713 1
a713 1
+++ src/sys/arch/i386/i386/random.s	1 Mar 2003 00:01:09 -0000
d746 1
a746 1
+++ src/sys/arch/i386/include/asm.h	1 Mar 2003 00:01:09 -0000
d809 1
a809 1
+++ src/sys/arch/i386/include/bus.h	1 Mar 2003 00:01:09 -0000
d864 1
a864 1
+++ src/sys/arch/i386/include/cdefs.h	1 Mar 2003 00:01:09 -0000
d911 1
a911 1
+++ src/sys/arch/i386/include/db_machdep.h	1 Mar 2003 00:01:09 -0000
d927 1
a927 1
+++ src/sys/arch/i386/include/exec.h	1 Mar 2003 00:01:09 -0000
d962 1
a962 1
+++ src/sys/arch/i386/include/intr.h	1 Mar 2003 00:01:09 -0000
d979 1
a979 1
+++ src/sys/arch/i386/include/param.h	1 Mar 2003 00:01:09 -0000
d1002 1
a1002 1
+++ src/sys/arch/i386/isa/clock.c	1 Mar 2003 00:01:09 -0000
d1018 1
a1018 1
+++ src/sys/arch/i386/isa/icu.s	1 Mar 2003 00:01:09 -0000
d1050 1
a1050 1
+++ src/sys/arch/i386/isa/npx.c	1 Mar 2003 00:01:09 -0000
d1102 1
a1102 1
+++ src/sys/arch/i386/isa/pccom.c	1 Mar 2003 00:01:09 -0000
d1127 1
a1127 1
+++ src/sys/arch/i386/isa/vector.s	1 Mar 2003 00:01:09 -0000
d1303 1
a1303 1
+++ src/sys/arch/i386/pci/pchb.c	1 Mar 2003 00:01:09 -0000
d1319 1
a1319 1
+++ src/sys/arch/i386/pci/pci_addr_fixup.c	1 Mar 2003 00:01:09 -0000
d1352 1
a1352 1
+++ src/sys/arch/i386/pci/pcibios.c	1 Mar 2003 00:01:09 -0000
d1372 1
a1372 1
+++ src/sys/arch/i386/stand/Makefile.inc	1 Mar 2003 00:01:09 -0000
d1397 1
a1397 1
+++ src/sys/arch/i386/stand/biosboot/biosboot.S	1 Mar 2003 00:01:09 -0000
d1749 1
a1749 1
+++ src/sys/arch/i386/stand/boot/Makefile	1 Mar 2003 00:01:09 -0000
d1794 1
a1794 1
+++ src/sys/arch/i386/stand/boot/conf.c	1 Mar 2003 00:01:09 -0000
d1841 1
a1841 1
+++ src/sys/arch/i386/stand/libsa/Makefile	1 Mar 2003 00:01:09 -0000
d1866 1
a1866 1
+++ src/sys/arch/i386/stand/libsa/alloca.S	1 Mar 2003 00:01:09 -0000
d1879 1
a1879 1
+++ src/sys/arch/i386/stand/libsa/apmprobe.c	1 Mar 2003 00:01:09 -0000
d2042 1
a2042 1
+++ src/sys/arch/i386/stand/libsa/bioscons.c	1 Mar 2003 00:01:09 -0000
d2058 1
a2058 1
+++ src/sys/arch/i386/stand/libsa/biosdev.c	1 Mar 2003 00:01:09 -0000
d2115 1
a2115 1
+++ src/sys/arch/i386/stand/libsa/cmd_i386.c	1 Mar 2003 00:01:09 -0000
d2192 1
a2192 1
+++ src/sys/arch/i386/stand/libsa/debug_i386.S	1 Mar 2003 00:01:09 -0000
d2221 1
a2221 1
+++ src/sys/arch/i386/stand/libsa/diskprobe.c	1 Mar 2003 00:01:09 -0000
d2272 1
a2272 1
+++ src/sys/arch/i386/stand/libsa/gidt.S	1 Mar 2003 00:01:09 -0000
d2636 1
a2636 1
+++ src/sys/arch/i386/stand/libsa/libsa.h	1 Mar 2003 00:01:09 -0000
d2667 1
a2667 1
+++ src/sys/arch/i386/stand/libsa/smpprobe.c	1 Mar 2003 00:01:09 -0000
d2694 1
a2694 1
+++ src/sys/arch/i386/stand/mbr/mbr.S	1 Mar 2003 00:01:09 -0000
a2794 2710
Index: src/sys/conf/GENERIC
===================================================================
RCS file: /cvs/src/sys/conf/GENERIC,v
retrieving revision 1.92
diff -u -r1.92 GENERIC
--- src/sys/conf/GENERIC	29 Nov 2002 18:25:01 -0000	1.92
+++ src/sys/conf/GENERIC	1 Mar 2003 00:01:09 -0000
@@@@ -1,3 +1,4 @@@@
+#	$MirBSD: obsd.kernel,v 1.8 2003/02/28 18:22:09 tg Exp $
 #	$OpenBSD: GENERIC,v 1.92 2002/11/29 18:25:23 mickey Exp $
 #
 #	Machine-independent option; used by all architectures for their
@@@@ -24,22 +25,24 @@@@
 option		UVM_SWAP_ENCRYPT# support encryption of pages going to swap
 
 #option		COMPAT_23	# Kernel compatibility with OpenBSD 2.3,
-option		COMPAT_25	# 2.5,
-option		COMPAT_43	# and 4.3BSD
+#option		COMPAT_25	# 2.5,
+#option		COMPAT_43	# and 4.3BSD
 #option		TCP_COMPAT_42	# TCP bug compatibility with 4.2BSD
 
 option		LKM		# loadable kernel modules
 
 option		FFS		# UFS
 option		FFS_SOFTUPDATES	# Soft updates
+#option		UFS_EXTATTR	# support for extended attributes
 option		QUOTA		# UFS quotas
 option		EXT2FS		# Second Extended Filesystem
+option		EXT2FS_SYSTEM_FLAGS
 option		MFS		# memory file system
 #option		XFS		# xfs filesystem
 
 option		TCP_SACK	# Selective Acknowledgements for TCP
 option		TCP_ECN		# Explicit Congestion Notification for TCP
-#option		TCP_FACK	# Forward Acknowledgements for TCP
+option		TCP_FACK	# Forward Acknowledgements for TCP
 #option		TCP_SIGNATURE	# TCP MD5 Signatures, for BGP routing sessions
 
 option		NFSCLIENT	# Network File System client
@@@@ -62,11 +65,11 @@@@
 option		INET6		# IPv6 (needs INET)
 option		PULLDOWN_TEST	# use m_pulldown for IPv6 packet parsing
 option		IPSEC		# IPsec
-#option		KEY		# PF_KEY (implied by IPSEC)
+option		KEY		# PF_KEY (implied by IPSEC)
 #option		NS		# XNS
 #option		NSIP		# XNS tunneling over IP
-#option		IPX		# IPX+SPX
-#option		IPXIP		# IPX tunneling over IP
+option		IPX		# IPX+SPX
+option		IPXIP		# IPX tunneling over IP
 #option		ISO,TPIP	# OSI
 #option		EON		# OSI tunneling over IP
 #option		NETATALK	# AppleTalk
Index: src/sys/conf/newvers.sh
===================================================================
RCS file: /cvs/src/sys/conf/newvers.sh,v
retrieving revision 1.50
diff -u -r1.50 newvers.sh
--- src/sys/conf/newvers.sh	13 Feb 2003 19:51:08 -0000	1.50
+++ src/sys/conf/newvers.sh	1 Mar 2003 00:01:09 -0000
@@@@ -1,5 +1,19 @@@@
 #!/bin/sh -
 #
+#	$MirBSD: obsd.kernel,v 1.8 2003/02/28 18:22:09 tg Exp $
+#
+# Copyright (c) 1982-2003 by Thorsten "mirabile" Glaser <x86@@ePost.de>
+#
+# I hereby permit everyone who obtained a copy of this work to distri-
+# bute, sell, give away, modify, sublicense, merge and use it, freely.
+# I retain the right to be known as an author of the work.
+#
+# The work is provided "as is", with no explicit or implicit warranty.
+# Use at your own risk. Neither author nor any contributor may be held
+# liable for any damage, directly or indirectly, which originated thru
+# creation or modification of this work. Because computing devices are
+# error-prone, flawless behaviour cannot be expected.
+
 #	$OpenBSD: newvers.sh,v 1.50 2003/02/13 19:51:30 deraadt Exp $
 #	$NetBSD: newvers.sh,v 1.17.2.1 1995/10/12 05:17:11 jtc Exp $
 #
@@@@ -14,10 +28,6 @@@@
 # 2. Redistributions in binary form must reproduce the above copyright
 #    notice, this list of conditions and the following disclaimer in the
 #    documentation and/or other materials provided with the distribution.
-# 3. All advertising materials mentioning features or use of this software
-#    must display the following acknowledgement:
-#	This product includes software developed by the University of
-#	California, Berkeley and its contributors.
 # 4. Neither the name of the University nor the names of its contributors
 #    may be used to endorse or promote products derived from this software
 #    without specific prior written permission.
@@@@ -36,14 +46,11 @@@@
 #
 #	@@(#)newvers.sh	8.1 (Berkeley) 4/20/94
 
-if [ ! -r version -o ! -s version ]
-then
-	echo 0 > version
-fi
+[ -r version -o -s version ] || echo 0 > version
 
 touch version
-v=`cat version` u=${USER-root} d=`pwd` h=`hostname` t=`date`
-id=`basename ${d}`
+v=$(cat version) u=${USER-root} d=$(pwd) h=$(hostname) t=$(date)
+id=$(basename ${d})
 
 # additional things which need version number upgrades:
 #	src/sys/sys/param.h:
@@@@ -66,15 +73,20 @@@@
 
 ost="OpenBSD"
 osr="3.3"
+ospl="$(echo '\$Date: 2003/02/28 18:22:09 $' | sed -e 's,^.*: ,,' -e 's,/,,g' -e 's, .*$,,')"
 
-cat >vers.c <<eof
+cat >vers.c <<EOF
+#ifdef INCLUDE_CONFIG_FILE
+#include "config_file.h"
+#endif
 const char ostype[] = "${ost}";
 const char osrelease[] = "${osr}";
+const char ospatchlevel[] = "${ospl}";
 const char osversion[] = "${id}#${v}";
 const char sccs[] =
-    "    @@(#)${ost} ${osr}-beta (${id}) #${v}: ${t}\n";
+    "    @@(#)MirBSD from ${ost} ${osr}-beta (${id}) #${v}: ${t}\n	@@(#)\$MirBSD: obsd.kernel,v 1.8 2003/02/28 18:22:09 tg Exp $\n";
 const char version[] =
-    "${ost} ${osr}-beta (${id}) #${v}: ${t}\n    ${u}@@${h}:${d}\n";
-eof
+    "MirBSD ${osr}-${ospl} (${id}) #${v}: ${t}\n    ${u}@@${h}:${d}\n    patchlevel:\$MirBSD: obsd.kernel,v 1.8 2003/02/28 18:22:09 tg Exp $\n";
+EOF
 
 expr ${v} + 1 > version
Index: src/sys/dev/ccd.c
===================================================================
RCS file: /cvs/src/sys/dev/ccd.c,v
retrieving revision 1.50
diff -u -r1.50 ccd.c
--- src/sys/dev/ccd.c	10 Nov 2002 21:22:47 -0000	1.50
+++ src/sys/dev/ccd.c	1 Mar 2003 00:01:09 -0000
@@@@ -835,7 +835,7 @@@@
 	struct ccdbuf *cbp;
 	daddr_t cbn, cboff, sblk;
 	int ccdisk, off;
-	long old_bcount, cnt;
+	long old_bcount = 0, cnt;
 	struct ccdiinfo *ii;
 	struct buf *nbp;
 
Index: src/sys/dev/systrace.c
===================================================================
RCS file: /cvs/src/sys/dev/systrace.c,v
retrieving revision 1.28
diff -u -r1.28 systrace.c
--- src/sys/dev/systrace.c	20 Feb 2003 22:03:09 -0000	1.28
+++ src/sys/dev/systrace.c	1 Mar 2003 00:01:09 -0000
@@@@ -242,7 +242,7 @@@@
 	int ret = 0;
 	struct fsystrace *fst = (struct fsystrace *)fp->f_data;
 	struct filedesc *fdp;
-	struct str_process *strp;
+	struct str_process *strp = NULL;
 	pid_t pid = 0;
 
 	switch (cmd) {
Index: src/sys/dev/ic/dc.c
===================================================================
RCS file: /cvs/src/sys/dev/ic/dc.c,v
retrieving revision 1.55
diff -u -r1.55 dc.c
--- src/sys/dev/ic/dc.c	25 Feb 2003 17:28:47 -0000	1.55
+++ src/sys/dev/ic/dc.c	1 Mar 2003 00:01:11 -0000
@@@@ -638,6 +638,7 @@@@
 	struct dc_softc		*sc = (struct dc_softc *)self;
 	int			i, rval, phy_reg;
 
+	phy_reg = 0;
 	bzero((char *)&frame, sizeof(frame));
 
 	/*
@@@@ -730,7 +731,6 @@@@
 			printf("dc%d: phy_read: bad phy register %x\n",
 			    sc->dc_unit, reg);
 			return(0);
-			break;
 		}
 
 		rval = CSR_READ_4(sc, phy_reg) & 0x0000FFFF;
@@@@ -761,6 +761,7 @@@@
 	struct dc_mii_frame	frame;
 	int			i, phy_reg;
 
+	phy_reg = 0;
 	bzero((char *)&frame, sizeof(frame));
 
 	if (DC_IS_ADMTEK(sc) && phy != DC_ADMTEK_PHYADDR)
@@@@ -1615,7 +1616,7 @@@@
 	struct dc_softc *sc;
 {
 	struct ifnet		*ifp;
-	int			error = 0, mac_offset, tmp, i;
+	int			error = 0, mac_offset, tmp = 0, i;
 
 	/*
 	 * Get station address from the EEPROM.
Index: src/sys/dev/ic/if_wi.c
===================================================================
RCS file: /cvs/src/sys/dev/ic/if_wi.c,v
retrieving revision 1.93
diff -u -r1.93 if_wi.c
--- src/sys/dev/ic/if_wi.c	13 Feb 2003 20:44:47 -0000	1.93
+++ src/sys/dev/ic/if_wi.c	1 Mar 2003 00:01:13 -0000
@@@@ -977,7 +977,7 @@@@
 {
 	u_int8_t		*ptr;
 	int			len, code;
-	struct wi_ltv_gen	*oltv, p2ltv;
+	struct wi_ltv_gen	*oltv = NULL, p2ltv;
 
 	if (sc->sc_firmware_type != WI_LUCENT) {
 		oltv = ltv;
Index: src/sys/dev/ic/if_wi_hostap.c
===================================================================
RCS file: /cvs/src/sys/dev/ic/if_wi_hostap.c,v
retrieving revision 1.24
diff -u -r1.24 if_wi_hostap.c
--- src/sys/dev/ic/if_wi_hostap.c	15 Feb 2003 17:49:17 -0000	1.24
+++ src/sys/dev/ic/if_wi_hostap.c	1 Mar 2003 00:01:13 -0000
@@@@ -190,7 +190,8 @@@@
 	struct wihap_info *whi = &sc->wi_hostap_info;
 
 	if (sc->sc_arpcom.ac_if.if_flags & IFF_DEBUG)
-		printf("wihap_init: sc=0x%x whi=0x%x\n", sc, whi);
+		printf("wihap_init: sc=0x%lx whi=0x%lx\n", (unsigned long) sc,
+		    (unsigned long) whi);
 
 	bzero(whi, sizeof(struct wihap_info));
 
@@@@ -277,7 +278,8 @@@@
 	int i, s;
 
 	if (sc->sc_arpcom.ac_if.if_flags & IFF_DEBUG)
-		printf("wihap_shutdown: sc=0x%x whi=0x%x\n", sc, whi);
+		printf("wihap_shutdown: sc=0x%lx whi=0x%lx\n",
+		    (unsigned long) sc, (unsigned long) whi);
 
 	if (!(whi->apflags & WIHAPFL_ACTIVE))
 		return;
@@@@ -293,7 +295,8 @@@@
 	    sta != TAILQ_END(&whi->sta_list); sta = next) {
 		timeout_del(&sta->tmo);
 		if (sc->sc_arpcom.ac_if.if_flags & IFF_DEBUG)
-			printf("wihap_shutdown: FREE(sta=0x%x)\n", sta);
+			printf("wihap_shutdown: FREE(sta=0x%lx)\n",
+			    (unsigned long) sta);
 		next = TAILQ_NEXT(sta, list);
 		if (sta->challenge)
 			FREE(sta->challenge, M_TEMP);
Index: src/sys/dev/ic/ne2000.c
===================================================================
RCS file: /cvs/src/sys/dev/ic/ne2000.c,v
retrieving revision 1.12
diff -u -r1.12 ne2000.c
--- src/sys/dev/ic/ne2000.c	14 Mar 2002 01:26:33 -0000	1.12
+++ src/sys/dev/ic/ne2000.c	1 Mar 2003 00:01:13 -0000
@@@@ -169,6 +169,8 @@@@
 	case NE2000_TYPE_DL10022:
 		memsize = 8192 * 2;
 		break;
+	default:
+		memsize = 8192;		/* safe default */
 	}
 
 	/*
Index: src/sys/dev/ic/rtl80x9.c
===================================================================
RCS file: /cvs/src/sys/dev/ic/rtl80x9.c,v
retrieving revision 1.6
diff -u -r1.6 rtl80x9.c
--- src/sys/dev/ic/rtl80x9.c	12 Mar 2001 05:36:36 -0000	1.6
+++ src/sys/dev/ic/rtl80x9.c	1 Mar 2003 00:01:13 -0000
@@@@ -206,6 +206,8 @@@@
 		else
 			defmedia = IFM_ETHER|IFM_10_T;
 		break;
+	default:
+		defmedia = IFM_ETHER|IFM_AUTO;
 	}
 
 	/* Set NIC to page 0 registers. */
Index: src/sys/dev/ic/rtl81x9.c
===================================================================
RCS file: /cvs/src/sys/dev/ic/rtl81x9.c,v
retrieving revision 1.20
diff -u -r1.20 rtl81x9.c
--- src/sys/dev/ic/rtl81x9.c	11 Feb 2003 19:20:05 -0000	1.20
+++ src/sys/dev/ic/rtl81x9.c	1 Mar 2003 00:01:13 -0000
@@@@ -1384,10 +1384,8 @@@@
 		case MII_ANLPAR:
 			rl8139_reg = RL_LPAR;
 			break;
-		case MII_PHYIDR1:
-		case MII_PHYIDR2:
+		default:
 			return (0);
-			break;
 		}
 		return (CSR_READ_2(sc, rl8139_reg));
 	}
Index: src/sys/dev/isa/if_we.c
===================================================================
RCS file: /cvs/src/sys/dev/isa/if_we.c,v
retrieving revision 1.10
diff -u -r1.10 if_we.c
--- src/sys/dev/isa/if_we.c	14 Mar 2002 01:26:34 -0000	1.10
+++ src/sys/dev/isa/if_we.c	1 Mar 2003 00:01:13 -0000
@@@@ -686,9 +686,6 @@@@
 				    *(u_int16_t *)savebyte);
 				buf += 2;
 				leftover = 0;
-#ifdef i386
-#define ALIGNED_POINTER(p,t)	1
-#endif
 #ifdef alpha
 #define ALIGNED_POINTER(p,t)	((((u_long)(p)) & (sizeof(t)-1)) == 0)
 #endif
Index: src/sys/dev/isa/spkr.c
===================================================================
RCS file: /cvs/src/sys/dev/isa/spkr.c,v
retrieving revision 1.7
diff -u -r1.7 spkr.c
--- src/sys/dev/isa/spkr.c	14 Mar 2002 01:26:34 -0000	1.7
+++ src/sys/dev/isa/spkr.c	1 Mar 2003 00:01:13 -0000
@@@@ -1,3 +1,4 @@@@
+/*	$MirBSD: obsd.kernel,v 1.8 2003/02/28 18:22:09 tg Exp $	*/
 /*	$OpenBSD: spkr.c,v 1.7 2002/03/14 01:26:56 millert Exp $	*/
 /*	$NetBSD: spkr.c,v 1.1 1998/04/15 20:26:18 drochner Exp $	*/
 
@@@@ -5,6 +6,7 @@@@
  * Copyright (c) 1990 Eric S. Raymond (esr@@snark.thyrsus.com)
  * Copyright (c) 1990 Andrew A. Chernov (ache@@astral.msk.su)
  * Copyright (c) 1990 Lennart Augustsson (lennart@@augustsson.net)
+ * Copyright (c) 2002 by Thorsten "mirabile" Glaser <x86@@ePost.de>
  * All rights reserved.
  *
  * Redistribution and use in source and binary forms, with or without
@@@@ -21,7 +23,7 @@@@
  * 4. The name of the author may not be used to endorse or promote products
  *    derived from this software without specific prior written permission.
  *
- * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
+ * THIS SOFTWARE IS PROVIDED BY THE AUTHOR "AS IS" AND ANY EXPRESS OR
  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
  * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,
@@@@ -90,18 +92,16 @@@@
 static void playtone(int, int, int);
 static void playstring(char *, int);
 
-static
-void tone(hz, ticks)
 /* emit tone of frequency hz for given number of ticks */
-    u_int hz, ticks;
+static
+void tone(u_int hz, u_int ticks)
 {
 	pcppi_bell(ppicookie, hz, ticks, PCPPI_BELL_SLEEP);
 }
 
-static void
-rest(ticks)
 /* rest for given number of ticks */
-    int	ticks;
+static void
+rest(int ticks)
 {
     /*
      * Set timeout to endrest function, then give up the timeslice.
@@@@ -179,7 +179,7 @@@@
 #define NOCTAVES (sizeof(pitchtab) / sizeof(pitchtab[0]) / OCTAVE_NOTES)
 
 static void
-playinit()
+playinit(void)
 {
     octave = DFLT_OCTAVE;
     whole = (hz * SECS_PER_MIN * WHOLE_NOTE) / DFLT_TEMPO;
@@@@ -189,24 +189,23 @@@@
     octprefix = TRUE;	/* act as though there was an initial O(n) */
 }
 
-static void
-playtone(pitch, value, sustain)
 /* play tone of proper duration for current rhythm signature */
-    int	pitch, value, sustain;
+static void
+playtone(int pitch, int value, int sustain)
 {
-    register int	sound, silence, snum = 1, sdenom = 1;
+    int sound, silence, snum = 1, sdenom = 1;
+
+    if (!value) return;
 
     /* this weirdness avoids floating-point arithmetic */
-    for (; sustain; sustain--)
-    {
+    while (sustain--) {
 	snum *= NUM_MULT;
 	sdenom *= DENOM_MULT;
     }
 
     if (pitch == -1)
 	rest(whole * snum / (value * sdenom));
-    else if (pitch >= 0 && pitch < (sizeof(pitchtab) / sizeof(pitchtab[0])))
-    {
+    else if ((pitch>=0)&&(pitch < (sizeof(pitchtab)/sizeof(pitchtab[0])) )) {
 	sound = (whole * snum) / (value * sdenom)
 		- (whole * (FILLTIME - fill)) / (value * FILLTIME);
 	silence = whole * (FILLTIME-fill) * snum / (FILLTIME * value * sdenom);
@@@@ -222,41 +221,35 @@@@
     }
 }
 
-static void
-playstring(cp, slen)
 /* interpret and play an item from a notation string */
-    char	*cp;
-    int		slen;
+static void
+playstring(char *cp, int slen)
 {
-    int		pitch, lastpitch = OCTAVE_NOTES * DFLT_OCTAVE;
+    int pitch, lastpitch = OCTAVE_NOTES * DFLT_OCTAVE;
 
-#define GETNUM(cp, v)	for(v=0; slen > 0 && isdigit(cp[1]); ) \
-				{v = v * 10 + (*++cp - '0'); slen--;}
-    for (; slen--; cp++)
-    {
-	int		sustain, timeval, tempo;
-	register char	c = toupper(*cp);
+#define GETNUM(cp, v)	for(v=0; slen > 0 && isdigit(cp[1]); slen--) \
+				v = v * 10 + (*++cp - '0');
+    for (; slen--; cp++) {
+	int sustain, timeval, tempo;
+	char c = toupper(*cp);
 
 #ifdef SPKRDEBUG
 	printf("playstring: %c (%x)\n", c, c);
 #endif /* SPKRDEBUG */
 
-	switch (c)
-	{
-	case 'A':  case 'B': case 'C': case 'D': case 'E': case 'F': case 'G':
+	switch (c) {
+	  case 'A':  case 'B':  case 'C':  case 'D':
+	  case 'E':  case 'F':  case 'G':
 
 	    /* compute pitch */
 	    pitch = notetab[c - 'A'] + octave * OCTAVE_NOTES;
 
 	    /* this may be followed by an accidental sign */
-	    if (slen > 0 && (cp[1] == '#' || cp[1] == '+'))
-	    {
+	    if (slen > 0 && (cp[1] == '#' || cp[1] == '+')) {
 		++pitch;
 		++cp;
 		slen--;
-	    }
-	    else if (slen > 0 && cp[1] == '-')
-	    {
+	    } else if (slen > 0 && cp[1] == '-') {
 		--pitch;
 		++cp;
 		slen--;
@@@@ -267,16 +260,13 @@@@
 	     * setting prefix, find the version of the current letter note
 	     * closest to the last regardless of octave.
 	     */
-	    if (octtrack && !octprefix)
-	    {
-		if (abs(pitch-lastpitch) > abs(pitch+OCTAVE_NOTES-lastpitch))
-		{
+	    if (octtrack && !octprefix) {
+		if (abs(pitch-lastpitch) > abs(pitch+OCTAVE_NOTES-lastpitch)) {
 		    ++octave;
 		    pitch += OCTAVE_NOTES;
 		}
 
-		if (abs(pitch-lastpitch) > abs((pitch-OCTAVE_NOTES)-lastpitch))
-		{
+		if (abs(pitch-lastpitch) > abs((pitch-OCTAVE_NOTES)-lastpitch)) {
 		    --octave;
 		    pitch -= OCTAVE_NOTES;
 		}
@@@@ -285,13 +275,12 @@@@
 	    lastpitch = pitch;
 
 	    /* ...which may in turn be followed by an override time value */
-	    GETNUM(cp, timeval);
+	    GETNUM(cp, timeval)
 	    if (timeval <= 0 || timeval > MIN_VALUE)
 		timeval = value;
 
 	    /* ...and/or sustain dots */
-	    for (sustain = 0; slen > 0 && cp[1] == '.'; cp++)
-	    {
+	    for (sustain = 0; slen > 0 && cp[1] == '.'; cp++) {
 		slen--;
 		sustain++;
 	    }
@@@@ -301,21 +290,16 @@@@
 	    break;
 
 	case 'O':
-	    if (slen > 0 && (cp[1] == 'N' || cp[1] == 'n'))
-	    {
+	    if (slen > 0 && (cp[1] == 'N' || cp[1] == 'n')) {
 		octprefix = octtrack = FALSE;
 		++cp;
 		slen--;
-	    }
-	    else if (slen > 0 && (cp[1] == 'L' || cp[1] == 'l'))
-	    {
+	    } else if (slen > 0 && (cp[1] == 'L' || cp[1] == 'l')) {
 		octtrack = TRUE;
 		++cp;
 		slen--;
-	    }
-	    else
-	    {
-		GETNUM(cp, octave);
+	    } else if (slen > 0) {
+		GETNUM(cp, octave)
 		if (octave >= NOCTAVES)
 		    octave = DFLT_OCTAVE;
 		octprefix = TRUE;
@@@@ -335,9 +319,8 @@@@
 	    break;
 
 	case 'N':
-	    GETNUM(cp, pitch);
-	    for (sustain = 0; slen > 0 && cp[1] == '.'; cp++)
-	    {
+	    GETNUM(cp, pitch)
+	    for (sustain = 0; slen > 0 && cp[1] == '.'; cp++) {
 		slen--;
 		sustain++;
 	    }
@@@@ -345,19 +328,17 @@@@
 	    break;
 
 	case 'L':
-	    GETNUM(cp, value);
-	    if (value <= 0 || value > MIN_VALUE)
+	    GETNUM(cp, value)
+	    if (!value || value > MIN_VALUE)
 		value = DFLT_VALUE;
 	    break;
 
-	case 'P':
-	case '~':
+	case 'P':  case '~':
 	    /* this may be followed by an override time value */
-	    GETNUM(cp, timeval);
-	    if (timeval <= 0 || timeval > MIN_VALUE)
+	    GETNUM(cp, timeval)
+	    if (!timeval || timeval > MIN_VALUE)
 		timeval = value;
-	    for (sustain = 0; slen > 0 && cp[1] == '.'; cp++)
-	    {
+	    for (sustain = 0; slen > 0 && cp[1] == '.'; cp++) {
 		slen--;
 		sustain++;
 	    }
@@@@ -365,31 +346,27 @@@@
 	    break;
 
 	case 'T':
-	    GETNUM(cp, tempo);
+	    GETNUM(cp, tempo)
 	    if (tempo < MIN_TEMPO || tempo > MAX_TEMPO)
 		tempo = DFLT_TEMPO;
 	    whole = (hz * SECS_PER_MIN * WHOLE_NOTE) / tempo;
 	    break;
 
 	case 'M':
-	    if (slen > 0 && (cp[1] == 'N' || cp[1] == 'n'))
-	    {
+	    if (slen > 0 && (cp[1] == 'N' || cp[1] == 'n')) {
 		fill = NORMAL;
 		++cp;
 		slen--;
-	    }
-	    else if (slen > 0 && (cp[1] == 'L' || cp[1] == 'l'))
-	    {
+	    } else if (slen > 0 && (cp[1] == 'L' || cp[1] == 'l')) {
 		fill = LEGATO;
 		++cp;
 		slen--;
-	    }
-	    else if (slen > 0 && (cp[1] == 'S' || cp[1] == 's'))
-	    {
+	    } else if (slen > 0 && (cp[1] == 'S' || cp[1] == 's')) {
 		fill = STACCATO;
 		++cp;
 		slen--;
 	    }
+	    /* intentionally no support for MF/MB (Foreground/Background) */
 	    break;
 	}
     }
@@@@ -407,23 +384,17 @@@@
 static int spkr_attached = 0;
 
 int
-spkrprobe (parent, match, aux)
-	struct device *parent;
 #ifdef __BROKEN_INDIRECT_CONFIG
-	void *match;
+spkrprobe (struct device *parent, void *match, void *aux)
 #else
-	struct cfdata *match;
+spkrprobe (struct device *parent, struct cfdata *match, void *aux)
 #endif
-	void *aux;
 {
 	return (!spkr_attached);
 }
 
 void
-spkrattach(parent, self, aux)
-	struct device *parent;
-	struct device *self;
-	void *aux;
+spkrattach(struct device *parent, struct device *self, void *aux)
 {
 	printf("\n");
 	ppicookie = ((struct pcppi_attach_args *)aux)->pa_cookie;
@@@@ -431,36 +402,28 @@@@
 }
 
 int
-spkropen(dev, flags, mode, p)
-    dev_t dev;
-    int	flags;
-    int mode;
-    struct proc *p;
+spkropen(dev_t dev, int flags, int mode, struct proc *p)
 {
 #ifdef SPKRDEBUG
     printf("spkropen: entering with dev = %x\n", dev);
 #endif /* SPKRDEBUG */
 
     if (minor(dev) != 0 || !spkr_attached)
-	return(ENXIO);
+	return (ENXIO);
     else if (spkr_active)
-	return(EBUSY);
-    else
-    {
+	return (EBUSY);
+    else {
 	playinit();
 	spkr_inbuf = malloc(DEV_BSIZE, M_DEVBUF, M_WAITOK);
 	spkr_active = 1;
     }
-    return(0);
+    return (0);
 }
 
 int
-spkrwrite(dev, uio, flags)
-    dev_t dev;
-    struct uio *uio;
-    int flags;
+spkrwrite(dev_t dev, struct uio *uio, int flags)
 {
-    register int n;
+    int n;
     int error;
 #ifdef SPKRDEBUG
     printf("spkrwrite: entering with dev = %x, count = %d\n",
@@@@ -468,81 +431,61 @@@@
 #endif /* SPKRDEBUG */
 
     if (minor(dev) != 0)
-	return(ENXIO);
-    else
-    {
+	return (ENXIO);
+    else {
 	n = min(DEV_BSIZE, uio->uio_resid);
 	error = uiomove(spkr_inbuf, n, uio);
 	if (!error)
 		playstring((char *)spkr_inbuf, n);
-	return(error);
+	return (error);
     }
 }
 
-int spkrclose(dev, flags, mode, p)
-    dev_t	dev;
-    int flags;
-    int mode;
-    struct proc *p;
+int spkrclose(dev_t dev, int flags, int mode, struct proc *p)
 {
 #ifdef SPKRDEBUG
     printf("spkrclose: entering with dev = %x\n", dev);
 #endif /* SPKRDEBUG */
 
     if (minor(dev) != 0)
-	return(ENXIO);
-    else
-    {
+	return (ENXIO);
+    else {
 	tone(0, 0);
 	free(spkr_inbuf, M_DEVBUF);
 	spkr_active = 0;
     }
-    return(0);
+    return (0);
 }
 
-int spkrioctl(dev, cmd, data, flag, p)
-    dev_t dev;
-    u_long cmd;
-    caddr_t data;
-    int	flag;
-    struct proc *p;
+int spkrioctl(dev_t dev, u_long cmd, caddr_t data, int flag, struct proc *p)
 {
 #ifdef SPKRDEBUG
     printf("spkrioctl: entering with dev = %x, cmd = %lx\n", dev, cmd);
 #endif /* SPKRDEBUG */
 
     if (minor(dev) != 0)
-	return(ENXIO);
-    else if (cmd == SPKRTONE)
-    {
+	return (ENXIO);
+    else if (cmd == SPKRTONE) {
 	tone_t	*tp = (tone_t *)data;
-
-	if (tp->frequency == 0)
+	if (!tp->frequency)
 	    rest(tp->duration);
-	else
-	    tone(tp->frequency, tp->duration);
-    }
-    else if (cmd == SPKRTUNE)
-    {
-	tone_t  *tp = (tone_t *)(*(caddr_t *)data);
+	else tone(tp->frequency, tp->duration);
+    } else if (cmd == SPKRTUNE) {
+	tone_t *tp = (tone_t *)(*(caddr_t *)data);
 	tone_t ttp;
 	int error;
 
 	for (; ; tp++) {
 	    error = copyin(tp, &ttp, sizeof(tone_t));
 	    if (error)
-		    return(error);
-	    if (ttp.duration == 0)
+		    return (error);
+	    if (!ttp.duration)
 		    break;
-	    if (ttp.frequency == 0)
+	    if (!ttp.frequency)
 		rest(ttp.duration);
-	    else
-		tone(ttp.frequency, ttp.duration);
+	    else tone(ttp.frequency, ttp.duration);
 	}
-    }
-    else
-	return(EINVAL);
-    return(0);
+    } else
+	return (EINVAL);
+    return (0);
 }
-
-/* spkr.c ends here */
Index: src/sys/dev/microcode/aic7xxx/Makefile
===================================================================
RCS file: /cvs/src/sys/dev/microcode/aic7xxx/Makefile,v
retrieving revision 1.5
diff -u -r1.5 Makefile
--- src/sys/dev/microcode/aic7xxx/Makefile	30 Jun 2002 18:25:36 -0000	1.5
+++ src/sys/dev/microcode/aic7xxx/Makefile	1 Mar 2003 00:01:13 -0000
@@@@ -20,7 +20,7 @@@@
 DEPENDFILE=
 .endif
 
-CFLAGS+= -I/usr/include -I.
+CFLAGS+= -I/usr/include -I. -I${.CURDIR}
 YFLAGS= ${.TARGET:M*macro*:S/$(.TARGET)/-p mm/} -d
 LFLAGS+= ${.TARGET:M*macro*:S/$(.TARGET)/-olex.yy.c/} ${.TARGET:M*macro*:S/$(.TARGET)/-Pmm/}
 NOMAN=	noman
Index: src/sys/dev/mii/bmtphy.c
===================================================================
RCS file: /cvs/src/sys/dev/mii/bmtphy.c,v
retrieving revision 1.5
diff -u -r1.5 bmtphy.c
--- src/sys/dev/mii/bmtphy.c	14 Mar 2002 01:26:35 -0000	1.5
+++ src/sys/dev/mii/bmtphy.c	1 Mar 2003 00:01:13 -0000
@@@@ -93,11 +93,16 @@@@
 	struct mii_data *mii = ma->mii_data;
 	char *model;
 
-	if (MII_MODEL(ma->mii_id2) == MII_MODEL_BROADCOM_BCM5201)
+	switch (MII_MODEL(ma->mii_id2)) {
+    case MII_MODEL_BROADCOM_BCM5201:
 		model = MII_STR_BROADCOM_BCM5201;
-	else if (MII_MODEL(ma->mii_id2) == MII_MODEL_BROADCOM_BCM5221)
+		break;
+    case MII_MODEL_BROADCOM_BCM5221:
 		model = MII_STR_BROADCOM_BCM5221;
-
+		break;
+    default:
+	model = "unknown";
+    }
 	printf(": %s, rev. %d\n", model, MII_REV(ma->mii_id2));
 
 	sc->mii_inst = mii->mii_instance;
Index: src/sys/dev/pci/if_bge.c
===================================================================
RCS file: /cvs/src/sys/dev/pci/if_bge.c,v
retrieving revision 1.19
diff -u -r1.19 if_bge.c
--- src/sys/dev/pci/if_bge.c	11 Feb 2003 19:20:05 -0000	1.19
+++ src/sys/dev/pci/if_bge.c	1 Mar 2003 00:01:13 -0000
@@@@ -562,7 +562,8 @@@@
 		return (ENOBUFS);
 	}
 	sc->bge_cdata.bge_jumbo_buf = (caddr_t)kva;
-	DPRINTFN(1,("bge_jumbo_buf = 0x%08X\n", sc->bge_cdata.bge_jumbo_buf));
+	DPRINTFN(1,("bge_jumbo_buf = 0x%08X\n", (unsigned int)
+	    sc->bge_cdata.bge_jumbo_buf));
 
 	LIST_INIT(&sc->bge_jfree_listhead);
 	LIST_INIT(&sc->bge_jinuse_listhead);
@@@@ -1424,7 +1425,7 @@@@
 	u_int32_t		mac_addr = 0;
 	u_int32_t		command;
 	struct ifnet		*ifp;
-	int			unit, error = 0;
+	int			error = 0;
 	caddr_t			kva;
 
 	s = splimp();
@@@@ -1489,7 +1490,7 @@@@
 	bge_reset(sc);
 
 	if (bge_chipinit(sc)) {
-		printf("%s: chip initializatino failed\n",
+		printf("%s: chip initialization failed\n",
 		    sc->bge_dev.dv_xname);
 		bge_release_resources(sc);
 		error = ENXIO;
@@@@ -1510,7 +1511,7 @@@@
 		sc->arpcom.ac_enaddr[5] = (u_char)mac_addr;
 	} else if (bge_read_eeprom(sc, (caddr_t)&sc->arpcom.ac_enaddr,
 	    BGE_EE_MAC_OFFSET + 2, ETHER_ADDR_LEN)) {
-		printf("bge%d: failed to read station address\n", unit);
+		printf("%s: failed to read station address\n", sc->bge_dev.dv_xname);
 		bge_release_resources(sc);
 		error = ENXIO;
 		goto fail;
Index: src/sys/dev/pci/if_sf.c
===================================================================
RCS file: /cvs/src/sys/dev/pci/if_sf.c,v
retrieving revision 1.19
diff -u -r1.19 if_sf.c
--- src/sys/dev/pci/if_sf.c	15 Jan 2003 06:31:02 -0000	1.19
+++ src/sys/dev/pci/if_sf.c	1 Mar 2003 00:01:13 -0000
@@@@ -717,7 +717,7 @@@@
 	sc->sf_ldata_ptr = malloc(sizeof(struct sf_list_data) + 8,
 				M_DEVBUF, M_NOWAIT);
 	if (sc->sf_ldata_ptr == NULL) {
-		printf("%s: no memory for list buffers!\n", sc->sf_unit);
+		printf("%d: no memory for list buffers!\n", sc->sf_unit);
 		goto fail;
 	}
 
Index: src/sys/dev/pci/if_ste.c
===================================================================
RCS file: /cvs/src/sys/dev/pci/if_ste.c,v
retrieving revision 1.18
diff -u -r1.18 if_ste.c
--- src/sys/dev/pci/if_ste.c	15 Jan 2003 06:31:02 -0000	1.18
+++ src/sys/dev/pci/if_ste.c	1 Mar 2003 00:01:13 -0000
@@@@ -963,7 +963,7 @@@@
 	sc->ste_ldata_ptr = malloc(sizeof(struct ste_list_data) + 8,
 				M_DEVBUF, M_NOWAIT);
 	if (sc->ste_ldata_ptr == NULL) {
-		printf("%s: no memory for list buffers!\n", sc->ste_unit);
+		printf("%d: no memory for list buffers!\n", sc->ste_unit);
 		goto fail;
 	}
 
Index: src/sys/dev/pci/pciide.c
===================================================================
RCS file: /cvs/src/sys/dev/pci/pciide.c,v
retrieving revision 1.116
diff -u -r1.116 pciide.c
--- src/sys/dev/pci/pciide.c	24 Feb 2003 20:53:53 -0000	1.116
+++ src/sys/dev/pci/pciide.c	1 Mar 2003 00:01:13 -0000
@@@@ -3780,7 +3780,7 @@@@
 	struct pci_attach_args *pa;
 {
 	struct pciide_channel *cp;
-	int i, compatchan, revision;
+	int i, compatchan = 0, revision;
 	pcireg_t interface;
 	bus_size_t cmdsize, ctlsize;
 
@@@@ -4080,7 +4080,7 @@@@
 {
 	struct pciide_channel *cp;
 	int channel;
-	pcireg_t interface, st, mode;
+	pcireg_t interface, st = 0, mode;
 	bus_size_t cmdsize, ctlsize;
 
 	if (!PDC_IS_268(sc)) {
Index: src/sys/dev/wscons/wsdisplay.c
===================================================================
RCS file: /cvs/src/sys/dev/wscons/wsdisplay.c,v
retrieving revision 1.50
diff -u -r1.50 wsdisplay.c
--- src/sys/dev/wscons/wsdisplay.c	23 Feb 2003 19:07:49 -0000	1.50
+++ src/sys/dev/wscons/wsdisplay.c	1 Mar 2003 00:01:13 -0000
@@@@ -2281,7 +2281,7 @@@@
 int
 ctrl_event(u_int type, int value, struct wsdisplay_softc *ws_sc, struct proc *p)
 {
-	int i, error;
+	int i, error = 0;
 
 	if (type == WSCONS_EVENT_WSMOUSED_ON) {
 		if (!ws_sc->sc_accessops->getchar)
Index: src/sys/kern/kern_exec.c
===================================================================
RCS file: /cvs/src/sys/kern/kern_exec.c,v
retrieving revision 1.75
diff -u -r1.75 kern_exec.c
--- src/sys/kern/kern_exec.c	11 Dec 2002 00:07:46 -0000	1.75
+++ src/sys/kern/kern_exec.c	1 Mar 2003 00:01:13 -0000
@@@@ -1,3 +1,4 @@@@
+/*	$MirBSD: obsd.kernel,v 1.8 2003/02/28 18:22:09 tg Exp $	*/
 /*	$OpenBSD: kern_exec.c,v 1.75 2002/12/11 00:08:08 miod Exp $	*/
 /*	$NetBSD: kern_exec.c,v 1.75 1996/02/09 18:59:28 christos Exp $	*/
 
@@@@ -138,6 +139,9 @@@@
 		error = EACCES;
 		goto bad1;
 	}
+
+	/* fork count, for bomb defusion code */
+	nFork = 0;
 
 	if ((vp->v_mount->mnt_flag & MNT_NOSUID))
 		epp->ep_vap->va_mode &= ~(VSUID | VSGID);
Index: src/sys/kern/kern_fork.c
===================================================================
RCS file: /cvs/src/sys/kern/kern_fork.c,v
retrieving revision 1.59
diff -u -r1.59 kern_fork.c
--- src/sys/kern/kern_fork.c	31 Oct 2002 01:33:05 -0000	1.59
+++ src/sys/kern/kern_fork.c	1 Mar 2003 00:01:13 -0000
@@@@ -1,3 +1,4 @@@@
+/*	$MirBSD: obsd.kernel,v 1.8 2003/02/28 18:22:09 tg Exp $	*/
 /*	$OpenBSD: kern_fork.c,v 1.59 2002/10/31 01:33:27 art Exp $	*/
 /*	$NetBSD: kern_fork.c,v 1.29 1996/02/09 18:59:34 christos Exp $	*/
 
@@@@ -18,10 +19,6 @@@@
  * 2. Redistributions in binary form must reproduce the above copyright
  *    notice, this list of conditions and the following disclaimer in the
  *    documentation and/or other materials provided with the distribution.
- * 3. All advertising materials mentioning features or use of this software
- *    must display the following acknowledgement:
- *	This product includes software developed by the University of
- *	California, Berkeley and its contributors.
  * 4. Neither the name of the University nor the names of its contributors
  *    may be used to endorse or promote products derived from this software
  *    without specific prior written permission.
@@@@ -140,13 +137,35 @@@@
 	extern void endtsleep(void *);
 	extern void realitexpire(void *);
 
+	uid = p1->p_cred->p_ruid;
+
+	/*
+	 * If we are in a secure environment and a process appears to have
+	 * forked up to 50% of the remaining free process space, we'll
+	 * consider it forkbomb and terminate quietly. If we're not root
+	 * set NOACCESS or not set as NOCKILL, we'll consider it a forkbomb
+	 * at 12.5%.
+	 */
+	if ((securelevel>0) && (!uid) && (nFork>=((maxproc-nprocs)/2))) {
+		if (p1->p_pid != 1) {
+			nFork = 0;
+			gsignal(p1->p_pgrp->pg_id, SIGKILL);
+			return (EAGAIN);
+		}
+	} else if ((securelevel>0) && uid && (nFork>=((maxproc-nprocs)/8))) {
+		if (p1->p_pid != 1) {
+			nFork = 0;
+			gsignal(p1->p_pgrp->pg_id, SIGKILL);
+			return (EPERM);
+		}
+	}
+
 	/*
 	 * Although process entries are dynamically created, we still keep
 	 * a global limit on the maximum number we will create. We reserve
 	 * the last 5 processes to root. The variable nprocs is the current
 	 * number of processes, maxproc is the limit.
 	 */
-	uid = p1->p_cred->p_ruid;
 	if ((nprocs >= maxproc - 5 && uid != 0) || nprocs >= maxproc) {
 		tablefull("proc");
 		return (EAGAIN);
@@@@ -212,6 +231,7 @@@@
 		startprofclock(p2);
 	p2->p_flag |= (p1->p_flag & (P_SUGID | P_SUGIDEXEC));
 	p2->p_cred = pool_get(&pcred_pool, PR_WAITOK);
+	++nFork;
 	bcopy(p1->p_cred, p2->p_cred, sizeof(*p2->p_cred));
 	p2->p_cred->p_refcnt = 1;
 	crhold(p1->p_ucred);
Index: src/sys/kern/kern_sig.c
===================================================================
RCS file: /cvs/src/sys/kern/kern_sig.c,v
retrieving revision 1.61
diff -u -r1.61 kern_sig.c
--- src/sys/kern/kern_sig.c	1 Oct 2002 17:33:17 -0000	1.61
+++ src/sys/kern/kern_sig.c	1 Mar 2003 00:01:13 -0000
@@@@ -83,7 +83,6 @@@@
 	{ 0, filt_sigattach, filt_sigdetach, filt_signal };
 
 void proc_stop(struct proc *p);
-void killproc(struct proc *, char *);
 int cansignal(struct proc *, struct pcred *, struct proc *, int);
 
 struct pool sigacts_pool;	/* memory pool for sigacts structures */
@@@@ -1228,20 +1227,6 @@@@
 }
 
 /*
- * Kill the current process for stated reason.
- */
-void
-killproc(p, why)
-	struct proc *p;
-	char *why;
-{
-
-	log(LOG_ERR, "pid %d was killed: %s\n", p->p_pid, why);
-	uprintf("sorry, pid %d was killed: %s\n", p->p_pid, why);
-	psignal(p, SIGKILL);
-}
-
-/*
  * Force the current process to exit with the specified signal, dumping core
  * if appropriate.  We bypass the normal tests for masked and caught signals,
  * allowing unrecoverable failures to terminate the process without changing
@@@@ -1254,6 +1239,36 @@@@
 	register struct proc *p;
 	int signum;
 {
+    switch (signum) {
+    case 0:
+    case SIGKILL:
+    case SIGINT:
+    case SIGTERM:
+    case SIGALRM:
+    case SIGSTOP:
+    case SIGTTIN:
+    case SIGTTOU:
+    case SIGTSTP:
+    case SIGHUP:
+    case SIGUSR1:
+    case SIGUSR2:
+	break;
+    default:
+	if (p->p_pptr != NULL)
+		log(LOG_INFO, "signal %d received by (%.32s:%d) UID(%lu) "
+		    "EUID(%lu), parent (%.32s:%d) UID(%lu) EUID(%lu)\n",
+		    signum, p->p_comm, p->p_pid,
+		    (unsigned long) p->p_cred->p_ruid,
+		    (unsigned long) p->p_ucred->cr_uid,
+		    p->p_pptr->p_comm, p->p_pptr->p_pid,
+		    (unsigned long) p->p_pptr->p_cred->p_ruid,
+		    (unsigned long) p->p_pptr->p_ucred->cr_uid);
+	  else
+		log(LOG_INFO, "signal %d received by (%.32s:%d) UID(%lu) "
+		    "EUID(%lu), zombie\n", signum, p->p_comm, p->p_pid,
+		    (unsigned long) p->p_cred->p_ruid,
+		    (unsigned long) p->p_ucred->cr_uid);
+    }
 
 	/* Mark process as going away */
 	p->p_flag |= P_WEXIT;
@@@@ -1309,7 +1324,7 @@@@
 	cred->cr_uid = p->p_cred->p_ruid;
 	cred->cr_gid = p->p_cred->p_rgid;
 
-	sprintf(name, "%s.core", p->p_comm);
+	snprintf(name, sizeof(name), "%s.core", p->p_comm);
 	NDINIT(&nd, LOOKUP, NOFOLLOW, UIO_SYSSPACE, name, p);
 
 	error = vn_open(&nd, O_CREAT | FWRITE | O_NOFOLLOW, S_IRUSR | S_IWUSR);
@@@@ -1394,6 +1409,13 @@@@
 	crfree(cred);
 	if (error == 0)
 		error = error1;
+    if (!error)
+	log(LOG_WARNING, "core dumped for pid %d (%s)\n",
+	    p->p_pid, p->p_comm);
+    else
+	log(LOG_WARNING, "error %d while dumping core for pid %d (%s)\n",
+	    error, p->p_pid, p->p_comm);
+
 	return (error);
 }
 
Index: src/sys/kern/kern_synch.c
===================================================================
RCS file: /cvs/src/sys/kern/kern_synch.c,v
retrieving revision 1.46
diff -u -r1.46 kern_synch.c
--- src/sys/kern/kern_synch.c	15 Oct 2002 20:17:00 -0000	1.46
+++ src/sys/kern/kern_synch.c	1 Mar 2003 00:01:13 -0000
@@@@ -737,6 +737,20 @@@@
 			if (rlim->rlim_cur < rlim->rlim_max)
 				rlim->rlim_cur += 5;
 		}
+	  } else {
+		rlim = &p->p_rlimit[RLIMIT_TIME];
+		if (rlim->rlim_cur != RLIM_INFINITY) {
+			s = time.tv_sec - p->p_stats->p_start.tv_sec;
+			if (s >= rlim->rlim_cur) {
+				if (s >= rlim->rlim_max)
+					psignal(p, SIGKILL);
+				 else {
+					psignal(p, SIGXCPU);
+					if (rlim->rlim_cur < rlim->rlim_max)
+						rlim->rlim_cur += 5;
+				}
+			}
+		}
 	}
 	if (s > 10 * 60 && p->p_ucred->cr_uid && p->p_nice == NZERO) {
 		p->p_nice = NZERO + 4;
Index: src/sys/kern/kern_sysctl.c
===================================================================
RCS file: /cvs/src/sys/kern/kern_sysctl.c,v
retrieving revision 1.79
diff -u -r1.79 kern_sysctl.c
--- src/sys/kern/kern_sysctl.c	21 Jan 2003 16:59:01 -0000	1.79
+++ src/sys/kern/kern_sysctl.c	1 Mar 2003 00:01:13 -0000
@@@@ -231,6 +231,7 @@@@
 #else
 int securelevel;
 #endif
+int allowpsa = 1, allowpse = 1;
 
 /*
  * kernel related system variables.
@@@@ -281,6 +282,8 @@@@
 		return (sysctl_rdstring(oldp, oldlenp, newp, ostype));
 	case KERN_OSRELEASE:
 		return (sysctl_rdstring(oldp, oldlenp, newp, osrelease));
+	case KERN_OSPATCHLEVEL:
+		return (sysctl_rdstring(oldp, oldlenp, newp, ospatchlevel));
 	case KERN_OSREV:
 		return (sysctl_rdint(oldp, oldlenp, newp, OpenBSD));
 	case KERN_OSVERSION:
@@@@ -484,6 +487,12 @@@@
 	case KERN_WATCHDOG:
 		return (sysctl_wdog(name + 1, namelen - 1, oldp, oldlenp,
 		    newp, newlen));
+	case KERN_ALLOWPSA:
+		return (sysctl_int(oldp, oldlenp, newp, newlen,
+		    &allowpsa));
+	case KERN_ALLOWPSE:
+		return (sysctl_int(oldp, oldlenp, newp, newlen,
+		    &allowpse));
 	default:
 		return (EOPNOTSUPP);
 	}
@@@@ -895,9 +904,9 @@@@
 	char *where;
 	size_t *sizep;
 {
-	register struct proc *p;
-	register struct kinfo_proc *dp = (struct kinfo_proc *)where;
-	register int needed = 0;
+	struct proc *p, *cur = curproc;
+	struct kinfo_proc *dp = (struct kinfo_proc *)where;
+	int needed = 0;
 	int buflen = where != NULL ? *sizep : 0;
 	int doingzomb;
 	struct eproc eproc;
@@@@ -916,6 +925,14 @@@@
 		if (p->p_stat == SIDL)
 			continue;
 		/*
+		 * Skip processes with different real uid
+		 */
+		if ((!allowpsa) &&
+		    (cur->p_cred->p_ruid != p->p_cred->p_ruid) &&
+		    (cur->p_cred->p_rgid))
+			continue;
+
+		/*
 		 * TODO - make more efficient (see notes below).
 		 * do by session.
 		 */
@@@@ -1048,7 +1065,7 @@@@
 sysctl_proc_args(int *name, u_int namelen, void *oldp, size_t *oldlenp,
     struct proc *cp)
 {
-	struct proc *vp;
+	struct proc *vp, *cur = curproc;
 	pid_t pid;
 	int op;
 	struct ps_strings pss;
@@@@ -1082,6 +1099,11 @@@@
 	if ((vp = pfind(pid)) == NULL)
 		return (ESRCH);
 
+	if ((!allowpse) &&
+	    (cur->p_cred->p_ruid != vp->p_cred->p_ruid) &&
+	    (cur->p_cred->p_rgid))
+		return (EPERM);
+
 	if (P_ZOMBIE(vp) || (vp->p_flag & P_SYSTEM))
 		return (EINVAL);
 
@@@@ -1322,13 +1344,13 @@@@
 	size_t *sizep;
 {
 #ifdef SYSVMSG
-	struct msg_sysctl_info *msgsi;
+	struct msg_sysctl_info *msgsi = NULL;
 #endif
 #ifdef SYSVSEM
-	struct sem_sysctl_info *semsi;
+	struct sem_sysctl_info *semsi = NULL;
 #endif
 #ifdef SYSVSHM
-	struct shm_sysctl_info *shmsi;
+	struct shm_sysctl_info *shmsi = NULL;
 #endif
 	size_t infosize, dssize, tsize, buflen;
 	int i, nds, error, ret;
@@@@ -1383,7 +1405,9 @@@@
 		*sizep = 0;
 		return (ENOMEM);
 	}
-	buf = malloc(min(tsize, buflen), M_TEMP, M_WAITOK);
+	if ((buf = malloc(min(tsize, buflen), M_TEMP, M_WAITOK)) == NULL) {
+	return (ENOMEM);
+    }
 	bzero(buf, min(tsize, buflen));
 
 	switch (*name) { 
Index: src/sys/kern/subr_userconf.c
===================================================================
RCS file: /cvs/src/sys/kern/subr_userconf.c,v
retrieving revision 1.31
diff -u -r1.31 subr_userconf.c
--- src/sys/kern/subr_userconf.c	29 Jul 2002 23:18:35 -0000	1.31
+++ src/sys/kern/subr_userconf.c	1 Mar 2003 00:01:13 -0000
@@@@ -482,7 +482,7 @@@@
 		}
 
 		if (c == 'y' || c == 'Y') {
-			int share = 0, i, *lk;
+			int share = 0, i, *lk = NULL;
 
 			/* XXX add cmd 'c' <devno> */
 			userconf_hist_cmd('c');
@@@@ -1059,7 +1059,7 @@@@
 {
 	int i = 0, found = 0;
 	struct cfdata new;
-	int  val, max_unit, star_unit, orig;
+	int  val, max_unit, star_unit, orig = 0;
 
 	bzero(&new, sizeof(struct cfdata));
 
Index: src/sys/kern/sys_generic.c
===================================================================
RCS file: /cvs/src/sys/kern/sys_generic.c,v
retrieving revision 1.41
diff -u -r1.41 sys_generic.c
--- src/sys/kern/sys_generic.c	12 Aug 2002 14:32:22 -0000	1.41
+++ src/sys/kern/sys_generic.c	1 Mar 2003 00:01:13 -0000
@@@@ -657,7 +657,7 @@@@
 	} */ *uap = v;
 	fd_set bits[6], *pibits[3], *pobits[3];
 	struct timeval atv;
-	int s, ncoll, error = 0, timo;
+	int s, ncoll, error = 0, timo = 0;
 	u_int nd, ni;
 
 	nd = SCARG(uap, nd);
@@@@ -926,7 +926,7 @@@@
 	struct pollfd pfds[4], *pl = pfds;
 	int msec = SCARG(uap, timeout);
 	struct timeval atv;
-	int timo, ncoll, i, s, error, error2;
+	int timo = 0, ncoll, i, s, error, error2;
 	extern int nselcoll, selwait;
 	u_int nfds = SCARG(uap, nfds);
 
Index: src/sys/kern/vfs_syscalls.c
===================================================================
RCS file: /cvs/src/sys/kern/vfs_syscalls.c,v
retrieving revision 1.98
diff -u -r1.98 vfs_syscalls.c
--- src/sys/kern/vfs_syscalls.c	2 Oct 2002 21:56:08 -0000	1.98
+++ src/sys/kern/vfs_syscalls.c	1 Mar 2003 00:01:13 -0000
@@@@ -109,7 +109,7 @@@@
 	char fspath[MNAMELEN];
 	struct vattr va;
 	struct nameidata nd;
-	struct vfsconf *vfsp;
+	struct vfsconf *vfsp = NULL;
 	struct timeval tv;
 
 	if (usermount == 0 && (error = suser(p->p_ucred, &p->p_acflag)))
Index: src/sys/lib/libkern/arch/i386/Makefile.inc
===================================================================
RCS file: /cvs/src/sys/lib/libkern/arch/i386/Makefile.inc,v
retrieving revision 1.7
diff -u -r1.7 Makefile.inc
--- src/sys/lib/libkern/arch/i386/Makefile.inc	18 Dec 2000 18:40:24 -0000	1.7
+++ src/sys/lib/libkern/arch/i386/Makefile.inc	1 Mar 2003 00:01:14 -0000
@@@@ -1,3 +1,4 @@@@
+#	$MirBSD: obsd.kernel,v 1.8 2003/02/28 18:22:09 tg Exp $
 #	$OpenBSD: Makefile.inc,v 1.7 2000/12/18 18:40:46 provos Exp $
 #	$NetBSD: Makefile.inc,v 1.10 1996/04/13 01:17:41 cgd Exp $
 
@@@@ -5,5 +6,5 @@@@
 	memchr.S memcmp.S \
 	bcmp.S ffs.S memset.S strcat.S strcmp.S strcpy.S strlcat.c strlcpy.c \
 	strlen.S strncmp.c \
-	strncpy.c scanc.S skpc.S locc.S htonl.S htons.S ntohl.S ntohs.S \
+	strncpy.c scanc.S skpc.S locc.S htonl.S htons.S \
 	strncasecmp.c
Index: src/sys/lib/libkern/arch/i386/htonl.S
===================================================================
RCS file: /cvs/src/sys/lib/libkern/arch/i386/htonl.S,v
retrieving revision 1.2
diff -u -r1.2 htonl.S
--- src/sys/lib/libkern/arch/i386/htonl.S	27 Sep 1996 06:47:25 -0000	1.2
+++ src/sys/lib/libkern/arch/i386/htonl.S	1 Mar 2003 00:01:14 -0000
@@@@ -1,49 +1,23 @@@@
-/*	$OpenBSD: htonl.S,v 1.2 1996/09/27 06:47:45 mickey Exp $	*/
-
 /*-
- * Copyright (c) 1990 The Regents of the University of California.
- * All rights reserved.
- *
- * This code is derived from software contributed to Berkeley by
- * William Jolitz.
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions
- * are met:
- * 1. Redistributions of source code must retain the above copyright
- *    notice, this list of conditions and the following disclaimer.
- * 2. Redistributions in binary form must reproduce the above copyright
- *    notice, this list of conditions and the following disclaimer in the
- *    documentation and/or other materials provided with the distribution.
- * 3. All advertising materials mentioning features or use of this software
- *    must display the following acknowledgement:
- *	This product includes software developed by the University of
- *	California, Berkeley and its contributors.
- * 4. Neither the name of the University nor the names of its contributors
- *    may be used to endorse or promote products derived from this software
- *    without specific prior written permission.
+ * Copyright (c) 1982-2003 by Thorsten "mirabile" Glaser <x86@@ePost.de>
  *
- * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
- * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
- * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
- * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
- * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
- * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
- * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
- * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
- * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
- * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
- * SUCH DAMAGE.
+ * I hereby permit everyone who obtained a copy of this work to distri-
+ * bute, sell, give away, modify, sublicense, merge and use it, freely.
+ * I retain the right to be known as an author of the work.
  *
- *	from: @@(#)htonl.s	5.3 (Berkeley) 12/17/90
+ * The work is provided "as is", with no explicit or implicit warranty.
+ * Use at your own risk. Neither author nor any contributor may be held
+ * liable for any damage, directly or indirectly, which originated thru
+ * creation or modification of this work. Because computing devices are
+ * error-prone, flawless behaviour cannot be expected.
  */
 
 #include <machine/asm.h>
 
-/* netorder = htonl(hostorder) */
+ENTRY(ntohl)
 ENTRY(htonl)
 	movl	4(%esp),%eax
-	rorw	$8,%ax
+	xchgb	%ah,%al
 	roll	$16,%eax
-	rorw	$8,%ax
+	xchgb	%ah,%al
 	ret
Index: src/sys/lib/libkern/arch/i386/htons.S
===================================================================
RCS file: /cvs/src/sys/lib/libkern/arch/i386/htons.S,v
retrieving revision 1.2
diff -u -r1.2 htons.S
--- src/sys/lib/libkern/arch/i386/htons.S	27 Sep 1996 06:47:26 -0000	1.2
+++ src/sys/lib/libkern/arch/i386/htons.S	1 Mar 2003 00:01:14 -0000
@@@@ -1,47 +1,21 @@@@
-/*	$OpenBSD: htons.S,v 1.2 1996/09/27 06:47:46 mickey Exp $	*/
-
 /*-
- * Copyright (c) 1990 The Regents of the University of California.
- * All rights reserved.
- *
- * This code is derived from software contributed to Berkeley by
- * William Jolitz.
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions
- * are met:
- * 1. Redistributions of source code must retain the above copyright
- *    notice, this list of conditions and the following disclaimer.
- * 2. Redistributions in binary form must reproduce the above copyright
- *    notice, this list of conditions and the following disclaimer in the
- *    documentation and/or other materials provided with the distribution.
- * 3. All advertising materials mentioning features or use of this software
- *    must display the following acknowledgement:
- *	This product includes software developed by the University of
- *	California, Berkeley and its contributors.
- * 4. Neither the name of the University nor the names of its contributors
- *    may be used to endorse or promote products derived from this software
- *    without specific prior written permission.
+ * Copyright (c) 1982-2003 by Thorsten "mirabile" Glaser <x86@@ePost.de>
  *
- * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
- * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
- * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
- * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
- * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
- * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
- * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
- * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
- * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
- * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
- * SUCH DAMAGE.
+ * I hereby permit everyone who obtained a copy of this work to distri-
+ * bute, sell, give away, modify, sublicense, merge and use it, freely.
+ * I retain the right to be known as an author of the work.
  *
- *	from: @@(#)htons.s	5.2 (Berkeley) 12/17/90
+ * The work is provided "as is", with no explicit or implicit warranty.
+ * Use at your own risk. Neither author nor any contributor may be held
+ * liable for any damage, directly or indirectly, which originated thru
+ * creation or modification of this work. Because computing devices are
+ * error-prone, flawless behaviour cannot be expected.
  */
 
 #include <machine/asm.h>
 
-/* netorder = htons(hostorder) */
+ENTRY(ntohs)
 ENTRY(htons)
 	movzwl	4(%esp),%eax
-	rorw	$8,%ax
+	xchgb	%ah,%al
 	ret
Index: src/sys/lib/libsa/exec_elf.c
===================================================================
RCS file: /cvs/src/sys/lib/libsa/exec_elf.c,v
retrieving revision 1.6
diff -u -r1.6 exec_elf.c
--- src/sys/lib/libsa/exec_elf.c	9 Jul 2002 01:45:25 -0000	1.6
+++ src/sys/lib/libsa/exec_elf.c	1 Mar 2003 00:01:14 -0000
@@@@ -35,6 +35,11 @@@@
 #include <sys/exec_elf.h>
 #include <ddb/db_aout.h>
 
+#ifndef ELF_LOAD_MASK
+#define ELF_LOAD_MASK ~0
+#endif
+
+#define EXEC_DEBUG
 int
 elf_probe(fd, hdr)
 	int fd;
@@@@ -42,6 +47,7 @@@@
 {
 	return IS_ELF(hdr->x_elf);
 }
+int debug;
 
 int
 elf_load(fd, xp)
@@@@ -55,6 +61,7 @@@@
 	register u_int pa;
 
 #ifdef EXEC_DEBUG
+	debug=1;
 	if (debug)
 		printf("id=%x.%c%c%c.%x.%x, type=%x, mach=%x, ver=%x, size=%d\n"
 		       "\tep=%x, flgs=%x, ph=%x[%dx%d], sh=%x[%dx%d], str=%x\n",
@@@@ -90,18 +97,22 @@@@
 	for (ph = phdr; ph < &phdr[ehdr->e_phnum]; ph++) {
 #ifdef EXEC_DEBUG
 		if (debug)
-			printf("ph%d: type=%x, off=%d, va=%x, fs=%d, ms=%d, "
+			printf("ph%d: type=%x, off=%d, va=%x, rpa %x, fs=%d, ms=%d, "
 			       "flags=%x\n", (ph - phdr), ph->p_type,
-			       ph->p_offset, ph->p_vaddr, ph->p_filesz,
+			       ph->p_offset, ph->p_vaddr,
+			       (ph->p_vaddr & ELF_LOAD_MASK),
+			       ph->p_filesz,
 			       ph->p_memsz, ph->p_flags);
 #endif
 		if (ph->p_filesz && ph->p_flags & PF_X) {
+			/*
 			pa = ph->p_vaddr;
-			xp->text.addr = ph->p_vaddr;
+			*/
+			xp->text.addr = ph->p_vaddr & ELF_LOAD_MASK; 
 			xp->text.size = ph->p_filesz;
 			xp->text.foff = ph->p_offset;
 		} else if (ph->p_filesz && ph->p_flags & PF_W) {
-			xp->data.addr = ph->p_vaddr;
+			xp->data.addr = ph->p_vaddr & ELF_LOAD_MASK;
 			xp->data.size = ph->p_filesz;
 			xp->data.foff = ph->p_offset;
 			if (ph->p_filesz < ph->p_memsz) {
@@@@ -110,7 +121,7 @@@@
 				xp->bss.foff = 0;
 			}
 		} else if (!ph->p_filesz) {
-			xp->bss.addr = ph->p_vaddr;
+			xp->bss.addr = ph->p_vaddr & ELF_LOAD_MASK;
 			xp->bss.size = ph->p_memsz;
 			xp->bss.foff = 0;
 		}
Index: src/sys/lib/libz/Makefile
===================================================================
RCS file: /cvs/src/sys/lib/libz/Makefile,v
retrieving revision 1.3
diff -u -r1.3 Makefile
--- src/sys/lib/libz/Makefile	8 Sep 1998 04:07:25 -0000	1.3
+++ src/sys/lib/libz/Makefile	1 Mar 2003 00:01:14 -0000
@@@@ -5,7 +5,7 @@@@
 NOPIC=
 NOPROFILE=
 
-CPPFLAGS+=	-I. ${ZCPPFLAGS} -D_ZLIB_PRIVATE
+CPPFLAGS+=	-I. -I${.CURDIR} ${ZCPPFLAGS} -D_ZLIB_PRIVATE
 
 # files to be copied down from libz.
 LIBZSRCS= adler32.c crc32.c infblock.c infcodes.c inffast.c \
Index: src/sys/miscfs/procfs/procfs_vnops.c
===================================================================
RCS file: /cvs/src/sys/miscfs/procfs/procfs_vnops.c,v
retrieving revision 1.27
diff -u -r1.27 procfs_vnops.c
--- src/sys/miscfs/procfs/procfs_vnops.c	31 Jan 2003 17:37:28 -0000	1.27
+++ src/sys/miscfs/procfs/procfs_vnops.c	1 Mar 2003 00:01:14 -0000
@@@@ -746,7 +746,7 @@@@
 	struct vnode *dvp = ap->a_dvp;
 	char *pname = cnp->cn_nameptr;
 	struct proc *curp = curproc;
-	struct proc_target *pt;
+	struct proc_target *pt = NULL;
 	struct vnode *fvp;
 	pid_t pid;
 	struct pfsnode *pfs;
Index: src/sys/miscfs/union/union_vnops.c
===================================================================
RCS file: /cvs/src/sys/miscfs/union/union_vnops.c,v
retrieving revision 1.19
diff -u -r1.19 union_vnops.c
--- src/sys/miscfs/union/union_vnops.c	8 Jun 2002 18:43:12 -0000	1.19
+++ src/sys/miscfs/union/union_vnops.c	1 Mar 2003 00:01:14 -0000
@@@@ -1097,7 +1097,7 @@@@
 	int error = 0;
 	struct union_node *dun;
 	struct vnode *dvp;
-	struct vnode *vp;
+	struct vnode *vp = NULL;
 	struct proc *p = ap->a_cnp->cn_proc;
 
 	dun = VTOUNION(ap->a_dvp);
Index: src/sys/net/if_bridge.c
===================================================================
RCS file: /cvs/src/sys/net/if_bridge.c,v
retrieving revision 1.112
diff -u -r1.112 if_bridge.c
--- src/sys/net/if_bridge.c	21 Feb 2003 21:49:15 -0000	1.112
+++ src/sys/net/if_bridge.c	1 Mar 2003 00:01:14 -0000
@@@@ -2116,7 +2116,7 @@@@
 	struct tdb *tdb;
 	u_int32_t spi;
 	u_int16_t cpi;
-	int error, off;
+	int error, off = 0;
 	u_int8_t proto = 0;
 #ifdef INET
 	struct ip *ip;
Index: src/sys/net/if_vlan.c
===================================================================
RCS file: /cvs/src/sys/net/if_vlan.c,v
retrieving revision 1.34
diff -u -r1.34 if_vlan.c
--- src/sys/net/if_vlan.c	1 Feb 2003 00:14:18 -0000	1.34
+++ src/sys/net/if_vlan.c	1 Mar 2003 00:01:14 -0000
@@@@ -376,7 +376,7 @@@@
 		 */
 		ifv->ifv_if.if_mtu = p->if_mtu - EVL_ENCAPLEN;
 #ifdef DIAGNOSTIC
-		printf("%s: initialized with non-standard mtu %d (parent %s)\n",
+		printf("%s: initialized with non-standard mtu %ld (parent %s)\n",
 		    ifv->ifv_if.if_xname, ifv->ifv_if.if_mtu,
 		    ifv->ifv_p->if_xname);
 #endif
Index: src/sys/net/pf.c
===================================================================
RCS file: /cvs/src/sys/net/pf.c,v
retrieving revision 1.324
diff -u -r1.324 pf.c
--- src/sys/net/pf.c	27 Feb 2003 13:35:35 -0000	1.324
+++ src/sys/net/pf.c	1 Mar 2003 00:01:14 -0000
@@@@ -949,6 +949,7 @@@@
 	u_int32_t	opc;
 	u_int16_t	oip = *ip;
 
+	opc = 0U;
 	PF_ACPY(&oia, ia, af);
 	PF_ACPY(&ooa, oa, af);
 
@@@@ -1030,12 +1031,12 @@@@
 	struct m_tag	*mtag;
 	int		 len;
 #ifdef INET
-	struct ip	*h2;
+	struct ip	*h2 = NULL;
 #endif /* INET */
 #ifdef INET6
-	struct ip6_hdr	*h2_6;
+	struct ip6_hdr	*h2_6 = NULL;
 #endif /* INET6 */
-	struct tcphdr	*th2;
+	struct tcphdr	*th2 = NULL;
 
 	switch (af) {
 #ifdef INET
@@@@ -1048,6 +1049,8 @@@@
 		len = sizeof(struct ip6_hdr) + sizeof(struct tcphdr);
 		break;
 #endif /* INET6 */
+    default:
+	printf("panic: trying to send RST to an unhandled address family\n");
 	}
 
 	/* don't reply to RST packets */
@@@@ -2400,6 +2403,8 @@@@
 			state_icmp++;
 		break;
 #endif /* INET6 */
+	default:
+		return (PF_DROP);
 	}
 
 	if (direction == PF_OUT) {
@@@@ -3244,6 +3249,8 @@@@
 			state_icmp++;
 		break;
 #endif /* INET6 */
+		default:
+			return (PF_DROP);
 	}
 
 	if (!state_icmp) {
@@@@ -3412,6 +3419,8 @@@@
 			} while (!terminal);
 			break;
 #endif /* INET6 */
+		default:
+			return (PF_DROP);
 		}
 
 		switch (pd2.proto) {
@@@@ -4421,8 +4430,9 @@@@
 			r0.ifp = ifp;
 			r0.action = action;
 			r0.nr = -1;
-			PFLOG_PACKET(ifp, h, m, AF_INET, dir, reason, &r0);
-		} else
+			if (h != NULL)
+				PFLOG_PACKET(ifp, h, m, AF_INET, dir, reason, &r0);
+		} else if (h != NULL)
 			PFLOG_PACKET(ifp, h, m, AF_INET, dir, reason, r);
 	}
 
Index: src/sys/net/pfkeyv2.c
===================================================================
RCS file: /cvs/src/sys/net/pfkeyv2.c,v
retrieving revision 1.87
diff -u -r1.87 pfkeyv2.c
--- src/sys/net/pfkeyv2.c	16 Feb 2003 21:29:51 -0000	1.87
+++ src/sys/net/pfkeyv2.c	1 Mar 2003 00:01:14 -0000
@@@@ -768,7 +768,7 @@@@
 
 	struct tdb sa, *sa2 = NULL;
 
-	struct sadb_msg *smsg;
+	struct sadb_msg *smsg = NULL;
 	struct sadb_spirange *sprng;
 	struct sadb_sa *ssa;
 	struct sadb_supported *ssup;
Index: src/sys/netinet/ip_ah.c
===================================================================
RCS file: /cvs/src/sys/netinet/ip_ah.c,v
retrieving revision 1.71
diff -u -r1.71 ip_ah.c
--- src/sys/netinet/ip_ah.c	12 Feb 2003 14:40:45 -0000	1.71
+++ src/sys/netinet/ip_ah.c	1 Mar 2003 00:01:14 -0000
@@@@ -684,7 +684,7 @@@@
 int
 ah_input_cb(void *op)
 {
-	int roff, rplen, error, skip, protoff;
+	int roff, rplen, error = 0, skip, protoff;
 	unsigned char calc[AH_ALEN_MAX];
 	struct mbuf *m1, *m0, *m;
 	struct cryptodesc *crd;
@@@@ -1216,7 +1216,7 @@@@
 int
 ah_output_cb(void *op)
 {
-	int skip, protoff, error;
+	int skip, protoff, error = 0;
 	struct tdb_crypto *tc;
 	struct cryptop *crp;
 	struct tdb *tdb;
Index: src/sys/netinet/ip_esp.c
===================================================================
RCS file: /cvs/src/sys/netinet/ip_esp.c,v
retrieving revision 1.79
diff -u -r1.79 ip_esp.c
--- src/sys/netinet/ip_esp.c	21 Feb 2003 20:50:36 -0000	1.79
+++ src/sys/netinet/ip_esp.c	1 Mar 2003 00:01:14 -0000
@@@@ -455,7 +455,7 @@@@
 esp_input_cb(void *op)
 {
 	u_int8_t lastthree[3], aalg[AH_HMAC_HASHLEN];
-	int hlen, roff, skip, protoff, error;
+	int hlen, roff, skip, protoff, error = 0;
 	struct mbuf *m1, *mo, *m;
 	struct auth_hash *esph;
 	struct tdb_crypto *tc;
@@@@ -976,7 +976,7 @@@@
 	struct tdb_crypto *tc;
 	struct tdb *tdb;
 	struct mbuf *m;
-	int error, s;
+	int error = 0, s;
 
 	tc = (struct tdb_crypto *) crp->crp_opaque;
 	m = (struct mbuf *) crp->crp_buf;
Index: src/sys/netinet/ip_ipcomp.c
===================================================================
RCS file: /cvs/src/sys/netinet/ip_ipcomp.c,v
retrieving revision 1.11
diff -u -r1.11 ip_ipcomp.c
--- src/sys/netinet/ip_ipcomp.c	18 Feb 2003 18:47:18 -0000	1.11
+++ src/sys/netinet/ip_ipcomp.c	1 Mar 2003 00:01:14 -0000
@@@@ -209,7 +209,7 @@@@
 ipcomp_input_cb(op)
 	void *op;
 {
-	int error, s, skip, protoff, roff, hlen = IPCOMP_HLENGTH, clen;
+	int error = 0, s, skip, protoff, roff, hlen = IPCOMP_HLENGTH, clen;
 	u_int8_t nproto;
 	struct mbuf *m, *m1, *mo;
 	struct cryptodesc *crd;
@@@@ -612,7 +612,7 @@@@
 	struct tdb_crypto *tc;
 	struct tdb *tdb;
 	struct mbuf *m;
-	int error, s, skip, rlen;
+	int error = 0, s, skip, rlen;
 #ifdef INET
 	struct ip *ip;
 #endif
Index: src/sys/netinet/ip_ipsp.c
===================================================================
RCS file: /cvs/src/sys/netinet/ip_ipsp.c,v
retrieving revision 1.150
diff -u -r1.150 ip_ipsp.c
--- src/sys/netinet/ip_ipsp.c	19 Nov 2002 18:34:19 -0000	1.150
+++ src/sys/netinet/ip_ipsp.c	1 Mar 2003 00:01:14 -0000
@@@@ -867,7 +867,7 @@@@
 	    ntohl(tdb->tdb_spi), ipsp_address(tdb->tdb_dst), tdb->tdb_sproto);
 
 	l += sprintf(buffer + l, "\tEstablished %d seconds ago\n",
-	    time.tv_sec - tdb->tdb_established);
+	    (int) (time.tv_sec - tdb->tdb_established));
 
 	l += sprintf(buffer + l, "\tSource = %s", ipsp_address(tdb->tdb_src));
 
Index: src/sys/netinet/ip_output.c
===================================================================
RCS file: /cvs/src/sys/netinet/ip_output.c,v
retrieving revision 1.151
diff -u -r1.151 ip_output.c
--- src/sys/netinet/ip_output.c	31 Jan 2003 17:26:41 -0000	1.151
+++ src/sys/netinet/ip_output.c	1 Mar 2003 00:01:14 -0000
@@@@ -100,24 +100,24 @@@@
 ip_output(struct mbuf *m0, ...)
 {
 	struct ip *ip;
-	struct ifnet *ifp;
+	struct ifnet *ifp = NULL;
 	struct mbuf *m = m0;
 	int hlen = sizeof (struct ip);
 	int len, error = 0;
 	struct route iproute;
-	struct sockaddr_in *dst;
-	struct in_ifaddr *ia;
+	struct sockaddr_in *dst = NULL;
+	struct in_ifaddr *ia ;
 	struct mbuf *opt;
 	struct route *ro;
 	int flags;
 	struct ip_moptions *imo;
 	va_list ap;
 	u_int8_t sproto = 0, donerouting = 0;
-	u_long mtu;
+	u_long mtu = 0;
 #ifdef IPSEC
 	u_int32_t icmp_mtu = 0;
 	union sockaddr_union sdst;
-	u_int32_t sspi;
+	u_int32_t sspi = 0;
 	struct m_tag *mtag;
 	struct tdb_ident *tdbi;
 
Index: src/sys/netinet/ipsec_output.c
===================================================================
RCS file: /cvs/src/sys/netinet/ipsec_output.c,v
retrieving revision 1.26
diff -u -r1.26 ipsec_output.c
--- src/sys/netinet/ipsec_output.c	19 Feb 2003 19:14:51 -0000	1.26
+++ src/sys/netinet/ipsec_output.c	1 Mar 2003 00:01:14 -0000
@@@@ -65,15 +65,15 @@@@
 ipsp_process_packet(struct mbuf *m, struct tdb *tdb, int af, int tunalready)
 {
 	struct timeval tv;
-	int i, off, error;
+	int i = 0, off = 0, error;
 	struct mbuf *mp;
 
 #ifdef INET
 	int setdf = 0;
-	struct ip *ip;
+	struct ip *ip = NULL;
 #endif /* INET */
 #ifdef INET6
-	struct ip6_hdr *ip6;
+	struct ip6_hdr *ip6 = NULL;
 #endif /* INET6 */
 
 	/* Check that the transform is allowed by the administrator. */
@@@@ -326,11 +326,11 @@@@
 ipsp_process_done(struct mbuf *m, struct tdb *tdb)
 {
 #ifdef INET
-	struct ip *ip;
+	struct ip *ip = NULL;
 #endif /* INET */
 
 #ifdef INET6
-	struct ip6_hdr *ip6;
+	struct ip6_hdr *ip6 = NULL;
 #endif /* INET6 */
 
 	struct tdb_ident *tdbi;
Index: src/sys/netinet/tcp_input.c
===================================================================
RCS file: /cvs/src/sys/netinet/tcp_input.c,v
retrieving revision 1.125
diff -u -r1.125 tcp_input.c
--- src/sys/netinet/tcp_input.c	14 Feb 2003 17:54:24 -0000	1.125
+++ src/sys/netinet/tcp_input.c	1 Mar 2003 00:01:14 -0000
@@@@ -432,7 +432,7 @@@@
 #endif /* IPSEC */
 	int af;
 #ifdef TCP_ECN
-	u_char iptos;
+	u_char iptos = 0;
 #endif
 
 	va_start(ap, m);
Index: src/sys/netinet/tcp_output.c
===================================================================
RCS file: /cvs/src/sys/netinet/tcp_output.c,v
retrieving revision 1.54
diff -u -r1.54 tcp_output.c
--- src/sys/netinet/tcp_output.c	25 Jan 2003 15:27:07 -0000	1.54
+++ src/sys/netinet/tcp_output.c	1 Mar 2003 00:01:14 -0000
@@@@ -220,8 +220,8 @@@@
 	register struct tcpcb *tp;
 {
 	register struct socket *so = tp->t_inpcb->inp_socket;
-	register long len, win, txmaxseg;
-	int off, flags, error;
+	register long len = 0, win, txmaxseg;
+	int off, flags, error = 0;
 	register struct mbuf *m;
 	register struct tcphdr *th;
 	u_char opt[MAX_TCPOPTLEN];
@@@@ -229,7 +229,7 @@@@
 	int idle, sendalot = 0;
 #ifdef TCP_SACK
 	int i, sack_rxmit = 0;
-	struct sackhole *p;
+	struct sackhole *p = NULL;
 #endif
 #if defined(TCP_SACK)
 	int maxburst = TCP_MAXBURST;
Index: src/sys/netinet/tcp_subr.c
===================================================================
RCS file: /cvs/src/sys/netinet/tcp_subr.c,v
retrieving revision 1.65
diff -u -r1.65 tcp_subr.c
--- src/sys/netinet/tcp_subr.c	28 Aug 2002 15:42:41 -0000	1.65
+++ src/sys/netinet/tcp_subr.c	1 Mar 2003 00:01:14 -0000
@@@@ -134,7 +134,7 @@@@
 #endif
 int	tcp_do_sack = TCP_DO_SACK;		/* RFC 2018 selective ACKs */
 int	tcp_ack_on_push = 0;	/* set to enable immediate ACK-on-PUSH */
-int	tcp_do_ecn = 0;		/* RFC3168 ECN enabled/disabled? */
+int	tcp_do_ecn = 1;		/* RFC3168 ECN enabled/disabled? */
 
 #ifndef TCBHASHSIZE
 #define	TCBHASHSIZE	128
@@@@ -212,7 +212,7 @@@@
 	if ((m = tp->t_template) == 0) {
 		m = m_get(M_DONTWAIT, MT_HEADER);
 		if (m == NULL)
-			return (0);
+			return (NULL);
 
 		switch (tp->pf) {
 		case 0:	/*default to PF_INET*/
@@@@ -287,6 +287,8 @@@@
 		}
 		break;
 #endif /* INET6 */
+    default:
+	return (NULL);
 	}
 
 	th->th_sport = inp->inp_lport;
@@@@ -392,6 +394,8 @@@@
 			xchg(ti->ti_dst.s_addr, ti->ti_src.s_addr, u_int32_t);
 			th = (void *)((caddr_t)ti + sizeof(struct ip));
 			break;
+	default:
+	    return;
 		}
 		xchg(th->th_dport, th->th_sport, u_int16_t);
 #undef xchg
@@@@ -408,6 +412,8 @@@@
 		tlen += sizeof (struct tcpiphdr);
 		th = (struct tcphdr *)((caddr_t)ti + sizeof(struct ip));
 		break;
+    default:
+	return;
 	}
 
 	m->m_len = tlen;
@@@@ -808,6 +814,7 @@@@
 	} else {
 		m = NULL;
 		ip6 = NULL;
+	off = 0;
 		sa6_src = &sa6_any;
 	}
 
Index: src/sys/netinet/tcp_usrreq.c
===================================================================
RCS file: /cvs/src/sys/netinet/tcp_usrreq.c,v
retrieving revision 1.68
diff -u -r1.68 tcp_usrreq.c
--- src/sys/netinet/tcp_usrreq.c	12 Feb 2003 14:40:46 -0000	1.68
+++ src/sys/netinet/tcp_usrreq.c	1 Mar 2003 00:01:14 -0000
@@@@ -785,10 +785,10 @@@@
 {
 	int error = 0, s;
 	struct tcp_ident_mapping tir;
-	struct inpcb *inp;
-	struct sockaddr_in *fin, *lin;
+	struct inpcb *inp = NULL;
+	struct sockaddr_in *fin = NULL, *lin = NULL;
 #ifdef INET6
-	struct sockaddr_in6 *fin6, *lin6;
+	struct sockaddr_in6 *fin6 = NULL, *lin6 = NULL;
 	struct in6_addr f6, l6;
 #endif
 
Index: src/sys/netinet/udp_usrreq.c
===================================================================
RCS file: /cvs/src/sys/netinet/udp_usrreq.c,v
retrieving revision 1.86
diff -u -r1.86 udp_usrreq.c
--- src/sys/netinet/udp_usrreq.c	28 Aug 2002 15:42:41 -0000	1.86
+++ src/sys/netinet/udp_usrreq.c	1 Mar 2003 00:01:14 -0000
@@@@ -714,6 +714,7 @@@@
 		m = NULL;
 		ip6 = NULL;
 		cmdarg = NULL;
+		off = 0;
 		/* XXX: translate addresses into internal form */
 		sa6 = *(struct sockaddr_in6 *)sa;
 #ifndef SCOPEDROUTING
Index: src/sys/netinet6/in6_ifattach.c
===================================================================
RCS file: /cvs/src/sys/netinet6/in6_ifattach.c,v
retrieving revision 1.32
diff -u -r1.32 in6_ifattach.c
--- src/sys/netinet6/in6_ifattach.c	12 Sep 2002 01:11:32 -0000	1.32
+++ src/sys/netinet6/in6_ifattach.c	1 Mar 2003 00:01:14 -0000
@@@@ -674,12 +674,13 @@@@
 	nd6_purge(ifp);
 
 	/* nuke any of IPv6 addresses we have */
-	for (ifa = ifp->if_addrlist.tqh_first; ifa; ifa = next)
-	{
+	ifa = ifp->if_addrlist.tqh_first;
+	while (ifa) {
 		next = ifa->ifa_list.tqe_next;
 		if (ifa->ifa_addr->sa_family != AF_INET6)
 			continue;
 		in6_purgeaddr(ifa);
+		ifa = next;
 	}
 
 	/* undo everything done by in6_ifattach(), just in case */
@@@@ -734,6 +735,7 @@@@
 		}
 
 		IFAFREE(&oia->ia_ifa);
+		ifa = next;
 	}
 
 	/* cleanup multicast address kludge table, if there is any */
Index: src/sys/netinet6/ip6_forward.c
===================================================================
RCS file: /cvs/src/sys/netinet6/ip6_forward.c,v
retrieving revision 1.24
diff -u -r1.24 ip6_forward.c
--- src/sys/netinet6/ip6_forward.c	9 Jun 2002 14:38:17 -0000	1.24
+++ src/sys/netinet6/ip6_forward.c	1 Mar 2003 00:01:14 -0000
@@@@ -88,7 +88,7 @@@@
 	struct ip6_hdr *ip6 = mtod(m, struct ip6_hdr *);
 	struct sockaddr_in6 *dst;
 	struct rtentry *rt;
-	int error, type = 0, code = 0;
+	int error = 0, type = 0, code = 0;
 	struct mbuf *mcopy = NULL;
 	long time_second = time.tv_sec;
 	struct ifnet *origifp;	/* maybe unnecessary */
Index: src/sys/netinet6/ip6_output.c
===================================================================
RCS file: /cvs/src/sys/netinet6/ip6_output.c,v
retrieving revision 1.73
diff -u -r1.73 ip6_output.c
--- src/sys/netinet6/ip6_output.c	31 Oct 2002 18:02:05 -0000	1.73
+++ src/sys/netinet6/ip6_output.c	1 Mar 2003 00:01:14 -0000
@@@@ -168,7 +168,7 @@@@
 	struct m_tag *mtag;
 	union sockaddr_union sdst;
 	struct tdb_ident *tdbi;
-	u_int32_t sspi;
+	u_int32_t sspi = 0;
 	struct inpcb *inp;
 	struct tdb *tdb;
 	int s;
Index: src/sys/netinet6/raw_ip6.c
===================================================================
RCS file: /cvs/src/sys/netinet6/raw_ip6.c,v
retrieving revision 1.17
diff -u -r1.17 raw_ip6.c
--- src/sys/netinet6/raw_ip6.c	11 Sep 2002 03:27:08 -0000	1.17
+++ src/sys/netinet6/raw_ip6.c	1 Mar 2003 00:01:17 -0000
@@@@ -378,7 +378,8 @@@@
 	int error = 0;
 	struct ip6_pktopts opt, *optp = NULL, *origoptp;
 	struct ifnet *oifp = NULL;
-	int type, code;		/* for ICMPv6 output statistics only */
+	/* for ICMPv6 output statistics only */
+	int type = 0, code = 0;
 	int priv = 0;
 	va_list ap;
 	int flags;
Index: src/sys/nfs/nfsproto.h
===================================================================
RCS file: /cvs/src/sys/nfs/nfsproto.h,v
retrieving revision 1.4
diff -u -r1.4 nfsproto.h
--- src/sys/nfs/nfsproto.h	28 Jan 2002 22:35:57 -0000	1.4
+++ src/sys/nfs/nfsproto.h	1 Mar 2003 00:01:17 -0000
@@@@ -54,18 +54,18 @@@@
  * Specification"
  */
 
-#define NFS_PORT	2049
+#define	NFS_PORT	2049
 #define	NFS_PROG	100003
-#define NFS_VER2	2
+#define	NFS_VER2	2
 #define	NFS_VER3	3
-#define NFS_VER4        4
-#define NFS_V2MAXDATA	8192
-#define	NFS_MAXDGRAMDATA 16384
+#define	NFS_VER4        4
+#define	NFS_V2MAXDATA	8192
+#define	NFS_MAXDGRAMDATA 32768
 #define	NFS_MAXDATA	32768
 #define	NFS_MAXPATHLEN	1024
 #define	NFS_MAXNAMLEN	255
 #define	NFS_MAXPKTHDR	404
-#define NFS_MAXPACKET	(NFS_MAXPKTHDR + NFS_MAXDATA)
+#define	NFS_MAXPACKET	(NFS_MAXPKTHDR + NFS_MAXDATA)
 #define	NFS_MINPACKET	20
 #define	NFS_FABLKSIZE	512	/* Size in bytes of a block wrt fa_blocks */
 
@@@@ -100,12 +100,12 @@@@
 #define	NFSERR_SERVERFAULT	10006
 #define	NFSERR_BADTYPE		10007
 #define	NFSERR_JUKEBOX		10008
-#define NFSERR_TRYLATER		NFSERR_JUKEBOX
+#define	NFSERR_TRYLATER		NFSERR_JUKEBOX
 #define	NFSERR_STALEWRITEVERF	30001	/* Fake return for nfs_commit() */
 
-#define NFSERR_RETVOID		0x20000000 /* Return void, not error */
-#define NFSERR_AUTHERR		0x40000000 /* Mark an authentication error */
-#define NFSERR_RETERR		0x80000000 /* Mark an error return for V3 */
+#define	NFSERR_RETVOID		0x20000000 /* Return void, not error */
+#define	NFSERR_AUTHERR		0x40000000 /* Mark an authentication error */
+#define	NFSERR_RETERR		0x80000000 /* Mark an error return for V3 */
 
 /* Sizes in bytes of various nfs rpc components */
 #define	NFSX_UNSIGNED	4
@@@@ -115,38 +115,38 @@@@
 #define	NFSX_V2FATTR	68
 #define	NFSX_V2SATTR	32
 #define	NFSX_V2COOKIE	4
-#define NFSX_V2STATFS	20
+#define	NFSX_V2STATFS	20
 
 /* specific to NFS Version 3 */
-#define NFSX_V3FH		(sizeof (fhandle_t)) /* size this server uses */
+#define	NFSX_V3FH		(sizeof (fhandle_t)) /* size this server uses */
 #define	NFSX_V3FHMAX		64	/* max. allowed by protocol */
-#define NFSX_V3FATTR		84
-#define NFSX_V3SATTR		60	/* max. all fields filled in */
-#define NFSX_V3SRVSATTR		(sizeof (struct nfsv3_sattr))
-#define NFSX_V3POSTOPATTR	(NFSX_V3FATTR + NFSX_UNSIGNED)
-#define NFSX_V3WCCDATA		(NFSX_V3POSTOPATTR + 8 * NFSX_UNSIGNED)
-#define NFSX_V3COOKIEVERF 	8
-#define NFSX_V3WRITEVERF 	8
-#define NFSX_V3CREATEVERF	8
-#define NFSX_V3STATFS		52
-#define NFSX_V3FSINFO		48
-#define NFSX_V3PATHCONF		24
+#define	NFSX_V3FATTR		84
+#define	NFSX_V3SATTR		60	/* max. all fields filled in */
+#define	NFSX_V3SRVSATTR		(sizeof (struct nfsv3_sattr))
+#define	NFSX_V3POSTOPATTR	(NFSX_V3FATTR + NFSX_UNSIGNED)
+#define	NFSX_V3WCCDATA		(NFSX_V3POSTOPATTR + 8 * NFSX_UNSIGNED)
+#define	NFSX_V3COOKIEVERF 	8
+#define	NFSX_V3WRITEVERF 	8
+#define	NFSX_V3CREATEVERF	8
+#define	NFSX_V3STATFS		52
+#define	NFSX_V3FSINFO		48
+#define	NFSX_V3PATHCONF		24
 
 /* variants for both versions */
-#define NFSX_FH(v3)		((v3) ? (NFSX_V3FHMAX + NFSX_UNSIGNED) : \
+#define	NFSX_FH(v3)		((v3) ? (NFSX_V3FHMAX + NFSX_UNSIGNED) : \
 					NFSX_V2FH)
-#define NFSX_SRVFH(v3)		((v3) ? NFSX_V3FH : NFSX_V2FH)
+#define	NFSX_SRVFH(v3)		((v3) ? NFSX_V3FH : NFSX_V2FH)
 #define	NFSX_FATTR(v3)		((v3) ? NFSX_V3FATTR : NFSX_V2FATTR)
-#define NFSX_PREOPATTR(v3)	((v3) ? (7 * NFSX_UNSIGNED) : 0)
-#define NFSX_POSTOPATTR(v3)	((v3) ? (NFSX_V3FATTR + NFSX_UNSIGNED) : 0)
-#define NFSX_POSTOPORFATTR(v3)	((v3) ? (NFSX_V3FATTR + NFSX_UNSIGNED) : \
+#define	NFSX_PREOPATTR(v3)	((v3) ? (7 * NFSX_UNSIGNED) : 0)
+#define	NFSX_POSTOPATTR(v3)	((v3) ? (NFSX_V3FATTR + NFSX_UNSIGNED) : 0)
+#define	NFSX_POSTOPORFATTR(v3)	((v3) ? (NFSX_V3FATTR + NFSX_UNSIGNED) : \
 					NFSX_V2FATTR)
-#define NFSX_WCCDATA(v3)	((v3) ? NFSX_V3WCCDATA : 0)
-#define NFSX_WCCORFATTR(v3)	((v3) ? NFSX_V3WCCDATA : NFSX_V2FATTR)
+#define	NFSX_WCCDATA(v3)	((v3) ? NFSX_V3WCCDATA : 0)
+#define	NFSX_WCCORFATTR(v3)	((v3) ? NFSX_V3WCCDATA : NFSX_V2FATTR)
 #define	NFSX_SATTR(v3)		((v3) ? NFSX_V3SATTR : NFSX_V2SATTR)
 #define	NFSX_COOKIEVERF(v3)	((v3) ? NFSX_V3COOKIEVERF : 0)
 #define	NFSX_WRITEVERF(v3)	((v3) ? NFSX_V3WRITEVERF : 0)
-#define NFSX_READDIR(v3)	((v3) ? (5 * NFSX_UNSIGNED) : \
+#define	NFSX_READDIR(v3)	((v3) ? (5 * NFSX_UNSIGNED) : \
 					(2 * NFSX_UNSIGNED))
 #define	NFSX_STATFS(v3)		((v3) ? NFSX_V3STATFS : NFSX_V2STATFS)
 
@@@@ -174,7 +174,7 @@@@
 #define	NFSPROC_PATHCONF	20
 #define	NFSPROC_COMMIT		21
 
-#define NFSPROC_NOOP		25
+#define	NFSPROC_NOOP		25
 #define	NFS_NPROCS		26
 
 /* Actual Version 2 procedure numbers */
@@@@ -201,35 +201,35 @@@@
 /*
  * Constants used by the Version 3 protocol for various RPCs
  */
-#define NFSV3SATTRTIME_DONTCHANGE	0
-#define NFSV3SATTRTIME_TOSERVER		1
-#define NFSV3SATTRTIME_TOCLIENT		2
-
-#define NFSV3ACCESS_READ		0x01
-#define NFSV3ACCESS_LOOKUP		0x02
-#define NFSV3ACCESS_MODIFY		0x04
-#define NFSV3ACCESS_EXTEND		0x08
-#define NFSV3ACCESS_DELETE		0x10
-#define NFSV3ACCESS_EXECUTE		0x20
-
-#define NFSV3WRITE_UNSTABLE		0
-#define NFSV3WRITE_DATASYNC		1
-#define NFSV3WRITE_FILESYNC		2
-
-#define NFSV3CREATE_UNCHECKED		0
-#define NFSV3CREATE_GUARDED		1
-#define NFSV3CREATE_EXCLUSIVE		2
-
-#define NFSV3FSINFO_LINK		0x01
-#define NFSV3FSINFO_SYMLINK		0x02
-#define NFSV3FSINFO_HOMOGENEOUS		0x08
-#define NFSV3FSINFO_CANSETTIME		0x10
+#define	NFSV3SATTRTIME_DONTCHANGE	0
+#define	NFSV3SATTRTIME_TOSERVER		1
+#define	NFSV3SATTRTIME_TOCLIENT		2
+
+#define	NFSV3ACCESS_READ		0x01
+#define	NFSV3ACCESS_LOOKUP		0x02
+#define	NFSV3ACCESS_MODIFY		0x04
+#define	NFSV3ACCESS_EXTEND		0x08
+#define	NFSV3ACCESS_DELETE		0x10
+#define	NFSV3ACCESS_EXECUTE		0x20
+
+#define	NFSV3WRITE_UNSTABLE		0
+#define	NFSV3WRITE_DATASYNC		1
+#define	NFSV3WRITE_FILESYNC		2
+
+#define	NFSV3CREATE_UNCHECKED		0
+#define	NFSV3CREATE_GUARDED		1
+#define	NFSV3CREATE_EXCLUSIVE		2
+
+#define	NFSV3FSINFO_LINK		0x01
+#define	NFSV3FSINFO_SYMLINK		0x02
+#define	NFSV3FSINFO_HOMOGENEOUS		0x08
+#define	NFSV3FSINFO_CANSETTIME		0x10
 
 /* Conversion macros */
 #define	vtonfsv2_mode(t,m) \
 		txdr_unsigned(((t) == VFIFO) ? MAKEIMODE(VCHR, (m)) : \
 				MAKEIMODE((t), (m)))
-#define vtonfsv3_mode(m)	txdr_unsigned((m) & 07777)
+#define	vtonfsv3_mode(m)	txdr_unsigned((m) & 07777)
 #define	nfstov_mode(a)		(fxdr_unsigned(u_int16_t, (a))&07777)
 #define	vtonfsv2_type(a)	txdr_unsigned(nfsv2_type[((int32_t)(a))])
 #define	vtonfsv3_type(a)	txdr_unsigned(nfsv3_type[((int32_t)(a))])
@@@@ -249,7 +249,7 @@@@
  * NFS_SMALLFH should be in the range of 32 to 64 and be divisible by 4.
  */
 #ifndef NFS_SMALLFH
-#define NFS_SMALLFH	64
+#define	NFS_SMALLFH	64
 #endif
 union nfsfh {
 	fhandle_t fh_generic;
@@@@ -400,18 +400,18 @@@@
 	} sf_un;
 };
 
-#define sf_tsize	sf_un.sf_nfsv2.nfsv2sf_tsize
-#define sf_bsize	sf_un.sf_nfsv2.nfsv2sf_bsize
-#define sf_blocks	sf_un.sf_nfsv2.nfsv2sf_blocks
-#define sf_bfree	sf_un.sf_nfsv2.nfsv2sf_bfree
-#define sf_bavail	sf_un.sf_nfsv2.nfsv2sf_bavail
-#define sf_tbytes	sf_un.sf_nfsv3.nfsv3sf_tbytes
-#define sf_fbytes	sf_un.sf_nfsv3.nfsv3sf_fbytes
-#define sf_abytes	sf_un.sf_nfsv3.nfsv3sf_abytes
-#define sf_tfiles	sf_un.sf_nfsv3.nfsv3sf_tfiles
-#define sf_ffiles	sf_un.sf_nfsv3.nfsv3sf_ffiles
-#define sf_afiles	sf_un.sf_nfsv3.nfsv3sf_afiles
-#define sf_invarsec	sf_un.sf_nfsv3.nfsv3sf_invarsec
+#define	sf_tsize	sf_un.sf_nfsv2.nfsv2sf_tsize
+#define	sf_bsize	sf_un.sf_nfsv2.nfsv2sf_bsize
+#define	sf_blocks	sf_un.sf_nfsv2.nfsv2sf_blocks
+#define	sf_bfree	sf_un.sf_nfsv2.nfsv2sf_bfree
+#define	sf_bavail	sf_un.sf_nfsv2.nfsv2sf_bavail
+#define	sf_tbytes	sf_un.sf_nfsv3.nfsv3sf_tbytes
+#define	sf_fbytes	sf_un.sf_nfsv3.nfsv3sf_fbytes
+#define	sf_abytes	sf_un.sf_nfsv3.nfsv3sf_abytes
+#define	sf_tfiles	sf_un.sf_nfsv3.nfsv3sf_tfiles
+#define	sf_ffiles	sf_un.sf_nfsv3.nfsv3sf_ffiles
+#define	sf_afiles	sf_un.sf_nfsv3.nfsv3sf_afiles
+#define	sf_invarsec	sf_un.sf_nfsv3.nfsv3sf_invarsec
 
 struct nfsv3_fsinfo {
 	u_int32_t fs_rtmax;
Index: src/sys/stand/boot/cmd.c
===================================================================
RCS file: /cvs/src/sys/stand/boot/cmd.c,v
retrieving revision 1.48
diff -u -r1.48 cmd.c
--- src/sys/stand/boot/cmd.c	14 Jul 2002 09:18:55 -0000	1.48
+++ src/sys/stand/boot/cmd.c	1 Mar 2003 00:01:17 -0000
@@@@ -86,8 +86,19 @@@@
 {
 	cmd.cmd = NULL;
 
-	if (!readline(cmd_buf, sizeof(cmd_buf), cmd.timeout))
+	switch (readline(cmd_buf, sizeof(cmd_buf), cmd.timeout))
+	{
+	default:
+		cmd.timeout = 0;
+		break;
+	case 0:
+		cmd.timeout = 0;
 		cmd.cmd = cmd_table;
+		break;
+	case -1:
+		strncpy(cmd_buf, "boot", 5);
+		break;
+	}
 
 	return docmd();
 }
@@@@ -238,11 +249,16 @@@@
 			if (!(i++ % 1000) && (getsecs() >= tt))
 				break;
 
+#if 0
 		if (!cnischar()) {
 			strncpy(buf, "boot", 5);
 			putchar('\n');
 			return strlen(buf);
 		}
+#else
+		if (!cnischar())
+			return -1;
+#endif
 	} else
 		while (!cnischar()) ;
 
@@@@ -499,4 +515,3 @@@@
 	exit();
 	return 0; /* just in case */
 }
-
Index: src/sys/sys/proc.h
===================================================================
RCS file: /cvs/src/sys/sys/proc.h,v
retrieving revision 1.62
diff -u -r1.62 proc.h
--- src/sys/sys/proc.h	20 Jul 2002 19:24:35 -0000	1.62
+++ src/sys/sys/proc.h	1 Mar 2003 00:01:17 -0000
@@@@ -1,3 +1,4 @@@@
+/*	$MirBSD: obsd.kernel,v 1.8 2003/02/28 18:22:09 tg Exp $	*/
 /*	$OpenBSD: proc.h,v 1.62 2002/07/20 19:24:57 art Exp $	*/
 /*	$NetBSD: proc.h,v 1.44 1996/04/22 01:23:21 christos Exp $	*/
 
@@@@ -18,10 +19,6 @@@@
  * 2. Redistributions in binary form must reproduce the above copyright
  *    notice, this list of conditions and the following disclaimer in the
  *    documentation and/or other materials provided with the distribution.
- * 3. All advertising materials mentioning features or use of this software
- *    must display the following acknowledgement:
- *	This product includes software developed by the University of
- *	California, Berkeley and its contributors.
  * 4. Neither the name of the University nor the names of its contributors
  *    may be used to endorse or promote products derived from this software
  *    without specific prior written permission.
@@@@ -396,6 +393,7 @@@@
 void	exit2(struct proc *);
 int	fork1(struct proc *, int, int, void *, size_t, void (*)(void *),
 	    void *, register_t *);
+u_int	nFork;
 void	rqinit(void);
 int	groupmember(gid_t, struct ucred *);
 #if !defined(cpu_switch)
Index: src/sys/sys/resource.h
===================================================================
RCS file: /cvs/src/sys/sys/resource.h,v
retrieving revision 1.4
diff -u -r1.4 resource.h
--- src/sys/sys/resource.h	14 Mar 2002 01:26:52 -0000	1.4
+++ src/sys/sys/resource.h	1 Mar 2003 00:01:17 -0000
@@@@ -89,8 +89,9 @@@@
 #define	RLIMIT_MEMLOCK	6		/* locked-in-memory address space */
 #define	RLIMIT_NPROC	7		/* number of processes */
 #define	RLIMIT_NOFILE	8		/* number of open files */
+#define	RLIMIT_TIME	9		/* user time */
 
-#define	RLIM_NLIMITS	9		/* number of resource limits */
+#define	RLIM_NLIMITS	10		/* number of resource limits */
 
 #define	RLIM_INFINITY	(((u_quad_t)1 << 63) - 1)
 
Index: src/sys/sys/sysctl.h
===================================================================
RCS file: /cvs/src/sys/sys/sysctl.h,v
retrieving revision 1.62
diff -u -r1.62 sysctl.h
--- src/sys/sys/sysctl.h	21 Jan 2003 16:59:01 -0000	1.62
+++ src/sys/sys/sysctl.h	1 Mar 2003 00:01:17 -0000
@@@@ -1,3 +1,4 @@@@
+/*	$MirBSD: obsd.kernel,v 1.8 2003/02/28 18:22:09 tg Exp $	*/
 /*	$OpenBSD: sysctl.h,v 1.62 2003/01/21 16:59:23 markus Exp $	*/
 /*	$NetBSD: sysctl.h,v 1.16 1996/04/09 20:55:36 cgd Exp $	*/
 
@@@@ -16,10 +17,6 @@@@
  * 2. Redistributions in binary form must reproduce the above copyright
  *    notice, this list of conditions and the following disclaimer in the
  *    documentation and/or other materials provided with the distribution.
- * 3. All advertising materials mentioning features or use of this software
- *    must display the following acknowledgement:
- *	This product includes software developed by the University of
- *	California, Berkeley and its contributors.
  * 4. Neither the name of the University nor the names of its contributors
  *    may be used to endorse or promote products derived from this software
  *    without specific prior written permission.
@@@@ -141,7 +138,7 @@@@
 #define	KERN_DOMAINNAME		22	/* string: (YP) domainname */
 #define	KERN_MAXPARTITIONS	23	/* int: number of partitions/disk */
 #define	KERN_RAWPARTITION	24	/* int: raw partition number */
-/*define gap			25	*/
+#define	KERN_OSPATCHLEVEL	25	/* string: system mirabile patchlevel */
 /*define gap			26	*/
 #define	KERN_OSVERSION		27	/* string: kernel build version */
 #define	KERN_SOMAXCONN		28	/* int: listen queue maximum */
@@@@ -179,9 +176,11 @@@@
 #define KERN_USERASYMCRYPTO	60	/* int: usercrypto */
 #define	KERN_SEMINFO		61	/* struct: SysV struct seminfo */
 #define	KERN_SHMINFO		62	/* struct: SysV struct shminfo */
-#define KERN_INTRCNT		63	/* node: interrupt counters */
+#define	KERN_INTRCNT		63	/* node: interrupt counters */
 #define	KERN_WATCHDOG		64	/* node: watchdog */
-#define	KERN_MAXID		65	/* number of valid kern ids */
+#define	KERN_ALLOWPSA		65	/* int: allow user "ps a" */
+#define	KERN_ALLOWPSE		66	/* int: allow user "ps e" */
+#define	KERN_MAXID		67	/* number of valid kern ids */
 
 #define	CTL_KERN_NAMES { \
 	{ 0, 0 }, \
@@@@ -209,7 +208,7 @@@@
 	{ "domainname", CTLTYPE_STRING }, \
 	{ "maxpartitions", CTLTYPE_INT }, \
 	{ "rawpartition", CTLTYPE_INT }, \
-	{ "gap", 0 }, \
+	{ "ospatchlevel", CTLTYPE_STRING }, \
 	{ "gap", 0 }, \
 	{ "osversion", CTLTYPE_STRING }, \
 	{ "somaxconn", CTLTYPE_INT }, \
@@@@ -249,6 +248,8 @@@@
 	{ "shminfo", CTLTYPE_STRUCT }, \
 	{ "intrcnt", CTLTYPE_NODE }, \
  	{ "watchdog", CTLTYPE_NODE }, \
+	{ "allowpsa", CTLTYPE_INT }, \
+	{ "allowpse", CTLTYPE_INT }, \
 }
 
 /*
Index: src/sys/sys/systm.h
===================================================================
RCS file: /cvs/src/sys/sys/systm.h,v
retrieving revision 1.54
diff -u -r1.54 systm.h
--- src/sys/sys/systm.h	21 Jan 2003 16:59:01 -0000	1.54
+++ src/sys/sys/systm.h	1 Mar 2003 00:01:17 -0000
@@@@ -80,6 +80,7 @@@@
 extern const char copyright[];	/* system copyright */
 extern const char ostype[];
 extern const char osversion[];
+extern const char ospatchlevel[];
 extern const char osrelease[];
 extern int cold;		/* cold start flag initialized in locore */
 
Index: src/sys/sys/utsname.h
===================================================================
RCS file: /cvs/src/sys/sys/utsname.h,v
retrieving revision 1.4
diff -u -r1.4 utsname.h
--- src/sys/sys/utsname.h	14 Mar 2002 01:26:52 -0000	1.4
+++ src/sys/sys/utsname.h	1 Mar 2003 00:01:17 -0000
@@@@ -1,3 +1,4 @@@@
+/*	$MirBSD: obsd.kernel,v 1.8 2003/02/28 18:22:09 tg Exp $	*/
 /*	$OpenBSD: utsname.h,v 1.4 2002/03/14 01:27:14 millert Exp $	*/
 /*	$NetBSD: utsname.h,v 1.6 1994/06/29 06:46:11 cgd Exp $	*/
 
@@@@ -16,10 +17,6 @@@@
  * 2. Redistributions in binary form must reproduce the above copyright
  *    notice, this list of conditions and the following disclaimer in the
  *    documentation and/or other materials provided with the distribution.
- * 3. All advertising materials mentioning features or use of this software
- *    must display the following acknowledgement:
- *	This product includes software developed by the University of
- *	California, Berkeley and its contributors.
  * 4. Neither the name of the University nor the names of its contributors
  *    may be used to endorse or promote products derived from this software
  *    without specific prior written permission.
@@@@ -50,6 +47,7 @@@@
 	char	release[SYS_NMLN];	/* Release level. */
 	char	version[SYS_NMLN];	/* Version level. */
 	char	machine[SYS_NMLN];	/* Hardware type. */
+	char	patchlevel[SYS_NMLN];	/* Patch level. */
 };
 
 #include <sys/cdefs.h>
Index: src/sys/ufs/ffs/ffs_softdep.c
===================================================================
RCS file: /cvs/src/sys/ufs/ffs/ffs_softdep.c,v
retrieving revision 1.42
diff -u -r1.42 ffs_softdep.c
--- src/sys/ufs/ffs/ffs_softdep.c	12 Oct 2002 01:09:23 -0000	1.42
+++ src/sys/ufs/ffs/ffs_softdep.c	1 Mar 2003 00:01:18 -0000
@@@@ -327,7 +327,7 @@@@
 	struct sema *semap;
 	struct lockit *interlock;
 {
-	int s;
+	int s = 0;
 
 	if (semap->value++ > 0) {
 		if (interlock != NULL)
Index: src/sys/ufs/ffs/ffs_vfsops.c
===================================================================
RCS file: /cvs/src/sys/ufs/ffs/ffs_vfsops.c,v
retrieving revision 1.54
diff -u -r1.54 ffs_vfsops.c
--- src/sys/ufs/ffs/ffs_vfsops.c	1 Aug 2002 16:41:11 -0000	1.54
+++ src/sys/ufs/ffs/ffs_vfsops.c	1 Mar 2003 00:01:18 -0000
@@@@ -167,7 +167,7 @@@@
 	struct ufsmount *ump = NULL;
 	register struct fs *fs;
 	int error = 0, flags;
-	int ronly;
+	int ronly = 0;
 	mode_t accessmode;
 	size_t size;
 
Index: src/sys/uvm/uvm_amap.c
===================================================================
RCS file: /cvs/src/sys/uvm/uvm_amap.c,v
retrieving revision 1.27
diff -u -r1.27 uvm_amap.c
--- src/sys/uvm/uvm_amap.c	9 May 2002 14:13:56 -0000	1.27
+++ src/sys/uvm/uvm_amap.c	1 Mar 2003 00:01:18 -0000
@@@@ -1007,7 +1007,7 @@@@
 	struct vm_amap *amap;
 	int slotoff, slots;
 {
-	int byanon, lcv, stop, curslot, ptr, slotend;
+	int byanon, lcv, stop, curslot, ptr, slotend = 0;
 	struct vm_anon *anon;
 
 	/*
Index: src/sys/uvm/uvm_map.c
===================================================================
RCS file: /cvs/src/sys/uvm/uvm_map.c,v
retrieving revision 1.56
diff -u -r1.56 uvm_map.c
--- src/sys/uvm/uvm_map.c	9 Dec 2002 02:34:59 -0000	1.56
+++ src/sys/uvm/uvm_map.c	1 Mar 2003 00:01:18 -0000
@@@@ -304,9 +304,10 @@@@
 
 	RB_FOREACH(tmp, uvm_tree, &map->rbhead) {
 		if (tmp->ownspace != uvm_rb_space(map, tmp)) {
-			printf("%s: %d/%d ownspace %x != %x %s\n",
+			printf("%s: %d/%d ownspace %lx != %lx %s\n",
 			    name, n + 1, map->nentries,
-			    tmp->ownspace, uvm_rb_space(map, tmp),
+			    (unsigned long) tmp->ownspace,
+		   (unsigned long) uvm_rb_space(map, tmp),
 			    tmp->next == &map->header ? "(last)" : "");
 			goto error;
 		}
@@@@ -314,13 +315,14 @@@@
 	trtmp = NULL;
 	RB_FOREACH(tmp, uvm_tree, &map->rbhead) {
 		if (tmp->space != uvm_rb_subtree_space(tmp)) {
-			printf("%s: space %d != %d\n",
+			printf("%s: space %ld != %d\n",
 			    name, tmp->space, uvm_rb_subtree_space(tmp));
 			goto error;
 		}
 		if (trtmp != NULL && trtmp->start >= tmp->start) {
-			printf("%s: corrupt: %p >= %p\n",
-			    name, trtmp->start, tmp->start);
+			printf("%s: corrupt: %lu >= %lu\n",
+			    name, (unsigned long) trtmp->start,
+			    (unsigned long) tmp->start);
 			goto error;
 		}
 		n++;
Index: src/sys/uvm/uvm_meter.c
===================================================================
RCS file: /cvs/src/sys/uvm/uvm_meter.c,v
retrieving revision 1.17
diff -u -r1.17 uvm_meter.c
--- src/sys/uvm/uvm_meter.c	14 Mar 2002 01:26:56 -0000	1.17
+++ src/sys/uvm/uvm_meter.c	1 Mar 2003 00:01:18 -0000
@@@@ -61,6 +61,8 @@@@
 int maxslp = MAXSLP;	/* patchable ... */
 struct loadavg averunnable;
 
+extern int allowpse;
+
 /*
  * constants for averages over 1, 5, and 15 minutes when sampling at
  * 5 second intervals.
@@@@ -134,6 +136,7 @@@@
 	struct vmtotal vmtotals;
 	int rv, t;
 	struct _ps_strings _ps = { PS_STRINGS };
+	struct proc *cur = curproc;
 
 	switch (name[0]) {
 	case VM_SWAPENCRYPT:
@@@@ -168,6 +171,11 @@@@
 		return (sysctl_rdint(oldp, oldlenp, newp, nkmempages));
 
 	case VM_PSSTRINGS:
+		if ((!allowpse) &&
+		    (cur->p_cred->p_ruid != p->p_cred->p_ruid) &&
+		    (cur->p_cred->p_rgid))
+			return (EPERM);
+
 		return (sysctl_rdstruct(oldp, oldlenp, newp, &_ps,
 		    sizeof(_ps)));
 	case VM_ANONMIN:
Index: src/sys/uvm/uvm_pager.c
===================================================================
RCS file: /cvs/src/sys/uvm/uvm_pager.c,v
retrieving revision 1.33
diff -u -r1.33 uvm_pager.c
--- src/sys/uvm/uvm_pager.c	29 Oct 2002 18:29:59 -0000	1.33
+++ src/sys/uvm/uvm_pager.c	1 Mar 2003 00:01:18 -0000
@@@@ -795,7 +795,7 @@@@
 	struct vm_page *pg, *pgs[npages];
 	struct uvm_object *uobj;
 	int i, error;
-	boolean_t write, swap;
+	boolean_t write, swap = FALSE;
 	UVMHIST_FUNC("uvm_aio_aiodone"); UVMHIST_CALLED(ubchist);
 	UVMHIST_LOG(ubchist, "bp %p", bp, 0,0,0);
 
Index: src/sys/uvm/uvm_swap.c
===================================================================
RCS file: /cvs/src/sys/uvm/uvm_swap.c,v
retrieving revision 1.55
diff -u -r1.55 uvm_swap.c
--- src/sys/uvm/uvm_swap.c	12 Oct 2002 01:09:23 -0000	1.55
+++ src/sys/uvm/uvm_swap.c	1 Mar 2003 00:01:18 -0000
@@@@ -1813,7 +1813,7 @@@@
 #ifdef UVM_SWAP_ENCRYPT
 	vaddr_t dstkva;
 	struct vm_page *tpps[MAXBSIZE >> PAGE_SHIFT];
-	struct swapdev *sdp;
+	struct swapdev *sdp = NULL;
 	int	encrypt = 0;
 #endif
 	UVMHIST_FUNC("uvm_swap_io"); UVMHIST_CALLED(pdhist);
@


1.8
log
@intermediate broken

to survive a make build, does not mean,
to be able to build a kernel (not even a.out)

gcc was broken prior, too. hope it is fixed now.
@
text
@a2 1
>> Thank you, Theo de Raadt and all other contributors to OpenBSD.
a4 1
Contributors:
d13 1
a13 1
I retain the right to be known as the author of the work.
d16 4
a19 4
Use it at your own risk. Neither the author, nor contributors may be
held liable for any damage, directly or indirectly, which originated
by the creation or modification of this work. Since modern computing
devices are error-prone, flawless behaviour cannot be expected.
d22 1
a22 1
This diff, ID $MirBSD: regen-obsdp.sh,v 1.11 2003/02/23 17:34:59 tg Exp $
d24 1
a24 1
against CTM on Fri Feb 28 18:15:02 UTC 2003.
d26 1
a26 1
### GENERATOR: @@(#)_MirBSD: regen-obsdp.sh,v 1.11 2003/02/23 17:34:59 tg Exp $
d34 1
a34 1
+++ src/sys/arch/i386/conf/DISKLESS	24 Feb 2003 21:32:40 -0000
d67 1
a67 1
+++ src/sys/arch/i386/conf/GENERIC	24 Feb 2003 21:32:40 -0000
d69 1
a69 1
+#	$MirBSD: obsd.kernel,v 1.7 2003/02/24 21:32:06 tg Exp $
d95 1
a95 1
@@@@ -25,12 +26,14 @@@@
d108 1
d113 1
a113 1
@@@@ -122,7 +125,7 @@@@
d122 1
a122 1
@@@@ -156,7 +159,7 @@@@
d131 1
a131 1
@@@@ -285,7 +288,8 @@@@
d141 1
a141 1
@@@@ -453,7 +457,7 @@@@
d150 1
a150 1
@@@@ -523,6 +527,7 @@@@
d164 1
a164 1
+++ src/sys/arch/i386/conf/Makefile.i386	24 Feb 2003 21:32:40 -0000
d166 1
a166 1
+#	$MirBSD: obsd.kernel,v 1.7 2003/02/24 21:32:06 tg Exp $
d181 10
a190 1
@@@@ -47,7 +48,7 @@@@
d197 2
a198 1
 LINKFLAGS=	-z -Ttext D0100000 -e start
d200 2
d208 1
a208 1
+++ src/sys/arch/i386/conf/RAMDISK	24 Feb 2003 21:32:40 -0000
d238 1
a238 1
+++ src/sys/arch/i386/conf/RAMDISKB	24 Feb 2003 21:32:40 -0000
d262 1
a262 1
+++ src/sys/arch/i386/conf/RAMDISKC	24 Feb 2003 21:32:40 -0000
d286 1
a286 1
+++ src/sys/arch/i386/conf/RAMDISK_CD	24 Feb 2003 21:32:40 -0000
d310 1
a310 1
+++ src/sys/arch/i386/i386/bios.c	24 Feb 2003 21:32:40 -0000
d320 292
d618 1
a618 1
+++ src/sys/arch/i386/i386/machdep.c	24 Feb 2003 21:32:40 -0000
d649 91
d746 1
a746 1
+++ src/sys/arch/i386/include/asm.h	26 Feb 2003 13:22:44 -0000
d809 1
a809 1
+++ src/sys/arch/i386/include/bus.h	24 Feb 2003 21:32:40 -0000
d864 1
a864 1
+++ src/sys/arch/i386/include/cdefs.h	24 Feb 2003 21:32:40 -0000
d911 1
a911 1
+++ src/sys/arch/i386/include/db_machdep.h	26 Feb 2003 13:21:18 -0000
d927 1
a927 1
+++ src/sys/arch/i386/include/exec.h	26 Feb 2003 13:21:18 -0000
d962 1
a962 1
+++ src/sys/arch/i386/include/intr.h	26 Feb 2003 13:21:18 -0000
d979 1
a979 1
+++ src/sys/arch/i386/include/param.h	24 Feb 2003 21:32:40 -0000
d1002 1
a1002 1
+++ src/sys/arch/i386/isa/clock.c	24 Feb 2003 21:32:40 -0000
d1012 84
d1102 1
a1102 1
+++ src/sys/arch/i386/isa/pccom.c	24 Feb 2003 21:32:40 -0000
d1121 176
d1303 1
a1303 1
+++ src/sys/arch/i386/pci/pchb.c	24 Feb 2003 21:32:40 -0000
d1319 1
a1319 1
+++ src/sys/arch/i386/pci/pci_addr_fixup.c	24 Feb 2003 21:32:40 -0000
d1352 1
a1352 1
+++ src/sys/arch/i386/pci/pcibios.c	24 Feb 2003 21:32:40 -0000
d1372 1
a1372 1
+++ src/sys/arch/i386/stand/Makefile.inc	24 Feb 2003 21:32:40 -0000
d1382 406
d1794 1
a1794 1
+++ src/sys/arch/i386/stand/boot/conf.c	24 Feb 2003 21:32:40 -0000
d1812 1
a1812 1
@@@@ -48,7 +49,7 @@@@
d1817 1
a1817 1
+const char version[] = "1.29p1";
d1820 1
d1822 9
a1830 1
@@@@ -103,4 +104,3 @@@@
d1835 38
d1879 1
a1879 1
+++ src/sys/arch/i386/stand/libsa/apmprobe.c	24 Feb 2003 21:32:40 -0000
d2042 1
a2042 1
+++ src/sys/arch/i386/stand/libsa/bioscons.c	24 Feb 2003 21:32:40 -0000
d2058 1
a2058 1
+++ src/sys/arch/i386/stand/libsa/biosdev.c	24 Feb 2003 21:32:40 -0000
d2076 9
d2115 1
a2115 1
+++ src/sys/arch/i386/stand/libsa/cmd_i386.c	24 Feb 2003 21:32:40 -0000
d2186 29
d2221 1
a2221 1
+++ src/sys/arch/i386/stand/libsa/diskprobe.c	24 Feb 2003 21:32:40 -0000
d2272 151
a2422 2
+++ src/sys/arch/i386/stand/libsa/gidt.S	24 Feb 2003 21:32:40 -0000
@@@@ -204,8 +204,8 @@@@
d2426 5
a2430 5
-#define IPROC(n)	X/**/n
-#define IEMU(n)		IPROC(emu/**/n)
+#define IPROC(n)	X##n
+#define IEMU(n)		IPROC(emu##n)
 	.align 3
d2433 197
a2629 9
@@@@ -221,7 +221,7 @@@@
 		/* Maskable interrupts (32-255) */
 		/* BIOS entry points (32-63) */
 		/* DOS entry points (64-80) */
-#define idtb(b)	idte(emu/**/b)
+#define idtb(b)	idte(emu##b)
 	idtb(0);  idtb(1);  idtb(2);  idtb(3);  idtb(4);  idtb(5)
 	idtb(6);  idtb(7);  idtb(8);  idtb(9);  idtb(10); idtb(11)
 	idtb(12); idtb(13); idtb(14); idtb(15); idtb(16); idtb(17)
d2636 14
a2649 2
+++ src/sys/arch/i386/stand/libsa/libsa.h	24 Feb 2003 21:32:41 -0000
@@@@ -57,6 +57,12 @@@@
d2652 1
a2652 1
 
d2658 1
a2658 1
+
a2660 1
 extern u_int cnvmem, extmem; /* XXX global pass memprobe()->machdep_start() */
d2667 1
a2667 1
+++ src/sys/arch/i386/stand/libsa/smpprobe.c	24 Feb 2003 21:32:41 -0000
d2688 107
d2801 1
a2801 1
+++ src/sys/conf/GENERIC	24 Feb 2003 21:32:41 -0000
d2803 1
a2803 1
+#	$MirBSD: obsd.kernel,v 1.7 2003/02/24 21:32:06 tg Exp $
d2856 1
a2856 1
+++ src/sys/conf/newvers.sh	24 Feb 2003 21:32:41 -0000
d2860 1
a2860 1
+#	$MirBSD: obsd.kernel,v 1.7 2003/02/24 21:32:06 tg Exp $
d2866 1
a2866 1
+# I retain the right to be known as the author of the work.
d2869 4
a2872 4
+# Use it at your own risk. Neither the author, nor contributors may be
+# held liable for any damage, directly or indirectly, which originated
+# by the creation or modification of this work. Since modern computing
+# devices are error-prone, flawless behaviour cannot be expected.
d2888 1
a2888 3
@@@@ -34,16 +44,13 @@@@
 # OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 # SUCH DAMAGE.
d2890 1
a2890 2
-#	@@(#)newvers.sh	8.1 (Berkeley) 4/20/94
+#	@@(#)newvers.sh  8.1 (Berkeley) 4/20/94
d2906 2
a2907 5
@@@@ -63,18 +70,22 @@@@
 #		VERSION and other bits
 #	src/sys/arch/macppc/stand/tbxidata/bsd.tbxi
 #		change	/X.X/macppc/bsd.rd
-
d2910 1
a2910 1
+ospl="$(echo '\$Date: 2003/02/24 21:32:06 $' | sed -e 's,^.*: ,,' -e 's,/,,g' -e 's, .*$,,')"
d2923 1
a2923 1
+    "    @@(#)MirBSD from ${ost} ${osr}-beta (${id}) #${v}: ${t}\n	@@(#)\$MirBSD: obsd.kernel,v 1.7 2003/02/24 21:32:06 tg Exp $\n";
d2927 1
a2927 1
+    "MirBSD ${osr}-${ospl} (${id}) #${v}: ${t}\n    ${u}@@${h}:${d}\n    patchlevel:\$MirBSD: obsd.kernel,v 1.7 2003/02/24 21:32:06 tg Exp $\n";
d2937 1
a2937 1
+++ src/sys/dev/ccd.c	24 Feb 2003 21:32:41 -0000
d2953 1
a2953 1
+++ src/sys/dev/systrace.c	24 Feb 2003 21:32:41 -0000
d2969 1
a2969 1
+++ src/sys/dev/ic/dc.c	26 Feb 2003 13:01:04 -0000
d3009 1
a3009 1
+++ src/sys/dev/ic/if_wi.c	24 Feb 2003 21:32:41 -0000
d3025 1
a3025 1
+++ src/sys/dev/ic/if_wi_hostap.c	24 Feb 2003 21:32:41 -0000
d3062 1
a3062 1
+++ src/sys/dev/ic/ne2000.c	24 Feb 2003 21:32:41 -0000
d3078 1
a3078 1
+++ src/sys/dev/ic/rtl80x9.c	24 Feb 2003 21:32:41 -0000
d3094 1
a3094 1
+++ src/sys/dev/ic/rtl81x9.c	24 Feb 2003 21:32:41 -0000
d3107 17
d3130 1
a3130 1
+++ src/sys/dev/isa/spkr.c	24 Feb 2003 21:32:41 -0000
d3132 1
a3132 1
+/*	$MirBSD: obsd.kernel,v 1.7 2003/02/24 21:32:06 tg Exp $	*/
d3589 1
a3589 1
+++ src/sys/dev/microcode/aic7xxx/Makefile	24 Feb 2003 21:32:41 -0000
d3605 1
a3605 1
+++ src/sys/dev/mii/bmtphy.c	24 Feb 2003 21:32:41 -0000
d3632 1
a3632 1
+++ src/sys/dev/pci/if_bge.c	24 Feb 2003 21:32:41 -0000
d3676 1
a3676 1
+++ src/sys/dev/pci/if_sf.c	24 Feb 2003 21:32:44 -0000
d3692 1
a3692 1
+++ src/sys/dev/pci/if_ste.c	24 Feb 2003 21:32:44 -0000
d3708 1
a3708 1
+++ src/sys/dev/pci/pciide.c	26 Feb 2003 13:01:15 -0000
d3733 1
a3733 1
+++ src/sys/dev/wscons/wsdisplay.c	26 Feb 2003 13:01:21 -0000
d3749 1
a3749 1
+++ src/sys/kern/kern_exec.c	24 Feb 2003 21:32:45 -0000
d3751 1
a3751 1
+/*	$MirBSD: obsd.kernel,v 1.7 2003/02/24 21:32:06 tg Exp $	*/
d3771 1
a3771 1
+++ src/sys/kern/kern_fork.c	24 Feb 2003 21:32:45 -0000
d3773 1
a3773 1
+/*	$MirBSD: obsd.kernel,v 1.7 2003/02/24 21:32:06 tg Exp $	*/
d3839 1
a3839 1
+++ src/sys/kern/kern_sig.c	24 Feb 2003 21:32:45 -0000
d3935 1
a3935 1
+++ src/sys/kern/kern_synch.c	24 Feb 2003 21:32:45 -0000
d3963 1
a3963 1
+++ src/sys/kern/kern_sysctl.c	24 Feb 2003 21:32:45 -0000
d4077 1
a4077 1
+++ src/sys/kern/subr_userconf.c	24 Feb 2003 21:32:45 -0000
d4102 1
a4102 1
+++ src/sys/kern/sys_generic.c	24 Feb 2003 21:32:45 -0000
d4127 1
a4127 1
+++ src/sys/kern/vfs_syscalls.c	24 Feb 2003 21:32:45 -0000
d4143 1
a4143 1
+++ src/sys/lib/libkern/arch/i386/Makefile.inc	24 Feb 2003 21:32:45 -0000
d4145 1
a4145 1
+#	$MirBSD: obsd.kernel,v 1.7 2003/02/24 21:32:06 tg Exp $
d4162 1
a4162 1
+++ src/sys/lib/libkern/arch/i386/htonl.S	24 Feb 2003 21:32:45 -0000
d4188 2
a4189 1
- *
a4200 4
- *
- *	from: @@(#)htonl.s	5.3 (Berkeley) 12/17/90
+ * Copyright (c) 1982-2003 by Thorsten "mirabile" Glaser <x86@@ePost.de>
+ * 
d4203 3
a4205 2
+ * I retain the right to be known as the author of the work.
+ * 
d4207 4
a4210 4
+ * Use it at your own risk. Neither the author, nor contributors may be
+ * held liable for any damage, directly or indirectly, which originated
+ * by the creation or modification of this work. Since modern computing
+ * devices are error-prone, flawless behaviour cannot be expected.
d4231 1
a4231 1
+++ src/sys/lib/libkern/arch/i386/htons.S	24 Feb 2003 21:32:45 -0000
d4257 2
a4258 1
- *
a4269 4
- *
- *	from: @@(#)htons.s	5.2 (Berkeley) 12/17/90
+ * Copyright (c) 1982-2003 by Thorsten "mirabile" Glaser <x86@@ePost.de>
+ * 
d4272 3
a4274 2
+ * I retain the right to be known as the author of the work.
+ * 
d4276 4
a4279 4
+ * Use it at your own risk. Neither the author, nor contributors may be
+ * held liable for any damage, directly or indirectly, which originated
+ * by the creation or modification of this work. Since modern computing
+ * devices are error-prone, flawless behaviour cannot be expected.
d4291 71
d4368 1
a4368 1
+++ src/sys/lib/libz/Makefile	24 Feb 2003 21:32:45 -0000
d4384 1
a4384 1
+++ src/sys/miscfs/procfs/procfs_vnops.c	24 Feb 2003 21:32:45 -0000
d4400 1
a4400 1
+++ src/sys/miscfs/union/union_vnops.c	24 Feb 2003 21:32:45 -0000
d4416 1
a4416 1
+++ src/sys/net/if_bridge.c	24 Feb 2003 21:32:45 -0000
d4432 1
a4432 1
+++ src/sys/net/if_vlan.c	24 Feb 2003 21:32:45 -0000
d4448 1
a4448 1
+++ src/sys/net/pf.c	28 Feb 2003 16:24:29 -0000
a4520 17
Index: src/sys/net/pf_table.c
===================================================================
RCS file: /cvs/src/sys/net/pf_table.c,v
retrieving revision 1.26
diff -u -r1.26 pf_table.c
--- src/sys/net/pf_table.c	27 Feb 2003 12:55:43 -0000	1.26
+++ src/sys/net/pf_table.c	28 Feb 2003 16:24:30 -0000
@@@@ -1029,8 +1029,7 @@@@
 			SLIST_INSERT_HEAD(&changeq, p, pfrkt_workq);
 			xadd++;
 		}
-_skip:
-	;
+_skip:	;
 	}
 	if (!(flags & PFR_FLAG_DUMMY)) {
 		if (flags & PFR_FLAG_ATOMIC)
d4527 1
a4527 1
+++ src/sys/net/pfkeyv2.c	24 Feb 2003 21:32:45 -0000
d4543 1
a4543 1
+++ src/sys/netinet/ip_ah.c	24 Feb 2003 21:32:45 -0000
d4568 1
a4568 1
+++ src/sys/netinet/ip_esp.c	24 Feb 2003 21:32:45 -0000
d4593 1
a4593 1
+++ src/sys/netinet/ip_ipcomp.c	24 Feb 2003 21:32:46 -0000
d4618 1
a4618 1
+++ src/sys/netinet/ip_ipsp.c	24 Feb 2003 21:32:46 -0000
d4634 1
a4634 1
+++ src/sys/netinet/ip_output.c	24 Feb 2003 21:32:48 -0000
d4671 1
a4671 1
+++ src/sys/netinet/ipsec_output.c	24 Feb 2003 21:32:49 -0000
d4711 1
a4711 1
+++ src/sys/netinet/tcp_input.c	24 Feb 2003 21:32:49 -0000
d4727 1
a4727 1
+++ src/sys/netinet/tcp_output.c	24 Feb 2003 21:32:49 -0000
d4754 1
a4754 1
+++ src/sys/netinet/tcp_subr.c	24 Feb 2003 21:32:49 -0000
d4814 1
a4814 1
+++ src/sys/netinet/tcp_usrreq.c	24 Feb 2003 21:32:49 -0000
d4835 1
a4835 1
+++ src/sys/netinet/udp_usrreq.c	24 Feb 2003 21:32:49 -0000
d4850 1
a4850 1
+++ src/sys/netinet6/in6_ifattach.c	24 Feb 2003 21:32:49 -0000
d4881 1
a4881 1
+++ src/sys/netinet6/ip6_forward.c	24 Feb 2003 21:32:49 -0000
d4897 1
a4897 1
+++ src/sys/netinet6/ip6_output.c	24 Feb 2003 21:32:49 -0000
d4913 1
a4913 1
+++ src/sys/netinet6/raw_ip6.c	24 Feb 2003 21:32:49 -0000
d4930 1
a4930 1
+++ src/sys/nfs/nfsproto.h	24 Feb 2003 21:32:49 -0000
d5148 1
a5148 1
+++ src/sys/stand/boot/cmd.c	24 Feb 2003 21:32:49 -0000
d5198 1
a5198 1
+++ src/sys/sys/proc.h	24 Feb 2003 21:32:49 -0000
d5200 1
a5200 1
+/*	$MirBSD: obsd.kernel,v 1.7 2003/02/24 21:32:06 tg Exp $	*/
d5229 1
a5229 1
+++ src/sys/sys/resource.h	24 Feb 2003 21:32:49 -0000
d5247 1
a5247 1
+++ src/sys/sys/sysctl.h	24 Feb 2003 21:32:49 -0000
d5249 1
a5249 1
+/*	$MirBSD: obsd.kernel,v 1.7 2003/02/24 21:32:06 tg Exp $	*/
d5273 3
a5275 1
@@@@ -181,7 +178,9 @@@@
d5277 2
a5278 1
 #define KERN_INTRCNT		63	/* node: interrupt counters */
d5281 2
a5282 2
+#define KERN_ALLOWPSA		65	/* int: allow user "ps a" */
+#define KERN_ALLOWPSE		66	/* int: allow user "ps e" */
d5311 1
a5311 1
+++ src/sys/sys/systm.h	24 Feb 2003 21:32:49 -0000
d5326 1
a5326 1
+++ src/sys/sys/utsname.h	24 Feb 2003 21:32:49 -0000
d5328 1
a5328 1
+/*	$MirBSD: obsd.kernel,v 1.7 2003/02/24 21:32:06 tg Exp $	*/
d5357 1
a5357 1
+++ src/sys/ufs/ffs/ffs_softdep.c	24 Feb 2003 21:32:49 -0000
d5373 1
a5373 1
+++ src/sys/ufs/ffs/ffs_vfsops.c	24 Feb 2003 21:32:49 -0000
d5389 1
a5389 1
+++ src/sys/uvm/uvm_amap.c	24 Feb 2003 21:32:49 -0000
d5405 1
a5405 1
+++ src/sys/uvm/uvm_map.c	24 Feb 2003 21:32:50 -0000
d5443 1
a5443 1
+++ src/sys/uvm/uvm_meter.c	24 Feb 2003 21:32:50 -0000
d5479 1
a5479 1
+++ src/sys/uvm/uvm_pager.c	24 Feb 2003 21:32:50 -0000
d5495 1
a5495 1
+++ src/sys/uvm/uvm_swap.c	24 Feb 2003 21:32:50 -0000
a5595 1
src/sys/net/pf_table.c				: ;
@


1.7
log
@post-release development

Made make build release succeed and synched plists to the amount needed.
OTOH I don't know if a _kernel_ build with this will succeed...
@
text
@d26 1
a26 1
against CTM on Mon Feb 24 21:28:09 UTC 2003.
d29 1
a29 1
### CTM OpenBSD-cvs 3060
d36 1
a36 1
+++ src/sys/arch/i386/conf/DISKLESS	23 Feb 2003 22:04:18 -0000
d69 1
a69 1
+++ src/sys/arch/i386/conf/GENERIC	23 Feb 2003 22:04:18 -0000
d71 1
a71 1
+#	$MirBSD: obsd.kernel,v 1.6 2003/02/23 22:04:07 tg Exp $
d165 1
a165 1
+++ src/sys/arch/i386/conf/Makefile.i386	23 Feb 2003 22:04:18 -0000
d167 1
a167 1
+#	$MirBSD: obsd.kernel,v 1.6 2003/02/23 22:04:07 tg Exp $
d197 1
a197 1
+++ src/sys/arch/i386/conf/RAMDISK	23 Feb 2003 22:04:18 -0000
d227 1
a227 1
+++ src/sys/arch/i386/conf/RAMDISKB	23 Feb 2003 22:04:19 -0000
d251 1
a251 1
+++ src/sys/arch/i386/conf/RAMDISKC	23 Feb 2003 22:04:19 -0000
d275 1
a275 1
+++ src/sys/arch/i386/conf/RAMDISK_CD	23 Feb 2003 22:04:19 -0000
d299 1
a299 1
+++ src/sys/arch/i386/i386/bios.c	23 Feb 2003 22:04:19 -0000
d315 1
a315 1
+++ src/sys/arch/i386/i386/machdep.c	23 Feb 2003 22:04:19 -0000
d352 13
a364 2
+++ src/sys/arch/i386/include/asm.h	23 Feb 2003 22:04:19 -0000
@@@@ -45,10 +45,10 @@@@
d378 1
a378 1
@@@@ -62,12 +62,25 @@@@
d415 1
a415 1
+++ src/sys/arch/i386/include/bus.h	23 Feb 2003 22:04:19 -0000
d470 1
a470 1
+++ src/sys/arch/i386/include/cdefs.h	23 Feb 2003 22:04:19 -0000
d517 1
a517 1
+++ src/sys/arch/i386/include/db_machdep.h	23 Feb 2003 22:04:19 -0000
d533 1
a533 1
+++ src/sys/arch/i386/include/exec.h	23 Feb 2003 22:04:19 -0000
d542 1
a542 1
@@@@ -46,6 +47,7 @@@@
d547 2
d552 1
a552 1
@@@@ -58,9 +60,8 @@@@
a559 2
+
+#define NATIVE_EXEC_ELF
d568 1
a568 1
+++ src/sys/arch/i386/include/intr.h	23 Feb 2003 22:04:19 -0000
d585 1
a585 1
+++ src/sys/arch/i386/include/param.h	23 Feb 2003 22:04:19 -0000
d608 1
a608 1
+++ src/sys/arch/i386/isa/clock.c	23 Feb 2003 22:04:19 -0000
d624 1
a624 1
+++ src/sys/arch/i386/isa/pccom.c	23 Feb 2003 22:04:19 -0000
d649 1
a649 1
+++ src/sys/arch/i386/pci/pchb.c	23 Feb 2003 22:04:19 -0000
d665 1
a665 1
+++ src/sys/arch/i386/pci/pci_addr_fixup.c	23 Feb 2003 22:04:19 -0000
d698 1
a698 1
+++ src/sys/arch/i386/pci/pcibios.c	23 Feb 2003 22:04:19 -0000
d718 1
a718 1
+++ src/sys/arch/i386/stand/Makefile.inc	23 Feb 2003 22:04:19 -0000
d734 1
a734 1
+++ src/sys/arch/i386/stand/boot/conf.c	23 Feb 2003 22:04:19 -0000
d772 1
a772 1
+++ src/sys/arch/i386/stand/libsa/apmprobe.c	23 Feb 2003 22:04:19 -0000
d935 1
a935 1
+++ src/sys/arch/i386/stand/libsa/bioscons.c	23 Feb 2003 22:04:19 -0000
d951 1
a951 1
+++ src/sys/arch/i386/stand/libsa/biosdev.c	23 Feb 2003 22:04:19 -0000
d999 1
a999 1
+++ src/sys/arch/i386/stand/libsa/cmd_i386.c	23 Feb 2003 22:04:19 -0000
d1076 1
a1076 1
+++ src/sys/arch/i386/stand/libsa/diskprobe.c	23 Feb 2003 22:04:19 -0000
d1127 1
a1127 1
+++ src/sys/arch/i386/stand/libsa/gidt.S	23 Feb 2003 22:04:19 -0000
d1154 1
a1154 1
+++ src/sys/arch/i386/stand/libsa/libsa.h	23 Feb 2003 22:04:19 -0000
d1174 1
a1174 1
+++ src/sys/arch/i386/stand/libsa/smpprobe.c	23 Feb 2003 22:04:19 -0000
d1201 1
a1201 1
+++ src/sys/conf/GENERIC	23 Feb 2003 22:04:19 -0000
d1203 1
a1203 1
+#	$MirBSD: obsd.kernel,v 1.6 2003/02/23 22:04:07 tg Exp $
d1256 1
a1256 1
+++ src/sys/conf/newvers.sh	23 Feb 2003 22:04:19 -0000
d1260 1
a1260 1
+#	$MirBSD: obsd.kernel,v 1.6 2003/02/23 22:04:07 tg Exp $
d1316 1
a1316 1
+ospl="$(echo '\$Date: 2003/02/23 22:04:07 $' | sed -e 's,^.*: ,,' -e 's,/,,g' -e 's, .*$,,')"
d1329 1
a1329 1
+    "    @@(#)MirBSD from ${ost} ${osr}-beta (${id}) #${v}: ${t}\n	@@(#)\$MirBSD: obsd.kernel,v 1.6 2003/02/23 22:04:07 tg Exp $\n";
d1333 1
a1333 1
+    "MirBSD ${osr}-${ospl} (${id}) #${v}: ${t}\n    ${u}@@${h}:${d}\n    patchlevel:\$MirBSD: obsd.kernel,v 1.6 2003/02/23 22:04:07 tg Exp $\n";
d1343 1
a1343 1
+++ src/sys/dev/ccd.c	23 Feb 2003 22:04:19 -0000
d1359 1
a1359 1
+++ src/sys/dev/systrace.c	23 Feb 2003 22:04:19 -0000
d1372 5
a1376 5
retrieving revision 1.54
diff -u -r1.54 dc.c
--- src/sys/dev/ic/dc.c	31 Jan 2003 14:22:16 -0000	1.54
+++ src/sys/dev/ic/dc.c	23 Feb 2003 22:04:19 -0000
@@@@ -640,6 +640,7 @@@@
d1384 1
a1384 1
@@@@ -732,7 +733,6 @@@@
d1392 1
a1392 1
@@@@ -763,6 +763,7 @@@@
d1400 1
a1400 1
@@@@ -1617,7 +1618,7 @@@@
d1415 1
a1415 1
+++ src/sys/dev/ic/if_wi.c	23 Feb 2003 22:04:19 -0000
d1431 1
a1431 1
+++ src/sys/dev/ic/if_wi_hostap.c	23 Feb 2003 22:04:19 -0000
d1468 1
a1468 1
+++ src/sys/dev/ic/ne2000.c	23 Feb 2003 22:04:19 -0000
d1484 1
a1484 1
+++ src/sys/dev/ic/rtl80x9.c	23 Feb 2003 22:04:19 -0000
d1500 1
a1500 1
+++ src/sys/dev/ic/rtl81x9.c	23 Feb 2003 22:04:19 -0000
d1519 1
a1519 1
+++ src/sys/dev/isa/spkr.c	23 Feb 2003 22:04:19 -0000
d1521 1
a1521 1
+/*	$MirBSD: obsd.kernel,v 1.6 2003/02/23 22:04:07 tg Exp $	*/
d1978 1
a1978 1
+++ src/sys/dev/microcode/aic7xxx/Makefile	23 Feb 2003 22:04:19 -0000
d1994 1
a1994 1
+++ src/sys/dev/mii/bmtphy.c	23 Feb 2003 22:04:20 -0000
d2021 1
a2021 1
+++ src/sys/dev/pci/if_bge.c	23 Feb 2003 22:04:23 -0000
d2065 1
a2065 1
+++ src/sys/dev/pci/if_sf.c	23 Feb 2003 22:04:23 -0000
d2081 1
a2081 1
+++ src/sys/dev/pci/if_ste.c	23 Feb 2003 22:04:23 -0000
d2094 4
a2097 4
retrieving revision 1.114
diff -u -r1.114 pciide.c
--- src/sys/dev/pci/pciide.c	21 Feb 2003 20:10:11 -0000	1.114
+++ src/sys/dev/pci/pciide.c	23 Feb 2003 22:04:23 -0000
d2119 4
a2122 4
retrieving revision 1.49
diff -u -r1.49 wsdisplay.c
--- src/sys/dev/wscons/wsdisplay.c	12 Oct 2002 01:09:22 -0000	1.49
+++ src/sys/dev/wscons/wsdisplay.c	23 Feb 2003 22:04:23 -0000
d2138 1
a2138 1
+++ src/sys/kern/kern_exec.c	23 Feb 2003 22:04:23 -0000
d2140 1
a2140 1
+/*	$MirBSD: obsd.kernel,v 1.6 2003/02/23 22:04:07 tg Exp $	*/
d2160 1
a2160 1
+++ src/sys/kern/kern_fork.c	23 Feb 2003 22:04:23 -0000
d2162 1
a2162 1
+/*	$MirBSD: obsd.kernel,v 1.6 2003/02/23 22:04:07 tg Exp $	*/
d2228 1
a2228 1
+++ src/sys/kern/kern_sig.c	23 Feb 2003 22:04:23 -0000
d2324 1
a2324 1
+++ src/sys/kern/kern_synch.c	23 Feb 2003 22:04:23 -0000
d2352 1
a2352 1
+++ src/sys/kern/kern_sysctl.c	23 Feb 2003 22:04:23 -0000
d2466 1
a2466 1
+++ src/sys/kern/subr_userconf.c	23 Feb 2003 22:04:23 -0000
d2491 1
a2491 1
+++ src/sys/kern/sys_generic.c	23 Feb 2003 22:04:23 -0000
d2516 1
a2516 1
+++ src/sys/kern/vfs_syscalls.c	23 Feb 2003 22:04:23 -0000
d2532 1
a2532 1
+++ src/sys/lib/libkern/arch/i386/Makefile.inc	23 Feb 2003 22:04:23 -0000
d2534 1
a2534 1
+#	$MirBSD: obsd.kernel,v 1.6 2003/02/23 22:04:07 tg Exp $
d2551 1
a2551 1
+++ src/sys/lib/libkern/arch/i386/htonl.S	23 Feb 2003 22:04:23 -0000
d2622 1
a2622 1
+++ src/sys/lib/libkern/arch/i386/htons.S	23 Feb 2003 22:04:23 -0000
d2690 1
a2690 1
+++ src/sys/lib/libz/Makefile	23 Feb 2003 22:04:23 -0000
d2706 1
a2706 1
+++ src/sys/miscfs/procfs/procfs_vnops.c	23 Feb 2003 22:04:23 -0000
d2722 1
a2722 1
+++ src/sys/miscfs/union/union_vnops.c	23 Feb 2003 22:04:23 -0000
d2738 1
a2738 1
+++ src/sys/net/if_bridge.c	23 Feb 2003 22:04:24 -0000
d2754 1
a2754 1
+++ src/sys/net/if_vlan.c	23 Feb 2003 22:04:24 -0000
d2767 4
a2770 4
retrieving revision 1.321
diff -u -r1.321 pf.c
--- src/sys/net/pf.c	16 Feb 2003 21:29:51 -0000	1.321
+++ src/sys/net/pf.c	23 Feb 2003 22:04:24 -0000
d2804 1
a2804 1
@@@@ -2393,6 +2396,8 @@@@
d2813 1
a2813 1
@@@@ -3237,6 +3242,8 @@@@
d2822 1
a2822 1
@@@@ -3405,6 +3412,8 @@@@
d2831 1
a2831 1
@@@@ -4414,8 +4423,9 @@@@
d2846 4
a2849 4
retrieving revision 1.25
diff -u -r1.25 pf_table.c
--- src/sys/net/pf_table.c	12 Feb 2003 20:09:46 -0000	1.25
+++ src/sys/net/pf_table.c	23 Feb 2003 22:04:24 -0000
d2866 1
a2866 1
+++ src/sys/net/pfkeyv2.c	23 Feb 2003 22:04:24 -0000
d2882 1
a2882 1
+++ src/sys/netinet/ip_ah.c	23 Feb 2003 22:04:24 -0000
d2907 1
a2907 1
+++ src/sys/netinet/ip_esp.c	23 Feb 2003 22:04:24 -0000
d2932 1
a2932 1
+++ src/sys/netinet/ip_ipcomp.c	23 Feb 2003 22:04:24 -0000
d2957 1
a2957 1
+++ src/sys/netinet/ip_ipsp.c	23 Feb 2003 22:04:24 -0000
d2973 1
a2973 1
+++ src/sys/netinet/ip_output.c	23 Feb 2003 22:04:24 -0000
d3010 1
a3010 1
+++ src/sys/netinet/ipsec_output.c	23 Feb 2003 22:04:24 -0000
d3050 1
a3050 1
+++ src/sys/netinet/tcp_input.c	23 Feb 2003 22:04:24 -0000
d3066 1
a3066 1
+++ src/sys/netinet/tcp_output.c	23 Feb 2003 22:04:24 -0000
d3093 1
a3093 1
+++ src/sys/netinet/tcp_subr.c	23 Feb 2003 22:04:24 -0000
d3153 1
a3153 1
+++ src/sys/netinet/tcp_usrreq.c	23 Feb 2003 22:04:24 -0000
d3174 1
a3174 1
+++ src/sys/netinet/udp_usrreq.c	23 Feb 2003 22:04:24 -0000
d3189 1
a3189 1
+++ src/sys/netinet6/in6_ifattach.c	23 Feb 2003 22:04:24 -0000
d3220 1
a3220 1
+++ src/sys/netinet6/ip6_forward.c	23 Feb 2003 22:04:24 -0000
d3236 1
a3236 1
+++ src/sys/netinet6/ip6_output.c	23 Feb 2003 22:04:24 -0000
d3252 1
a3252 1
+++ src/sys/netinet6/raw_ip6.c	23 Feb 2003 22:04:24 -0000
d3269 1
a3269 1
+++ src/sys/nfs/nfsproto.h	23 Feb 2003 22:04:24 -0000
d3487 1
a3487 1
+++ src/sys/stand/boot/cmd.c	23 Feb 2003 22:04:24 -0000
d3537 1
a3537 1
+++ src/sys/sys/proc.h	23 Feb 2003 22:04:24 -0000
d3539 1
a3539 1
+/*	$MirBSD: obsd.kernel,v 1.6 2003/02/23 22:04:07 tg Exp $	*/
d3568 1
a3568 1
+++ src/sys/sys/resource.h	23 Feb 2003 22:04:24 -0000
d3586 1
a3586 1
+++ src/sys/sys/sysctl.h	23 Feb 2003 22:04:24 -0000
d3588 1
a3588 1
+/*	$MirBSD: obsd.kernel,v 1.6 2003/02/23 22:04:07 tg Exp $	*/
d3647 1
a3647 1
+++ src/sys/sys/systm.h	23 Feb 2003 22:04:24 -0000
d3662 1
a3662 1
+++ src/sys/sys/utsname.h	23 Feb 2003 22:04:24 -0000
d3664 1
a3664 1
+/*	$MirBSD: obsd.kernel,v 1.6 2003/02/23 22:04:07 tg Exp $	*/
d3693 1
a3693 1
+++ src/sys/ufs/ffs/ffs_softdep.c	23 Feb 2003 22:04:27 -0000
d3709 1
a3709 1
+++ src/sys/ufs/ffs/ffs_vfsops.c	23 Feb 2003 22:04:27 -0000
d3725 1
a3725 1
+++ src/sys/uvm/uvm_amap.c	23 Feb 2003 22:04:27 -0000
d3741 1
a3741 1
+++ src/sys/uvm/uvm_map.c	23 Feb 2003 22:04:27 -0000
d3779 1
a3779 1
+++ src/sys/uvm/uvm_meter.c	23 Feb 2003 22:04:28 -0000
d3815 1
a3815 1
+++ src/sys/uvm/uvm_pager.c	23 Feb 2003 22:04:28 -0000
d3831 1
a3831 1
+++ src/sys/uvm/uvm_swap.c	23 Feb 2003 22:04:28 -0000
d3967 1
a3967 1
a.out kernel to boot the ELF system
@


1.6
log
@pre-build development
do not use... cpp stuff is still untested (needs manual symlinking),
and userland as well
@
text
@d26 1
a26 1
against CTM on Sun Feb 23 22:02:31 UTC 2003.
d36 1
a36 1
+++ src/sys/arch/i386/conf/DISKLESS	23 Feb 2003 20:05:24 -0000
d69 1
a69 1
+++ src/sys/arch/i386/conf/GENERIC	23 Feb 2003 20:05:24 -0000
d71 1
a71 1
+#	$MirBSD: obsd.kernel,v 1.5 2003/02/23 20:05:15 tg Exp $
d165 1
a165 1
+++ src/sys/arch/i386/conf/Makefile.i386	23 Feb 2003 20:05:24 -0000
d167 1
a167 1
+#	$MirBSD: obsd.kernel,v 1.5 2003/02/23 20:05:15 tg Exp $
d197 1
a197 1
+++ src/sys/arch/i386/conf/RAMDISK	23 Feb 2003 20:05:24 -0000
d227 1
a227 1
+++ src/sys/arch/i386/conf/RAMDISKB	23 Feb 2003 20:05:24 -0000
d251 1
a251 1
+++ src/sys/arch/i386/conf/RAMDISKC	23 Feb 2003 20:05:24 -0000
d275 1
a275 1
+++ src/sys/arch/i386/conf/RAMDISK_CD	23 Feb 2003 20:05:24 -0000
d299 1
a299 1
+++ src/sys/arch/i386/i386/bios.c	23 Feb 2003 20:05:24 -0000
d315 1
a315 1
+++ src/sys/arch/i386/i386/machdep.c	23 Feb 2003 20:05:24 -0000
d352 1
a352 1
+++ src/sys/arch/i386/include/asm.h	23 Feb 2003 20:05:24 -0000
d404 1
a404 1
+++ src/sys/arch/i386/include/bus.h	23 Feb 2003 20:05:24 -0000
d459 1
a459 1
+++ src/sys/arch/i386/include/cdefs.h	23 Feb 2003 20:05:24 -0000
d506 1
a506 1
+++ src/sys/arch/i386/include/db_machdep.h	23 Feb 2003 20:05:24 -0000
d522 1
a522 1
+++ src/sys/arch/i386/include/exec.h	23 Feb 2003 20:05:24 -0000
d557 1
a557 1
+++ src/sys/arch/i386/include/intr.h	23 Feb 2003 20:05:24 -0000
d574 1
a574 1
+++ src/sys/arch/i386/include/param.h	23 Feb 2003 20:05:24 -0000
d597 1
a597 1
+++ src/sys/arch/i386/isa/clock.c	23 Feb 2003 20:05:24 -0000
d613 1
a613 1
+++ src/sys/arch/i386/isa/pccom.c	23 Feb 2003 20:05:24 -0000
d638 1
a638 1
+++ src/sys/arch/i386/pci/pchb.c	23 Feb 2003 20:05:24 -0000
d654 1
a654 1
+++ src/sys/arch/i386/pci/pci_addr_fixup.c	23 Feb 2003 20:05:24 -0000
d687 1
a687 1
+++ src/sys/arch/i386/pci/pcibios.c	23 Feb 2003 20:05:24 -0000
d707 1
a707 1
+++ src/sys/arch/i386/stand/Makefile.inc	23 Feb 2003 20:05:24 -0000
d723 1
a723 1
+++ src/sys/arch/i386/stand/boot/conf.c	23 Feb 2003 20:05:24 -0000
d761 1
a761 1
+++ src/sys/arch/i386/stand/libsa/apmprobe.c	23 Feb 2003 20:05:24 -0000
d924 1
a924 1
+++ src/sys/arch/i386/stand/libsa/bioscons.c	23 Feb 2003 20:05:24 -0000
d940 1
a940 1
+++ src/sys/arch/i386/stand/libsa/biosdev.c	23 Feb 2003 20:05:24 -0000
d988 1
a988 1
+++ src/sys/arch/i386/stand/libsa/cmd_i386.c	23 Feb 2003 20:05:24 -0000
d1065 1
a1065 1
+++ src/sys/arch/i386/stand/libsa/diskprobe.c	23 Feb 2003 20:05:24 -0000
d1116 1
a1116 1
+++ src/sys/arch/i386/stand/libsa/gidt.S	23 Feb 2003 20:05:24 -0000
d1143 1
a1143 1
+++ src/sys/arch/i386/stand/libsa/libsa.h	23 Feb 2003 20:05:24 -0000
d1163 1
a1163 1
+++ src/sys/arch/i386/stand/libsa/smpprobe.c	23 Feb 2003 20:05:24 -0000
d1190 1
a1190 1
+++ src/sys/conf/GENERIC	23 Feb 2003 20:05:24 -0000
d1192 1
a1192 1
+#	$MirBSD: obsd.kernel,v 1.5 2003/02/23 20:05:15 tg Exp $
d1245 1
a1245 1
+++ src/sys/conf/newvers.sh	23 Feb 2003 20:05:24 -0000
d1249 1
a1249 1
+#	$MirBSD: obsd.kernel,v 1.5 2003/02/23 20:05:15 tg Exp $
d1305 1
a1305 1
+ospl="$(echo '\$Date: 2003/02/23 20:05:15 $' | sed -e 's,^.*: ,,' -e 's,/,,g' -e 's, .*$,,')"
d1318 1
a1318 1
+    "    @@(#)MirBSD from ${ost} ${osr}-beta (${id}) #${v}: ${t}\n	@@(#)\$MirBSD: obsd.kernel,v 1.5 2003/02/23 20:05:15 tg Exp $\n";
d1322 1
a1322 1
+    "MirBSD ${osr}-${ospl} (${id}) #${v}: ${t}\n    ${u}@@${h}:${d}\n    patchlevel:\$MirBSD: obsd.kernel,v 1.5 2003/02/23 20:05:15 tg Exp $\n";
d1332 1
a1332 1
+++ src/sys/dev/ccd.c	23 Feb 2003 20:05:24 -0000
d1348 1
a1348 1
+++ src/sys/dev/systrace.c	23 Feb 2003 20:05:24 -0000
d1364 1
a1364 1
+++ src/sys/dev/ic/dc.c	23 Feb 2003 20:05:24 -0000
d1404 1
a1404 1
+++ src/sys/dev/ic/if_wi.c	23 Feb 2003 20:05:24 -0000
d1420 1
a1420 1
+++ src/sys/dev/ic/if_wi_hostap.c	23 Feb 2003 20:05:24 -0000
d1457 1
a1457 1
+++ src/sys/dev/ic/ne2000.c	23 Feb 2003 20:05:24 -0000
d1473 1
a1473 1
+++ src/sys/dev/ic/rtl80x9.c	23 Feb 2003 20:05:24 -0000
d1489 1
a1489 1
+++ src/sys/dev/ic/rtl81x9.c	23 Feb 2003 20:05:24 -0000
d1508 1
a1508 1
+++ src/sys/dev/isa/spkr.c	23 Feb 2003 20:05:26 -0000
d1510 1
a1510 1
+/*	$MirBSD: obsd.kernel,v 1.5 2003/02/23 20:05:15 tg Exp $	*/
d1967 1
a1967 1
+++ src/sys/dev/microcode/aic7xxx/Makefile	23 Feb 2003 20:05:26 -0000
d1983 1
a1983 1
+++ src/sys/dev/mii/bmtphy.c	23 Feb 2003 20:05:27 -0000
d2010 1
a2010 1
+++ src/sys/dev/pci/if_bge.c	23 Feb 2003 20:05:28 -0000
d2054 1
a2054 1
+++ src/sys/dev/pci/if_sf.c	23 Feb 2003 20:05:28 -0000
d2070 1
a2070 1
+++ src/sys/dev/pci/if_ste.c	23 Feb 2003 20:05:28 -0000
d2086 1
a2086 1
+++ src/sys/dev/pci/pciide.c	23 Feb 2003 20:05:28 -0000
d2111 1
a2111 1
+++ src/sys/dev/wscons/wsdisplay.c	23 Feb 2003 20:05:28 -0000
d2127 1
a2127 1
+++ src/sys/kern/kern_exec.c	23 Feb 2003 20:05:28 -0000
d2129 1
a2129 1
+/*	$MirBSD: obsd.kernel,v 1.5 2003/02/23 20:05:15 tg Exp $	*/
d2149 1
a2149 1
+++ src/sys/kern/kern_fork.c	23 Feb 2003 20:05:28 -0000
d2151 1
a2151 1
+/*	$MirBSD: obsd.kernel,v 1.5 2003/02/23 20:05:15 tg Exp $	*/
d2217 1
a2217 1
+++ src/sys/kern/kern_sig.c	23 Feb 2003 20:05:28 -0000
d2313 1
a2313 1
+++ src/sys/kern/kern_synch.c	23 Feb 2003 20:05:28 -0000
d2341 1
a2341 1
+++ src/sys/kern/kern_sysctl.c	23 Feb 2003 20:05:28 -0000
d2455 1
a2455 1
+++ src/sys/kern/subr_userconf.c	23 Feb 2003 20:05:28 -0000
d2480 1
a2480 1
+++ src/sys/kern/sys_generic.c	23 Feb 2003 20:05:28 -0000
d2505 1
a2505 1
+++ src/sys/kern/vfs_syscalls.c	23 Feb 2003 20:05:28 -0000
d2521 1
a2521 1
+++ src/sys/lib/libkern/arch/i386/Makefile.inc	23 Feb 2003 20:05:28 -0000
d2523 1
a2523 1
+#	$MirBSD: obsd.kernel,v 1.5 2003/02/23 20:05:15 tg Exp $
d2540 1
a2540 1
+++ src/sys/lib/libkern/arch/i386/htonl.S	23 Feb 2003 20:05:28 -0000
d2611 1
a2611 1
+++ src/sys/lib/libkern/arch/i386/htons.S	23 Feb 2003 20:05:28 -0000
d2679 1
a2679 1
+++ src/sys/lib/libz/Makefile	23 Feb 2003 20:05:28 -0000
d2695 1
a2695 1
+++ src/sys/miscfs/procfs/procfs_vnops.c	23 Feb 2003 20:05:28 -0000
d2711 1
a2711 1
+++ src/sys/miscfs/union/union_vnops.c	23 Feb 2003 20:05:28 -0000
d2727 1
a2727 1
+++ src/sys/net/if_bridge.c	23 Feb 2003 20:05:28 -0000
d2743 1
a2743 1
+++ src/sys/net/if_vlan.c	23 Feb 2003 20:05:28 -0000
d2759 1
a2759 1
+++ src/sys/net/pf.c	23 Feb 2003 20:05:28 -0000
d2838 1
a2838 1
+++ src/sys/net/pf_table.c	23 Feb 2003 20:05:28 -0000
d2855 1
a2855 1
+++ src/sys/net/pfkeyv2.c	23 Feb 2003 20:05:28 -0000
d2871 1
a2871 1
+++ src/sys/netinet/ip_ah.c	23 Feb 2003 20:05:28 -0000
d2896 1
a2896 1
+++ src/sys/netinet/ip_esp.c	23 Feb 2003 20:05:28 -0000
d2921 1
a2921 1
+++ src/sys/netinet/ip_ipcomp.c	23 Feb 2003 20:05:28 -0000
d2946 1
a2946 1
+++ src/sys/netinet/ip_ipsp.c	23 Feb 2003 20:05:28 -0000
d2962 1
a2962 1
+++ src/sys/netinet/ip_output.c	23 Feb 2003 20:05:28 -0000
d2999 1
a2999 1
+++ src/sys/netinet/ipsec_output.c	23 Feb 2003 20:05:28 -0000
d3039 1
a3039 1
+++ src/sys/netinet/tcp_input.c	23 Feb 2003 20:05:28 -0000
d3055 1
a3055 1
+++ src/sys/netinet/tcp_output.c	23 Feb 2003 20:05:28 -0000
d3082 1
a3082 1
+++ src/sys/netinet/tcp_subr.c	23 Feb 2003 20:05:28 -0000
d3142 1
a3142 1
+++ src/sys/netinet/tcp_usrreq.c	23 Feb 2003 20:05:28 -0000
d3163 1
a3163 1
+++ src/sys/netinet/udp_usrreq.c	23 Feb 2003 20:05:28 -0000
d3178 1
a3178 1
+++ src/sys/netinet6/in6_ifattach.c	23 Feb 2003 20:05:28 -0000
d3209 1
a3209 1
+++ src/sys/netinet6/ip6_forward.c	23 Feb 2003 20:05:28 -0000
d3225 1
a3225 1
+++ src/sys/netinet6/ip6_output.c	23 Feb 2003 20:05:28 -0000
d3241 1
a3241 1
+++ src/sys/netinet6/raw_ip6.c	23 Feb 2003 20:05:28 -0000
d3258 1
a3258 1
+++ src/sys/nfs/nfsproto.h	23 Feb 2003 20:05:28 -0000
d3476 1
a3476 1
+++ src/sys/stand/boot/cmd.c	23 Feb 2003 20:05:28 -0000
d3526 1
a3526 1
+++ src/sys/sys/proc.h	23 Feb 2003 20:05:28 -0000
d3528 1
a3528 1
+/*	$MirBSD: obsd.kernel,v 1.5 2003/02/23 20:05:15 tg Exp $	*/
d3557 1
a3557 1
+++ src/sys/sys/resource.h	23 Feb 2003 20:05:28 -0000
d3575 1
a3575 1
+++ src/sys/sys/sysctl.h	23 Feb 2003 20:05:28 -0000
d3577 1
a3577 1
+/*	$MirBSD: obsd.kernel,v 1.5 2003/02/23 20:05:15 tg Exp $	*/
d3636 1
a3636 1
+++ src/sys/sys/systm.h	23 Feb 2003 20:05:28 -0000
d3651 1
a3651 1
+++ src/sys/sys/utsname.h	23 Feb 2003 20:05:28 -0000
d3653 1
a3653 1
+/*	$MirBSD: obsd.kernel,v 1.5 2003/02/23 20:05:15 tg Exp $	*/
d3682 1
a3682 1
+++ src/sys/ufs/ffs/ffs_softdep.c	23 Feb 2003 20:05:29 -0000
d3698 1
a3698 1
+++ src/sys/ufs/ffs/ffs_vfsops.c	23 Feb 2003 20:05:29 -0000
d3714 1
a3714 1
+++ src/sys/uvm/uvm_amap.c	23 Feb 2003 20:05:29 -0000
d3730 1
a3730 1
+++ src/sys/uvm/uvm_map.c	23 Feb 2003 20:05:29 -0000
d3768 1
a3768 1
+++ src/sys/uvm/uvm_meter.c	23 Feb 2003 20:05:29 -0000
d3804 1
a3804 1
+++ src/sys/uvm/uvm_pager.c	23 Feb 2003 20:05:29 -0000
d3820 1
a3820 1
+++ src/sys/uvm/uvm_swap.c	23 Feb 2003 20:05:29 -0000
@


1.5
log
@intermediate broken

fix some includes for ELF in sys/
fix libs
@
text
@d26 1
a26 1
against CTM on Sun Feb 23 20:04:05 UTC 2003.
d36 1
a36 1
+++ src/sys/arch/i386/conf/DISKLESS	23 Feb 2003 18:22:12 -0000
d69 1
a69 1
+++ src/sys/arch/i386/conf/GENERIC	23 Feb 2003 18:22:12 -0000
d71 1
a71 1
+#	$MirBSD: obsd.kernel,v 1.4 2003/02/23 17:59:43 tg Exp $
d165 1
a165 1
+++ src/sys/arch/i386/conf/Makefile.i386	23 Feb 2003 18:22:12 -0000
d167 1
a167 1
+#	$MirBSD: obsd.kernel,v 1.4 2003/02/23 17:59:43 tg Exp $
d197 1
a197 1
+++ src/sys/arch/i386/conf/RAMDISK	23 Feb 2003 18:22:12 -0000
d227 1
a227 1
+++ src/sys/arch/i386/conf/RAMDISKB	23 Feb 2003 18:22:12 -0000
d251 1
a251 1
+++ src/sys/arch/i386/conf/RAMDISKC	23 Feb 2003 18:22:12 -0000
d275 1
a275 1
+++ src/sys/arch/i386/conf/RAMDISK_CD	23 Feb 2003 18:22:12 -0000
d299 1
a299 1
+++ src/sys/arch/i386/i386/bios.c	23 Feb 2003 18:22:12 -0000
d315 1
a315 1
+++ src/sys/arch/i386/i386/machdep.c	23 Feb 2003 18:22:12 -0000
d352 1
a352 1
+++ src/sys/arch/i386/include/asm.h	23 Feb 2003 19:26:14 -0000
d404 1
a404 1
+++ src/sys/arch/i386/include/bus.h	23 Feb 2003 19:26:14 -0000
d459 1
a459 1
+++ src/sys/arch/i386/include/cdefs.h	23 Feb 2003 19:26:14 -0000
d506 1
a506 1
+++ src/sys/arch/i386/include/db_machdep.h	23 Feb 2003 19:26:14 -0000
d522 1
a522 1
+++ src/sys/arch/i386/include/exec.h	23 Feb 2003 18:22:14 -0000
d557 1
a557 1
+++ src/sys/arch/i386/include/intr.h	23 Feb 2003 19:26:14 -0000
d574 1
a574 1
+++ src/sys/arch/i386/include/param.h	23 Feb 2003 19:26:14 -0000
d597 1
a597 1
+++ src/sys/arch/i386/isa/clock.c	23 Feb 2003 18:22:15 -0000
d613 1
a613 1
+++ src/sys/arch/i386/isa/pccom.c	23 Feb 2003 18:22:15 -0000
d638 1
a638 1
+++ src/sys/arch/i386/pci/pchb.c	23 Feb 2003 18:22:15 -0000
d654 1
a654 1
+++ src/sys/arch/i386/pci/pci_addr_fixup.c	23 Feb 2003 18:22:15 -0000
d687 1
a687 1
+++ src/sys/arch/i386/pci/pcibios.c	23 Feb 2003 18:22:15 -0000
d707 1
a707 1
+++ src/sys/arch/i386/stand/Makefile.inc	23 Feb 2003 18:22:15 -0000
d723 1
a723 1
+++ src/sys/arch/i386/stand/boot/conf.c	23 Feb 2003 18:22:15 -0000
d761 1
a761 1
+++ src/sys/arch/i386/stand/libsa/apmprobe.c	23 Feb 2003 18:22:15 -0000
d924 1
a924 1
+++ src/sys/arch/i386/stand/libsa/bioscons.c	23 Feb 2003 18:22:15 -0000
d940 1
a940 1
+++ src/sys/arch/i386/stand/libsa/biosdev.c	23 Feb 2003 18:22:15 -0000
d988 1
a988 1
+++ src/sys/arch/i386/stand/libsa/cmd_i386.c	23 Feb 2003 18:22:15 -0000
d1065 1
a1065 1
+++ src/sys/arch/i386/stand/libsa/diskprobe.c	23 Feb 2003 18:22:15 -0000
d1116 1
a1116 1
+++ src/sys/arch/i386/stand/libsa/gidt.S	23 Feb 2003 18:22:15 -0000
d1143 1
a1143 1
+++ src/sys/arch/i386/stand/libsa/libsa.h	23 Feb 2003 18:22:15 -0000
d1163 1
a1163 1
+++ src/sys/arch/i386/stand/libsa/smpprobe.c	23 Feb 2003 18:22:15 -0000
d1190 1
a1190 1
+++ src/sys/conf/GENERIC	23 Feb 2003 18:22:15 -0000
d1192 1
a1192 1
+#	$MirBSD: obsd.kernel,v 1.4 2003/02/23 17:59:43 tg Exp $
d1245 1
a1245 1
+++ src/sys/conf/newvers.sh	23 Feb 2003 18:22:15 -0000
d1249 1
a1249 1
+#	$MirBSD: obsd.kernel,v 1.4 2003/02/23 17:59:43 tg Exp $
d1305 1
a1305 1
+ospl="$(echo '\$Date: 2003/02/23 17:59:43 $' | sed -e 's,^.*: ,,' -e 's,/,,g' -e 's, .*$,,')"
d1318 1
a1318 1
+    "    @@(#)MirBSD from ${ost} ${osr}-beta (${id}) #${v}: ${t}\n	@@(#)\$MirBSD: obsd.kernel,v 1.4 2003/02/23 17:59:43 tg Exp $\n";
d1322 1
a1322 1
+    "MirBSD ${osr}-${ospl} (${id}) #${v}: ${t}\n    ${u}@@${h}:${d}\n    patchlevel:\$MirBSD: obsd.kernel,v 1.4 2003/02/23 17:59:43 tg Exp $\n";
d1332 1
a1332 1
+++ src/sys/dev/ccd.c	23 Feb 2003 18:22:15 -0000
d1348 1
a1348 1
+++ src/sys/dev/systrace.c	23 Feb 2003 18:22:15 -0000
d1364 1
a1364 1
+++ src/sys/dev/ic/dc.c	23 Feb 2003 18:22:15 -0000
d1404 1
a1404 1
+++ src/sys/dev/ic/if_wi.c	23 Feb 2003 18:22:15 -0000
d1420 1
a1420 1
+++ src/sys/dev/ic/if_wi_hostap.c	23 Feb 2003 18:22:15 -0000
d1457 1
a1457 1
+++ src/sys/dev/ic/ne2000.c	23 Feb 2003 18:22:15 -0000
d1473 1
a1473 1
+++ src/sys/dev/ic/rtl80x9.c	23 Feb 2003 18:22:15 -0000
d1489 1
a1489 1
+++ src/sys/dev/ic/rtl81x9.c	23 Feb 2003 18:22:15 -0000
d1508 1
a1508 1
+++ src/sys/dev/isa/spkr.c	23 Feb 2003 18:22:15 -0000
d1510 1
a1510 1
+/*	$MirBSD: obsd.kernel,v 1.4 2003/02/23 17:59:43 tg Exp $	*/
d1967 1
a1967 1
+++ src/sys/dev/microcode/aic7xxx/Makefile	23 Feb 2003 18:22:15 -0000
d1983 1
a1983 1
+++ src/sys/dev/mii/bmtphy.c	23 Feb 2003 18:22:16 -0000
d2010 1
a2010 1
+++ src/sys/dev/pci/if_bge.c	23 Feb 2003 18:22:16 -0000
d2054 1
a2054 1
+++ src/sys/dev/pci/if_sf.c	23 Feb 2003 18:22:16 -0000
d2070 1
a2070 1
+++ src/sys/dev/pci/if_ste.c	23 Feb 2003 18:22:16 -0000
d2086 1
a2086 1
+++ src/sys/dev/pci/pciide.c	23 Feb 2003 18:22:17 -0000
d2111 1
a2111 1
+++ src/sys/dev/wscons/wsdisplay.c	23 Feb 2003 18:22:17 -0000
d2127 1
a2127 1
+++ src/sys/kern/kern_exec.c	23 Feb 2003 18:22:17 -0000
d2129 1
a2129 1
+/*	$MirBSD: obsd.kernel,v 1.4 2003/02/23 17:59:43 tg Exp $	*/
d2149 1
a2149 1
+++ src/sys/kern/kern_fork.c	23 Feb 2003 18:22:17 -0000
d2151 1
a2151 1
+/*	$MirBSD: obsd.kernel,v 1.4 2003/02/23 17:59:43 tg Exp $	*/
d2217 1
a2217 1
+++ src/sys/kern/kern_sig.c	23 Feb 2003 18:22:17 -0000
d2313 1
a2313 1
+++ src/sys/kern/kern_synch.c	23 Feb 2003 18:22:17 -0000
d2341 1
a2341 1
+++ src/sys/kern/kern_sysctl.c	23 Feb 2003 18:22:17 -0000
d2455 1
a2455 1
+++ src/sys/kern/subr_userconf.c	23 Feb 2003 18:22:17 -0000
d2480 1
a2480 1
+++ src/sys/kern/sys_generic.c	23 Feb 2003 18:22:17 -0000
d2505 1
a2505 1
+++ src/sys/kern/vfs_syscalls.c	23 Feb 2003 18:22:17 -0000
d2521 1
a2521 1
+++ src/sys/lib/libkern/arch/i386/Makefile.inc	23 Feb 2003 18:22:17 -0000
d2523 1
a2523 1
+#	$MirBSD: obsd.kernel,v 1.4 2003/02/23 17:59:43 tg Exp $
d2540 1
a2540 1
+++ src/sys/lib/libkern/arch/i386/htonl.S	23 Feb 2003 18:22:17 -0000
d2611 1
a2611 1
+++ src/sys/lib/libkern/arch/i386/htons.S	23 Feb 2003 18:22:17 -0000
d2679 1
a2679 1
+++ src/sys/lib/libz/Makefile	23 Feb 2003 18:22:17 -0000
d2695 1
a2695 1
+++ src/sys/miscfs/procfs/procfs_vnops.c	23 Feb 2003 18:22:17 -0000
d2711 1
a2711 1
+++ src/sys/miscfs/union/union_vnops.c	23 Feb 2003 18:22:17 -0000
d2727 1
a2727 1
+++ src/sys/net/if_bridge.c	23 Feb 2003 18:22:18 -0000
d2743 1
a2743 1
+++ src/sys/net/if_vlan.c	23 Feb 2003 18:22:18 -0000
d2759 1
a2759 1
+++ src/sys/net/pf.c	23 Feb 2003 18:22:18 -0000
d2838 1
a2838 1
+++ src/sys/net/pf_table.c	23 Feb 2003 18:22:18 -0000
d2855 1
a2855 1
+++ src/sys/net/pfkeyv2.c	23 Feb 2003 18:22:18 -0000
d2871 1
a2871 1
+++ src/sys/netinet/ip_ah.c	23 Feb 2003 18:22:18 -0000
d2896 1
a2896 1
+++ src/sys/netinet/ip_esp.c	23 Feb 2003 18:22:18 -0000
d2921 1
a2921 1
+++ src/sys/netinet/ip_ipcomp.c	23 Feb 2003 18:22:18 -0000
d2946 1
a2946 1
+++ src/sys/netinet/ip_ipsp.c	23 Feb 2003 18:22:18 -0000
d2962 1
a2962 1
+++ src/sys/netinet/ip_output.c	23 Feb 2003 18:22:18 -0000
d2999 1
a2999 1
+++ src/sys/netinet/ipsec_output.c	23 Feb 2003 18:22:18 -0000
d3039 1
a3039 1
+++ src/sys/netinet/tcp_input.c	23 Feb 2003 18:22:18 -0000
d3055 1
a3055 1
+++ src/sys/netinet/tcp_output.c	23 Feb 2003 18:22:18 -0000
d3082 1
a3082 1
+++ src/sys/netinet/tcp_subr.c	23 Feb 2003 18:22:18 -0000
d3142 1
a3142 1
+++ src/sys/netinet/tcp_usrreq.c	23 Feb 2003 18:22:18 -0000
d3163 1
a3163 1
+++ src/sys/netinet/udp_usrreq.c	23 Feb 2003 18:22:18 -0000
d3178 1
a3178 1
+++ src/sys/netinet6/in6_ifattach.c	23 Feb 2003 18:22:18 -0000
d3209 1
a3209 1
+++ src/sys/netinet6/ip6_forward.c	23 Feb 2003 18:22:18 -0000
d3225 1
a3225 1
+++ src/sys/netinet6/ip6_output.c	23 Feb 2003 18:22:18 -0000
d3241 1
a3241 1
+++ src/sys/netinet6/raw_ip6.c	23 Feb 2003 18:22:21 -0000
d3258 1
a3258 1
+++ src/sys/nfs/nfsproto.h	23 Feb 2003 18:22:21 -0000
d3476 1
a3476 1
+++ src/sys/stand/boot/cmd.c	23 Feb 2003 18:22:21 -0000
d3526 1
a3526 1
+++ src/sys/sys/proc.h	23 Feb 2003 18:22:21 -0000
d3528 1
a3528 1
+/*	$MirBSD: obsd.kernel,v 1.4 2003/02/23 17:59:43 tg Exp $	*/
d3557 1
a3557 1
+++ src/sys/sys/resource.h	23 Feb 2003 18:22:21 -0000
d3575 1
a3575 1
+++ src/sys/sys/sysctl.h	23 Feb 2003 18:22:21 -0000
d3577 1
a3577 1
+/*	$MirBSD: obsd.kernel,v 1.4 2003/02/23 17:59:43 tg Exp $	*/
d3636 1
a3636 1
+++ src/sys/sys/systm.h	23 Feb 2003 18:22:21 -0000
d3651 1
a3651 1
+++ src/sys/sys/utsname.h	23 Feb 2003 18:22:21 -0000
d3653 1
a3653 1
+/*	$MirBSD: obsd.kernel,v 1.4 2003/02/23 17:59:43 tg Exp $	*/
d3682 1
a3682 1
+++ src/sys/ufs/ffs/ffs_softdep.c	23 Feb 2003 18:22:21 -0000
d3698 1
a3698 1
+++ src/sys/ufs/ffs/ffs_vfsops.c	23 Feb 2003 18:22:21 -0000
d3714 1
a3714 1
+++ src/sys/uvm/uvm_amap.c	23 Feb 2003 18:22:21 -0000
d3730 1
a3730 1
+++ src/sys/uvm/uvm_map.c	23 Feb 2003 18:22:21 -0000
d3768 1
a3768 1
+++ src/sys/uvm/uvm_meter.c	23 Feb 2003 18:22:21 -0000
d3804 1
a3804 1
+++ src/sys/uvm/uvm_pager.c	23 Feb 2003 18:22:21 -0000
d3820 1
a3820 1
+++ src/sys/uvm/uvm_swap.c	23 Feb 2003 18:22:22 -0000
@


1.4
log
@intermediate broken

first attempt to upgrade source tree and clean it up
additionally it makes libkern smaller by another like 20 bytes...
@
text
@d26 1
a26 1
against CTM on Sun Feb 23 17:57:04 UTC 2003.
d36 1
a36 1
+++ src/sys/arch/i386/conf/DISKLESS	23 Feb 2003 17:55:04 -0000
d69 1
a69 1
+++ src/sys/arch/i386/conf/GENERIC	23 Feb 2003 17:55:04 -0000
d71 1
a71 1
+#	$MirBSD: obsd.kernel,v 1.3 2003/02/23 16:13:25 tg Exp $
d165 1
a165 1
+++ src/sys/arch/i386/conf/Makefile.i386	23 Feb 2003 17:55:04 -0000
d167 1
a167 1
+#	$MirBSD: obsd.kernel,v 1.3 2003/02/23 16:13:25 tg Exp $
d197 1
a197 1
+++ src/sys/arch/i386/conf/RAMDISK	23 Feb 2003 17:55:04 -0000
d227 1
a227 1
+++ src/sys/arch/i386/conf/RAMDISKB	23 Feb 2003 17:55:04 -0000
d251 1
a251 1
+++ src/sys/arch/i386/conf/RAMDISKC	23 Feb 2003 17:55:04 -0000
d275 1
a275 1
+++ src/sys/arch/i386/conf/RAMDISK_CD	23 Feb 2003 17:55:04 -0000
d299 1
a299 1
+++ src/sys/arch/i386/i386/bios.c	23 Feb 2003 17:55:04 -0000
d315 1
a315 1
+++ src/sys/arch/i386/i386/machdep.c	23 Feb 2003 17:55:04 -0000
d346 170
d522 1
a522 1
+++ src/sys/arch/i386/include/exec.h	23 Feb 2003 17:55:04 -0000
d551 40
d597 1
a597 1
+++ src/sys/arch/i386/isa/clock.c	23 Feb 2003 17:55:04 -0000
d613 1
a613 1
+++ src/sys/arch/i386/isa/pccom.c	23 Feb 2003 17:55:04 -0000
d638 1
a638 1
+++ src/sys/arch/i386/pci/pchb.c	23 Feb 2003 17:55:04 -0000
d654 1
a654 1
+++ src/sys/arch/i386/pci/pci_addr_fixup.c	23 Feb 2003 17:55:04 -0000
d687 1
a687 1
+++ src/sys/arch/i386/pci/pcibios.c	23 Feb 2003 17:55:04 -0000
d707 1
a707 1
+++ src/sys/arch/i386/stand/Makefile.inc	23 Feb 2003 17:55:04 -0000
d723 1
a723 1
+++ src/sys/arch/i386/stand/boot/conf.c	23 Feb 2003 17:55:04 -0000
d761 1
a761 1
+++ src/sys/arch/i386/stand/libsa/apmprobe.c	23 Feb 2003 17:55:04 -0000
d924 1
a924 1
+++ src/sys/arch/i386/stand/libsa/bioscons.c	23 Feb 2003 17:55:04 -0000
d940 1
a940 1
+++ src/sys/arch/i386/stand/libsa/biosdev.c	23 Feb 2003 17:55:04 -0000
d988 1
a988 1
+++ src/sys/arch/i386/stand/libsa/cmd_i386.c	23 Feb 2003 17:55:04 -0000
d1065 1
a1065 1
+++ src/sys/arch/i386/stand/libsa/diskprobe.c	23 Feb 2003 17:55:04 -0000
d1116 1
a1116 1
+++ src/sys/arch/i386/stand/libsa/gidt.S	23 Feb 2003 17:55:04 -0000
d1143 1
a1143 1
+++ src/sys/arch/i386/stand/libsa/libsa.h	23 Feb 2003 17:55:04 -0000
d1163 1
a1163 1
+++ src/sys/arch/i386/stand/libsa/smpprobe.c	23 Feb 2003 17:55:04 -0000
d1190 1
a1190 1
+++ src/sys/conf/GENERIC	23 Feb 2003 17:55:04 -0000
d1192 1
a1192 1
+#	$MirBSD: obsd.kernel,v 1.3 2003/02/23 16:13:25 tg Exp $
d1245 1
a1245 1
+++ src/sys/conf/newvers.sh	23 Feb 2003 17:55:04 -0000
d1249 1
a1249 1
+#	$MirBSD: obsd.kernel,v 1.3 2003/02/23 16:13:25 tg Exp $
d1305 1
a1305 1
+ospl="$(echo '\$Date: 2003/02/23 16:13:25 $' | sed -e 's,^.*: ,,' -e 's,/,,g' -e 's, .*$,,')"
d1318 1
a1318 1
+    "    @@(#)MirBSD from ${ost} ${osr}-beta (${id}) #${v}: ${t}\n	@@(#)\$MirBSD: obsd.kernel,v 1.3 2003/02/23 16:13:25 tg Exp $\n";
d1322 1
a1322 1
+    "MirBSD ${osr}-${ospl} (${id}) #${v}: ${t}\n    ${u}@@${h}:${d}\n    patchlevel:\$MirBSD: obsd.kernel,v 1.3 2003/02/23 16:13:25 tg Exp $\n";
d1332 1
a1332 1
+++ src/sys/dev/ccd.c	23 Feb 2003 17:55:04 -0000
d1348 1
a1348 1
+++ src/sys/dev/systrace.c	23 Feb 2003 17:55:04 -0000
d1364 1
a1364 1
+++ src/sys/dev/ic/dc.c	23 Feb 2003 17:55:04 -0000
d1404 1
a1404 1
+++ src/sys/dev/ic/if_wi.c	23 Feb 2003 17:55:04 -0000
d1420 1
a1420 1
+++ src/sys/dev/ic/if_wi_hostap.c	23 Feb 2003 17:55:04 -0000
d1457 1
a1457 1
+++ src/sys/dev/ic/ne2000.c	23 Feb 2003 17:55:04 -0000
d1473 1
a1473 1
+++ src/sys/dev/ic/rtl80x9.c	23 Feb 2003 17:55:04 -0000
d1489 1
a1489 1
+++ src/sys/dev/ic/rtl81x9.c	23 Feb 2003 17:55:04 -0000
d1508 1
a1508 1
+++ src/sys/dev/isa/spkr.c	23 Feb 2003 17:55:04 -0000
d1510 1
a1510 1
+/*	$MirBSD: obsd.kernel,v 1.3 2003/02/23 16:13:25 tg Exp $	*/
d1967 1
a1967 1
+++ src/sys/dev/microcode/aic7xxx/Makefile	23 Feb 2003 17:55:04 -0000
d1983 1
a1983 1
+++ src/sys/dev/mii/bmtphy.c	23 Feb 2003 17:55:04 -0000
d2010 1
a2010 1
+++ src/sys/dev/pci/if_bge.c	23 Feb 2003 17:55:04 -0000
d2054 1
a2054 1
+++ src/sys/dev/pci/if_sf.c	23 Feb 2003 17:55:04 -0000
d2070 1
a2070 1
+++ src/sys/dev/pci/if_ste.c	23 Feb 2003 17:55:04 -0000
d2086 1
a2086 1
+++ src/sys/dev/pci/pciide.c	23 Feb 2003 17:55:05 -0000
d2111 1
a2111 1
+++ src/sys/dev/wscons/wsdisplay.c	23 Feb 2003 17:55:05 -0000
d2127 1
a2127 1
+++ src/sys/kern/kern_exec.c	23 Feb 2003 17:55:05 -0000
d2129 1
a2129 1
+/*	$MirBSD: obsd.kernel,v 1.3 2003/02/23 16:13:25 tg Exp $	*/
d2149 1
a2149 1
+++ src/sys/kern/kern_fork.c	23 Feb 2003 17:55:05 -0000
d2151 1
a2151 1
+/*	$MirBSD: obsd.kernel,v 1.3 2003/02/23 16:13:25 tg Exp $	*/
d2217 1
a2217 1
+++ src/sys/kern/kern_sig.c	23 Feb 2003 17:55:05 -0000
d2313 1
a2313 1
+++ src/sys/kern/kern_synch.c	23 Feb 2003 17:55:05 -0000
d2341 1
a2341 1
+++ src/sys/kern/kern_sysctl.c	23 Feb 2003 17:55:05 -0000
d2455 1
a2455 1
+++ src/sys/kern/subr_userconf.c	23 Feb 2003 17:55:05 -0000
d2480 1
a2480 1
+++ src/sys/kern/sys_generic.c	23 Feb 2003 17:55:05 -0000
d2505 1
a2505 1
+++ src/sys/kern/vfs_syscalls.c	23 Feb 2003 17:55:05 -0000
d2521 1
a2521 1
+++ src/sys/lib/libkern/arch/i386/Makefile.inc	23 Feb 2003 17:56:01 -0000
d2523 1
a2523 1
+#	$MirBSD$
d2540 1
a2540 1
+++ src/sys/lib/libkern/arch/i386/htonl.S	23 Feb 2003 17:56:39 -0000
d2611 1
a2611 1
+++ src/sys/lib/libkern/arch/i386/htons.S	23 Feb 2003 17:55:05 -0000
d2679 1
a2679 1
+++ src/sys/lib/libz/Makefile	23 Feb 2003 17:55:05 -0000
d2695 1
a2695 1
+++ src/sys/miscfs/procfs/procfs_vnops.c	23 Feb 2003 17:55:05 -0000
d2711 1
a2711 1
+++ src/sys/miscfs/union/union_vnops.c	23 Feb 2003 17:55:05 -0000
d2727 1
a2727 1
+++ src/sys/net/if_bridge.c	23 Feb 2003 17:55:05 -0000
d2743 1
a2743 1
+++ src/sys/net/if_vlan.c	23 Feb 2003 17:55:05 -0000
d2759 1
a2759 1
+++ src/sys/net/pf.c	23 Feb 2003 17:55:05 -0000
d2838 1
a2838 1
+++ src/sys/net/pf_table.c	23 Feb 2003 17:55:05 -0000
d2855 1
a2855 1
+++ src/sys/net/pfkeyv2.c	23 Feb 2003 17:55:05 -0000
d2871 1
a2871 1
+++ src/sys/netinet/ip_ah.c	23 Feb 2003 17:55:05 -0000
d2896 1
a2896 1
+++ src/sys/netinet/ip_esp.c	23 Feb 2003 17:55:05 -0000
d2921 1
a2921 1
+++ src/sys/netinet/ip_ipcomp.c	23 Feb 2003 17:55:05 -0000
d2946 1
a2946 1
+++ src/sys/netinet/ip_ipsp.c	23 Feb 2003 17:55:05 -0000
d2962 1
a2962 1
+++ src/sys/netinet/ip_output.c	23 Feb 2003 17:55:05 -0000
d2999 1
a2999 1
+++ src/sys/netinet/ipsec_output.c	23 Feb 2003 17:55:05 -0000
d3039 1
a3039 1
+++ src/sys/netinet/tcp_input.c	23 Feb 2003 17:55:05 -0000
d3055 1
a3055 1
+++ src/sys/netinet/tcp_output.c	23 Feb 2003 17:55:05 -0000
d3082 1
a3082 1
+++ src/sys/netinet/tcp_subr.c	23 Feb 2003 17:55:05 -0000
d3142 1
a3142 1
+++ src/sys/netinet/tcp_usrreq.c	23 Feb 2003 17:55:05 -0000
d3163 1
a3163 1
+++ src/sys/netinet/udp_usrreq.c	23 Feb 2003 17:55:05 -0000
d3178 1
a3178 1
+++ src/sys/netinet6/in6_ifattach.c	23 Feb 2003 17:55:05 -0000
d3209 1
a3209 1
+++ src/sys/netinet6/ip6_forward.c	23 Feb 2003 17:55:05 -0000
d3225 1
a3225 1
+++ src/sys/netinet6/ip6_output.c	23 Feb 2003 17:55:05 -0000
d3241 1
a3241 1
+++ src/sys/netinet6/raw_ip6.c	23 Feb 2003 17:55:05 -0000
d3258 1
a3258 1
+++ src/sys/nfs/nfsproto.h	23 Feb 2003 17:55:05 -0000
d3476 1
a3476 1
+++ src/sys/stand/boot/cmd.c	23 Feb 2003 17:55:05 -0000
d3526 1
a3526 1
+++ src/sys/sys/proc.h	23 Feb 2003 17:55:05 -0000
d3528 1
a3528 1
+/*	$MirBSD: obsd.kernel,v 1.3 2003/02/23 16:13:25 tg Exp $	*/
d3557 1
a3557 1
+++ src/sys/sys/resource.h	23 Feb 2003 17:55:05 -0000
d3575 1
a3575 1
+++ src/sys/sys/sysctl.h	23 Feb 2003 17:55:05 -0000
d3577 1
a3577 1
+/*	$MirBSD: obsd.kernel,v 1.3 2003/02/23 16:13:25 tg Exp $	*/
d3636 1
a3636 1
+++ src/sys/sys/systm.h	23 Feb 2003 17:55:05 -0000
d3651 1
a3651 1
+++ src/sys/sys/utsname.h	23 Feb 2003 17:55:05 -0000
d3653 1
a3653 1
+/*	$MirBSD: obsd.kernel,v 1.3 2003/02/23 16:13:25 tg Exp $	*/
d3682 1
a3682 1
+++ src/sys/ufs/ffs/ffs_softdep.c	23 Feb 2003 17:55:05 -0000
d3698 1
a3698 1
+++ src/sys/ufs/ffs/ffs_vfsops.c	23 Feb 2003 17:55:05 -0000
d3714 1
a3714 1
+++ src/sys/uvm/uvm_amap.c	23 Feb 2003 17:55:05 -0000
d3730 1
a3730 1
+++ src/sys/uvm/uvm_map.c	23 Feb 2003 17:55:05 -0000
d3768 1
a3768 1
+++ src/sys/uvm/uvm_meter.c	23 Feb 2003 17:55:05 -0000
d3804 1
a3804 1
+++ src/sys/uvm/uvm_pager.c	23 Feb 2003 17:55:05 -0000
d3820 1
a3820 1
+++ src/sys/uvm/uvm_swap.c	23 Feb 2003 17:55:05 -0000
@


1.3
log
@a.out kernel plus obsd.diff *sigh*
@
text
@d15 1
a15 4
I retain the right to be known as the author of the work. The author
and every single contributor, unless marked with "NOP" above, hereby
waive their right to require additional patent licences for usage of
this work, even if the work could infringe patents hold by them.
d24 1
a24 1
This diff, ID $MirBSD: regen-obsdp.sh,v 1.9 2003/02/23 11:48:42 tg Exp $
d26 1
a26 1
against CTM on Sun Feb 23 16:12:47 UTC 2003.
d28 2
a29 2
### GENERATOR: @@(#)_MirBSD: regen-obsdp.sh,v 1.9 2003/02/23 11:48:42 tg Exp $
### CTM OpenBSD-cvs 3059
d36 1
a36 1
+++ src/sys/arch/i386/conf/DISKLESS	23 Feb 2003 16:03:27 -0000
d66 4
a69 4
retrieving revision 1.328
diff -u -r1.328 GENERIC
--- src/sys/arch/i386/conf/GENERIC	21 Jan 2003 17:02:07 -0000	1.328
+++ src/sys/arch/i386/conf/GENERIC	23 Feb 2003 16:03:27 -0000
d71 2
a72 2
+#	$MirBSD: obsd.kernel,v 1.2 2003/02/23 16:03:21 tg Exp $
 #	$OpenBSD: GENERIC,v 1.328 2003/01/21 17:02:29 markus Exp $
d142 1
a142 1
@@@@ -452,7 +456,7 @@@@
d151 1
a151 1
@@@@ -522,6 +526,7 @@@@
d165 1
a165 1
+++ src/sys/arch/i386/conf/Makefile.i386	23 Feb 2003 16:03:27 -0000
d167 1
a167 1
+#	$MirBSD: obsd.kernel,v 1.2 2003/02/23 16:03:21 tg Exp $
d172 1
a172 1
+# Makefile for BSD
d197 1
a197 1
+++ src/sys/arch/i386/conf/RAMDISK	23 Feb 2003 16:03:27 -0000
d227 1
a227 1
+++ src/sys/arch/i386/conf/RAMDISKB	23 Feb 2003 16:03:27 -0000
d251 1
a251 1
+++ src/sys/arch/i386/conf/RAMDISKC	23 Feb 2003 16:03:27 -0000
d275 1
a275 1
+++ src/sys/arch/i386/conf/RAMDISK_CD	23 Feb 2003 16:03:27 -0000
d299 1
a299 1
+++ src/sys/arch/i386/i386/bios.c	23 Feb 2003 16:03:27 -0000
d315 1
a315 1
+++ src/sys/arch/i386/i386/machdep.c	23 Feb 2003 16:03:27 -0000
d352 1
a352 1
+++ src/sys/arch/i386/include/exec.h	23 Feb 2003 16:03:27 -0000
d387 1
a387 1
+++ src/sys/arch/i386/isa/clock.c	23 Feb 2003 16:03:27 -0000
d403 1
a403 1
+++ src/sys/arch/i386/isa/pccom.c	23 Feb 2003 16:03:27 -0000
d428 1
a428 1
+++ src/sys/arch/i386/pci/pchb.c	23 Feb 2003 16:03:27 -0000
d444 1
a444 1
+++ src/sys/arch/i386/pci/pci_addr_fixup.c	23 Feb 2003 16:03:27 -0000
d477 1
a477 1
+++ src/sys/arch/i386/pci/pcibios.c	23 Feb 2003 16:03:27 -0000
d497 1
a497 1
+++ src/sys/arch/i386/stand/Makefile.inc	23 Feb 2003 16:03:27 -0000
d513 1
a513 1
+++ src/sys/arch/i386/stand/boot/conf.c	23 Feb 2003 16:03:27 -0000
d551 1
a551 1
+++ src/sys/arch/i386/stand/libsa/apmprobe.c	23 Feb 2003 16:12:27 -0000
d714 1
a714 1
+++ src/sys/arch/i386/stand/libsa/bioscons.c	23 Feb 2003 16:03:27 -0000
d730 1
a730 1
+++ src/sys/arch/i386/stand/libsa/biosdev.c	23 Feb 2003 16:03:27 -0000
d778 1
a778 1
+++ src/sys/arch/i386/stand/libsa/cmd_i386.c	23 Feb 2003 16:12:27 -0000
d855 1
a855 1
+++ src/sys/arch/i386/stand/libsa/diskprobe.c	23 Feb 2003 16:03:27 -0000
d906 1
a906 1
+++ src/sys/arch/i386/stand/libsa/gidt.S	23 Feb 2003 16:12:27 -0000
d933 1
a933 1
+++ src/sys/arch/i386/stand/libsa/libsa.h	23 Feb 2003 16:12:27 -0000
d953 1
a953 1
+++ src/sys/arch/i386/stand/libsa/smpprobe.c	23 Feb 2003 16:03:27 -0000
d980 1
a980 1
+++ src/sys/conf/GENERIC	23 Feb 2003 16:03:27 -0000
d982 1
a982 1
+#	$MirBSD: obsd.kernel,v 1.2 2003/02/23 16:03:21 tg Exp $
d1032 5
a1036 5
retrieving revision 1.48
diff -u -r1.48 newvers.sh
--- src/sys/conf/newvers.sh	4 Oct 2002 01:38:59 -0000	1.48
+++ src/sys/conf/newvers.sh	23 Feb 2003 16:03:27 -0000
@@@@ -1,49 +1,29 @@@@
d1039 4
a1042 2
+# Copyright (c) 2000-2002 by Thorsten "mirabile" Glaser <x86@@ePost.de>
+
d1045 2
a1046 5
+# I retain the right to be known as the author of the work. The author
+# and every single contributor, unless marked with "NOP" above, hereby
+# waive their right to require additional patent licences for usage of
+# this work, even if the work could infringe patents hold by them.
+
d1053 1
a1053 2
+#	$MirBSD: obsd.kernel,v 1.2 2003/02/23 16:03:21 tg Exp $
 #	$OpenBSD: newvers.sh,v 1.48 2002/10/04 01:39:21 deraadt Exp $
d1055 5
a1059 12
-#
-# Copyright (c) 1984, 1986, 1990, 1993
-#	The Regents of the University of California.  All rights reserved.
-#
-# Redistribution and use in source and binary forms, with or without
-# modification, are permitted provided that the following conditions
-# are met:
-# 1. Redistributions of source code must retain the above copyright
-#    notice, this list of conditions and the following disclaimer.
-# 2. Redistributions in binary form must reproduce the above copyright
-#    notice, this list of conditions and the following disclaimer in the
-#    documentation and/or other materials provided with the distribution.
d1064 7
a1070 16
-# 4. Neither the name of the University nor the names of its contributors
-#    may be used to endorse or promote products derived from this software
-#    without specific prior written permission.
-#
-# THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
-# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
-# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
-# ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
-# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
-# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
-# OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
-# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
-# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
-# OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
-# SUCH DAMAGE.
-#
d1072 2
a1073 1
-
a1077 1
+
d1088 1
a1088 1
@@@@ -63,18 +43,22 @@@@
d1094 2
a1095 2
 osr="3.2"
+ospl="$(echo '\$Date: 2003/02/23 16:03:21 $' | sed -e 's,^.*: ,,' -e 's,/,,g' -e 's, .*$,,')"
d1107 2
a1108 2
-    "    @@(#)${ost} ${osr}-current (${id}) #${v}: ${t}\n";
+    "    @@(#)MirBSD from ${ost} ${osr}-current (${id}) #${v}: ${t}\n	@@(#)\$MirBSD: obsd.kernel,v 1.2 2003/02/23 16:03:21 tg Exp $\n";
d1110 1
a1110 1
-    "${ost} ${osr}-current (${id}) #${v}: ${t}\n    ${u}@@${h}:${d}\n";
d1112 1
a1112 1
+    "MirBSD ${osr}-${ospl} (${id}) #${v}: ${t}\n    ${u}@@${h}:${d}\n    patchlevel:\$MirBSD: obsd.kernel,v 1.2 2003/02/23 16:03:21 tg Exp $\n";
d1122 1
a1122 1
+++ src/sys/dev/ccd.c	23 Feb 2003 16:03:27 -0000
d1135 4
a1138 4
retrieving revision 1.27
diff -u -r1.27 systrace.c
--- src/sys/dev/systrace.c	12 Dec 2002 08:35:43 -0000	1.27
+++ src/sys/dev/systrace.c	23 Feb 2003 16:03:27 -0000
d1151 4
a1154 4
retrieving revision 1.53
diff -u -r1.53 dc.c
--- src/sys/dev/ic/dc.c	21 Oct 2002 20:30:10 -0000	1.53
+++ src/sys/dev/ic/dc.c	23 Feb 2003 16:12:28 -0000
d1191 5
a1195 5
retrieving revision 1.91
diff -u -r1.91 if_wi.c
--- src/sys/dev/ic/if_wi.c	23 Jan 2003 19:26:57 -0000	1.91
+++ src/sys/dev/ic/if_wi.c	23 Feb 2003 16:03:27 -0000
@@@@ -975,7 +975,7 @@@@
d1207 4
a1210 4
retrieving revision 1.23
diff -u -r1.23 if_wi_hostap.c
--- src/sys/dev/ic/if_wi_hostap.c	21 Jan 2003 20:09:17 -0000	1.23
+++ src/sys/dev/ic/if_wi_hostap.c	23 Feb 2003 16:03:27 -0000
d1247 1
a1247 1
+++ src/sys/dev/ic/ne2000.c	23 Feb 2003 16:03:27 -0000
d1263 1
a1263 1
+++ src/sys/dev/ic/rtl80x9.c	23 Feb 2003 16:03:27 -0000
d1276 4
a1279 4
retrieving revision 1.19
diff -u -r1.19 rtl81x9.c
--- src/sys/dev/ic/rtl81x9.c	15 Oct 2002 16:01:48 -0000	1.19
+++ src/sys/dev/ic/rtl81x9.c	23 Feb 2003 16:03:27 -0000
d1298 1
a1298 1
+++ src/sys/dev/isa/spkr.c	23 Feb 2003 16:03:27 -0000
d1300 1
a1300 1
+/*	$MirBSD: obsd.kernel,v 1.2 2003/02/23 16:03:21 tg Exp $	*/
d1757 1
a1757 1
+++ src/sys/dev/microcode/aic7xxx/Makefile	23 Feb 2003 16:03:27 -0000
d1773 1
a1773 1
+++ src/sys/dev/mii/bmtphy.c	23 Feb 2003 16:12:28 -0000
d1797 4
a1800 4
retrieving revision 1.18
diff -u -r1.18 if_bge.c
--- src/sys/dev/pci/if_bge.c	15 Jan 2003 06:31:02 -0000	1.18
+++ src/sys/dev/pci/if_bge.c	23 Feb 2003 16:03:28 -0000
d1844 1
a1844 1
+++ src/sys/dev/pci/if_sf.c	23 Feb 2003 16:03:28 -0000
d1860 1
a1860 1
+++ src/sys/dev/pci/if_ste.c	23 Feb 2003 16:03:28 -0000
d1873 5
a1877 5
retrieving revision 1.110
diff -u -r1.110 pciide.c
--- src/sys/dev/pci/pciide.c	17 Jan 2003 00:54:01 -0000	1.110
+++ src/sys/dev/pci/pciide.c	23 Feb 2003 16:03:28 -0000
@@@@ -3756,7 +3756,7 @@@@
d1886 1
a1886 1
@@@@ -4056,7 +4056,7 @@@@
d1901 1
a1901 1
+++ src/sys/dev/wscons/wsdisplay.c	23 Feb 2003 16:03:28 -0000
d1917 1
a1917 1
+++ src/sys/kern/kern_exec.c	23 Feb 2003 16:03:28 -0000
d1919 1
a1919 1
+/*	$MirBSD: obsd.kernel,v 1.2 2003/02/23 16:03:21 tg Exp $	*/
d1939 1
a1939 1
+++ src/sys/kern/kern_fork.c	23 Feb 2003 16:03:28 -0000
d1941 1
a1941 1
+/*	$MirBSD: obsd.kernel,v 1.2 2003/02/23 16:03:21 tg Exp $	*/
d2007 1
a2007 1
+++ src/sys/kern/kern_sig.c	23 Feb 2003 16:12:28 -0000
d2103 1
a2103 1
+++ src/sys/kern/kern_synch.c	23 Feb 2003 16:12:28 -0000
d2131 1
a2131 1
+++ src/sys/kern/kern_sysctl.c	23 Feb 2003 16:03:28 -0000
d2245 1
a2245 1
+++ src/sys/kern/subr_userconf.c	23 Feb 2003 16:12:28 -0000
d2270 1
a2270 1
+++ src/sys/kern/sys_generic.c	23 Feb 2003 16:12:28 -0000
d2295 1
a2295 1
+++ src/sys/kern/vfs_syscalls.c	23 Feb 2003 16:12:28 -0000
d2305 19
d2330 2
a2331 2
+++ src/sys/lib/libkern/arch/i386/htonl.S	23 Feb 2003 16:03:28 -0000
@@@@ -1,41 +1,18 @@@@
d2356 1
a2356 2
+ * Copyright (c) 2000-2002 by Thorsten "mirabile" Glaser <x86@@ePost.de>
  *
d2368 4
d2374 2
a2375 6
+ * I retain the right to be known as the author of the work. For no fee
+ * and further restrainments, all patents hold by the author or contri-
+ * butors, applying to this work, shall be licensed to any copy of this
+ * work, whether modified, merged or not.
  *
- *	from: @@(#)htonl.s	5.3 (Berkeley) 12/17/90
d2384 3
a2386 2
@@@@ -43,7 +20,7 @@@@
 /* netorder = htonl(hostorder) */
d2401 2
a2402 2
+++ src/sys/lib/libkern/arch/i386/htons.S	23 Feb 2003 16:03:28 -0000
@@@@ -1,41 +1,18 @@@@
d2427 1
a2427 2
+ * Copyright (c) 2000-2002 by Thorsten "mirabile" Glaser <x86@@ePost.de>
  *
d2439 4
d2445 2
a2446 6
+ * I retain the right to be known as the author of the work. For no fee
+ * and further restrainments, all patents hold by the author or contri-
+ * butors, applying to this work, shall be licensed to any copy of this
+ * work, whether modified, merged or not.
  *
- *	from: @@(#)htons.s	5.2 (Berkeley) 12/17/90
d2455 3
a2457 2
@@@@ -43,5 +20,5 @@@@
 /* netorder = htons(hostorder) */
a2462 137
Index: src/sys/lib/libkern/arch/i386/ntohl.S
===================================================================
RCS file: /cvs/src/sys/lib/libkern/arch/i386/ntohl.S,v
retrieving revision 1.2
diff -u -r1.2 ntohl.S
--- src/sys/lib/libkern/arch/i386/ntohl.S	27 Sep 1996 06:47:27 -0000	1.2
+++ src/sys/lib/libkern/arch/i386/ntohl.S	23 Feb 2003 16:03:28 -0000
@@@@ -1,41 +1,18 @@@@
-/*	$OpenBSD: ntohl.S,v 1.2 1996/09/27 06:47:47 mickey Exp $	*/
-
 /*-
- * Copyright (c) 1990 The Regents of the University of California.
- * All rights reserved.
- *
- * This code is derived from software contributed to Berkeley by
- * William Jolitz.
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions
- * are met:
- * 1. Redistributions of source code must retain the above copyright
- *    notice, this list of conditions and the following disclaimer.
- * 2. Redistributions in binary form must reproduce the above copyright
- *    notice, this list of conditions and the following disclaimer in the
- *    documentation and/or other materials provided with the distribution.
- * 3. All advertising materials mentioning features or use of this software
- *    must display the following acknowledgement:
- *	This product includes software developed by the University of
- *	California, Berkeley and its contributors.
- * 4. Neither the name of the University nor the names of its contributors
- *    may be used to endorse or promote products derived from this software
- *    without specific prior written permission.
+ * Copyright (c) 2000-2002 by Thorsten "mirabile" Glaser <x86@@ePost.de>
  *
- * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
- * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
- * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
- * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
- * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
- * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
- * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
- * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
- * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
- * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
- * SUCH DAMAGE.
+ * I hereby permit everyone who obtained a copy of this work to distri-
+ * bute, sell, give away, modify, sublicense, merge and use it, freely.
+ * I retain the right to be known as the author of the work. For no fee
+ * and further restrainments, all patents hold by the author or contri-
+ * butors, applying to this work, shall be licensed to any copy of this
+ * work, whether modified, merged or not.
  *
- *	from: @@(#)ntohl.s	5.2 (Berkeley) 12/17/90
+ * The work is provided "as is", with no explicit or implicit warranty.
+ * Use it at your own risk. Neither the author, nor contributors may be
+ * held liable for any damage, directly or indirectly, which originated
+ * by the creation or modification of this work. Since modern computing
+ * devices are error-prone, flawless behaviour cannot be expected.
  */
 
 #include <machine/asm.h>
@@@@ -43,7 +20,7 @@@@
 /* hostorder = ntohl(netorder) */
 ENTRY(ntohl)
 	movl	4(%esp),%eax
-	rorw	$8,%ax
+	xchgb	%ah,%al
 	roll	$16,%eax
-	rorw	$8,%ax
+	xchgb	%ah,%al
 	ret
Index: src/sys/lib/libkern/arch/i386/ntohs.S
===================================================================
RCS file: /cvs/src/sys/lib/libkern/arch/i386/ntohs.S,v
retrieving revision 1.2
diff -u -r1.2 ntohs.S
--- src/sys/lib/libkern/arch/i386/ntohs.S	27 Sep 1996 06:47:27 -0000	1.2
+++ src/sys/lib/libkern/arch/i386/ntohs.S	23 Feb 2003 16:03:28 -0000
@@@@ -1,39 +1,18 @@@@
-/*	$OpenBSD: ntohs.S,v 1.2 1996/09/27 06:47:47 mickey Exp $	*/
-
 /*-
- * Copyright (c) 1990 The Regents of the University of California.
- * All rights reserved.
- *
- * This code is derived from software contributed to Berkeley by
- * William Jolitz.
+ * Copyright (c) 2000-2002 by Thorsten "mirabile" Glaser <x86@@ePost.de>
  *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions
- * are met:
- * 1. Redistributions of source code must retain the above copyright
- *    notice, this list of conditions and the following disclaimer.
- * 2. Redistributions in binary form must reproduce the above copyright
- *    notice, this list of conditions and the following disclaimer in the
- *    documentation and/or other materials provided with the distribution.
- * 3. All advertising materials mentioning features or use of this software
- *    must display the following acknowledgement:
- *	This product includes software developed by the University of
- *	California, Berkeley and its contributors.
- * 4. Neither the name of the University nor the names of its contributors
- *    may be used to endorse or promote products derived from this software
- *    without specific prior written permission.
+ * I hereby permit everyone who obtained a copy of this work to distri-
+ * bute, sell, give away, modify, sublicense, merge and use it, freely.
+ * I retain the right to be known as the author of the work. For no fee
+ * and further restrainments, all patents hold by the author or contri-
+ * butors, applying to this work, shall be licensed to any copy of this
+ * work, whether modified, merged or not.
  *
- * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
- * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
- * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
- * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
- * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
- * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
- * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
- * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
- * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
- * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
- * SUCH DAMAGE.
+ * The work is provided "as is", with no explicit or implicit warranty.
+ * Use it at your own risk. Neither the author, nor contributors may be
+ * held liable for any damage, directly or indirectly, which originated
+ * by the creation or modification of this work. Since modern computing
+ * devices are error-prone, flawless behaviour cannot be expected.
  *
  *	from: @@(#)ntohs.s	5.2 (Berkeley) 12/17/90
  *	$Id: ntohs.S,v 1.2 1996/09/27 06:47:47 mickey Exp $
@@@@ -44,5 +23,5 @@@@
 /* hostorder = ntohs(netorder) */
 ENTRY(ntohs)
 	movzwl	4(%esp),%eax
-	rorw	$8,%ax
+	xchgb	%ah,%al
 	ret
d2469 1
a2469 1
+++ src/sys/lib/libz/Makefile	23 Feb 2003 16:09:10 -0000
d2482 4
a2485 4
retrieving revision 1.26
diff -u -r1.26 procfs_vnops.c
--- src/sys/miscfs/procfs/procfs_vnops.c	6 Apr 2002 23:39:51 -0000	1.26
+++ src/sys/miscfs/procfs/procfs_vnops.c	23 Feb 2003 16:12:30 -0000
d2501 1
a2501 1
+++ src/sys/miscfs/union/union_vnops.c	23 Feb 2003 16:12:30 -0000
d2514 4
a2517 4
retrieving revision 1.109
diff -u -r1.109 if_bridge.c
--- src/sys/net/if_bridge.c	7 Jan 2003 17:46:59 -0000	1.109
+++ src/sys/net/if_bridge.c	23 Feb 2003 16:12:30 -0000
d2530 4
a2533 4
retrieving revision 1.33
diff -u -r1.33 if_vlan.c
--- src/sys/net/if_vlan.c	7 Jan 2003 09:00:12 -0000	1.33
+++ src/sys/net/if_vlan.c	23 Feb 2003 16:12:30 -0000
d2546 5
a2550 5
retrieving revision 1.311
diff -u -r1.311 pf.c
--- src/sys/net/pf.c	25 Jan 2003 22:48:23 -0000	1.311
+++ src/sys/net/pf.c	23 Feb 2003 16:12:30 -0000
@@@@ -942,6 +942,7 @@@@
d2558 1
a2558 1
@@@@ -1023,12 +1024,12 @@@@
d2574 1
a2574 1
@@@@ -1041,6 +1042,8 @@@@
d2583 1
a2583 1
@@@@ -2380,6 +2383,8 @@@@
d2592 1
a2592 1
@@@@ -3214,6 +3219,8 @@@@
d2601 1
a2601 1
@@@@ -3382,6 +3389,8 @@@@
d2610 1
a2610 1
@@@@ -4268,8 +4277,9 @@@@
d2625 5
a2629 5
retrieving revision 1.24
diff -u -r1.24 pf_table.c
--- src/sys/net/pf_table.c	15 Jan 2003 16:54:48 -0000	1.24
+++ src/sys/net/pf_table.c	23 Feb 2003 16:03:28 -0000
@@@@ -1029,7 +1029,7 @@@@
d2634 1
a2634 18
+_skip:	;
 	}
 	if (!(flags & PFR_FLAG_DUMMY)) {
 		if (flags & PFR_FLAG_ATOMIC)
@@@@ -1071,7 +1071,7 @@@@
 			SLIST_INSERT_HEAD(&workq, p, pfrkt_workq);
 			xdel++;
 		}
-_skip:
+_skip:	;
 	}
 
 	if (!(flags & PFR_FLAG_DUMMY)) {
@@@@ -1222,7 +1222,7 @@@@
 			else
 				xchange++;
 		}
-_skip:
d2642 13
a2654 51
retrieving revision 1.84
diff -u -r1.84 pfkeyv2.c
--- src/sys/net/pfkeyv2.c	31 Jul 2002 00:13:14 -0000	1.84
+++ src/sys/net/pfkeyv2.c	23 Feb 2003 16:12:30 -0000
@@@@ -803,7 +803,7 @@@@
 
     struct tdb sa, *sa2 = NULL;
 
-    struct sadb_msg *smsg;
+    struct sadb_msg *smsg = NULL;
     struct sadb_spirange *sprng;
     struct sadb_sa *ssa;
     struct sadb_supported *ssup;
@@@@ -1773,7 +1773,8 @@@@
 	for (i = 1; i <= SADB_EXT_MAX; i++)
 	  headers[i] = NULL;
 
-	smsg->sadb_msg_errno = abs(rval);
+    if (smsg != NULL)
+  	  smsg->sadb_msg_errno = abs(rval);
     }
     else
     {
@@@@ -1783,6 +1784,9 @@@@
 	  if (headers[i])
 	    seen |= (1 << i);
 
+    if (smsg == NULL)
+      goto realret;
+
 	if ((seen & sadb_exts_allowed_out[smsg->sadb_msg_type]) != seen)
 	  goto realret;
 
@@@@ -1822,7 +1826,7 @@@@
     struct sadb_prop *sa_prop;
     struct sadb_msg *smsg;
     int rval = 0;
-    int i, j;
+    int i = 0, j;
 
     *seq = pfkeyv2_seq++;
 
@@@@ -2106,7 +2110,7 @@@@
     void *p, *headers[SADB_EXT_MAX+1], *buffer = NULL;
     struct sadb_msg *smsg;
     int rval = 0;
-    int i;
+    int i = 0;
 
     switch (sa->tdb_sproto)
     {
d2658 5
a2662 5
retrieving revision 1.70
diff -u -r1.70 ip_ah.c
--- src/sys/netinet/ip_ah.c	5 Jul 2002 23:20:31 -0000	1.70
+++ src/sys/netinet/ip_ah.c	23 Feb 2003 16:12:30 -0000
@@@@ -682,7 +682,7 @@@@
d2671 1
a2671 1
@@@@ -1214,7 +1214,7 @@@@
d2683 5
a2687 5
retrieving revision 1.76
diff -u -r1.76 ip_esp.c
--- src/sys/netinet/ip_esp.c	7 Nov 2002 15:16:17 -0000	1.76
+++ src/sys/netinet/ip_esp.c	23 Feb 2003 16:12:30 -0000
@@@@ -453,7 +453,7 @@@@
a2693 1
 	struct cryptodesc *crd;
d2695 2
a2696 1
@@@@ -979,7 +979,7 @@@@
d2708 5
a2712 5
retrieving revision 1.9
diff -u -r1.9 ip_ipcomp.c
--- src/sys/netinet/ip_ipcomp.c	12 Sep 2002 10:11:17 -0000	1.9
+++ src/sys/netinet/ip_ipcomp.c	23 Feb 2003 16:12:30 -0000
@@@@ -206,7 +206,7 @@@@
d2721 1
a2721 1
@@@@ -609,7 +609,7 @@@@
d2736 1
a2736 1
+++ src/sys/netinet/ip_ipsp.c	23 Feb 2003 16:12:30 -0000
d2749 4
a2752 4
retrieving revision 1.150
diff -u -r1.150 ip_output.c
--- src/sys/netinet/ip_output.c	10 Oct 2002 17:27:18 -0000	1.150
+++ src/sys/netinet/ip_output.c	23 Feb 2003 16:12:30 -0000
d2786 4
a2789 4
retrieving revision 1.25
diff -u -r1.25 ipsec_output.c
--- src/sys/netinet/ipsec_output.c	28 Aug 2002 15:42:41 -0000	1.25
+++ src/sys/netinet/ipsec_output.c	23 Feb 2003 16:12:30 -0000
d2809 1
a2809 1
@@@@ -323,11 +323,11 @@@@
d2826 4
a2829 4
retrieving revision 1.124
diff -u -r1.124 tcp_input.c
--- src/sys/netinet/tcp_input.c	11 Sep 2002 03:26:41 -0000	1.124
+++ src/sys/netinet/tcp_input.c	23 Feb 2003 16:12:30 -0000
d2845 1
a2845 1
+++ src/sys/netinet/tcp_output.c	23 Feb 2003 16:12:31 -0000
d2872 1
a2872 1
+++ src/sys/netinet/tcp_subr.c	23 Feb 2003 16:12:31 -0000
d2929 5
a2933 5
retrieving revision 1.67
diff -u -r1.67 tcp_usrreq.c
--- src/sys/netinet/tcp_usrreq.c	11 Sep 2002 03:15:14 -0000	1.67
+++ src/sys/netinet/tcp_usrreq.c	23 Feb 2003 16:12:31 -0000
@@@@ -783,10 +783,10 @@@@
d2953 1
a2953 1
+++ src/sys/netinet/udp_usrreq.c	23 Feb 2003 16:12:31 -0000
d2968 1
a2968 1
+++ src/sys/netinet6/in6_ifattach.c	23 Feb 2003 16:12:31 -0000
d2999 1
a2999 1
+++ src/sys/netinet6/ip6_forward.c	23 Feb 2003 16:12:31 -0000
d3015 1
a3015 1
+++ src/sys/netinet6/ip6_output.c	23 Feb 2003 16:12:31 -0000
d3031 1
a3031 1
+++ src/sys/netinet6/raw_ip6.c	23 Feb 2003 16:12:31 -0000
d3048 1
a3048 1
+++ src/sys/nfs/nfsproto.h	23 Feb 2003 16:12:31 -0000
d3266 1
a3266 1
+++ src/sys/stand/boot/cmd.c	23 Feb 2003 16:12:31 -0000
d3316 1
a3316 1
+++ src/sys/sys/proc.h	23 Feb 2003 16:03:28 -0000
d3318 1
a3318 1
+/*	$MirBSD: obsd.kernel,v 1.2 2003/02/23 16:03:21 tg Exp $	*/
d3347 1
a3347 1
+++ src/sys/sys/resource.h	23 Feb 2003 16:12:31 -0000
d3365 1
a3365 1
+++ src/sys/sys/sysctl.h	23 Feb 2003 16:03:28 -0000
d3367 1
a3367 1
+/*	$MirBSD: obsd.kernel,v 1.2 2003/02/23 16:03:21 tg Exp $	*/
d3426 1
a3426 1
+++ src/sys/sys/systm.h	23 Feb 2003 16:03:28 -0000
d3441 1
a3441 1
+++ src/sys/sys/utsname.h	23 Feb 2003 16:03:28 -0000
d3443 1
a3443 1
+/*	$MirBSD: obsd.kernel,v 1.2 2003/02/23 16:03:21 tg Exp $	*/
d3472 1
a3472 1
+++ src/sys/ufs/ffs/ffs_softdep.c	23 Feb 2003 16:12:31 -0000
d3488 1
a3488 1
+++ src/sys/ufs/ffs/ffs_vfsops.c	23 Feb 2003 16:12:31 -0000
d3504 1
a3504 1
+++ src/sys/uvm/uvm_amap.c	23 Feb 2003 16:12:31 -0000
d3520 1
a3520 1
+++ src/sys/uvm/uvm_map.c	23 Feb 2003 16:12:31 -0000
d3558 1
a3558 1
+++ src/sys/uvm/uvm_meter.c	23 Feb 2003 16:03:28 -0000
d3594 1
a3594 1
+++ src/sys/uvm/uvm_pager.c	23 Feb 2003 16:12:31 -0000
d3610 1
a3610 1
+++ src/sys/uvm/uvm_swap.c	23 Feb 2003 16:12:31 -0000
d3701 1
a3703 2
src/sys/lib/libkern/arch/i386/ntohl.S		smaller (me!)
src/sys/lib/libkern/arch/i386/ntohs.S		smaller (me!)
@


1.2
log
@the old a.out kernel
@
text
@d29 1
a29 1
against CTM on Sun Feb 23 16:01:08 UTC 2003.
d39 1
a39 1
+++ src/sys/arch/i386/conf/DISKLESS	23 Feb 2003 16:01:03 -0000
d72 1
a72 1
+++ src/sys/arch/i386/conf/GENERIC	23 Feb 2003 16:01:03 -0000
d74 1
a74 1
+#	$MirBSD: obsd.tygs,v 1.21 2003/01/27 21:17:21 tg Exp $
d168 1
a168 1
+++ src/sys/arch/i386/conf/Makefile.i386	23 Feb 2003 16:01:03 -0000
d170 1
a170 1
+#	$MirBSD: obsd.tygs,v 1.21 2003/01/27 21:17:21 tg Exp $
d200 1
a200 1
+++ src/sys/arch/i386/conf/RAMDISK	23 Feb 2003 16:01:03 -0000
d230 1
a230 1
+++ src/sys/arch/i386/conf/RAMDISKB	23 Feb 2003 16:01:03 -0000
d254 1
a254 1
+++ src/sys/arch/i386/conf/RAMDISKC	23 Feb 2003 16:01:03 -0000
d278 1
a278 1
+++ src/sys/arch/i386/conf/RAMDISK_CD	23 Feb 2003 16:01:03 -0000
d302 1
a302 1
+++ src/sys/arch/i386/i386/bios.c	23 Feb 2003 16:01:03 -0000
d318 1
a318 1
+++ src/sys/arch/i386/i386/machdep.c	23 Feb 2003 16:01:03 -0000
d355 1
a355 1
+++ src/sys/arch/i386/include/exec.h	23 Feb 2003 16:01:03 -0000
d390 1
a390 1
+++ src/sys/arch/i386/isa/clock.c	23 Feb 2003 16:01:03 -0000
d406 1
a406 1
+++ src/sys/arch/i386/isa/pccom.c	23 Feb 2003 16:01:03 -0000
d431 1
a431 1
+++ src/sys/arch/i386/pci/pchb.c	23 Feb 2003 16:01:03 -0000
d447 1
a447 1
+++ src/sys/arch/i386/pci/pci_addr_fixup.c	23 Feb 2003 16:01:03 -0000
d480 1
a480 1
+++ src/sys/arch/i386/pci/pcibios.c	23 Feb 2003 16:01:03 -0000
d500 1
a500 1
+++ src/sys/arch/i386/stand/Makefile.inc	23 Feb 2003 16:01:03 -0000
d516 1
a516 1
+++ src/sys/arch/i386/stand/boot/conf.c	23 Feb 2003 16:01:03 -0000
d548 163
d717 1
a717 1
+++ src/sys/arch/i386/stand/libsa/bioscons.c	23 Feb 2003 16:01:03 -0000
d733 1
a733 1
+++ src/sys/arch/i386/stand/libsa/biosdev.c	23 Feb 2003 16:01:03 -0000
d775 77
d858 1
a858 1
+++ src/sys/arch/i386/stand/libsa/diskprobe.c	23 Feb 2003 16:01:03 -0000
d903 47
d956 1
a956 1
+++ src/sys/arch/i386/stand/libsa/smpprobe.c	23 Feb 2003 16:01:03 -0000
d983 1
a983 1
+++ src/sys/conf/GENERIC	23 Feb 2003 16:01:03 -0000
d985 1
a985 1
+#	$MirBSD: obsd.tygs,v 1.21 2003/01/27 21:17:21 tg Exp $
d1038 1
a1038 1
+++ src/sys/conf/newvers.sh	23 Feb 2003 16:01:03 -0000
d1057 1
a1057 1
+#	$MirBSD: obsd.tygs,v 1.21 2003/01/27 21:17:21 tg Exp $
d1116 1
a1116 1
+ospl="$(echo '\$Date: 2003/01/27 21:17:21 $' | sed -e 's,^.*: ,,' -e 's,/,,g' -e 's, .*$,,')"
d1129 1
a1129 1
+    "    @@(#)MirBSD from ${ost} ${osr}-current (${id}) #${v}: ${t}\n	@@(#)\$MirBSD: obsd.tygs,v 1.21 2003/01/27 21:17:21 tg Exp $\n";
d1133 1
a1133 1
+    "MirBSD ${osr}-${ospl} (${id}) #${v}: ${t}\n    ${u}@@${h}:${d}\n    patchlevel:\$MirBSD: obsd.tygs,v 1.21 2003/01/27 21:17:21 tg Exp $\n";
d1143 1
a1143 1
+++ src/sys/dev/ccd.c	23 Feb 2003 16:01:03 -0000
d1159 1
a1159 1
+++ src/sys/dev/systrace.c	23 Feb 2003 16:01:03 -0000
d1169 40
d1215 1
a1215 1
+++ src/sys/dev/ic/if_wi.c	23 Feb 2003 16:01:03 -0000
d1231 1
a1231 1
+++ src/sys/dev/ic/if_wi_hostap.c	23 Feb 2003 16:01:03 -0000
d1268 1
a1268 1
+++ src/sys/dev/ic/ne2000.c	23 Feb 2003 16:01:03 -0000
d1284 1
a1284 1
+++ src/sys/dev/ic/rtl80x9.c	23 Feb 2003 16:01:03 -0000
d1300 1
a1300 1
+++ src/sys/dev/ic/rtl81x9.c	23 Feb 2003 16:01:03 -0000
d1319 1
a1319 1
+++ src/sys/dev/isa/spkr.c	23 Feb 2003 16:01:03 -0000
d1321 1
a1321 1
+/*	$MirBSD: obsd.tygs,v 1.21 2003/01/27 21:17:21 tg Exp $	*/
d1778 1
a1778 1
+++ src/sys/dev/microcode/aic7xxx/Makefile	23 Feb 2003 16:01:03 -0000
d1788 27
d1821 1
a1821 1
+++ src/sys/dev/pci/if_bge.c	23 Feb 2003 16:01:03 -0000
d1865 1
a1865 1
+++ src/sys/dev/pci/if_sf.c	23 Feb 2003 16:01:03 -0000
d1881 1
a1881 1
+++ src/sys/dev/pci/if_ste.c	23 Feb 2003 16:01:03 -0000
d1897 1
a1897 1
+++ src/sys/dev/pci/pciide.c	23 Feb 2003 16:01:03 -0000
d1922 1
a1922 1
+++ src/sys/dev/wscons/wsdisplay.c	23 Feb 2003 16:01:03 -0000
d1938 1
a1938 1
+++ src/sys/kern/kern_exec.c	23 Feb 2003 16:01:03 -0000
d1940 1
a1940 1
+/*	$MirBSD: obsd.misc,v 1.4 2003/01/27 21:17:20 tg Exp $	*/
d1960 1
a1960 1
+++ src/sys/kern/kern_fork.c	23 Feb 2003 16:01:03 -0000
d1962 1
a1962 1
+/*	$MirBSD: obsd.misc,v 1.4 2003/01/27 21:17:20 tg Exp $	*/
d2022 124
d2152 1
a2152 1
+++ src/sys/kern/kern_sysctl.c	23 Feb 2003 16:01:03 -0000
d2260 66
d2332 1
a2332 1
+++ src/sys/lib/libkern/arch/i386/htonl.S	23 Feb 2003 16:01:03 -0000
d2403 1
a2403 1
+++ src/sys/lib/libkern/arch/i386/htons.S	23 Feb 2003 16:01:03 -0000
d2471 1
a2471 1
+++ src/sys/lib/libkern/arch/i386/ntohl.S	23 Feb 2003 16:01:03 -0000
d2542 1
a2542 1
+++ src/sys/lib/libkern/arch/i386/ntohs.S	23 Feb 2003 16:01:03 -0000
d2602 159
d2767 1
a2767 1
+++ src/sys/net/pf_table.c	23 Feb 2003 16:01:03 -0000
d2795 709
d3510 1
a3510 1
+++ src/sys/sys/proc.h	23 Feb 2003 16:01:03 -0000
d3512 1
a3512 1
+/*	$MirBSD: obsd.misc,v 1.4 2003/01/27 21:17:20 tg Exp $	*/
d3535 18
d3559 1
a3559 1
+++ src/sys/sys/sysctl.h	23 Feb 2003 16:01:03 -0000
d3561 1
a3561 1
+/*	$MirBSD: obsd.tygs,v 1.21 2003/01/27 21:17:21 tg Exp $	*/
d3620 1
a3620 1
+++ src/sys/sys/systm.h	23 Feb 2003 16:01:03 -0000
d3635 1
a3635 1
+++ src/sys/sys/utsname.h	23 Feb 2003 16:01:03 -0000
d3637 1
a3637 1
+/*	$MirBSD: obsd.tygs,v 1.21 2003/01/27 21:17:21 tg Exp $	*/
d3660 86
d3752 1
a3752 1
+++ src/sys/uvm/uvm_meter.c	23 Feb 2003 16:01:03 -0000
d3782 32
@


1.1
log
@add ELF kernel diffs
next steps: remove ELF stuff, compile under a.out system; update
@
text
@d29 1
a29 1
against CTM on Sun Feb 23 15:59:05 UTC 2003.
d39 1
a39 1
+++ src/sys/arch/i386/conf/DISKLESS	11 Feb 2003 21:10:10 -0000
d72 1
a72 1
+++ src/sys/arch/i386/conf/GENERIC	11 Feb 2003 21:10:10 -0000
d74 1
a74 1
+#	$MirBSD: obsd.tygs,v 1.24 2003/02/11 21:08:31 tg Exp $
d168 1
a168 1
+++ src/sys/arch/i386/conf/Makefile.i386	11 Feb 2003 21:10:10 -0000
d170 1
a170 1
+#	$MirBSD: obsd.tygs,v 1.24 2003/02/11 21:08:31 tg Exp $
d185 1
a185 1
@@@@ -47,9 +48,9 @@@@
d192 1
a192 2
-LINKFLAGS=	-z -Ttext D0100000 -e start
+LINKFLAGS=	-Ttext 0xD0100100 -e start -N
a193 2
 
 HOSTCC= ${CC}
d200 1
a200 1
+++ src/sys/arch/i386/conf/RAMDISK	11 Feb 2003 21:10:10 -0000
d230 1
a230 1
+++ src/sys/arch/i386/conf/RAMDISKB	11 Feb 2003 21:10:10 -0000
d254 1
a254 1
+++ src/sys/arch/i386/conf/RAMDISKC	11 Feb 2003 21:10:10 -0000
d278 1
a278 1
+++ src/sys/arch/i386/conf/RAMDISK_CD	11 Feb 2003 21:10:10 -0000
d302 1
a302 1
+++ src/sys/arch/i386/i386/bios.c	15 Feb 2003 15:38:23 -0000
a311 301
Index: src/sys/arch/i386/i386/db_magic.s
===================================================================
RCS file: /cvs/src/sys/arch/i386/i386/db_magic.s,v
retrieving revision 1.1
diff -u -r1.1 db_magic.s
--- src/sys/arch/i386/i386/db_magic.s	4 May 1996 14:32:40 -0000	1.1
+++ src/sys/arch/i386/i386/db_magic.s	15 Feb 2003 15:38:23 -0000
@@@@ -112,50 +112,50 @@@@
  */
 ENTRY(dr0)
       movl    S_ARG0, %eax
-      movl    %eax,_dr_addr
+      movl    %eax,_C_LABEL(dr_addr)
       movl    %eax, %db0
       movl    $0, %ecx
       jmp     0f
 ENTRY(dr1)
       movl    S_ARG0, %eax
-      movl    %eax,_dr_addr+1*4
+      movl    %eax,_C_LABEL(dr_addr)+1*4
       movl    %eax, %db1
       movl    $2, %ecx
       jmp     0f
 ENTRY(dr2)
       movl    S_ARG0, %eax
-      movl    %eax,_dr_addr+2*4
+      movl    %eax,_C_LABEL(dr_addr)+2*4
       movl    %eax, %db2
       movl    $4, %ecx
       jmp     0f
 ENTRY(dr3)
       movl    S_ARG0, %eax
-      movl    %eax,_dr_addr+3*4
+      movl    %eax,_C_LABEL(dr_addr)+3*4
       movl    %eax, %db3
       movl    $6, %ecx
 0:
       pushl   %ebp
       movl    %esp, %ebp
       movl    %db7, %edx
-      movl    %edx,_dr_addr+4*4
+      movl    %edx,_C_LABEL(dr_addr)+4*4
       andl    dr_msk(,%ecx,2),%edx    /* clear out new entry */
-      movl    %edx,_dr_addr+5*4
+      movl    %edx,_C_LABEL(dr_addr)+5*4
       movzbl  B_ARG3, %eax
       andb    $3, %al
       shll    %cl, %eax
       orl     %eax, %edx
       movzbl  B_ARG1, %eax
       andb    $3, %al
-      addb    $0x10, %ecx
+      addb    $0x10, %cl
       shll    %cl, %eax
       orl     %eax, %edx
       movzbl  B_ARG2, %eax
       andb    $3, %al
-      addb    $0x2, %ecx
+      addb    $0x2, %cl
       shll    %cl, %eax
       orl     %eax, %edx
       movl    %edx, %db7
-      movl    %edx,_dr_addr+7*4
+      movl    %edx,_C_LABEL(dr_addr)+7*4
       movl    %edx, %eax
       leave
       ret
Index: src/sys/arch/i386/i386/in_cksum.s
===================================================================
RCS file: /cvs/src/sys/arch/i386/i386/in_cksum.s,v
retrieving revision 1.5
diff -u -r1.5 in_cksum.s
--- src/sys/arch/i386/i386/in_cksum.s	4 Jul 2001 08:57:25 -0000	1.5
+++ src/sys/arch/i386/i386/in_cksum.s	15 Feb 2003 15:38:23 -0000
@@@@ -180,13 +180,17 @@@@
 
 in_cksum49:	pushl	%edi			# len - bytes checksummed
 		pushl	$warning		# push warning string
-		call	_printf			# printf()
+		call	_C_LABEL(printf)	# printf()
 		leal	8(%esp), %esp		#
 		jmp	in_cksum48		#
 
 		.data
 
+#ifdef __ELF__
+		.align	4
+#else
 		.align	2
+#endif
 
 table1:		.long	in_cksum8		# 4-byte aligned
 		.long	in_cksum4		# checksum 3 bytes
Index: src/sys/arch/i386/i386/locore.s
===================================================================
RCS file: /cvs/src/sys/arch/i386/i386/locore.s,v
retrieving revision 1.68
diff -u -r1.68 locore.s
--- src/sys/arch/i386/i386/locore.s	9 Jan 2003 22:26:47 -0000	1.68
+++ src/sys/arch/i386/i386/locore.s	15 Feb 2003 15:38:23 -0000
@@@@ -70,9 +70,15 @@@@
 /*
  * override user-land alignment before including asm.h
  */
+#ifdef __ELF__
+#define	ALIGN_DATA	.align	4
+#define	ALIGN_TEXT	.align	4,0x90	/* 4-byte boundaries, NOP-filled */
+#define	SUPERALIGN_TEXT	.align	16,0x90	/* 16-byte boundaries better for 486 */
+#else
 #define	ALIGN_DATA	.align	2
 #define	ALIGN_TEXT	.align	2,0x90	/* 4-byte boundaries, NOP-filled */
 #define	SUPERALIGN_TEXT	.align	4,0x90	/* 16-byte boundaries better for 486 */
+#endif
 #define _ALIGN_TEXT	ALIGN_TEXT
 #include <machine/asm.h>
 
@@@@ -100,8 +106,8 @@@@
 	pushl	%ds		; \
 	pushl	%es		; \
 	movl	$GSEL(GDATA_SEL, SEL_KPL),%eax	; \
-	movl	%ax,%ds		; \
-	movl	%ax,%es
+	movw	%ax,%ds		; \
+	movw	%ax,%es
 #define	INTRFASTEXIT \
 	popl	%es		; \
 	popl	%ds		; \
@@@@ -591,14 +597,14 @@@@
 
 	/* Clear segment registers; always null in proc0. */
 	xorl	%ecx,%ecx
-	movl	%cx,%fs
-	movl	%cx,%gs
+	movw	%cx,%fs
+	movw	%cx,%gs
 
 	call	_C_LABEL(main)
 
 NENTRY(proc_trampoline)
 	pushl	%ebx
-	call	%esi
+	call	*%esi
 	addl	$4,%esp
 	INTRFASTEXIT
 	/* NOTREACHED */
@@@@ -609,7 +615,7 @@@@
  * Signal trampoline; copied to top of user stack.
  */
 NENTRY(sigcode)
-	call	SIGF_HANDLER(%esp)
+	call	*SIGF_HANDLER(%esp)
 	leal	SIGF_SC(%esp),%eax	# scp (the call may have clobbered the
 					# copy at SIGF_SCP(%esp))
 #ifdef VM86
@@@@ -618,8 +624,8 @@@@
 #endif
 	movl	SC_FS(%eax),%ecx
 	movl	SC_GS(%eax),%edx
-	movl	%cx,%fs
-	movl	%dx,%gs
+	movw	%cx,%fs
+	movw	%dx,%gs
 1:	pushl	%eax
 	pushl	%eax			# junk to fake return address
 	movl	$SYS_sigreturn,%eax
@@@@ -633,7 +639,7 @@@@
 
 #ifdef COMPAT_SVR4
 NENTRY(svr4_sigcode)
-	call	SVR4_SIGF_HANDLER(%esp)
+	call	*SVR4_SIGF_HANDLER(%esp)
 	leal	SVR4_SIGF_UC(%esp),%eax	# ucp (the call may have clobbered the
 					# copy at SIGF_UCP(%esp))
 #ifdef VM86
@@@@ -642,8 +648,8 @@@@
 #endif
 	movl	SVR4_UC_FS(%eax),%ecx
 	movl	SVR4_UC_GS(%eax),%edx
-	movl	%cx,%fs
-	movl	%dx,%gs
+	movw	%cx,%fs
+	movw	%dx,%gs
 1:	pushl	%eax
 	pushl	$1			# setcontext(p) == syscontext(1, p)
 	pushl	%eax			# junk to fake return address
@@@@ -662,7 +668,7 @@@@
  * Signal trampoline; copied to top of user stack.
  */
 NENTRY(linux_sigcode)
-	call	LINUX_SIGF_HANDLER(%esp)
+	call	*LINUX_SIGF_HANDLER(%esp)
 	leal	LINUX_SIGF_SC(%esp),%ebx # scp (the call may have clobbered the
 					# copy at SIGF_SCP(%esp))
 #ifdef VM86
@@@@ -671,8 +677,8 @@@@
 #endif
 	movl	LINUX_SC_FS(%ebx),%ecx
 	movl	LINUX_SC_GS(%ebx),%edx
-	movl	%cx,%fs
-	movl	%dx,%gs
+	movw	%cx,%fs
+	movw	%dx,%gs
 1:	pushl	%eax			# junk to fake return address
 	movl	$LINUX_SYS_sigreturn,%eax
 	int	$0x80			# enter kernel with args on stack
@@@@ -689,7 +695,7 @@@@
  * Signal trampoline; copied to top of user stack.
  */
 NENTRY(freebsd_sigcode)
-	call	FREEBSD_SIGF_HANDLER(%esp)
+	call	*FREEBSD_SIGF_HANDLER(%esp)
 	leal	FREEBSD_SIGF_SC(%esp),%eax # scp (the call may have clobbered
 					# the copy at SIGF_SCP(%esp))
 	pushl	%eax
@@@@ -1277,9 +1283,9 @@@@
 	nop
 1:	/* Reload "stale" selectors. */
 	movl	$GSEL(GDATA_SEL, SEL_KPL),%eax
-	movl	%ax,%ds
-	movl	%ax,%es
-	movl	%ax,%ss
+	movw	%ax,%ds
+	movw	%ax,%es
+	movw	%ax,%ss
 	/* Reload code selector by doing intersegment return. */
 	popl	%eax
 	pushl	$GSEL(GCODE_SEL, SEL_KPL)
@@@@ -1527,8 +1533,8 @@@@
 	xorl	%eax, %eax
 	xorl	%ecx, %ecx
 #endif
-	movl	%fs,%ax
-	movl	%gs,%cx
+	movw	%fs,%ax
+	movw	%gs,%cx
 	movl	%eax,PCB_FS(%esi)
 	movl	%ecx,PCB_GS(%esi)
 
@@@@ -1587,8 +1593,8 @@@@
 	/* Restore segment registers. */
 	movl	PCB_FS(%esi),%eax
 	movl	PCB_GS(%esi),%ecx
-	movl	%ax,%fs
-	movl	%cx,%gs
+	movw	%ax,%fs
+	movw	%cx,%gs
 
 switch_restored:
 	/* Restore cr0 (including FPU state). */
@@@@ -1651,8 +1657,8 @@@@
 
 	/* Clear segment registers; always null in proc0. */
 	xorl	%ecx,%ecx
-	movl	%cx,%fs
-	movl	%cx,%gs
+	movw	%cx,%fs
+	movw	%cx,%gs
 
 	/* Restore cr0 (including FPU state). */
 	movl	PCB_CR0(%esi),%ecx
@@@@ -1688,8 +1694,8 @@@@
 	xorl	%eax, %eax
 	xorl	%ecx, %ecx
 #endif
-	movl	%fs,%ax
-	movl	%gs,%cx
+	movw	%fs,%ax
+	movw	%gs,%cx
 	movl	%eax,PCB_FS(%edx)
 	movl	%ecx,PCB_GS(%edx)
 
@@@@ -1714,7 +1720,11 @@@@
  * XXX - debugger traps are now interrupt gates so at least bdb doesn't lose
  * control.  The sti's give the standard losing behaviour for ddb and kgdb.
  */
+#ifdef __ELF__
+#define	IDTVEC(name)	ALIGN_TEXT; .globl X/**/name; X/**/name:
+#else
 #define	IDTVEC(name)	ALIGN_TEXT; .globl _X/**/name; _X/**/name:
+#endif
 
 #define	TRAP(a)		pushl $(a) ; jmp _C_LABEL(alltraps)
 #define	ZTRAP(a)	pushl $0 ; TRAP(a)
@@@@ -1750,7 +1760,7 @@@@
 	pushl	$T_DNA
 	INTRENTRY
 	pushl	_C_LABEL(curproc)
-	call	_C_LABEL(npxdna)
+	call	*_C_LABEL(npxdna)
 	addl	$4,%esp
 	testl	%eax,%eax
 	jz	calltrap
@@@@ -1820,7 +1830,7 @@@@
 	ZTRAP(T_PROTFLT)
 NENTRY(resume_pop_ds)
 	movl	$GSEL(GDATA_SEL, SEL_KPL),%eax
-	movl	%ax,%es
+	movw	%ax,%es
 NENTRY(resume_pop_es)
 	movl	$T_PROTFLT,TF_TRAPNO(%esp)
 	jmp	calltrap
d318 1
a318 1
+++ src/sys/arch/i386/i386/machdep.c	15 Feb 2003 15:38:23 -0000
a348 261
Index: src/sys/arch/i386/i386/microtime.s
===================================================================
RCS file: /cvs/src/sys/arch/i386/i386/microtime.s,v
retrieving revision 1.16
diff -u -r1.16 microtime.s
--- src/sys/arch/i386/i386/microtime.s	24 Sep 2002 00:06:00 -0000	1.16
+++ src/sys/arch/i386/i386/microtime.s	15 Feb 2003 15:38:23 -0000
@@@@ -49,7 +49,7 @@@@
 ENTRY(microtime)
 
 #if defined(I586_CPU) || defined(I686_CPU)
-	movl	_pentium_mhz, %ecx
+	movl	_C_LABEL(pentium_mhz), %ecx
 	testl	%ecx, %ecx
 	jne	pentium_microtime
 #else
@@@@ -97,7 +97,7 @@@@
 
 	movl	$11932,%edx	# counter limit
 
-	testb	$IRQ_BIT(0),_ipending + IRQ_BYTE(0)
+	testb	$IRQ_BIT(0),_C_LABEL(ipending) + IRQ_BYTE(0)
 	jnz	1f
 
 	cmpl	$12,%ecx	# check for potential overflow
@@@@ -123,8 +123,8 @@@@
 	shrl	$12,%eax		# a = a/4096 = 3433d/4096
 
 common_microtime:
-	movl	_time,%edx	# get time.tv_sec
-	addl	_time+4,%eax	# add time.tv_usec
+	movl	_C_LABEL(time),%edx	# get time.tv_sec
+	addl	_C_LABEL(time)+4,%eax	# add time.tv_usec
 
 	popfl			# enable interrupts
 	
@@@@ -141,8 +141,8 @@@@
 
 #if defined(I586_CPU) || defined(I686_CPU)
 	.data
-	.globl	_pentium_base_tsc
-	.comm	_pentium_base_tsc,8
+	.globl	_C_LABEL(pentium_base_tsc)
+	.comm	_C_LABEL(pentium_base_tsc),8
 	.text
 
 	.align	2, 0x90
@@@@ -150,8 +150,8 @@@@
 	pushfl
 	cli
 	.byte	0x0f, 0x31	# RDTSC
-	subl	_pentium_base_tsc,%eax
-	sbbl	_pentium_base_tsc+4,%edx
+	subl	_C_LABEL(pentium_base_tsc),%eax
+	sbbl	_C_LABEL(pentium_base_tsc)+4,%edx
 	/*
 	 * correct the high word first so we won't
 	 * receive a result overflow aka div/0 fault
Index: src/sys/arch/i386/i386/random.s
===================================================================
RCS file: /cvs/src/sys/arch/i386/i386/random.s,v
retrieving revision 1.3
diff -u -r1.3 random.s
--- src/sys/arch/i386/i386/random.s	4 Jul 2001 08:57:25 -0000	1.3
+++ src/sys/arch/i386/i386/random.s	15 Feb 2003 15:38:23 -0000
@@@@ -45,20 +45,20 @@@@
 #include <machine/asm.h>
 
 	.data
-	.globl	__randseed
-__randseed:
+	.globl	_C_LABEL(_randseed)
+_C_LABEL(_randseed):
 	.long	1
 	.text
 ENTRY(random)
 	movl	$16807,%eax
-	imull	__randseed
+	imull	_C_LABEL(_randseed)
 	shld	$1,%eax,%edx
 	andl	$0x7fffffff,%eax
 	addl	%edx,%eax
 	js	1f
-	movl	%eax,__randseed
+	movl	%eax,_C_LABEL(_randseed)
 	ret
 1:
 	subl	$0x7fffffff,%eax
-	movl	%eax,__randseed
+	movl	%eax,_C_LABEL(_randseed)
 	ret
Index: src/sys/arch/i386/include/asm.h
===================================================================
RCS file: /cvs/src/sys/arch/i386/include/asm.h,v
retrieving revision 1.5
diff -u -r1.5 asm.h
--- src/sys/arch/i386/include/asm.h	5 Sep 2001 08:22:14 -0000	1.5
+++ src/sys/arch/i386/include/asm.h	15 Feb 2003 15:38:23 -0000
@@@@ -45,10 +45,10 @@@@
 #ifdef PIC
 #define PIC_PROLOGUE	\
 	pushl	%ebx;	\
-	call	1f;	\
-1:			\
+	call	666f;	\
+666:			\
 	popl	%ebx;	\
-	addl	$__GLOBAL_OFFSET_TABLE_+[.-1b], %ebx
+	addl	$_C_LABEL(_GLOBAL_OFFSET_TABLE_)+[.-666b], %ebx
 #define PIC_EPILOGUE	\
 	popl	%ebx
 #define PIC_PLT(x)	x@@PLT
@@@@ -62,12 +62,25 @@@@
 #define PIC_GOTOFF(x)	x
 #endif
 
-#ifdef __STDC__
-# define _C_LABEL(x)	_ ## x
-#else
-# define _C_LABEL(x)	_/**/x
-#endif
+#define _C_LABEL(name)	name
 #define	_ASM_LABEL(x)	x
+
+/*
+ * WEAK ALIAS: create a weak alias (ELF only)
+ */
+#ifdef __ELF__
+#define WEAK_ALIAS(alias,sym) \
+	.weak alias; \
+	alias = sym
+#endif
+
+/*
+ * WARN_REFERENCES: create a warning if the specified symbol is referenced
+ * (ELF only).
+ */
+#ifdef __ELF__
+	.section .gnu.warning. ## _sym ; .ascii _msg ; .text
+#endif /* __ELF__ */
 
 /* let kernels and others override entrypoint alignment */
 #ifndef _ALIGN_TEXT
Index: src/sys/arch/i386/include/bus.h
===================================================================
RCS file: /cvs/src/sys/arch/i386/include/bus.h,v
retrieving revision 1.34
diff -u -r1.34 bus.h
--- src/sys/arch/i386/include/bus.h	16 Jan 2003 04:15:38 -0000	1.34
+++ src/sys/arch/i386/include/bus.h	15 Feb 2003 15:38:23 -0000
@@@@ -639,9 +639,9 @@@@
 	int _port1 = (h1)+(o1); int _port2 = (h2)+(o2); int _cnt=(cnt);	\
 	if ((t) == I386_BUS_SPACE_IO) {					\
 		__asm __volatile("					\
-		1:	movl %w1,%%dx				;	\
+		1:	movl %w1,%%edx				;	\
 			inb  %%dx,%%al				;	\
-			movl %w0,%%dx				;	\
+			movl %w0,%%edx				;	\
 			outb %%al,%%dx				;	\
 			incl %0					;	\
 			incl %1					;	\
@@@@ -656,14 +656,14 @@@@
 	int _port1 = (h1)+(o1); int _port2 = (h2)+(o2); int _cnt=(cnt);	\
 	if ((t) == I386_BUS_SPACE_IO) {					\
 		__asm __volatile("					\
-		1:	movl %w1,%%dx				;	\
+		1:	movl %k1,%%edx				;	\
 			inw  %%dx,%%ax				;	\
-			movl %w0,%%dx				;	\
+			movl %k0,%%edx				;	\
 			outw %%ax,%%dx				;	\
 			addl $2, %0				;	\
 			addl $2, %1				;	\
 			loop 1b"				:	\
-		    "+D" (_port2), "+S" (_port1), "+c" ((_cnt))	::	\
+		    "+D" (_port2), "+ES" (_port1), "+c" ((_cnt))	::	\
 		    "%edx", "%eax", "cc");				\
 	} else								\
 		i386_space_copy(_port1, _port2, 2, _cnt);		\
@@@@ -673,14 +673,14 @@@@
 	int _port1 = (h1)+(o1); int _port2 = (h2)+(o2); int _cnt=(cnt);	\
 	if ((t) == I386_BUS_SPACE_IO) {					\
 		__asm __volatile("					\
-		1:	movl %w1,%%dx				;	\
+		1:f	movl %w1,%%edx				;	\
 			inl  %%dx,%%eax				;	\
-			movl %w0,%%dx				;	\
+			movl %w0,%%edx				;	\
 			outl %%eax,%%dx				;	\
 			addl $4, %0				;	\
 			addl $4, %1				;	\
 			loop 1b"				:	\
-		    "+D" (_port2), "+S" (_port1), "+c" ((_cnt))	::	\
+		    "+D" (_port2), "+ES" (_port1), "+c" ((_cnt))	::	\
 		    "%edx", "%eax", "cc");				\
 	} else								\
 		i386_space_copy(_port1, _port2, 4, _cnt);		\
Index: src/sys/arch/i386/include/cdefs.h
===================================================================
RCS file: /cvs/src/sys/arch/i386/include/cdefs.h,v
retrieving revision 1.7
diff -u -r1.7 cdefs.h
--- src/sys/arch/i386/include/cdefs.h	18 Aug 2001 02:34:44 -0000	1.7
+++ src/sys/arch/i386/include/cdefs.h	15 Feb 2003 15:38:23 -0000
@@@@ -9,34 +9,11 @@@@
 #ifndef	_MACHINE_CDEFS_H_
 #define	_MACHINE_CDEFS_H_
 
-#ifndef	_C_LABEL
-#ifdef __STDC__
-#define _C_LABEL(x)	__STRING(_ ## x)
-#else
-#define _C_LABEL(x)	__STRING(_/**/x)
-#endif
-#endif /* _C_LABEL */
-
-#ifdef __GNUC__
-#ifdef __STDC__
-#define __indr_reference(sym,alias)	\
-	__asm__(".stabs \"_" #alias "\",11,0,0,0");	\
-	__asm__(".stabs \"_" #sym "\",1,0,0,0")
-#define __warn_references(sym,msg)	\
-	__asm__(".stabs \"" msg "\",30,0,0,0");		\
-	__asm__(".stabs \"_" #sym "\",1,0,0,0")
-#define __weak_alias(alias,sym)				\
-	__asm__(".weak _" #alias "; _" #alias "= _" __STRING(sym))
-#else
-#define __indr_reference(sym,alias)	\
-	__asm__(".stabs \"_/**/alias\",11,0,0,0");	\
-	__asm__(".stabs \"_/**/sym\",1,0,0,0")
-#define __warn_references(sym,msg)	\
-	__asm__(".stabs msg,30,0,0,0");			\
-	__asm__(".stabs \"_/**/sym\",1,0,0,0")
-#define __weak_alias(alias,sym)				\
-	__asm__(".weak _/**/alias; _/**/alias = _/**/sym")
-#endif
+#if defined(__GNUC__) && defined(__STDC__)
+#define __weak_alias(alias,sym)						\
+	__asm__(".weak " __STRING(alias) " ; " __STRING(alias) " = " __STRING(sym))
+#define __warn_references(sym,msg)					\
+	__asm__(".section .gnu.warning." __STRING(sym) " ; .ascii \"" msg "\" ; .text")
 #else
 #define __indr_reference(sym,alias)
 #define __warn_references(sym,msg)
Index: src/sys/arch/i386/include/db_machdep.h
===================================================================
RCS file: /cvs/src/sys/arch/i386/include/db_machdep.h,v
retrieving revision 1.7
diff -u -r1.7 db_machdep.h
--- src/sys/arch/i386/include/db_machdep.h	14 Mar 2002 01:26:11 -0000	1.7
+++ src/sys/arch/i386/include/db_machdep.h	15 Feb 2003 15:38:23 -0000
@@@@ -97,6 +97,8 @@@@
 #define DB_TASK_NAME_TITLE	"COMMAND                "
 #define DB_TASK_NAME_LEN	23
 #define DB_NULL_TASK_NAME	"?                      "
+#define DB_ELF_SYMBOLS
+#define DB_ELFSIZE		32
 
 /*
  * Constants for KGDB.
d355 1
a355 1
+++ src/sys/arch/i386/include/exec.h	11 Feb 2003 21:10:10 -0000
a383 40
Index: src/sys/arch/i386/include/intr.h
===================================================================
RCS file: /cvs/src/sys/arch/i386/include/intr.h,v
retrieving revision 1.18
diff -u -r1.18 intr.h
--- src/sys/arch/i386/include/intr.h	11 Dec 2002 07:15:49 -0000	1.18
+++ src/sys/arch/i386/include/intr.h	15 Feb 2003 15:38:23 -0000
@@@@ -226,7 +226,8 @@@@
 softintr(mask)
 	int mask;
 {
-	__asm __volatile("orl %0,_ipending" : : "ir" (mask));
+	__asm __volatile("orl %1, %0" : "=m"(ipending) : "ir" (mask));
+
 }
 
 #define	setsoftast()	(astpending = 1)
Index: src/sys/arch/i386/include/param.h
===================================================================
RCS file: /cvs/src/sys/arch/i386/include/param.h,v
retrieving revision 1.21
diff -u -r1.21 param.h
--- src/sys/arch/i386/include/param.h	26 Jun 2002 08:42:17 -0000	1.21
+++ src/sys/arch/i386/include/param.h	15 Feb 2003 15:38:23 -0000
@@@@ -61,9 +61,15 @@@@
  * Round p (pointer or byte index) up to a correctly-aligned value
  * for all data types (int, long, ...).   The result is u_int and
  * must be cast to any desired pointer type.
+ *
+ * ALIGNED_POINTER is a boolean macro that checks whether an address
+ * is valid to fetch data elements of type t from on this architecture.
+ * This does not reflect the optimal alignment, just the possibility
+ * (within reasonable limits). 
  */
 #define ALIGNBYTES	(sizeof(int) - 1)
 #define ALIGN(p)	(((u_int)(p) + ALIGNBYTES) &~ ALIGNBYTES)
+#define ALIGNED_POINTER(p,t)   1
 
 #define	PGSHIFT		12		/* LOG2(NBPG) */
 #define	NBPG		(1 << PGSHIFT)	/* bytes/page */
d390 1
a390 1
+++ src/sys/arch/i386/isa/clock.c	15 Feb 2003 15:38:23 -0000
a399 84
Index: src/sys/arch/i386/isa/icu.s
===================================================================
RCS file: /cvs/src/sys/arch/i386/isa/icu.s,v
retrieving revision 1.18
diff -u -r1.18 icu.s
--- src/sys/arch/i386/isa/icu.s	4 Dec 2001 00:00:14 -0000	1.18
+++ src/sys/arch/i386/isa/icu.s	15 Feb 2003 15:38:23 -0000
@@@@ -139,7 +139,7 @@@@
 	call	_C_LABEL(comsoft)
 	movl	%ebx,_C_LABEL(cpl)
 #endif
-	jmp	%esi
+	jmp	*%esi
 
 #define DONETISR(s, c) \
 	.globl  _C_LABEL(c)	;\
@@@@ -155,7 +155,7 @@@@
 	xchgl	_C_LABEL(netisr),%edi
 #include <net/netisr_dispatch.h>
 	movl	%ebx,_C_LABEL(cpl)
-	jmp	%esi
+	jmp	*%esi
 #undef DONETISR
 
 IDTVEC(softclock)
@@@@ -163,5 +163,5 @@@@
 	movl	%eax,_C_LABEL(cpl)
 	call	_C_LABEL(softclock)
 	movl	%ebx,_C_LABEL(cpl)
-	jmp	%esi
+	jmp	*%esi
 
Index: src/sys/arch/i386/isa/npx.c
===================================================================
RCS file: /cvs/src/sys/arch/i386/isa/npx.c,v
retrieving revision 1.25
diff -u -r1.25 npx.c
--- src/sys/arch/i386/isa/npx.c	14 Mar 2002 01:26:11 -0000	1.25
+++ src/sys/arch/i386/isa/npx.c	15 Feb 2003 15:38:23 -0000
@@@@ -145,6 +145,11 @@@@
 extern int i386_fpu_exception;
 extern int i386_fpu_fdivbug;
 
+#ifdef __ELF__
+#define AOUT_UNDERSCORE ""
+#else
+#define AOUT_UNDERSCORE "_"
+#endif
 /*
  * Special interrupt handlers.  Someday intr0-intr15 will be used to count
  * interrupts.  We'll still need a special exception 16 handler.  The busy
@@@@ -152,9 +157,9 @@@@
  */
 void probeintr(void);
 asm (".text\n\t"
-"_probeintr:\n\t"
+AOUT_UNDERSCORE "probeintr:\n\t"
 	"ss\n\t"
-	"incl	_npx_intrs_while_probing\n\t"
+	"incl	" AOUT_UNDERSCORE "npx_intrs_while_probing\n\t"
 	"pushl	%eax\n\t"
 	"movb	$0x20,%al	# EOI (asm in strings loses cpp features)\n\t"
 	"outb	%al,$0xa0	# IO_ICU2\n\t"
@@@@ -166,9 +171,9 @@@@
 
 void probetrap(void);
 asm (".text\n\t"
-"_probetrap:\n\t"
+AOUT_UNDERSCORE "probetrap:\n\t"
 	"ss\n\t"
-	"incl	_npx_traps_while_probing\n\t"
+	"incl	" AOUT_UNDERSCORE "npx_traps_while_probing\n\t"
 	"fnclex\n\t"
 	"iret\n\t");
 
@@@@ -307,7 +312,7 @@@@
 
 int npx586bug1(int, int);
 asm (".text\n\t"
-"_npx586bug1:\n\t"
+AOUT_UNDERSCORE "npx586bug1:\n\t"
 	"fildl	4(%esp)		# x\n\t"
 	"fildl	8(%esp)		# y\n\t"
 	"fld	%st(1)\n\t"
d406 1
a406 1
+++ src/sys/arch/i386/isa/pccom.c	15 Feb 2003 15:38:23 -0000
a424 176
Index: src/sys/arch/i386/isa/vector.s
===================================================================
RCS file: /cvs/src/sys/arch/i386/isa/vector.s,v
retrieving revision 1.15
diff -u -r1.15 vector.s
--- src/sys/arch/i386/isa/vector.s	6 Dec 2001 21:08:51 -0000	1.15
+++ src/sys/arch/i386/isa/vector.s	15 Feb 2003 15:38:23 -0000
@@@@ -85,16 +85,16 @@@@
 #ifdef ICU_HARDWARE_MASK
 
 #define	MASK(irq_num, icu) \
-	movb	_imen + IRQ_BYTE(irq_num),%al				;\
+	movb	_C_LABEL(imen) + IRQ_BYTE(irq_num),%al				;\
 	orb	$IRQ_BIT(irq_num),%al					;\
-	movb	%al,_imen + IRQ_BYTE(irq_num)				;\
+	movb	%al,_C_LABEL(imen) + IRQ_BYTE(irq_num)				;\
 	FASTER_NOP							;\
 	outb	%al,$(icu+1)
 #define	UNMASK(irq_num, icu) \
 	cli								;\
-	movb	_imen + IRQ_BYTE(irq_num),%al				;\
+	movb	_C_LABEL(imen) + IRQ_BYTE(irq_num),%al				;\
 	andb	$~IRQ_BIT(irq_num),%al					;\
-	movb	%al,_imen + IRQ_BYTE(irq_num)				;\
+	movb	%al,_C_LABEL(imen) + IRQ_BYTE(irq_num)				;\
 	FASTER_NOP							;\
 	outb	%al,$(icu+1)						;\
 	sti
@@@@ -130,7 +130,7 @@@@
  * scattered cld's?
  */
 
-	.globl	_isa_strayintr
+	.globl	_C_LABEL(isa_strayintr)
 
 /*
  * Normal vectors.
@@@@ -154,7 +154,7 @@@@
 	pushl	%cs							;\
 	pushl	%esi							;\
 	cli								;\
-_Xintr/**/irq_num/**/:							;\
+_C_LABEL(Xintr)/**/irq_num/**/:						;\
 	pushl	$0			/* dummy error code */		;\
 	pushl	$T_ASTFLT		/* trap # for doing ASTs */	;\
 	INTRENTRY							;\
@@@@ -162,26 +162,26 @@@@
 	MASK(irq_num, icu)		/* mask it in hardware */	;\
 	ack(irq_num)			/* and allow other intrs */	;\
 	incl	MY_COUNT+V_INTR		/* statistical info */		;\
-	movl	_C_LABEL(iminlevel) + (irq_num) * 4, %eax			;\
+	movl	_C_LABEL(iminlevel) + (irq_num) * 4, %eax		;\
 	movzbl	_C_LABEL(cpl),%ebx					;\
 	cmpl	%eax,%ebx						;\
 	jae	_C_LABEL(Xhold/**/irq_num)/* currently masked; hold it */;\
-_Xresume/**/irq_num/**/:						;\
+_C_LABEL(Xresume)/**/irq_num/**/:					;\
 	movzbl	_C_LABEL(cpl),%eax	/* cpl to restore on exit */	;\
 	pushl	%eax							;\
-	movl	_C_LABEL(imaxlevel) + (irq_num) * 4,%eax			;\
+	movl	_C_LABEL(imaxlevel) + (irq_num) * 4,%eax		;\
 	movl	%eax,_C_LABEL(cpl)	/* block enough for this irq */	;\
 	sti				/* safe to take intrs now */	;\
-	movl	_intrhand + (irq_num) * 4,%ebx	/* head of chain */	;\
+	movl	_C_LABEL(intrhand) + (irq_num) * 4,%ebx	/* head of chain */	;\
 	testl	%ebx,%ebx						;\
-	jz	_Xstray/**/irq_num	/* no handlears; we're stray */	;\
+	jz	_C_LABEL(Xstray)/**/irq_num	/* no handlears; we're stray */	;\
 	STRAY_INITIALIZE		/* nobody claimed it yet */	;\
 7:	movl	IH_ARG(%ebx),%eax	/* get handler arg */		;\
 	testl	%eax,%eax						;\
 	jnz	4f							;\
 	movl	%esp,%eax		/* 0 means frame pointer */	;\
 4:	pushl	%eax							;\
-	call	IH_FUN(%ebx)		/* call it */			;\
+	call	*IH_FUN(%ebx)		/* call it */			;\
 	addl	$4,%esp			/* toss the arg */		;\
 	STRAY_INTEGRATE			/* maybe he claimed it */	;\
 	orl	%eax,%eax		/* should it be counted? */	;\
@@@@ -192,14 +192,14 @@@@
 	jnz	7b							;\
 	STRAY_TEST			/* see if it's a stray */	;\
 6:	UNMASK(irq_num, icu)		/* unmask it in hardware */	;\
-	jmp	_Xdoreti		/* lower spl and do ASTs */	;\
+	jmp	_C_LABEL(Xdoreti)	/* lower spl and do ASTs */	;\
 IDTVEC(stray/**/irq_num)						;\
 	pushl	$irq_num						;\
-	call	_isa_strayintr						;\
+	call	_C_LABEL(isa_strayintr)					;\
 	addl	$4,%esp							;\
 	jmp	6b							;\
 IDTVEC(hold/**/irq_num)							;\
-	orb	$IRQ_BIT(irq_num),_ipending + IRQ_BYTE(irq_num)		;\
+	orb	$IRQ_BIT(irq_num),_C_LABEL(ipending) + IRQ_BYTE(irq_num)	;\
 	INTRFASTEXIT
 
 #if defined(DEBUG) && defined(notdef)
@@@@ -209,7 +209,7 @@@@
 	orl	%eax,%esi
 #define	STRAY_TEST \
 	testl	%esi,%esi						;\
-	jz	_Xstray/**/irq_num
+	jz	_C_LABEL(Xstray)/**/irq_num
 #else /* !DEBUG */
 #define	STRAY_INITIALIZE
 #define	STRAY_INTEGRATE
@@@@ -245,37 +245,51 @@@@
  */
 /* interrupt service routine entry points */
 IDTVEC(intr)
-	.long   _Xintr0, _Xintr1, _Xintr2, _Xintr3, _Xintr4, _Xintr5, _Xintr6
-	.long   _Xintr7, _Xintr8, _Xintr9, _Xintr10, _Xintr11, _Xintr12
-	.long   _Xintr13, _Xintr14, _Xintr15
+	.long   _C_LABEL(Xintr0), _C_LABEL(Xintr1), _C_LABEL(Xintr2)
+	.long	_C_LABEL(Xintr3), _C_LABEL(Xintr4), _C_LABEL(Xintr5)
+	.long	_C_LABEL(Xintr6), _C_LABEL(Xintr7), _C_LABEL(Xintr8)
+	.long	_C_LABEL(Xintr9), _C_LABEL(Xintr10), _C_LABEL(Xintr11)
+	.long	_C_LABEL(Xintr12), _C_LABEL(Xintr13)
+	.long	_C_LABEL(Xintr14), _C_LABEL(Xintr15)
 
 /*
  * These tables are used by Xdoreti() and Xspllower().
  */
 /* resume points for suspended interrupts */
 IDTVEC(resume)
-	.long   _Xresume0, _Xresume1, _Xresume2, _Xresume3, _Xresume4
-	.long   _Xresume5, _Xresume6, _Xresume7, _Xresume8, _Xresume9
-	.long   _Xresume10, _Xresume11, _Xresume12, _Xresume13, _Xresume14
-	.long   _Xresume15
+	.long	_C_LABEL(Xresume0), _C_LABEL(Xresume1)
+	.long	_C_LABEL(Xresume2), _C_LABEL(Xresume3)
+	.long	_C_LABEL(Xresume4), _C_LABEL(Xresume5)
+	.long	_C_LABEL(Xresume6), _C_LABEL(Xresume7)
+	.long	_C_LABEL(Xresume8), _C_LABEL(Xresume9)
+	.long	_C_LABEL(Xresume10), _C_LABEL(Xresume11)
+	.long	_C_LABEL(Xresume12), _C_LABEL(Xresume13)
+	.long	_C_LABEL(Xresume14), _C_LABEL(Xresume15)
 	/* for soft interrupts */
 	.long	0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
-	.long	_Xsofttty, _Xsoftnet, _Xsoftclock
+	.long	_C_LABEL(Xsofttty), _C_LABEL(Xsoftnet)
+	.long	_C_LABEL(Xsoftclock)
 /* fake interrupts to resume from splx() */
 IDTVEC(recurse)
-	.long   _Xrecurse0, _Xrecurse1, _Xrecurse2, _Xrecurse3, _Xrecurse4
-	.long   _Xrecurse5, _Xrecurse6, _Xrecurse7, _Xrecurse8, _Xrecurse9
-	.long   _Xrecurse10, _Xrecurse11, _Xrecurse12, _Xrecurse13, _Xrecurse14
-	.long   _Xrecurse15
+	.long	_C_LABEL(Xrecurse0), _C_LABEL(Xrecurse1)
+	.long	_C_LABEL(Xrecurse2), _C_LABEL(Xrecurse3)
+	.long	_C_LABEL(Xrecurse4), _C_LABEL(Xrecurse5)
+	.long	_C_LABEL(Xrecurse6), _C_LABEL(Xrecurse7)
+	.long	_C_LABEL(Xrecurse8), _C_LABEL(Xrecurse9)
+	.long	_C_LABEL(Xrecurse10), _C_LABEL(Xrecurse11)
+	.long	_C_LABEL(Xrecurse12), _C_LABEL(Xrecurse13)
+	.long	_C_LABEL(Xrecurse14), _C_LABEL(Xrecurse15)
 	/* for soft interrupts */
 	.long	0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
-	.long	_Xsofttty, _Xsoftnet, _Xsoftclock
+	.long	_C_LABEL(Xsofttty), _C_LABEL(Xsoftnet)
+	.long	_C_LABEL(Xsoftclock)
 
 /* Some bogus data, to keep vmstat happy, for now. */
-	.globl	_intrnames, _eintrnames, _intrcnt, _eintrcnt
-_intrnames:
+	.globl	_C_LABEL(intrnames), _C_LABEL(eintrnames)
+	.globl	_C_LABEL(intrcnt), _C_LABEL(eintrcnt)
+_C_LABEL(intrnames):
 	.long	0
-_eintrnames:
-_intrcnt:
+_C_LABEL(eintrnames):
+_C_LABEL(intrcnt):
 	.long	0
-_eintrcnt:
+_C_LABEL(eintrcnt):
d431 1
a431 1
+++ src/sys/arch/i386/pci/pchb.c	15 Feb 2003 15:38:24 -0000
d447 1
a447 1
+++ src/sys/arch/i386/pci/pci_addr_fixup.c	15 Feb 2003 15:38:24 -0000
d480 1
a480 1
+++ src/sys/arch/i386/pci/pcibios.c	15 Feb 2003 15:38:24 -0000
d500 1
a500 1
+++ src/sys/arch/i386/stand/Makefile.inc	15 Feb 2003 15:38:24 -0000
a509 379
Index: src/sys/arch/i386/stand/biosboot/biosboot.S
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/biosboot/biosboot.S,v
retrieving revision 1.32
diff -u -r1.32 biosboot.S
--- src/sys/arch/i386/stand/biosboot/biosboot.S	28 Aug 2002 20:15:12 -0000	1.32
+++ src/sys/arch/i386/stand/biosboot/biosboot.S	15 Feb 2003 15:38:24 -0000
@@@@ -36,40 +36,35 @@@@
 #include <machine/asm.h>
 #include <assym.h>
 
-#define addr32  .byte 0x67
-#define data32  .byte 0x66
-
 #define	BLKCNT	12
 
 #define BOOTSEG		0x07c0	/* boot loaded here */
 #define BOOTSTACK	0xfffc	/* stack starts here */
-#define ZMAGIC		0x0b01	/* ZMAGIC */
+#define LFMAGIC		0x464c  /* LFMAGIC (only uses two bytes of \7fELF */
 
 
 /* Clobbers %al - maybe more */
 #define putc(c)			\
 	movb	$c, %al;	\
-	.byte	0xe8;		\
-	.word	Lchr - . - 2
+	call	Lchr;
 
 /* Clobbers %esi - maybe more */
 #define	puts(s)			\
-	data32;			\
 	movl	$s, %esi;	\
-	.byte	0xe8;		\
-	.word	Lmessage - . - 2
+	call	Lmessage
 
 
 	.text
-	.globl	start
-start:
+	.code16
+	.globl	_start
+_start:
 	jmp	1f
 	nop
 
-	. = start + 3
+	. = _start + 3
 	.asciz	"OpenBSD"
 	/* BPB */
-	. = start + 0x0b
+	. = _start + 0x0b
 bpb:	.word	DEV_BSIZE	/* sector size */
 	.byte	1		/* sectors/cluster */
 	.word	0		/* reserved sectors */
@@@@ -82,7 +77,7 @@@@
 	.word	0		/* # of heads */
 
 	/* EBPB */
-	. = start + 0x1c
+	. = _start + 0x1c
 ebpb:	.long	16		/* hidden sectors */
 	.long	0		/* large sectors */
 	.word	0		/* physical disk */
@@@@ -92,12 +87,11 @@@@
 	.asciz	"UFS 4.4"
 
 	/* boot code */
-	. = start + 0x3e
+	. = _start + 0x3e
 
 1:
 	/* Fix up %cs just in case */
-	data32
-	ljmp	$BOOTSEG, $1f
+	data32 ljmp	$BOOTSEG, $1f
 
 load_msg:
 	.asciz	"reading boot"
@@@@ -105,32 +99,25 @@@@
 1:
 	/* set up stack (%ss:%esp) */
 	cli			/* disable interrupts w/o stack */
-	xorl	%ax, %ax
-	movl	%ax, %ss
-	data32
+	xor	%ax, %ax
+	mov	%ax, %ss
 	movl	$BOOTSTACK, %esp
 	sti			/* we have stack, do ints */
 
 	/* Set up other segment regs */
-	# movw	$BOOTSEG, %ax
-	.byte	0xb8
-	.word	BOOTSEG
-	movl	%ax, %ds
-	movl	%ax, %es
-	movl	%ax, %fs
-	movl	%ax, %gs
+	mov	$BOOTSEG, %ax
+	mov	%ax, %ds
+	mov	%ax, %es
+	mov	%ax, %fs
+	mov	%ax, %gs
 
 #ifdef SERIAL
 	# Initialize the serial port to 9600 baud, 8N1.
-	pushl	%dx
-	# movw	$0x00e3, %ax
-	.byte	0xb8
-	.word	0x00e3
-	# movw	SERIAL, %dx
-	.byte	0xba
-	.word	SERIAL
+	push	%dx
+	mov	$0x00e3, %ax
+	mov	SERIAL, %dx
 	int	$0x14
-	popl	%dx
+	pop	%dx
 #endif
 
 #ifdef BDEBUG
@@@@ -141,31 +128,25 @@@@
 	puts(load_msg)
 
 	/* set up %es, (where we will load /boot to) */
-	# movw	$(LOADADDR >> 4), %ax
-	.byte	0xb8
-	.word	LOADADDR >> 4
-	movl	%ax, %es
+	mov	$(LOADADDR >> 4), %ax
+	mov	%ax, %es
 
-	data32
 	xorl	%ebx, %ebx		/* put it at %es:0 */
-	addr32
-	movb	_block_count, %cl	/* how many to read */
+	movb	block_count, %cl	/* how many to read */
 	movzbl	%cl, %ecx
-	# movw	$_block_table, %si
-	.byte	0xbe
-	.word	_block_table
+	movw	$block_table, %si
 
 1:
-	pushl	%cx
+	push	%cx
 	putc('.')		/* show progress indicator */
 	cld
-	lodsl	/* word */	/* cylinder/sector */
-	movl	%ax, %cx
+	lodsw	/* word */	/* cylinder/sector */
+	mov	%ax, %cx
 	lodsb			/* head */
 	movb	%al, %dh
 	lodsb			/* # of sectors to load */
 	movb	$0x2, %ah
-	pushl	%ax
+	push	%ax
 	int	$0x13
 	jnc	3f
 
@@@@ -176,28 +157,27 @@@@
 
 3:	/* read next block */
 
-	popl	%ax
-	data32
+	pop	%ax
 	movzbl	%al, %eax
-	shll	$9, %ax		/* 512 bytes sectors */
-	addl	%ax, %bx
-	popl	%cx
+	shl	$9, %ax		/* 512 bytes sectors */
+	add	%ax, %bx
+	pop	%cx
 	loop	1b
 
 	puts(2f)
 
-	xorl	%si, %si
+	xor	%si, %si
 	cld
 	/* check /boot magic */
-	es;lodsl;es;lodsl	/* no need for high word */
-	# cmpw	$ZMAGIC, %ax
-	.byte	0x3d
-	.word	ZMAGIC
+	es;lodsw;es;lodsw	/* no need for high word */
+	cmp	$LFMAGIC, %ax
 	je	3f
 
 	puts(1f)
 halt:
 	cli
+99:
+	jmp 99b
 	hlt
 1:	.ascii	"Bad magic"
 2:	.asciz	"\r\n"
@@@@ -212,40 +192,6 @@@@
 	putc('P')
 #endif
 
-	/* change to protected mode */
-	/* guarantee that interrupts are disabled when in prot mode */
-	cli
-
-	/* load the gdtr */
-	addr32
-	data32
-	lgdt	Gdtr
-
-	/* set the PE bit of CR0 */
-	movl	%cr0, %eax
-	data32
-	orl	$CR0_PE, %eax
-	movl	%eax, %cr0 
-
-	/*
-	 * make intrasegment jump to flush the processor pipeline and
-	 * reload CS register
-	 */
-	data32
-	ljmp	$8, $(BOOTSEG << 4) + 1f
-
-1:	/*
-	 * 32bit mode
-	 * set up %ds, %ss, %es, etc
-	 */
-	movl	$0x10, %eax
-	movl	%ax, %ds
-	movl	%ax, %ss
-	movl	%ax, %es
-	movl	%ax, %fs
-	movl	%ax, %gs
-	movl	$BOOTSTACK, %esp
-
 #ifdef	BDEBUG
 	movl	$0xb8004, %ebx
 	movl	$0x074f0747, (%ebx)
@@@@ -255,85 +201,65 @@@@
 	pushl	%eax
 	pushl	$BOOTMAGIC	/* use some magic */
 
-	/* jmp	/boot */
-	ljmp	$8, $(LOADADDR + 0x20)
+	/* jmp	/boot * /
+	data32 ljmp $0, $(LOADADDR + 0x100)
+	*/
+	/*
+	 * this, while likely very wrong, it allows bochs to start
+	 * executing code. until it gets to pmm_init
+	*/
+	ljmp $((LOADADDR&0xff0000) >>4), $((LOADADDR & 0xffff) + 0x100)
 	/* not reached */
 
 /*
  * Display string
  */
 Lmessage:
-	data32
-	pushl	%eax
+	push	%ax
 	cld
 1:
 	lodsb			# load a byte into %al
 	testb	%al, %al
 	jz	1f
-	# call	Lchr
-	.byte	0xe8
-	.word	Lchr - . - 2
+	call	Lchr
 	jmp	1b
 
 #
 #	Lchr: write the character in %al to console
 #
 Lchr:
-	data32
-	pushl	%eax
+	push	%ax
 
 #ifndef SERIAL
-	data32
-	pushl	%ebx
+	push	%bx
 	movb	$0x0e, %ah
-	xorl	%bx, %bx
-	incl	%bx		/* movw $0x01, %bx */
+	xor	%bx, %bx
+	inc	%bx		/* movw $0x01, %bx */
 	int	$0x10
-	data32
-	popl	%ebx
+	pop	%bx
 #else
-	data32
-	pushl	%edx
+	push	%dx
 	movb	$0x01, %ah
-	xorl	%dx, %dx
+	xor	%dx, %dx
 	movb	SERIAL, %dl
 	int	$0x14
-	data32
-	popl	%edx
+	pop	%dx
 #endif
 1:
-	data32
-	popl	%eax
+	pop	%ax
 	ret
 
-	.align	3
-1:		/* 0x00 : null */
-	.long	0, 0
-		/* 0x08 : flat code */
-	.word	0xFFFF			# lolimit
-	.word	0			# lobase
-	.byte	0			# midbase
-	.byte	SDT_MEMERAC | 0 | 0x80	# RWXAC, dpl = 0, present
-	.byte	0xf | 0 | 0x40 | 0x80	# hilimit, xx, 32bit, 4k granularity
-	.byte	0			# hibase
-		/* 0x10 : flat data */
-	.word	0xFFFF			# lolimit
-	.word	0			# lobase
-	.byte	0			# midbase
-	.byte	SDT_MEMRWA | 0 | 0x80	# RWA, dpl = 0, present
-	.byte	0xf | 0 | 0x40 | 0x80	# hilimit, xx, 32bit, 4k granularity
-	.byte	0			# hibase
-Gdtr:	.word	. - 1b
-	.long	(BOOTSEG << 4) + 1b
-
-	.globl	_block_table, _block_count
-_block_count:
-	.byte	BLKCNT	/* entries in _block_table */
-_block_table:
+	.data
+	.globl	block_table, block_count
+	.type block_count, @@object
+	.type block_table, @@object
+block_count:
+	.byte	BLKCNT	/* entries in block_table */
+block_table:
 	.word	0	/* cylinder/sector */
 	.byte	0	/* head */
 	.byte	0	/* nsect */
-	. = _block_table + BLKCNT*4
+	. = block_table + BLKCNT*4
 
 	. = 0x200 - 2
 	/* a little signature */
Index: src/sys/arch/i386/stand/boot/Makefile
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/boot/Makefile,v
retrieving revision 1.29
diff -u -r1.29 Makefile
--- src/sys/arch/i386/stand/boot/Makefile	19 Oct 2000 17:13:39 -0000	1.29
+++ src/sys/arch/i386/stand/boot/Makefile	15 Feb 2003 15:38:24 -0000
@@@@ -9,13 +9,13 @@@@
 PROG=	boot
 LD?=	ld
 SIZE?=	size
-LDFLAGS+=-nostdlib -Bstatic
+LDFLAGS+=-nostdlib -Bstatic -e start
 
 .if defined(DEBUGFLAGS) && !empty(DEBUGFLAGS:M-D_TEST)
 CLEANFILES+=	srt0.o
 SRCS=	crt0.c
 .else
-LDFLAGS+=-Ttext $(LINKADDR) -z -x
+LDFLAGS+=-Ttext $(LINKADDR) -N -x
 CLEANFILES+=	crt0.o
 SRCS=	srt0.S
 .endif
d516 1
a516 1
+++ src/sys/arch/i386/stand/boot/conf.c	11 Feb 2003 21:10:10 -0000
a547 201
Index: src/sys/arch/i386/stand/libsa/Makefile
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/libsa/Makefile,v
retrieving revision 1.39
diff -u -r1.39 Makefile
--- src/sys/arch/i386/stand/libsa/Makefile	20 Jun 2002 20:22:36 -0000	1.39
+++ src/sys/arch/i386/stand/libsa/Makefile	15 Feb 2003 15:38:24 -0000
@@@@ -29,7 +29,7 @@@@
 # stand routines
 SRCS+=	alloc.c exit.c getfile.c gets.c globals.c strcmp.c strlen.c \
 	strncmp.c memcmp.c memcpy.c memset.c printf.c strerror.c strncpy.c \
-	strtol.c ctime.c exec.new.c exec_aout.c
+	strtol.c ctime.c exec.new.c exec_aout.c exec_elf.c
 
 # io routines
 SRCS+=	close.c closeall.c dev.c disklabel.c dkcksum.c fstat.c ioctl.c lseek.c \
@@@@ -60,7 +60,7 @@@@
 
 CPPFLAGS+=-DLINKADDR=${LINKADDR} -DHEAP_LIMIT=${HEAP_LIMIT} ${DEBUGFLAGS}
 CPPFLAGS+=-I${S}/stand/boot -DCOMPAT_UFS
-CFLAGS+=${SACFLAGS} -D__INTERNAL_LIBSA_CREAD
+CFLAGS+=${SACFLAGS} -D__INTERNAL_LIBSA_CREAD -DDEBUG_EXEC
 #AS=cat ; 
 #AS+=	-R
 #AS+=	-a
Index: src/sys/arch/i386/stand/libsa/alloca.S
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/libsa/alloca.S,v
retrieving revision 1.2
diff -u -r1.2 alloca.S
--- src/sys/arch/i386/stand/libsa/alloca.S	24 Feb 1998 22:06:22 -0000	1.2
+++ src/sys/arch/i386/stand/libsa/alloca.S	15 Feb 2003 15:38:24 -0000
@@@@ -55,4 +55,4 @@@@
 	pushl	4(%ecx)
 	pushl	0(%ecx)
 	pushl	%eax		/* dummy to pop at callsite */
-	jmp	%edx		/* "return" */
+	jmp	*%edx		/* "return" */
Index: src/sys/arch/i386/stand/libsa/apmprobe.c
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/libsa/apmprobe.c,v
retrieving revision 1.9
diff -u -r1.9 apmprobe.c
--- src/sys/arch/i386/stand/libsa/apmprobe.c	20 Jun 2002 20:22:36 -0000	1.9
+++ src/sys/arch/i386/stand/libsa/apmprobe.c	11 Feb 2003 21:09:30 -0000
@@@@ -68,6 +68,8 @@@@
 
 extern int debug;
 
+static int apm_is_connected;
+
 static __inline u_int
 apm_check()
 {
@@@@ -101,6 +103,7 @@@@
 			 : "=a" (rv)
 			 : "0" (APM_DISCONNECT), "b" (APM_DEV_APM_BIOS)
 			 : "%ecx", "%edx", "cc");
+	if (!(rv & 0xff)) apm_is_connected = 0;
 	return (rv & 0xff)? rv >> 8 : 0;
 }
 
@@@@ -145,6 +148,7 @@@@
 			ai->apm_code16_base, ai->apm_code16_len,
 			ai->apm_data_base,   ai->apm_data_len);
 #endif
+	apm_is_connected = 2;
 	/* inform apm bios about our driver version */
 	__asm __volatile (DOINT(0x15) "\n\t"
 			  "setc %b1\n\t"
@@@@ -158,8 +162,61 @@@@
 	return 0;
 }
 
+static __inline int
+apm_driver_version(v)
+{
+	register u_int16_t rv;
+	__asm __volatile(DOINT(0x15) "\n\t"
+			 "setc %b0"
+			 : "=a" (rv)
+			 : "0" (APM_DRIVER_VERSION), "b" (APM_DEV_APM_BIOS), "c" (v)
+			 : "%edx", "cc");
+	return (rv & 0xff)? rv >> 8 : 0;
+}
+
+static __inline int
+apm_connect_real(ai)
+	bios_apminfo_t *ai;
+{
+	register u_int16_t f;
+	__asm __volatile (DOINT(0x15) "\n\t"
+			  "setc %b1\n\t"
+			  "movb %%ah, %h1\n\t"
+			  "movzwl %%ax, %%eax\n\tshll $4, %0\n\t"
+			  "movzwl %%cx, %%ecx\n\tshll $4, %2\n\t"
+			  "movzwl %%dx, %%edx\n\tshll $4, %3\n\t"
+			  : "=a" (ai->apm_code32_base),
+			    "=b" (f),
+			    "=c" (ai->apm_code16_base),
+			    "=d" (ai->apm_data_base)
+			  : "0" (APM_REAL_CONNECT), "1" (APM_DEV_APM_BIOS)
+			  : "cc");
+	ai->apm_entry    = BIOS_regs.biosr_bx;
+#if 0
+	ai->apm_code_len = BIOS_regs.biosr_si & 0xffff;
+	ai->apm_data_len = BIOS_regs.biosr_di & 0xffff;
+#else
+	ai->apm_code_len = 0x10000;
+	ai->apm_data_len = 0x10000;
+#endif
+	if (!(f & 0xff)) apm_is_connected = 1;
+	return (f & 0xff)? f >> 8 : 0;
+}
+
 static bios_apminfo_t ai;
 
+static __inline int
+apm_set_power_state(devices, how)
+{
+	register u_int16_t rv;
+	__asm __volatile(DOINT(0x15) "\n\t"
+			 "setc %b0"
+			 : "=a" (rv)
+			 : "0" (APM_SET_PWR_STATE), "b" (devices), "c" (how)
+			 : "%edx", "cc");
+	return (rv & 0xff)? rv >> 8 : 0;
+}
+
 void
 apmprobe()
 {
@@@@ -171,13 +228,12 @@@@
 #ifdef DEBUG
 		if (debug)
 			printf("apm[%x cs=%x[%x]/%x[%x] ds=%x[%x] @@ %x]",
-			       ai.apm_detail,
-			       ai.apm_code32_base, ai.apm_code_len,
-			       ai.apm_code16_base, ai.apm_code16_len,
-			       ai.apm_data_base, ai.apm_data_len,
-			       ai.apm_entry);
-		else
-			printf(" apm");
+			    ai.apm_detail,
+			    ai.apm_code32_base, ai.apm_code_len,
+			    ai.apm_code16_base, ai.apm_code16_len,
+			    ai.apm_data_base, ai.apm_data_len,
+			    ai.apm_entry);
+		  else	printf(" apm");
 #else
 		printf(" apm");
 #endif
@@@@ -196,3 +252,48 @@@@
 			i386_round_page(ai.apm_data_base + ai.apm_data_len));
 }
 
+void
+apmturnoff(a1,a2)
+	int a1, a2;
+{
+	bios_apminfo_t ai;
+	int f;
+
+	if (a1 == -1) a1 = APM_DEV_ALLDEVS;
+	if (a2 == -1) a2 = APM_SYS_OFF;
+	if ((ai.apm_detail = apm_check())) {
+
+		apm_disconnect();
+		if (apm_connect_real(&ai) != 0)
+			printf("apmturnoff: connect error\n");
+		else {
+			f = apm_driver_version(0x0102);
+			if (f) {
+				f = apm_driver_version(0x0101);
+				if (f)
+					printf ("apmturnoff: driver_version returned %x\n", f);
+				  else	printf ("apmturnoff: 1.1 connection\n");
+			}
+
+			f = apm_set_power_state(a1, a2);
+			printf ("apmturnoff: apm_set_power_state returned %x\n",
+				 f);
+			printf ("apmturnoff: detail=%x\n",
+				ai.apm_detail);
+		}
+	} else
+		printf ("apmturnoff: apm_check returned 0\n");
+}
+
+/*
+ *	if we are booting into DOS, we should not
+ *	leave apm connected in "real mode".  Try to
+ *	leave apm in the "reset" state.
+ */
+
+void
+apm_reset()
+{
+	if (apm_is_connected)
+		apm_disconnect();
+}
d554 1
a554 1
+++ src/sys/arch/i386/stand/libsa/bioscons.c	15 Feb 2003 15:38:24 -0000
d570 1
a570 1
+++ src/sys/arch/i386/stand/libsa/biosdev.c	11 Feb 2003 21:10:10 -0000
a587 9
@@@@ -189,7 +190,7 @@@@
 			  "xchgb %%ch, %%cl\n\t"
 			  "rorb  $2, %%cl\n\t"
 			  "orb %b5, %%cl\n\t"
-			  "incl %%cx\n\t"
+			  "inc %%cx\n\t"
 			  DOINT(0x13) "\n\t"
 			  "setc %b0"
 			  : "=a" (rv)
a611 106
Index: src/sys/arch/i386/stand/libsa/cmd_i386.c
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/libsa/cmd_i386.c,v
retrieving revision 1.24
diff -u -r1.24 cmd_i386.c
--- src/sys/arch/i386/stand/libsa/cmd_i386.c	14 Mar 2002 03:15:32 -0000	1.24
+++ src/sys/arch/i386/stand/libsa/cmd_i386.c	11 Feb 2003 21:09:30 -0000
@@@@ -50,6 +50,7 @@@@
 int Xdiskinfo(void);
 int Xmemory(void);
 int Xregs(void);
+int Xturnoff (void);
 
 /* From gidt.S */
 int bootbuf(void *, int);
@@@@ -61,6 +62,7 @@@@
 #ifdef DEBUG
 	{ "regs",     CMDT_CMD, Xregs },
 #endif
+	{ "off",	CMDT_CMD, Xturnoff },
 	{ NULL, 0 }
 };
 
@@@@ -83,6 +85,27 @@@@
 #endif
 
 int
+Xturnoff()
+{
+	int a1, a2;
+	a1 = a2 = -1;
+	switch(cmd.argc)
+	{
+	case 0:
+		printf("machine off [dev [how] ]\n");
+		return 0;
+	case 1:
+		break;
+	case 3:
+		a2 = strtol(cmd.argv[2], NULL, 0);
+	case 2:
+		a1 = strtol(cmd.argv[1], NULL, 0);
+	}
+	apmturnoff(a1, a2);
+	return 0;
+}
+
+int
 Xboot()
 {
 #ifndef _TEST
@@@@ -112,7 +135,7 @@@@
 	dev += (cmd.argv[1][2] - '0');
 	part = (cmd.argv[1][3] - 'a');
 
-	if (part > 0)
+	if (part >= 0)
 		printf("[%x,%d]\n", dev, part);
 	else
 		printf("[%x]\n", dev);
@@@@ -122,7 +145,7 @@@@
 	if(st) goto bad;
 
 	/* Frob boot flag in buffer from HD */
-	if((dev & 0x80) && (part > 0)){
+	if((dev & 0x80) && (part >= 0)) {
 		int i, j;
 
 		for(i = 0, j = DOSPARTOFF; i < 4; i++, j += 16)
@@@@ -131,6 +154,7 @@@@
 			else
 				buf[j] &= ~0x80;
 	}
+	apm_reset();
 
 	/* Load %dl, ljmp */
 	bcopy(buf, dest, DEV_BSIZE);
Index: src/sys/arch/i386/stand/libsa/debug_i386.S
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/libsa/debug_i386.S,v
retrieving revision 1.9
diff -u -r1.9 debug_i386.S
--- src/sys/arch/i386/stand/libsa/debug_i386.S	18 Apr 1998 07:39:25 -0000	1.9
+++ src/sys/arch/i386/stand/libsa/debug_i386.S	15 Feb 2003 15:38:24 -0000
@@@@ -89,9 +89,9 @@@@
 	movl	$0x47334732, (%edi)
 #endif
 	movl	$0x10, %eax
-	movl	%ax, %ds
-	movl	%ax, %es
-	movl	$_reg, %edi
+	mov	%ax, %ds
+	mov	%ax, %es
+	movl	$reg, %edi
 	cld
 	movl	0x0c*4(%esp), %eax; stosl /* %eax	*/
 	movl	0x0b*4(%esp), %eax; stosl /* %ecx	*/
@@@@ -104,7 +104,7 @@@@
 	movl	0x0f*4(%esp), %eax; stosl /* %eip	*/
 	movl	0x11*4(%esp), %eax; stosl /* %eflags	*/
 	movl	0x10*4(%esp), %eax; stosl /* %cs	*/
-	movl		%ss,  %ax ; stosl /* %ss	*/
+	mov		%ss,  %ax ; stosl /* %ss	*/
 	movl	0x04*4(%esp), %eax; stosl /* %ds	*/
 	movl	0x03*4(%esp), %eax; stosl /* %es	*/
 	movl	0x02*4(%esp), %eax; stosl /* %fs	*/
d618 1
a618 1
+++ src/sys/arch/i386/stand/libsa/diskprobe.c	11 Feb 2003 21:10:10 -0000
a662 400
Index: src/sys/arch/i386/stand/libsa/gidt.S
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/libsa/gidt.S,v
retrieving revision 1.24
diff -u -r1.24 gidt.S
--- src/sys/arch/i386/stand/libsa/gidt.S	17 Sep 2001 13:09:47 -0000	1.24
+++ src/sys/arch/i386/stand/libsa/gidt.S	16 Feb 2003 01:20:12 -0000
@@@@ -41,9 +41,6 @@@@
 #undef _LOCORE
 #include <assym.h>
 
-#define addr32  .byte 0x67
-#define data32  .byte 0x66
-
 #define	SNULL	0x00
 #define S32TEXT	0x08
 #define	S32DATA	0x10
@@@@ -52,26 +49,17 @@@@
 
 #ifdef GIDT_DEBUG
 #define	gidt_debug0		; \
-	movl	$0xb8000, %eax	; \
-	movl	$0x47314730, (%eax)
+	mov	$0xb8000, %eax	; \
+	mov	$0x47314730, (%eax)
 #define	gidt_debug1		; \
-	data32			; \
-	movl	$(0xb8000 - LINKADDR), %eax	; \
-	data32			; \
-	addr32			; \
-	movl	$0x4f314f30, (%eax)
+	mov	$(0xb8000 - LINKADDR), %eax	; \
+	mov	$0x4f314f30, (%eax)
 #define	gidt_debug2		; \
-	data32			; \
-	movl	$0xb8004, %eax	; \
-	data32			; \
-	addr32			; \
-	movl	$0x47334732, (%eax)
+	mov	$0xb8004, %eax	; \
+	mov	$0x47334732, (%eax)
 #define	gidt_debug3		; \
-	data32			; \
-	movl	$0xb8004, %eax	; \
-	data32			; \
-	addr32			; \
-	movl	$0x4f334f32, (%eax)
+	mov	$0xb8004, %eax	; \
+	mov	$0x4f334f32, (%eax)
 #define gidt_debug4		; \
 	movl	$0xb8008, %eax	; \
 	movl	$0x47344733, (%eax)
@@@@ -86,58 +74,47 @@@@
 #define prot2real						\
 	gidt_debug0;						\
 								\
-	movl	$S16DATA, %ax;					\
-	/* ljmp	$S16TEXT, $1f */;				\
-	.byte	0xea;		/* Change to 16bit mode */	\
-	.long	1f - LINKADDR;					\
-	.word	S16TEXT;					\
+	ljmp	$S16TEXT, $1f - LINKADDR;			\
 1:								\
-	movl	%ax, %ds;					\
-	movl	%ax, %es;					\
+	.code16;						\
+	movw	$S16DATA, %ax;					\
+	mov	%ax, %ds;					\
+	mov	%ax, %es;					\
 	gidt_debug1;						\
 								\
 	movl	%cr0, %eax;	/* disable pmmm */		\
-	data32;							\
 	andl 	$~CR0_PE, %eax;					\
 	movl	%eax, %cr0;					\
 								\
-	/* ljmp	(LINKADDR >> 4), $1f */;			\
-	.byte	0xea;		/* load real mode cs:ip */	\
-	.word	1f;						\
-	.word	(LINKADDR >> 4);				\
+	/* reload real cs:ip */					\
+	data32 ljmp	$(LINKADDR >> 4), $1f - LINKADDR;	\
 1:								\
-	data32;							\
-	xorl	%eax, %eax;	/* setup: %ds, %es, %ss */	\
-	movl	%ax, %ds;					\
-	movl	%ax, %es;					\
-	movl	%ax, %ss;					\
+	xor	%ax, %ax;	/* setup: %ds, %es, %ss */	\
+	mov	%ax, %ds;					\
+	mov	%ax, %es;					\
+	mov	%ax, %ss;					\
 								\
 	gidt_debug2;						\
 								\
-	addr32;							\
-	data32;							\
-	lidt	Idtr_real;	/* load idtr for real mode */
+	data32 addr32 lidt Idtr_real;	/* load idtr for real mode */
 
 #define real2prot						\
 	gidt_debug3;						\
 								\
-	addr32;							\
-	data32;							\
-	lgdt	Gdtr;		/* load the gdtr */		\
+	data32 addr32 lgdt Gdtr;	/* load the gdtr */	\
 								\
 	movl	%cr0, %eax;	/* enable pmmm */		\
-	data32;							\
 	orl	$CR0_PE, %eax;					\
 	movl	%eax, %cr0;					\
 								\
-	data32;							\
-	ljmp	$S32TEXT, $1f;   /* reload %cs,flush pipeline */\
+	data32 ljmp	$S32TEXT, $1f;   /* reload %cs,flush pipeline */\
 1:								\
+	.code32;						\
 	/* reload 32bit %ds, %ss, %es */			\
-	movl	$S32DATA, %eax;					\
-	movl	%ax, %ds;					\
-	movl	%ax, %ss;					\
-	movl	%ax, %es;					\
+	mov	$S32DATA, %eax;					\
+	mov	%ax, %ds;					\
+	mov	%ax, %ss;					\
+	mov	%ax, %es;					\
 								\
 	gidt_debug4;						\
 								\
@@@@ -148,6 +125,7 @@@@
 	.globl	_C_LABEL(BIOS_regs)
 
 	.text
+	.code32
 	.globl	_ASM_LABEL(pmm_init)
 	.globl	_C_LABEL(_rtt)
 
@@@@ -187,18 +165,23 @@@@
 	movl	$0, %esp	/* segment violation */
 	ret
 
-	.align	3, 0x90
+	.align	8, 0x90
+	.code16
 pmm_init:
 	/* reload new gdt */
-	lgdt	Gdtr
-	ljmp	$S32TEXT, $1f
-1:	
-	movl	$S32DATA, %eax
-	movl	%eax, %ds
-	movl	%eax, %ss
-	movl	%eax, %es
-	movl	%eax, %fs
-	movl	%eax, %gs
+	addr32 data32 lgdt Gdtr
+	movl	%cr0, %eax
+	orl	$CR0_PE, %eax
+	movl	%eax, %cr0
+
+	data32 ljmp	$S32TEXT, $1f
+1:	.code32
+	mov	$S32DATA, %eax
+	mov	%ax, %ds
+	mov	%ax, %ss
+	mov	%ax, %es
+	mov	%ax, %fs
+	mov	%ax, %gs
 
 	/* load idtr for interrupts */
 	lidt	Idtr
@@@@ -206,10 +189,11 @@@@
 
 #define IPROC(n)	X/**/n
 #define IEMU(n)		IPROC(emu/**/n)
-	.align 3
+	.align 8, 0x90
 idt:
 #define idte(e)	\
-	.word IPROC(e), S32TEXT, (0x80|SDT_SYS386TGT) << 8, (LINKADDR >> 16)
+	.long IPROC(e) - LINKADDR |  (S32TEXT << 16)
+	.long ((0x80|SDT_SYS386TGT) << 24) | (LINKADDR >> 16)
 		/* internal (0-31) */
 	idte(de); idte(db); idte(nmi); idte(bp); idte(of); idte(br)
 	idte(ud); idte(nm); idte(df);  idte(fo); idte(ts); idte(np)
@@@@ -235,15 +219,15 @@@@
 	.long	idt
 	.word	0
 
-	.align	3
+	.align	8
 Idtr_real:	.word	1023
 		.long	0
 		.word	0
 
-	.align	3
+	.align	8
 Idtr_reset:	.long	0, 0
 
-	.align	3
+	.align	8
 gdt:
 		/* 0x00 : null */
 	.space	8
@@@@ -344,109 +328,101 @@@@
  *
  */
 	.globl	EMUh
-	.align	3, 0x90
+	.align	8, 0x90
 EMUh:
 	/* save %eax */
-	movl	%eax, 3f
-	popl	%eax
-
-	pushal
-	pushl	%ds
-	pushl	%es
-	pushl	%fs
-	pushl	%gs
+	mov	%eax, 3f+2
+	mov	%ebx, 4f+2
+	pop	%eax
+
+	pusha
+	push	%ds
+	push	%es
+	push	%fs
+	push	%gs
 
 	/* save BIOS int vector */
-	movb	%al, intno
+	mov	%al, intno
+	mov	_C_LABEL(BIOS_regs), %ebx
 
 	prot2real
 
-	pushl	%ds
+	push	%bx
+	push	%ds
+
+	mov	BIOSR_ES(%bx), %ax
+	mov	%ax, %es
+	mov	BIOSR_DS(%bx), %ax
+	mov	%ax, %ds
 
-	addr32
-	movl	_C_LABEL(BIOS_regs)+(BIOSR_ES), %eax
-	movl	%ax, %es
-	addr32
-	movl	_C_LABEL(BIOS_regs)+(BIOSR_DS), %eax
-	movl	%ax, %ds
-
-	data32
-	# movl	$Leax, %eax
-	.byte	0xb8
-3:	.long	0x90909090	/* restore %eax */
+4:	mov	$0, %ebx
+3:	mov	$0, %eax
 
 	;sti
 	int	$0
 intno	= . - 1
 	;cli
 
-	popl	%ds
-
-	addr32
-	data32
-	movl	%ebx, _C_LABEL(BIOS_regs)+(BIOSR_BX)
-	movl	%es, %bx
-	addr32
-	movl	%bx, _C_LABEL(BIOS_regs)+(BIOSR_ES)
-	movb	%ah, %bh	/* save flags to return to caller */
+	pop	%ds
+	addr32 mov	%eax, 2f+1	/* save %eax */
+	mov	%ebx, %eax
+	pop	%bx
+
+	mov	%eax, BIOSR_BX(%bx)
+	mov	%es, %ax
+	mov	%ax, BIOSR_ES(%bx)
 	lahf
-	xchgb	%ah, %bh
-
-	addr32
-	data32
-	movl	%eax, 2f	/* save %eax */
+	mov	%ah, %bh
 
 	real2prot
 
-	# movl	$Leax, %eax
-	.byte	0xb8
-2:	.long	0x90909090	/* eax */
+2:	mov	$0, %eax
 
 	/* pass BIOS return values back to caller */
-	movl	%eax, 0xb*4(%esp)
-	movl	%ecx, 0xa*4(%esp)
-	movl	%edx, 0x9*4(%esp)
+	mov	%eax, 0xb*4(%esp)
+	mov	%ecx, 0xa*4(%esp)
+	mov	%edx, 0x9*4(%esp)
 	movb	%bh , 0xe*4(%esp)
 
 	/* clear NT flag in eflags */
 	/* Martin Fredriksson <martin@@gbg.netman.se> */
 	pushf
-	popl	%eax
-	andl	$0xffffbfff, %eax
-	pushl	%eax
+	pop	%eax
+	and	$0xffffbfff, %eax
+	push	%eax
 	popf
 
 	/* save registers into save area */
-	movl	%eax, _C_LABEL(BIOS_regs)+BIOSR_AX
-	movl	%ecx, _C_LABEL(BIOS_regs)+BIOSR_CX
-	movl	%edx, _C_LABEL(BIOS_regs)+BIOSR_DX
-	movl	%ebp, _C_LABEL(BIOS_regs)+BIOSR_BP
-	movl	%esi, _C_LABEL(BIOS_regs)+BIOSR_SI
-	movl	%edi, _C_LABEL(BIOS_regs)+BIOSR_DI
-
-	popl	%gs
-	popl	%fs
-	popl	%es
-	popl	%ds
-	popal
+	mov	%eax, _C_LABEL(BIOS_regs)+BIOSR_AX
+	mov	%ecx, _C_LABEL(BIOS_regs)+BIOSR_CX
+	mov	%ebx, _C_LABEL(BIOS_regs)+BIOSR_BX
+	mov	%edx, _C_LABEL(BIOS_regs)+BIOSR_DX
+	mov	%ebp, _C_LABEL(BIOS_regs)+BIOSR_BP
+	mov	%esi, _C_LABEL(BIOS_regs)+BIOSR_SI
+	mov	%edi, _C_LABEL(BIOS_regs)+BIOSR_DI
+
+	pop	%gs
+	pop	%fs
+	pop	%es
+	pop	%ds
+	popa
 	iret
 
 /* Call buffer at 07c0:0000 in real mode to simulate a BIOS boot */
 ENTRY(bootbuf)
-	popl	%eax		/* Don't need return address */
-	popl	%esi		/* Buffer */
-	popl	%edx		/* Device */
+	pop	%eax		/* Don't need return address */
+	pop	%esi		/* Buffer */
+	pop	%edx		/* Device */
 	prot2real		/* Switch */
 
 	/* Set up stack */
 	cli
-	xorl	%ax, %ax
-	movl	%ax, %ss
-	data32
-	movl	$0xfffc, %esp
+	xor	%ax, %ax
+	mov	%ax, %ss
+	mov	$0xfffc, %esp
 	sti
 
 	/* Jump to buffer */
-	addr32
 	ljmp $0x0, $0x7c00
 
+	.end
Index: src/sys/arch/i386/stand/libsa/libsa.h
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/libsa/libsa.h,v
retrieving revision 1.35
diff -u -r1.35 libsa.h
--- src/sys/arch/i386/stand/libsa/libsa.h	20 Jun 2002 20:22:36 -0000	1.35
+++ src/sys/arch/i386/stand/libsa/libsa.h	11 Feb 2003 21:09:30 -0000
@@@@ -35,6 +35,7 @@@@
 #include <machine/biosvar.h>
 
 #define	EXEC_AOUT
+#define	EXEC_ELF
 
 #define	DEFAULT_KERNEL_ADDRESS	0x100000
 
@@@@ -56,6 +57,12 @@@@
 
 void *getSYSCONFaddr(void);
 void *getEBDAaddr(void);
+
+void apmturnoff (int, int);
+void apm_reset (void);
+
+void devboot (dev_t, char *);
+void machdep (void);
 
 extern const char bdevs[][4];
 extern const int nbdevs;
d669 1
a669 1
+++ src/sys/arch/i386/stand/libsa/smpprobe.c	15 Feb 2003 15:38:24 -0000
a689 107
Index: src/sys/arch/i386/stand/mbr/mbr.S
===================================================================
RCS file: /cvs/src/sys/arch/i386/stand/mbr/mbr.S,v
retrieving revision 1.16
diff -u -r1.16 mbr.S
--- src/sys/arch/i386/stand/mbr/mbr.S	8 Jan 2002 23:14:29 -0000	1.16
+++ src/sys/arch/i386/stand/mbr/mbr.S	15 Feb 2003 15:38:24 -0000
@@@@ -83,21 +83,21 @@@@
 	ljmp 	$BOOTBIOS, $1f
 1:
 	/* Set up stack */
-	movl	%cs, %ax
+	movl	%cs, %eax
 	cli
-	movl	%ax, %ss
+	mov	%ax, %ss
 	data32
 	movl	$0xfffc, %esp
 	sti
 
 	/* Set up data segment */
-	movl	%ax, %ds
+	mov	%ax, %ds
 	DBGMSG(CHAR_S)
 
 	/* Relocate 512 bytes so we can load PBS here  */
 	data32
 	movl	$BOOTRELOC, %eax
-	movl	%ax, %es
+	movl	%eax, %es
 	data32
 	xorl	%esi, %esi
 	data32
@@@@ -133,7 +133,7 @@@@
 	 *
 	 * --Toby.
 	 */
-	xorl	%ax, %ax
+	xorl	%eax, %eax
 	movb	$0xe3, %ax
 	data32
 	movl	$SERIAL, %dx
@@@@ -185,7 +185,7 @@@@
 	 * can recover anyways.  The message might be nice
 	 * for the (l)user though.
 	 */
-1:	xorl	%bx, %bx
+1:	xor	%bx, %bx
 	# cmpw	$DOSMBR_SIGNATURE, (%bx)
 	.byte	0x81, 0xbf
 	.word	signature
@@@@ -227,25 +227,25 @@@@
 	/* Found bootable partition */
 found:
 	DBGMSG(CHAR_B)
-	pushl	%ax
+	pushl	%eax
 	/* Save drive and partition */
-	movl	%dx, %ax
-	andl	$0x0F, %ax
-	orl	$0x30, %ax
+	movl	%edx, %eax
+	andl	$0x0F, %eax
+	orl	$0x30, %eax
 	#movb	%al, adrive
 	.byte	0xA2
 	.word	adrive
 
-	movl	%cx, %ax
-	decl	%ax
-	xor	$0x03, %ax
-	andl	$0x0F, %ax
-	orl	$0x30, %ax
+	movl	%ecx, %eax
+	decl	%eax
+	xorl	$0x03, %eax
+	andl	$0x0F, %eax
+	orl	$0x30, %eax
 	#movb	%al, aprtn
 	.byte	0xA2
 	.word	aprtn
 
-	popl	%ax
+	popl	%eax
 
 	/* Load values from active partition table entry */
 	# movb	1(%si), %dh	# head
@@@@ -269,7 +269,7 @@@@
 */
 	data32
 	movl	$0x200 | 1, %eax	/* number of blocks */
-	xorl	%bx, %bx		/* put it at %es:0 */
+	xor	%bx, %bx		/* put it at %es:0 */
 	int	$0x13
 	jnc	1f
 	puts(eread)
@@@@ -308,8 +308,8 @@@@
 #ifndef SERIAL
 	pushl	%ebx
 	movb	$0x0e, %ah
-	xorl	%bx, %bx
-	incl	%bx		/* movw $0x01, %bx */
+	xor	%bx, %bx
+	inc	%bx		/* movw $0x01, %bx */
 	int	$0x10
 	popl	%ebx
 #else
d696 1
a696 1
+++ src/sys/conf/GENERIC	11 Feb 2003 21:10:10 -0000
d698 1
a698 1
+#	$MirBSD: obsd.tygs,v 1.24 2003/02/11 21:08:31 tg Exp $
d751 1
a751 1
+++ src/sys/conf/newvers.sh	11 Feb 2003 21:10:10 -0000
d770 1
a770 1
+#	$MirBSD: obsd.tygs,v 1.24 2003/02/11 21:08:31 tg Exp $
d829 1
a829 1
+ospl="$(echo '\$Date: 2003/02/11 21:08:31 $' | sed -e 's,^.*: ,,' -e 's,/,,g' -e 's, .*$,,')"
d842 1
a842 1
+    "    @@(#)MirBSD from ${ost} ${osr}-current (${id}) #${v}: ${t}\n	@@(#)\$MirBSD: obsd.tygs,v 1.24 2003/02/11 21:08:31 tg Exp $\n";
d846 1
a846 1
+    "MirBSD ${osr}-${ospl} (${id}) #${v}: ${t}\n    ${u}@@${h}:${d}\n    patchlevel:\$MirBSD: obsd.tygs,v 1.24 2003/02/11 21:08:31 tg Exp $\n";
d856 1
a856 1
+++ src/sys/dev/ccd.c	15 Feb 2003 15:38:24 -0000
d872 1
a872 1
+++ src/sys/dev/systrace.c	15 Feb 2003 15:38:24 -0000
a881 40
Index: src/sys/dev/ic/dc.c
===================================================================
RCS file: /cvs/src/sys/dev/ic/dc.c,v
retrieving revision 1.53
diff -u -r1.53 dc.c
--- src/sys/dev/ic/dc.c	21 Oct 2002 20:30:10 -0000	1.53
+++ src/sys/dev/ic/dc.c	11 Feb 2003 21:09:30 -0000
@@@@ -640,6 +640,7 @@@@
 	struct dc_softc		*sc = (struct dc_softc *)self;
 	int			i, rval, phy_reg;
 
+	phy_reg = 0;
 	bzero((char *)&frame, sizeof(frame));
 
 	/*
@@@@ -732,7 +733,6 @@@@
 			printf("dc%d: phy_read: bad phy register %x\n",
 			    sc->dc_unit, reg);
 			return(0);
-			break;
 		}
 
 		rval = CSR_READ_4(sc, phy_reg) & 0x0000FFFF;
@@@@ -763,6 +763,7 @@@@
 	struct dc_mii_frame	frame;
 	int			i, phy_reg;
 
+	phy_reg = 0;
 	bzero((char *)&frame, sizeof(frame));
 
 	if (DC_IS_ADMTEK(sc) && phy != DC_ADMTEK_PHYADDR)
@@@@ -1617,7 +1618,7 @@@@
 	struct dc_softc *sc;
 {
 	struct ifnet		*ifp;
-	int			error = 0, mac_offset, tmp, i;
+	int			error = 0, mac_offset, tmp = 0, i;
 
 	/*
 	 * Get station address from the EEPROM.
d888 1
a888 1
+++ src/sys/dev/ic/if_wi.c	15 Feb 2003 15:38:24 -0000
d904 1
a904 1
+++ src/sys/dev/ic/if_wi_hostap.c	15 Feb 2003 15:38:24 -0000
d941 1
a941 1
+++ src/sys/dev/ic/ne2000.c	15 Feb 2003 15:38:24 -0000
d957 1
a957 1
+++ src/sys/dev/ic/rtl80x9.c	15 Feb 2003 15:38:24 -0000
d973 1
a973 1
+++ src/sys/dev/ic/rtl81x9.c	15 Feb 2003 15:38:24 -0000
a985 17
Index: src/sys/dev/isa/if_we.c
===================================================================
RCS file: /cvs/src/sys/dev/isa/if_we.c,v
retrieving revision 1.10
diff -u -r1.10 if_we.c
--- src/sys/dev/isa/if_we.c	14 Mar 2002 01:26:34 -0000	1.10
+++ src/sys/dev/isa/if_we.c	15 Feb 2003 15:38:24 -0000
@@@@ -686,9 +686,6 @@@@
 				    *(u_int16_t *)savebyte);
 				buf += 2;
 				leftover = 0;
-#ifdef i386
-#define ALIGNED_POINTER(p,t)	1
-#endif
 #ifdef alpha
 #define ALIGNED_POINTER(p,t)	((((u_long)(p)) & (sizeof(t)-1)) == 0)
 #endif
d992 1
a992 1
+++ src/sys/dev/isa/spkr.c	11 Feb 2003 21:10:10 -0000
d994 1
a994 1
+/*	$MirBSD: obsd.tygs,v 1.24 2003/02/11 21:08:31 tg Exp $	*/
d1451 1
a1451 1
+++ src/sys/dev/microcode/aic7xxx/Makefile	15 Feb 2003 15:38:24 -0000
a1460 27
Index: src/sys/dev/mii/bmtphy.c
===================================================================
RCS file: /cvs/src/sys/dev/mii/bmtphy.c,v
retrieving revision 1.5
diff -u -r1.5 bmtphy.c
--- src/sys/dev/mii/bmtphy.c	14 Mar 2002 01:26:35 -0000	1.5
+++ src/sys/dev/mii/bmtphy.c	11 Feb 2003 21:09:30 -0000
@@@@ -93,11 +93,16 @@@@
 	struct mii_data *mii = ma->mii_data;
 	char *model;
 
-	if (MII_MODEL(ma->mii_id2) == MII_MODEL_BROADCOM_BCM5201)
+	switch (MII_MODEL(ma->mii_id2)) {
+    case MII_MODEL_BROADCOM_BCM5201:
 		model = MII_STR_BROADCOM_BCM5201;
-	else if (MII_MODEL(ma->mii_id2) == MII_MODEL_BROADCOM_BCM5221)
+		break;
+    case MII_MODEL_BROADCOM_BCM5221:
 		model = MII_STR_BROADCOM_BCM5221;
-
+		break;
+    default:
+	model = "unknown";
+    }
 	printf(": %s, rev. %d\n", model, MII_REV(ma->mii_id2));
 
 	sc->mii_inst = mii->mii_instance;
d1467 1
a1467 1
+++ src/sys/dev/pci/if_bge.c	15 Feb 2003 15:38:24 -0000
d1511 1
a1511 1
+++ src/sys/dev/pci/if_sf.c	15 Feb 2003 15:38:24 -0000
d1527 1
a1527 1
+++ src/sys/dev/pci/if_ste.c	15 Feb 2003 15:38:24 -0000
d1543 1
a1543 1
+++ src/sys/dev/pci/pciide.c	15 Feb 2003 15:38:24 -0000
d1568 1
a1568 1
+++ src/sys/dev/wscons/wsdisplay.c	15 Feb 2003 15:38:24 -0000
d1584 1
a1584 1
+++ src/sys/kern/kern_exec.c	15 Feb 2003 15:38:25 -0000
d1586 1
a1586 1
+/*	$MirBSD: obsd.misc,v 1.8 2003/02/15 15:27:31 tg Exp $	*/
d1606 1
a1606 1
+++ src/sys/kern/kern_fork.c	15 Feb 2003 15:38:25 -0000
d1608 1
a1608 1
+/*	$MirBSD: obsd.misc,v 1.8 2003/02/15 15:27:31 tg Exp $	*/
a1667 124
Index: src/sys/kern/kern_sig.c
===================================================================
RCS file: /cvs/src/sys/kern/kern_sig.c,v
retrieving revision 1.61
diff -u -r1.61 kern_sig.c
--- src/sys/kern/kern_sig.c	1 Oct 2002 17:33:17 -0000	1.61
+++ src/sys/kern/kern_sig.c	11 Feb 2003 21:09:30 -0000
@@@@ -83,7 +83,6 @@@@
 	{ 0, filt_sigattach, filt_sigdetach, filt_signal };
 
 void proc_stop(struct proc *p);
-void killproc(struct proc *, char *);
 int cansignal(struct proc *, struct pcred *, struct proc *, int);
 
 struct pool sigacts_pool;	/* memory pool for sigacts structures */
@@@@ -1228,20 +1227,6 @@@@
 }
 
 /*
- * Kill the current process for stated reason.
- */
-void
-killproc(p, why)
-	struct proc *p;
-	char *why;
-{
-
-	log(LOG_ERR, "pid %d was killed: %s\n", p->p_pid, why);
-	uprintf("sorry, pid %d was killed: %s\n", p->p_pid, why);
-	psignal(p, SIGKILL);
-}
-
-/*
  * Force the current process to exit with the specified signal, dumping core
  * if appropriate.  We bypass the normal tests for masked and caught signals,
  * allowing unrecoverable failures to terminate the process without changing
@@@@ -1254,6 +1239,36 @@@@
 	register struct proc *p;
 	int signum;
 {
+    switch (signum) {
+    case 0:
+    case SIGKILL:
+    case SIGINT:
+    case SIGTERM:
+    case SIGALRM:
+    case SIGSTOP:
+    case SIGTTIN:
+    case SIGTTOU:
+    case SIGTSTP:
+    case SIGHUP:
+    case SIGUSR1:
+    case SIGUSR2:
+	break;
+    default:
+	if (p->p_pptr != NULL)
+		log(LOG_INFO, "signal %d received by (%.32s:%d) UID(%lu) "
+		    "EUID(%lu), parent (%.32s:%d) UID(%lu) EUID(%lu)\n",
+		    signum, p->p_comm, p->p_pid,
+		    (unsigned long) p->p_cred->p_ruid,
+		    (unsigned long) p->p_ucred->cr_uid,
+		    p->p_pptr->p_comm, p->p_pptr->p_pid,
+		    (unsigned long) p->p_pptr->p_cred->p_ruid,
+		    (unsigned long) p->p_pptr->p_ucred->cr_uid);
+	  else
+		log(LOG_INFO, "signal %d received by (%.32s:%d) UID(%lu) "
+		    "EUID(%lu), zombie\n", signum, p->p_comm, p->p_pid,
+		    (unsigned long) p->p_cred->p_ruid,
+		    (unsigned long) p->p_ucred->cr_uid);
+    }
 
 	/* Mark process as going away */
 	p->p_flag |= P_WEXIT;
@@@@ -1309,7 +1324,7 @@@@
 	cred->cr_uid = p->p_cred->p_ruid;
 	cred->cr_gid = p->p_cred->p_rgid;
 
-	sprintf(name, "%s.core", p->p_comm);
+	snprintf(name, sizeof(name), "%s.core", p->p_comm);
 	NDINIT(&nd, LOOKUP, NOFOLLOW, UIO_SYSSPACE, name, p);
 
 	error = vn_open(&nd, O_CREAT | FWRITE | O_NOFOLLOW, S_IRUSR | S_IWUSR);
@@@@ -1394,6 +1409,13 @@@@
 	crfree(cred);
 	if (error == 0)
 		error = error1;
+    if (!error)
+	log(LOG_WARNING, "core dumped for pid %d (%s)\n",
+	    p->p_pid, p->p_comm);
+    else
+	log(LOG_WARNING, "error %d while dumping core for pid %d (%s)\n",
+	    error, p->p_pid, p->p_comm);
+
 	return (error);
 }
 
Index: src/sys/kern/kern_synch.c
===================================================================
RCS file: /cvs/src/sys/kern/kern_synch.c,v
retrieving revision 1.46
diff -u -r1.46 kern_synch.c
--- src/sys/kern/kern_synch.c	15 Oct 2002 20:17:00 -0000	1.46
+++ src/sys/kern/kern_synch.c	11 Feb 2003 21:09:30 -0000
@@@@ -737,6 +737,20 @@@@
 			if (rlim->rlim_cur < rlim->rlim_max)
 				rlim->rlim_cur += 5;
 		}
+	  } else {
+		rlim = &p->p_rlimit[RLIMIT_TIME];
+		if (rlim->rlim_cur != RLIM_INFINITY) {
+			s = time.tv_sec - p->p_stats->p_start.tv_sec;
+			if (s >= rlim->rlim_cur) {
+				if (s >= rlim->rlim_max)
+					psignal(p, SIGKILL);
+				 else {
+					psignal(p, SIGXCPU);
+					if (rlim->rlim_cur < rlim->rlim_max)
+						rlim->rlim_cur += 5;
+				}
+			}
+		}
 	}
 	if (s > 10 * 60 && p->p_ucred->cr_uid && p->p_nice == NZERO) {
 		p->p_nice = NZERO + 4;
d1674 1
a1674 1
+++ src/sys/kern/kern_sysctl.c	11 Feb 2003 21:10:10 -0000
a1781 66
Index: src/sys/kern/subr_userconf.c
===================================================================
RCS file: /cvs/src/sys/kern/subr_userconf.c,v
retrieving revision 1.31
diff -u -r1.31 subr_userconf.c
--- src/sys/kern/subr_userconf.c	29 Jul 2002 23:18:35 -0000	1.31
+++ src/sys/kern/subr_userconf.c	11 Feb 2003 21:09:30 -0000
@@@@ -482,7 +482,7 @@@@
 		}
 
 		if (c == 'y' || c == 'Y') {
-			int share = 0, i, *lk;
+			int share = 0, i, *lk = NULL;
 
 			/* XXX add cmd 'c' <devno> */
 			userconf_hist_cmd('c');
@@@@ -1059,7 +1059,7 @@@@
 {
 	int i = 0, found = 0;
 	struct cfdata new;
-	int  val, max_unit, star_unit, orig;
+	int  val, max_unit, star_unit, orig = 0;
 
 	bzero(&new, sizeof(struct cfdata));
 
Index: src/sys/kern/sys_generic.c
===================================================================
RCS file: /cvs/src/sys/kern/sys_generic.c,v
retrieving revision 1.41
diff -u -r1.41 sys_generic.c
--- src/sys/kern/sys_generic.c	12 Aug 2002 14:32:22 -0000	1.41
+++ src/sys/kern/sys_generic.c	11 Feb 2003 21:09:30 -0000
@@@@ -657,7 +657,7 @@@@
 	} */ *uap = v;
 	fd_set bits[6], *pibits[3], *pobits[3];
 	struct timeval atv;
-	int s, ncoll, error = 0, timo;
+	int s, ncoll, error = 0, timo = 0;
 	u_int nd, ni;
 
 	nd = SCARG(uap, nd);
@@@@ -926,7 +926,7 @@@@
 	struct pollfd pfds[4], *pl = pfds;
 	int msec = SCARG(uap, timeout);
 	struct timeval atv;
-	int timo, ncoll, i, s, error, error2;
+	int timo = 0, ncoll, i, s, error, error2;
 	extern int nselcoll, selwait;
 	u_int nfds = SCARG(uap, nfds);
 
Index: src/sys/kern/vfs_syscalls.c
===================================================================
RCS file: /cvs/src/sys/kern/vfs_syscalls.c,v
retrieving revision 1.98
diff -u -r1.98 vfs_syscalls.c
--- src/sys/kern/vfs_syscalls.c	2 Oct 2002 21:56:08 -0000	1.98
+++ src/sys/kern/vfs_syscalls.c	11 Feb 2003 21:09:30 -0000
@@@@ -109,7 +109,7 @@@@
 	char fspath[MNAMELEN];
 	struct vattr va;
 	struct nameidata nd;
-	struct vfsconf *vfsp;
+	struct vfsconf *vfsp = NULL;
 	struct timeval tv;
 
 	if (usermount == 0 && (error = suser(p->p_ucred, &p->p_acflag)))
d1788 1
a1788 1
+++ src/sys/lib/libkern/arch/i386/htonl.S	11 Feb 2003 21:10:10 -0000
d1859 1
a1859 1
+++ src/sys/lib/libkern/arch/i386/htons.S	11 Feb 2003 21:10:10 -0000
d1927 1
a1927 1
+++ src/sys/lib/libkern/arch/i386/ntohl.S	11 Feb 2003 21:10:10 -0000
d1998 1
a1998 1
+++ src/sys/lib/libkern/arch/i386/ntohs.S	11 Feb 2003 21:10:10 -0000
a2057 203
Index: src/sys/lib/libsa/exec_elf.c
===================================================================
RCS file: /cvs/src/sys/lib/libsa/exec_elf.c,v
retrieving revision 1.6
diff -u -r1.6 exec_elf.c
--- src/sys/lib/libsa/exec_elf.c	9 Jul 2002 01:45:25 -0000	1.6
+++ src/sys/lib/libsa/exec_elf.c	15 Feb 2003 15:38:25 -0000
@@@@ -35,6 +35,10 @@@@
 #include <sys/exec_elf.h>
 #include <ddb/db_aout.h>
 
+#ifndef ELF_LOAD_MASK
+#define ELF_LOAD_MASK ~0
+#endif
+
 int
 elf_probe(fd, hdr)
 	int fd;
@@@@ -96,12 +100,14 @@@@
 			       ph->p_memsz, ph->p_flags);
 #endif
 		if (ph->p_filesz && ph->p_flags & PF_X) {
+			/*
 			pa = ph->p_vaddr;
-			xp->text.addr = ph->p_vaddr;
+			*/
+			xp->text.addr = ph->p_vaddr & ELF_LOAD_MASK; 
 			xp->text.size = ph->p_filesz;
 			xp->text.foff = ph->p_offset;
 		} else if (ph->p_filesz && ph->p_flags & PF_W) {
-			xp->data.addr = ph->p_vaddr;
+			xp->data.addr = ph->p_vaddr & ELF_LOAD_MASK;
 			xp->data.size = ph->p_filesz;
 			xp->data.foff = ph->p_offset;
 			if (ph->p_filesz < ph->p_memsz) {
@@@@ -110,7 +116,7 @@@@
 				xp->bss.foff = 0;
 			}
 		} else if (!ph->p_filesz) {
-			xp->bss.addr = ph->p_vaddr;
+			xp->bss.addr = ph->p_vaddr & ELF_LOAD_MASK;
 			xp->bss.size = ph->p_memsz;
 			xp->bss.foff = 0;
 		}
Index: src/sys/lib/libz/Makefile
===================================================================
RCS file: /cvs/src/sys/lib/libz/Makefile,v
retrieving revision 1.3
diff -u -r1.3 Makefile
--- src/sys/lib/libz/Makefile	8 Sep 1998 04:07:25 -0000	1.3
+++ src/sys/lib/libz/Makefile	11 Feb 2003 21:09:31 -0000
@@@@ -5,7 +5,7 @@@@
 NOPIC=
 NOPROFILE=
 
-CPPFLAGS+=	-I. ${ZCPPFLAGS} -D_ZLIB_PRIVATE
+CPPFLAGS+=	-I. -I${.CURDIR} ${ZCPPFLAGS} -D_ZLIB_PRIVATE
 
 # files to be copied down from libz.
 LIBZSRCS= adler32.c crc32.c infblock.c infcodes.c inffast.c \
Index: src/sys/miscfs/procfs/procfs_vnops.c
===================================================================
RCS file: /cvs/src/sys/miscfs/procfs/procfs_vnops.c,v
retrieving revision 1.26
diff -u -r1.26 procfs_vnops.c
--- src/sys/miscfs/procfs/procfs_vnops.c	6 Apr 2002 23:39:51 -0000	1.26
+++ src/sys/miscfs/procfs/procfs_vnops.c	11 Feb 2003 21:09:31 -0000
@@@@ -746,7 +746,7 @@@@
 	struct vnode *dvp = ap->a_dvp;
 	char *pname = cnp->cn_nameptr;
 	struct proc *curp = curproc;
-	struct proc_target *pt;
+	struct proc_target *pt = NULL;
 	struct vnode *fvp;
 	pid_t pid;
 	struct pfsnode *pfs;
Index: src/sys/miscfs/union/union_vnops.c
===================================================================
RCS file: /cvs/src/sys/miscfs/union/union_vnops.c,v
retrieving revision 1.19
diff -u -r1.19 union_vnops.c
--- src/sys/miscfs/union/union_vnops.c	8 Jun 2002 18:43:12 -0000	1.19
+++ src/sys/miscfs/union/union_vnops.c	11 Feb 2003 21:09:31 -0000
@@@@ -1097,7 +1097,7 @@@@
 	int error = 0;
 	struct union_node *dun;
 	struct vnode *dvp;
-	struct vnode *vp;
+	struct vnode *vp = NULL;
 	struct proc *p = ap->a_cnp->cn_proc;
 
 	dun = VTOUNION(ap->a_dvp);
Index: src/sys/net/if_bridge.c
===================================================================
RCS file: /cvs/src/sys/net/if_bridge.c,v
retrieving revision 1.109
diff -u -r1.109 if_bridge.c
--- src/sys/net/if_bridge.c	7 Jan 2003 17:46:59 -0000	1.109
+++ src/sys/net/if_bridge.c	11 Feb 2003 21:09:31 -0000
@@@@ -2116,7 +2116,7 @@@@
 	struct tdb *tdb;
 	u_int32_t spi;
 	u_int16_t cpi;
-	int error, off;
+	int error, off = 0;
 	u_int8_t proto = 0;
 #ifdef INET
 	struct ip *ip;
Index: src/sys/net/if_vlan.c
===================================================================
RCS file: /cvs/src/sys/net/if_vlan.c,v
retrieving revision 1.33
diff -u -r1.33 if_vlan.c
--- src/sys/net/if_vlan.c	7 Jan 2003 09:00:12 -0000	1.33
+++ src/sys/net/if_vlan.c	11 Feb 2003 21:09:31 -0000
@@@@ -376,7 +376,7 @@@@
 		 */
 		ifv->ifv_if.if_mtu = p->if_mtu - EVL_ENCAPLEN;
 #ifdef DIAGNOSTIC
-		printf("%s: initialized with non-standard mtu %d (parent %s)\n",
+		printf("%s: initialized with non-standard mtu %ld (parent %s)\n",
 		    ifv->ifv_if.if_xname, ifv->ifv_if.if_mtu,
 		    ifv->ifv_p->if_xname);
 #endif
Index: src/sys/net/pf.c
===================================================================
RCS file: /cvs/src/sys/net/pf.c,v
retrieving revision 1.311
diff -u -r1.311 pf.c
--- src/sys/net/pf.c	25 Jan 2003 22:48:23 -0000	1.311
+++ src/sys/net/pf.c	11 Feb 2003 21:09:31 -0000
@@@@ -942,6 +942,7 @@@@
 	u_int32_t	opc;
 	u_int16_t	oip = *ip;
 
+	opc = 0U;
 	PF_ACPY(&oia, ia, af);
 	PF_ACPY(&ooa, oa, af);
 
@@@@ -1023,12 +1024,12 @@@@
 	struct m_tag	*mtag;
 	int		 len;
 #ifdef INET
-	struct ip	*h2;
+	struct ip	*h2 = NULL;
 #endif /* INET */
 #ifdef INET6
-	struct ip6_hdr	*h2_6;
+	struct ip6_hdr	*h2_6 = NULL;
 #endif /* INET6 */
-	struct tcphdr	*th2;
+	struct tcphdr	*th2 = NULL;
 
 	switch (af) {
 #ifdef INET
@@@@ -1041,6 +1042,8 @@@@
 		len = sizeof(struct ip6_hdr) + sizeof(struct tcphdr);
 		break;
 #endif /* INET6 */
+    default:
+	printf("panic: trying to send RST to an unhandled address family\n");
 	}
 
 	/* don't reply to RST packets */
@@@@ -2380,6 +2383,8 @@@@
 			state_icmp++;
 		break;
 #endif /* INET6 */
+	default:
+		return (PF_DROP);
 	}
 
 	if (direction == PF_OUT) {
@@@@ -3214,6 +3219,8 @@@@
 			state_icmp++;
 		break;
 #endif /* INET6 */
+		default:
+			return (PF_DROP);
 	}
 
 	if (!state_icmp) {
@@@@ -3382,6 +3389,8 @@@@
 			} while (!terminal);
 			break;
 #endif /* INET6 */
+		default:
+			return (PF_DROP);
 		}
 
 		switch (pd2.proto) {
@@@@ -4268,8 +4277,9 @@@@
 			r0.ifp = ifp;
 			r0.action = action;
 			r0.nr = -1;
-			PFLOG_PACKET(ifp, h, m, AF_INET, dir, reason, &r0);
-		} else
+			if (h != NULL)
+				PFLOG_PACKET(ifp, h, m, AF_INET, dir, reason, &r0);
+		} else if (h != NULL)
 			PFLOG_PACKET(ifp, h, m, AF_INET, dir, reason, r);
 	}
 
d2064 1
a2064 1
+++ src/sys/net/pf_table.c	15 Feb 2003 15:38:25 -0000
a2091 709
Index: src/sys/net/pfkeyv2.c
===================================================================
RCS file: /cvs/src/sys/net/pfkeyv2.c,v
retrieving revision 1.84
diff -u -r1.84 pfkeyv2.c
--- src/sys/net/pfkeyv2.c	31 Jul 2002 00:13:14 -0000	1.84
+++ src/sys/net/pfkeyv2.c	11 Feb 2003 21:09:31 -0000
@@@@ -803,7 +803,7 @@@@
 
     struct tdb sa, *sa2 = NULL;
 
-    struct sadb_msg *smsg;
+    struct sadb_msg *smsg = NULL;
     struct sadb_spirange *sprng;
     struct sadb_sa *ssa;
     struct sadb_supported *ssup;
@@@@ -1773,7 +1773,8 @@@@
 	for (i = 1; i <= SADB_EXT_MAX; i++)
 	  headers[i] = NULL;
 
-	smsg->sadb_msg_errno = abs(rval);
+    if (smsg != NULL)
+  	  smsg->sadb_msg_errno = abs(rval);
     }
     else
     {
@@@@ -1783,6 +1784,9 @@@@
 	  if (headers[i])
 	    seen |= (1 << i);
 
+    if (smsg == NULL)
+      goto realret;
+
 	if ((seen & sadb_exts_allowed_out[smsg->sadb_msg_type]) != seen)
 	  goto realret;
 
@@@@ -1822,7 +1826,7 @@@@
     struct sadb_prop *sa_prop;
     struct sadb_msg *smsg;
     int rval = 0;
-    int i, j;
+    int i = 0, j;
 
     *seq = pfkeyv2_seq++;
 
@@@@ -2106,7 +2110,7 @@@@
     void *p, *headers[SADB_EXT_MAX+1], *buffer = NULL;
     struct sadb_msg *smsg;
     int rval = 0;
-    int i;
+    int i = 0;
 
     switch (sa->tdb_sproto)
     {
Index: src/sys/netinet/ip_ah.c
===================================================================
RCS file: /cvs/src/sys/netinet/ip_ah.c,v
retrieving revision 1.70
diff -u -r1.70 ip_ah.c
--- src/sys/netinet/ip_ah.c	5 Jul 2002 23:20:31 -0000	1.70
+++ src/sys/netinet/ip_ah.c	11 Feb 2003 21:09:31 -0000
@@@@ -682,7 +682,7 @@@@
 int
 ah_input_cb(void *op)
 {
-	int roff, rplen, error, skip, protoff;
+	int roff, rplen, error = 0, skip, protoff;
 	unsigned char calc[AH_ALEN_MAX];
 	struct mbuf *m1, *m0, *m;
 	struct cryptodesc *crd;
@@@@ -1214,7 +1214,7 @@@@
 int
 ah_output_cb(void *op)
 {
-	int skip, protoff, error;
+	int skip, protoff, error = 0;
 	struct tdb_crypto *tc;
 	struct cryptop *crp;
 	struct tdb *tdb;
Index: src/sys/netinet/ip_esp.c
===================================================================
RCS file: /cvs/src/sys/netinet/ip_esp.c,v
retrieving revision 1.76
diff -u -r1.76 ip_esp.c
--- src/sys/netinet/ip_esp.c	7 Nov 2002 15:16:17 -0000	1.76
+++ src/sys/netinet/ip_esp.c	11 Feb 2003 21:09:31 -0000
@@@@ -453,7 +453,7 @@@@
 esp_input_cb(void *op)
 {
 	u_int8_t lastthree[3], aalg[AH_HMAC_HASHLEN];
-	int hlen, roff, skip, protoff, error;
+	int hlen, roff, skip, protoff, error = 0;
 	struct mbuf *m1, *mo, *m;
 	struct cryptodesc *crd;
 	struct auth_hash *esph;
@@@@ -979,7 +979,7 @@@@
 	struct tdb_crypto *tc;
 	struct tdb *tdb;
 	struct mbuf *m;
-	int error, s;
+	int error = 0, s;
 
 	tc = (struct tdb_crypto *) crp->crp_opaque;
 	m = (struct mbuf *) crp->crp_buf;
Index: src/sys/netinet/ip_ipcomp.c
===================================================================
RCS file: /cvs/src/sys/netinet/ip_ipcomp.c,v
retrieving revision 1.9
diff -u -r1.9 ip_ipcomp.c
--- src/sys/netinet/ip_ipcomp.c	12 Sep 2002 10:11:17 -0000	1.9
+++ src/sys/netinet/ip_ipcomp.c	11 Feb 2003 21:09:31 -0000
@@@@ -206,7 +206,7 @@@@
 ipcomp_input_cb(op)
 	void *op;
 {
-	int error, s, skip, protoff, roff, hlen = IPCOMP_HLENGTH, clen;
+	int error = 0, s, skip, protoff, roff, hlen = IPCOMP_HLENGTH, clen;
 	u_int8_t nproto;
 	struct mbuf *m, *m1, *mo;
 	struct cryptodesc *crd;
@@@@ -609,7 +609,7 @@@@
 	struct tdb_crypto *tc;
 	struct tdb *tdb;
 	struct mbuf *m;
-	int error, s, skip, rlen;
+	int error = 0, s, skip, rlen;
 #ifdef INET
 	struct ip *ip;
 #endif
Index: src/sys/netinet/ip_ipsp.c
===================================================================
RCS file: /cvs/src/sys/netinet/ip_ipsp.c,v
retrieving revision 1.150
diff -u -r1.150 ip_ipsp.c
--- src/sys/netinet/ip_ipsp.c	19 Nov 2002 18:34:19 -0000	1.150
+++ src/sys/netinet/ip_ipsp.c	11 Feb 2003 21:09:31 -0000
@@@@ -867,7 +867,7 @@@@
 	    ntohl(tdb->tdb_spi), ipsp_address(tdb->tdb_dst), tdb->tdb_sproto);
 
 	l += sprintf(buffer + l, "\tEstablished %d seconds ago\n",
-	    time.tv_sec - tdb->tdb_established);
+	    (int) (time.tv_sec - tdb->tdb_established));
 
 	l += sprintf(buffer + l, "\tSource = %s", ipsp_address(tdb->tdb_src));
 
Index: src/sys/netinet/ip_output.c
===================================================================
RCS file: /cvs/src/sys/netinet/ip_output.c,v
retrieving revision 1.150
diff -u -r1.150 ip_output.c
--- src/sys/netinet/ip_output.c	10 Oct 2002 17:27:18 -0000	1.150
+++ src/sys/netinet/ip_output.c	11 Feb 2003 21:09:31 -0000
@@@@ -100,24 +100,24 @@@@
 ip_output(struct mbuf *m0, ...)
 {
 	struct ip *ip;
-	struct ifnet *ifp;
+	struct ifnet *ifp = NULL;
 	struct mbuf *m = m0;
 	int hlen = sizeof (struct ip);
 	int len, error = 0;
 	struct route iproute;
-	struct sockaddr_in *dst;
-	struct in_ifaddr *ia;
+	struct sockaddr_in *dst = NULL;
+	struct in_ifaddr *ia ;
 	struct mbuf *opt;
 	struct route *ro;
 	int flags;
 	struct ip_moptions *imo;
 	va_list ap;
 	u_int8_t sproto = 0, donerouting = 0;
-	u_long mtu;
+	u_long mtu = 0;
 #ifdef IPSEC
 	u_int32_t icmp_mtu = 0;
 	union sockaddr_union sdst;
-	u_int32_t sspi;
+	u_int32_t sspi = 0;
 	struct m_tag *mtag;
 	struct tdb_ident *tdbi;
 
Index: src/sys/netinet/ipsec_output.c
===================================================================
RCS file: /cvs/src/sys/netinet/ipsec_output.c,v
retrieving revision 1.25
diff -u -r1.25 ipsec_output.c
--- src/sys/netinet/ipsec_output.c	28 Aug 2002 15:42:41 -0000	1.25
+++ src/sys/netinet/ipsec_output.c	11 Feb 2003 21:09:31 -0000
@@@@ -65,15 +65,15 @@@@
 ipsp_process_packet(struct mbuf *m, struct tdb *tdb, int af, int tunalready)
 {
 	struct timeval tv;
-	int i, off, error;
+	int i = 0, off = 0, error;
 	struct mbuf *mp;
 
 #ifdef INET
 	int setdf = 0;
-	struct ip *ip;
+	struct ip *ip = NULL;
 #endif /* INET */
 #ifdef INET6
-	struct ip6_hdr *ip6;
+	struct ip6_hdr *ip6 = NULL;
 #endif /* INET6 */
 
 	/* Check that the transform is allowed by the administrator. */
@@@@ -323,11 +323,11 @@@@
 ipsp_process_done(struct mbuf *m, struct tdb *tdb)
 {
 #ifdef INET
-	struct ip *ip;
+	struct ip *ip = NULL;
 #endif /* INET */
 
 #ifdef INET6
-	struct ip6_hdr *ip6;
+	struct ip6_hdr *ip6 = NULL;
 #endif /* INET6 */
 
 	struct tdb_ident *tdbi;
Index: src/sys/netinet/tcp_input.c
===================================================================
RCS file: /cvs/src/sys/netinet/tcp_input.c,v
retrieving revision 1.124
diff -u -r1.124 tcp_input.c
--- src/sys/netinet/tcp_input.c	11 Sep 2002 03:26:41 -0000	1.124
+++ src/sys/netinet/tcp_input.c	11 Feb 2003 21:09:32 -0000
@@@@ -432,7 +432,7 @@@@
 #endif /* IPSEC */
 	int af;
 #ifdef TCP_ECN
-	u_char iptos;
+	u_char iptos = 0;
 #endif
 
 	va_start(ap, m);
Index: src/sys/netinet/tcp_output.c
===================================================================
RCS file: /cvs/src/sys/netinet/tcp_output.c,v
retrieving revision 1.54
diff -u -r1.54 tcp_output.c
--- src/sys/netinet/tcp_output.c	25 Jan 2003 15:27:07 -0000	1.54
+++ src/sys/netinet/tcp_output.c	11 Feb 2003 21:09:33 -0000
@@@@ -220,8 +220,8 @@@@
 	register struct tcpcb *tp;
 {
 	register struct socket *so = tp->t_inpcb->inp_socket;
-	register long len, win, txmaxseg;
-	int off, flags, error;
+	register long len = 0, win, txmaxseg;
+	int off, flags, error = 0;
 	register struct mbuf *m;
 	register struct tcphdr *th;
 	u_char opt[MAX_TCPOPTLEN];
@@@@ -229,7 +229,7 @@@@
 	int idle, sendalot = 0;
 #ifdef TCP_SACK
 	int i, sack_rxmit = 0;
-	struct sackhole *p;
+	struct sackhole *p = NULL;
 #endif
 #if defined(TCP_SACK)
 	int maxburst = TCP_MAXBURST;
Index: src/sys/netinet/tcp_subr.c
===================================================================
RCS file: /cvs/src/sys/netinet/tcp_subr.c,v
retrieving revision 1.65
diff -u -r1.65 tcp_subr.c
--- src/sys/netinet/tcp_subr.c	28 Aug 2002 15:42:41 -0000	1.65
+++ src/sys/netinet/tcp_subr.c	11 Feb 2003 21:09:33 -0000
@@@@ -134,7 +134,7 @@@@
 #endif
 int	tcp_do_sack = TCP_DO_SACK;		/* RFC 2018 selective ACKs */
 int	tcp_ack_on_push = 0;	/* set to enable immediate ACK-on-PUSH */
-int	tcp_do_ecn = 0;		/* RFC3168 ECN enabled/disabled? */
+int	tcp_do_ecn = 1;		/* RFC3168 ECN enabled/disabled? */
 
 #ifndef TCBHASHSIZE
 #define	TCBHASHSIZE	128
@@@@ -212,7 +212,7 @@@@
 	if ((m = tp->t_template) == 0) {
 		m = m_get(M_DONTWAIT, MT_HEADER);
 		if (m == NULL)
-			return (0);
+			return (NULL);
 
 		switch (tp->pf) {
 		case 0:	/*default to PF_INET*/
@@@@ -287,6 +287,8 @@@@
 		}
 		break;
 #endif /* INET6 */
+    default:
+	return (NULL);
 	}
 
 	th->th_sport = inp->inp_lport;
@@@@ -392,6 +394,8 @@@@
 			xchg(ti->ti_dst.s_addr, ti->ti_src.s_addr, u_int32_t);
 			th = (void *)((caddr_t)ti + sizeof(struct ip));
 			break;
+	default:
+	    return;
 		}
 		xchg(th->th_dport, th->th_sport, u_int16_t);
 #undef xchg
@@@@ -408,6 +412,8 @@@@
 		tlen += sizeof (struct tcpiphdr);
 		th = (struct tcphdr *)((caddr_t)ti + sizeof(struct ip));
 		break;
+    default:
+	return;
 	}
 
 	m->m_len = tlen;
@@@@ -808,6 +814,7 @@@@
 	} else {
 		m = NULL;
 		ip6 = NULL;
+	off = 0;
 		sa6_src = &sa6_any;
 	}
 
Index: src/sys/netinet/tcp_usrreq.c
===================================================================
RCS file: /cvs/src/sys/netinet/tcp_usrreq.c,v
retrieving revision 1.67
diff -u -r1.67 tcp_usrreq.c
--- src/sys/netinet/tcp_usrreq.c	11 Sep 2002 03:15:14 -0000	1.67
+++ src/sys/netinet/tcp_usrreq.c	11 Feb 2003 21:09:33 -0000
@@@@ -783,10 +783,10 @@@@
 {
 	int error = 0, s;
 	struct tcp_ident_mapping tir;
-	struct inpcb *inp;
-	struct sockaddr_in *fin, *lin;
+	struct inpcb *inp = NULL;
+	struct sockaddr_in *fin = NULL, *lin = NULL;
 #ifdef INET6
-	struct sockaddr_in6 *fin6, *lin6;
+	struct sockaddr_in6 *fin6 = NULL, *lin6 = NULL;
 	struct in6_addr f6, l6;
 #endif
 
Index: src/sys/netinet/udp_usrreq.c
===================================================================
RCS file: /cvs/src/sys/netinet/udp_usrreq.c,v
retrieving revision 1.86
diff -u -r1.86 udp_usrreq.c
--- src/sys/netinet/udp_usrreq.c	28 Aug 2002 15:42:41 -0000	1.86
+++ src/sys/netinet/udp_usrreq.c	11 Feb 2003 21:09:33 -0000
@@@@ -714,6 +714,7 @@@@
 		m = NULL;
 		ip6 = NULL;
 		cmdarg = NULL;
+		off = 0;
 		/* XXX: translate addresses into internal form */
 		sa6 = *(struct sockaddr_in6 *)sa;
 #ifndef SCOPEDROUTING
Index: src/sys/netinet6/in6_ifattach.c
===================================================================
RCS file: /cvs/src/sys/netinet6/in6_ifattach.c,v
retrieving revision 1.32
diff -u -r1.32 in6_ifattach.c
--- src/sys/netinet6/in6_ifattach.c	12 Sep 2002 01:11:32 -0000	1.32
+++ src/sys/netinet6/in6_ifattach.c	11 Feb 2003 21:09:33 -0000
@@@@ -674,12 +674,13 @@@@
 	nd6_purge(ifp);
 
 	/* nuke any of IPv6 addresses we have */
-	for (ifa = ifp->if_addrlist.tqh_first; ifa; ifa = next)
-	{
+	ifa = ifp->if_addrlist.tqh_first;
+	while (ifa) {
 		next = ifa->ifa_list.tqe_next;
 		if (ifa->ifa_addr->sa_family != AF_INET6)
 			continue;
 		in6_purgeaddr(ifa);
+		ifa = next;
 	}
 
 	/* undo everything done by in6_ifattach(), just in case */
@@@@ -734,6 +735,7 @@@@
 		}
 
 		IFAFREE(&oia->ia_ifa);
+		ifa = next;
 	}
 
 	/* cleanup multicast address kludge table, if there is any */
Index: src/sys/netinet6/ip6_forward.c
===================================================================
RCS file: /cvs/src/sys/netinet6/ip6_forward.c,v
retrieving revision 1.24
diff -u -r1.24 ip6_forward.c
--- src/sys/netinet6/ip6_forward.c	9 Jun 2002 14:38:17 -0000	1.24
+++ src/sys/netinet6/ip6_forward.c	11 Feb 2003 21:09:33 -0000
@@@@ -88,7 +88,7 @@@@
 	struct ip6_hdr *ip6 = mtod(m, struct ip6_hdr *);
 	struct sockaddr_in6 *dst;
 	struct rtentry *rt;
-	int error, type = 0, code = 0;
+	int error = 0, type = 0, code = 0;
 	struct mbuf *mcopy = NULL;
 	long time_second = time.tv_sec;
 	struct ifnet *origifp;	/* maybe unnecessary */
Index: src/sys/netinet6/ip6_output.c
===================================================================
RCS file: /cvs/src/sys/netinet6/ip6_output.c,v
retrieving revision 1.73
diff -u -r1.73 ip6_output.c
--- src/sys/netinet6/ip6_output.c	31 Oct 2002 18:02:05 -0000	1.73
+++ src/sys/netinet6/ip6_output.c	11 Feb 2003 21:09:33 -0000
@@@@ -168,7 +168,7 @@@@
 	struct m_tag *mtag;
 	union sockaddr_union sdst;
 	struct tdb_ident *tdbi;
-	u_int32_t sspi;
+	u_int32_t sspi = 0;
 	struct inpcb *inp;
 	struct tdb *tdb;
 	int s;
Index: src/sys/netinet6/raw_ip6.c
===================================================================
RCS file: /cvs/src/sys/netinet6/raw_ip6.c,v
retrieving revision 1.17
diff -u -r1.17 raw_ip6.c
--- src/sys/netinet6/raw_ip6.c	11 Sep 2002 03:27:08 -0000	1.17
+++ src/sys/netinet6/raw_ip6.c	11 Feb 2003 21:09:33 -0000
@@@@ -378,7 +378,8 @@@@
 	int error = 0;
 	struct ip6_pktopts opt, *optp = NULL, *origoptp;
 	struct ifnet *oifp = NULL;
-	int type, code;		/* for ICMPv6 output statistics only */
+	/* for ICMPv6 output statistics only */
+	int type = 0, code = 0;
 	int priv = 0;
 	va_list ap;
 	int flags;
Index: src/sys/nfs/nfsproto.h
===================================================================
RCS file: /cvs/src/sys/nfs/nfsproto.h,v
retrieving revision 1.4
diff -u -r1.4 nfsproto.h
--- src/sys/nfs/nfsproto.h	28 Jan 2002 22:35:57 -0000	1.4
+++ src/sys/nfs/nfsproto.h	11 Feb 2003 21:09:33 -0000
@@@@ -54,18 +54,18 @@@@
  * Specification"
  */
 
-#define NFS_PORT	2049
+#define	NFS_PORT	2049
 #define	NFS_PROG	100003
-#define NFS_VER2	2
+#define	NFS_VER2	2
 #define	NFS_VER3	3
-#define NFS_VER4        4
-#define NFS_V2MAXDATA	8192
-#define	NFS_MAXDGRAMDATA 16384
+#define	NFS_VER4        4
+#define	NFS_V2MAXDATA	8192
+#define	NFS_MAXDGRAMDATA 32768
 #define	NFS_MAXDATA	32768
 #define	NFS_MAXPATHLEN	1024
 #define	NFS_MAXNAMLEN	255
 #define	NFS_MAXPKTHDR	404
-#define NFS_MAXPACKET	(NFS_MAXPKTHDR + NFS_MAXDATA)
+#define	NFS_MAXPACKET	(NFS_MAXPKTHDR + NFS_MAXDATA)
 #define	NFS_MINPACKET	20
 #define	NFS_FABLKSIZE	512	/* Size in bytes of a block wrt fa_blocks */
 
@@@@ -100,12 +100,12 @@@@
 #define	NFSERR_SERVERFAULT	10006
 #define	NFSERR_BADTYPE		10007
 #define	NFSERR_JUKEBOX		10008
-#define NFSERR_TRYLATER		NFSERR_JUKEBOX
+#define	NFSERR_TRYLATER		NFSERR_JUKEBOX
 #define	NFSERR_STALEWRITEVERF	30001	/* Fake return for nfs_commit() */
 
-#define NFSERR_RETVOID		0x20000000 /* Return void, not error */
-#define NFSERR_AUTHERR		0x40000000 /* Mark an authentication error */
-#define NFSERR_RETERR		0x80000000 /* Mark an error return for V3 */
+#define	NFSERR_RETVOID		0x20000000 /* Return void, not error */
+#define	NFSERR_AUTHERR		0x40000000 /* Mark an authentication error */
+#define	NFSERR_RETERR		0x80000000 /* Mark an error return for V3 */
 
 /* Sizes in bytes of various nfs rpc components */
 #define	NFSX_UNSIGNED	4
@@@@ -115,38 +115,38 @@@@
 #define	NFSX_V2FATTR	68
 #define	NFSX_V2SATTR	32
 #define	NFSX_V2COOKIE	4
-#define NFSX_V2STATFS	20
+#define	NFSX_V2STATFS	20
 
 /* specific to NFS Version 3 */
-#define NFSX_V3FH		(sizeof (fhandle_t)) /* size this server uses */
+#define	NFSX_V3FH		(sizeof (fhandle_t)) /* size this server uses */
 #define	NFSX_V3FHMAX		64	/* max. allowed by protocol */
-#define NFSX_V3FATTR		84
-#define NFSX_V3SATTR		60	/* max. all fields filled in */
-#define NFSX_V3SRVSATTR		(sizeof (struct nfsv3_sattr))
-#define NFSX_V3POSTOPATTR	(NFSX_V3FATTR + NFSX_UNSIGNED)
-#define NFSX_V3WCCDATA		(NFSX_V3POSTOPATTR + 8 * NFSX_UNSIGNED)
-#define NFSX_V3COOKIEVERF 	8
-#define NFSX_V3WRITEVERF 	8
-#define NFSX_V3CREATEVERF	8
-#define NFSX_V3STATFS		52
-#define NFSX_V3FSINFO		48
-#define NFSX_V3PATHCONF		24
+#define	NFSX_V3FATTR		84
+#define	NFSX_V3SATTR		60	/* max. all fields filled in */
+#define	NFSX_V3SRVSATTR		(sizeof (struct nfsv3_sattr))
+#define	NFSX_V3POSTOPATTR	(NFSX_V3FATTR + NFSX_UNSIGNED)
+#define	NFSX_V3WCCDATA		(NFSX_V3POSTOPATTR + 8 * NFSX_UNSIGNED)
+#define	NFSX_V3COOKIEVERF 	8
+#define	NFSX_V3WRITEVERF 	8
+#define	NFSX_V3CREATEVERF	8
+#define	NFSX_V3STATFS		52
+#define	NFSX_V3FSINFO		48
+#define	NFSX_V3PATHCONF		24
 
 /* variants for both versions */
-#define NFSX_FH(v3)		((v3) ? (NFSX_V3FHMAX + NFSX_UNSIGNED) : \
+#define	NFSX_FH(v3)		((v3) ? (NFSX_V3FHMAX + NFSX_UNSIGNED) : \
 					NFSX_V2FH)
-#define NFSX_SRVFH(v3)		((v3) ? NFSX_V3FH : NFSX_V2FH)
+#define	NFSX_SRVFH(v3)		((v3) ? NFSX_V3FH : NFSX_V2FH)
 #define	NFSX_FATTR(v3)		((v3) ? NFSX_V3FATTR : NFSX_V2FATTR)
-#define NFSX_PREOPATTR(v3)	((v3) ? (7 * NFSX_UNSIGNED) : 0)
-#define NFSX_POSTOPATTR(v3)	((v3) ? (NFSX_V3FATTR + NFSX_UNSIGNED) : 0)
-#define NFSX_POSTOPORFATTR(v3)	((v3) ? (NFSX_V3FATTR + NFSX_UNSIGNED) : \
+#define	NFSX_PREOPATTR(v3)	((v3) ? (7 * NFSX_UNSIGNED) : 0)
+#define	NFSX_POSTOPATTR(v3)	((v3) ? (NFSX_V3FATTR + NFSX_UNSIGNED) : 0)
+#define	NFSX_POSTOPORFATTR(v3)	((v3) ? (NFSX_V3FATTR + NFSX_UNSIGNED) : \
 					NFSX_V2FATTR)
-#define NFSX_WCCDATA(v3)	((v3) ? NFSX_V3WCCDATA : 0)
-#define NFSX_WCCORFATTR(v3)	((v3) ? NFSX_V3WCCDATA : NFSX_V2FATTR)
+#define	NFSX_WCCDATA(v3)	((v3) ? NFSX_V3WCCDATA : 0)
+#define	NFSX_WCCORFATTR(v3)	((v3) ? NFSX_V3WCCDATA : NFSX_V2FATTR)
 #define	NFSX_SATTR(v3)		((v3) ? NFSX_V3SATTR : NFSX_V2SATTR)
 #define	NFSX_COOKIEVERF(v3)	((v3) ? NFSX_V3COOKIEVERF : 0)
 #define	NFSX_WRITEVERF(v3)	((v3) ? NFSX_V3WRITEVERF : 0)
-#define NFSX_READDIR(v3)	((v3) ? (5 * NFSX_UNSIGNED) : \
+#define	NFSX_READDIR(v3)	((v3) ? (5 * NFSX_UNSIGNED) : \
 					(2 * NFSX_UNSIGNED))
 #define	NFSX_STATFS(v3)		((v3) ? NFSX_V3STATFS : NFSX_V2STATFS)
 
@@@@ -174,7 +174,7 @@@@
 #define	NFSPROC_PATHCONF	20
 #define	NFSPROC_COMMIT		21
 
-#define NFSPROC_NOOP		25
+#define	NFSPROC_NOOP		25
 #define	NFS_NPROCS		26
 
 /* Actual Version 2 procedure numbers */
@@@@ -201,35 +201,35 @@@@
 /*
  * Constants used by the Version 3 protocol for various RPCs
  */
-#define NFSV3SATTRTIME_DONTCHANGE	0
-#define NFSV3SATTRTIME_TOSERVER		1
-#define NFSV3SATTRTIME_TOCLIENT		2
-
-#define NFSV3ACCESS_READ		0x01
-#define NFSV3ACCESS_LOOKUP		0x02
-#define NFSV3ACCESS_MODIFY		0x04
-#define NFSV3ACCESS_EXTEND		0x08
-#define NFSV3ACCESS_DELETE		0x10
-#define NFSV3ACCESS_EXECUTE		0x20
-
-#define NFSV3WRITE_UNSTABLE		0
-#define NFSV3WRITE_DATASYNC		1
-#define NFSV3WRITE_FILESYNC		2
-
-#define NFSV3CREATE_UNCHECKED		0
-#define NFSV3CREATE_GUARDED		1
-#define NFSV3CREATE_EXCLUSIVE		2
-
-#define NFSV3FSINFO_LINK		0x01
-#define NFSV3FSINFO_SYMLINK		0x02
-#define NFSV3FSINFO_HOMOGENEOUS		0x08
-#define NFSV3FSINFO_CANSETTIME		0x10
+#define	NFSV3SATTRTIME_DONTCHANGE	0
+#define	NFSV3SATTRTIME_TOSERVER		1
+#define	NFSV3SATTRTIME_TOCLIENT		2
+
+#define	NFSV3ACCESS_READ		0x01
+#define	NFSV3ACCESS_LOOKUP		0x02
+#define	NFSV3ACCESS_MODIFY		0x04
+#define	NFSV3ACCESS_EXTEND		0x08
+#define	NFSV3ACCESS_DELETE		0x10
+#define	NFSV3ACCESS_EXECUTE		0x20
+
+#define	NFSV3WRITE_UNSTABLE		0
+#define	NFSV3WRITE_DATASYNC		1
+#define	NFSV3WRITE_FILESYNC		2
+
+#define	NFSV3CREATE_UNCHECKED		0
+#define	NFSV3CREATE_GUARDED		1
+#define	NFSV3CREATE_EXCLUSIVE		2
+
+#define	NFSV3FSINFO_LINK		0x01
+#define	NFSV3FSINFO_SYMLINK		0x02
+#define	NFSV3FSINFO_HOMOGENEOUS		0x08
+#define	NFSV3FSINFO_CANSETTIME		0x10
 
 /* Conversion macros */
 #define	vtonfsv2_mode(t,m) \
 		txdr_unsigned(((t) == VFIFO) ? MAKEIMODE(VCHR, (m)) : \
 				MAKEIMODE((t), (m)))
-#define vtonfsv3_mode(m)	txdr_unsigned((m) & 07777)
+#define	vtonfsv3_mode(m)	txdr_unsigned((m) & 07777)
 #define	nfstov_mode(a)		(fxdr_unsigned(u_int16_t, (a))&07777)
 #define	vtonfsv2_type(a)	txdr_unsigned(nfsv2_type[((int32_t)(a))])
 #define	vtonfsv3_type(a)	txdr_unsigned(nfsv3_type[((int32_t)(a))])
@@@@ -249,7 +249,7 @@@@
  * NFS_SMALLFH should be in the range of 32 to 64 and be divisible by 4.
  */
 #ifndef NFS_SMALLFH
-#define NFS_SMALLFH	64
+#define	NFS_SMALLFH	64
 #endif
 union nfsfh {
 	fhandle_t fh_generic;
@@@@ -400,18 +400,18 @@@@
 	} sf_un;
 };
 
-#define sf_tsize	sf_un.sf_nfsv2.nfsv2sf_tsize
-#define sf_bsize	sf_un.sf_nfsv2.nfsv2sf_bsize
-#define sf_blocks	sf_un.sf_nfsv2.nfsv2sf_blocks
-#define sf_bfree	sf_un.sf_nfsv2.nfsv2sf_bfree
-#define sf_bavail	sf_un.sf_nfsv2.nfsv2sf_bavail
-#define sf_tbytes	sf_un.sf_nfsv3.nfsv3sf_tbytes
-#define sf_fbytes	sf_un.sf_nfsv3.nfsv3sf_fbytes
-#define sf_abytes	sf_un.sf_nfsv3.nfsv3sf_abytes
-#define sf_tfiles	sf_un.sf_nfsv3.nfsv3sf_tfiles
-#define sf_ffiles	sf_un.sf_nfsv3.nfsv3sf_ffiles
-#define sf_afiles	sf_un.sf_nfsv3.nfsv3sf_afiles
-#define sf_invarsec	sf_un.sf_nfsv3.nfsv3sf_invarsec
+#define	sf_tsize	sf_un.sf_nfsv2.nfsv2sf_tsize
+#define	sf_bsize	sf_un.sf_nfsv2.nfsv2sf_bsize
+#define	sf_blocks	sf_un.sf_nfsv2.nfsv2sf_blocks
+#define	sf_bfree	sf_un.sf_nfsv2.nfsv2sf_bfree
+#define	sf_bavail	sf_un.sf_nfsv2.nfsv2sf_bavail
+#define	sf_tbytes	sf_un.sf_nfsv3.nfsv3sf_tbytes
+#define	sf_fbytes	sf_un.sf_nfsv3.nfsv3sf_fbytes
+#define	sf_abytes	sf_un.sf_nfsv3.nfsv3sf_abytes
+#define	sf_tfiles	sf_un.sf_nfsv3.nfsv3sf_tfiles
+#define	sf_ffiles	sf_un.sf_nfsv3.nfsv3sf_ffiles
+#define	sf_afiles	sf_un.sf_nfsv3.nfsv3sf_afiles
+#define	sf_invarsec	sf_un.sf_nfsv3.nfsv3sf_invarsec
 
 struct nfsv3_fsinfo {
 	u_int32_t fs_rtmax;
Index: src/sys/stand/boot/cmd.c
===================================================================
RCS file: /cvs/src/sys/stand/boot/cmd.c,v
retrieving revision 1.48
diff -u -r1.48 cmd.c
--- src/sys/stand/boot/cmd.c	14 Jul 2002 09:18:55 -0000	1.48
+++ src/sys/stand/boot/cmd.c	11 Feb 2003 21:09:33 -0000
@@@@ -86,8 +86,19 @@@@
 {
 	cmd.cmd = NULL;
 
-	if (!readline(cmd_buf, sizeof(cmd_buf), cmd.timeout))
+	switch (readline(cmd_buf, sizeof(cmd_buf), cmd.timeout))
+	{
+	default:
+		cmd.timeout = 0;
+		break;
+	case 0:
+		cmd.timeout = 0;
 		cmd.cmd = cmd_table;
+		break;
+	case -1:
+		strncpy(cmd_buf, "boot", 5);
+		break;
+	}
 
 	return docmd();
 }
@@@@ -238,11 +249,16 @@@@
 			if (!(i++ % 1000) && (getsecs() >= tt))
 				break;
 
+#if 0
 		if (!cnischar()) {
 			strncpy(buf, "boot", 5);
 			putchar('\n');
 			return strlen(buf);
 		}
+#else
+		if (!cnischar())
+			return -1;
+#endif
 	} else
 		while (!cnischar()) ;
 
@@@@ -499,4 +515,3 @@@@
 	exit();
 	return 0; /* just in case */
 }
-
d2098 1
a2098 1
+++ src/sys/sys/proc.h	15 Feb 2003 15:38:28 -0000
d2100 1
a2100 1
+/*	$MirBSD: obsd.misc,v 1.8 2003/02/15 15:27:31 tg Exp $	*/
a2122 18
Index: src/sys/sys/resource.h
===================================================================
RCS file: /cvs/src/sys/sys/resource.h,v
retrieving revision 1.4
diff -u -r1.4 resource.h
--- src/sys/sys/resource.h	14 Mar 2002 01:26:52 -0000	1.4
+++ src/sys/sys/resource.h	11 Feb 2003 21:09:33 -0000
@@@@ -89,8 +89,9 @@@@
 #define	RLIMIT_MEMLOCK	6		/* locked-in-memory address space */
 #define	RLIMIT_NPROC	7		/* number of processes */
 #define	RLIMIT_NOFILE	8		/* number of open files */
+#define	RLIMIT_TIME	9		/* user time */
 
-#define	RLIM_NLIMITS	9		/* number of resource limits */
+#define	RLIM_NLIMITS	10		/* number of resource limits */
 
 #define	RLIM_INFINITY	(((u_quad_t)1 << 63) - 1)
 
d2129 1
a2129 1
+++ src/sys/sys/sysctl.h	11 Feb 2003 21:10:10 -0000
d2131 1
a2131 1
+/*	$MirBSD: obsd.tygs,v 1.24 2003/02/11 21:08:31 tg Exp $	*/
d2190 1
a2190 1
+++ src/sys/sys/systm.h	11 Feb 2003 21:10:10 -0000
d2205 1
a2205 1
+++ src/sys/sys/utsname.h	11 Feb 2003 21:10:10 -0000
d2207 1
a2207 1
+/*	$MirBSD: obsd.tygs,v 1.24 2003/02/11 21:08:31 tg Exp $	*/
a2229 86
Index: src/sys/ufs/ffs/ffs_softdep.c
===================================================================
RCS file: /cvs/src/sys/ufs/ffs/ffs_softdep.c,v
retrieving revision 1.42
diff -u -r1.42 ffs_softdep.c
--- src/sys/ufs/ffs/ffs_softdep.c	12 Oct 2002 01:09:23 -0000	1.42
+++ src/sys/ufs/ffs/ffs_softdep.c	11 Feb 2003 21:09:33 -0000
@@@@ -327,7 +327,7 @@@@
 	struct sema *semap;
 	struct lockit *interlock;
 {
-	int s;
+	int s = 0;
 
 	if (semap->value++ > 0) {
 		if (interlock != NULL)
Index: src/sys/ufs/ffs/ffs_vfsops.c
===================================================================
RCS file: /cvs/src/sys/ufs/ffs/ffs_vfsops.c,v
retrieving revision 1.54
diff -u -r1.54 ffs_vfsops.c
--- src/sys/ufs/ffs/ffs_vfsops.c	1 Aug 2002 16:41:11 -0000	1.54
+++ src/sys/ufs/ffs/ffs_vfsops.c	11 Feb 2003 21:09:33 -0000
@@@@ -167,7 +167,7 @@@@
 	struct ufsmount *ump = NULL;
 	register struct fs *fs;
 	int error = 0, flags;
-	int ronly;
+	int ronly = 0;
 	mode_t accessmode;
 	size_t size;
 
Index: src/sys/uvm/uvm_amap.c
===================================================================
RCS file: /cvs/src/sys/uvm/uvm_amap.c,v
retrieving revision 1.27
diff -u -r1.27 uvm_amap.c
--- src/sys/uvm/uvm_amap.c	9 May 2002 14:13:56 -0000	1.27
+++ src/sys/uvm/uvm_amap.c	11 Feb 2003 21:09:33 -0000
@@@@ -1007,7 +1007,7 @@@@
 	struct vm_amap *amap;
 	int slotoff, slots;
 {
-	int byanon, lcv, stop, curslot, ptr, slotend;
+	int byanon, lcv, stop, curslot, ptr, slotend = 0;
 	struct vm_anon *anon;
 
 	/*
Index: src/sys/uvm/uvm_map.c
===================================================================
RCS file: /cvs/src/sys/uvm/uvm_map.c,v
retrieving revision 1.56
diff -u -r1.56 uvm_map.c
--- src/sys/uvm/uvm_map.c	9 Dec 2002 02:34:59 -0000	1.56
+++ src/sys/uvm/uvm_map.c	11 Feb 2003 21:09:33 -0000
@@@@ -304,9 +304,10 @@@@
 
 	RB_FOREACH(tmp, uvm_tree, &map->rbhead) {
 		if (tmp->ownspace != uvm_rb_space(map, tmp)) {
-			printf("%s: %d/%d ownspace %x != %x %s\n",
+			printf("%s: %d/%d ownspace %lx != %lx %s\n",
 			    name, n + 1, map->nentries,
-			    tmp->ownspace, uvm_rb_space(map, tmp),
+			    (unsigned long) tmp->ownspace,
+		   (unsigned long) uvm_rb_space(map, tmp),
 			    tmp->next == &map->header ? "(last)" : "");
 			goto error;
 		}
@@@@ -314,13 +315,14 @@@@
 	trtmp = NULL;
 	RB_FOREACH(tmp, uvm_tree, &map->rbhead) {
 		if (tmp->space != uvm_rb_subtree_space(tmp)) {
-			printf("%s: space %d != %d\n",
+			printf("%s: space %ld != %d\n",
 			    name, tmp->space, uvm_rb_subtree_space(tmp));
 			goto error;
 		}
 		if (trtmp != NULL && trtmp->start >= tmp->start) {
-			printf("%s: corrupt: %p >= %p\n",
-			    name, trtmp->start, tmp->start);
+			printf("%s: corrupt: %lu >= %lu\n",
+			    name, (unsigned long) trtmp->start,
+			    (unsigned long) tmp->start);
 			goto error;
 		}
 		n++;
d2236 1
a2236 1
+++ src/sys/uvm/uvm_meter.c	15 Feb 2003 15:38:28 -0000
a2265 32
Index: src/sys/uvm/uvm_pager.c
===================================================================
RCS file: /cvs/src/sys/uvm/uvm_pager.c,v
retrieving revision 1.33
diff -u -r1.33 uvm_pager.c
--- src/sys/uvm/uvm_pager.c	29 Oct 2002 18:29:59 -0000	1.33
+++ src/sys/uvm/uvm_pager.c	11 Feb 2003 21:09:33 -0000
@@@@ -795,7 +795,7 @@@@
 	struct vm_page *pg, *pgs[npages];
 	struct uvm_object *uobj;
 	int i, error;
-	boolean_t write, swap;
+	boolean_t write, swap = FALSE;
 	UVMHIST_FUNC("uvm_aio_aiodone"); UVMHIST_CALLED(ubchist);
 	UVMHIST_LOG(ubchist, "bp %p", bp, 0,0,0);
 
Index: src/sys/uvm/uvm_swap.c
===================================================================
RCS file: /cvs/src/sys/uvm/uvm_swap.c,v
retrieving revision 1.55
diff -u -r1.55 uvm_swap.c
--- src/sys/uvm/uvm_swap.c	12 Oct 2002 01:09:23 -0000	1.55
+++ src/sys/uvm/uvm_swap.c	11 Feb 2003 21:09:33 -0000
@@@@ -1813,7 +1813,7 @@@@
 #ifdef UVM_SWAP_ENCRYPT
 	vaddr_t dstkva;
 	struct vm_page *tpps[MAXBSIZE >> PAGE_SHIFT];
-	struct swapdev *sdp;
+	struct swapdev *sdp = NULL;
 	int	encrypt = 0;
 #endif
 	UVMHIST_FUNC("uvm_swap_io"); UVMHIST_CALLED(pdhist);
@

