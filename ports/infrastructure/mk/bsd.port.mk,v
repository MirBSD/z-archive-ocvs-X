head	1.180;
access;
symbols
	cvs-200406091925:1.1.1.19
	cvs-200406012030:1.1.1.18
	cvs-200405281530:1.1.1.17
	cvs-200403091710:1.1.1.16
	cvs-200402211630:1.1.1.16
	cvs-200401261625:1.1.1.15
	cvs-200401181215:1.1.1.14
	cvs-200401162142:1.1.1.13
	cvs-200301141450:1.1.1.13
	cvs-200312021610:1.1.1.12
	cvs-200311151930:1.1.1.11
	cvs-200310311830:1.1.1.11
	cvs-200310021000:1.1.1.11
	cvs-200309281111:1.1.1.10
	cvs-200309171515:1.1.1.10
	cvs-200308302005:1.1.1.10
	cvs-200308221505:1.1.1.9
	cvs-200308171200:1.1.1.8
	ctm-3449:1.1.1.7
	cvs-200307191610:1.1.1.6
	ctm-3416:1.1.1.5
	cvs-200307091500:1.1.1.4
	ctm-3389:1.1.1.3
	cvs-200307030815:1.1.1.3
	cvs-200306301400:1.1.1.3
	cvs-200306291800:1.1.1.3
	ctm-3369:1.1.1.3
	ctm-3341:1.1.1.3
	MIRBSD_5:1.6
	cvs-200306082100:1.1.1.3
	ctm-3316:1.1.1.3
	ctm-3272:1.1.1.3
	ctm-3264:1.1.1.2
	ctm-3258:1.1.1.2
	MIRBSD_4:1.5
	ctm-3200:1.1.1.2
	ctm-3188:1.1.1.2
	ctm-3155:1.1.1.1
	ctm-3132:1.1.1.1
	openbsd:1.1.1;
locks; strict;
comment	@# @;


1.180
date	2005.03.15.19.56.16;	author tg;	state Exp;
branches;
next	1.179;

1.179
date	2005.03.10.20.50.30;	author tg;	state Exp;
branches;
next	1.178;

1.178
date	2005.03.06.16.43.11;	author bsiegert;	state Exp;
branches;
next	1.177;

1.177
date	2005.03.03.16.15.48;	author tg;	state Exp;
branches;
next	1.176;

1.176
date	2005.03.03.16.03.34;	author tg;	state Exp;
branches;
next	1.175;

1.175
date	2005.03.02.22.17.47;	author tg;	state Exp;
branches;
next	1.174;

1.174
date	2005.03.02.15.21.52;	author tg;	state Exp;
branches;
next	1.173;

1.173
date	2005.02.28.22.23.37;	author tg;	state Exp;
branches;
next	1.172;

1.172
date	2005.02.28.20.35.04;	author tg;	state Exp;
branches;
next	1.171;

1.171
date	2005.02.27.13.20.55;	author tg;	state Exp;
branches;
next	1.170;

1.170
date	2005.02.27.13.19.17;	author tg;	state Exp;
branches;
next	1.169;

1.169
date	2005.02.27.13.13.47;	author tg;	state Exp;
branches;
next	1.168;

1.168
date	2005.02.27.13.01.10;	author tg;	state Exp;
branches;
next	1.167;

1.167
date	2005.02.26.13.10.48;	author tg;	state Exp;
branches;
next	1.166;

1.166
date	2005.02.24.19.26.49;	author tg;	state Exp;
branches;
next	1.165;

1.165
date	2005.02.23.18.04.18;	author tg;	state Exp;
branches;
next	1.164;

1.164
date	2005.02.20.13.18.26;	author tg;	state Exp;
branches;
next	1.163;

1.163
date	2005.02.14.18.45.46;	author tg;	state Exp;
branches;
next	1.162;

1.162
date	2005.02.14.18.42.07;	author tg;	state Exp;
branches;
next	1.161;

1.161
date	2005.02.13.02.47.01;	author tg;	state Exp;
branches;
next	1.160;

1.160
date	2005.02.10.22.15.47;	author tg;	state Exp;
branches;
next	1.159;

1.159
date	2005.02.06.00.59.06;	author tg;	state Exp;
branches;
next	1.158;

1.158
date	2005.02.05.20.19.22;	author tg;	state Exp;
branches;
next	1.157;

1.157
date	2005.01.09.12.28.15;	author tg;	state Exp;
branches;
next	1.156;

1.156
date	2004.12.18.17.17.41;	author tg;	state Exp;
branches;
next	1.155;

1.155
date	2004.12.16.20.44.18;	author tg;	state Exp;
branches;
next	1.154;

1.154
date	2004.12.16.19.42.31;	author tg;	state Exp;
branches;
next	1.153;

1.153
date	2004.12.15.20.55.48;	author tg;	state Exp;
branches;
next	1.152;

1.152
date	2004.12.07.16.25.22;	author tg;	state Exp;
branches;
next	1.151;

1.151
date	2004.12.07.15.59.13;	author tg;	state Exp;
branches;
next	1.150;

1.150
date	2004.12.07.15.37.46;	author tg;	state Exp;
branches;
next	1.149;

1.149
date	2004.12.01.16.41.05;	author tg;	state Exp;
branches;
next	1.148;

1.148
date	2004.11.21.18.59.59;	author tg;	state Exp;
branches;
next	1.147;

1.147
date	2004.11.18.16.17.04;	author tg;	state Exp;
branches;
next	1.146;

1.146
date	2004.11.05.21.17.02;	author tg;	state Exp;
branches;
next	1.145;

1.145
date	2004.10.23.16.51.46;	author tg;	state Exp;
branches;
next	1.144;

1.144
date	2004.10.22.10.34.06;	author tg;	state Exp;
branches;
next	1.143;

1.143
date	2004.10.22.08.44.01;	author tg;	state Exp;
branches;
next	1.142;

1.142
date	2004.10.16.15.28.32;	author tg;	state Exp;
branches;
next	1.141;

1.141
date	2004.10.08.04.43.40;	author tg;	state Exp;
branches;
next	1.140;

1.140
date	2004.10.08.04.42.22;	author tg;	state Exp;
branches;
next	1.139;

1.139
date	2004.10.08.04.41.22;	author tg;	state Exp;
branches;
next	1.138;

1.138
date	2004.10.08.03.01.23;	author tg;	state Exp;
branches;
next	1.137;

1.137
date	2004.10.08.02.56.56;	author tg;	state Exp;
branches;
next	1.136;

1.136
date	2004.10.08.02.55.31;	author tg;	state Exp;
branches;
next	1.135;

1.135
date	2004.10.08.02.53.52;	author tg;	state Exp;
branches;
next	1.134;

1.134
date	2004.10.08.02.52.30;	author tg;	state Exp;
branches;
next	1.133;

1.133
date	2004.09.17.14.43.49;	author tg;	state Exp;
branches;
next	1.132;

1.132
date	2004.09.15.21.55.15;	author tg;	state Exp;
branches;
next	1.131;

1.131
date	2004.09.15.11.00.46;	author tg;	state Exp;
branches;
next	1.130;

1.130
date	2004.09.12.11.50.34;	author tg;	state Exp;
branches;
next	1.129;

1.129
date	2004.09.10.21.45.10;	author tg;	state Exp;
branches;
next	1.128;

1.128
date	2004.09.07.16.51.55;	author tg;	state Exp;
branches;
next	1.127;

1.127
date	2004.09.07.16.37.55;	author tg;	state Exp;
branches;
next	1.126;

1.126
date	2004.09.07.09.46.43;	author tg;	state Exp;
branches;
next	1.125;

1.125
date	2004.09.07.09.44.49;	author tg;	state Exp;
branches;
next	1.124;

1.124
date	2004.09.07.08.13.29;	author tg;	state Exp;
branches;
next	1.123;

1.123
date	2004.08.23.08.20.31;	author tg;	state Stab;
branches;
next	1.122;

1.122
date	2004.08.23.08.08.37;	author tg;	state Exp;
branches;
next	1.121;

1.121
date	2004.08.23.07.48.08;	author tg;	state Exp;
branches;
next	1.120;

1.120
date	2004.08.21.17.08.02;	author tg;	state Exp;
branches;
next	1.119;

1.119
date	2004.08.21.16.04.35;	author tg;	state Exp;
branches;
next	1.118;

1.118
date	2004.08.21.16.02.26;	author tg;	state Exp;
branches;
next	1.117;

1.117
date	2004.08.10.03.08.52;	author tg;	state Exp;
branches;
next	1.116;

1.116
date	2004.07.22.22.20.11;	author tg;	state Exp;
branches;
next	1.115;

1.115
date	2004.07.21.09.49.25;	author tg;	state Exp;
branches;
next	1.114;

1.114
date	2004.07.21.09.31.48;	author tg;	state Exp;
branches;
next	1.113;

1.113
date	2004.07.05.20.25.49;	author tg;	state Exp;
branches;
next	1.112;

1.112
date	2004.07.04.17.42.41;	author tg;	state Exp;
branches;
next	1.111;

1.111
date	2004.07.02.17.52.22;	author tg;	state Exp;
branches;
next	1.110;

1.110
date	2004.07.02.17.16.19;	author tg;	state Exp;
branches;
next	1.109;

1.109
date	2004.06.29.19.22.57;	author tg;	state Exp;
branches;
next	1.108;

1.108
date	2004.06.29.19.20.56;	author tg;	state Exp;
branches;
next	1.107;

1.107
date	2004.06.28.17.47.25;	author tg;	state Exp;
branches;
next	1.106;

1.106
date	2004.06.19.20.28.45;	author tg;	state Exp;
branches;
next	1.105;

1.105
date	2004.06.15.15.55.44;	author tg;	state Exp;
branches;
next	1.104;

1.104
date	2004.06.11.23.14.09;	author tg;	state Exp;
branches;
next	1.103;

1.103
date	2004.06.09.19.39.23;	author tg;	state Exp;
branches;
next	1.102;

1.102
date	2004.06.03.13.30.33;	author tg;	state Exp;
branches;
next	1.101;

1.101
date	2004.06.01.21.41.05;	author tg;	state Exp;
branches;
next	1.100;

1.100
date	2004.05.23.21.34.23;	author tg;	state Exp;
branches;
next	1.99;

1.99
date	2004.05.02.19.21.55;	author tg;	state Exp;
branches;
next	1.98;

1.98
date	2004.04.09.23.05.41;	author tg;	state Exp;
branches;
next	1.97;

1.97
date	2004.04.09.21.56.26;	author tg;	state Exp;
branches;
next	1.96;

1.96
date	2004.04.07.18.14.01;	author tg;	state Exp;
branches;
next	1.95;

1.95
date	2004.03.21.00.42.29;	author tg;	state Exp;
branches;
next	1.94;

1.94
date	2004.03.19.23.37.19;	author tg;	state Exp;
branches;
next	1.93;

1.93
date	2004.03.19.23.29.31;	author tg;	state Exp;
branches;
next	1.92;

1.92
date	2004.03.13.22.05.01;	author tg;	state Exp;
branches;
next	1.91;

1.91
date	2004.03.13.14.41.13;	author tg;	state Exp;
branches;
next	1.90;

1.90
date	2004.03.13.14.19.55;	author tg;	state Exp;
branches;
next	1.89;

1.89
date	2004.03.09.22.27.21;	author tg;	state Exp;
branches;
next	1.88;

1.88
date	2004.03.09.18.14.14;	author tg;	state Exp;
branches;
next	1.87;

1.87
date	2004.03.06.22.19.25;	author tg;	state Exp;
branches;
next	1.86;

1.86
date	2004.03.06.22.15.47;	author tg;	state Exp;
branches;
next	1.85;

1.85
date	2004.03.04.09.20.47;	author tg;	state Exp;
branches;
next	1.84;

1.84
date	2004.03.02.10.42.20;	author tg;	state Exp;
branches;
next	1.83;

1.83
date	2004.02.28.14.45.08;	author tg;	state Exp;
branches;
next	1.82;

1.82
date	2004.02.27.00.09.56;	author tg;	state Exp;
branches;
next	1.81;

1.81
date	2004.02.25.18.18.04;	author tg;	state Exp;
branches;
next	1.80;

1.80
date	2004.02.25.17.36.21;	author tg;	state Exp;
branches;
next	1.79;

1.79
date	2004.02.25.15.31.33;	author tg;	state Exp;
branches;
next	1.78;

1.78
date	2004.02.25.14.29.16;	author tg;	state Exp;
branches;
next	1.77;

1.77
date	2004.02.22.23.35.37;	author tg;	state Exp;
branches;
next	1.76;

1.76
date	2004.02.21.21.31.14;	author tg;	state Exp;
branches;
next	1.75;

1.75
date	2004.02.19.19.59.29;	author tg;	state Exp;
branches;
next	1.74;

1.74
date	2004.02.19.19.55.34;	author tg;	state Exp;
branches;
next	1.73;

1.73
date	2004.02.15.02.09.06;	author tg;	state Exp;
branches;
next	1.72;

1.72
date	2004.02.15.01.11.44;	author tg;	state Exp;
branches;
next	1.71;

1.71
date	2004.02.15.01.05.26;	author tg;	state Exp;
branches;
next	1.70;

1.70
date	2004.02.15.00.43.14;	author tg;	state Exp;
branches;
next	1.69;

1.69
date	2004.02.14.21.19.04;	author tg;	state Exp;
branches;
next	1.68;

1.68
date	2004.02.12.20.38.19;	author tg;	state Exp;
branches;
next	1.67;

1.67
date	2004.02.11.14.10.30;	author tg;	state Exp;
branches;
next	1.66;

1.66
date	2004.02.09.20.28.30;	author tg;	state Exp;
branches;
next	1.65;

1.65
date	2004.02.03.16.57.13;	author tg;	state Exp;
branches;
next	1.64;

1.64
date	2004.01.31.19.20.11;	author tg;	state Exp;
branches;
next	1.63;

1.63
date	2004.01.29.21.21.11;	author tg;	state Exp;
branches;
next	1.62;

1.62
date	2004.01.29.17.19.54;	author tg;	state Exp;
branches;
next	1.61;

1.61
date	2004.01.27.18.09.15;	author tg;	state Exp;
branches;
next	1.60;

1.60
date	2004.01.27.17.37.32;	author tg;	state Exp;
branches;
next	1.59;

1.59
date	2004.01.27.17.27.28;	author tg;	state Exp;
branches;
next	1.58;

1.58
date	2004.01.27.17.02.59;	author tg;	state Exp;
branches;
next	1.57;

1.57
date	2004.01.19.16.23.32;	author tg;	state Exp;
branches;
next	1.56;

1.56
date	2004.01.19.16.19.24;	author tg;	state Exp;
branches;
next	1.55;

1.55
date	2004.01.18.12.18.58;	author tg;	state Exp;
branches;
next	1.54;

1.54
date	2004.01.17.01.02.34;	author tg;	state Exp;
branches;
next	1.53;

1.53
date	2004.01.16.18.48.29;	author tg;	state Exp;
branches;
next	1.52;

1.52
date	2004.01.16.00.10.49;	author tg;	state Exp;
branches;
next	1.51;

1.51
date	2004.01.14.19.37.54;	author tg;	state Exp;
branches;
next	1.50;

1.50
date	2004.01.11.16.18.56;	author tg;	state Exp;
branches;
next	1.49;

1.49
date	2004.01.01.17.00.45;	author tg;	state Exp;
branches;
next	1.48;

1.48
date	2003.12.31.15.54.28;	author tg;	state Exp;
branches;
next	1.47;

1.47
date	2003.12.31.15.53.09;	author tg;	state Exp;
branches;
next	1.46;

1.46
date	2003.12.31.15.51.14;	author tg;	state Exp;
branches;
next	1.45;

1.45
date	2003.12.28.22.08.56;	author tg;	state Exp;
branches;
next	1.44;

1.44
date	2003.12.28.20.45.05;	author tg;	state Exp;
branches;
next	1.43;

1.43
date	2003.12.28.01.01.20;	author tg;	state Exp;
branches;
next	1.42;

1.42
date	2003.12.03.19.44.23;	author tg;	state Exp;
branches;
next	1.41;

1.41
date	2003.12.03.19.29.33;	author tg;	state Exp;
branches;
next	1.40;

1.40
date	2003.11.17.16.19.00;	author tg;	state Exp;
branches;
next	1.39;

1.39
date	2003.11.16.16.11.45;	author tg;	state Exp;
branches;
next	1.38;

1.38
date	2003.11.11.19.49.13;	author tg;	state Exp;
branches;
next	1.37;

1.37
date	2003.11.11.19.47.37;	author tg;	state Exp;
branches;
next	1.36;

1.36
date	2003.11.11.19.16.57;	author tg;	state Exp;
branches;
next	1.35;

1.35
date	2003.11.10.16.49.04;	author tg;	state Exp;
branches;
next	1.34;

1.34
date	2003.11.06.21.26.07;	author tg;	state Exp;
branches;
next	1.33;

1.33
date	2003.11.06.13.33.09;	author wbx;	state Exp;
branches;
next	1.32;

1.32
date	2003.11.01.01.29.11;	author tg;	state Exp;
branches;
next	1.31;

1.31
date	2003.10.21.15.17.31;	author tg;	state Exp;
branches;
next	1.30;

1.30
date	2003.10.08.18.07.38;	author tg;	state Exp;
branches;
next	1.29;

1.29
date	2003.10.02.19.45.21;	author tg;	state Exp;
branches;
next	1.28;

1.28
date	2003.10.01.22.04.16;	author tg;	state Exp;
branches;
next	1.27;

1.27
date	2003.10.01.19.33.35;	author tg;	state Exp;
branches;
next	1.26;

1.26
date	2003.10.01.18.19.34;	author tg;	state Exp;
branches;
next	1.25;

1.25
date	2003.10.01.16.48.09;	author tg;	state Exp;
branches;
next	1.24;

1.24
date	2003.09.24.22.27.53;	author tg;	state Exp;
branches;
next	1.23;

1.23
date	2003.09.24.22.23.55;	author tg;	state Exp;
branches;
next	1.22;

1.22
date	2003.09.17.13.54.34;	author tg;	state Exp;
branches;
next	1.21;

1.21
date	2003.09.10.22.07.51;	author tg;	state Exp;
branches;
next	1.20;

1.20
date	2003.09.03.12.57.48;	author tg;	state Exp;
branches;
next	1.19;

1.19
date	2003.09.01.18.28.14;	author tg;	state Exp;
branches;
next	1.18;

1.18
date	2003.09.01.17.10.36;	author tg;	state Exp;
branches;
next	1.17;

1.17
date	2003.08.31.20.52.48;	author tg;	state Exp;
branches;
next	1.16;

1.16
date	2003.08.18.15.57.46;	author tg;	state Exp;
branches;
next	1.15;

1.15
date	2003.07.26.16.03.58;	author tg;	state Exp;
branches;
next	1.14;

1.14
date	2003.07.24.17.09.07;	author tg;	state Exp;
branches;
next	1.13;

1.13
date	2003.07.19.17.45.43;	author tg;	state Exp;
branches;
next	1.12;

1.12
date	2003.07.19.14.17.57;	author tg;	state Exp;
branches;
next	1.11;

1.11
date	2003.07.15.13.57.00;	author tg;	state Exp;
branches;
next	1.10;

1.10
date	2003.07.15.12.07.26;	author tg;	state Exp;
branches;
next	1.9;

1.9
date	2003.07.15.11.54.13;	author tg;	state Exp;
branches;
next	1.8;

1.8
date	2003.07.09.18.59.26;	author tg;	state Exp;
branches;
next	1.7;

1.7
date	2003.07.07.14.38.15;	author tg;	state Exp;
branches;
next	1.6;

1.6
date	2003.05.22.13.28.24;	author tg;	state Exp;
branches;
next	1.5;

1.5
date	2003.04.10.20.09.15;	author tg;	state Exp;
branches;
next	1.4;

1.4
date	2003.04.08.17.07.37;	author tg;	state Exp;
branches;
next	1.3;

1.3
date	2003.03.23.15.44.06;	author tg;	state Exp;
branches;
next	1.2;

1.2
date	2003.03.23.14.56.58;	author tg;	state Exp;
branches;
next	1.1;

1.1
date	2003.03.22.19.51.19;	author tg;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2003.03.22.19.51.19;	author tg;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2003.04.10.14.07.30;	author tg;	state Exp;
branches;
next	1.1.1.3;

1.1.1.3
date	2003.05.21.18.21.37;	author tg;	state Exp;
branches;
next	1.1.1.4;

1.1.1.4
date	2003.07.09.16.01.28;	author tg;	state Exp;
branches;
next	1.1.1.5;

1.1.1.5
date	2003.07.15.12.40.42;	author tg;	state Exp;
branches;
next	1.1.1.6;

1.1.1.6
date	2003.07.19.17.02.15;	author tg;	state Exp;
branches;
next	1.1.1.7;

1.1.1.7
date	2003.07.26.13.40.49;	author tg;	state Exp;
branches;
next	1.1.1.8;

1.1.1.8
date	2003.08.17.13.19.48;	author tg;	state Exp;
branches;
next	1.1.1.9;

1.1.1.9
date	2003.08.22.15.25.13;	author tg;	state Exp;
branches;
next	1.1.1.10;

1.1.1.10
date	2003.08.30.21.22.14;	author tg;	state Exp;
branches;
next	1.1.1.11;

1.1.1.11
date	2003.10.02.10.42.58;	author tg;	state Exp;
branches;
next	1.1.1.12;

1.1.1.12
date	2003.12.02.18.47.15;	author tg;	state Exp;
branches;
next	1.1.1.13;

1.1.1.13
date	2004.01.14.15.41.31;	author tg;	state Exp;
branches;
next	1.1.1.14;

1.1.1.14
date	2004.01.18.12.17.32;	author tg;	state Exp;
branches;
next	1.1.1.15;

1.1.1.15
date	2004.01.26.17.47.36;	author bsiegert;	state Exp;
branches;
next	1.1.1.16;

1.1.1.16
date	2004.02.21.17.04.41;	author bsiegert;	state Exp;
branches;
next	1.1.1.17;

1.1.1.17
date	2004.05.28.16.47.43;	author bsiegert;	state Exp;
branches;
next	1.1.1.18;

1.1.1.18
date	2004.06.01.20.33.03;	author tg;	state Exp;
branches;
next	1.1.1.19;

1.1.1.19
date	2004.06.09.19.27.05;	author tg;	state Exp;
branches;
next	;


desc
@@


1.180
log
@remove
- support for DYNLIBDIR
- support for NEWDYNLIBDIR
- ldconfig sed scripts, now done by pkg_create

this simplifies the generation, too

agreed bsiegert@@:
<benz> mira: ich patche jetzt alle DYNLIBDIRs raus
@
text
@# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.179 2005/03/10 20:50:30 tg Exp $
# $OpenBSD: bsd.port.mk,v 1.677 2005/01/06 19:30:34 espie Exp $
# $FreeBSD: bsd.port.mk,v 1.264 1996/12/25 02:27:44 imp Exp $
# $NetBSD: bsd.port.mk,v 1.62 1998/04/09 12:47:02 hubertf Exp $
#-
# This is the MirPorts Framework master system Makefile. It provides
# an infrastructure to be used within the framework by every port.
#
# Each port has a maintainer, which is the email address(es) of the person(s)
# to contact if you have questions/suggestions about that specific port.
# To obtain that address, just type
#	make show=RESPONSIBLE
# in the specific port's directory.
#
# For the MirPorts Framework, the master contact address is the mailing list:
#	make show=_MIRPORTS_ADDRESS

# Any variable or target starting with an underscore (e.g., _DEPEND_ECHO)
# is internal to bsd.port.mk, not part of the user's API, and liable to
# change without notice.

.if ${.MAKEFLAGS:MFLAVOR=*}
ERRORS+=		"Use 'env FLAVOR=${FLAVOR:Q} ${MAKE}' instead."
.endif
.if ${.MAKEFLAGS:MSUBPACKAGE=*}
ERRORS+=		"Use 'env SUBPACKAGE=${SUBPACKAGE:Q} ${MAKE}' instead."
.endif

# Default sequence for "all" is:  fetch checksum extract patch configure build
#
# Please read the comments in the targets section below, you
# should be able to use the pre-* or post-* targets (which
# are available for every stage except checksum) or provide
# an overriding do-* target to do pretty much anything you
# want.
#
# For historical reasons, the distpatch target is a subtarget of patch.
# If you provide a do-patch, you MUST call distpatch explicitly.
# The sequence of hooks actually run is:
#
# pre-patch 'real distpatch' post-distpatch 'real patch' post-patch

# User settings
TRUST_PACKAGES?=	No
BIN_PACKAGES?=		No
CLEANDEPENDS?=		No
BULK?=			No
RECURSIVE_FETCH_LIST?=	Yes
WRKOBJDIR?=
FAKEOBJDIR?=
BULK_TARGETS?=

# special purpose user settings
PATCH_CHECK_ONLY?=	No
REFETCH?=		false

# Global path locations.
DISTDIR?=		${PORTSDIR}/distfiles
BULK_COOKIES_DIR?=	${PORTSDIR}/bulk/${MACHINE_ARCH}
TEMPLATES?=		${PORTSDIR}/infrastructure/templates
TMPDIR?=		/tmp

PKGREPOSITORYBASE?=	${PORTSDIR}/packages/${MACHINE_ARCH}
PKGREPOSITORY?=		${PKGREPOSITORYBASE}/all
CDROM_PACKAGES?=	${PKGREPOSITORYBASE}/cdrom
FTP_PACKAGES?=		${PKGREPOSITORYBASE}/ftp

WRKOBJDIR_${PKGPATH}?=		${WRKOBJDIR}
FAKEOBJDIR_${PKGPATH}?=		${FAKEOBJDIR}
BULK_${PKGPATH}?=		${BULK}
BULK_TARGETS_${PKGPATH}?=	${BULK_TARGETS}
CLEANDEPENDS_${PKGPATH}?=	${CLEANDEPENDS}

# Commands and command settings.
PKG_DBDIR?=		/var/db/pkg
PKG_TMPDIR?=		/var/tmp
PKG_CMDDIR?=		/usr/sbin
PKG_CMD_ADD?=		${PKG_CMDDIR}/pkg_add
PKG_CMD_CREATE?=	${PKG_CMDDIR}/pkg_create
PKG_CMD_DELETE?=	${PKG_CMDDIR}/pkg_delete
PKG_CMD_INFO?=		${PKG_CMDDIR}/pkg_info
PKG_CMD_PKG?=		${PKG_CMDDIR}/pkg

.if ${MACHINE_ARCH} != ${ARCH}
PKG_ARCH?=		${MACHINE_ARCH},${ARCH}
.else
PKG_ARCH?=		${MACHINE_ARCH}
.endif

# remount those mount points ro before fake.
# XXX tends to panic the OS
PROTECT_MOUNT_POINTS?=

.if exists(${.CURDIR}/../Makefile.inc)
.  include "${.CURDIR}/../Makefile.inc"
.endif

.if !defined(PERMIT_PACKAGE_CDROM) || !defined(PERMIT_PACKAGE_FTP) || \
  !defined(PERMIT_DISTFILES_CDROM) || !defined(PERMIT_DISTFILES_FTP)
ERRORS+=		"The licencing info for ${FULLPKGNAME} is incomplete."
ERRORS+=		"Please notify the MirPorts maintainer:"
ERRORS+=		"    ${RESPONSIBLE}"
_BAD_LICENSING=		Yes
PERMIT_PACKAGE_CDROM=	No
PERMIT_DISTFILES_CDROM=	No
PERMIT_PACKAGE_FTP=	No
PERMIT_DISTFILES_FTP=	No
.endif

# CDROM should be FTP exportable!
.if ${PERMIT_PACKAGE_CDROM:L} == "yes" && ${PERMIT_PACKAGE_FTP:L} != "yes"
ERRORS+=		"Package is marked as permit CDROM but not FTP."
.endif
.if ${PERMIT_DISTFILES_CDROM:L} == "yes" && ${PERMIT_DISTFILES_FTP:L} != "yes"
ERRORS+=		"Distfiles are marked as permit CDROM but not FTP."
.endif


.if defined(show)
.MAIN: show
show:
.  for _s in ${show}
	@@echo ${${_s}:Q}
.  endfor
.elif defined(clean)
.MAIN: clean
.else
.MAIN: all
.endif

FAKE?=			Yes
_LIBLIST=		${WRKDIR}/.liblist-${ARCH}${_FLAVOR_EXT2}
_BUILDLIBLIST=		${WRKDIR}/.buildliblist-${ARCH}${_FLAVOR_EXT2}

# need to go through an extra var because clean is set in stone,
# on the cmdline.
_clean=			${clean}
.if ${_clean:L:Mpackage} || ${_clean:L:Mpackages}
CLEANDEPENDS=		No
.endif
.if empty(_clean) || ${_clean:L} == "depends"
_clean+=		work
.endif
.if ${CLEANDEPENDS_${PKGPATH}:L} == "yes"
_clean+=		depends
.endif
.if ${_clean:L:Mwork}
_clean+=		fake
.endif
.if ${_clean:L:Mforce}
_clean+=		-f
.endif
# check that clean is clean
_okay_words=		-f bulk depends dist fake flavors force install \
			package packages readme sub work
.for _w in ${_clean:L}
.  if !${_okay_words:M${_w}}
ERRORS+=		"Fatal: unknown clean command: ${_w}"
.  endif
.endfor

NOMANCOMPRESS?=		Yes
DEF_UMASK?=		022

.if exists(${.CURDIR}/Makefile.${ARCH})
.  include "${.CURDIR}/Makefile.${ARCH}"
.elif exists(${.CURDIR}/Makefile.${MACHINE_ARCH})
.  include "${.CURDIR}/Makefile.${MACHINE_ARCH}"
.endif

NO_DEPENDS?=		No
NO_BUILD?=		No
NO_REGRESS?=		No
DIST_SUBDIR?=

.if !empty(DIST_SUBDIR)
FULLDISTDIR?=		${DISTDIR}/${DIST_SUBDIR}
.else
FULLDISTDIR?=		${DISTDIR}
.endif

.if exists(${.CURDIR}/patches.${ARCH})
PATCHDIR?=		${.CURDIR}/patches.${ARCH}
.elif exists(${.CURDIR}/patches.${MACHINE_ARCH})
PATCHDIR?=		${.CURDIR}/patches.${MACHINE_ARCH}
.else
PATCHDIR?=		${.CURDIR}/patches
.endif

PATCH_LIST?=		patch-*

.if exists(${.CURDIR}/scripts.${ARCH})
SCRIPTDIR?=		${.CURDIR}/scripts.${ARCH}
.elif exists(${.CURDIR}/scripts.${MACHINE_ARCH})
SCRIPTDIR?=		${.CURDIR}/scripts.${MACHINE_ARCH}
.else
SCRIPTDIR?=		${.CURDIR}/scripts
.endif

.if exists(${.CURDIR}/files.${ARCH})
FILESDIR?=		${.CURDIR}/files.${ARCH}
.elif exists(${.CURDIR}/files.${MACHINE_ARCH})
FILESDIR?=		${.CURDIR}/files.${MACHINE_ARCH}
.else
FILESDIR?=		${.CURDIR}/files
.endif

.if exists(${.CURDIR}/pkg.${ARCH})
PKGDIR?=		${.CURDIR}/pkg.${ARCH}
.elif exists(${.CURDIR}/pkg.${MACHINE_ARCH})
PKGDIR?=		${.CURDIR}/pkg.${MACHINE_ARCH}
.else
PKGDIR?=		${.CURDIR}/pkg
.endif

PREFIX?=		${LOCALBASE}
TRUEPREFIX?=		${PREFIX}
DESTDIRNAME?=		DESTDIR
DESTDIR?=		${WRKINST}
P5SITE=			libdata/perl5/site_perl
P5ARCH=			${P5SITE}/${MACHINE_ARCH}-${OSname}

MAKE_FLAGS?=
.if !defined(FAKE_FLAGS)
FAKE_FLAGS=		${DESTDIRNAME}='${WRKINST}'
.endif

EXTRA_XAKE_FLAGS+=	SHELL="${SHELL}"
MAKE_FLAGS+=		${EXTRA_MAKE_FLAGS} ${EXTRA_XAKE_FLAGS}
FAKE_FLAGS+=		${EXTRA_FAKE_FLAGS} ${EXTRA_XAKE_FLAGS}

CONFIGURE_STYLE?=

# where configuration files should go
SYSCONFDIR?=		/etc
.if ${USE_GMAKE:L} == "yes" || ${USE_SCHILY:L} != "no"
BUILD_DEPENDS+=		::devel/gmake
MAKE_PROGRAM=		${GMAKE}
MAKE_FLAGS+=		MAKE=$(MAKE_PROGRAM)
FAKE_FLAGS+=		MAKE=$(MAKE_PROGRAM)
.  if ${USE_SCHILY:L} != "no"
MAKE_ENV+=		MAKEPROG='${MAKE_PROGRAM}' CCOM=cc
.  endif
.else
MAKE_PROGRAM=		${MAKE}
.endif

.if ${CONFIGURE_STYLE:L:Mautomake} || ${CONFIGURE_STYLE:L:Mautoconf} \
    || ${CONFIGURE_STYLE:L:Mautoupdate} || ${CONFIGURE_STYLE:L:Mautogen}
.  if !${CONFIGURE_STYLE:L:Mgnu}
CONFIGURE_STYLE+=	gnu
.  endif
.endif

SUBPACKAGE?=
FLAVOR?=
FLAVORS?=
PSEUDO_FLAVORS?=
FLAVORS+=		${PSEUDO_FLAVORS}

.if !empty(FLAVORS:L:Mregress) && empty(FLAVOR:L:Mregress)
NO_REGRESS=		Yes
.endif

.if ${USE_MOTIF:L} != "no"
.  if ${USE_MOTIF:L} == "lesstif"
LIB_DEPENDS+=		Xm.1::x11/lesstif
.  elif ${USE_MOTIF:L} == "openmotif"
LIB_DEPENDS+=		Xm.2::x11/openmotif
.  elif ${USE_MOTIF:L} == "any" || ${USE_MOTIF:L} == "yes"
FLAVORS+=		lesstif
.    if ${FLAVOR:L:Mlesstif} && ${FLAVOR:L:Mmotif}
ERRORS+=		"Choose motif or lesstif, not both."
.    endif
.    if ${FLAVOR:L:Mlesstif}
LIB_DEPENDS+=		Xm.1::x11/lesstif
.    else
LIB_DEPENDS+=		Xm.2::x11/openmotif
.    endif
.  elif ${USE_MOTIF:L} != "transparent"
ERRORS+=		"Unknown USE_MOTIF=${USE_MOTIF:Q} settings."
.  endif
MOTIFLIB=		-L${LOCALBASE}/lib -lXm
MAKE_ENV+=		MOTIFLIB='${MOTIFLIB}'
.endif

.if !empty(SUBPACKAGE)
.  for _i in ${SUBPACKAGE}
.    if !defined(MULTI_PACKAGES) || empty(MULTI_PACKAGES:M${_i})
ERRORS+=		"Subpackage ${SUBPACKAGE} does not exist."
.    endif
.  endfor
.endif

# Support architecture and flavor dependent packing lists
SED_PLIST?=

# Build FLAVOR_EXT, checking that no flavors are misspelled
FLAVOR_EXT:=
# _FLAVOR_EXT2 is used internally for working directories.
# It encodes flavors and pseudo-flavors.
_FLAVOR_EXT2:=

# Create the basic sed substitution pipeline for fragments
# (applies only to PLIST for now)
.if !empty(FLAVORS)
.  for _i in ${FLAVORS:L}
.    if empty(FLAVOR:L:M${_i})
SED_PLIST+=	|sed \
		-e '/^!%%${_i}%%$$/r${PKGDIR}/PFRAG.no-${_i}${SUBPACKAGE}' \
		-e '//d' \
		-e '/^%%${_i}%%$$/d'
.    else
_FLAVOR_EXT2:=	${_FLAVOR_EXT2}-${_i}
.    if empty(PSEUDO_FLAVORS:L:M${_i})
FLAVOR_EXT:=	${FLAVOR_EXT}-${_i}
.    endif
SED_PLIST+=	|sed \
		-e '/^!%%${_i}%%$$/d' \
		-e '/^%%${_i}%%$$/r${PKGDIR}/PFRAG.${_i}${SUBPACKAGE}' \
		-e '//d'
.    endif
.  endfor
.endif

.if !empty(FLAVORS:M[0-9]*)
ERRORS+=		"Flavour cannot start with a digit."
.endif

.if !empty(FLAVOR)
.  if !empty(FLAVORS)
.    for _i in ${FLAVOR:L}
.      if empty(FLAVORS:L:M${_i})
ERRORS+=		"Unknown flavour: ${_i}"
ERRORS+=		"Possible flavours are: ${FLAVORS}"
.      endif
.    endfor
.  else
ERRORS+=		"No flavours for this port."
.  endif
.endif

.if ${MIRBSD_PKGTOOLS:L} == "no"
PKG_ARGS_ADD+=		-A${PKG_ARCH:Q}
.  if ${LOCALBASE} != "/usr/local"
PKG_ARGS_ADD+=		-L${LOCALBASE}
.  endif
.endif
PKGNAME?=		${DISTNAME}
FULLPKGNAME?=		${PKGNAME}${FLAVOR_EXT}
PKGFILE=		${PKGREPOSITORY}/${FULLPKGNAME}${PKG_SUFX}
_MASTER?=

.if defined(MULTI_PACKAGES) && !empty(MULTI_PACKAGES)
.  for _s in ${MULTI_PACKAGES}
.    if !defined(FULLPKGNAME${_s})
.      if defined(PKGNAME${_s})
FULLPKGNAME${_s} =	${PKGNAME${_s}}${FLAVOR_EXT}
.      else
FULLPKGNAME${_s} =	${PKGNAME}${_s}${FLAVOR_EXT}
.      endif
.    endif
PKGFILE${_s} =		${PKGREPOSITORY}/${FULLPKGNAME${_s}}${PKG_SUFX}
.  endfor
.endif

_SYSTRACE_COOKIE=	${WRKDIR}/systrace.policy
_WRKDIR_COOKIE=		${WRKDIR}/.extract_started
_EXTRACT_COOKIE=	${WRKDIR}/.extract_done
_PATCH_COOKIE=		${WRKDIR}/.patch_done
_DISTPATCH_COOKIE=	${WRKDIR}/.distpatch_done
_PREPATCH_COOKIE=	${WRKDIR}/.prepatch_done
_INSTALL_COOKIE=	${PKG_DBDIR}/${FULLPKGNAME${SUBPACKAGE}}/+CONTENTS
_BULK_COOKIE=		${BULK_COOKIES_DIR}/${FULLPKGNAME}
.if ${FAKE:L} == "yes"
_FAKE_COOKIE=		${WRKINST}/.fake_done
_INSTALL_PRE_COOKIE=	${WRKINST}/.install_started
.elif defined(SEPARATE_BUILD)
_INSTALL_PRE_COOKIE=	${WRKBUILD}/.install_started
.else
_INSTALL_PRE_COOKIE=	${WRKDIR}/.install_started
_FAKE_COOKIE=		${WRKDIR}/.fake_done
.endif
_PACKAGE_COOKIE=	${PKGFILE}
.if defined(SEPARATE_BUILD)
_CONFIGURE_COOKIE=	${WRKBUILD}/.configure_done
_BUILD_COOKIE=		${WRKBUILD}/.build_done
_REGRESS_COOKIE=	${WRKBUILD}/.regress_done
.else
_CONFIGURE_COOKIE=	${WRKDIR}/.configure_done
_BUILD_COOKIE=		${WRKDIR}/.build_done
_REGRESS_COOKIE=	${WRKDIR}/.regress_done
.endif

_ALL_COOKIES=		${_EXTRACT_COOKIE} ${_PATCH_COOKIE} \
			${_CONFIGURE_COOKIE} ${_INSTALL_PRE_COOKIE} \
			${_BUILD_COOKIE} ${_REGRESS_COOKIE} \
			${_PACKAGE_COOKIES} ${_DISTPATCH_COOKIE} \
			${_PREPATCH_COOKIE} ${_FAKE_COOKIE} \
			${_WRKDIR_COOKIE} ${_DEPlib_COOKIES} \
			${_DEPbuild_COOKIES} ${_DEPrun_COOKIES} \
			${_DEPregress_COOKIES}

_MAKE_COOKIE=		touch -f

# Miscellaneous overridable commands:
GMAKE?=			gmake

CHECKSUM_FILE?=		${.CURDIR}/distinfo

# Don't touch!!! Used for generating checksums.
_CIPHERS=		rmd160 sha512 sha1 md5

_PORTPATH?=		${WRKDIR}/bin:/usr/bin:/bin:/usr/sbin:/sbin:${LOCALBASE}/bin:${X11BASE}/bin
PORTPATH?=		${_PORTPATH}

# Add any COPTS to CFLAGS.
CPPFLAGS+=		-idirafter ${LOCALBASE}/include
CFLAGS+=		${COPTS} ${CPPFLAGS}
CXXFLAGS+=		${CXXOPTS} ${CPPFLAGS}
.if defined(WARNINGS) && ${WARNINGS:L} == "yes"
.  if defined(CDIAGFLAGS)
CFLAGS+=		${CDIAGFLAGS}
.  endif
.  if defined(CXXDIAGFLAGS)
CXXFLAGS+=		${CXXDIAGFLAGS}
.  endif
.endif
LDFLAGS+=		-L${LOCALBASE}/lib ${LDSTATIC}
.if ${OStype} == "MirBSD" && ${_CC_IS_GCC:M3.4*}
CFLAGS+=		-Werror-maybe-reset
CXXFLAGS+=		-Werror-maybe-reset
.endif

NO_CXX?=		No	# inhibit use of C++ ports
.if ${USE_CXX:L} == "yes"
.  if ${NO_CXX:L} == "yes"
NO_CXX=			C++ is explicitly disabled
.  elif ${HAS_CXX:L} == "base"
CXX?=			g++
NO_CXX=			No
.  elif ${HAS_CXX:L} == "port"
BUILD_DEPENDS+=		${_CXX_BR_DEPENDS}
LIB_DEPENDS+=		${_CXX_LIB_DEPENDS}
RUN_DEPENDS+=		${_CXX_BR_DEPENDS}
NO_CXX=			No
.  else
NO_CXX=			C++ is not supported on this system
.  endif
CONFIGURE_ENV+=		CXX='${CXX}'
MAKE_ENV+=		CXX='${CXX}'
.endif

MAKE_FILE?=		Makefile
PORTHOME?=		/${PKGNAME}_writes_to_HOME

MAKE_ENV+=		HOME='${PORTHOME}' PATH='${PORTPATH}' \
			PREFIX='${PREFIX}' TRUEPREFIX='${PREFIX}' \
			LOCALBASE='${LOCALBASE}' X11BASE='${X11BASE}' \
			CC='${CC}' CFLAGS='${CFLAGS:C/ *$//}' \
			LDFLAGS='${LDFLAGS}' ${DESTDIRNAME}= \
			EXTRA_SYS_MK_INCLUDES="<bsd.own.mk>"

DISTORIG?=		.bak.orig
PATCH?=			/usr/bin/patch
PATCHORIG?=		.orig
PATCH_STRIP?=		-p0
PATCH_DIST_STRIP?=	-p0

PATCH_DEBUG?=		No
.if ${PATCH_DEBUG:L} != "no"
PATCH_ARGS?=		-d ${WRKDIST} -z ${PATCHORIG} -E ${PATCH_STRIP}
PATCH_DIST_ARGS?=	-z ${DISTORIG} -d ${WRKDIST} -E ${PATCH_DIST_STRIP}
.else
PATCH_ARGS?=		-d ${WRKDIST} -z ${PATCHORIG} --forward --quiet -E ${PATCH_STRIP}
PATCH_DIST_ARGS?=	-z ${DISTORIG} -d ${WRKDIST} --forward --quiet -E ${PATCH_DIST_STRIP}
.endif

.if ${PATCH_CHECK_ONLY:L} == "yes"
PATCH_ARGS+=		-C
PATCH_DIST_ARGS+=	-C
.endif

TAR?=			/bin/tar
UNZIP?=			unzip
BZIP2?=			bzip2

.if !empty(FAKEOBJDIR_${PKGPATH})
WRKINST?=		${FAKEOBJDIR_${PKGPATH}}/${PKGNAME}${_FLAVOR_EXT2}
.else
WRKINST?=		${WRKDIR}/fake-${ARCH}${_FLAVOR_EXT2}
.endif

.if !empty(WRKOBJDIR_${PKGPATH})
.  if defined(SEPARATE_BUILD) && ${SEPARATE_BUILD:L:Mflavored}
WRKDIR?=		${WRKOBJDIR_${PKGPATH}}/${PKGNAME}
.  else
WRKDIR?=		${WRKOBJDIR_${PKGPATH}}/${PKGNAME}${_FLAVOR_EXT2}
.  endif
.else
.  if defined(SEPARATE_BUILD) && ${SEPARATE_BUILD:L:Mflavored}
WRKDIR?=		${.CURDIR}/w-${PKGNAME}
.  else
WRKDIR?=		${.CURDIR}/w-${PKGNAME}${_FLAVOR_EXT2}
.  endif
.endif

WRKDIST?=		${WRKDIR}/${DISTNAME}
WRKSRC?=		${WRKDIST}

.if defined(SEPARATE_BUILD)
WRKBUILD?=		${WRKDIR}/build-${MACHINE_ARCH}${_FLAVOR_EXT2}
WRKPKG?=		${WRKBUILD}/pkg
.else
WRKBUILD?=		${WRKSRC}
WRKPKG?=		${WRKDIR}/pkg
.endif
WRKCONF?=		${WRKBUILD}

ALL_TARGET?=		all
INSTALL_TARGET?=	install
FAKE_TARGET?=		${INSTALL_TARGET}

.for _i in perl gnu imake
.  if ${CONFIGURE_STYLE:L:M${_i}}
MODULES+=		${_i}
.  endif
.endfor

.if defined(MODULES)
_MODULES_DONE=
.  include "${PORTSDIR}/infrastructure/mk/modules.port.mk"
.endif

###
### Variable setup that can happen after modules
###

REGRESS_TARGET?=	regress
REGRESS_FLAGS?=		${MAKE_FLAGS}

.if ${FAKE:L} == "yes"
_PACKAGE_COOKIE_DEPS=	${_FAKE_COOKIE}
.else
_PACKAGE_COOKIE_DEPS=	${_INSTALL_COOKIE}
.endif

_PACKAGE_COOKIES=	${_PACKAGE_COOKIE}
.if ${BIN_PACKAGES:L} == "yes"
${_PACKAGE_COOKIE}:
	@@cd ${.CURDIR} && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS}
.else
${_PACKAGE_COOKIE}: ${_PACKAGE_COOKIE_DEPS}
.endif
	@@cd ${.CURDIR} && SUBPACKAGE='' FLAVOR='${FLAVOR}' PACKAGING='' exec ${MAKE} _package
.if !defined(PACKAGE_NOINSTALL)
	@@${_MAKE_COOKIE} $@@
.endif

.for _s in ${MULTI_PACKAGES}
_PACKAGE_COOKIE${_s} =	${PKGFILE${_s}}
_PACKAGE_COOKIES+=	${_PACKAGE_COOKIE${_s}}
.endfor

.if empty(SUBPACKAGE)
FULLPKGPATH=		${PKGPATH}${_FLAVOR_EXT2:S/-/,/g}
.else
FULLPKGPATH=		${PKGPATH},${SUBPACKAGE}${_FLAVOR_EXT2:S/-/,/g}
.endif

# A few aliases for *-install targets
INSTALL_PROGRAM=	${INSTALL} ${INSTALL_COPY} ${INSTALL_STRIP} \
			    -o ${BINOWN} -g ${BINGRP} -m ${BINMODE}
INSTALL_SCRIPT=		${INSTALL} ${INSTALL_COPY} \
			    -o ${BINOWN} -g ${BINGRP} -m ${BINMODE}
INSTALL_DATA=		${INSTALL} ${INSTALL_COPY} \
			    -o ${SHAREOWN} -g ${SHAREGRP} -m ${SHAREMODE}
INSTALL_MAN=		${INSTALL} ${INSTALL_COPY} \
			    -o ${MANOWN} -g ${MANGRP} -m ${MANMODE}

INSTALL_PROGRAM_DIR=	${INSTALL} -d -o ${BINOWN} -g ${BINGRP} -m ${DIRMODE}
INSTALL_SCRIPT_DIR=	${INSTALL_PROGRAM_DIR}
INSTALL_DATA_DIR=	${INSTALL} -d -o ${SHAREOWN} -g ${SHAREGRP} -m ${DIRMODE}
INSTALL_MAN_DIR=	${INSTALL} -d -o ${MANOWN} -g ${MANGRP} -m ${DIRMODE}

_INSTALL_MACROS=	BSD_INSTALL_PROGRAM="${INSTALL_PROGRAM}" \
			BSD_INSTALL_SCRIPT="${INSTALL_SCRIPT}" \
			BSD_INSTALL_DATA="${INSTALL_DATA}" \
			BSD_INSTALL_MAN="${INSTALL_MAN}" \
			BSD_INSTALL_PROGRAM_DIR="${INSTALL_PROGRAM_DIR}" \
			BSD_INSTALL_SCRIPT_DIR="${INSTALL_SCRIPT_DIR}" \
			BSD_INSTALL_DATA_DIR="${INSTALL_DATA_DIR}" \
			BSD_INSTALL_MAN_DIR="${INSTALL_MAN_DIR}"
MAKE_ENV+=		${_INSTALL_MACROS}
SCRIPTS_ENV+=		${_INSTALL_MACROS}

# setup systrace variables
NO_SYSTRACE?=		No
.if ${USE_SYSTRACE:L} == "yes" && ${NO_SYSTRACE:L} == "no"
_SYSTRACE_CMD?=		/bin/systrace ${SYSTRACE_ARGS_ADD} -i -a \
			    -f ${_SYSTRACE_COOKIE}
.else
_SYSTRACE_CMD=
.endif
SYSTRACE_FILTER?=	${PORTSDIR}/infrastructure/db/systrace.filter
_SYSTRACE_POLICIES+=	${SHELL} /usr/bin/env /usr/bin/make \
			    ${LOCALBASE}/bin/gmake
SYSTRACE_SUBST_VARS+=	DISTDIR PKG_TMPDIR PORTSDIR TMPDIR WRKDIR
.for _v in ${SYSTRACE_SUBST_VARS}
_SYSTRACE_SED_SUBST+=	-e 's,$${${_v}},${${_v}},g'
.endfor

# Create the generic variable substitution list, from subst vars
SUBST_VARS+=		MACHINE_ARCH ARCH HOMEPAGE PREFIX SYSCONFDIR \
			FLAVOR_EXT RESPONSIBLE
_SED_SUBST=		sed
.for _v in ${SUBST_VARS}
_SED_SUBST+=		-e 's|$${${_v}}|${${_v}}|g'
.endfor
_SED_SUBST+=		-e 's,$${FLAVORS},${FLAVOR_EXT},g' -e 's,$$\\,$$,g'
# and append it to the PLIST substitution pipeline
SED_PLIST+=		|${_SED_SUBST}

# find out the most appropriate PLIST source
.if !defined(PLIST) \
    && exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${ARCH})
PLIST=			${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${ARCH}
.elif !defined(PLIST) \
    && exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${MACHINE_ARCH})
PLIST=			${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${MACHINE_ARCH}
.endif
.if !defined(PLIST) && ${NO_SHARED_LIBS:L} == "yes" \
    && exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.noshared)
PLIST=			${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.noshared
.endif
.if !defined(PLIST) && exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT})
PLIST=			${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}
.endif
.if !defined(PLIST) && exists(${PKGDIR}/PLIST${SUBPACKAGE}.${ARCH})
PLIST=			${PKGDIR}/PLIST${SUBPACKAGE}.${ARCH}
.elif !defined(PLIST) && exists(${PKGDIR}/PLIST${SUBPACKAGE}.${MACHINE_ARCH})
PLIST=			${PKGDIR}/PLIST${SUBPACKAGE}.${MACHINE_ARCH}
.endif
.if !defined(PLIST) && ${NO_SHARED_LIBS:L} == "yes" \
    && exists(${PKGDIR}/PLIST${SUBPACKAGE}.noshared)
PLIST=			${PKGDIR}/PLIST${SUBPACKAGE}.noshared
.endif
PLIST?=			${PKGDIR}/PLIST${SUBPACKAGE}

# Likewise for DESCR/MESSAGE/COMMENT
.if defined(COMMENT${SUBPACKAGE}${FLAVOR_EXT})
_COMMENT=		${COMMENT${SUBPACKAGE}${FLAVOR_EXT}}
.elif defined(COMMENT${SUBPACKAGE})
_COMMENT=		${COMMENT${SUBPACKAGE}}
.endif

.if exists(${PKGDIR}/MESSAGE${SUBPACKAGE})
MESSAGE?=		${PKGDIR}/MESSAGE${SUBPACKAGE}
.endif

DESCR?=			${PKGDIR}/DESCR${SUBPACKAGE}

MTREE_FILE?=
MTREE_FILE+=		${PORTSDIR}/infrastructure/db/fake.mtree

# Fill out package command, and package dependencies
_PKG_PREREQ=		${WRKPKG}/PLIST${SUBPACKAGE} \
			${WRKPKG}/DESCR${SUBPACKAGE} \
			${WRKPKG}/COMMENT${SUBPACKAGE}
# Note that if you override PKG_ARGS, you will not get correct dependencies;
# you can add stuff to PKG_ARGS_ADD instead
.if !defined(PKG_ARGS)
PKG_ARGS=		-v -c '${WRKPKG}/COMMENT${SUBPACKAGE}' \
			-d ${WRKPKG}/DESCR${SUBPACKAGE}
PKG_ARGS+=		-f ${WRKPKG}/PLIST${SUBPACKAGE} -p ${PREFIX}
.  if exists(${PKGDIR}/INSTALL${SUBPACKAGE})
PKG_ARGS+=		-i ${WRKPKG}/INSTALL${SUBPACKAGE}
_PKG_PREREQ+=		${WRKPKG}/INSTALL${SUBPACKAGE}
.  endif
.  if exists(${PKGDIR}/DEINSTALL${SUBPACKAGE})
PKG_ARGS+=		-k ${WRKPKG}/DEINSTALL${SUBPACKAGE}
_PKG_PREREQ+=		${WRKPKG}/DEINSTALL${SUBPACKAGE}
.  endif
.  if exists(${PKGDIR}/REQ${SUBPACKAGE})
PKG_ARGS+=		-r ${WRKPKG}/REQ${SUBPACKAGE}
_PKG_PREREQ+=		${WRKPKG}/REQ${SUBPACKAGE}
.  endif
.  if defined(MESSAGE)
PKG_ARGS+=		-D ${WRKPKG}/MESSAGE${SUBPACKAGE}
_PKG_PREREQ+=		${WRKPKG}/MESSAGE${SUBPACKAGE}
.  endif
.endif
.if ${FAKE:L} == "yes"
PKG_ARGS+=		-S ${WRKINST}
.endif
PKG_ARGS+=		${PKG_ARGS_ADD}
.if !defined(_COMMENT)
ERRORS+=		"Missing port comment in Makefile."
.endif

CHMOD?=			/bin/chmod
CHOWN?=			/sbin/chown
GUNZIP_CMD?=		/usr/bin/gunzip -f
GZCAT?=			/usr/bin/gzcat
GZIP?=			-n9
GZIP_CMD?=		/usr/bin/gzip -nf ${GZIP}
LDCONFIG?=		[ ! -x /sbin/ldconfig ] || /sbin/ldconfig
M4?=			/usr/bin/m4
STRIP?=			/usr/bin/strip

# Autoconf scripts MAY tend to use bison by default otherwise
YACC?=			yacc
# XXX ${SETENV} is needed in front of var=value lists whenever the next
# command is expanded from a variable, as this could be a shell construct
SETENV?=		/usr/bin/env -i
# Override only if port depends e.g. on GNU bash features. Not recommended.
SH?=			${SHELL}

# Used to print all the '===>' style prompts - override this to turn them off.
ECHO_MSG?=		echo

# basic master sites configuration

.if exists(${PORTSDIR}/infrastructure/db/network.conf)
.  include "${PORTSDIR}/infrastructure/db/network.conf"
.else
.  include "${PORTSDIR}/infrastructure/templates/network.conf.template"
.endif
# Where to put distfiles that don't have any other master site
#
MASTER_SITE_LOCAL?= \
	ftp://ftp.netbsd.org/pub/NetBSD/packages/distfiles/LOCAL_PORTS/ \
	ftp://ftp.freebsd.org/pub/FreeBSD/distfiles/LOCAL_PORTS/

# Empty declarations to avoid "variable XXX is recursive" errors
MASTER_SITES?=
# I guess we're in the master distribution business! :)  As we gain mirror
# sites for distfiles, add them to this list.
.if !defined(MASTER_SITE_OVERRIDE)
MASTER_SITES:=	${MASTER_SITES} ${MASTER_SITE_BACKUP}
.else
MASTER_SITES:=	${MASTER_SITE_OVERRIDE} ${MASTER_SITES}
.endif

# _SITE_SELECTOR chooses the value of sites based on select.
_SITE_SELECTOR=	case $$select in

.for _I in 0 1 2 3 4 5 6 7 8 9
.  if defined(MASTER_SITES${_I})
.    if !defined(MASTER_SITE_OVERRIDE)
MASTER_SITES${_I}:=	${MASTER_SITES${_I}} ${MASTER_SITE_BACKUP}
.    else
MASTER_SITES${_I}:=	${MASTER_SITE_OVERRIDE} ${MASTER_SITES${_I}}
.    endif
_SITE_SELECTOR+=	*:${_I}) sites="${MASTER_SITES${_I}}";;
.  else
_SITE_SELECTOR+=	*:${_I}) echo >&2 \
			    "Error: MASTER_SITES${_I} not defined";;
.  endif
.endfor
_SITE_SELECTOR+=	*) sites="${MASTER_SITES}";; esac


# Code to handle ports distfiles on a CDROM.  The distfiles
# are located in /cdrom/distfiles/${DIST_SUBDIR}/ (assuming that the
# CD-ROM is mounted on /cdrom).
.if exists(/cdrom/distfiles)
CDROM_SITE?=		/cdrom/distfiles/${DIST_SUBDIR}
.else
CDROM_SITE?=
.endif

.if !empty(CDROM_SITE)
.  if defined(FETCH_SYMLINK_DISTFILES)
_CDROM_OVERRIDE=	if ln -s ${CDROM_SITE}/$$f .; then exit 0; fi
.  else
_CDROM_OVERRIDE=	if cp -f ${CDROM_SITE}/$$f .; then exit 0; fi
.  endif
.else
_CDROM_OVERRIDE=	:
.endif

EXTRACT_SUFX?=		.tar.gz
DISTFILES?=		${DISTNAME}${EXTRACT_SUFX}

_EVERYTHING=		${DISTFILES}
_DISTFILES=		${DISTFILES:C/:[0-9]$//}
ALLFILES=		${_DISTFILES}

.if defined(PATCHFILES)
_PATCHFILES=		${PATCHFILES:C/:[0-9]$//}
_EVERYTHING+=		${PATCHFILES}
ALLFILES+=		${_PATCHFILES}
.endif

.if make(checksum) || make(makesum) || make(addsum) || defined(__FETCH_ALL)
.  if defined(SUPDISTFILES) && !defined(NOSUPDISTFILES)
_EVERYTHING+=		${SUPDISTFILES}
ALLFILES+=		${SUPDISTFILES:C/:[0-9]$//}
.  endif
.endif

__CKSUMFILES=
# First, remove duplicates
.for _file in ${ALLFILES}
.  if empty(__CKSUMFILES:M${_file})
__CKSUMFILES+=		${_file}
.  endif
.endfor
ALLFILES:=		${__CKSUMFILES}

.if defined(IGNOREFILES)
.  for _file in ${IGNOREFILES}
__CKSUMFILES:=		${__CKSUMFILES:N${_file}}
.  endfor
.endif

# List of all files, with ${DIST_SUBDIR} in front.  Used for checksum.
.if !empty(DIST_SUBDIR)
_CKSUMFILES=		${__CKSUMFILES:S/^/${DIST_SUBDIR}\//}
_IGNOREFILES=		${IGNOREFILES:S/^/${DIST_SUBDIR}\//}
.else
_CKSUMFILES=		${__CKSUMFILES}
_IGNOREFILES=		${IGNOREFILES}
.endif

# This is what is actually going to be extracted, and is overridable
#  by user.
EXTRACT_ONLY?=		${_DISTFILES}

# okay, time for some guess work
.if !empty(EXTRACT_ONLY:M*.zip)
_USE_ZIP?=		Yes
.endif
.if !empty(EXTRACT_ONLY:M*.tar.bz2) \
    || (defined(PATCHFILES) && !empty(_PATCHFILES:M*.bz2))
_USE_BZIP2?=		Yes
.endif
_USE_ZIP?=		No
_USE_BZIP2?=		No

EXTRACT_CASES?=

_PERL_FIX_SHAR?=	perl -ne 'print if $$s || ($$s = m:^\#(\!\s*/bin/sh\s*| This is a shell archive):)'

# XXX note that we DON'T set EXTRACT_SUFX.
.if ${_USE_ZIP:L} != "no"
BUILD_DEPENDS+=		:unzip-*:archivers/unzip
EXTRACT_CASES+=		*.zip) ${UNZIP} -q ${FULLDISTDIR}/$$archive \
			    -d ${WRKDIR};;
.endif
.if ${_USE_BZIP2:L} != "no"
BUILD_DEPENDS+=		:bzip2-*:archivers/bzip2
EXTRACT_CASES+=		*.tar.bz2 | *.cpio.bz2 | *.cbz) ${BZIP2} -dc \
			    ${FULLDISTDIR}/$$archive | ${TAR} xf - ;;
.endif
EXTRACT_CASES+=		*.tar | *.cpio) ${TAR} xf ${FULLDISTDIR}/$$archive ;;
EXTRACT_CASES+=		*.shar.gz|*.shar.Z|*.sh.gz|*.sh.Z) ${GZIP_CMD} -dc \
			    ${FULLDISTDIR}/$$archive | ${_PERL_FIX_SHAR} \
			    | ${SH} ;;
EXTRACT_CASES+=		*.shar | *.sh) ${_PERL_FIX_SHAR} \
			    ${FULLDISTDIR}/$$archive | ${SH} ;;
EXTRACT_CASES+=		*.tar.gz | *.cpio.gz | *.cgz) ${GZIP_CMD} -dc \
			    ${FULLDISTDIR}/$$archive | ${TAR} xf - ;;
EXTRACT_CASES+=		*.gz) ${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive \
			    >$$(basename $$archive .gz) ;;
EXTRACT_CASES+=		*) ${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive \
			    | ${TAR} xf - ;;

PATCH_CASES?=
.if ${_USE_BZIP2:L} != "no"
PATCH_CASES+=		*.bz2) ${BZIP2} -dc $$patchfile \
			    | ${PATCH} ${PATCH_DIST_ARGS} ;;
.endif
PATCH_CASES+=		*.Z|*.gz) ${GZCAT} $$patchfile \
			    | ${PATCH} ${PATCH_DIST_ARGS} ;;
PATCH_CASES+=		*) ${PATCH} ${PATCH_DIST_ARGS} <$$patchfile ;;

# Documentation
RESPONSIBLE?=		The MirPorts mailing list ${_MIRPORTS_ADDRESS}

.if !defined(CATEGORIES)
ERRORS+=		"Makefile variable CATEGORIES is mandatory."
.endif


CONFIGURE_SCRIPT?=	configure
.if ${CONFIGURE_SCRIPT:M/*}
_CONFIGURE_SCRIPT=	${CONFIGURE_SCRIPT}
.else
.  if defined(SEPARATE_BUILD)
_CONFIGURE_SCRIPT=	${WRKSRC}/${CONFIGURE_SCRIPT}
.  else
_CONFIGURE_SCRIPT=	./${CONFIGURE_SCRIPT}
.  endif
.endif

CONFIGURE_ENV+=		PATH='${PORTPATH}'

.if ${NO_SHARED_LIBS:L} == "yes"
CONFIGURE_SHARED?=	--disable-shared
.else
CONFIGURE_SHARED?=	--enable-shared
.endif

# Passed to configure invocations, and user scripts
SCRIPTS_ENV+=		CURDIR='${.CURDIR}' DISTDIR='${DISTDIR}' \
			PATH='${PORTPATH}' WRKDIR='${WRKDIR}' \
			WRKDIST='${WRKDIST}' WRKSRC='${WRKSRC}' \
			WRKBUILD='${WRKBUILD}' PATCHDIR='${PATCHDIR}' \
			SCRIPTDIR='${SCRIPTDIR}' FILESDIR='${FILESDIR}' \
			PORTSDIR='${PORTSDIR}' DEPENDS="${DEPENDS}" \
			PREFIX='${PREFIX}' LOCALBASE='${LOCALBASE}' \
			X11BASE='${X11BASE}'

.if defined(BATCH)
SCRIPTS_ENV+=		BATCH=yes
.endif

FETCH_MANUALLY?=	No
.if ${FETCH_MANUALLY:L} != "no"
_ALLFILES_PRESENT=	Yes
.  for _F in ${ALLFILES:S@@^@@${FULLDISTDIR}/@@}
.    if !exists(${_F})
_ALLFILES_PRESENT=	No
.    endif
.  endfor
.  if ${_ALLFILES_PRESENT:L} == "no"
IS_INTERACTIVE=		Yes
.  endif
.endif

################################################################
# Many ways to disable a port.
#
# If we're in BATCH mode and the port is interactive, or we're
# in interactive mode and the port is non-interactive, skip all
# the important targets.  The reason we have two modes is that
# one might want to leave a build in BATCH mode running
# overnight, then come back in the morning and do _only_ the
# interactive ones that required your intervention.
#
# Ignore ports that can't be resold if building for a CDROM.
#
# Don't build a port if it's broken.
#
# Don't build a port if it comes with the base system.
################################################################

.if defined(WANTLIB) || defined(MAINTAINER)
BROKEN+=		port not converted from OpenBSD to MirPorts
.endif

.if !defined(NO_IGNORE)
.  if (defined(REGRESS_IS_INTERACTIVE) && defined(BATCH))
_IGNORE_REGRESS=	"has interactive tests"
.  endif
.  if (!defined(REGRESS_IS_INTERACTIVE) && defined(INTERACTIVE))
_IGNORE_REGRESS=	"does not have interactive tests"
.  endif
.  if (defined(IS_INTERACTIVE) && defined(BATCH))
IGNORE+=		"is an interactive port"
.  endif
.  if (!defined(IS_INTERACTIVE) && defined(INTERACTIVE))
IGNORE+=		"is not an interactive port"
.  endif
.  if ${USE_X11:L} == "yes"
.    if !exists(${X11BASE})
IGNORE+=		"uses X11, but ${X11BASE} not found"
.    else
LDFLAGS+=		-L${X11BASE}/lib
.    endif
.  endif
.  if ${USE_CXX:L} == "yes" && ${NO_CXX:L} != "no"
IGNORE+=		"uses C++, but ${NO_CXX}"
.  endif
.  if defined(BROKEN)
IGNORE+=		"is marked as broken: ${BROKEN}"
.  endif
.  if defined(ONLY_FOR_ARCHS)
.    for __ARCH in ${MACHINE_ARCH} ${ARCH}
.      if !empty(ONLY_FOR_ARCHS:M${__ARCH})
_ARCH_OK=1
.      endif
.    endfor
.    if !defined(_ARCH_OK)
.      if ${MACHINE_ARCH} == "${ARCH}"
IGNORE+=		"is only for ${ONLY_FOR_ARCHS}, not ${MACHINE_ARCH}"
.      else
IGNORE+=		"is only for ${ONLY_FOR_ARCHS}, not ${MACHINE_ARCH} \(${ARCH}\)"
.      endif
.    endif
.  endif
.  if defined(NOT_FOR_ARCHS)
.    for __ARCH in ${MACHINE_ARCH} ${ARCH}
.      if !empty(NOT_FOR_ARCHS:M${__ARCH})
IGNORE+=		"is not for ${NOT_FOR_ARCHS}"
.      endif
.    endfor
.  endif
.  if defined(ONLY_FOR_OS)
.    for _m in ${MACHINE_OS}
.      if empty(ONLY_FOR_OS:M${_m})
IGNORE+=		"is only for ${ONLY_FOR_OS}, not ${MACHINE_OS}"
.      endif
.    endfor
.  endif
.  if defined(NOT_FOR_OS)
.    for _m in ${MACHINE_OS}
.      if !empty(NOT_FOR_OS:M${_m})
IGNORE+=		"is not for ${NOT_FOR_OS}"
.      endif
.    endfor
.  endif
.endif		# NO_IGNORE


.if !defined(DEPENDS_TARGET)
.  if make(reinstall)
DEPENDS_TARGET=		reinstall
.  else
DEPENDS_TARGET=		install
.  endif
.endif


################################################################
# Dependency checking
################################################################

# Various dependency styles

_build_depends_fragment= \
	if ${PKG_CMD_PKG} dependencies check "$$pkg"; then \
		found=true; \
	fi
_run_depends_fragment=${_build_depends_fragment}
_regress_depends_fragment=${_build_depends_fragment}

.if ${NO_SHARED_LIBS:L} == "yes"
_noshared=		-noshared
.else
_noshared=
.endif

_libresolve_fragment= \
	case "$$d" in \
	*/*)	shprefix="$${d%/*}/"; shdir="${LOCALBASE}/$${d%/*}"; \
		d=$${d\#\#*/};; \
	*)	shprefix=""; shdir="${LOCALBASE}/lib";; \
	esac; \
	check=$$(eval $$listlibs | perl \
	    ${PORTSDIR}/infrastructure/build/resolve-lib ${_noshared} $$d) \
	    || true

_lib_depends_fragment= \
	what=$$dep; \
	IFS=,; bad=false; for d in $$dep; do \
		listlibs='ls /usr/lib $$shdir 2>/dev/null'; \
		${_libresolve_fragment}; \
		case "$$check" in \
		Missing\ library) bad=true; msg="$$msg $$d missing...";; \
		Error:*) bad=true; msg="$$msg $$d unsolvable...";; \
		esac; \
	done; $$bad || found=true

_FULL_PACKAGE_NAME?=	No

.for _DEP in build run lib regress
_DEP${_DEP}_COOKIES=
.  if defined(${_DEP:U}_DEPENDS) && ${NO_DEPENDS:L} == "no"
.    for _i in ${${_DEP:U}_DEPENDS}
_DEP${_DEP}_COOKIES+=	${WRKDIR}/.${_DEP}${_i:C,[|:./<=>*],-,g}
.    endfor
.  endif
.endfor

# Normal user-mode targets are PHONY targets, e.g., don't create the
# corresponding file. However, there is nothing phony about the cookie.

_INSTALL_DEPS=		${_INSTALL_COOKIE}
_PACKAGE_DEPS=		${_PACKAGE_COOKIES}
.if defined(ALWAYS_PACKAGE)
_INSTALL_DEPS+=		${_PACKAGE_COOKIES}
.endif
.if ${BULK_${PKGPATH}:L} == "yes"
_INSTALL_DEPS+=		${_BULK_COOKIE}
_PACKAGE_DEPS+=		${_BULK_COOKIE}
.endif

PREFER_SUBPKG_INSTALL?=	yes
.if empty(SUBPACKAGE) && defined(MULTI_PACKAGES) \
    && !empty(MULTI_PACKAGES) && (${PREFER_SUBPKG_INSTALL:L} == "yes")
.  for _i in ${MULTI_PACKAGES}
_INSTALL_DEPS+=		${PKG_DBDIR}/${FULLPKGNAME${_i}}/+CONTENTS

${PKG_DBDIR}/${FULLPKGNAME${_i}}/+CONTENTS: ${PKG_DBDIR}/${FULLPKGNAME}/+CONTENTS
	@@env SUBPACKAGE=${_i:Q} ${MAKE} install
.  endfor
.endif

MODSIMPLE_configure= \
	cd ${WRKCONF} && ${_SYSTRACE_CMD} ${SETENV} REALOS='${OStype}' \
	    CC="${CC}" ac_cv_path_CC="${CC}" CFLAGS="${CFLAGS:C/ *$//}" \
	    CXX="${CXX}" ac_cv_path_CXX="${CXX}" LDFLAGS="${LDFLAGS}" \
	    CXXFLAGS="${CXXFLAGS:C/ *$//}" CPPFLAGS="${CPPFLAGS:C/ *$//}" \
	    INSTALL="/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}" \
	    ac_given_INSTALL="/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}" \
	    INSTALL_PROGRAM="${INSTALL_PROGRAM}" YACC="${YACC}" \
	    INSTALL_MAN="${INSTALL_MAN}" INSTALL_DATA="${INSTALL_DATA}" \
	    INSTALL_SCRIPT="${INSTALL_SCRIPT}" LD="${LD}" GCC_NO_WERROR=1 \
	    ${CONFIGURE_ENV} ${SH} ${_CONFIGURE_SCRIPT} ${CONFIGURE_ARGS}

_FAKE_SETUP=		TRUEPREFIX='${PREFIX}' PREFIX='${WRKINST}${PREFIX}' \
			${DESTDIRNAME}='${WRKINST}'

VMEM_WARNING?=		No
_CLEANDEPENDS?=		Yes

_tmpvars:=
.  for _v in ${SUBST_VARS}
_tmpvars+=		${_v}='${${_v}}'
.  endfor

# mirroring utilities
.if !empty(DIST_SUBDIR)
_ALLFILES=		${ALLFILES:S/^/${DIST_SUBDIR}\//}
.else
_ALLFILES=		${ALLFILES}
.endif

_FMN=			${PKGPATH}/${FULLPKGNAME}
.if defined(MULTI_PACKAGES)
.  for _S in ${MULTI_PACKAGES}
_FMN+=			${PKGPATH}/${FULLPKGNAME${_S}}
.  endfor
.endif

# Internal variables, used by dependencies targets
# Only keep pkg:dir spec
.if defined(LIB_DEPENDS) && ${NO_SHARED_LIBS:L} != "yes"
_ALWAYS_DEP2=		${LIB_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_ALWAYS_DEP=		${_ALWAYS_DEP2:C/[^:]*://}
.else
_ALWAYS_DEP2=
_ALWAYS_DEP=
.endif

.if defined(RUN_DEPENDS)
_RUN_DEP2=		${RUN_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_RUN_DEP=		${_RUN_DEP2:C/[^:]*://}
.else
_RUN_DEP2=
_RUN_DEP=
.endif

.if defined(BUILD_DEPENDS)
_BUILD_DEP2=		${BUILD_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_BUILD_DEP=		${_BUILD_DEP2:C/[^:]*://}
.else
_BUILD_DEP2=
_BUILD_DEP=
.endif

_LIB_DEP2=		${LIB_DEPENDS}
README_NAME?=		${TEMPLATES}/README.port

REORDER_DEPENDENCIES?=

_size_fragment=		wc -c $$file 2>/dev/null | \
			    awk '{print "SIZE (" $$2 ") = " $$1}'

###
### end of variable setup. Only targets now
###

.if ${BIN_PACKAGES:L} == "yes"
${_PACKAGE_COOKIE}:
	@@cd ${.CURDIR} && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS}
.else
${_PACKAGE_COOKIE}: ${_PACKAGE_COOKIE_DEPS}
.endif
	@@cd ${.CURDIR} && SUBPACKAGE='' FLAVOR='${FLAVOR}' \
	    PACKAGING='' exec ${MAKE} _package
.if !defined(PACKAGE_NOINSTALL)
	@@${_MAKE_COOKIE} $@@
.endif

.for _s in ${MULTI_PACKAGES}
.  if ${BIN_PACKAGES:L} == "yes"
${_PACKAGE_COOKIE${_s}}:
	@@cd ${.CURDIR} && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS}
.  else
${_PACKAGE_COOKIE${_s}}: ${_PACKAGE_COOKIE_DEPS}
.  endif
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' FLAVOR='${FLAVOR}' \
	    PACKAGING='${_s}' exec ${MAKE} _package
.endfor

.PRECIOUS: ${_PACKAGE_COOKIES} ${_INSTALL_COOKIE}

${_SYSTRACE_COOKIE}:
	@@rm -f $@@
.for _i in ${_SYSTRACE_POLICIES}
	@@echo "Policy: ${_i}, Emulation: native" >>$@@
	@@if [ -f ${.CURDIR}/systrace.filter ]; then \
		cat ${.CURDIR}/systrace.filter >>$@@; \
	fi
	@@sed ${_SYSTRACE_SED_SUBST} ${SYSTRACE_FILTER} >>$@@
.endfor
	@@if [ -f ${.CURDIR}/systrace.policy ]; then \
		sed ${_SYSTRACE_SED_SUBST} ${.CURDIR}/systrace.policy >>$@@; \
	fi

# create the packing stuff from source
${WRKPKG}/COMMENT${SUBPACKAGE}:
	@@echo ${_COMMENT} >$@@

${WRKPKG}/PLIST${SUBPACKAGE}: ${PLIST} ${WRKPKG}/depends${SUBPACKAGE}
	@@echo "@@comment subdir=${FULLPKGPATH}" \
	    "cdrom=${PERMIT_PACKAGE_CDROM:L:S/"/\"/g}" \
	    "ftp=${PERMIT_PACKAGE_FTP:L:S/"/\"/g}" \
	    >$@@.tmp
	@@echo "@@comment" \
	    "portdir=http://mirbsd.bsdadvocacy.org/cvs.cgi/ports/${PKGPATH}/" \
	    >>$@@.tmp
	@@t="0${_noshared}"; if [[ $$t = 0-noshared ]]; then \
		t=0; \
	elif [ -x /sbin/ldconfig ]; then \
		t=1; \
	fi; echo "@@ldcache $$t" >>$@@.tmp
	@@sort -u <${WRKPKG}/depends${SUBPACKAGE} >>$@@.tmp
.if ${NO_SHARED_LIBS:L} == "yes"
	@@sed -e '/^!%%SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' \
	    -e '//d' \
	    -e '/^%%!SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' \
	    -e '//d' -e '/^%%SHARED%%$$/d' <${PLIST} ${SED_PLIST} \
	    >>$@@.tmp && mv -f $@@.tmp $@@
.elif ${OBJECT_FMT} == "Mach-O"
	if [ -e ${PKGDIR}/PFRAG.dylib${SUBPACKAGE} ]; then \
		sed -e '/^!%%SHARED%%$$/d' \
		    -e '/^%%!SHARED%%$$/d' \
		    -e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.dylib${SUBPACKAGE}' \
		    -e '//d' <${PLIST} ${SED_PLIST} \
		    >>$@@.tmp && mv -f $@@.tmp $@@; \
	else \
		echo '@@option dylib' >>$@@.tmp; \
		sed -e '/^!%%SHARED%%$$/d' \
		    -e '/^%%!SHARED%%$$/d' \
		    -e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' \
		    -e '//d' <${PLIST} ${SED_PLIST} \
		    >>$@@.tmp && mv -f $@@.tmp $@@; \
	fi
.else
	sed -e '/^!%%SHARED%%$$/d' -e '/^%%!SHARED%%$$/d' \
	    -e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' \
	    -e '//d' <${PLIST} ${SED_PLIST} >>$@@.tmp && mv -f $@@.tmp $@@
.endif

${WRKPKG}/depends${SUBPACKAGE}:
	@@mkdir -p ${WRKPKG}
	@@>$@@
.if (defined(RUN_DEPENDS) && !empty(RUN_DEPENDS)) || \
    (${NO_SHARED_LIBS:L} != "yes" && \
     defined(LIB_DEPENDS) && !empty(LIB_DEPENDS))
	@@${_depfile_fragment}; \
	    echo "|${FULLPKGNAME${SUBPACKAGE}}|" >>$${_DEPENDS_FILE}; \
	    self=${FULLPKGNAME${SUBPACKAGE}} _depends_result=$@@ \
	    ${MAKE} _recurse-solve-package-depends
.endif

${WRKPKG}/DESCR${SUBPACKAGE}: ${DESCR}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
	@@echo "\nMaintainer: ${RESPONSIBLE}" >>$@@
.if defined(HOMEPAGE)
	@@fgrep -q '$${HOMEPAGE}' $? || echo "\nWWW: ${HOMEPAGE}" >>$@@
.endif
.if !empty(FLAVORS)
	@@echo "\nFlavours available:" ${FLAVORS} >>$@@
.endif

${WRKPKG}/mtree.spec: ${MTREE_FILE}
	@@${_SED_SUBST} ${MTREE_FILE} >$@@.tmp
	@@(print '/@@@@local/d\ni\n'; IFS=/; s=; \
	 for pc in $$(print '${LOCALBASE}'); do \
		s="$$s    "; print "$$s$$pc"; \
	 done; print '.\nwq') | ed -s $@@.tmp
	@@mv -f $@@.tmp $@@

# substitute
.for _subst_file in INSTALL DEINSTALL REQ
.  if exists(${PKGDIR}/${_subst_file}${SUBPACKAGE})
${WRKPKG}/${_subst_file}${SUBPACKAGE}: ${PKGDIR}/${_subst_file}${SUBPACKAGE}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
.  endif
.endfor

.if defined(MESSAGE)
${WRKPKG}/MESSAGE${SUBPACKAGE}: ${MESSAGE}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
.endif

makesum: fetch-all
.if !defined(NO_CHECKSUM)
	@@rm -f ${CHECKSUM_FILE}
	@@x=bad; cd ${DISTDIR} && \
	    for cipher in ${_CIPHERS}; do \
		${_CKSUM_A} $$cipher ${_CKSUMFILES} \
		    >>${CHECKSUM_FILE} && x=ok || true; \
	    done; test $$x = ok
	@@for file in ${_IGNOREFILES}; do \
		echo "MD5 ($$file) = IGNORE" >>${CHECKSUM_FILE}; \
	done
	@@cd ${DISTDIR} && \
	    for file in ${_CKSUMFILES}; do \
		${_size_fragment} >>${CHECKSUM_FILE}; \
	    done
	@@sort -u -o ${CHECKSUM_FILE} ${CHECKSUM_FILE}
.endif


addsum: fetch-all
.if !defined(NO_CHECKSUM)
	@@touch ${CHECKSUM_FILE}
	@@x=bad; cd ${DISTDIR} && \
	    for cipher in ${_CIPHERS}; do \
		${_CKSUM_A} $$cipher ${_CKSUMFILES} \
		    >>${CHECKSUM_FILE} && x=ok || true; \
	    done; test $$x = ok
	@@for file in ${_IGNOREFILES}; do \
		echo "MD5 ($$file) = IGNORE" >>${CHECKSUM_FILE}; \
	done
	@@cd ${DISTDIR} && \
	    for file in ${_CKSUMFILES}; do \
		${_size_fragment} >>${CHECKSUM_FILE}; \
	    done
	@@sort -u -o ${CHECKSUM_FILE} ${CHECKSUM_FILE}
	@@if [ $$(sed -e 's/\=.*$$//' ${CHECKSUM_FILE} | uniq -d \
	    | wc -l) -ne 0 ]; then \
		echo "Inconsistent checksum in ${CHECKSUM_FILE}"; \
		exit 1; \
	else \
		${ECHO_MSG} "${CHECKSUM_FILE} updated okay," \
		    "don't forget to remove cruft"; \
	fi
.endif


################################################################
# Dependency checking
################################################################

depends: lib-depends build-depends run-depends regress-depends

# and the rules for the actual dependencies

_print-packagename:
.if ${_FULL_PACKAGE_NAME:L} == "yes"
	@@echo '${PKGPATH}/${FULLPKGNAME${SUBPACKAGE}}'
.else
	@@echo ${FULLPKGNAME${SUBPACKAGE}}
.endif

.for _DEP in build run lib regress
.  if defined(${_DEP:U}_DEPENDS) && ${NO_DEPENDS:L} == "no"
.    for _i in ${${_DEP:U}_DEPENDS}
${WRKDIR}/.${_DEP}${_i:C,[|:./<=>*],-,g}: ${_WRKDIR_COOKIE}
	@@unset PACKAGING DEPENDS_TARGET FLAVOR SUBPACKAGE \
	    _MASTER WRKDIR|| true; \
	echo '${_i}'|{ \
		IFS=:; read dep pkg dir target; \
		${_flavor_fragment}; defaulted=false; \
		case "X$$target" in X) target=${DEPENDS_TARGET};; esac; \
		case "X$$target" in \
		Xinstall|Xreinstall) early_exit=false;; \
		Xpackage) early_exit=true;; \
		*) \
			early_exit=true; mkdir -p ${WRKDIR}/$$dir; \
			toset="$$toset \
			    _MASTER='[${FULLPKGNAME${SUBPACKAGE}}]${_MASTER}' \
			    WRKDIR=${WRKDIR}/$$dir"; \
			dep="/nonexistent";; \
		esac; \
		case "X$$pkg" in \
		X)	pkg=$$(eval $$toset ${MAKE} _print-packagename); \
			defaulted=true;; \
		esac; \
		for abort in false false true; do \
			if $$abort; then \
				${ECHO_MSG} "Dependency check failed"; \
				exit 1; \
			fi; \
			found=false; \
			what=$$pkg; \
			case "$$dep" in \
			"/nonexistent") ;; \
			*)  \
				${_${_DEP}_depends_fragment}; \
				if $$found; then \
					${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} depends on: $$what - found"; \
					break; \
				else \
					: $${msg:= not found}; \
					${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} depends on: $$what -$$msg"; \
				fi;; \
			esac; \
			if [[ -z $$dir ]]; then \
				${ECHO_MSG} "===>  Please install $$what manually."; \
				${ECHO_MSG} "      There is no MirPort available for this dependency."; \
				exit 1; \
			fi; \
			${ECHO_MSG} "===>  Verifying $$target for $$what in $$dir"; \
			[[ $$target = *patch* ]] && \
			    target="__AUTOPORT_RECURSIVE=1 $$target"; \
			if eval $$toset ${MAKE} $$target; then \
				${ECHO_MSG} "===> Returning to build of ${FULLPKGNAME${SUBPACKAGE}}${_MASTER}"; \
			else \
				exit 1; \
			fi; \
			if $$early_exit; then \
				break; \
			fi; \
		done; \
	}
	@@${_MAKE_COOKIE} $@@
.    endfor
.  endif
${_DEP}-depends: ${_DEP${_DEP}_COOKIES}
.endfor

# Do a brute-force ldd/objdump on all files under WRKINST.
_CHECK_LIBS_SCRIPT=	${PORTSDIR}/infrastructure/install/check-libs-elf
${_LIBLIST}: ${_FAKE_COOKIE}
	@@cd ${WRKINST} && ${SUDO} find . -type f|\
		${SUDO} xargs objdump -p 2>/dev/null |\
		sed -n \
		    -e '/^ *NEEDED *\(.*\)\.so\.\([0-9][0-9]*\)\.\([0-9][0-9]*\)$$/s//\1 \2 \3/p' \
		    -e '/^ *NEEDED *\(.*\)\.so$$/s//\1/p' \
		| sort -u >$@@

# list of libraries that can be used: libraries just built, and system libs.
${_BUILDLIBLIST}: ${_FAKE_COOKIE}
	@@{ \
		${SUDO} find ${WRKINST} -type f -o -type l; \
		find /usr/lib -path /usr/lib -o -type d -prune \
		    -o -type f -print; \
		find ${X11BASE}/lib -path ${X11BASE}/lib -o -type d -prune \
		    -o -type f -print; \
	} | \
		egrep '(\.so\.|\.so$$)' | ${SUDO} xargs file -L \
		    | fgrep 'shared' | cut -d\: -f1 | sort -u >$@@


.for _i in ${EMUL}
HAS_EMUL_${_i}!=sysctl -n kern.emul.${_i} 2>/dev/null
.  if ${HAS_EMUL_${_i}} != "1"
IGNORE+=	"needs ${_i} emulation, which is turned off, see compat_${_i}(8)"
.  endif
.endfor


.if defined(IGNORE) && !defined(NO_IGNORE)
fetch checksum extract patch configure all build install regress \
    uninstall deinstall fake package lib-depends-check manpages-check \
    relevant-checks:
.  if !defined(IGNORE_SILENT)
.    for _i in ${IGNORE}
	@@${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} "${_i}.
.    endfor
.  endif

.else
# For now, just check all libnames are present
# The check is done on the fake area, be wary of multi-packages situation,
# since we don't take it into account yet.
#
# Note that we cache needed library names, and libraries we're allowed to
# depend upon, but not the actual list of lib depends, since this list is
# going to be tweaked as a result of running lib-depends-check.
#
lib-depends-check: ${_LIBLIST} ${_BUILDLIBLIST}
	@@${_depfile_fragment}; \
	LIB_DEPENDS="$$(${MAKE} _recurse-lib-depends-check)" \
	PKG_DBDIR='${PKG_DBDIR}' perl ${_CHECK_LIBS_SCRIPT} \
	    ${_LIBLIST} ${_BUILDLIBLIST}

manpages-check: ${_FAKE_COOKIE}
	@@cd ${WRKINST}${TRUEPREFIX}/man && \
	    ${SUDO} /usr/libexec/makewhatis -p . && cat whatis.db

# Most standard port targets create a cookie to avoid being re-run.
#
# fetch is an exception, as it uses the files it fetches as 'cookies',
# and it's run by checksum, so in essence it's a sub-goal of extract,
# in normal use.
#
# Besides, fetch can't create cookies, as it does not have WRKDIR available
# in the first place.
#
# IMPORTANT: pre-fetch/do-fetch/post-fetch MUST be designed so that they
# can be run several times in a row.

fetch:
	@@${ECHO_MSG} "===>  Checking files for ${FULLPKGNAME}${_MASTER}"
.  if target(pre-fetch)
	@@cd ${.CURDIR} && exec ${MAKE} pre-fetch
.  endif
.  if target(do-fetch)
	@@cd ${.CURDIR} && exec ${MAKE} do-fetch
.  else
# What FETCH normally does:
.    if !empty(ALLFILES)
	@@cd ${.CURDIR} && exec ${MAKE} ${ALLFILES:S@@^@@${FULLDISTDIR}/@@}
.    endif
# End of FETCH
.  endif
.  if target(post-fetch)
	@@cd ${.CURDIR} && exec ${MAKE} post-fetch
.  endif


checksum: fetch
.  if !defined(NO_CHECKSUM)
	@@checksum_file=${CHECKSUM_FILE}; \
	if [ ! -f $$checksum_file ]; then \
		${ECHO_MSG} ">> No checksum file."; \
	else \
		cd ${DISTDIR}; OK=true; list=''; \
		for file in ${_CKSUMFILES}; do \
			match=; \
			for cipher in ${_CIPHERS}; do \
				if ! (echo | ${_CKSUM_A} $$cipher \
				    >/dev/null 2>&1); then \
					${ECHO_MSG} ">> No $$cipher found on this system."; \
					continue; \
				fi; \
				if ! set -- $$(grep -i "^$$cipher ($$file)" \
				    $$checksum_file); then \
					${ECHO_MSG} ">> No $$cipher checksum recorded for $$file."; \
					continue; \
				fi; \
				case "$$4" in \
				"") \
					${ECHO_MSG} ">> No checksum recorded for $$file."; \
					OK=false;; \
				"IGNORE") \
					echo ">> Checksum for $$file is set to IGNORE in md5 file even though"; \
					echo "   the file is not in the "'$$'"{IGNOREFILES} list."; \
					OK=false;; \
				*) \
					CKSUM=$$(${_CKSUM_A} $$cipher <$$file); \
					case "$$CKSUM" in \
				  	"$$4") \
						match=1; \
						${ECHO_MSG} ">> Checksum OK for $$file. ($$cipher)";; \
					*) \
						echo ">> Checksum mismatch for $$file. ($$cipher)"; \
						list="$$list $$file $$cipher $$4"; \
						OK=false;; \
					esac;; \
				esac; \
			done; \
			[[ $$match = 1 ]] || OK=false; \
		done; \
		set --; \
		for file in ${_IGNOREFILES}; do \
		  set -- $$(grep "($$file)" $$checksum_file) || \
			  { echo ">> No checksum recorded for $$file, file is in "'$$'"{IGNOREFILES} list." && \
			  OK=false; } ; \
		  case "$$4" in \
		  	"IGNORE") : ;; \
			*) \
			  echo ">> Checksum for $$file is not set to IGNORE in md5 file even though"; \
			  echo "   the file is in the "'$$'"{IGNOREFILES} list."; \
			  OK=false;; \
		  esac; \
		done; \
		if ! $$OK; then \
		  if ${REFETCH}; then \
		  	cd ${.CURDIR} && ${MAKE} _refetch _PROBLEMS="$$list"; \
		  else \
			echo "Make sure the Makefile and checksum file ($$checksum_file)"; \
			echo "are up to date.  If you want to fetch a good copy of this"; \
			echo "file from the OpenBSD or MirOS main archive, type"; \
			echo "\"make REFETCH=true [other args]\"."; \
			exit 1; \
		  fi; \
		fi ; \
  fi
.  endif

_refetch:
.  for file cipher value in ${_PROBLEMS}
	@@rm ${DISTDIR}/${file}
	@@cd ${.CURDIR} && exec ${MAKE} ${DISTDIR}/${file} \
	    MASTER_SITE_OVERRIDE="ftp://ftp.openbsd.org/pub/OpenBSD/distfiles/${cipher}/${value}/"
.  endfor
	cd ${.CURDIR} && exec ${MAKE} checksum REFETCH=false


# The cookie's recipe hold the real rule for each of those targets.

extract: ${_EXTRACT_COOKIE}
patch: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} \
	${_PATCH_COOKIE}
distpatch: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} \
	${_DISTPATCH_COOKIE}
configure: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} \
	${_CONFIGURE_COOKIE}
all build: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} \
	${_BUILD_COOKIE}
install: ${_INSTALL_DEPS}
fake: ${_FAKE_COOKIE}
package: ${_PACKAGE_DEPS}

unconfigure:
	rm -f ${_CONFIGURE_COOKIE}

.  if defined(_IGNORE_REGRESS)
regress:
.    if !defined(IGNORE_SILENT)
	@@${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} ${_IGNORE_REGRESS}."
.    endif
.  else
regress: ${_DEPregress_COOKIES} ${_REGRESS_COOKIE}
.  endif

.endif # IGNORECMD

${_BULK_COOKIE}: ${_PACKAGE_COOKIES}
	@@mkdir -p ${BULK_COOKIES_DIR}
.for _i in ${BULK_TARGETS_${PKGPATH}}
	@@${ECHO_MSG} "===> Running ${_i}"
	@@cd ${.CURDIR} && exec ${MAKE} ${_i} ${BULK_FLAGS}
.endfor
	@@cd ${.CURDIR} && exec ${SUDO} ${MAKE} clean
	@@${_MAKE_COOKIE} $@@

# The real targets. Note that some parts always get run, some parts can be
# disabled, and there are hooks to override behavior.

${_WRKDIR_COOKIE}:
	@@rm -rf ${WRKDIR}
	@@mkdir -p ${WRKDIR} ${WRKDIR}/bin
	@@${_MAKE_COOKIE} $@@

${_EXTRACT_COOKIE}: ${_WRKDIR_COOKIE} ${_SYSTRACE_COOKIE}
	@@cd ${.CURDIR} && exec ${MAKE} NOSUPDISTFILES=1 \
	    checksum build-depends lib-depends
	@@${ECHO_MSG} "===>  Extracting for ${FULLPKGNAME}${_MASTER}"
.if target(pre-extract)
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} pre-extract
.endif
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} do-extract
.if target(post-extract)
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} post-extract
.endif
	@@${_MAKE_COOKIE} $@@

.if !target(do-extract)
do-extract:
# What EXTRACT normally does:
	@@PATH=${PORTPATH}; set -e; cd ${WRKDIR}; \
	for archive in ${EXTRACT_ONLY}; do \
		case $$archive in \
		${EXTRACT_CASES} \
		esac; \
	done
# End of EXTRACT
.endif


# Both distpatch and patch invoke pre-patch, if it's defined.
# Hence it needs special treatment (a specific cookie).
.if target(pre-patch)
${_PREPATCH_COOKIE}:
	@@cd ${.CURDIR} && exec ${MAKE} pre-patch
.  if ${PATCH_CHECK_ONLY:L} != "yes"
	@@${_MAKE_COOKIE} $@@
.  endif
.endif



# The real distpatch

${_DISTPATCH_COOKIE}: ${_EXTRACT_COOKIE}
.if target(pre-patch)
	@@cd ${.CURDIR} && exec ${MAKE} ${_PREPATCH_COOKIE}
.endif
.if target(do-distpatch)
	@@cd ${.CURDIR} && exec ${MAKE} do-distpatch
.else
# What DISTPATCH normally does
.  if defined(_PATCHFILES)
	@@${ECHO_MSG} "===>  Applying distribution patches for ${FULLPKGNAME}${_MASTER}"
	@@cd ${FULLDISTDIR}; \
	  for patchfile in ${_PATCHFILES}; do \
	  	case "${PATCH_DEBUG:L}" in \
		no)	;; \
		*)	${ECHO_MSG} "===>   Applying distribution patch $$patchfile" ;; \
		esac; \
		case $$patchfile in \
			${PATCH_CASES} \
		esac; \
	  done
.  endif
# End of DISTPATCH.
.endif
.if target(post-distpatch)
	@@cd ${.CURDIR} && exec ${MAKE} post-distpatch
.endif
.if ${PATCH_CHECK_ONLY:L} != "yes"
	@@${_MAKE_COOKIE} $@@
.endif

# The real patch

${_PATCH_COOKIE}: ${_EXTRACT_COOKIE}
	@@${ECHO_MSG} "===>  Patching for ${FULLPKGNAME}${_MASTER}"
.if target(pre-patch)
	@@cd ${.CURDIR} && exec ${MAKE} ${_PREPATCH_COOKIE}
.endif
.if target(do-patch)
	@@cd ${.CURDIR} && exec ${MAKE} do-patch
.else
# What PATCH normally does:
# XXX test for efficiency, don't bother with distpatch if it's not needed
.  if target(do-distpatch) || target(post-distpatch) || defined(PATCHFILES)
	@@cd ${.CURDIR} && exec ${MAKE} distpatch
.  endif
	@@if cd ${PATCHDIR} 2>/dev/null || [ x"${PATCH_LIST:M/*}" != x"" ]; then \
		error=false; \
		for i in ${PATCH_LIST}; do \
			case $$i in \
			*.orig|*.rej|*~) \
				${ECHO_MSG} "===>   Ignoring patchfile $$i" ; \
				;; \
			*) \
			    if [ -e $$i ]; then \
					case "${PATCH_DEBUG:L}" in \
					no)	;; \
					*)	${ECHO_MSG} "===>   Applying ${OPSYS} patch $$i" ;; \
					esac; \
					${PATCH} ${PATCH_ARGS} <$$i || \
						{ echo "***>   $$i did not apply cleanly"; \
						error=true; }\
				else \
					if [ $$i != "patch-*" ]; then \
						echo "===>   Can't find patch matching $$i"; \
						error=true; \
					fi; \
				fi; \
				;; \
			esac; \
		done;\
		if $$error; then exit 1; fi; \
	fi
# End of PATCH.
.endif
.if target(post-patch)
	@@cd ${.CURDIR} && exec ${MAKE} post-patch
.endif
.for _m in ${MODULES}
.  if defined(MOD${_m:U}_post-patch)
	@@${MOD${_m:U}_post-patch}
.  endif
.endfor
.if !empty(REORDER_DEPENDENCIES) && ${PATCH_CHECK_ONLY:L} != "yes"
	sed -e '/^#/d' ${REORDER_DEPENDENCIES} | \
	  tsort -r|while read f; do \
	    cd ${WRKSRC}; \
		case $$f in \
		/*) \
			find . -name $${f#/} -print | while read i; \
				do echo "Touching $$i"; touch $$i; done \
			;; \
		*) \
			if test -e $$f ; then \
				echo "Touching $$f"; touch $$f; \
			fi \
			;; \
		esac; done
.endif
.if ${PATCH_CHECK_ONLY:L} != "yes"
	@@${_MAKE_COOKIE} $@@
.endif

# The real configure

${_CONFIGURE_COOKIE}: ${_PATCH_COOKIE}
	@@${ECHO_MSG} "===>  Configuring for ${FULLPKGNAME}${_MASTER}"
	@@mkdir -p ${WRKBUILD} ${WRKPKG}
.if target(pre-configure)
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} pre-configure
.endif
.if ${USE_SCHILY:L} != "no"
	sed -e 's/@@@@OScompat@@@@/${OScompat}/' \
	    <${PORTSDIR}/infrastructure/db/uname.sed >${WRKDIR}/bin/uname
	print '#!${SHELL}\nexec ${CC} "$$@@"' >${WRKDIR}/bin/cc
	chmod ${BINMODE} ${WRKDIR}/bin/cc ${WRKDIR}/bin/uname
.  if ${MACHINE} != "i386"
	ln -sf ${WRKSRC}/RULES/i386-openbsd-cc.rul \
	    "${WRKSRC}/RULES/${MACHINE}-openbsd-cc.rul"
.  endif
.endif
.if target(do-configure)
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} do-configure
.elif ${CONFIGURE_STYLE:L} != "no"
# What CONFIGURE normally does
	@@if [ -f ${SCRIPTDIR}/configure ]; then \
		cd ${.CURDIR} &&  ${_SYSTRACE_CMD} ${SETENV} \
		    ${SCRIPTS_ENV} ${SH} ${SCRIPTDIR}/configure; \
	fi
.  for _c in ${CONFIGURE_STYLE:L}
.    if defined(MOD${_c:U}_configure)
	@@${MOD${_c:U}_configure}
.    endif
.  endfor
# End of CONFIGURE.
.endif
.if target(post-configure)
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} post-configure
.endif
	@@${_MAKE_COOKIE} $@@

# The real build

${_BUILD_COOKIE}: ${_CONFIGURE_COOKIE}
.if ${NO_BUILD:L} == "no"
	@@${ECHO_MSG} "===>  Building for ${FULLPKGNAME}${_MASTER}"
.  if ${VMEM_WARNING:L} == "yes"
	@@echo ""; \
	echo "*** WARNING: you may see an error such as"; \
	echo "***       virtual memory exhausted"; \
	echo "*** when building this package.  If you do you must increase"; \
	echo "*** your limits.  See the man page for your shell and look"; \
	echo "*** for the 'limit' or 'ulimit' command. You may also want to"; \
	echo "*** see the login.conf(5) manual page."; \
	echo "*** Some examples are: "; \
	echo "*** 	csh(1) and tcsh(1): limit datasize <KiB memory>"; \
	echo "***	ksh(1), zsh(1) and bash(1): ulimit -d <KiB memory>"; \
	echo ""
.  endif
.  if target(pre-build)
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} pre-build
.  endif
.  if target(do-build)
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} do-build
.  else
# What BUILD normally does:
	@@cd ${WRKBUILD} && exec ${_SYSTRACE_CMD} ${SETENV} ${MAKE_ENV} \
	    ${MAKE_PROGRAM} ${MAKE_FLAGS} -f ${MAKE_FILE} ${ALL_TARGET}
# End of BUILD
.  endif
.  if target(post-build)
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} post-build
.  endif
.endif
	@@${_MAKE_COOKIE} $@@

${_REGRESS_COOKIE}: ${_BUILD_COOKIE}
.if ${NO_REGRESS:L} == "no"
	@@${ECHO_MSG} "===>  Regression check for ${FULLPKGNAME}${_MASTER}"
.  if target(pre-regress)
	@@cd ${.CURDIR} && exec ${MAKE} pre-regress
.  endif
.  if target(do-regress)
	@@cd ${.CURDIR} && exec ${MAKE} do-regress
.  else
# What REGRESS normally does:
	@@cd ${WRKBUILD} && exec ${SETENV} ${MAKE_ENV} \
	    ${MAKE_PROGRAM} ${REGRESS_FLAGS} -f ${MAKE_FILE} ${REGRESS_TARGET}
# End of REGRESS
.  endif
.  if target(post-regress)
	@@cd ${.CURDIR} && exec ${MAKE} post-regress
.  endif
.else
	@@echo 1>&2 "No regression check for ${FULLPKGNAME}"
.endif
	@@${_MAKE_COOKIE} $@@

.if ${FAKE:L} == "yes"
${_FAKE_COOKIE}: ${_BUILD_COOKIE} ${WRKPKG}/mtree.spec
	@@${ECHO_MSG} "===>  Faking installation for ${FULLPKGNAME}${_MASTER}"
	@@if [ x$$(${SUDO} ${SH} -c umask) != x${DEF_UMASK} ]; then \
		echo >&2 "Error: your umask is \"$$(${SH} -c umask)"\".; \
		exit 1; \
	fi
	@@${SUDO} install -d -m 755 -o root -g wheel ${WRKINST}
	@@${SUDO} /usr/sbin/mtree -U -e -d -n -p ${WRKINST} \
		-f ${WRKPKG}/mtree.spec  >/dev/null
.  for _p in ${PROTECT_MOUNT_POINTS}
	@@${SUDO} mount -u -r ${_p}
.  endfor
.  for _m in ${MODULES}
.    if defined(MOD${_m:U}_pre-fake)
	@@${MOD${_m:U}_pre-fake}
.    endif
.  endfor

.  if target(pre-fake)
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} \
	    ${MAKE} pre-fake ${_FAKE_SETUP}
.  endif
	@@${SUDO} ${_MAKE_COOKIE} ${_INSTALL_PRE_COOKIE}
.  if target(pre-install)
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} \
	    ${MAKE} pre-install ${_FAKE_SETUP}
.  endif
.  if target(do-install)
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} \
	    ${MAKE} do-install ${_FAKE_SETUP}
.  else
# What FAKE normally does:
	@@cd ${WRKBUILD} && exec ${SUDO} ${_SYSTRACE_CMD} \
	    ${SETENV} ${MAKE_ENV} ${_FAKE_SETUP} \
	    ${MAKE_PROGRAM} ${FAKE_FLAGS} -f ${MAKE_FILE} ${FAKE_TARGET}
# End of FAKE.
.  endif
.  if target(post-install)
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} \
	    ${MAKE} post-install ${_FAKE_SETUP}
.  endif
.  for _p in ${PROTECT_MOUNT_POINTS}
	@@${SUDO} mount -u -w ${_p}
.  endfor
	@@${SUDO} ${_MAKE_COOKIE} $@@

# The real install

${_INSTALL_COOKIE}:  ${_PACKAGE_COOKIES}
	@@cd ${.CURDIR} && DEPENDS_TARGET=install \
	    exec ${MAKE} run-depends lib-depends
	@@${ECHO_MSG} "===>  Installing ${FULLPKGNAME${SUBPACKAGE}} from ${PKGFILE${SUBPACKAGE}}"
.  for _m in ${MODULES}
.    if defined(MOD${_m:U}_pre_install)
	@@${MOD${_m:U}_pre_install}
.    endif
.  endfor
.  if ${TRUST_PACKAGES:L} == "yes"
	@@if ${PKG_CMD_PKG} dependencies check \
	    ${FULLPKGNAME${SUBPACKAGE}}; then \
		echo "Package ${FULLPKGNAME${SUBPACKAGE}} is already installed"; \
	else \
		${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} \
		    PKG_TMPDIR=${PKG_TMPDIR} PATH="${PKG_CMDDIR}:$$PATH" \
		    ${PKG_CMD_ADD} ${PKGFILE${SUBPACKAGE}}; \
	fi
.  else
	@@${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} \
	    PKG_TMPDIR=${PKG_TMPDIR} PATH="${PKG_CMDDIR}:$$PATH" \
	    ${PKG_CMD_ADD} ${PKGFILE${SUBPACKAGE}}
.  endif
	@@-${SUDO} ${_MAKE_COOKIE} $@@
.endif

# The real package

_package: ${_PKG_PREREQ}
.if target(pre-package)
	@@cd ${.CURDIR} && exec ${MAKE} pre-package
.endif
.if target(do-package)
	@@cd ${.CURDIR} && exec ${MAKE} do-package
.else
# What PACKAGE normally does:
	@@${ECHO_MSG} "===>  Building package for ${FULLPKGNAME${SUBPACKAGE}}"
	@@if [ ! -d ${PKGREPOSITORY} ]; then \
	   if ! mkdir -p ${PKGREPOSITORY}; then \
	      echo ">> Can't create directory ${PKGREPOSITORY}."; \
		  exit 1; \
	   fi; \
	fi
# PLIST should normally hold no duplicates.
# This is left as a warning, because stuff such as @@exec %F/%D
# completion may cause legitimate dups.
	@@duplicates=$$(sort <${WRKPKG}/PLIST${SUBPACKAGE} \
	    | egrep -v '@@(comment|mode|owner)' | uniq -d); \
	case "$${duplicates}" in "");; \
	*)	echo "\n*** WARNING *** Duplicates in PLIST:\n$$duplicates\n";; \
	esac
	@@cd ${.CURDIR} && if ${SUDO} ${SETENV} PATH="${PKG_CMDDIR}:$$PATH" \
	    ${PKG_CMD_CREATE} ${PKG_ARGS} ${PKGFILE${SUBPACKAGE}}; then \
		mode=$$(id -u):$$(id -g); \
		${SUDO} ${CHOWN} $${mode} ${PKGFILE${SUBPACKAGE}}; \
		${MAKE} _package-links; \
	  else \
		${SUDO} ${MAKE} CLEANDEPENDS=No clean=package; \
		exit 1; \
	  fi
# End of PACKAGE.
.endif
.if target(post-package)
	@@cd ${.CURDIR} && exec ${MAKE} post-package
.endif

fetch-all:
	@@cd ${.CURDIR} && exec ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes \
	    NO_IGNORE=Yes fetch

# Separate target for each file fetch will retrieve

.for _F in ${ALLFILES:S@@^@@${FULLDISTDIR}/@@}
${_F}:
.  if ${FETCH_MANUALLY:L} != "no"
.    for _M in ${FETCH_MANUALLY}
	@@echo "*** "${_M}
.    endfor
	@@exit 1
.  else
	@@mkdir -p ${_F:H}; \
	cd ${_F:H}; \
	select=${_EVERYTHING:M*${_F:S@@^${FULLDISTDIR}/@@@@}\:[0-9]}; \
	f=${_F:S@@^${FULLDISTDIR}/@@@@}; \
	${ECHO_MSG} ">> $$f doesn't seem to exist on this system."; \
	${_CDROM_OVERRIDE}; \
	${_SITE_SELECTOR}; \
	for site in $$sites; do \
		${ECHO_MSG} ">> Attempting to fetch ${_F} from $${site}."; \
		if ${FETCH_CMD} $${site}$$f; then \
				file=${_F:S@@^${DISTDIR}/@@@@}; \
				ck=$$(cd ${DISTDIR} && ${_size_fragment}); \
				if grep -qe "^$$ck\$$" -e "^$$(print "$$ck" \
				    | sed s/IZE/ize/) bytes\$$" ${CHECKSUM_FILE}; then \
					${ECHO_MSG} ">> Size matches for ${_F}"; \
					exit 0; \
				elif egrep -q "S(IZE|ize) \($$file\)" ${CHECKSUM_FILE}; then \
					${ECHO_MSG} ">> Size does not match for ${_F}"; \
				else \
					${ECHO_MSG} ">> No size recorded for ${_F}"; \
					exit 0; \
				fi; \
		fi; \
	done; exit 1
.  endif
.endfor

# Some support rules for do-package

_package-links:
	@@cd ${.CURDIR} && exec ${MAKE} _delete-package-links
.for _l in FTP CDROM
.  if ${PERMIT_PACKAGE_${_l}:L} == "yes"
	@@echo "Link to ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}"
	@@mkdir -p ${${_l}_PACKAGES}
	@@rm -f ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
	@@ln ${PKGFILE${SUBPACKAGE}} \
	  ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX} 2>/dev/null || \
	  cp -p ${PKGFILE${SUBPACKAGE}} \
	  ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
.  endif
.endfor

_delete-package-links:
.for _l in FTP CDROM
	@@rm -f ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
.endfor

# Cleaning up

clean:
.if ${_clean:L:Mdepends} && ${_CLEANDEPENDS:L} == "yes"
	@@${MAKE} all-dir-depends | tsort -r | while read dir; do \
		unset FLAVOR SUBPACKAGE || true; \
		${_flavor_fragment}; \
		eval $$toset ${MAKE} _CLEANDEPENDS=No clean; \
	done
.else
	@@${ECHO_MSG} "===>  Cleaning for ${FULLPKGNAME${SUBPACKAGE}}"
.  if ${_clean:L:Mfake}
	@@if cd ${WRKINST} 2>/dev/null; then ${SUDO} rm -rf ${WRKINST}; fi
.  endif
.  if ${_clean:L:Mwork}
.    if ${_clean:L:Mflavors}
	@@for i in ${.CURDIR}/w-*; do \
		if [ -L $$i ]; then ${SUDO} rm -rf $$(readlink $$i); fi; \
		${SUDO} rm -rf $$i; \
	done
.    else
	@@[ ! -L ${WRKDIR} ] || rm -rf $$(readlink ${WRKDIR})
	@@rm -rf ${WRKDIR}
.    endif
.  endif
.  if ${_clean:L:Mdist}
	@@${ECHO_MSG} "===>  Dist cleaning for ${FULLPKGNAME${SUBPACKAGE}}"
	@@if cd ${FULLDISTDIR} 2>/dev/null; then \
		if [ "${_DISTFILES}" -o "${_PATCHFILES}" ]; then \
			rm -f ${_DISTFILES} ${_PATCHFILES}; \
		fi \
	fi
.    if !empty(DIST_SUBDIR)
	-@@rmdir ${FULLDISTDIR}
.    endif
.  endif
.  if ${_clean:L:Minstall}
.    if ${_clean:L:Msub}
.      for _s in ${MULTI_PACKAGES}
	-${SUDO} ${SETENV} PATH="${PKG_CMDDIR}:$$PATH" \
	    ${PKG_CMD_DELETE} ${FULLPKGNAME${_s}}
.      endfor
.    else
	-${SUDO} ${SETENV} PATH="${PKG_CMDDIR}:$$PATH" \
	    ${PKG_CMD_DELETE} ${FULLPKGNAME${SUBPACKAGE}}
.    endif
.  endif
.  if ${_clean:L:Mpackages} || ${_clean:L:Mpackage} && ${_clean:L:Msub}
	rm -f ${_PACKAGE_COOKIES}
.    if defined(MULTI_PACKAGES)
.      for _s in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' exec ${MAKE} _delete-package-links
.      endfor
.    endif
.  elif ${_clean:L:Mpackage}
	@@cd ${.CURDIR} && exec ${MAKE} _delete-package-links
	rm -f ${PKGFILE${SUBPACKAGE}}
.  endif
.  if ${_clean:L:Mreadmes}
	rm -f ${.CURDIR}/${FULLPKGNAME}.html
.      for _s in ${MULTI_PACKAGES}
	rm -f ${.CURDIR}/${FULLPKGNAME${_s}}.html
.      endfor
.  endif
.  if ${_clean:L:Mbulk}
	rm -f ${_BULK_COOKIE}
.  endif
.endif

# packing list utilities.  This generates a packing list from a recently
# installed port.  Not perfect, but pretty close.  The generated file
# will have to have some tweaks done by hand.
# Note: add @@comment PACKAGE(arch=${MACHINE_ARCH},
#		opsys=${OPSYS}, vers=${OPSYS_VER})
# when port is installed or package created.
#
.if ${FAKE:L} == "yes"
plist update-plist: fake
	@@mkdir -p ${PKGDIR}
	@@DESTDIR=${WRKINST} PREFIX=${WRKINST}${PREFIX} LDCONFIG="${LDCONFIG}" \
	MTREE_FILE=${WRKPKG}/mtree.spec \
	INSTALL_PRE_COOKIE=${_INSTALL_PRE_COOKIE} \
	PKGREPOSITORY=${PKGREPOSITORY} \
	PLIST=${PLIST} \
	PFRAG=${PKGDIR}/PFRAG \
	FLAVORS='${FLAVORS}' MULTI_PACKAGES='${MULTI_PACKAGES}' \
	OKAY_FILES='${_FAKE_COOKIE} ${_INSTALL_PRE_COOKIE}' \
	perl ${PORTSDIR}/infrastructure/install/make-plist ${PKGDIR} ${_tmpvars}
.endif

update-patches:
	@@toedit=$$(WRKDIST=${WRKDIST} PATCHDIR=${PATCHDIR} \
	    PATCH_LIST='${PATCH_LIST}' DIFF_ARGS='${DIFF_ARGS}' \
	    DISTORIG=${DISTORIG} PATCHORIG=${PATCHORIG} ${_GDIFFLAG} \
	    ${SHELL} ${PORTSDIR}/infrastructure/build/update-patches); \
	case $$toedit in "");; \
	*) read i?'edit patches: '; \
	cd ${PATCHDIR} && $${VISUAL:-$${EDITOR:-/usr/bin/vi}} $$toedit;; esac


# mirroring utilities
fetch-makefile:
	@@echo -n "all"
.if ${PERMIT_DISTFILES_FTP:L} == "yes"
	@@echo -n " ftp"
.endif
.if ${PERMIT_DISTFILES_CDROM:L} == "yes"
	@@echo -n " cdrom"
.endif
	@@echo ":: ${_FMN}"
# write generic package dependencies
	@@echo ".PHONY: ${_FMN}"
.if ${RECURSIVE_FETCH_LIST:L} == "yes"
	@@echo "${_FMN}: ${_ALLFILES} "$$(_FULL_PACKAGE_NAME=Yes \
	    ${MAKE} full-all-depends)
.else
	@@echo "${_FMN}: ${_ALLFILES}"
.endif
	@@exec ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes \
	    NO_IGNORE=Yes _fetch-makefile

_fetch-makefile:
.if !empty(ALLFILES)
.  for _F in ${_ALLFILES}
	@@if ! fgrep -q "|${_F}|" $${_DONE_FILES}; then \
		echo "|${_F}|" >>$${_DONE_FILES}; \
		${MAKE} _fetch-onefile _file=${_F}; \
	fi
.  endfor
.endif
	@@echo


_fetch-onefile:
# XXX loop so that M${_F} will work
.for _F in ${_file}
	@@echo '${_F}: $$F'
	@@echo -n '\t@@RESPONSIBLE="${RESPONSIBLE}" '
.  if !empty(DIST_SUBDIR)
	@@echo -n 'DIST_SUBDIR="${DIST_SUBDIR}" '
.  endif
	@@echo '\\'
	@@select='${_EVERYTHING:M*${_F:S@@^${DIST_SUBDIR}/@@@@}\:[0-9]}'; \
	${_SITE_SELECTOR}; \
	echo "\t SITES=\"$$sites\" \\"
.  if ${FETCH_MANUALLY:L} != "no"
	@@echo '\t FETCH_MANUALLY="Yes" \\'
.  endif
.  if !defined(NO_CHECKSUM) && !empty(_CKSUMFILES:M${_F})
	@@checksum_file=${CHECKSUM_FILE}; \
	if [ ! -f $$checksum_file ]; then \
	  echo >&2 "Missing checksum file: $$checksum_file"; \
	  echo '\t ERROR="no checksum file" \\'; \
	else \
	  for c in ${_CIPHERS}; do \
		if set -- $$(grep -i "^$$c (${_F})" $$checksum_file); then \
			break; fi; \
	  done; \
	  case "$$4" in \
		"") \
		  echo >&2 "No checksum recorded for ${_F}."; \
		  echo '\t ERROR="no checksum" \\';; \
		"IGNORE") \
		  echo >&2 "Checksum for ${_F} is IGNORE in $$checksum_file"; \
		  echo >&2 'but file is not in $${IGNORE_FILES}'; \
		  echo '\t ERROR="IGNORE inconsistent" \\';; \
		*) \
		  echo "\t CIPHER=\"$$c\" CKSUM=\"$$4\" \\";; \
	  esac; \
	fi
.  endif
	@@echo '\t $${EXEC} $${FETCH} "$$@@"'
.endfor

# This target generates an index entry suitable for aggregation into
# a large index.  Format is:
#
# distribution-name|port-path|installation-prefix|comment|homepage| \
#  description-file|maintainer|categories|lib-deps|build-deps|run-deps| \
#  fos-os|for-arch|package-cdrom|package-ftp|distfiles-cdrom|distfiles-ftp
_EXTRA_DESCRIBE=""
.if defined(BROKEN)
_EXTRA_DESCRIBE+=	"(broken)"
.endif
.if ${USE_CXX:L} == "yes"
_EXTRA_DESCRIBE+=	"(uses C++)"
.endif
.if ${USE_X11:L} == "yes"
_EXTRA_DESCRIBE+=	"(uses X11)"
.endif
.if ${USE_GMAKE:L} == "yes"
_EXTRA_DESCRIBE+=	"(uses GNU Make)"
.endif
.if ${USE_SCHILY:L} == "yes"
_EXTRA_DESCRIBE+=	"(uses GNU Make) (uses Schily)"
.endif
.if ${USE_MOTIF:L} == "yes"
_EXTRA_DESCRIBE+=	"(uses Motif)"
.endif
.if ${_USE_ZIP:L} == "yes"
_EXTRA_DESCRIBE+=	"(uses PKZip)"
.endif
.if ${_USE_BZIP2:L} == "yes"
_EXTRA_DESCRIBE+=	"(uses BZip2)"
.endif
.for _i in ${EMUL}
_EXTRA_DESCRIBE+=	"(uses ${_i} personality)"
.endfor
.if ${_EXTRA_DESCRIBE} == ""
_EXTRA_DESCRIBE=
.endif
describe:
.if defined(MULTI_PACKAGES) && !defined(PACKAGING)
	@@cd ${.CURDIR} && SUBPACKAGE='${SUBPACKAGE}' FLAVOR='${FLAVOR}' \
	    PACKAGING='${SUBPACKAGE}' exec ${MAKE} describe
.  if empty(SUBPACKAGE)
.    for _sub in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' \
	    PACKAGING='${_sub}' exec ${MAKE} describe
.    endfor
.  endif
.else
	@@echo -n "${FULLPKGNAME${SUBPACKAGE}}|${FULLPKGPATH}|"
.  if ${PREFIX} == ${LOCALBASE}
	@@echo -n "|"
.  else
	@@echo -n "${PREFIX}|"
.  endif
	@@echo -n ${_COMMENT}${_EXTRA_DESCRIBE}"|${HOMEPAGE}|"; \
	if [ -f ${DESCR} ]; then \
		echo -n "${DESCR:S,^${PORTSDIR}/,,}|"; \
	else \
		echo -n "/dev/null|"; \
	fi; \
	echo -n "${RESPONSIBLE}|${CATEGORIES}|"
.  for _d in LIB BUILD RUN
.    if !empty(_${_d}_DEP2)
	@@cd ${.CURDIR} && _FINAL_ECHO=: _INITIAL_ECHO=: exec \
	    ${MAKE} ${_d:L}-depends-list
.    endif
	@@echo -n "|"
.  endfor
	@@case "${ONLY_FOR_OS}" in \
	 "") case "${NOT_FOR_OS}" in \
		 "") echo -n "BSD Linux|";; \
		 *) echo -n "!${NOT_FOR_OS}|";; \
		 esac;; \
	 *) echo -n "${ONLY_FOR_OS}|";; \
	 esac
	@@case "${ONLY_FOR_ARCHS}" in \
	 "") case "${NOT_FOR_ARCHS}" in \
		 "") echo -n "any|";; \
		 *) echo -n "!${NOT_FOR_ARCHS}|";; \
		 esac;; \
	 *) echo -n "${ONLY_FOR_ARCHS}|";; \
	 esac

.  if defined(_BAD_LICENSING)
	@@echo "?|?|?|?"
.  else
.    if ${PERMIT_PACKAGE_CDROM:L} == "yes"
	@@echo -n "y|"
.    else
	@@echo -n "n|"
.    endif
.    if ${PERMIT_PACKAGE_FTP:L} == "yes"
	@@echo -n "y|"
.    else
	@@echo -n "n|"
.    endif
.    if ${PERMIT_DISTFILES_CDROM:L} == "yes"
	@@echo -n "y|"
.    else
	@@echo -n "n|"
.    endif
.    if ${PERMIT_DISTFILES_FTP:L} == "yes"
	@@echo "y"
.    else
	@@echo "n"
.    endif
.  endif
.endif

readmes:
.if defined(MULTI_PACKAGES) && !defined(PACKAGING)
	@@cd ${.CURDIR} && SUBPACKAGE='${SUBPACKAGE}' FLAVOR='${FLAVOR}' \
	    PACKAGING='${SUBPACKAGE}' exec ${MAKE} readmes
.  if empty(SUBPACKAGE)
.    for _sub in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' \
	    PACKAGING='${_sub}' exec ${MAKE} readmes
.    endfor
.  endif
.else
	@@rm -f ${FULLPKGNAME${SUBPACKAGE}}.html
	@@cd ${.CURDIR} && exec ${MAKE} README_NAME=${README_NAME} \
	    ${FULLPKGNAME${SUBPACKAGE}}.html
.endif


${FULLPKGNAME${SUBPACKAGE}}.html:
	@@echo ${_COMMENT} | ${HTMLIFY} >$@@.tmp-comment
	@@echo ${FULLPKGNAME${SUBPACKAGE}} | ${HTMLIFY} >$@@.tmp3
.if defined(HOMEPAGE)
	@@echo 'See <a href="${HOMEPAGE}">${HOMEPAGE}</a> for details.' >$@@.tmp4
.else
	@@echo "" >$@@.tmp4
.endif
.if defined(MULTI_PACKAGES)
.  if empty(SUBPACKAGE)
	@@echo "<h2>Subpackages</h2>" >$@@.tmp-subpackages
	@@echo "<ul>" >>$@@.tmp-subpackages

.    for _S in ${MULTI_PACKAGES}
	@@name=$$(SUBPACKAGE=${_S} ${MAKE} _print-packagename \
	    _FULL_PACKAGE_NAME=No); \
	echo "<li><a href=\"$$name.html\">$$name</a>" >>$@@.tmp-subpackages
.    endfor
	@@echo "</ul>" >>$@@.tmp-subpackages
.  else
	@@name=$$(unset SUBPACKAGE; ${MAKE} _print-packagename \
	    _FULL_PACKAGE_NAME=No); \
	echo "<h2>Subpackage of <a href=\"$$name.html\">$$name</a></h2>" \
	    >$@@.tmp-subpackages
.  endif
.else
	@@>$@@.tmp-subpackages
.endif
.for _I in build run
.  if !empty(_ALWAYS_DEP) || !empty(_${_I:U}_DEP)
	@@cd ${.CURDIR} && ${MAKE} full-${_I}-depends _FULL_PACKAGE_NAME=Yes \
	    | while read n; do \
		j=$$(dirname $$n|${HTMLIFY}); k=$$(basename $$n|${HTMLIFY}); \
		echo "<li><a href=\"${PKGDEPTH}$$j/$$k.html\">$$k</a>"; \
	    done  >$@@.tmp-${_I}
.  else
	@@echo "<li>none" >$@@.tmp-${_I}
.  endif
.endfor
	@@cat ${README_NAME} | sed \
	    -e 's|%%PORT%%|'"$$(echo ${FULLPKGPATH}  | ${HTMLIFY})"'|g' \
	    -e '/%%PKG%%/r$@@.tmp3' -e '//d' \
	    -e '/%%COMMENT%%/r$@@.tmp-comment' -e '//d' \
	    -e '/%%DESCR%%/r${PKGDIR}/DESCR${SUBPACKAGE}' -e '//d' \
	    -e '/%%HOMEPAGE%%/r$@@.tmp4' -e '//d' \
	    -e '/%%BUILD_DEPENDS%%/r$@@.tmp-build' -e '//d' \
	    -e '/%%RUN_DEPENDS%%/r$@@.tmp-run' -e '//d' \
 	    -e '/%%SUBPACKAGES%%/r$@@.tmp-subpackages' -e '//d' \
	    >>$@@
	@@rm -f $@@.tmp*


print-build-depends:
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP)
	@@echo -n 'This port requires package(s) "'
	@@${MAKE} full-build-depends|tr '\012' '\040'|sed -e 's, $$,,'
	@@echo '" to build.'
.endif

print-run-depends:
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
	@@echo -n 'This port requires package(s) "'
	@@${MAKE} full-run-depends|tr '\012' '\040'|sed -e 's, $$,,'
	@@echo '" to run.'
.endif

print-all-depends:
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP) || !empty(_BUILD_DEP)
	@@echo -n 'This port requires package(s) "'
	@@${MAKE} full-all-depends|tr '\012' '\040'|sed -e 's, $$,,'
	@@echo '" to run.'
.endif

print-depends: print-build-depends print-run-depends
	# Nothing to do...

.for _i in build all run
full-${_i}-depends:
	@@${MAKE} ${_i}-dir-depends | tsort -r | sed -e '$$d' \
	    | while read dir; do \
		unset FLAVOR SUBPACKAGE || true; \
		${_flavor_fragment}; \
		eval $$toset ${MAKE} _print-packagename ; \
	done
.endfor

relevant-checks:
.if ${PERMIT_PACKAGE_CDROM:L} == "yes" || ${PERMIT_PACKAGE_FTP:L} == "yes" \
    || ${USE_CXX:L} == "yes" || ${USE_X11:L} == "yes"
	@@${MAKE} all-dir-depends | tsort -r | sed -e '$$d' \
	    | while read dir; do \
		unset FLAVOR SUBPACKAGE || true; \
		${_flavor_fragment}; \
		export _MASTER_PERMIT_CDROM=${PERMIT_PACKAGE_CDROM:Q} \
		    _MASTER_PERMIT_FTP=${PERMIT_PACKAGE_FTP:Q} \
		    _MASTER_USE_CXX=${USE_CXX:Q} \
		    _MASTER_USE_X11=${USE_X11:Q}; \
		eval $$toset ${MAKE} _relevant-checks; \
	done
.endif

_relevant-checks:
.for _i in FTP CDROM
.  if defined(_MASTER_PERMIT_${_i}) \
    && ${_MASTER_PERMIT_${_i}:L} == "yes" && ${PERMIT_PACKAGE_${_i}:L} != "yes"
	@@echo >&2 "Warning: dependency ${PKGPATH} is not allowed for ${_i}"
.  endif
.endfor
.for _i in CXX X11
.  if defined(_MASTER_USE_${_i}) \
    && ${_MASTER_USE_${_i}:L} != "yes" && ${USE_${_i}:L} == "yes"
	@@echo >&2 "Warning: dependency ${PKGPATH} uses ${_i}"
.  endif
.endfor

.for _i in RUN BUILD LIB
${_i:L}-depends-list:
.  if !empty(_${_i}_DEP2)
	@@unset FLAVOR SUBPACKAGE || true; \
	: $${_INITIAL_ECHO:='echo -n "This port requires \""'}; \
	: $${_ECHO='echo -n'}; \
	: $${_FINAL_ECHO:='echo "\" for ${_i:L}."'}; space=''; \
	eval $${_INITIAL_ECHO}; \
	for spec in $$(echo '${_${_i}_DEP2}' \
		| tr '\040' '\012' | sort -u); do \
		$${_ECHO} "$$space$${spec}"; \
		space=' '; \
	done; eval $${_FINAL_ECHO}
.  endif
.endfor

# recursive depend targets

# Print list of all libraries that we may depend upon.
_recurse-lib-depends-check:
.for _i in  ${LIB_DEPENDS}
	@@unset FLAVOR SUBPACKAGE  || true; \
	echo '${_i}' | { \
		IFS=:; read dep pkg dir target; \
		IFS=,; for j in $$dep; do echo $$j; done; \
		if ! fgrep -q "|$$dir|" $${_DEPENDS_FILE}; then \
			echo "|$$dir|" >>$${_DEPENDS_FILE}; \
			${_flavor_fragment}; \
			eval $$toset ${MAKE} _recurse-lib-depends-check; \
		fi; \
	}
.endfor
.for _i in  ${RUN_DEPENDS}
	@@unset FLAVOR SUBPACKAGE  || true; \
	echo '${_i}' | { \
		IFS=:; read dep pkg dir target; \
		if ! fgrep -q "|$$dir|" $${_DEPENDS_FILE}; then \
			echo "|$$dir|" >>$${_DEPENDS_FILE}; \
			${_flavor_fragment}; \
			eval $$toset ${MAKE} _recurse-lib-depends-check; \
		fi; \
	}
.endfor


# Write a correct list of dependencies for packages.
_recurse-solve-package-depends:
.for _i in ${RUN_DEPENDS}
	@@unset FLAVOR SUBPACKAGE || true; \
	echo '${_i}' |{ \
		IFS=:; read dep pkg dir target; \
		if [[ -n $$dir ]]; then \
			${_flavor_fragment}; \
			default=$$(eval $$toset ${MAKE} _print-packagename); \
		else \
			default=nonexistent; \
		fi; \
		: $${pkg:=$$default}; \
		echo "@@newdepend $$self:$$pkg:$$default" >>$${_depends_result}; \
		if fgrep -q "|$$default|" $${_DEPENDS_FILE}; then \
			: ; \
		elif [[ -n $$dir ]]; then \
			echo "|$$default|" >>$${_DEPENDS_FILE}; \
			toset="$$toset self=\"$$default\""; \
			if ! eval $$toset ${MAKE} \
			    _recurse-solve-package-depends; then  \
				echo 1>&2 "*** Problem checking deps in \"$$dir\"." ; \
				exit 1; \
			fi; \
		fi; }
.endfor
.if ${NO_SHARED_LIBS:L} != "yes"
.  for _i in ${LIB_DEPENDS}
	@@unset FLAVOR SUBPACKAGE || true; \
	echo '${_i}'|{ \
		IFS=:; read dep pkg dir target; \
		${_flavor_fragment}; \
		libspecs='';comma=''; \
		default=$$(eval $$toset ${MAKE} _print-packagename); \
		case "X$$pkg" in \
		X)	pkg=$$(echo $$default | sed -e 's,-[0-9].*,-*,');; \
		esac; \
		newdep=; comma=; \
		if ${PKG_CMD_PKG} dependencies check $$pkg; then \
			listlibs='ls /usr/lib $$shdir 2>/dev/null'; \
		else \
			listlibs='ls /usr/lib 2>/dev/null'; \
			IFS=,; for d in $$dep; do \
				${_libresolve_fragment}; \
				case "$$check" in \
				*.a|Missing\ library|Error:*) \
					newdep="$$newdep$$comma$$d"; \
					comma=',' ;; \
				esac; \
			done; \
			comma=; dep="$$newdep"; \
		fi; \
		if [[ -n $$newdep ]]; then \
			eval $$toset ${MAKE} \
			    ${PKGREPOSITORY}/$$default${PKG_SUFX}; \
			listlibs='${SETENV} PATH="${PKG_CMDDIR}:$$PATH" \
			    ${PKG_CMD_INFO} -L \
			    ${PKGREPOSITORY}/$$default${PKG_SUFX} \
			    | grep $$shdir | sed -e "s,^$$shdir/,,"'; \
		fi; \
		IFS=,; for d in $$dep; do \
			${_libresolve_fragment}; \
			case "$$check" in \
			*.a) continue;; \
			Missing\ library|Error:*) \
				echo 1>&2 "Can't resolve libspec $$d"; \
				exit 1;; \
			*) \
				libspecs="$$libspecs$$comma$$shprefix$$check"; \
				comma=',';; \
			esac; \
		done; \
		case "X$$libspecs" in \
		X) ;;\
		*) \
			echo "@@libdepend $$self:$$libspecs:$$pkg:$$default" \
			    >>$${_depends_result}; \
			if ! fgrep -q "|$$default|" $${_DEPENDS_FILE}; then \
				echo "lib|$$default|" >>$${_DEPENDS_FILE}; \
				toset="$$toset self=\"$$default\""; \
				if ! eval $$toset ${MAKE} \
				    _recurse-solve-package-depends; then  \
					echo 1>&2 "*** Problem checking deps in \"$$dir\"." ; \
					exit 1; \
				fi; \
			fi;; \
		esac; \
	}
.  endfor
.endif

# recursively build a list of dirs for package running, ready for tsort
_recurse-run-dir-depends:
.for _dir in ${_ALWAYS_DEP} ${_RUN_DEP}
	@@unset FLAVOR SUBPACKAGE || true; \
	echo "$$self ${_dir}"; \
	if ! fgrep -q "|${_dir}|" $${_DEPENDS_FILE}; then \
		echo "|${_dir}|" >>$${_DEPENDS_FILE}; \
		dir=${_dir}; \
		${_flavor_fragment}; \
		toset="$$toset self=\"${_dir}\""; \
		if ! eval $$toset ${MAKE} _recurse-run-dir-depends; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
			exit 1; \
		fi; \
	fi
.endfor

run-dir-depends:
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
	@@${_depfile_fragment}; \
	if ! fgrep -q "|${FULLPKGPATH}|" $${_DEPENDS_FILE}; then \
		echo "|${FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
		self=${FULLPKGPATH} PACKAGING='${SUBPACKAGE}' \
		${MAKE} _recurse-run-dir-depends; \
	fi
.else
	@@echo "${FULLPKGPATH} ${FULLPKGPATH}"
.endif

# recursively build a list of dirs for package building, ready for tsort
# second and further stages need _RUN_DEP.
_recurse-all-dir-depends:
.for _dir in ${_ALWAYS_DEP} ${_BUILD_DEP} ${_RUN_DEP}
	@@unset FLAVOR SUBPACKAGE || true; \
	echo "$$self ${_dir}"; \
	if ! fgrep -q "|${_dir}|" $${_DEPENDS_FILE}; then \
		echo "|${_dir}|" >>$${_DEPENDS_FILE}; \
		dir=${_dir}; \
		${_flavor_fragment}; \
		toset="$$toset self=\"${_dir}\""; \
		if ! eval $$toset ${MAKE} _recurse-all-dir-depends; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
			exit 1; \
		fi; \
	fi
.endfor

# first stage does not need _RUN_DEP
_build-dir-depends:
.for _dir in ${_ALWAYS_DEP} ${_BUILD_DEP}
	@@unset FLAVOR SUBPACKAGE || true; \
	echo "$$self ${_dir}"; \
	if ! fgrep -q "|${_dir}|" $${_DEPENDS_FILE}; then \
		echo "|${_dir}|" >>$${_DEPENDS_FILE}; \
		dir=${_dir}; \
		${_flavor_fragment}; \
		toset="$$toset self=\"${_dir}\""; \
		if ! eval $$toset ${MAKE} _recurse-all-dir-depends; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
			exit 1; \
		fi; \
	fi
.endfor

build-dir-depends:
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP)
	@@${_depfile_fragment}; \
	if ! fgrep -q "|${FULLPKGPATH}|" $${_DEPENDS_FILE}; then \
		echo "|${FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
		self=${FULLPKGPATH} ${MAKE} _build-dir-depends; \
	fi
.else
	@@echo "${FULLPKGPATH} ${FULLPKGPATH}"
.endif

all-dir-depends:
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || !empty(_RUN_DEP)
	@@${_depfile_fragment}; \
	if ! fgrep -q "|${FULLPKGPATH}|" $${_DEPENDS_FILE}; then \
		echo "|${FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
		self=${FULLPKGPATH} ${MAKE} _recurse-all-dir-depends; \
	fi
.else
	@@echo "${FULLPKGPATH} ${FULLPKGPATH}"
.endif

link-categories:
.for _CAT in ${CATEGORIES}
	@@linkname=${PORTSDIR}/${_CAT}/$$(basename ${.CURDIR}); \
	if [ ! -e $$linkname ]; then \
		echo "$$linkname -> ${.CURDIR}"; \
		mkdir -p ${PORTSDIR}/${_CAT}; \
		ln -s ${.CURDIR} $$linkname; \
	fi
.endfor

unlink-categories:
.for _CAT in ${CATEGORIES}
	@@linkname=${PORTSDIR}/${_CAT}/$$(basename ${.CURDIR}); \
	if [ -L $$linkname ]; then \
		echo "rm $$linkname"; \
		rm $$linkname; \
		if rmdir ${PORTSDIR}/${_CAT} 2>/dev/null; then \
			echo "rmdir ${PORTSDIR}/${_CAT}"; \
	    fi; \
	fi
.endfor

homepage-links:
.if defined(HOMEPAGE)
	@@echo '<li><a href="${HOMEPAGE}">${PKGNAME}</a>'
.else
	@@echo '<li>${PKGNAME}'
.endif

.if ${FAKE:L} == "no"
.  include "${PORTSDIR}/infrastructure/mk/old-install.mk"
.endif

#####################################################
# convenience targets, not really needed
#####################################################

checkpatch:
	@@cd ${.CURDIR} && exec ${MAKE} PATCH_CHECK_ONLY=Yes patch

clean-depends:
	@@cd ${.CURDIR} && exec ${MAKE} clean=depends

distclean:
	@@cd ${.CURDIR} && exec ${MAKE} CLEANDEPENDS=No clean=dist

cleandir:
	@@cd ${.CURDIR} && exec ${MAKE} CLEANDEPENDS=Yes clean

delete-package:
	@@cd ${.CURDIR} && exec ${MAKE} CLEANDEPENDS=No clean=package

reinstall:
	@@cd ${.CURDIR} && exec ${MAKE} clean='install force'
	@@cd ${.CURDIR} && DEPENDS_TARGET=${DEPENDS_TARGET} exec ${MAKE} install

repackage:
	@@cd ${.CURDIR} && exec ${MAKE} CLEANDEPENDS=No clean=packages
	@@cd ${.CURDIR} && exec ${MAKE} package

rebuild:
	@@rm -f ${_BUILD_COOKIE}
	@@cd ${.CURDIR} && exec ${MAKE} build

uninstall deinstall:
	@@${ECHO_MSG} "===> Deinstalling for ${FULLPKGNAME${SUBPACKAGE}}"
	@@${SUDO} ${SETENV} PATH="${PKG_CMDDIR}:$$PATH" \
	    ${PKG_CMD_DELETE} ${FULLPKGNAME${SUBPACKAGE}}

.if defined(ERRORS)
.BEGIN:
.  for _m in ${ERRORS}
	@@echo 1>&2 ${_m} "(in ${PKGPATH})"
.  endfor
	@@exit 1
.endif

.PHONY: \
	_build-dir-depends _delete-package-links \
	_fetch-makefile _fetch-onefile \
	_package _package-links _print-packagename \
	_recurse-all-dir-depends _recurse-lib-depends-check \
	_recurse-run-dir-depends _recurse-solve-package-depends _refetch \
	addsum \
	all all-dir-depends build \
	build-depends build-depends-list build-dir-depends \
	checkpatch checksum clean cleandir \
	clean-depends configure deinstall \
	delete-package \
	depends \
	describe distclean distpatch \
	do-build do-configure do-distpatch \
	do-extract do-fetch do-install \
	do-package do-regress extract \
	fake fetch fetch-all \
	fetch-makefile full-all-depends full-build-depends \
	full-run-depends homepage-links install \
	lib-depends lib-depends-check lib-depends-list \
	link-categories makesum manpages-check \
	package patch \
	plist post-build post-configure \
	post-distpatch post-extract post-fetch \
	post-install post-package post-patch \
	post-regress pre-build pre-configure \
	pre-extract pre-fake pre-fetch \
	pre-install pre-package pre-patch \
	pre-regress print-build-depends print-run-depends \
	_print-uses readmes rebuild \
	regress regress-depends \
	reinstall repackage run-depends \
	run-depends-list run-dir-depends show \
	uninstall unlink-categories update-patches \
	update-plist unconfigure \
	relevant-checks _relevant-checks
@


1.179
log
@don't use ${SUDO} on make clean, since we do not, I repeat
do not, have a relinking issue with libtool, according to
the source.

this breaks a 'make clean' in python; I'd like someone (I
don't care who it is) to fix that. bsiegert@@ once told me
about the problem... something's built on 'make fake'. I
don't remember exactly, though.

whereelse this breaks is a bug and should be reported to me.
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.178 2005/03/06 16:43:11 bsiegert Exp $
a707 1
LDCONFIG_SED_SCRIPT?=	${PORTSDIR}/infrastructure/install/ldconfig-new.sed
a1253 4
	if fgrep 'DYNLIBDIR(' $@@ >/dev/null 2>&1; then \
		echo 'Error: old-style shared libraries in PLIST/PFRAG!'; \
		exit 1; \
	fi
d1255 3
a1257 14
	@@if [ -x /sbin/ldconfig ]; then \
		sed -e '/^!%%SHARED%%$$/d' \
		    -e '/^%%!SHARED%%$$/d' \
		    -e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' \
		    -e '//d' \
		    <${PLIST} ${SED_PLIST} | sed -f ${LDCONFIG_SED_SCRIPT} \
		    >>$@@.tmp && mv -f $@@.tmp $@@; \
	else \
		sed -e '/^!%%SHARED%%$$/d' \
		    -e '/^%%!SHARED%%$$/d' \
		    -e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' \
		    -e '//d' <${PLIST} ${SED_PLIST} \
		    >>$@@.tmp && mv -f $@@.tmp $@@; \
	fi
@


1.178
log
@Replace the @@dylib token in PLISTs with @@option dylib. Also document this
in pkg_create(1).

agreed tg@@
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.177 2005/03/03 16:15:48 tg Exp $
d2098 2
a2099 2
	@@if [ -L ${WRKDIR} ]; then ${SUDO} rm -rf $$(readlink ${WRKDIR}); fi
	@@${SUDO} rm -rf ${WRKDIR}
@


1.177
log
@remove special case handling of ${MAINTAINER},
just use it - like ${WANTLIB} - as a case of OpenBSD legacy

this also removes ${MNTNER}, the maintainer of
a port has always been ${RESPONSIBLE} (since 2004 or so)
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.176 2005/03/03 16:03:34 tg Exp $
d1248 1
a1248 1
		echo '@@dylib' >>$@@.tmp; \
@


1.176
log
@mark unmodified OpenBSD ports as broken
only a cautious measure, because you _want_ to look after them
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.175 2005/03/02 22:17:47 tg Exp $
d9 1
a9 1
# Each port has a MNTNER, which is the email address(es) of the person(s)
d12 1
a12 1
#	make show=MNTNER
d102 1
a102 1
ERRORS+=		"    ${MNTNER}"
d614 2
a615 2
SUBST_VARS+=		MACHINE_ARCH ARCH HOMEPAGE MNTNER PREFIX SYSCONFDIR \
			FLAVOR_EXT MAINTAINER RESPONSIBLE
a881 6
.if defined(MAINTAINER) && !empty(MAINTAINER)
MAINTAINER_OS?=		OpenBSD
MNTNER=			${RESPONSIBLE} (${MAINTAINER_OS} port contributed by ${MAINTAINER})
.else
MNTNER=			${RESPONSIBLE}
.endif
d951 1
a951 1
.if defined(WANTLIB)
d1290 1
a1290 1
	@@echo "\nMaintainer: ${MNTNER}" >>$@@
a2213 1
	@@echo -n '\t@@MAINTAINER="${MAINTAINER}" '
d2311 1
a2311 1
	echo -n "${MNTNER}|${CATEGORIES}|"
@


1.175
log
@experimental lib*.dylib support using PFRAG.dylib,
including an untested perl hack (I don't know perl
and still got to do this, aww) to create them

I wonder why I have to do this - on a PC notebook!
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.174 2005/03/02 15:21:52 tg Exp $
d956 4
@


1.174
log
@accept NetBSD(tm) pkgsrc-style SIZEs, too - they matter as well
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.173 2005/02/28 22:23:37 tg Exp $
d1242 19
@


1.173
log
@allow osdep overriding the portpath
allow bsiegert@@ to not use /usr/mpkg/etc
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.172 2005/02/28 20:35:04 tg Exp $
d2024 2
a2025 1
				if grep -q "^$$ck\$$" ${CHECKSUM_FILE}; then \
d2028 1
a2028 1
				elif grep -q "SIZE ($$file)" ${CHECKSUM_FILE}; then \
@


1.172
log
@switch to $PKG_CMDDIR/mirports_tar for creating packages
on Darwin (and maybe later, on old MirOS and OpenBSD versions),
this is MirCpio (which is built by darwin-setup.sh)
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.170 2005/02/27 13:19:17 tg Exp $
d414 2
a415 1
PORTPATH?=		${WRKDIR}/bin:/usr/bin:/bin:/usr/sbin:/sbin:${LOCALBASE}/bin:${X11BASE}/bin
@


1.171
log
@forgot a semi-colon
@
text
@d855 1
a855 1
			    ${FULLDISTDIR}/$$archive | cpio -mid ;;
d857 1
a857 1
EXTRACT_CASES+=		*.tar | *.cpio) cpio -mid <${FULLDISTDIR}/$$archive ;;
d860 1
a860 1
			    | ${SHELL};;
d862 1
a862 1
			    ${FULLDISTDIR}/$$archive | ${SHELL};;
d864 1
a864 1
			    ${FULLDISTDIR}/$$archive | cpio -mid ;;
d866 1
a866 1
			    >$$(basename $$archive .gz);;
d868 1
a868 1
			    | ${TAR} xf -;;
d873 1
a873 1
			    | ${PATCH} ${PATCH_DIST_ARGS};;
d876 2
a877 2
			    | ${PATCH} ${PATCH_DIST_ARGS};;
PATCH_CASES+=		*) ${PATCH} ${PATCH_DIST_ARGS} <$$patchfile;;
@


1.170
log
@forgot line continuation :(
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.169 2005/02/27 13:13:47 tg Exp $
d1284 1
a1284 1
		s="$$s    "; print "$$s$$pc" \
@


1.169
log
@replace tar by cpio

Mac OSX doesn't have paxtar and can't handle cpio,
but cpio can handle ustar and old tar, and gtar is
irrelevant(tm)
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.168 2005/02/27 13:01:10 tg Exp $
d1282 3
a1284 3
	@@(print '/@@@@local/d\ni\n'; IFS=/; s=;
	 for pc in $$(print '${LOCALBASE}'); do
		s="$$s    "; print "$$s$$pc"
@


1.168
log
@whoops, inserted way too much
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.167 2005/02/26 13:10:48 tg Exp $
d855 1
a855 1
			    ${FULLDISTDIR}/$$archive | ${TAR} xf -;;
d857 1
a857 1
EXTRACT_CASES+=		*.tar | *.cpio) ${TAR} xf ${FULLDISTDIR}/$$archive;;
d864 1
a864 1
			    ${FULLDISTDIR}/$$archive | ${TAR} xf -;;
@


1.167
log
@correct the use of IFS and ed
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.166 2005/02/24 19:26:49 tg Exp $
d1284 1
a1284 1
		s="$$s    "; print '/@@@@local/i\n'"$$s$$pc"
@


1.166
log
@* use mtree for building /usr/mpkg/* on Darwin
* fix mtree spec for the ${LOCALBASE} != "/usr/local" case
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.165 2005/02/23 18:04:18 tg Exp $
d1282 4
a1285 4
	@@(export IFS=/; s=; for pc in $$(print '${LOCALBASE}'); do \
		s="$$s    "; print '/@@@@local/i\n'"$$s$$pc"'\n.\nwq' \
		    | ed -s $@@.tmp; \
	  done; print '/@@@@local/d\nwq' | ed -s $@@.tmp)
@


1.165
log
@first step at supporting MirPorts on Mac OSX (tee emm, or err, or something)
* no shared libraries
* no "provided setup script" right now
* two things to fix in mirmake

while here,
* ekkoBSD is history
* lowercase HTML tags
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.164 2005/02/20 13:18:26 tg Exp $
d1281 6
a1286 1
	@@${_SED_SUBST} ${MTREE_FILE}>$@@.tmp && mv -f $@@.tmp $@@
@


1.164
log
@now, with SHA-1 being broken for (pretty) sure, check
all available checksums on a file, not only the first
"good" one.

Could someone please test this on #7ter in the follo-
wing two ports: archivers/arc; archivers/lha
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.163 2005/02/14 18:45:46 tg Exp $
d429 1
a429 1
.if ${_CC_IS_GCC:M3.4*}
d2715 1
a2715 1
	@@echo '<li><A HREF="${HOMEPAGE}">${PKGNAME}</A>'
@


1.163
log
@-idirafter, even
/usr/include is system, so it comes first
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.162 2005/02/14 18:42:07 tg Exp $
d412 1
a412 4
_CIPHERS=		sha1 rmd160 md5 sha512

# This is the one you can override
PREFERRED_CIPHERS?=	${_CIPHERS}
d1523 2
a1524 1
			for cipher in ${PREFERRED_CIPHERS}; do \
d1530 25
a1554 3
				set -- $$(grep -i "^$$cipher ($$file)" \
				    $$checksum_file) && break || \
				    ${ECHO_MSG} ">> No $$cipher checksum recorded for $$file."; \
d1556 1
a1556 19
			case "$$4" in \
			"") \
				${ECHO_MSG} ">> No checksum recorded for $$file."; \
				OK=false;; \
			"IGNORE") \
				echo ">> Checksum for $$file is set to IGNORE in md5 file even though"; \
				echo "   the file is not in the "'$$'"{IGNOREFILES} list."; \
				OK=false;; \
			*) \
				CKSUM=$$(${_CKSUM_A} $$cipher <$$file); \
				case "$$CKSUM" in \
			  	"$$4") \
					${ECHO_MSG} ">> Checksum OK for $$file. ($$cipher)";; \
				*) \
					echo ">> Checksum mismatch for $$file. ($$cipher)"; \
					list="$$list $$file $$cipher $$4"; \
					OK=false;; \
				esac;; \
			esac; \
d2208 1
a2208 1
	  for c in ${PREFERRED_CIPHERS}; do \
@


1.162
log
@make /usr/local/include an -isystem not an -I, so it gets taken last
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.161 2005/02/13 02:47:01 tg Exp $
d420 1
a420 1
CPPFLAGS+=		-isystem ${LOCALBASE}/include
@


1.161
log
@support running configure scripts under -Werror (MirGCC 3.4 only)
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.160 2005/02/10 22:15:47 tg Exp $
d420 1
a420 1
CPPFLAGS+=		-I${LOCALBASE}/include
@


1.160
log
@documentary update, and nuke the licence boilerplates
I still consider the MirPorts to be licenced under the
same terms and with the same authors as MirOS base, but
it's such a conglomerate...
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.159 2005/02/06 00:59:06 tg Exp $
a42 5
.ifndef _CC_IS_GCC
ERRORS+=		"You must use 'make setup' in the top-level MirPorts"
ERRORS+=		"directory in order to install the infrastructure."
.endif

d432 4
d1116 1
a1116 1
	    INSTALL_SCRIPT="${INSTALL_SCRIPT}" LD="${LD}" \
@


1.159
log
@bsiegert@@ caught me off cold, SYSCONFDIR as SUBST_VAR _is_ a
good idea (@@cwd and stuff).

Sometimes, two pairs of eyes just see more than one...
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.157 2005/01/09 12:28:15 tg Exp $
a7 2
# Each infrastructure file is licenced under the terms and conditions
# set forth in ports/README by the MirPorts Framework team.
d17 1
a17 4
#
# The definitive source of documentation to this file's user-visible parts
# is bsd.port.mk(5) which could need updates more often.
#
a42 4
.ifndef	MIRPORTS_SYS_MK
ERRORS+=		"Please upgrade your system Makefile includes. See"
ERRORS+=		"http://mirbsd.bsdadvocacy.org/?ports for instructions."
.endif
@


1.158
log
@SYSCONFDIR should not be a SUBST_VAR
rationale:
+share/examples/mirex${SYSCONFDIR}_profile
(from PLIST)
@
text
@d626 1
a626 1
SUBST_VARS+=		MACHINE_ARCH ARCH HOMEPAGE MNTNER PREFIX \
@


1.157
log
@sync with openbsd
yea, size matters now (from pedro martelletto ;)
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.156 2004/12/18 17:17:41 tg Exp $
d626 1
a626 1
SUBST_VARS+=		MACHINE_ARCH ARCH HOMEPAGE MNTNER PREFIX SYSCONFDIR \
@


1.156
log
@move some USE_*?= from bsd.port.mk to mirports.sys.mk
@
text
@d1 2
a2 2
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.155 2004/12/16 20:44:18 tg Exp $
# $OpenBSD: bsd.port.mk,v 1.617 2004/06/06 11:49:08 espie Exp $
d167 8
d620 1
a620 1
SYSTRACE_SUBST_VARS+=	WRKDIR PORTSDIR DISTDIR TMPDIR PKG_TMPDIR
d1185 3
d1320 4
d1339 4
d1441 1
a1441 1
		xargs objdump -p 2>/dev/null |\
d2024 11
a2034 1
				exit 0; \
d2213 1
a2213 1
	  echo >&2 'Missing checksum file: $$checksum_file'; \
@


1.155
log
@add a new plist item:
	@@ldcache 0
	@@ldcache 1

only during @@ldcache 1 sessions, @@lib automatically
adds the exec/unexec ldconfig calls.

not tested, but since @@lib is not used anywhere, I
commit it anyway, so Benny has got less work

the <bsd.port.mk> logic is correct, and a simple port
still installs with the new tools.
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.154 2004/12/16 19:42:31 tg Exp $
a60 1
USE_SYSTRACE?=		Yes
a241 2
USE_GMAKE?=		No
USE_SCHILY?=		No
a270 2
USE_MOTIF?=		No

a438 2
USE_X11?=		No
USE_CXX?=		No
@


1.154
log
@* document that people must use 'make setup' in order
  to install the infrastructure - even #7-stable users
  - agreed bsiegert@@ after quite some discussion
* create a point in time which checks for that. manual
  installation will not work any more, because a new
  variable set in /etc/mk.conf will be checked by the
  <*.mk> files now.
* the new variable is ${_CC_IS_GCC} which contains
  either "no" or the GCC version if ${CC} is a gcc
  at the time of 'make setup' execution - this means
  #7 users might have to type 'make setup MKC_EGCC=yes'
  if they are going to use that.
  - prodded by sap@@ for GNU emacs
  and no, I don't know if you can use ${...} >= "3.4"
* who volunteers to update /?ports in www?
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.153 2004/12/15 20:55:48 tg Exp $
d1238 5
@


1.153
log
@while here: 'make plist' has not needed run depend cookies
since I added the rcdb stuff and enhanced @@dirrm ...
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.151 2004/12/07 15:59:13 tg Exp $
d51 4
@


1.152
log
@fix some abuse of hardcoded /bin/sh
add EXTRA_{M,F,X}AKE_FLAGS variable
(XAKE = MAKE + FAKE)
@
text
@d2107 1
a2107 1
plist update-plist: fake ${_DEPrun_COOKIES}
@


1.151
log
@oups
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.150 2004/12/07 15:37:46 tg Exp $
d230 4
@


1.150
log
@* escape PERMIT_PACKAGE_* reasons in @@comment
* add full CVSweb URI to port path as @@comment
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.149 2004/12/01 16:41:05 tg Exp $
d1228 1
a1228 1
	    "portdir=http://mirbsd.bsdadvocacy.org/cvs.cgi/ports/${FULLPKGPATH}/" \
@


1.149
log
@fix mod_schily
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.148 2004/11/21 18:59:59 tg Exp $
d1224 2
a1225 1
	    "cdrom=${PERMIT_PACKAGE_CDROM:L} ftp=${PERMIT_PACKAGE_FTP:L}" \
d1227 4
a1230 1
	@@sort -u <${WRKPKG}/depends${SUBPACKAGE}>>$@@.tmp
@


1.148
log
@r1.138 was wrong w.r.t. giving CPPFLAGS to configure
(since it's not explicitly given to make, no danger,
 but not giving it to configure breaks at least links+)
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.147 2004/11/18 16:17:04 tg Exp $
d1772 2
a1773 1
	chmod ${BINMODE} ${WRKDIR}/bin/uname
@


1.147
log
@it's /sbin/chown here too, damn it
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.146 2004/11/05 21:17:02 tg Exp $
d1111 2
a1112 1
	    CXX="${CXX}" ac_cv_path_CXX="${CXX}" \
a1117 1
	    LDFLAGS="${LDFLAGS}" CXXFLAGS="${CXXFLAGS:C/ *$//}" \
@


1.146
log
@shuffle around compat stuff, reducing the lines of code which
need to be parsed by every make(1) invocation

minor fallout expected, please report
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.145 2004/10/23 16:51:46 tg Exp $
d705 1
a705 1
CHOWN?=			/usr/sbin/chown
@


1.145
log
@tentative fix for the png-on-packaging-time issue
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.144 2004/10/22 10:34:06 tg Exp $
d442 2
a443 6
.  elif ${HAS_ONLY_C_LANG:L} == "yes"
.    if ${HAS_GCCPORT_ABILITY:L} == "yes"
BUILD_DEPENDS+=		:gcc->=3.4.0:
RUN_DEPENDS+=		:gcc->=3.4.0:
.    elif defined(MKC_EGCC) && ${MKC_EGCC:L} == "yes"
# maybe I should warn...
d445 6
a450 9
.    elif ${HAS_GCCPORT_OBSD:L} == "stable"
NO_CXX=			egcc port is not verified yet
LIB_DEPENDS+=		estdc++.5:libstdc++->=3.2.0:lang/egcs/stable,-estdc
CXX=			eg++
.    elif ${HAS_GCCPORT_OBSD:L} == "system"
NO_CXX=			gcc port no longer included
LIB_DEPENDS+=		estdc++.5:libstdc++->=3.2.0:lang/egcs/system,-estdc
#CXX=			eg++
.    else
a451 1
.    endif
@


1.144
log
@whitespace
fix the depends-on-gcc problem
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.143 2004/10/22 08:44:01 tg Exp $
d2527 1
d2531 12
@


1.143
log
@remove the libpng kludge, because I'm too lazy to implement
it for libexpat

instead, make the lib resolver see into /usr/lib as
well, and bump libpng to shlib version 4.0; add an
appropriate symlink to the setup script
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.142 2004/10/16 15:28:32 tg Exp $
d2033 1
a2033 1
	@@${MAKE} all-dir-depends|tsort -r|while read dir; do \
d2408 2
a2409 1
	@@${MAKE} ${_i}-dir-depends|tsort -r|sed -e '$$d'|while read dir; do \
d2496 6
a2501 2
		${_flavor_fragment}; \
		default=$$(eval $$toset ${MAKE} _print-packagename); \
d2504 3
a2506 1
		if fgrep -q "|$$default|" $${_DEPENDS_FILE}; then : ; else \
@


1.142
log
@add flavour list only if !empty
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.141 2004/10/08 04:43:40 tg Exp $
a1069 7
.if ${HAS_LIBPNG_BASE:L} == "yes"
_libpng_fragment= \
		[[ $$d = png*(.?*) ]] && check=yes;
.else
_libpng_fragment= : ;
.endif

d1073 2
a1074 2
		listlibs='ls $$shdir 2>/dev/null'; \
		${_libresolve_fragment}; ${_libpng_fragment} \
a2513 3
		IFS=,; for d in $$dep; do \
			check=no; ${_libpng_fragment} \
			if [[ $$check = no ]]; then \
d2521 1
a2521 1
			listlibs='ls $$shdir 2>/dev/null'; \
d2531 1
a2531 1
			${_libresolve_fragment}; ${_libpng_fragment} \
d2557 1
a2557 1
	fi; done; }
@


1.141
log
@remove fake gcc port, since we'll do an installation set
which installs a fake port (just like obsd wanted to do with X)
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.140 2004/10/08 04:42:22 tg Exp $
d1283 1
a1283 1
.if defined(FLAVORS)
@


1.140
log
@if the last of the three fields of a packages-specs(7) is empty,
issue a warning which looks waaaay better and is more descriptive
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.139 2004/10/08 04:41:22 tg Exp $
d444 2
a445 2
NO_CXX=			gcc port is not completed yet
LIB_DEPENDS+=		stdc++::lang/gcc
@


1.139
log
@fix the 'make clean' problem by applying some more sudo
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.138 2004/10/08 03:01:23 tg Exp $
d1399 5
@


1.138
log
@* from openbsd:
  strip trailing spaces from CFLAGS and CXXFLAGS to please autotools
* whitespace fixup
* don't pass CPPFLAGS, since we put them into CFLAGS and CXXFLAGS already
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.137 2004/10/08 02:56:56 tg Exp $
d2052 2
a2053 2
	@@if [ -L ${WRKDIR} ]; then rm -rf $$(readlink ${WRKDIR}); fi
	@@rm -rf ${WRKDIR}
@


1.137
log
@from openbsd:
WRKCONF?=${WRKBUILD}
and fix MODSIMPLE_configure
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.136 2004/10/08 02:55:31 tg Exp $
d471 3
a473 2
			CC='${CC}' CFLAGS='${CFLAGS}' LDFLAGS='${LDFLAGS}' \
			${DESTDIRNAME}= EXTRA_SYS_MK_INCLUDES="<bsd.own.mk>"
d1125 9
a1133 9
		CC="${CC}" ac_cv_path_CC="${CC}" CFLAGS="${CFLAGS}" \
		CXX="${CXX}" ac_cv_path_CXX="${CXX}" CXXFLAGS="${CXXFLAGS}" \
		INSTALL="/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}" \
		ac_given_INSTALL="/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}" \
		INSTALL_PROGRAM="${INSTALL_PROGRAM}" YACC="${YACC}" \
		INSTALL_MAN="${INSTALL_MAN}" INSTALL_DATA="${INSTALL_DATA}" \
		INSTALL_SCRIPT="${INSTALL_SCRIPT}" LD="${LD}" \
		LDFLAGS="${LDFLAGS}" CPPFLAGS="${CPPFLAGS}" ${CONFIGURE_ENV} \
		${SH} ${_CONFIGURE_SCRIPT} ${CONFIGURE_ARGS}
@


1.136
log
@idea from openbsd:
explicitly forbid flavors starting with [0-9].
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.135 2004/10/08 02:53:52 tg Exp $
d528 1
d1123 1
a1123 1
	cd ${WRKBUILD} && ${_SYSTRACE_CMD} ${SETENV} REALOS='${OStype}' \
@


1.135
log
@from openbsd:
tag error messages with PKGPATH, as they get hard to decipher
when walking the tree.
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.134 2004/10/08 02:52:30 tg Exp $
d327 4
@


1.134
log
@from openbsd:
always define NO_SHARED_LIBS
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.133 2004/09/17 14:43:49 tg Exp $
d2718 1
a2718 1
	@@echo 1>&2 ${_m}
@


1.133
log
@move NO_CXX?= and USE_foo?= farther above before modules are run
so they can use them

unbreaks imake ports and "make index"
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.132 2004/09/15 21:55:15 tg Exp $
d637 1
a637 1
.if !defined(PLIST) && defined(NO_SHARED_LIBS) \
d649 1
a649 1
.if !defined(PLIST) && defined(NO_SHARED_LIBS) \
d912 1
a912 1
.if defined(NO_SHARED_LIBS)
d1048 1
a1048 1
.if defined(NO_SHARED_LIBS)
d1156 1
a1156 1
.if defined(LIB_DEPENDS)
d1236 1
a1236 1
.if defined(NO_SHARED_LIBS)
d1263 2
a1264 1
    (!defined(NO_SHARED_LIBS) && defined(LIB_DEPENDS) && !empty(LIB_DEPENDS))
d2505 1
a2505 1
.if !defined(NO_SHARED_LIBS)
@


1.132
log
@add ${LDSTATIC} to LDFLAGS by default
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.131 2004/09/15 11:00:46 tg Exp $
d432 29
a929 29
.endif

USE_X11?=		No
USE_CXX?=		No
NO_CXX?=		No	# inhibit use of C++ ports
.if ${USE_CXX:L} == "yes"
.  if ${NO_CXX:L} == "yes"
NO_CXX=			C++ is explicitly disabled
.  elif ${HAS_ONLY_C_LANG:L} == "yes"
.    if ${HAS_GCCPORT_ABILITY:L} == "yes"
NO_CXX=			gcc port is not completed yet
LIB_DEPENDS+=		stdc++::lang/gcc
.    elif defined(MKC_EGCC) && ${MKC_EGCC:L} == "yes"
# maybe I should warn...
NO_CXX=			No
.    elif ${HAS_GCCPORT_OBSD:L} == "stable"
NO_CXX=			egcc port is not verified yet
LIB_DEPENDS+=		estdc++.5:libstdc++->=3.2.0:lang/egcs/stable,-estdc
CXX=			eg++
.    elif ${HAS_GCCPORT_OBSD:L} == "system"
NO_CXX=			gcc port no longer included
LIB_DEPENDS+=		estdc++.5:libstdc++->=3.2.0:lang/egcs/system,-estdc
#CXX=			eg++
.    else
NO_CXX=			C++ is not supported on this system
.    endif
.  endif
CONFIGURE_ENV+=		CXX='${CXX}'
MAKE_ENV+=		CXX='${CXX}'
@


1.131
log
@allow MKC_EGCC (*only* for #7 users, I warn ya!)
joint idea with bsiegert@@
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.130 2004/09/12 11:50:34 tg Exp $
d430 1
a430 1
LDFLAGS+=		-L${LOCALBASE}/lib
@


1.130
log
@typo prevented make addsum from working correctly
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.129 2004/09/10 21:45:10 tg Exp $
d913 3
@


1.129
log
@* fix imlib/imlib2 "" vs "no_cxx" confusion
* nuke spurious "can't find /cdrom/distfiles//foo.tar.gz" msgs
* echo flavours to package description
* add no_cxx python pkgs (sry bsiegert@@)
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.128 2004/09/07 16:51:55 tg Exp $
d1320 1
a1320 1
	@@if [ $(sed -e 's/\=.*$$//' ${CHECKSUM_FILE} | uniq -d \
@


1.128
log
@* if USE_X11, add -L${X11BASE}/lib to LDFLAGS automagically
* add 'relevant-checks' target which checks the packaging
  permissions for dependend packages as well as the uses
  for C++ and X11 (for library reasons)
yes, my english sucks...
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.127 2004/09/07 16:37:55 tg Exp $
d744 1
d746 3
d1272 3
@


1.127
log
@provide $$CXX to configure and make if USE_CXX
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.126 2004/09/07 09:46:43 tg Exp $
d968 2
a969 1
.  if ${USE_X11:L} == "yes" && !exists(${X11BASE})
d971 3
d1434 2
a1435 1
uninstall deinstall fake package lib-depends-check manpages-check license-check:
d2400 5
a2404 3
license-check:
.if ${PERMIT_PACKAGE_CDROM:L} == "yes" || ${PERMIT_PACKAGE_FTP:L} == "yes"
	@@${MAKE} all-dir-depends|tsort -r|sed -e '$$d'|while read dir; do \
d2408 4
a2411 2
		    _MASTER_PERMIT_FTP=${PERMIT_PACKAGE_FTP:Q}; \
		eval $$toset ${MAKE} _license-check; \
d2415 1
a2415 1
_license-check:
d2422 6
d2748 1
a2748 1
	license-check _license-check
@


1.126
log
@fix doubled quoting, again
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.125 2004/09/07 09:44:49 tg Exp $
d921 2
@


1.125
log
@mostly whitespace update; few semantics (for example:
ERRORS doesn't need Fatal: any more; PKG_CMD_PKG added)
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.124 2004/09/07 08:13:29 tg Exp $
d904 1
a904 1
NO_CXX=			"C++ is explicitly disabled"
d907 1
a907 1
NO_CXX=			"gcc port is not completed yet"
d910 1
a910 1
NO_CXX=			"egcc port is not verified yet"
d914 1
a914 1
NO_CXX=			"gcc port no longer included"
d918 1
a918 1
NO_CXX=			"C++ is not supported on this system"
@


1.124
log
@remove useless recursing for USE_CXX and USE_X11;
will be replaced by more sane code later
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.123 2004/08/23 08:20:31 tg Exp $
d28 1
a28 1
ERRORS+=		"Use 'env FLAVOR=${FLAVOR} ${MAKE}' instead."
d31 1
a31 1
ERRORS+=		"Use 'env SUBPACKAGE=${SUBPACKAGE} ${MAKE}' instead."
d49 2
a50 2
ERRORS+=		"Fatal: Please upgrade your system Makefile includes."
ERRORS+=		"See http://mirbsd.de/?mirports for instructions."
d93 1
d123 1
a123 1
ERRORS+=		"Package is marked as CDROM but not FTP."
d126 1
a126 1
ERRORS+=		"Distfiles are marked as CDROM but not FTP."
a129 4
# MODULES support
# reserved name spaces: for module=NAME, modname*, _modname* variables and
# targets.

d228 1
a228 1
FAKE_FLAGS=		${DESTDIRNAME}=${WRKINST}
d243 1
a243 1
MAKE_ENV+=		MAKEPROG=${MAKE_PROGRAM} CCOM=cc
d276 1
a276 1
ERRORS+=		"Fatal: choose motif or lesstif, not both."
d283 2
a284 2
.  else
ERRORS+=		"Fatal: Unknown USE_MOTIF=${USE_MOTIF} settings."
d287 1
d293 1
a293 1
ERRORS+=		"Fatal: Subpackage ${SUBPACKAGE} does not exist."
a298 1
#
d312 4
a315 1
SED_PLIST+=|sed -e '/^!%%${_i}%%$$/r${PKGDIR}/PFRAG.no-${_i}${SUBPACKAGE}' -e '//d' -e '/^%%${_i}%%$$/d'
d317 1
a317 1
_FLAVOR_EXT2:=${_FLAVOR_EXT2}-${_i}
d319 1
a319 1
FLAVOR_EXT:=${FLAVOR_EXT}-${_i}
d321 4
a324 1
SED_PLIST+=|sed -e '/^!%%${_i}%%$$/d' -e '/^%%${_i}%%$$/r${PKGDIR}/PFRAG.${_i}${SUBPACKAGE}' -e '//d'
d333 2
a334 2
ERRORS+=		"Fatal: Unknown flavor: ${_i}"
ERRORS+=		"   (Possible flavors are: ${FLAVORS})."
d338 1
a338 1
ERRORS+=		"Fatal: no flavors for this port."
d343 1
a343 1
PKG_ARGS_ADD+=		-A'${PKG_ARCH}'
d410 1
a410 1
# Don't touch !!! Used for generating checksums.
d435 2
a436 1
MAKE_ENV+=		PATH='${PORTPATH}' PREFIX='${PREFIX}' \
d438 2
a439 3
			MOTIFLIB='${MOTIFLIB}' CFLAGS='${CFLAGS}' \
			TRUEPREFIX='${PREFIX}' ${DESTDIRNAME}='' \
			CC='${CC}' LDFLAGS='${LDFLAGS}' HOME='${PORTHOME}'
a464 2
MAKE_ENV+=		EXTRA_SYS_MK_INCLUDES="<bsd.own.mk>"

a497 1

d548 13
a560 17
INSTALL_PROGRAM= \
	${INSTALL} ${INSTALL_COPY} ${INSTALL_STRIP} -o ${BINOWN} -g ${BINGRP} -m ${BINMODE}
INSTALL_SCRIPT= \
	${INSTALL} ${INSTALL_COPY} -o ${BINOWN} -g ${BINGRP} -m ${BINMODE}
INSTALL_DATA= \
	${INSTALL} ${INSTALL_COPY} -o ${SHAREOWN} -g ${SHAREGRP} -m ${SHAREMODE}
INSTALL_MAN= \
	${INSTALL} ${INSTALL_COPY} -o ${MANOWN} -g ${MANGRP} -m ${MANMODE}

INSTALL_PROGRAM_DIR= \
	${INSTALL} -d -o ${BINOWN} -g ${BINGRP} -m ${DIRMODE}
INSTALL_SCRIPT_DIR= \
	${INSTALL_PROGRAM_DIR}
INSTALL_DATA_DIR= \
	${INSTALL} -d -o ${SHAREOWN} -g ${SHAREGRP} -m ${DIRMODE}
INSTALL_MAN_DIR= \
	${INSTALL} -d -o ${MANOWN} -g ${MANGRP} -m ${DIRMODE}
d582 2
a583 1
_SYSTRACE_POLICIES+=	${SHELL} /usr/bin/env /usr/bin/make ${LOCALBASE}/bin/gmake
d601 2
a602 1
.if !defined(PLIST) && exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${ARCH})
d604 2
a605 2
.else
.if !defined(PLIST) && exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${MACHINE_ARCH})
d608 2
a609 2
.endif
.if !defined(PLIST) && defined(NO_SHARED_LIBS) && exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.noshared)
d617 1
a617 2
.else
.if !defined(PLIST) && exists(${PKGDIR}/PLIST${SUBPACKAGE}.${MACHINE_ARCH})
d620 2
a621 2
.endif
.if !defined(PLIST) && defined(NO_SHARED_LIBS) && exists(${PKGDIR}/PLIST${SUBPACKAGE}.noshared)
d646 2
a647 1
# Note that if you override PKG_ARGS, you will not get correct dependencies
d674 1
a674 1
ERRORS+=		"Fatal: Missing comment."
d693 1
d732 1
a732 1
_SITE_SELECTOR+=*:${_I}) sites="${MASTER_SITES${_I}}";;
d734 2
a735 1
_SITE_SELECTOR+=*:${_I}) echo >&2 "Error: MASTER_SITES${_I} not defined";;
d738 1
a738 1
_SITE_SELECTOR+=*) sites="${MASTER_SITES}";; esac
d741 1
a741 1
# OpenBSD code to handle ports distfiles on a CDROM.  The distfiles
d743 2
a744 3
# CDROM is mounted on /cdrom).
#
CDROM_SITE?=	/cdrom/distfiles/${DIST_SUBDIR}
d808 2
a809 1
.if !empty(EXTRACT_ONLY:M*.tar.bz2) || (defined(PATCHFILES) && !empty(_PATCHFILES:M*.bz2))
d822 2
a823 1
EXTRACT_CASES+= *.zip) ${UNZIP} -q ${FULLDISTDIR}/$$archive -d ${WRKDIR};;
d827 2
a828 1
EXTRACT_CASES+= *.tar.bz2 | *.cpio.bz2 | *.cbz) ${BZIP2} -dc ${FULLDISTDIR}/$$archive | ${TAR} xf -;;
d830 12
a841 6
EXTRACT_CASES+= *.tar | *.cpio) ${TAR} xf ${FULLDISTDIR}/$$archive;;
EXTRACT_CASES+= *.shar.gz|*.shar.Z|*.sh.gz|*.sh.Z) ${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive | ${_PERL_FIX_SHAR} | /bin/sh;;
EXTRACT_CASES+= *.shar | *.sh) ${_PERL_FIX_SHAR} ${FULLDISTDIR}/$$archive | /bin/sh;;
EXTRACT_CASES+= *.tar.gz | *.cpio.gz | *.cgz) ${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive | ${TAR} xf -;;
EXTRACT_CASES+= *.gz) ${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive >$$(basename $$archive .gz);;
EXTRACT_CASES+= *) ${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive | ${TAR} xf -;;
d845 2
a846 1
PATCH_CASES+= *.bz2) ${BZIP2} -dc $$patchfile | ${PATCH} ${PATCH_DIST_ARGS};;
d848 3
a850 2
PATCH_CASES+= *.Z|*.gz) ${GZCAT} $$patchfile | ${PATCH} ${PATCH_DIST_ARGS};;
PATCH_CASES+= *) ${PATCH} ${PATCH_DIST_ARGS} <$$patchfile;;
d853 1
a859 1
RESPONSIBLE?=		The MirPorts mailing list ${_MIRPORTS_ADDRESS}
d862 1
a862 1
ERRORS+=		"Fatal: CATEGORIES is mandatory."
d877 1
a877 1
CONFIGURE_ENV+=		PATH=${PORTPATH}
d886 8
a893 7
SCRIPTS_ENV+=		CURDIR=${.CURDIR} DISTDIR=${DISTDIR} \
			PATH=${PORTPATH} WRKDIR=${WRKDIR} WRKDIST=${WRKDIST} \
			WRKSRC=${WRKSRC} WRKBUILD=${WRKBUILD} \
			PATCHDIR=${PATCHDIR} SCRIPTDIR=${SCRIPTDIR} \
			FILESDIR=${FILESDIR} \
			PORTSDIR=${PORTSDIR} DEPENDS="${DEPENDS}" \
			PREFIX=${PREFIX} LOCALBASE=${LOCALBASE} X11BASE=${X11BASE}
d903 2
a904 2
.  if ${NO_CXX:L} != "no"
IGNORE+=		"uses C++ which is explicitly disabled"
d907 1
a907 1
IGNORE+=		"gcc port not completed yet"
d910 1
d914 1
d918 1
a918 1
IGNORE+=		"uses C++ which is not supported on this system"
d969 2
a970 2
.  if ${USE_CXX:L} == "yes" && ${NO_CXX:L} == "yes"
IGNORE+=		"uses C++, but no CXX installed"
d1029 1
a1029 1
	if pkg dependencies check "$$pkg"; then \
d1042 8
a1049 8
		case "$$d" in \
		*/*) shprefix="$${d%/*}/"; shdir="${LOCALBASE}/$${d%/*}"; \
			d=$${d\#\#*/};; \
		*) shprefix="" shdir="${LOCALBASE}/lib";; \
		esac; \
		check=$$(eval $$listlibs| perl \
			${PORTSDIR}/infrastructure/build/resolve-lib ${_noshared} $$d) \
			|| true
d1094 2
a1095 2
.if empty(SUBPACKAGE) && defined(MULTI_PACKAGES) && \
	!empty(MULTI_PACKAGES) && (${PREFER_SUBPKG_INSTALL:L} == "yes")
d1105 1
a1105 1
	cd ${WRKBUILD} && ${_SYSTRACE_CMD} ${SETENV} REALOS=${OStype} \
d1116 2
a1117 2
_FAKE_SETUP=		TRUEPREFIX=${PREFIX} PREFIX=${WRKINST}${PREFIX} \
			${DESTDIRNAME}=${WRKINST}
d1182 2
a1183 1
	@@cd ${.CURDIR} && SUBPACKAGE='' FLAVOR='${FLAVOR}' PACKAGING='' exec ${MAKE} _package
d1195 2
a1196 1
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' FLAVOR='${FLAVOR}' PACKAGING='${_s}' exec ${MAKE} _package
d1219 3
a1221 1
	@@echo "@@comment subdir=${FULLPKGPATH} cdrom=${PERMIT_PACKAGE_CDROM:L} ftp=${PERMIT_PACKAGE_FTP:L}" >$@@.tmp
d1224 5
a1228 4
	@@sed -e '/^!%%SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' -e '//d' \
		-e '/^%%!SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' -e '//d' \
		-e '/^%%SHARED%%$$/d' <${PLIST} \
		${SED_PLIST} >>$@@.tmp && mv -f $@@.tmp $@@
d1232 5
a1236 4
			-e '/^%%!SHARED%%$$/d' \
			-e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' -e '//d' \
			<${PLIST} ${SED_PLIST} \
			| sed -f ${LDCONFIG_SED_SCRIPT} >>$@@.tmp && mv -f $@@.tmp $@@; \
d1239 4
a1242 4
			-e '/^%%!SHARED%%$$/d' \
			-e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' -e '//d' \
			<${PLIST} \
			${SED_PLIST} >>$@@.tmp && mv -f $@@.tmp $@@; \
d1249 2
a1250 1
.if (defined(RUN_DEPENDS) && !empty(RUN_DEPENDS)) || (!defined(NO_SHARED_LIBS) && defined(LIB_DEPENDS) && !empty(LIB_DEPENDS))
d1252 3
a1254 2
	echo "|${FULLPKGNAME${SUBPACKAGE}}|" >>$${_DEPENDS_FILE}; \
	self=${FULLPKGNAME${SUBPACKAGE}} _depends_result=$@@ ${MAKE} _recurse-solve-package-depends
d1312 2
a1313 1
		${ECHO_MSG} "${CHECKSUM_FILE} updated okay, don't forget to remove cruft"; \
d1337 2
a1338 1
	@@unset PACKAGING DEPENDS_TARGET FLAVOR SUBPACKAGE _MASTER WRKDIR|| true; \
d1348 3
a1350 1
			toset="$$toset _MASTER='[${FULLPKGNAME${SUBPACKAGE}}]${_MASTER}' WRKDIR=${WRKDIR}/$$dir"; \
d1353 4
a1356 2
		case "X$$pkg" in X) pkg=$$(eval $$toset ${MAKE} _print-packagename); \
			defaulted=true;; esac; \
d1377 2
a1378 1
			[[ $$target = *patch* ]] && target="__AUTOPORT_RECURSIVE=1 $$target"; \
d1401 3
a1403 3
			-e '/^ *NEEDED *\(.*\)\.so\.\([0-9][0-9]*\)\.\([0-9][0-9]*\)$$/s//\1 \2 \3/p' \
			-e '/^ *NEEDED *\(.*\)\.so$$/s//\1/p'| \
		sort -u >$@@
d1409 7
a1415 4
		find /usr/lib -path /usr/lib -o -type d -prune -o -type f -print; \
		find ${X11BASE}/lib -path ${X11BASE}/lib -o -type d -prune -o -type f -print; \
	}|\
		egrep '(\.so\.|\.so$$)'|${SUDO} xargs file -L|fgrep 'shared'|cut -d\: -f1|sort -u >$@@
d1447 2
a1448 3
	PKG_DBDIR='${PKG_DBDIR}' \
		perl ${_CHECK_LIBS_SCRIPT} \
		${_LIBLIST} ${_BUILDLIBLIST}
d1452 1
a1452 2
		${SUDO} /usr/libexec/makewhatis -p . && \
		cat whatis.db
d1486 1
a1486 1
.  if ! defined(NO_CHECKSUM)
d1554 1
a1554 1
		MASTER_SITE_OVERRIDE="ftp://ftp.openbsd.org/pub/OpenBSD/distfiles/${cipher}/${value}/"
d1658 2
a1659 2
			no) ;; \
			*) ${ECHO_MSG} "===>   Applying distribution patch $$patchfile" ;; \
d1694 16
a1709 17
				*.orig|*.rej|*~) \
					${ECHO_MSG} "===>   Ignoring patchfile $$i" ; \
					;; \
				*) \
				    if [ -e $$i ]; then \
						case "${PATCH_DEBUG:L}" in \
							no) ;; \
							*) ${ECHO_MSG} "===>   Applying ${OPSYS} patch $$i" ;; \
						esac; \
						${PATCH} ${PATCH_ARGS} <$$i || \
							{ echo "***>   $$i did not apply cleanly"; \
							error=true; }\
					else \
						if [ $$i != "patch-*" ]; then \
							echo "===>   Can't find patch matching $$i"; \
							error=true; \
						fi; \
d1711 2
a1712 1
					;; \
d1758 1
a1758 1
	chmod 555 ${WRKDIR}/bin/uname
d1770 1
a1770 1
			${SCRIPTS_ENV} ${SH} ${SCRIPTDIR}/configure; \
d1789 1
a1789 1
.if ${VMEM_WARNING:L} == "yes"
d1798 2
a1799 2
	echo "*** 	csh(1) and tcsh(1): limit datasize <kbytes of memory>"; \
	echo "***	ksh(1), zsh(1) and bash(1): ulimit -d <kbytes of memory>"; \
d1801 1
a1801 1
.endif
d1809 2
a1810 1
	@@cd ${WRKBUILD} && exec ${_SYSTRACE_CMD} ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} -f ${MAKE_FILE} ${ALL_TARGET}
d1829 2
a1830 1
	@@cd ${WRKBUILD} && exec ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${REGRESS_FLAGS} -f ${MAKE_FILE} ${REGRESS_TARGET}
d1861 2
a1862 1
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} ${MAKE} pre-fake ${_FAKE_SETUP}
d1866 2
a1867 1
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} ${MAKE} pre-install ${_FAKE_SETUP}
d1870 2
a1871 1
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} ${MAKE} do-install ${_FAKE_SETUP}
d1874 3
a1876 1
	@@cd ${WRKBUILD} && exec ${SUDO} ${_SYSTRACE_CMD} ${SETENV} ${MAKE_ENV} ${_FAKE_SETUP} ${MAKE_PROGRAM} ${FAKE_FLAGS} -f ${MAKE_FILE} ${FAKE_TARGET}
d1880 2
a1881 1
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} ${MAKE} post-install ${_FAKE_SETUP}
d1891 2
a1892 1
	@@cd ${.CURDIR} && DEPENDS_TARGET=install exec ${MAKE} run-depends lib-depends
d1900 2
a1901 1
	@@if pkg dependencies check ${FULLPKGNAME${SUBPACKAGE}}; then \
d1936 2
a1937 1
	@@duplicates=$$(sort <${WRKPKG}/PLIST${SUBPACKAGE}|egrep -v '@@(comment|mode|owner)'|uniq -d); \
d1939 1
a1939 1
		*) echo "\n*** WARNING *** Duplicates in PLIST:\n$$duplicates\n";; \
d1957 2
a1958 1
	@@cd ${.CURDIR} && exec ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes fetch
d2079 2
a2080 1
# Note: add @@comment PACKAGE(arch=${MACHINE_ARCH}, opsys=${OPSYS}, vers=${OPSYS_VER})
d2099 3
a2101 3
		PATCH_LIST='${PATCH_LIST}' DIFF_ARGS='${DIFF_ARGS}' \
		DISTORIG=${DISTORIG} PATCHORIG=${PATCHORIG} ${_GDIFFLAG} \
		${SHELL} ${PORTSDIR}/infrastructure/build/update-patches); \
d2120 2
a2121 1
	@@echo "${_FMN}: ${_ALLFILES} "$$(_FULL_PACKAGE_NAME=Yes ${MAKE} full-all-depends)
d2125 2
a2126 1
	@@exec ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes _fetch-makefile
d2163 2
a2164 1
		if set -- $$(grep -i "^$$c (${_F})" $$checksum_file); then break; fi; \
d2185 1
a2185 1
# distribution-name|port-path|installation-prefix|comment| \
d2187 1
a2187 2
#  for-arch|package-cdrom|package-ftp|distfiles-cdrom|distfiles-ftp
#
d2221 2
a2222 1
	@@cd ${.CURDIR} && SUBPACKAGE='${SUBPACKAGE}' FLAVOR='${FLAVOR}' PACKAGING='${SUBPACKAGE}' exec ${MAKE} describe
d2225 2
a2226 1
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' PACKAGING='${_sub}' exec ${MAKE} describe
d2245 2
a2246 1
	@@cd ${.CURDIR} && _FINAL_ECHO=: _INITIAL_ECHO=: exec ${MAKE} ${_d:L}-depends-list
d2293 2
a2294 1
	@@cd ${.CURDIR} && SUBPACKAGE='${SUBPACKAGE}' FLAVOR='${FLAVOR}' PACKAGING='${SUBPACKAGE}' exec ${MAKE} readmes
d2297 2
a2298 1
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' PACKAGING='${_sub}' exec ${MAKE} readmes
d2303 2
a2304 1
	@@cd ${.CURDIR} && exec ${MAKE} README_NAME=${README_NAME} ${FULLPKGNAME${SUBPACKAGE}}.html
d2322 2
a2323 1
	@@name=$$(SUBPACKAGE=${_S} ${MAKE} _print-packagename _FULL_PACKAGE_NAME=No); \
d2328 4
a2331 2
	@@name=$$(unset SUBPACKAGE; ${MAKE} _print-packagename _FULL_PACKAGE_NAME=No); \
	echo "<h2>Subpackage of <a href=\"$$name.html\">$$name</a></h2>" >$@@.tmp-subpackages
d2338 5
a2342 5
	@@cd ${.CURDIR} && ${MAKE} full-${_I}-depends _FULL_PACKAGE_NAME=Yes| \
		while read n; do \
			j=$$(dirname $$n|${HTMLIFY}); k=$$(basename $$n|${HTMLIFY}); \
			echo "<li><a href=\"${PKGDEPTH}$$j/$$k.html\">$$k</a>"; \
		 done  >$@@.tmp-${_I}
d2347 10
a2356 10
	@@cat ${README_NAME} | \
		sed -e 's|%%PORT%%|'"$$(echo ${FULLPKGPATH}  | ${HTMLIFY})"'|g' \
			-e '/%%PKG%%/r$@@.tmp3' -e '//d' \
			-e '/%%COMMENT%%/r$@@.tmp-comment' -e '//d' \
			-e '/%%DESCR%%/r${PKGDIR}/DESCR${SUBPACKAGE}' -e '//d' \
			-e '/%%HOMEPAGE%%/r$@@.tmp4' -e '//d' \
			-e '/%%BUILD_DEPENDS%%/r$@@.tmp-build' -e '//d' \
			-e '/%%RUN_DEPENDS%%/r$@@.tmp-run' -e '//d' \
 			-e '/%%SUBPACKAGES%%/r$@@.tmp-subpackages' -e '//d' \
		>>$@@
d2398 2
a2399 3
		_MASTER_PERMIT_CDROM=${PERMIT_PACKAGE_CDROM:Q}; \
		_MASTER_PERMIT_FTP=${PERMIT_PACKAGE_FTP:Q}; \
		export _MASTER_PERMIT_CDROM _MASTER_PERMIT_FTP; \
d2406 2
a2407 1
.  if defined(_MASTER_PERMIT_${_i}) && ${_MASTER_PERMIT_${_i}:L} == "yes" && ${PERMIT_PACKAGE_${_i}:L} != "yes"
d2470 2
a2471 1
			if ! eval $$toset ${MAKE} _recurse-solve-package-depends; then  \
d2488 4
a2491 2
		case "X$$pkg" in X) pkg=$$(echo $$default|sed -e 's,-[0-9].*,-*,');; esac; \
		if pkg dependencies check $$pkg; then \
d2494 6
a2499 2
			eval $$toset ${MAKE} ${PKGREPOSITORY}/$$default${PKG_SUFX}; \
			listlibs='${SETENV} PATH="${PKG_CMDDIR}:$$PATH" ${PKG_CMD_INFO} -L ${PKGREPOSITORY}/$$default${PKG_SUFX}|grep $$shdir|sed -e "s,^$$shdir/,,"'; \
d2516 2
a2517 1
			echo "@@libdepend $$self:$$libspecs:$$pkg:$$default" >>$${_depends_result}; \
d2521 2
a2522 1
				if ! eval $$toset ${MAKE} _recurse-solve-package-depends; then  \
d2554 2
a2555 1
		self=${FULLPKGPATH} PACKAGING='${SUBPACKAGE}' ${MAKE} _recurse-run-dir-depends; \
a2691 1
.  if !empty(ERRORS:M"Fatal\:*") || !empty(ERRORS:M'Fatal\:*')
a2692 1
.  endif
d2696 2
a2697 1
	_build-dir-depends _delete-package-links _fetch-makefile _fetch-onefile \
@


1.123
log
@improve checksum case for #7
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.122 2004/08/23 08:08:37 tg Exp $
a7 1
#
d9 1
a9 3
# set forth in ports/README, unless explicitly noted otherwise, even
# if the notice says "Public Domain" (into which a work cannot be
# released from an author in a droit d'auteur country).
d17 1
a17 3
# In the case of MirPorts, the contact address is the MirPorts mailing list.
# If and only if that's not responsible, mail <mirabile@@bsdcow.net> directly.
# To get the MirPorts mailing list address, just type
d21 1
a21 1
# is bsd.port.mk(5).
a996 13
.  if defined(BATCH) && !defined(BATCH_OVERRIDE)
USES!=	make _print-uses BATCH_OVERRIDE=1 | sort -u
.    if !exists(${X11BASE})
.      for _i in ${USES:MX11%*}
IGNORE+=		"depends on ${_i:S/X11%//}, which uses X11"
.      endfor
.    endif
.    if ${NO_CXX:L} == "yes"
.      for _i in ${USES:MCXX%*}
IGNORE+=		"depends on ${_i:S/CXX%//}, which uses C++"
.      endfor
.    endif
.  endif
a997 24


_print-uses:
	@@for i in \
	    ${BUILD_DEPENDS:C!^[^:]*\:[^:]*\:${.CURDIR:S,^${PORTSDIR}/,,}.*$!!:C/^[^:]*:[^:]*://} \
	    ${LIB_DEPENDS:C!^[^:]*\:[^:]*\:${.CURDIR:S,^${PORTSDIR}/,,}.*$!!:C/^[^:]*:[^:]*://} \
	    ; do echo "$$i" | { \
		unset PACKAGING DEPENDS_TARGET FLAVOR SUBPACKAGE _MASTER \
		    WRKDIR || true; \
		IFS=\,; read dir flav; FLAV=""; \
		cd "${PORTSDIR}/$$dir"; \
		[ -n "$$flav" ] && \
		    FLAV="FLAVOR=\"$$(echo "$$flav" | sed 's/,/ /')\""; \
		UCXX=$$(eval $$FLAV make show=USE_CXX | tr '[A-Z]' '[a-z]'); \
		UX11=$$(eval $$FLAV make show=USE_X11 | tr '[A-Z]' '[a-z]'); \
		UNAM=$$(eval $$FLAV make _print-packagename); \
		UEXI=$$(if [ -e ${PKG_DBDIR}/$$UNAM ]; then echo yes; else \
			echo "no"; fi); \
		if [ $$UEXI == no ]; then \
			if [ $$UCXX == yes ]; then echo "CXX%$$UNAM"; fi; \
			if [ $$UX11 == yes ]; then echo "X11%$$UNAM"; fi; \
			make _print-uses; \
		fi; \
	}; done
@


1.122
log
@whoops, forgot the checksum case
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.121 2004/08/23 07:48:08 tg Exp $
d1507 5
@


1.121
log
@add sha512 to the list of default algos for cksum
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.120 2004/08/21 17:08:02 tg Exp $
d1502 1
a1502 1
	  ${ECHO_MSG} ">> No checksum file."; \
d1504 1
a1504 1
	  cd ${DISTDIR}; OK=true; list=''; \
d1506 6
a1511 5
		  for cipher in ${PREFERRED_CIPHERS}; do \
			set -- $$(grep -i "^$$cipher ($$file)" $$checksum_file) && break || \
			  ${ECHO_MSG} ">> No $$cipher checksum recorded for $$file."; \
		  done; \
		  case "$$4" in \
d1513 2
a1514 2
			  ${ECHO_MSG} ">> No checksum recorded for $$file."; \
			  OK=false;; \
d1516 3
a1518 3
			  echo ">> Checksum for $$file is set to IGNORE in md5 file even though"; \
			  echo "   the file is not in the "'$$'"{IGNOREFILES} list."; \
			  OK=false;; \
d1520 2
a1521 2
			  CKSUM=$$($$cipher <$$file); \
			  case "$$CKSUM" in \
d1523 1
a1523 1
				  ${ECHO_MSG} ">> Checksum OK for $$file. ($$cipher)";; \
d1525 5
a1529 5
				  echo ">> Checksum mismatch for $$file. ($$cipher)"; \
				  list="$$list $$file $$cipher $$4"; \
				  OK=false;; \
			  esac;; \
		  esac; \
@


1.120
log
@don't automatically CLEANDEPENDS=Yes when make clean=packages (can still
be overridden by specifying CLEANDEPENDS=Yes on the make command line)
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.119 2004/08/21 16:04:35 tg Exp $
d413 1
a413 1
_CIPHERS=		sha1 rmd160 md5
d1304 5
a1308 4
	@@cd ${DISTDIR} && \
		for cipher in ${_CIPHERS}; do \
			$$cipher ${_CKSUMFILES} >>${CHECKSUM_FILE}; \
	    done
d1319 5
a1323 4
	@@cd ${DISTDIR} && \
	 	for cipher in ${_CIPHERS}; do \
			$$cipher ${_CKSUMFILES} >>${CHECKSUM_FILE}; \
	    done
@


1.119
log
@another c++ fix
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.118 2004/08/21 16:02:26 tg Exp $
d157 3
@


1.118
log
@* add has_evilwm capability
* frobnify C++ handling (compatibility to #7 is a PITA)
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.117 2004/08/10 03:08:52 tg Exp $
d899 1
a899 1
LIB_DEPENDS+=		stdc++.>=1:gcc->=3.4:lang/gcc
d905 1
a905 1
CXX=			eg++
@


1.117
log
@.if defined(MODGNU_CONFIG_MIRLIBTOOL)
ERRORS+=	Waldemar, nein. Pfui.
.endif

 * MODGNU_CONFIG_MIRLIBTOOL never existed, and thus is
   an error. Nuke it.

.if ${MODGNU_MIRLIBTOOL:L} != "old" && ${MODGNU_MIRLIBTOOL:L} != "new" && ${MODGNU_MIRLIBTOOL:L} != "no"
ERRORS+=	Waldemar, aus.
.endif

 * MODGNU_MIRLIBTOOL was a tristate for (no|old|new), defaulting
   to "no" unless CONFIGURE_STYLE contains autoconf, thus triggering
   to activate MirLibtool by setting MODGNU_MIRLIBTOOL to "old".
   Remove =YES occurrences.

[10:47] <benz> MODGNU_TWIDDLE_DIRS?= ${MODGNU_CONFIG_GUESS_DIRS}
[10:50] <mira> eek!

 * bsiegert@@ requested that MODGNU_TWIDDLE_DIRS, whose name I chose short
   so that it lines up nicely with CONFIGURE_STYLE and the like, dies and
   be reverted to MODGNU_CONFIG_GUESS_DIRS, even if it does more than that

### READ THIS ###

 * As a novum, MirLibtool-old has gone, so MODGNU_MIRLIBTOOL now
   defaults to YES if CONFIGURE_STYLE=autoconf, and has switched
   to a bistate. Thus, remove MODGNU_MIRLIBTOOL={old|new} assignments.

I'm saving commit messages for those people with poor internet again.

 * fix the tree, regenerate INDEX - 2841 unzels
 * remove MAINTAINER= (bad bad)
 * quieten "make index" for EMUL ports

All this was done via ed(1), so it needs testing (obviously) ;-)
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.116 2004/07/22 22:20:11 tg Exp $
d892 9
a900 5
NO_CXX?=		No
.if ${NO_CXX} == "1"
NO_CXX:=		Yes
.endif
.if ${USE_CXX:L} == "yes" && (${CXX:L:Mec++} != "" || ${CXX:L:Meg++} != "")
d902 8
a909 1
IGNORE+=		"uses C++, but egcc is no longer supported"
@


1.116
log
@don't escape from shell "...\$i" because \$i is always
a make "word", coming with its own double quotes.

fixes display of error in archivers/rar
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.115 2004/07/21 09:49:25 tg Exp $
d1414 1
a1414 1
HAS_EMUL_${_i}!=sysctl -n kern.emul.${_i}
@


1.115
log
@add PATH="\${PKG_CMDDIR}:\$\$PATH" to the necessary places

(if you see a backslash before dollar sign, this is what I
 add manually because the log_accum2 and commit_prep2
 scripts are weirdly broken, and we don't know perl to fix)
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.114 2004/07/21 09:31:48 tg Exp $
d1426 1
a1426 1
	@@${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} ${_i}."
@


1.114
log
@add support for moving pkgtools out of /usr/sbin (for
dual installs openbsd ports tree + mirports framework)
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.113 2004/07/05 20:25:49 tg Exp $
d1885 3
a1887 1
		${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} ${PKG_CMD_ADD} ${PKGFILE${SUBPACKAGE}}; \
d1890 3
a1892 1
	@@${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} ${PKG_CMD_ADD} ${PKGFILE${SUBPACKAGE}}
d1921 5
a1925 4
	@@cd ${.CURDIR} && \
	  if ${SUDO} ${PKG_CMD_CREATE} ${PKG_ARGS} ${PKGFILE${SUBPACKAGE}}; then \
	    mode=$$(id -u):$$(id -g); ${SUDO} ${CHOWN} $${mode} ${PKGFILE${SUBPACKAGE}}; \
	    ${MAKE} _package-links; \
d1927 2
a1928 2
	    ${SUDO} ${MAKE} CLEANDEPENDS=No clean=package; \
	    exit 1; \
d2025 2
a2026 1
	-${SUDO} ${PKG_CMD_DELETE} ${FULLPKGNAME${_s}}
d2029 2
a2030 1
	-${SUDO} ${PKG_CMD_DELETE} ${FULLPKGNAME${SUBPACKAGE}}
d2459 1
a2459 1
			listlibs='${PKG_CMD_INFO} -L ${PKGREPOSITORY}/$$default${PKG_SUFX}|grep $$shdir|sed -e "s,^$$shdir/,,"'; \
d2641 2
a2642 1
	@@${SUDO} ${PKG_CMD_DELETE} ${FULLPKGNAME${SUBPACKAGE}}
@


1.113
log
@add hint where to find compat_* manpage

idea from reading DAU questions in IRC :)
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.112 2004/07/04 17:42:41 tg Exp $
d93 5
a97 2
PKG_CMD?=		/usr/sbin/pkg_create
PKG_DELETE?=		/usr/sbin/pkg_delete
d1885 1
a1885 1
		${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${PKGFILE${SUBPACKAGE}}; \
d1888 1
a1888 1
	@@${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} PKG_TMPDIR=${PKG_TMPDIR} pkg_add ${PKGFILE${SUBPACKAGE}}
d1918 1
a1918 1
	  if ${SUDO} ${PKG_CMD} ${PKG_ARGS} ${PKGFILE${SUBPACKAGE}}; then \
d2020 1
a2020 1
	-${SUDO} ${PKG_DELETE} ${FULLPKGNAME${_s}}
d2023 1
a2023 1
	-${SUDO} ${PKG_DELETE} ${FULLPKGNAME${SUBPACKAGE}}
d2452 1
a2452 1
			listlibs='pkg_info -L ${PKGREPOSITORY}/$$default${PKG_SUFX}|grep $$shdir|sed -e "s,^$$shdir/,,"'; \
d2634 1
a2634 1
	@@${SUDO} ${PKG_DELETE} ${FULLPKGNAME${SUBPACKAGE}}
@


1.112
log
@die, GNU diff, die!
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.111 2004/07/02 17:52:22 tg Exp $
d1413 1
a1413 1
IGNORE+=	"needs ${_i} emulation, which is turned off"
@


1.111
log
@oops... missed to check if there are subpackages
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.110 2004/07/02 17:16:19 tg Exp $
d2068 1
a2068 1
		DISTORIG=${DISTORIG} PATCHORIG=${PATCHORIG} \
@


1.110
log
@bsiegert@@ wants that "make install" installs _all_ subpackages
by default. here's the code for it.
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.109 2004/06/29 19:22:57 tg Exp $
d1106 2
a1107 1
.if empty(SUBPACKAGE) && !empty(MULTI_PACKAGES) && (${PREFER_SUBPKG_INSTALL:L} == "yes")
@


1.109
log
@oops, reverse.

GNU configure scripts take over the CFLAGS given to the Makefiles generated.
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.107 2004/06/28 17:47:25 tg Exp $
d1103 10
@


1.108
log
@add -Wno-error to configure script CFLAGS and CXXFLAGS
@
text
@d1107 9
a1115 10
	    CC="${CC}" ac_cv_path_CC="${CC}" \
	    CFLAGS="${CFLAGS} -Wno-error" CXXFLAGS="${CXXFLAGS} -Wno-error" \
	    CXX="${CXX}" ac_cv_path_CXX="${CXX}" \
	    INSTALL="/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}" \
	    ac_given_INSTALL="/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}" \
	    INSTALL_PROGRAM="${INSTALL_PROGRAM}" YACC="${YACC}" \
	    INSTALL_MAN="${INSTALL_MAN}" INSTALL_DATA="${INSTALL_DATA}" \
	    INSTALL_SCRIPT="${INSTALL_SCRIPT}" LD="${LD}" \
	    LDFLAGS="${LDFLAGS}" CPPFLAGS="${CPPFLAGS}" ${CONFIGURE_ENV} \
	    ${SH} ${_CONFIGURE_SCRIPT} ${CONFIGURE_ARGS}
@


1.107
log
@ldflags += /usr/local/lib
configure_env += cppflags
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.106 2004/06/19 20:28:45 tg Exp $
d1107 10
a1116 9
		CC="${CC}" ac_cv_path_CC="${CC}" CFLAGS="${CFLAGS}" \
		CXX="${CXX}" ac_cv_path_CXX="${CXX}" CXXFLAGS="${CXXFLAGS}" \
		INSTALL="/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}" \
		ac_given_INSTALL="/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}" \
		INSTALL_PROGRAM="${INSTALL_PROGRAM}" YACC="${YACC}" \
		INSTALL_MAN="${INSTALL_MAN}" INSTALL_DATA="${INSTALL_DATA}" \
		INSTALL_SCRIPT="${INSTALL_SCRIPT}" LD="${LD}" \
		LDFLAGS="${LDFLAGS}" CPPFLAGS="${CPPFLAGS}" ${CONFIGURE_ENV} \
		${SH} ${_CONFIGURE_SCRIPT} ${CONFIGURE_ARGS}
@


1.106
log
@add -static to LDFLAGS if NOPIC
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.105 2004/06/15 15:55:44 tg Exp $
d426 1
d1114 1
a1114 1
		LDFLAGS="${LDFLAGS}" ${CONFIGURE_ENV} \
@


1.105
log
@who's afraid of Makefiles?
Not me.

Implement stuff for new, more portable, more flexible MirPorts
and os-dependant infrastructure; fix indenting, use \${SHELL},
have a baseline of sane defaults, etc.
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.104 2004/06/11 23:14:09 tg Exp $
d434 1
a434 1
			CC='${CC}' HOME='${PORTHOME}'
d1113 2
a1114 2
		LDFLAGS="${LDFLAGS}" ${CONFIGURE_ENV} ${SH} \
		${_CONFIGURE_SCRIPT} ${CONFIGURE_ARGS}
@


1.104
log
@fix master sites
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.103 2004/06/09 19:39:23 tg Exp $
a51 1
#
d53 3
a55 3
.ifndef	SYS_PORT_MK
SYS_PORT_MK_X=		defined
.  include "${PORTSDIR}/infrastructure/mk/sys.port.mk"
d84 5
a88 5
WRKOBJDIR_${PKGPATH}?=	${WRKOBJDIR}
FAKEOBJDIR_${PKGPATH}?=	${FAKEOBJDIR}
BULK_${PKGPATH}?=	${BULK}
BULK_TARGETS_${PKGPATH}?= ${BULK_TARGETS}
CLEANDEPENDS_${PKGPATH}?= ${CLEANDEPENDS}
d107 1
a107 1
.include "${.CURDIR}/../Makefile.inc"
d171 1
a171 1
.include "${.CURDIR}/Makefile.${ARCH}"
d173 1
a173 1
.include "${.CURDIR}/Makefile.${MACHINE_ARCH}"
d191 1
a191 1
.  else
d226 1
a226 1
P5ARCH=			${P5SITE}/${MACHINE_ARCH}-${A_OS}
d431 4
a434 4
	LOCALBASE='${LOCALBASE}' X11BASE='${X11BASE}' \
	MOTIFLIB='${MOTIFLIB}' CFLAGS='${CFLAGS}' \
	TRUEPREFIX='${PREFIX}' ${DESTDIRNAME}='' \
	CC='${CC}' HOME='${PORTHOME}'
a482 1

d584 1
a584 1
_SYSTRACE_POLICIES+=	/bin/sh /usr/bin/env /usr/bin/make ${LOCALBASE}/bin/gmake
d693 1
a693 1
SH?=			/bin/sh
d701 1
a701 1
.include "${PORTSDIR}/infrastructure/db/network.conf"
d703 1
a703 1
.include "${PORTSDIR}/infrastructure/templates/network.conf.template"
d894 1
d1105 1
a1105 1
	cd ${WRKBUILD} && ${_SYSTRACE_CMD} ${SETENV} REALOS=MirOS \
d2057 1
a2057 1
		/bin/sh ${PORTSDIR}/infrastructure/build/update-patches); \
d2597 1
a2597 1
	@@cd ${.CURDIR} && exec ${MAKE} clean=dist
@


1.103
log
@merge (heavy effort ;)
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.102 2004/06/03 13:30:33 tg Exp $
d1519 1
a1519 1
			echo "file from the OpenBSD main archive, type"; \
@


1.102
log
@remove USE_LIBTOOL flag.

currently breaks:
 * audio/faad
	fix underways...
 * audio/grip
 * devel/ffcall
 * devel/gengameng
 * games/bombermaze
 * math/graphviz
 * misc/hfsplus
 * net/etherape
 * net/ethereal
 * security/nessus
 * www/mod_jk
 * www/xmhtml
 * x11/ion
	definitively broken anyways, wants libltdl from libtool-new
 * x11/py-Gtk
 * x11/xfce4/plugins/xfce4-minicmd-plugin
@
text
@d1 2
a2 2
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.101 2004/06/01 21:41:05 tg Exp $
# $OpenBSD: bsd.port.mk,v 1.615 2004/05/31 12:27:07 sturm Exp $
d1171 2
d1704 16
@


1.101
log
@* merge all the latest stuff from OpenBSD
* shovel some stuff into the right place
* update licence, pointers etc.
* update <sys.port.mk> with stuff which is already in our
  <sys.mk> but not in the <sys.mk> of ekkoBSD
  (maybe need more? who knows)
* style (lines <80 chars, the obnoxious 0x60 character,
  whitespace at end of line/file, etc.)
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.100 2004/05/23 21:34:23 tg Exp $
a229 1
LIBTOOL_FLAGS?=
a258 13
USE_LIBTOOL?=		No
.if ${USE_LIBTOOL:L} == "yes"
LIBTOOL?=		${LOCALBASE}/bin/libtool
BUILD_DEPENDS+=		::devel/libtool/v1.3
CONFIGURE_ENV+=		LIBTOOL="${LIBTOOL} ${LIBTOOL_FLAGS}"
MAKE_ENV+=		LIBTOOL="${LIBTOOL} ${LIBTOOL_FLAGS}"
MAKE_FLAGS+=		LIBTOOL="${LIBTOOL} ${LIBTOOL_FLAGS}"
# Users of an external GNU Libtool most probably don't want
# to use MirLibtool. Besides that, the libtool port provides
# libltdl, which MirLibtool doesn't.
MODGNU_MIRLIBTOOL=	no
.endif

a2139 3
.endif
.if ${USE_LIBTOOL:L} == "yes"
_EXTRA_DESCRIBE+=	"(uses Libtool)"
@


1.100
log
@simplify (c) and move it to ports/README from all the single
files it was spread before
@
text
@d1 2
a2 2
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.99 2004/05/02 19:21:55 tg Exp $
# $OpenBSD: bsd.port.mk,v 1.611 2004/02/07 22:36:13 espie Exp $
d78 1
d601 1
a601 1
SYSTRACE_SUBST_VARS+=	WRKDIR PORTSDIR DISTDIR
d854 1
a854 1
PATCH_CASES+= *) ${PATCH} ${PATCH_DIST_ARGS} < $$patchfile;;
d1215 1
a1215 1
	@@echo "Policy: ${_i}, Emulation: native" >> $@@
d1217 1
a1217 1
		cat ${.CURDIR}/systrace.filter >> $@@; \
d1219 1
a1219 1
	@@sed ${_SYSTRACE_SED_SUBST} ${SYSTRACE_FILTER} >> $@@
d1221 3
a1223 1

d1233 3
a1235 3
	@@sed -e '/^!%%SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' \
		-e '/^%%!SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' \
		-e '//d' -e '/^%%SHARED%%$$/d' <${PLIST} \
d1241 2
a1242 2
			-e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' \
			-e '//d' <${PLIST} ${SED_PLIST} \
d1247 2
a1248 2
			-e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' \
			-e '//d' <${PLIST} \
d1290 1
a1290 1
			$$cipher ${_CKSUMFILES} >> ${CHECKSUM_FILE}; \
d1293 1
a1293 1
		echo "MD5 ($$file) = IGNORE" >> ${CHECKSUM_FILE}; \
d1304 1
a1304 1
			$$cipher ${_CKSUMFILES} >> ${CHECKSUM_FILE}; \
d1307 1
a1307 1
		echo "MD5 ($$file) = IGNORE" >> ${CHECKSUM_FILE}; \
d1310 2
a1311 1
	@@if [ `sed -e 's/\=.*$$//' ${CHECKSUM_FILE} | uniq -d | wc -l` -ne 0 ]; then \
d1692 1
a1692 1
						${PATCH} ${PATCH_ARGS} < $$i || \
d2258 1
a2258 1
	@@echo ${FULLPKGNAME${SUBPACKAGE}} | ${HTMLIFY} > $@@.tmp3
d2301 1
a2301 1
		>> $@@
d2474 1
a2474 1
		echo "|${_dir}|" >> $${_DEPENDS_FILE}; \
d2503 1
a2503 1
		echo "|${_dir}|" >> $${_DEPENDS_FILE}; \
d2520 1
a2520 1
		echo "|${_dir}|" >> $${_DEPENDS_FILE}; \
@


1.99
log
@spell licence properly :)
@
text
@d1 1
a1 1
# $MirBSD: ports/infrastructure/mk/bsd.port.mk,v 1.98 2004/04/09 23:05:41 tg Exp $
a5 30
# Copyright (c) 2003, 2004 by
#	The MirPorts Framework Team (see the list below)
# Code contributed by Jordan K. Hubbard, the FreeBSD project, NetBSD
# Foundation and Theo de Raadt's OpenBSD project.
#
# Subject to these terms, everybody who obtained a copy of this work
# is hereby permitted to deal in the work without restriction inclu-
# ding without limitation the rights to use, distribute, sell, modi-
# fy, publically perform, give away, merge or sublicence it provided
# this notice is kept and the authors and contributors are given due
# credit in derivates or accompanying documents.
#
# This work is provided by its developers (authors and contributors)
# "as is" and without any warranties whatsoever, express or implied,
# to the maximum extent permitted by applicable law; in no event may
# developers be held liable for damage caused, directly or indirect-
# ly, but not by a developer's malice intent, even if advised of the
# possibility of such damage.
#
# This licence agreement shall be governed in all aspects by the law
# of Germany; designated place of court is Bonn, NRW, Germany.  (Der
# Gerichtsstand ist Bonn, NRW/Deutschland. Es gilt deutsches Recht.)
#
# These people are currently in the MirPorts Framework team, or have
# been contributing actively to the MirPorts Framework in the past:
#	Waldemar Brodkorb (former MirOS developer)
#	Thorsten Glaser (MirOS Project)
#	Benny Siegert (MirOS Project)
#	Josef Sntgen (MirOS contributor)
#-
d8 5
@


1.98
log
@helps ghostscript to build
fixes some png dependency issues
fixes the "can't build PKGNAME..cgz" appearing sometimes
fixes maintainer displayed in DESCR in final package
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.97 2004/04/09 21:56:26 tg Exp $
d137 1
a137 1
ERRORS+=		"The licensing info for ${FULLPKGNAME} is incomplete."
@


1.97
log
@another trial for png dependencies;
this time it matches
	png
	png.(any number)
	png.major.minor
which should be pretty much everything occuring.
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.96 2004/04/07 18:14:01 tg Exp $
d1286 1
a1286 1
	@@echo "\nMaintainer: ${MAINTAINER}" >>$@@
d1395 1
d2447 3
d2457 2
a2458 2
			eval $$toset ${MAKE} ${PKGREPOSITORY}/$$default.${PKG_SUFX}; \
			listlibs='pkg_info -L ${PKGREPOSITORY}/$$default.${PKG_SUFX}|grep $$shdir|sed -e "s,^$$shdir/,,"'; \
d2485 1
a2485 1
	}
@


1.96
log
@blargh, more flexibility for png
tradeoff: needs ksh... anyways
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.95 2004/03/21 00:42:29 tg Exp $
d1103 1
a1103 1
		[[ $$d = png || $$d = png.@@(2|3|4) ]] && check=yes;
@


1.95
log
@this should fix packages with lib_depends on anything else but png
noticed by bsiegert@@, fix by me, sorry
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.94 2004/03/19 23:37:19 tg Exp $
d1103 1
a1103 1
		[ x"$$d" = x"png.2" -o x"$$d" = x"png" ] && check=yes;
@


1.94
log
@merge pkgpath.mk into sys.port.mk, which is included anyways
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.93 2004/03/19 23:29:31 tg Exp $
d1105 1
a1105 1
_libpng_fragment= ;
@


1.93
log
@preliminary update to current consensus on licence template
for the list of people in the MirPorts team, mark which project
they are from (in case we get external help ;)
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.92 2004/03/13 22:05:01 tg Exp $
a107 3

# local path locations
.include "${PORTSDIR}/infrastructure/mk/pkgpath.mk"
@


1.92
log
@blah blah png
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.91 2004/03/13 14:41:13 tg Exp $
d7 1
a7 2
#	The MirPorts Framework Team, MirOS Project
# (for the full list of authors, please refer to the list below)
d18 10
a27 5
# This work is provided "as is" with no explicit or implicit warran-
# ties whatsoever to the maximum extent permitted by applicable law;
# in no event may an author or contributor be held liable for damage
# that is, directly or indirectly, caused by the work, even if advi-
# sed of the possibility of such damage.
d31 4
a34 4
#	Thorsten Glaser
#	Benny Siegert
#	Waldemar Brodkorb
#	Josef Sntgen
@


1.91
log
@unfuckup after png fuckup, sorry for the breakage
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.90 2004/03/13 14:19:55 tg Exp $
d1102 1
a1102 1
		[ x"$$d" = x"png.2" ] && check=yes;
@


1.90
log
@unbreak xloadimage - dependencies on png.2 look for libpng.so too
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.89 2004/03/09 22:27:21 tg Exp $
d1100 6
d1111 1
a1111 2
		${_libresolve_fragment}; \
		[ x"$$d" = x"png.2" ] && check=yes; \
d2456 1
a2456 1
			${_libresolve_fragment}; \
@


1.89
log
@note EMUL in make describe output, too
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.88 2004/03/09 18:14:14 tg Exp $
d1106 1
@


1.88
log
@woohoo, my first after-birthday merge XDD
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.87 2004/03/06 22:19:25 tg Exp $
d2180 3
@


1.87
log
@rename REQUIRE_EMUL -> EMUL
make these ports use/define it
nuke SunOS from netscape, we don't have it (back then agreed with wbx@@)
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.86 2004/03/06 22:15:47 tg Exp $
d293 1
a293 1
MODGNU_CONFIG_MIRLIBTOOL=no
@


1.86
log
@works without, too
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.85 2004/03/04 09:20:47 tg Exp $
d1424 1
a1424 1
.for _i in ${REQUIRE_EMUL}
@


1.85
log
@remove all traces of sysctl writes in ports
they must not do this

note: these ports must be converted to REQUIRE_EMUL now.

-

fix some typos, whitespace
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.84 2004/03/02 10:42:20 tg Exp $
a1423 1
REQUIRE_EMUL?=
@


1.84
log
@NO_CXX compatibility glue for older OSes
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.83 2004/02/28 14:45:08 tg Exp $
d1424 1
a1424 1
#EQUIRE_EMUL?=
@


1.83
log
@solve most problems an operating system version checker might have.
need to adjust for OpenBSD 3.4 ./. 3.5 diversion later, though.

MirOS BSD #7 users: you *must* update your pkg tools to #7-stable
before attempting to use them. An MFC is in progress.
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.82 2004/02/27 00:09:56 tg Exp $
d928 3
@


1.82
log
@USE_SYSTRACE is stable enough, and the half dozen of ports which are
not supported by it already have a NO_SYSTRACE, so enable by default

on BSD, security > speed. even OpenBSD seems to ignore it sometimes;
well we do actually, too... no blaming these guys
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.81 2004/02/25 18:18:04 tg Exp $
a118 5
.if ${OPSYS} == "OpenBSD"
FETCH_CMD?=		/usr/bin/ftp -V -m
.else
FETCH_CMD?=		/usr/bin/ftp -EV -m
.endif
a375 2
MIRBSD_PKGTOOLS?=	Yes
PKG_ARGS_ADD=
a376 1
PKG_SUFX?=		.tgz
a380 10
.else
_VERCHECK_MAJOR=7
_VERCHECK_MINOR=159
.  include <bsd.port.ver.mk>
.  if ${_VERCHECK_VALUE} != "1"
PKG_SUFX?=		.tgz
PKG_ARGS_ADD+=		-Z
.  else
PKG_SUFX?=		.cgz
.  endif
d617 2
a618 9
_SYSTRACE_HAS_E=	-e
.  if ${_OSrev} == 7
.    if ${_OSrpl} < 154
_SYSTRACE_HAS_E=
.    endif
.  elif ${OSrev} < 7
_SYSTRACE_HAS_E=
.  endif
_SYSTRACE_CMD?=		/bin/systrace ${_SYSTRACE_HAS_E} -i -a -f ${_SYSTRACE_COOKIE}
@


1.81
log
@depending on if an ustar or sv4crc archive is created,
use the correct extension (.tgz / .cgz) and parametres
to the mirbsd or openbsd pkgtools.

``bah, go on bsiegert@@
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.79 2004/02/25 15:31:33 tg Exp $
d84 1
a84 1
USE_SYSTRACE?=		No
@


1.80
log
@instead of hardcoding .tgz in two places, use $PKG_SUFX instead
@
text
@d381 13
d395 5
d736 1
a736 14
MIRBSD_PKGTOOLS?=	Yes
.if ${MIRBSD_PKGTOOLS:L} == "no"
PKG_ARGS+=		-A'${PKG_ARCH}'
.  if ${LOCALBASE} != "/usr/local"
PKG_ARGS+=		-L${LOCALBASE}
.  endif
.else
_VERCHECK_MAJOR=7
_VERCHECK_MINOR=159
.  include <bsd.port.ver.mk>
.  if ${_VERCHECK_VALUE} != "1"
PKG_ARGS+=		-Z
.  endif
.endif
@


1.79
log
@add extract cases for cpio files
we need not require cpio distfiles be named .tgz :)
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.78 2004/02/25 14:29:16 tg Exp $
d2461 2
a2462 2
			eval $$toset ${MAKE} ${PKGREPOSITORY}/$$default.tgz; \
			listlibs='pkg_info -L ${PKGREPOSITORY}/$$default.tgz|grep $$shdir|sed -e "s,^$$shdir/,,"'; \
@


1.78
log
@on older MirOS versions, use -Z to pkg_create(1) because paxtar does
not yet support the options necessary for creating SV4CPIO archives
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.77 2004/02/22 23:35:37 tg Exp $
d883 1
a883 1
EXTRACT_CASES+= *.tar.bz2) ${BZIP2} -dc ${FULLDISTDIR}/$$archive | ${TAR} xf -;;
d885 1
a885 1
EXTRACT_CASES+= *.tar) ${TAR} xf ${FULLDISTDIR}/$$archive;;
d888 1
a888 1
EXTRACT_CASES+= *.tar.gz) ${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive | ${TAR} xf -;;
@


1.77
log
@neither bsiegert@@ nor I think that, since we use rcdb for
counting shared directory references, make-plist needs to
check all dependent packages.

may someone please check this up with espie@@openbsd?
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.76 2004/02/21 21:31:14 tg Exp $
d723 7
@


1.76
log
@merge
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.75 2004/02/19 19:59:29 tg Exp $
a2065 1
	DEPS="$$(${MAKE} full-run-depends)" \
@


1.75
log
@enable schily to coexist with different configure styles
@
text
@d1 2
a2 2
# $MirBSD: bsd.port.mk,v 1.74 2004/02/19 19:55:34 tg Exp $
# $OpenBSD: bsd.port.mk,v 1.602 2004/01/22 21:28:49 espie Exp $
d6 3
a8 3
# Copyright (c) 2003, 2004 by The MirPorts Framework Team, MirOS Project
#	(for the full list of authors, please refer
#	 to src/share/man/man0/COPYRIGHT within CVS)
d24 7
d87 3
d105 9
d167 3
a169 1
	@@echo ${${show}:Q}
d186 1
a186 1
.if ${CLEANDEPENDS:L} == "yes"
d208 1
d210 1
a210 1
.if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
d218 1
a218 2
.else
.  if exists(${.CURDIR}/patches.${MACHINE_ARCH})
a221 1
.  endif
d228 1
a228 2
.else
.if exists(${.CURDIR}/scripts.${MACHINE_ARCH})
a232 1
.endif
d236 1
a236 2
.else
.if exists(${.CURDIR}/files.${MACHINE_ARCH})
a240 1
.endif
d244 1
a244 2
.else
.if exists(${.CURDIR}/pkg.${MACHINE_ARCH})
a248 1
.endif
d500 2
a501 2
.if defined(FAKEOBJDIR)
WRKINST?=		${FAKEOBJDIR}/${PKGNAME}${_FLAVOR_EXT2}
d506 1
a506 1
.if defined(WRKOBJDIR)
d508 1
a508 1
WRKDIR?=		${WRKOBJDIR}/${PKGNAME}
d510 1
a510 1
WRKDIR?=		${WRKOBJDIR}/${PKGNAME}${_FLAVOR_EXT2}
d721 3
d794 2
d797 1
a797 5
.if exists(/cdrom/distfiles)
CDROM_SITE=		/cdrom/distfiles/${DIST_SUBDIR}
.endif

.if defined(CDROM_SITE)
d843 1
a843 1
.if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
d1141 1
a1141 1
.if ${BULK:L} == "yes"
a1145 2
BULK_TARGETS?=

d1170 1
a1170 1
.if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
a1211 2
.include "${PORTSDIR}/infrastructure/mk/pkgpath.mk"

d1415 1
a1415 12
.if ${ELF_TOOLCHAIN:L} == "no"
${_LIBLIST}: ${_FAKE_COOKIE}
	@@${SUDO} mkdir -p ${WRKINST}/usr/libexec
	@@-${SUDO} cp -f /usr/libexec/ld.so ${WRKINST}/usr/libexec
	@@-${SUDO} cp -f /usr/lib/libc.so.* ${WRKINST}
	@@-${SUDO} cp -f /usr/bin/ldd ${WRKINST}
	@@cd ${WRKINST} && ${SUDO} find . -type f|\
		${SUDO} env LD_LIBRARY_PATH=. xargs chroot ${WRKINST} \
		./ldd -f '\tlibrary: %o %m %n\n' -f '\tlibrary: %o %m %n\n' 2>/dev/null|\
		grep '^	'|\
		sort -u >$@@
.else
d1419 3
a1421 5
		grep NEEDED |\
		sed 's/\ lib//g' |\
		sed 's/  NEEDED     /	library: /g' |\
		sed 's/\.so\./ /g' |\
		sed 's/^\(.*\)\ \([^\.]*\)\.\([^\.]*\)/\1\ \2\ \3/g' |\
a1422 1
.endif
d1431 1
a1431 1
		fgrep .so.|${SUDO} xargs file -L|fgrep 'shared'|cut -d\: -f1|sort -u >$@@
d1465 1
a1465 1
		perl ${PORTSDIR}/infrastructure/install/check-libs \
a1485 1
# See ports/infrastructure/templates/Makefile.template
d1603 1
a1603 1
.for _i in ${BULK_TARGETS}
d2019 1
a2019 1
.    if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
d2026 1
a2026 1
	-${SUDO} ${PKG_DELETE} ${_clean:M-f} ${FULLPKGNAME${_s}}
d2029 1
a2029 1
	-${SUDO} ${PKG_DELETE} ${_clean:M-f} ${FULLPKGNAME${SUBPACKAGE}}
d2122 1
a2122 1
.  if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
d2638 1
a2638 1
	@@${SUDO} ${PKG_DELETE} -f ${FULLPKGNAME${SUBPACKAGE}}
@


1.74
log
@Who's worse, Jrg Schilling or Crud Puppy?
/me tends to the former

we've got mod_schily now (USE_SCHILY?=No)... *sigh*
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.73 2004/02/15 02:09:06 tg Exp $
d1764 2
a1765 1
.elif target(do-configure)
d1767 1
a1767 1
.else
@


1.73
log
@remove change of the order
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.72 2004/02/15 01:11:44 tg Exp $
d254 2
a255 1
.if ${USE_GMAKE:L} == "yes"
d260 3
d1756 9
a1764 1
.if target(do-configure)
d2179 3
@


1.72
log
@autogen is a more appropriate, and shorter, name
it's also more common between GNU folks
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.71 2004/02/15 01:05:26 tg Exp $
d1732 3
a1739 3
.if target(post-patch)
	@@cd ${.CURDIR} && exec ${MAKE} post-patch
.endif
@


1.71
log
@this GNU stuff really is funny
but now, we've hidden some magic, _and_ got rid of a port USE_LIBTOOL
left: 16

builds
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.70 2004/02/15 00:43:14 tg Exp $
d264 1
a264 1
    || ${CONFIGURE_STYLE:L:Mautoupdate} || ${CONFIGURE_STYLE:L:Mautobootstrap}
@


1.70
log
@shuffle the order of execution a bit to help modules
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.69 2004/02/14 21:19:04 tg Exp $
d263 2
a264 1
.if ${CONFIGURE_STYLE:L:Mautomake} || ${CONFIGURE_STYLE:L:Mautoconf} || ${CONFIGURE_STYLE:L:Mautoupdate}
@


1.69
log
@use -E parameter to ftp (if OS not OpenBSD) by default
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.68 2004/02/12 20:38:19 tg Exp $
a1730 3
.if target(post-patch)
	@@cd ${.CURDIR} && exec ${MAKE} post-patch
.endif
d1736 3
@


1.68
log
@bsiegert@@ noticed problems with w3m and SUPDISTFILES.
this change _should_ do the following (I'm still not good at make):
 - if SUPDISTFILES is given, fetch-all and checksum will check them too
   (for mirroring etc. purposes)
 - but a "normal" make will ignore them (unless they're DISTFILES)

works on w3m and w3m,-m17n so far; testing appreciated
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.67 2004/02/11 14:10:30 tg Exp $
d100 1
d102 3
@


1.67
log
@remove untrue comment (MirPorts imake _does_ peruse CFLAGS :)
always add COPTS et al. to CFLAGS
ensure CPPFLAGS are added to CFLAGS and CXXFLAGS
(this should btw make for a nice point to add -D__OpenBSD__ if
 the ekkoBSD project decides to undefine it in the future)
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.66 2004/02/09 20:28:30 tg Exp $
d797 1
a797 1
.  if defined(SUPDISTFILES)
d1277 1
a1277 1
# substitute 
d1614 2
a1615 1
	@@cd ${.CURDIR} && exec ${MAKE} checksum build-depends lib-depends
@


1.66
log
@clients to USE_LIBTOOL=YES most probably don't want MirLibtool
OTOH, many USE_LIBTOOL=YES are probably _better_ off than now
if they are converted to use MirLibtool (CONFIGURE_STYLE=autoconf)
instead - as long as they don't use -lltdl, which is LIBTOOL.
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.65 2004/02/03 16:57:13 tg Exp $
d429 4
a432 9
# Add any COPTS to CFLAGS.  Note: programs that use imake do not
# use CFLAGS!  Also, many (most?) ports hard code CFLAGS, ignoring
# what we pass in.
.if defined(COPTS)
CFLAGS+=		${COPTS} -I${LOCALBASE}/include
.endif
.if defined(CXXOPTS)
CXXFLAGS+=		${CXXOPTS} -I${LOCALBASE}/include
.endif
@


1.65
log
@don't cleandepends=yes when rm'ing pkg
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.64 2004/01/31 19:20:11 tg Exp $
d272 4
@


1.64
log
@MirOS #7 didn't have ${MIRBSD_PKGTOOLS}
neither OpenBSD 3.4 nor 3.4-current

if using MirPorts on OpenBSD 3.4-current,
# echo MIRBSD_PKGTOOLS=No >>/etc/mk.conf
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.63 2004/01/29 21:21:11 tg Exp $
d1914 1
a1914 1
	    ${SUDO} ${MAKE} clean=package; \
d2605 1
a2605 1
	@@cd ${.CURDIR} && exec ${MAKE} clean=package
d2612 1
a2612 1
	@@cd ${.CURDIR} && exec ${MAKE} clean=packages
@


1.63
log
@if the {package is,distfiles are} markes
 PERMIT_*_CDROM=Yes but PERMIT_*_FTP!=Yes,
keep it as an error.

Our ISOs should be FTP exportable.
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.62 2004/01/29 17:19:54 tg Exp $
d696 1
@


1.62
log
@new: REQUIRE_EMUL (because MirPorts are not allowed to set sysctl)
fix some typos, too
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.61 2004/01/27 18:09:15 tg Exp $
d127 9
@


1.61
log
@our pkgtools don't have -A, the openbsd ones do
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.60 2004/01/27 17:37:32 tg Exp $
d616 1
a616 1
# find out the most appropriate PLIST  source
d1419 8
d1922 1
a1922 1
	@@echo "*** ${_M}"
@


1.60
log
@as per suggestion on ports@@openbsd,
take the homepage into the INDEX
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.59 2004/01/27 17:27:28 tg Exp $
d687 3
a689 1
PKG_ARGS+=-A'${PKG_ARCH}'
@


1.59
log
@by (probably unpopular) decision:
- don't fake we are openbsd to the configure script:
  * autoconf should already know it aight
  * simple break

Most ports should work (if not, I'll cede back this commit);
few might need fixes in configure.in (something along the
lines: case foo in openbsd*) -> openbsd* | mirbsd* | ekkobsd*)
might be needed).
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.58 2004/01/27 17:02:59 tg Exp $
d2173 1
a2173 1
	@@echo -n ${_COMMENT}${_EXTRA_DESCRIBE}"|"; \
@


1.58
log
@import
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.57 2004/01/19 16:23:32 tg Exp $
d1123 1
a1123 1
		${_CONFIGURE_SCRIPT} ${CONFIGURE_ARGS} ${_CONFIGURE_DOOBSD}
@


1.57
log
@NO_CXX defaults to "no", not "yes" for hysterical raisins
(and compatibility with #7 mk.conf)
@
text
@d1 2
a2 2
# $MirBSD: bsd.port.mk,v 1.56 2004/01/19 16:19:24 tg Exp $
# $OpenBSD: bsd.port.mk,v 1.600 2004/01/18 07:52:49 sturm Exp $
d102 6
d321 1
a321 1
SED_PLIST+=|sed -e '/^!%%${_i}%%$$/r${PKGDIR}/PFRAG.no-${_i}' -e '//d' -e '/^%%${_i}%%$$/d'
d327 1
a327 1
SED_PLIST+=|sed -e '/^!%%${_i}%%$$/d' -e '/^%%${_i}%%$$/r${PKGDIR}/PFRAG.${_i}' -e '//d'
d687 1
@


1.56
log
@(c) for MirPorts is "the MirOS Project's MirPorts Team", not every single
person by themselfes.
In English, "Theo de Raadt's project" is written _with_ an apostrophe.
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.55 2004/01/18 12:18:58 tg Exp $
d582 1
a582 1
.    if ${_OSrpl} < 153
d898 1
a898 1
NO_CXX?=		Yes
d949 1
a949 1
.  if ${USE_CXX:L} == "yes" && ${NO_CXX:L} != "no"
d997 1
a997 1
.    if defined(NO_CXX)
@


1.55
log
@merge
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.54 2004/01/17 01:02:34 tg Exp $
d7 2
a8 3
#	Waldemar Brodkorb <miros@@thinknow.de>
#	Thorsten Glaser <x86@@ePost.de>
#	Benny Siegert <bsiegert@@gmx.de>
d10 1
a10 1
# Foundation and Theo de Raadts OpenBSD project.
@


1.54
log
@* remove Waldemar Brodkorb as Maintainer as per his request
* merge MirXAWTV and OpenXAWTV
* merge import of the following ports:
  - databases/openldap
  - mail/mutt
  - mail/p5-Mail-SpamAssassin
  - net/irssi
  - www/snownews
* also, apply fixes so that irssi "might" build again
  (work by myself, even if I despise irssi totally)
* merge that another import again
* add back uvscan, uvscan_dat (XXX needs update!)
* remove calls to "sysctl -w kern.emul.foo=1" in PLISTs!
  no port is allowed to do such a change to the system!
* various minor fixes of rough edges which make more ports compile
* cosmetics in databases/db: no need to have four files,
  DESCR${SUBPACKAGE}, with identical contents
@
text
@d1 2
a2 2
# $MirBSD: bsd.port.mk,v 1.53 2004/01/16 18:48:29 tg Exp $
# $OpenBSD: bsd.port.mk,v 1.599 2004/01/11 15:04:01 sturm Exp $
d1206 3
@


1.53
log
@hopefully fix ports using <bsd.port.ver.mk> again
apologies to bsiegert@@ and Jos Antonio Matias de Jesus
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.52 2004/01/16 00:10:49 tg Exp $
d601 2
a602 2
SUBST_VARS+=		MACHINE_ARCH ARCH HOMEPAGE PREFIX SYSCONFDIR \
			FLAVOR_EXT MAINTAINER RESPONSIBLE MNTNER
d779 1
a779 1
.if make(makesum) || make(addsum) || defined(__FETCH_ALL)
@


1.52
log
@I admit I had broken "make fake".
Repair that.
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.51 2004/01/14 19:37:54 tg Exp $
d69 4
a72 1
.include <bsd.own.mk>
a85 24
# Constants used by the ports tree
ARCH!=			uname -m
A_OS!=			uname -s | tr '[A-Z]' '[a-z]'
_MIRPORTS_ADDRESS=	<miros-discuss@@${_DOMAIN_DU_JOUR}>
OPSYS=			MirBSD
OPSYS_VER=		${OSREV}
OScompat?=		3.4
.if defined(OSrpl)
_OSrev=			${OSrev}
_OSrpl=			${OSrpl}
.elif defined(OSrel) && defined(OSrelm)
_OSrev=			${OSrel}
_OSrpl=			${OSrelm}
.else
_OSrev=			0
_OSrpl=			0
.endif
_CONFIGURE_NOOBSD?=	No
_CONFIGURE_DOOBSD?=
AUTOCONF_FAKEOS=	${MACHINE_ARCH}-ecce-openbsd${OScompat}
.if ${_CONFIGURE_NOOBSD:L} == "no"
_CONFIGURE_DOOBSD+=	--host=${AUTOCONF_FAKEOS} --build=${AUTOCONF_FAKEOS}
.endif

a86 3
PORTSDIR?=		/usr/ports
LOCALBASE?=		/usr/local
X11BASE?=		/usr/X11R6
@


1.51
log
@fearless and careful (at least in infrastructure/) attempt to merge [a-n]
of ports and take care of the changes.
expect _major_ breakage. porters, check your ports. I might have been tired.

The following things have not been updated:
* databases/db
* databases/openldap
* mail/mutt
* mail/p5-Mail-SpamAssassin
* net/irssi

Maintainers, to merge the conflicts, use
$ cd databases/openldap; cvs -d $CVSROOT up -PAd -jcvs-200312021610 -jcvs-200301141450
then find and fix conflicts.

Note: some files might have been added or "marked for deletion".
No need to restate that CVS sucks, this is already consensus.
So please check the "cvs up" output carefully (not only rcsmerge,
but also cvs and U ones - and M, you shouldn't include local mods).
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.50 2004/01/11 16:18:56 tg Exp $
d1143 2
a1144 1
_FAKE_SETUP=TRUEPREFIX=	${PREFIX} PREFIX=${WRKINST}${PREFIX} ${DESTDIRNAME}=${WRKINST}
@


1.50
log
@* update licence template
* new ${A_OS} contains uname in lower case (mirbsd, openbsd for mirbsd#7)
* move P5ARCH and P5SITE to <bsd.port.mk>, might help fixing irssi *hint*
* nuke COMES_WITH, as announced earlier.
  all ports still using it *MUST* be converted to <bsd.port.ver.mk> now.
@
text
@d1 2
a2 2
# $MirBSD: bsd.port.mk,v 1.49 2004/01/01 17:00:45 tg Exp $
# $OpenBSD: bsd.port.mk,v 1.589 2003/11/22 12:03:44 espie Exp $
d28 1
a28 1

d34 1
a34 1

d39 1
a39 9


.if ${.MAKEFLAGS:MFLAVOR=*}
ERRORS+= "Fatal: Use 'env FLAVOR=${FLAVOR} ${MAKE}' instead."
.endif
.if ${.MAKEFLAGS:MSUBPACKAGE=*}
ERRORS+= "Fatal: Use 'env SUBPACKAGE=${SUBPACKAGE} ${MAKE}' instead."
.endif

d46 7
a52 11
#
#
# NO_PKG_REGISTER - Don't register a port install as a package.
# SCRIPTS_ENV	- Additional environment vars passed to scripts in
#                 ${SCRIPTDIR} executed by bsd.port.mk.
#
# Variables to change if you want a special behavior:
#
# DEPENDS_TARGET - The target to execute when a port is calling a
#				  dependency (default: "install").
#
d69 61
d137 8
a144 8
ERRORS+="The licensing info for ${FULLPKGNAME} is incomplete."
ERRORS+="Please notify the MirPorts maintainer:"
ERRORS+="    ${MNTNER}"
_BAD_LICENSING=Yes
PERMIT_PACKAGE_CDROM = No
PERMIT_DISTFILES_CDROM = No
PERMIT_PACKAGE_FTP = No
PERMIT_DISTFILES_FTP = No
d161 3
a163 26
FAKE?=Yes
TRUST_PACKAGES?=No
BIN_PACKAGES?=No
_LIBLIST=${WRKDIR}/.liblist-${ARCH}${_FLAVOR_EXT2}
_BUILDLIBLIST=${WRKDIR}/.buildliblist-${ARCH}${_FLAVOR_EXT2}

_MIRPORTS_ADDRESS=<miros-discuss@@${_DOMAIN_DU_JOUR}>

# Get the operating system and architecture
ARCH!=	uname -m
A_OS!=	uname -s | tr '[A-Z]' '[a-z]'

# Get the operating system type and version (XXX)
OPSYS=	MirBSD
OPSYS_VER=	${OSREV}

NO_SHARED_ARCHS=hppa m88k vax

# Define NO_SHARED_LIBS for those machines that don't support shared libraries.
.for _m in ${MACHINE_ARCH}
.  if !empty(NO_SHARED_ARCHS:M${_m})
NO_SHARED_LIBS=	Yes
.  endif
.endfor

CLEANDEPENDS?=No
d167 1
a167 1
_clean=${clean}
d169 1
a169 1
_clean+=work
d172 1
a172 1
_clean+=depends
d175 1
a175 1
_clean+=fake
d178 1
a178 1
_clean+=-f
d181 1
a181 1
NOMANCOMPRESS?=	Yes
d186 1
a186 2
.else
.if exists(${.CURDIR}/Makefile.${MACHINE_ARCH})
a188 1
.endif
d190 4
a193 11
NO_DEPENDS?= No
NO_BUILD?= No
NO_REGRESS?= No

# These need to be absolute since we don't know how deep in the ports
# tree we are and thus can't go relative.  They can, of course, be overridden
# by individual Makefiles or local system make configuration.
PORTSDIR?=		/usr/ports
LOCALBASE?=		/usr/local
X11BASE?=		/usr/X11R6
DISTDIR?=		${PORTSDIR}/distfiles
d195 1
a195 1
FULLDISTDIR?=	${DISTDIR}/${DIST_SUBDIR}
d197 1
a197 1
FULLDISTDIR?=	${DISTDIR}
a198 5
PKGREPOSITORYBASE?=	${PORTSDIR}/packages/${MACHINE_ARCH}
TEMPLATES?=		${PORTSDIR}/infrastructure/templates

CDROM_PACKAGES?=	${PKGREPOSITORYBASE}/cdrom
FTP_PACKAGES?=		${PKGREPOSITORYBASE}/ftp
d203 1
a203 1
.if exists(${.CURDIR}/patches.${MACHINE_ARCH})
d205 1
a205 1
.else
d207 1
a207 1
.endif
d210 1
a210 1
PATCH_LIST?=    patch-*
d242 6
a247 6
PREFIX?=	${LOCALBASE}
TRUEPREFIX?=	${PREFIX}
DESTDIRNAME?=	DESTDIR
DESTDIR?=	${WRKINST}
P5SITE=		libdata/perl5/site_perl
P5ARCH=		${P5SITE}/${MACHINE_ARCH}-${A_OS}
d252 1
a252 1
FAKE_FLAGS=${DESTDIRNAME}=${WRKINST}
d258 1
a258 1
SYSCONFDIR?=	/etc
d271 1
a271 1
CONFIGURE_STYLE+=gnu
d275 1
a275 1
USE_LIBTOOL?=No
d277 1
a277 1
LIBTOOL?=			${LOCALBASE}/bin/libtool
d280 1
a280 1
MAKE_ENV+=			LIBTOOL="${LIBTOOL} ${LIBTOOL_FLAGS}"
a283 4
.if exists(${PORTSDIR}/../Makefile.inc)
.include "${PORTSDIR}/../Makefile.inc"
.endif

d288 1
a288 1
FLAVORS+=${PSEUDO_FLAVORS}
d291 1
a291 1
NO_REGRESS= Yes
d294 1
a294 1
USE_MOTIF?=No
d302 1
a302 1
FLAVORS+=lesstif
d304 1
a304 1
ERRORS+="Fatal: choose motif or lesstif, not both."
d312 1
a312 1
ERRORS+= "Fatal: Unknown USE_MOTIF=${USE_MOTIF} settings."
d314 1
a314 1
MOTIFLIB=-L${LOCALBASE}/lib -lXm
d320 1
a320 1
ERRORS+= "Fatal: Subpackage ${SUBPACKAGE} does not exist."
d355 2
a356 2
ERRORS+=	"Fatal: Unknown flavor: ${_i}"
ERRORS+= "   (Possible flavors are: ${FLAVORS})."
d360 1
a360 1
ERRORS+=	"Fatal: no flavors for this port."
d365 3
a367 7
PKGREPOSITORY?=		${PKGREPOSITORYBASE}/all
PKG_DBDIR?=		/var/db/pkg
BULK_COOKIES_DIR?= ${PORTSDIR}/bulk/${MACHINE_ARCH}

PKGNAME?=${DISTNAME}
FULLPKGNAME?=${PKGNAME}${FLAVOR_EXT}
PKGFILE=${PKGREPOSITORY}/${FULLPKGNAME}${PKG_SUFX}
d370 1
a370 1
.if defined(MULTI_PACKAGES)
d374 1
a374 1
FULLPKGNAME${_s} = ${PKGNAME${_s}}${FLAVOR_EXT}
d376 1
a376 1
FULLPKGNAME${_s} = ${PKGNAME}${_s}${FLAVOR_EXT}
d379 1
a379 1
PKGFILE${_s} = ${PKGREPOSITORY}/${FULLPKGNAME${_s}}${PKG_SUFX}
d393 1
a393 1
_INSTALL_PRE_COOKIE=${WRKINST}/.install_started
d395 1
a395 1
_INSTALL_PRE_COOKIE=${WRKBUILD}/.install_started
d397 1
a397 1
_INSTALL_PRE_COOKIE=${WRKDIR}/.install_started
d411 8
a418 6
_ALL_COOKIES=${_EXTRACT_COOKIE} ${_PATCH_COOKIE} ${_CONFIGURE_COOKIE} \
${_INSTALL_PRE_COOKIE} ${_BUILD_COOKIE} ${_REGRESS_COOKIE} \
${_PACKAGE_COOKIES} \
${_DISTPATCH_COOKIE} ${_PREPATCH_COOKIE} ${_FAKE_COOKIE} \
${_WRKDIR_COOKIE} ${_DEPlib_COOKIES} ${_DEPbuild_COOKIES} \
${_DEPrun_COOKIES} ${_DEPregress_COOKIES}
d420 1
a420 1
_MAKE_COOKIE=touch -f
d425 1
a425 1
CHECKSUM_FILE?=	${.CURDIR}/distinfo
d431 1
a431 1
PREFERRED_CIPHERS?= ${_CIPHERS}
d433 1
a433 1
PORTPATH?= ${WRKDIR}/bin:/usr/bin:/bin:/usr/sbin:/sbin:${LOCALBASE}/bin:${X11BASE}/bin
d462 1
a462 3
FETCH_CMD?=		/usr/bin/ftp -V -m

DISTORIG?=	.bak.orig
d464 2
a465 2
PATCHORIG?=	.orig
PATCH_STRIP?=	-p0
d468 1
a468 1
PATCH_DEBUG?=No
d470 1
a470 1
PATCH_ARGS?=	-d ${WRKDIST} -z ${PATCHORIG} -E ${PATCH_STRIP}
d473 1
a473 1
PATCH_ARGS?=	-d ${WRKDIST} -z ${PATCHORIG} --forward --quiet -E ${PATCH_STRIP}
a476 1
PATCH_CHECK_ONLY?=No
d478 1
a478 1
PATCH_ARGS+=	-C
d482 3
a484 6
TAR?=	/bin/tar
UNZIP?=	unzip
BZIP2?=	bzip2


MAKE_ENV+=	EXTRA_SYS_MK_INCLUDES="<bsd.own.mk>"
d486 1
d489 1
a489 1
WRKINST?=	${FAKEOBJDIR}/${PKGNAME}${_FLAVOR_EXT2}
d491 1
a491 1
WRKINST?=	${WRKDIR}/fake-${ARCH}${_FLAVOR_EXT2}
d510 1
a510 1
WRKSRC?=	   ${WRKDIST}
d523 1
a523 1
FAKE_TARGET ?= ${INSTALL_TARGET}
d527 1
a527 1
MODULES+=${_i}
d536 6
a541 2
REGRESS_TARGET ?= regress
REGRESS_FLAGS ?= ${MAKE_FLAGS}
d544 1
a544 1
_PACKAGE_COOKIE_DEPS=${_FAKE_COOKIE}
d546 1
a546 1
_PACKAGE_COOKIE_DEPS=${_INSTALL_COOKIE}
d549 1
a549 1
_PACKAGE_COOKIES= ${_PACKAGE_COOKIE}
d562 2
a563 9
_PACKAGE_COOKIE${_s} = ${PKGFILE${_s}}
_PACKAGE_COOKIES += ${_PACKAGE_COOKIE${_s}}
.  if ${BIN_PACKAGES:L} == "yes"
${_PACKAGE_COOKIE${_s}}:
	@@cd ${.CURDIR} && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS}
.  else
${_PACKAGE_COOKIE${_s}}: ${_PACKAGE_COOKIE_DEPS}
.  endif
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' FLAVOR='${FLAVOR}' PACKAGING='${_s}' exec ${MAKE} _package
a565 4
.PRECIOUS: ${_PACKAGE_COOKIES} ${_INSTALL_COOKIE}

.include "${PORTSDIR}/infrastructure/mk/pkgpath.mk"

d567 1
a567 1
FULLPKGPATH=${PKGPATH}${_FLAVOR_EXT2:S/-/,/g}
d569 1
a569 1
FULLPKGPATH=${PKGPATH},${SUBPACKAGE}${_FLAVOR_EXT2:S/-/,/g}
d599 2
a600 2
MAKE_ENV+=	${_INSTALL_MACROS}
SCRIPTS_ENV+=	${_INSTALL_MACROS}
d602 2
a603 3
# setup systrace
USE_SYSTRACE?=	No
NO_SYSTRACE?=	No
d605 9
a613 1
_SYSTRACE_CMD?=	/bin/systrace -i -a -f ${_SYSTRACE_COOKIE}
d617 3
a619 4
SYSTRACE_FILTER?=		${PORTSDIR}/infrastructure/db/systrace.filter
_SYSTRACE_POLICIES+=	/bin/sh /usr/bin/env /usr/bin/make \
	${LOCALBASE}/bin/gmake
SYSTRACE_SUBST_VARS+=	WRKOBJDIR PORTSDIR DISTDIR
d621 1
a621 8
_SYSTRACE_SED_SUBST+=-e 's,$${${_v}},${${_v}},g'
.endfor

${_SYSTRACE_COOKIE}:
	@@rm -f $@@
.for _i in ${_SYSTRACE_POLICIES}
	@@echo "Policy: ${_i}, Emulation: native" >> $@@
	@@sed ${_SYSTRACE_SED_SUBST} ${SYSTRACE_FILTER} >> $@@
d625 3
a627 3
SUBST_VARS+=MACHINE_ARCH ARCH HOMEPAGE PREFIX SYSCONFDIR FLAVOR_EXT \
	    MAINTAINER RESPONSIBLE MNTNER
_SED_SUBST=sed
d629 1
a629 1
_SED_SUBST+=-e 's|$${${_v}}|${${_v}}|g'
d631 1
a631 1
_SED_SUBST+=-e 's,$${FLAVORS},${FLAVOR_EXT},g' -e 's,$$\\,$$,g'
d633 1
a633 1
SED_PLIST+=|${_SED_SUBST}
d637 1
a637 1
PLIST=		${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${ARCH}
d640 1
a640 1
PLIST=		${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${MACHINE_ARCH}
d644 1
a644 1
PLIST=		${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.noshared
d647 1
a647 1
PLIST=		${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}
d650 1
a650 1
PLIST=		${PKGDIR}/PLIST${SUBPACKAGE}.${ARCH}
d653 1
a653 1
PLIST=		${PKGDIR}/PLIST${SUBPACKAGE}.${MACHINE_ARCH}
d657 1
a657 1
PLIST=		${PKGDIR}/PLIST${SUBPACKAGE}.noshared
d659 1
a659 1
PLIST?=		${PKGDIR}/PLIST${SUBPACKAGE}
d663 1
a663 1
_COMMENT=${COMMENT${SUBPACKAGE}${FLAVOR_EXT}}
d665 1
a665 8
_COMMENT=${COMMENT${SUBPACKAGE}}
.endif

${WRKPKG}/COMMENT${SUBPACKAGE}:
.if defined(_COMMENT)
	@@echo ${_COMMENT} >$@@
.else
ERRORS+="Fatal: Missing comment."
d669 1
a669 28
MESSAGE?= ${PKGDIR}/MESSAGE${SUBPACKAGE}
.endif

DESCR?=		${PKGDIR}/DESCR${SUBPACKAGE}

# And create the actual files from sources
${WRKPKG}/PLIST${SUBPACKAGE}: ${PLIST} ${WRKPKG}/depends${SUBPACKAGE}
	@@echo "@@comment subdir=${FULLPKGPATH} cdrom=${PERMIT_PACKAGE_CDROM:L} ftp=${PERMIT_PACKAGE_FTP:L}" >$@@.tmp
	@@sort -u <${WRKPKG}/depends${SUBPACKAGE}>>$@@.tmp
.if defined(NO_SHARED_LIBS)
	@@sed -e '/^!%%SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' \
		-e '/^%%!SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' \
		-e '//d' -e '/^%%SHARED%%$$/d' <${PLIST} \
		${SED_PLIST} >>$@@.tmp && mv -f $@@.tmp $@@
.else
	@@if [ -x /sbin/ldconfig ]; then \
		sed -e '/^!%%SHARED%%$$/d' \
			-e '/^%%!SHARED%%$$/d' \
			-e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' \
			-e '//d' <${PLIST} ${SED_PLIST} \
			| sed -f ${LDCONFIG_SED_SCRIPT} >>$@@.tmp && mv -f $@@.tmp $@@; \
	else \
		sed -e '/^!%%SHARED%%$$/d' \
			-e '/^%%!SHARED%%$$/d' \
			-e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' \
			-e '//d' <${PLIST} \
			${SED_PLIST} >>$@@.tmp && mv -f $@@.tmp $@@; \
	fi
d672 1
a672 8
${WRKPKG}/depends${SUBPACKAGE}:
	@@mkdir -p ${WRKPKG}
	@@>$@@
.if (defined(RUN_DEPENDS) && !empty(RUN_DEPENDS)) || (!defined(NO_SHARED_LIBS) && defined(LIB_DEPENDS) && !empty(LIB_DEPENDS))
	@@${_depfile_fragment}; \
	echo "|${FULLPKGNAME${SUBPACKAGE}}|" >>$${_DEPENDS_FILE}; \
	self=${FULLPKGNAME${SUBPACKAGE}} _depends_result=$@@ ${MAKE} _recurse-solve-package-depends
.endif
d675 1
a675 15
MTREE_FILE+=${PORTSDIR}/infrastructure/db/fake.mtree

${WRKPKG}/DESCR${SUBPACKAGE}: ${DESCR}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
	@@echo "\nMaintainer: ${MNTNER}" >>$@@
.if defined(HOMEPAGE)
	@@fgrep -q '$${HOMEPAGE}' $? || echo "\nWWW: ${HOMEPAGE}" >>$@@
.endif

${WRKPKG}/mtree.spec: ${MTREE_FILE}
	@@${_SED_SUBST} ${MTREE_FILE}>$@@.tmp && mv -f $@@.tmp $@@

PKG_TMPDIR?=	/var/tmp
PKG_CMD?=		/usr/sbin/pkg_create
PKG_DELETE?=	/usr/sbin/pkg_delete
d678 3
a680 1
_PKG_PREREQ= ${WRKPKG}/PLIST${SUBPACKAGE} ${WRKPKG}/DESCR${SUBPACKAGE} ${WRKPKG}/COMMENT${SUBPACKAGE}
d683 3
a685 2
PKG_ARGS= -v -c '${WRKPKG}/COMMENT${SUBPACKAGE}' -d ${WRKPKG}/DESCR${SUBPACKAGE}
PKG_ARGS+=-f ${WRKPKG}/PLIST${SUBPACKAGE} -p ${PREFIX}
d688 1
a688 3
_PKG_PREREQ+=${WRKPKG}/INSTALL${SUBPACKAGE}
${WRKPKG}/INSTALL${SUBPACKAGE}: ${PKGDIR}/INSTALL${SUBPACKAGE}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
d692 1
a692 3
_PKG_PREREQ+=${WRKPKG}/DEINSTALL${SUBPACKAGE}
${WRKPKG}/DEINSTALL${SUBPACKAGE}: ${PKGDIR}/DEINSTALL${SUBPACKAGE}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
d696 1
a696 3
_PKG_PREREQ+=${WRKPKG}/REQ${SUBPACKAGE}
${WRKPKG}/REQ${SUBPACKAGE}: ${PKGDIR}/REQ${SUBPACKAGE}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
d700 1
a700 3
_PKG_PREREQ+=${WRKPKG}/MESSAGE${SUBPACKAGE}
${WRKPKG}/MESSAGE${SUBPACKAGE}: ${MESSAGE}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
d706 3
d710 10
a719 10
CHMOD?=		/bin/chmod
CHOWN?=		/usr/sbin/chown
GUNZIP_CMD?=	/usr/bin/gunzip -f
GZCAT?=		/usr/bin/gzcat
GZIP?=		-9
GZIP_CMD?=	/usr/bin/gzip -nf ${GZIP}
LDCONFIG?=	[ ! -x /sbin/ldconfig ] || /sbin/ldconfig
LDCONFIG_SED_SCRIPT?=${PORTSDIR}/infrastructure/install/ldconfig-new.sed
M4?=		/usr/bin/m4
STRIP?=		/usr/bin/strip
d722 1
a722 1
YACC?=yacc
d725 2
a726 2
SETENV?=	/usr/bin/env -i
SH?=		/bin/sh
a738 1
# ;;; This is referenced in a few Makefiles -- we'd like to get rid of it
d755 1
a755 2
_SITE_SELECTOR=case $$select in

d762 1
a762 1
MASTER_SITES${_I}:= ${MASTER_SITE_OVERRIDE} ${MASTER_SITES${_I}}
d775 1
a775 1
#
d777 1
a777 1
CDROM_SITE=	/cdrom/distfiles/${DIST_SUBDIR}
d782 1
a782 1
_CDROM_OVERRIDE=if ln -s ${CDROM_SITE}/$$f .; then exit 0; fi
d784 1
a784 1
_CDROM_OVERRIDE=if cp -f ${CDROM_SITE}/$$f .; then exit 0; fi
d787 1
a787 1
_CDROM_OVERRIDE=:
a790 1

d793 3
a795 3
_EVERYTHING=${DISTFILES}
_DISTFILES=	${DISTFILES:C/:[0-9]$//}
ALLFILES=	${_DISTFILES}
d798 3
a800 3
_PATCHFILES=${PATCHFILES:C/:[0-9]$//}
_EVERYTHING+=${PATCHFILES}
ALLFILES+=	${_PATCHFILES}
d805 2
a806 2
_EVERYTHING+= ${SUPDISTFILES}
ALLFILES+= ${SUPDISTFILES:C/:[0-9]$//}
d814 1
a814 1
__CKSUMFILES+=${_file}
d817 1
a817 1
ALLFILES:=${__CKSUMFILES}
d821 1
a821 1
__CKSUMFILES:=${__CKSUMFILES:N${_file}}
d827 2
a828 2
_CKSUMFILES=	${__CKSUMFILES:S/^/${DIST_SUBDIR}\//}
_IGNOREFILES=	${IGNOREFILES:S/^/${DIST_SUBDIR}\//}
d830 2
a831 2
_CKSUMFILES=	${__CKSUMFILES}
_IGNOREFILES=	${IGNOREFILES}
d836 1
a836 1
EXTRACT_ONLY?=	${_DISTFILES}
d840 1
a840 1
_USE_ZIP?=	Yes
d843 1
a843 1
_USE_BZIP2?=	Yes
d845 2
a846 2
_USE_ZIP?=	No
_USE_BZIP2?=	No
d850 1
a850 1
_PERL_FIX_SHAR?=perl -ne 'print if $$s || ($$s = m:^\#(\!\s*/bin/sh\s*| This is a shell archive):)'
d877 2
a878 2
MAINTAINER_OS?=OpenBSD
MNTNER=		${RESPONSIBLE} (${MAINTAINER_OS} port contributed by ${MAINTAINER})
d880 1
a880 1
MNTNER=		${RESPONSIBLE}
d882 1
a882 1
RESPONSIBLE?=	The MirPorts mailing list ${_MIRPORTS_ADDRESS}
d885 1
a885 1
ERRORS+=	"Fatal: CATEGORIES is mandatory."
d891 1
a891 1
_CONFIGURE_SCRIPT=${CONFIGURE_SCRIPT}
d894 1
a894 1
_CONFIGURE_SCRIPT=${WRKSRC}/${CONFIGURE_SCRIPT}
d896 1
a896 1
_CONFIGURE_SCRIPT=./${CONFIGURE_SCRIPT}
d909 7
a915 6
SCRIPTS_ENV+= CURDIR=${.CURDIR} DISTDIR=${DISTDIR} \
          PATH=${PORTPATH} WRKDIR=${WRKDIR} WRKDIST=${WRKDIST} \
		  WRKSRC=${WRKSRC} WRKBUILD=${WRKBUILD} \
		  PATCHDIR=${PATCHDIR} SCRIPTDIR=${SCRIPTDIR} FILESDIR=${FILESDIR} \
		  PORTSDIR=${PORTSDIR} DEPENDS="${DEPENDS}" \
		  PREFIX=${PREFIX} LOCALBASE=${LOCALBASE} X11BASE=${X11BASE}
d918 1
a918 1
SCRIPTS_ENV+=	BATCH=yes
d921 3
a923 3
.include <bsd.own.mk>
USE_X11?=No
USE_CXX?=No
d925 1
a925 1
LIB_DEPENDS+= estdc++.5:libstdc++->=3.2.0:lang/egcs/stable,-estdc
d928 1
a928 1
FETCH_MANUALLY?=No
d930 1
a930 1
_ALLFILES_PRESENT=Yes
d933 1
a933 1
_ALLFILES_PRESENT=No
d937 1
a937 1
IS_INTERACTIVE=Yes
d966 1
a966 1
IGNORE+=	"is an interactive port"
d969 1
a969 1
IGNORE+=	"is not an interactive port"
d972 1
a972 1
IGNORE+=	"uses X11, but ${X11BASE} not found"
d974 2
a975 2
.  if ${USE_CXX:L} == "yes" && defined(NO_CXX)
IGNORE+=	"uses C++, but no CXX installed"
d978 1
a978 1
IGNORE+=	"is marked as broken: ${BROKEN}"
d988 1
a988 1
IGNORE+= "is only for ${ONLY_FOR_ARCHS}, not ${MACHINE_ARCH}"
d990 1
a990 1
IGNORE+= "is only for ${ONLY_FOR_ARCHS}, not ${MACHINE_ARCH} \(${ARCH}\)"
d997 1
a997 1
IGNORE+= "is not for ${NOT_FOR_ARCHS}"
d1004 1
a1004 1
IGNORE+= "is only for ${ONLY_FOR_OS}, not ${MACHINE_OS}"
d1011 1
a1011 1
IGNORE+= "is not for ${NOT_FOR_OS}"
d1019 1
a1019 1
IGNORE+=	"depends on ${_i:S/X11%//}, which uses X11"
d1024 1
a1024 1
IGNORE+=	"depends on ${_i:S/CXX%//}, which uses C++"
d1057 1
a1057 1
DEPENDS_TARGET=	reinstall
d1059 1
a1059 1
DEPENDS_TARGET=	install
a1062 32
makesum: fetch-all
.if !defined(NO_CHECKSUM)
	@@rm -f ${CHECKSUM_FILE}
	@@cd ${DISTDIR} && \
		for cipher in ${_CIPHERS}; do \
			$$cipher ${_CKSUMFILES} >> ${CHECKSUM_FILE}; \
	 done
	@@for file in ${_IGNOREFILES}; do \
		echo "MD5 ($$file) = IGNORE" >> ${CHECKSUM_FILE}; \
	done
	@@sort -u -o ${CHECKSUM_FILE} ${CHECKSUM_FILE}
.endif


addsum: fetch-all
.if !defined(NO_CHECKSUM)
	@@touch ${CHECKSUM_FILE}
	@@cd ${DISTDIR} && \
	 	for cipher in ${_CIPHERS}; do \
			$$cipher ${_CKSUMFILES} >> ${CHECKSUM_FILE}; \
	 done
	@@for file in ${_IGNOREFILES}; do \
		echo "MD5 ($$file) = IGNORE" >> ${CHECKSUM_FILE}; \
	done
	@@sort -u -o ${CHECKSUM_FILE} ${CHECKSUM_FILE}
	@@if [ $$(sed -e 's/\=.*$$//' ${CHECKSUM_FILE} | uniq -d | wc -l) -ne 0 ]; then \
		echo "Inconsistent checksum in ${CHECKSUM_FILE}"; \
		exit 1; \
	else \
		${ECHO_MSG} "${CHECKSUM_FILE} updated okay, don't forget to remove cruft"; \
	fi
.endif
a1067 1

d1078 1
a1078 1
_noshared=-noshared
d1083 1
a1083 1
_libresolve_fragment = \
d1094 1
a1094 1
_lib_depends_fragment = \
d1105 225
a1334 1
_FULL_PACKAGE_NAME?=No
a1342 1
_DEP${_DEP}_COOKIES=
a1391 1
_DEP${_DEP}_COOKIES+=${WRKDIR}/.${_DEP}${_i:C,[|:./<=>*],-,g}
a1493 5
# Set to true to try to retrieve older distfiles from ftp.openbsd.org if
# checksums no longer match.

REFETCH?=false

a1561 14
# Normal user-mode targets are PHONY targets, e.g., don't create the
# corresponding file. However, there is nothing phony about the cookie.

BULK?=No
_INSTALL_DEPS=${_INSTALL_COOKIE}
_PACKAGE_DEPS=${_PACKAGE_COOKIES}
.  if defined(ALWAYS_PACKAGE)
_INSTALL_DEPS+=${_PACKAGE_COOKIES}
.  endif
.  if ${BULK:L} == "yes"
_INSTALL_DEPS+=${_BULK_COOKIE}
_PACKAGE_DEPS+=${_BULK_COOKIE}
.  endif

a1590 2
BULK_TARGETS?=

a1732 22

OScompat ?= 3.4
_CONFIGURE_NOOBSD ?= No
_CONFIGURE_DOOBSD ?=
AUTOCONF_FAKEHOST=${MACHINE_ARCH}-ecce-openbsd${OScompat}
.if ${_CONFIGURE_NOOBSD:L} == "no"
_CONFIGURE_DOOBSD+=--host=${AUTOCONF_FAKEHOST} --build=${AUTOCONF_FAKEHOST}
.else
_CONFIGURE_DOOBSD+=
.endif
MODSIMPLE_configure= \
	cd ${WRKBUILD} && ${_SYSTRACE_CMD} ${SETENV} REALOS=MirOS \
		CC="${CC}" ac_cv_path_CC="${CC}" CFLAGS="${CFLAGS}" \
		CXX="${CXX}" ac_cv_path_CXX="${CXX}" CXXFLAGS="${CXXFLAGS}" \
		INSTALL="/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}" \
		ac_given_INSTALL="/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}" \
		INSTALL_PROGRAM="${INSTALL_PROGRAM}" YACC="${YACC}" \
		INSTALL_MAN="${INSTALL_MAN}" INSTALL_DATA="${INSTALL_DATA}" \
		INSTALL_SCRIPT="${INSTALL_SCRIPT}" LD="${LD}" \
		LDFLAGS="${LDFLAGS}" ${CONFIGURE_ENV} ${SH} \
		${_CONFIGURE_SCRIPT} ${CONFIGURE_ARGS} ${_CONFIGURE_DOOBSD}

a1760 2
VMEM_WARNING?=	No

a1815 4
_FAKE_SETUP=TRUEPREFIX=${PREFIX} PREFIX=${WRKINST}${PREFIX} ${DESTDIRNAME}=${WRKINST}

PROTECT_MOUNT_POINTS?=

a1968 2
_CLEANDEPENDS?=Yes

a2033 2
RECURSIVE_FETCH_LIST?=	Yes

a2040 4
_tmp:=
.  for _v in ${SUBST_VARS}
_tmp += ${_v}='${${_v}}'
.  endfor
d2051 2
a2052 1
	perl ${PORTSDIR}/infrastructure/install/make-plist ${PKGDIR} ${_tmp}
a2064 5
################################################################
# The special package-building targets
# You probably won't need to touch these
################################################################

a2065 13
.if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
_ALLFILES=${ALLFILES:S/^/${DIST_SUBDIR}\//}
.else
_ALLFILES=${ALLFILES}
.endif

_FMN=${PKGPATH}/${FULLPKGNAME}
.if defined(MULTI_PACKAGES)
.  for _S in ${MULTI_PACKAGES}
_FMN+= ${PKGPATH}/${FULLPKGNAME${_S}}
.  endfor
.endif

d2087 12
d2102 1
a2102 1
.    if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
d2104 1
a2104 1
.    endif
d2109 1
a2109 1
.    if ${FETCH_MANUALLY:L} != "no"
d2111 2
a2112 2
.    endif
.    if !defined(NO_CHECKSUM) && !empty(_CKSUMFILES:M${_F})
d2133 1
a2133 1
.    endif
d2135 1
a2135 33
.  endfor
.endif
	@@echo


# Internal variables, used by dependencies targets
# Only keep pkg:dir spec
.if defined(LIB_DEPENDS)
_ALWAYS_DEP2 = ${LIB_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_ALWAYS_DEP= ${_ALWAYS_DEP2:C/[^:]*://}
.else
_ALWAYS_DEP2=
_ALWAYS_DEP=
.endif

.if defined(RUN_DEPENDS)
_RUN_DEP2 = ${RUN_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_RUN_DEP = ${_RUN_DEP2:C/[^:]*://}
.else
_RUN_DEP2=
_RUN_DEP=
.endif


.if defined(BUILD_DEPENDS)
_BUILD_DEP2 = ${BUILD_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_BUILD_DEP = ${_BUILD_DEP2:C/[^:]*://}
.else
_BUILD_DEP2=
_BUILD_DEP=
.endif

_LIB_DEP2= ${LIB_DEPENDS}
d2146 1
a2146 1
_EXTRA_DESCRIBE+="(broken)"
d2149 1
a2149 1
_EXTRA_DESCRIBE+="(uses C++)"
d2152 16
a2167 1
_EXTRA_DESCRIBE+="(uses X11)"
a2240 2
README_NAME?=	${TEMPLATES}/README.port

d2381 1
a2381 1
		if fgrep -q "|$$dir|" $${_DEPENDS_FILE}; then :; else \
d2392 1
a2392 1
		if fgrep -q "|$$dir|" $${_DEPENDS_FILE}; then :; else \
d2628 1
a2628 1
	_build-dir-depends _delete-package-links _fetch-makefile \
@


1.49
log
@extend (c) to 2004
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.48 2003/12/31 15:54:28 tg Exp $
d16 1
a16 1
# fy, publically perform, give away, merge or sublicense it provided
d21 1
a21 1
# ties whatsoever to the maximum extend permitted by applicable law;
d120 1
a120 1
# Get the architecture
d122 1
d124 1
a124 1
# Get the operating system type and version
d230 1
a230 1
PREFIX?=		${LOCALBASE}
d233 3
a235 1
DESTDIR?=		${WRKINST}
a1080 5
.  if defined(COMES_WITH)
.    if (${OPSYS_VER} >= ${COMES_WITH})
IGNORE+= "-- ${FULLPKGNAME${SUBPACKAGE}:C/-[0-9].*//g} comes with ${OPSYS} as of release ${COMES_WITH}"
.    endif
.  endif
a2017 1
.if !defined(COMES_WITH)
d2019 1
a2019 1
.  if ${PERMIT_DISTFILES_FTP:L} == "yes"
d2021 2
a2022 2
.  endif
.  if ${PERMIT_DISTFILES_CDROM:L} == "yes"
d2024 1
a2024 1
.  endif
d2028 1
a2028 1
.  if ${RECURSIVE_FETCH_LIST:L} == "yes"
d2030 1
a2030 1
.  else
d2032 1
a2032 1
.  endif
a2033 1
.endif
@


1.48
log
@use += so user can possibly override
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.47 2003/12/31 15:53:09 tg Exp $
d6 1
a6 1
# Copyright (c) 2003 by The MirPorts Framework Team, MirOS Project
@


1.47
log
@darn, typos at early morning
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.46 2003/12/31 15:51:14 tg Exp $
d1636 1
d1639 1
a1639 1
_CONFIGURE_DOOBSD=--host=${AUTOCONF_FAKEHOST} --build=${AUTOCONF_FAKEHOST}
d1641 1
a1641 1
_CONFIGURE_DOOBSD=
@


1.46
log
@ocaml doesn't like GNU autoconf alike host types, work around
if ports break, just add _CONFIGURE_NOOBSD=Yes to Makefile
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.45 2003/12/28 22:08:56 tg Exp $
d1641 1
a1641 1
,endif
@


1.45
log
@autoconf versions differ
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.44 2003/12/28 20:45:05 tg Exp $
d1635 1
d1637 5
d1652 1
a1652 2
		${_CONFIGURE_SCRIPT} ${CONFIGURE_ARGS} \
		--host=${AUTOCONF_FAKEHOST} --build=${AUTOCONF_FAKEHOST}
@


1.44
log
@more compatible to #7
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.43 2003/12/28 01:01:20 tg Exp $
d1635 1
d1647 1
a1647 1
		--build=${MACHINE_ARCH}-ecce-openbsd${OScompat}
@


1.43
log
@employ fix for the uname change problem
which will fix 95% of the 90% broken ports
XXX all ports using COMES_WITH must use mirbsd
XXX	releases (1, 2, 3...) not openbsd ones
XXX	(3.0, 3.1, ...) now!
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.42 2003/12/03 19:44:23 tg Exp $
d1634 1
@


1.42
log
@Perl 5.8.2

MirPorts tracks MirOS current from now on, apparently.
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.41 2003/12/03 19:29:33 tg Exp $
d124 1
a124 1
OPSYS=	OpenBSD
d1635 1
a1635 1
	cd ${WRKBUILD} && ${_SYSTRACE_CMD} ${SETENV} \
d1640 6
a1645 4
		INSTALL_PROGRAM="${INSTALL_PROGRAM}" INSTALL_MAN="${INSTALL_MAN}" \
		INSTALL_SCRIPT="${INSTALL_SCRIPT}" INSTALL_DATA="${INSTALL_DATA}" \
		YACC="${YACC}" LD="${LD}" LDFLAGS="${LDFLAGS}" \
		${CONFIGURE_ENV} ${SH} ${_CONFIGURE_SCRIPT} ${CONFIGURE_ARGS}
@


1.41
log
@Merge import of OpenBSD ports tree into MirPorts,
except for xawtv and gnome
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.40 2003/11/17 16:19:00 tg Exp $
d19 1
@


1.40
log
@well, it's a disaster, but still :)
you "just" need to convert _all_ existing ports from
	::devel/libtool
to	::devel/libtool/v1.3
except for ion, which needs v1.4+
oh, and fix all these ports
@
text
@d1 2
a2 2
# $MirBSD: bsd.port.mk,v 1.39 2003/11/16 16:11:45 tg Exp $
# $OpenBSD: bsd.port.mk,v 1.588 2003/09/28 10:57:01 espie Exp $
a1771 4
	@@if ${SUDO} find ${WRKINST} -type l -ls|fgrep -- '-> ${WRKINST}'; then \
		echo >&2 "*** bad links in ${WRKINST}"; \
		exit 1; \
	fi
@


1.39
log
@Let all packages which have USE_CXX=Yes set, and which are built using
the eg++ or ec++ compiler, depend on libestdc++ (ok bsiegert@@)

Software which uses egcs but not C++, or doesn't depend on C++ for execution
(examples: gnome (former), mysql (latter)), need their USE flag changed to:
| .if ${MKC_PGCC:L} == "yes"
| MKC_EGCC=yes
| .endif
or something like that, I suppose.
(bsd.own.mk MUST NOT be included before that)
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.38 2003/11/11 19:49:13 tg Exp $
d262 1
a262 1
BUILD_DEPENDS+=		::devel/libtool
@


1.38
log
@nuke all .elif
rationale: this way, you get shown ALL, not just one ${IGNORE} at once
wasn't in openbsd because they're too stupid(?) to display more
than one ${IGNORE}...
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.37 2003/11/11 19:47:37 tg Exp $
d983 1
d986 3
@


1.37
log
@*d'oh*

/me grabs for the definition of ".elif" again
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.36 2003/11/11 19:16:57 tg Exp $
d1019 2
a1020 1
.  elif (!defined(REGRESS_IS_INTERACTIVE) && defined(INTERACTIVE))
d1025 2
a1026 1
.  elif (!defined(IS_INTERACTIVE) && defined(INTERACTIVE))
d1028 2
a1029 1
.  elif ${USE_X11:L} == "yes" && !exists(${X11BASE})
d1031 2
a1032 1
.  elif ${USE_CXX:L} == "yes" && defined(NO_CXX)
d1034 2
a1035 1
.  elif defined(BROKEN)
d1037 2
a1038 1
.  elif defined(ONLY_FOR_ARCHS)
d1051 2
a1052 1
.  elif defined(NOT_FOR_ARCHS)
d1058 2
a1059 1
.  elif defined(ONLY_FOR_OS)
d1065 2
a1066 1
.  elif defined(NOT_FOR_OS)
d1072 2
a1073 1
.  elif defined(COMES_WITH)
d1077 2
a1078 1
.  elif defined(BATCH) && !defined(BATCH_OVERRIDE)
@


1.36
log
@this should fix the recursion bug wbx@@ discovered for audio/libao
XXX only direct dependencies on myself are checked; not the
XXX (uncommon) situation "foo(SUBPACKAGE:baz) depends on bar; bar depends
XXX on foo(SUBPACKAGE:main)"
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.35 2003/11/10 16:49:04 tg Exp $
a1023 12
.  elif defined(BATCH) && !defined(BATCH_OVERRIDE)
USES!=	make _print-uses BATCH_OVERRIDE=1 | sort -u
.    if !exists(${X11BASE})
.      for _i in ${USES:MX11%*}
IGNORE+=	"depends on ${_i:S/X11%//}, which uses X11"
.      endfor
.    endif
.    if defined(NO_CXX)
.      for _i in ${USES:MCXX%*}
IGNORE+=	"depends on ${_i:S/CXX%//}, which uses C++"
.      endfor
.    endif
d1063 1
a1063 2
.  endif
.  if !defined(IGNORE) && defined(COMES_WITH)
d1067 12
a1079 1

@


1.35
log
@wbx@@ you definitively owe me something.
I had the idea at work, polished it in the train back,
and it took me quite two (2) hours to get it working.

* while here, remove whitespace at end of line
* while here, change IGNORE= to IGNORE+=
* while here, print _all_ ignores on separate lines
  (taken from bsd.sys.mk)
* have ports being IGNOREd _iff_
  a) BATCH=Yes
  b) USE_CXX=Yes AND no C++ compiler installed (as usual)
  OR USE_X11=Yes AND no X-Window installed (as usual)
  OR it depends on another port, which
     - is NOT already installed
       XXX version number is checked. bad (for users, not for QA).
     - EITHER depends on C++ which is not installed
       OR depends on X-Window which is not installed
       OR both of the above
* yes, this is inherited (e.g. kde/base3 checks not only kde/libs3,
  but also its dependencies, as well as the dependencies of those).
* sync the licence between these two files

XXX please do test if nothing breaks

Yes, it's known that this increases the build time, because this
check has to be done every time (and it's recursive).
That's why it's only used if BATCH=Yes (if BATCH is not defined,
nothing should have changed at all, lest alone the allowal for
multiple IGNORE lines).

Sample shot:

tg@@odem:/usr/ports/x11/gnome/applets2 $ make BATCH=YES X11BASE=/nonexistent
===>  gnome-applets2-2.4.1 depends on gail-1.4.0, which uses X11.
===>  gnome-applets2-2.4.1 depends on gconf2-2.4.0.1, which uses X11.
===>  gnome-applets2-2.4.1 depends on gnome-panel-2.4.0, which uses X11.
===>  gnome-applets2-2.4.1 depends on gnome-vfs2-2.4.0, which uses X11.
===>  gnome-applets2-2.4.1 depends on gtk+2-2.2.4, which uses X11.
===>  gnome-applets2-2.4.1 depends on libglade2-2.0.1, which uses X11.
===>  gnome-applets2-2.4.1 depends on libgnomecanvas-2.4.0, which uses X11.
===>  gnome-applets2-2.4.1 depends on libwnck-2.4.0.1, which uses X11.
===>  gnome-applets2-2.4.1 depends on pango-1.2.5, which uses X11.
===>  gnome-applets2-2.4.1 depends on ORBit2-2.8.1, which uses C++.
===>  gnome-applets2-2.4.1 depends on atk-1.4.0, which uses C++.
===>  gnome-applets2-2.4.1 depends on gail-1.4.0, which uses C++.
===>  gnome-applets2-2.4.1 depends on gconf2-2.4.0.1, which uses C++.
===>  gnome-applets2-2.4.1 depends on gnome-desktop-2.4.0, which uses C++.
===>  gnome-applets2-2.4.1 depends on gnome-mime-data-2.4.0, which uses C++.
===>  gnome-applets2-2.4.1 depends on gnome-panel-2.4.0, which uses C++.
===>  gnome-applets2-2.4.1 depends on gnome-vfs2-2.4.0, which uses C++.
===>  gnome-applets2-2.4.1 depends on gtk+2-2.2.4, which uses C++.
===>  gnome-applets2-2.4.1 depends on libIDL-0.8.2, which uses C++.
===>  gnome-applets2-2.4.1 depends on libbonobo-2.4.0, which uses C++.
===>  gnome-applets2-2.4.1 depends on libglade2-2.0.1, which uses C++.
===>  gnome-applets2-2.4.1 depends on libgnome-2.4.0, which uses C++.
===>  gnome-applets2-2.4.1 depends on libgnomecanvas-2.4.0, which uses C++.
===>  gnome-applets2-2.4.1 depends on libgnomeui-2.4.0.1, which uses C++.
===>  gnome-applets2-2.4.1 depends on libgtop2-2.0.5, which uses C++.
===>  gnome-applets2-2.4.1 depends on libwnck-2.4.0.1, which uses C++.
===>  gnome-applets2-2.4.1 depends on pango-1.2.5, which uses C++.
===>  gnome-applets2-2.4.1 depends on startup-notification-0.5, which uses C++.
tg@@odem:/usr/ports/x11/gnome/applets2 $ make BATCH=YES
===>  gnome-applets2-2.4.1 depends on ORBit2-2.8.1, which uses C++.
===>  gnome-applets2-2.4.1 depends on atk-1.4.0, which uses C++.
===>  gnome-applets2-2.4.1 depends on gail-1.4.0, which uses C++.
===>  gnome-applets2-2.4.1 depends on gconf2-2.4.0.1, which uses C++.
===>  gnome-applets2-2.4.1 depends on gnome-desktop-2.4.0, which uses C++.
===>  gnome-applets2-2.4.1 depends on gnome-mime-data-2.4.0, which uses C++.
===>  gnome-applets2-2.4.1 depends on gnome-panel-2.4.0, which uses C++.
===>  gnome-applets2-2.4.1 depends on gnome-vfs2-2.4.0, which uses C++.
===>  gnome-applets2-2.4.1 depends on gtk+2-2.2.4, which uses C++.
===>  gnome-applets2-2.4.1 depends on libIDL-0.8.2, which uses C++.
===>  gnome-applets2-2.4.1 depends on libbonobo-2.4.0, which uses C++.
===>  gnome-applets2-2.4.1 depends on libglade2-2.0.1, which uses C++.
===>  gnome-applets2-2.4.1 depends on libgnome-2.4.0, which uses C++.
===>  gnome-applets2-2.4.1 depends on libgnomecanvas-2.4.0, which uses C++.
===>  gnome-applets2-2.4.1 depends on libgnomeui-2.4.0.1, which uses C++.
===>  gnome-applets2-2.4.1 depends on libgtop2-2.0.5, which uses C++.
===>  gnome-applets2-2.4.1 depends on libwnck-2.4.0.1, which uses C++.
===>  gnome-applets2-2.4.1 depends on pango-1.2.5, which uses C++.
===>  gnome-applets2-2.4.1 depends on startup-notification-0.5, which uses C++.
tg@@odem:/usr/ports/x11/gnome/applets2 $ make BATCH=YES MKC_EGCC=Yes
===>  gnome-applets2-2.4.1 depends on: pkgconfig->=0.12.0p1 - found
===>  gnome-applets2-2.4.1 depends on: scrollkeeper->=0.3.12p1 - not found
===>  Verifying install for scrollkeeper->=0.3.12p1 in textproc/scrollkeeper
^Ctg@@odem:/usr/ports/x11/gnome/applets2 $
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.34 2003/11/06 21:26:07 tg Exp $
d1087 2
a1088 2
	    ${BUILD_DEPENDS:C/^[^:]*:[^:]*://} \
	    ${LIB_DEPENDS:C/^[^:]*:[^:]*://} \
d1090 2
@


1.34
log
@fix the most annoying bugs...
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.33 2003/11/06 13:33:09 wbx Exp $
d25 2
a26 1
# This is the MirPorts master system Makefile.
d137 1
a137 1
# need to go through an extra var because clean is set in stone, 
d1023 13
a1035 1
IGNORE=	"is an interactive port"
d1037 1
a1037 1
IGNORE=	"is not an interactive port"
d1039 1
a1039 1
IGNORE=	"uses X11, but ${X11BASE} not found"
d1041 1
a1041 1
IGNORE=	"uses C++, but no CXX installed"
d1043 1
a1043 1
IGNORE=	"is marked as broken: ${BROKEN}"
d1052 1
a1052 1
IGNORE= "is only for ${ONLY_FOR_ARCHS}, not ${MACHINE_ARCH}"
d1054 1
a1054 1
IGNORE= "is only for ${ONLY_FOR_ARCHS}, not ${MACHINE_ARCH} \(${ARCH}\)"
d1060 1
a1060 1
IGNORE= "is not for ${NOT_FOR_ARCHS}"
d1066 1
a1066 1
IGNORE= "is only for ${ONLY_FOR_OS}, not ${MACHINE_OS}"
d1072 1
a1072 1
IGNORE= "is not for ${NOT_FOR_OS}"
d1078 1
a1078 1
IGNORE= "-- ${FULLPKGNAME${SUBPACKAGE}:C/-[0-9].*//g} comes with ${OPSYS} as of release ${COMES_WITH}"
d1085 22
d1299 3
a1301 1
	@@${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} ${IGNORE}."
d2203 1
a2203 1
.if defined(MULTI_PACKAGES) 
d2570 1
a2570 1
	_recurse-all-dir-depends _recurse-lib-depends-check \ 
d2596 1
a2596 1
	readmes rebuild \
@


1.33
log
@changed my mailadress to miros@@thinknow.de
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.32 2003/11/01 01:29:11 tg Exp $
d428 1
a428 1
CFLAGS+=		${COPTS}
d431 1
a431 1
CXXFLAGS+=		${CXXOPTS}
@


1.32
log
@o unlock the ports framework again
o sync (2493 ports)
o small changes in the framework base for allowing
  a more flexible use for the MAINTAINER variable
o nuke 60 char limit on pkgname
  (make up to 72, and fix an off-by-one)
o fix a few leftover hung lines from removal ed script

[ read on for the full story ]

o the following lines need checks if they can either
  be uncommented or nuked altogether:

	Makefile:	#SUBDIR += german
	Makefile:	#SUBDIR += vietnamese
	astro/Makefile:	#    SUBDIR += ephem
	astro/Makefile:	#    SUBDIR += stars
	audio/Makefile:	#    SUBDIR += cam
	audio/Makefile:	#    SUBDIR += cddbd
	audio/Makefile:	#    SUBDIR += cdplay
	audio/Makefile:	#    SUBDIR += gmod
	audio/Makefile:	#    SUBDIR += maplay
	audio/Makefile:	#    SUBDIR += mikmod
	audio/Makefile:	#    SUBDIR += mxv
	audio/Makefile:	#    SUBDIR += nas
	audio/Makefile:	#    SUBDIR += playmidi
	audio/Makefile:	#    SUBDIR += radio
	audio/Makefile:	#    SUBDIR += rosegarden
	audio/Makefile:	#    SUBDIR += s3mod
	audio/Makefile:	#    SUBDIR += splay
	chinese/Makefile:	#    SUBDIR += Wnn
	chinese/Makefile:	#    SUBDIR += big5con
	chinese/Makefile:	#    SUBDIR += big5fonts
	chinese/Makefile:	#    SUBDIR += celvis
	chinese/Makefile:	#    SUBDIR += cnsfonts
	chinese/Makefile:	#    SUBDIR += cxterm
	chinese/Makefile:	#    SUBDIR += gb2ps
	chinese/Makefile:	#    SUBDIR += gbfonts
	chinese/Makefile:	#    SUBDIR += gbscript
	chinese/Makefile:	#    SUBDIR += hztty
	chinese/Makefile:	#    SUBDIR += mule-wnn4
	chinese/Makefile:	#    SUBDIR += nvi-big5
	chinese/Makefile:	#    SUBDIR += nvi-euc-cn
	chinese/Makefile:	#    SUBDIR += nvi-euc-tw
	chinese/Makefile:	#    SUBDIR += samba
	chinese/Makefile:	#    SUBDIR += ted
	comms/Makefile:	#    SUBDIR += ecu
	comms/Makefile:	#    SUBDIR += snooper
	converters/Makefile:	#   SUBDIR += uudeview
	converters/Makefile:	#   SUBDIR += uudx
	converters/Makefile:	#   SUBDIR += uulib
	converters/Makefile:	#   SUBDIR += xdeview
	devel/binutils/Makefile:	#     SUBDIR += devel
	editors/Makefile:	#    SUBDIR += asedit
	editors/Makefile:	#    SUBDIR += bpatch
	editors/Makefile:	#    SUBDIR += e93
	editors/Makefile:	#    SUBDIR += mule
	editors/Makefile:	#    SUBDIR += mule-common
	editors/Makefile:	#    SUBDIR += nvi
	editors/Makefile:	#    SUBDIR += staroffice
	editors/Makefile:	#    SUBDIR += thoteditor
	editors/Makefile:	#    SUBDIR += uzap
	editors/Makefile:	#    SUBDIR += vile
	editors/Makefile:	#    SUBDIR += xcoral
	editors/Makefile:	#    SUBDIR += xed
	editors/Makefile:	#    SUBDIR += xemacs
	editors/Makefile:	#    SUBDIR += xvile
	emulators/wine/Makefile:	# SUBDIR +=	rewind
	games/Makefile:	#    SUBDIR += acm
	games/Makefile:	#    SUBDIR += block
	games/Makefile:	#    SUBDIR += blue
	games/Makefile:	#    SUBDIR += bs
	games/Makefile:	#    SUBDIR += cosmo
	games/Makefile:	#    SUBDIR += crossfire
	games/Makefile:	#    SUBDIR += dontspace
	games/Makefile:	#    SUBDIR += doom
	games/Makefile:	#    SUBDIR += empire
	games/Makefile:	#    SUBDIR += flying
	games/Makefile:	#    SUBDIR += galaxis
	games/Makefile:	#    SUBDIR += golddig
	games/Makefile:	#    SUBDIR += imaze
	games/Makefile:	#    SUBDIR += jetpack
	games/Makefile:	#    SUBDIR += kdegames
	games/Makefile:	#    SUBDIR += klondike
	games/Makefile:	#    SUBDIR += oneko
	games/Makefile:	#    SUBDIR += oonsoo
	games/Makefile:	#    SUBDIR += qcc
	games/Makefile:	#    SUBDIR += quakeserver
	games/Makefile:	#    SUBDIR += sokoban
	games/Makefile:	#    SUBDIR += tksol
	games/Makefile:	#    SUBDIR += tvp
	games/Makefile:	#    SUBDIR += uqmcontent
	games/Makefile:	#    SUBDIR += xblackjack
	games/Makefile:	#    SUBDIR += xemeraldia
	games/Makefile:	#    SUBDIR += xeyesplus
	games/Makefile:	#    SUBDIR += xfrisk
	games/Makefile:	#    SUBDIR += xgalaga
	games/Makefile:	#    SUBDIR += xgammon
	games/Makefile:	#    SUBDIR += xmille
	games/Makefile:	#    SUBDIR += xpipeman
	games/Makefile:	#    SUBDIR += xpuyo
	games/Makefile:	#    SUBDIR += xpuzzletama
	games/Makefile:	#    SUBDIR += xrisk
	games/Makefile:	#    SUBDIR += xrobots
	games/Makefile:	#    SUBDIR += xrubik
	games/Makefile:	#    SUBDIR += xshisen
	games/Makefile:	#    SUBDIR += xshogi
	games/Makefile:	#    SUBDIR += xsokoban
	games/Makefile:	#    SUBDIR += xspringies
	games/Makefile:	#    SUBDIR += xtic
	games/Makefile:	#    SUBDIR += xtriangles
	games/Makefile:	#    SUBDIR += yahtzee
	games/Makefile:	#    SUBDIR += yamsweeper
	games/Makefile:	#    SUBDIR += ztrack
	games/xblast/Makefile:	# MASTER_SITE_SUBDIR= games/multiplayer
	graphics/Makefile:	#    SUBDIR += aero
	graphics/Makefile:	#    SUBDIR += camediaplay
	graphics/Makefile:	#    SUBDIR += dc3play
	graphics/Makefile:	#    SUBDIR += dore
	graphics/Makefile:	#    SUBDIR += geomview
	graphics/Makefile:	#    SUBDIR += gfont
	graphics/Makefile:	#    SUBDIR += gifmerge
	graphics/Makefile:	#    SUBDIR += giftool
	graphics/Makefile:	#    SUBDIR += hdf
	graphics/Makefile:	#    SUBDIR += hobbes-icons-xpm
	graphics/Makefile:	#    SUBDIR += hpscan
	graphics/Makefile:	#    SUBDIR += mpeg2codec
	graphics/Makefile:	#    SUBDIR += mpeg2play
	graphics/Makefile:	#    SUBDIR += mpeg_stat
	graphics/Makefile:	#    SUBDIR += mpegedit
	graphics/Makefile:	#    SUBDIR += pgperl
	graphics/Makefile:	#    SUBDIR += pgplot
	graphics/Makefile:	#    SUBDIR += photopc
	graphics/Makefile:	#    SUBDIR += pixmap
	graphics/Makefile:	#    SUBDIR += plotmtv
	graphics/Makefile:	#    SUBDIR += qvplay
	graphics/Makefile:	#    SUBDIR += sced
	graphics/Makefile:	#    SUBDIR += spigot
	graphics/Makefile:	#    SUBDIR += splitmpg
	graphics/Makefile:	#    SUBDIR += txtmerge
	graphics/Makefile:	#    SUBDIR += urt
	graphics/Makefile:	#    SUBDIR += vcg
	graphics/Makefile:	#    SUBDIR += whirlgif
	graphics/Makefile:	#    SUBDIR += xaos
	graphics/Makefile:	#    SUBDIR += xdl
	graphics/Makefile:	#    SUBDIR += xfractint
	graphics/Makefile:	#    SUBDIR += xgrasp
	graphics/Makefile:	#    SUBDIR += xli
	graphics/Makefile:	#    SUBDIR += xmandel
	graphics/Makefile:	#    SUBDIR += xmfract
	graphics/Makefile:	#    SUBDIR += xmorph
	graphics/Makefile:	#    SUBDIR += xmountains
	graphics/gimp/Makefile:	#     SUBDIR+= snapshot
	lang/Makefile:	#    SUBDIR += Sather
	lang/Makefile:	#    SUBDIR += atlast
	lang/Makefile:	#    SUBDIR += bwbasic
	lang/Makefile:	#    SUBDIR += cim
	lang/Makefile:	#    SUBDIR += cmucl
	lang/Makefile:	#    SUBDIR += eiffel
	lang/Makefile:	#    SUBDIR += elk
	lang/Makefile:	#    SUBDIR += eperl
	lang/Makefile:	#    SUBDIR += forth
	lang/Makefile:	#    SUBDIR += g77
	lang/Makefile:	#    SUBDIR += gcl
	lang/Makefile:	#    SUBDIR += gnat
	lang/Makefile:	#    SUBDIR += idl4
	lang/Makefile:	#    SUBDIR += itcl
	lang/Makefile:	#    SUBDIR += javac_netscape
	lang/Makefile:	#    SUBDIR += jdk
	lang/Makefile:	#    SUBDIR += lcc
	lang/Makefile:	#    SUBDIR += logo
	lang/Makefile:	#    SUBDIR += mit-scheme
	lang/Makefile:	#    SUBDIR += mixal
	lang/Makefile:	#    SUBDIR += mocka
	lang/Makefile:	#    SUBDIR += modula-3
	lang/Makefile:	#    SUBDIR += modula-3-lib
	lang/Makefile:	#    SUBDIR += modula-3-socks
	lang/Makefile:	#    SUBDIR += moscow_ml
	lang/Makefile:	#    SUBDIR += objc
	lang/Makefile:	#    SUBDIR += p2c
	lang/Makefile:	#    SUBDIR += p5-Tcl
	lang/Makefile:	#    SUBDIR += p5-ePerl
	lang/Makefile:	#    SUBDIR += pbasic
	lang/Makefile:	#    SUBDIR += perl5
	lang/Makefile:	#    SUBDIR += pgcc
	lang/Makefile:	#    SUBDIR += pgcc-current
	lang/Makefile:	#    SUBDIR += rexx-imc
	lang/Makefile:	#    SUBDIR += scheme48
	lang/Makefile:	#    SUBDIR += schemetoc
	lang/Makefile:	#    SUBDIR += smalltalk
	lang/Makefile:	#    SUBDIR += sr
	lang/Makefile:	#    SUBDIR += swi-pl
	lang/Makefile:	#    SUBDIR += tclX75
	lang/Makefile:	#    SUBDIR += tclplugin
	lang/Makefile:	#    SUBDIR += xpl
	lang/Makefile:	#    SUBDIR += yorick
	lang/icon/interp/Makefile:	#DIST_SUBDIR=	icon/${VERSION}
	lang/icon/lib/Makefile:	#DIST_SUBDIR=icon/${VERSION}
	lang/smlnj/Makefile:	#	cd ${WRKDIR} && ln -sf ${DISTDIR}/${DIST_SUBDIR}/*  .
	mail/Makefile:	#    SUBDIR += xfmail,threads
	mail/Makefile:	#    SUBDIR += xfmail,threads,esd
	math/Makefile:	#    SUBDIR += Scilab
	math/Makefile:	#    SUBDIR += apc
	math/Makefile:	#    SUBDIR += blas
	math/Makefile:	#    SUBDIR += calctool
	math/Makefile:	#    SUBDIR += eispack
	math/Makefile:	#    SUBDIR += eval
	math/Makefile:	#    SUBDIR += femlab
	math/Makefile:	#    SUBDIR += fftpack
	math/Makefile:	#    SUBDIR += freefem
	math/Makefile:	#    SUBDIR += fudgit
	math/Makefile:	#    SUBDIR += lapack
	math/Makefile:	#    SUBDIR += libranlib
	math/Makefile:	#    SUBDIR += linpack
	math/Makefile:	#    SUBDIR += metis
	math/Makefile:	#    SUBDIR += numpy
	math/Makefile:	#    SUBDIR += oleo
	math/Makefile:	#    SUBDIR += p5-MatrixReal
	math/Makefile:	#    SUBDIR += pari
	math/Makefile:	#    SUBDIR += plplot
	math/Makefile:	#    SUBDIR += r
	math/Makefile:	#    SUBDIR += siag
	math/Makefile:	#    SUBDIR += simpack
	math/Makefile:	#    SUBDIR += ss
	math/Makefile:	#    SUBDIR += umatrix
	math/Makefile:	#    SUBDIR += xgfe
	math/Makefile:	#    SUBDIR += xgraph
	math/Makefile:	#    SUBDIR += xldlas
	math/Makefile:	#    SUBDIR += xlispstat
	math/Makefile:	#    SUBDIR += xmgr
	math/Makefile:	#    SUBDIR += xplot
	misc/Makefile:	#    SUBDIR += cal
	misc/Makefile:	#    SUBDIR += chord
	misc/Makefile:	#    SUBDIR += colorls
	misc/Makefile:	#    SUBDIR += ctk
	misc/Makefile:	#    SUBDIR += dejagnu
	misc/Makefile:	#    SUBDIR += dotfile
	misc/Makefile:	#    SUBDIR += ecc
	misc/Makefile:	#    SUBDIR += estic
	misc/Makefile:	#    SUBDIR += fd
	misc/Makefile:	#    SUBDIR += fep
	misc/Makefile:	#    SUBDIR += git
	misc/Makefile:	#    SUBDIR += ical
	misc/Makefile:	#    SUBDIR += kdeutils
	misc/Makefile:	#    SUBDIR += kp
	misc/Makefile:	#    SUBDIR += less
	misc/Makefile:	#    SUBDIR += lile
	misc/Makefile:	#    SUBDIR += logsurfer
	misc/Makefile:	#    SUBDIR += nwrite
	misc/Makefile:	#    SUBDIR += p5-Array-PrintCols
	misc/Makefile:	#    SUBDIR += p5-Business-CreditCard
	misc/Makefile:	#    SUBDIR += p5-Search
	misc/Makefile:	#    SUBDIR += team
	misc/Makefile:	#    SUBDIR += unclutter
	misc/Makefile:	#    SUBDIR += xcalendar
	misc/Makefile:	#    SUBDIR += xinvest
	misc/Makefile:	#    SUBDIR += xmaddressbook
	misc/Makefile:	#    SUBDIR += xopps
	misc/Makefile:	#    SUBDIR += xpns
	misc/Makefile:	#    SUBDIR += zorro
	net/Makefile:	#    SUBDIR += cvsup-mirror
	net/Makefile:	#    SUBDIR += ipband
	net/samba/Makefile:	#     SUBDIR+= snapshot
	news/Makefile:	#    SUBDIR += diablo
	news/Makefile:	#    SUBDIR += dnews
	news/Makefile:	#    SUBDIR += ifmail
	news/Makefile:	#    SUBDIR += inn
	news/Makefile:	#    SUBDIR += knews
	news/Makefile:	#    SUBDIR += nn
	news/Makefile:	#    SUBDIR += nntp
	news/Makefile:	#    SUBDIR += nntpbtr
	news/Makefile:	#    SUBDIR += nntpcache
	news/Makefile:	#    SUBDIR += rkive
	news/Makefile:	#    SUBDIR += slnr
	news/Makefile:	#    SUBDIR += slurp
	news/Makefile:	#    SUBDIR += suck
	news/Makefile:	#    SUBDIR += xvnews
	plan9/Makefile:	#    SUBDIR += 9term
	plan9/Makefile:	#    SUBDIR += Xg
	print/Makefile:	#   SUBDIR += a2ps43
	print/Makefile:	#   SUBDIR += asprint
	print/Makefile:	#   SUBDIR += bibcard
	print/Makefile:	#   SUBDIR += c2ps
	print/Makefile:	#   SUBDIR += dvi2xx
	print/Makefile:	#   SUBDIR += dvips
	print/Makefile:	#   SUBDIR += dvips2ascii
	print/Makefile:	#   SUBDIR += dviselect
	print/Makefile:	#   SUBDIR += ghostscript3
	print/Makefile:	#   SUBDIR += ghostscript4
	print/Makefile:	#   SUBDIR += ghostscript5
	print/Makefile:	#   SUBDIR += html2latex
	print/Makefile:	#   SUBDIR += latex
	print/Makefile:	#   SUBDIR += lout
	print/Makefile:	#   SUBDIR += lprps
	print/Makefile:	#   SUBDIR += makeindex
	print/Makefile:	#   SUBDIR += mp
	print/Makefile:	#   SUBDIR += musixtex
	print/Makefile:	#   SUBDIR += rtf2latex
	print/Makefile:	#   SUBDIR += tex
	print/Makefile:	#   SUBDIR += texinfo
	print/Makefile:	#   SUBDIR += tr2latex
	print/Makefile:	#   SUBDIR += virtualpaper
	print/Makefile:	#   SUBDIR += xdvi
	print/Makefile:	#   SUBDIR += xmbibtex
	print/Makefile:	#   SUBDIR += xmgr
	textproc/Makefile:	#    SUBDIR += figlet
	textproc/Makefile:	#    SUBDIR += pspell
	textproc/Makefile:	#    SUBDIR += unroff
	www/Makefile:	#    SUBDIR += Mosaic         # requires Motif
	www/Makefile:	#    SUBDIR += arena
	www/Makefile:	#    SUBDIR += ashe           # requires Motif
	www/Makefile:	#    SUBDIR += aswedit
	www/Makefile:	#    SUBDIR += chimera
	www/Makefile:	#    SUBDIR += comline
	www/Makefile:	#    SUBDIR += fxhtml
	www/Makefile:	#    SUBDIR += gn
	www/Makefile:	#    SUBDIR += gwstat
	www/Makefile:	#    SUBDIR += harvest
	www/Makefile:	#    SUBDIR += http-analyze
	www/Makefile:	#    SUBDIR += libpics
	www/Makefile:	#    SUBDIR += libwww
	www/Makefile:	#    SUBDIR += linemode
	www/Makefile:	#    SUBDIR += mapedit
	www/Makefile:	#    SUBDIR += mmm
	www/Makefile:	#    SUBDIR += momspider
	www/Makefile:	#    SUBDIR += p5-CGI_Lite
	www/Makefile:	#    SUBDIR += p5-HTML-QuickCheck
	www/Makefile:	#    SUBDIR += p5-HTTPD-Tools
	www/Makefile:	#    SUBDIR += p5-WWW-Search
	www/Makefile:	#    SUBDIR += vrweb
	www/Makefile:	#    SUBDIR += w3
	www/Makefile:	#    SUBDIR += w3c-httpd
	www/Makefile:	#    SUBDIR += webcopy
	www/Makefile:	#    SUBDIR += webstone
	www/Makefile:	#    SUBDIR += wml
	www/Makefile:	#    SUBDIR += wn
	www/Makefile:	#    SUBDIR += wwwstat
	x11/Makefile:	#    SUBDIR += FWF
	x11/Makefile:	#    SUBDIR += auis
	x11/Makefile:	#    SUBDIR += blt
	x11/Makefile:	#    SUBDIR += camltk41
	x11/Makefile:	#    SUBDIR += emu
	x11/Makefile:	#    SUBDIR += etlfonts
	x11/Makefile:	#    SUBDIR += evilwm
	x11/Makefile:	#    SUBDIR += fbsd-icons
	x11/Makefile:	#    SUBDIR += filerunner
	x11/Makefile:	#    SUBDIR += fvwm
	x11/Makefile:	#    SUBDIR += fvwm2-english
	x11/Makefile:	#    SUBDIR += gwm
	x11/Makefile:	#    SUBDIR += iv
	x11/Makefile:	#    SUBDIR += libsx
	x11/Makefile:	#    SUBDIR += mlvwm
	x11/Makefile:	#    SUBDIR += p5-Tcl-Tk
	x11/Makefile:	#    SUBDIR += pythonqt
	x11/Makefile:	#    SUBDIR += slingshot
	x11/Makefile:	#    SUBDIR += sxpc
	x11/Makefile:	#    SUBDIR += tix
	x11/Makefile:	#    SUBDIR += tk41
	x11/Makefile:	#    SUBDIR += tk42
	x11/Makefile:	#    SUBDIR += tk80
	x11/Makefile:	#    SUBDIR += tk82
	x11/Makefile:	#    SUBDIR += tkdesk
	x11/Makefile:	#    SUBDIR += tkgoodstuff
	x11/Makefile:	#    SUBDIR += tkstep80
	x11/Makefile:	#    SUBDIR += tycoon
	x11/Makefile:	#    SUBDIR += x3270
	x11/Makefile:	#    SUBDIR += xalarm
	x11/Makefile:	#    SUBDIR += xbuffy
	x11/Makefile:	#    SUBDIR += xskyroot
	x11/Makefile:	#    SUBDIR += xtide


-
nuke all the OpenBSD guys (listed below), except those
who did not (my mail to ports@@ was enough to notify
everyone, since it's a list every porter is obliged
to subscribe to)

in contrast, the MirPorts framework is now covered by
a standard MirOS-style licence (see the template).

read on for the full story:

| From ak@@sdf.lonestar.org Sun Oct  5 19:09:27 2003
| Received: from sdf.lonestar.org (IDENT:root@@ol.freeshell.org [192.94.73.20])
| 	by herc.66h.42h.de (8.12.10/8.12.10) with ESMTP id h95J9Pnv007292
| 	for <tg@@66h.42h.de>; Sun, 5 Oct 2003 19:09:26 GMT
| Received: from sdf.lonestar.org (IDENT:ak@@otaku.freeshell.org [192.94.73.2])
| 	by sdf.lonestar.org (8.12.9/8.12.8) with ESMTP id h95J93X2012636
| 	for <tg@@66h.42h.de>; Sun, 5 Oct 2003 19:09:03 GMT
| Received: (from ak@@localhost)
| 	by sdf.lonestar.org (8.12.9/8.12.8/Submit) id h95J93jO008910
| 	for tg@@66h.42h.de; Sun, 5 Oct 2003 20:09:03 +0100 (BST)
| Date: Sun, 5 Oct 2003 20:09:03 +0100
| From: Andreas Kahari <ak@@freeshell.org>
| To: Thorsten Glaser <tg@@66h.42h.de>
| Subject: Re: OpenBSD ports maintainership
| Message-ID: <20031005190903.GA25959@@SDF.LONESTAR.ORG>
| References: <Pine.BSO.4.58.0310051812420.9202@@herc.66h.42h.de>
| Mime-Version: 1.0
| Content-Type: text/plain; charset=iso-8859-1
| Content-Disposition: inline
| Content-Transfer-Encoding: 8bit
| In-Reply-To: <Pine.BSO.4.58.0310051812420.9202@@herc.66h.42h.de>
| User-Agent: Mutt/1.4.1i
|
| Hi Thorsten,
|
| I'm the maintainer of the following commited OpenBSD ports:
|
|     * math/mcl
|     * sysutils/anacron
|     * sysutils/stow
|
| In the Makefiles, I am listed with the e-mail address
| "andreas.kahari@@unix.net".
|
| You are free to keep me in the Makefiles for these ports if
| you happen to move them over to MirBSD.  Since I'm strictly
| speaking not a MirBSD ports maintainer I will not assume any
| responsibility concerning these ports on MirBSD.
|
| I hope that's ok with you.
|
| Regards,
| Andreas Kdhdri
|
|
| On Sun, Oct 05, 2003 at 06:18:03PM +0000, Thorsten Glaser wrote:
| > Hello people.
| [cut]
| > That's why I have made the following decision:
| >
| >  - All names of MAINTAINERs, unless explicitly stated until end of this month,
| >    timezone UTC, will be removed from the Makefiles.
| >  - The mentioning of OpenBSD in the documentation will be removed.
| >
| > The first of these points is, IMHO, a breach of the BSD licence which has been
| > referred to farther above, that's why I am announcing this on the mailing list
| > and asking people prior to that.
| [cut]
|
| --
| Andreas Kdhdri
| East Anglia, England
|
| From tg@@66h.42h.de Sun Oct 26 21:45:41 2003 +0000
| Date: Sun, 26 Oct 2003 21:45:36 +0000 (UTC)
| From: Thorsten Glaser <tg@@66h.42h.de>
| To: ports@@openbsd.org
| Subject: Reminder: removal of names in MirPorts
| Message-ID: <Pine.BSO.4.58.0310262141190.31390@@herc.66h.42h.de>
| Followup-To: poster
| MIME-Version: 1.0
| Content-Type: TEXT/PLAIN; charset=iso-8859-1
| Content-Transfer-Encoding: QUOTED-PRINTABLE
|
| Hello ports developers,
|
| five days before launch remainder: Every ports ${MAINTAINER}
| who does NOT want his name to completely removed from the
| MirPorts framework Makefile, drop me an eMail.
|
| The current state is like this:
|
| tg@@odem:/usr/ports/x11/gtk+2 $ make describe
| gtk+2-2.2.4|x11/gtk+2||multi-platform graphical toolkit (uses C++) (uses X1=
| 1)|x11/gtk+2/pkg/DESCR|Benny Siegert <bsiegert@@66h.42h.de> (OpenBSD port co=
| ntributed by Marc Matteo <marcm@@openbsd.org>)|x11 devel|atk-1.0.0.1::devel/=
| atk glib-2.0.0.8,gmodule-2.0.0.8,gobject-2.0.0.8::devel/glib2 jpeg.62::grap=
| hics/jpeg pango-1.0.0.1,pangox-1.0.0.1,pangoxft-1.0.0.1::devel/pango png.3:=
| :graphics/png tiff.35::graphics/tiff|:devel/gmake bzip2-*:archivers/bzip2 p=
| kgconfig-*:devel/pkgconfig||BSD Linux|!hppa m88k vax|y|y|y|y
| gtk+2-docs-2.2.4|x11/gtk+2,-docs||gtk+-2 documentation (uses C++) (uses X11=
| )|x11/gtk+2/pkg/DESCR-docs|Benny Siegert <bsiegert@@66h.42h.de> (OpenBSD por=
| t contributed by Marc Matteo <marcm@@openbsd.org>)|x11 devel||:devel/gmake b=
| zip2-*:archivers/bzip2||BSD Linux|!hppa m88k vax|y|y|y|y
| (sorry for the overly long lines)
|
| I'm only reminding because this is removing a credit to the
| author of a work, which I think is not a very "easy" and
| "quick" thing to do.
|
| Please do not reply to the list because this is not OpenBSD
| related. Please do not reply off-topic, the discussion is over
| already. Thank you very much.
|
| //Thorsten
| --=20
| [rsocha] MEISTER!
| =09Robin S. Socha zu mir, im IRC, um die Zeit der letzten
| =09gro=DFen OpenSSH-Updates herum


The following peoples' names have been removed from MirPorts:

| Joe Abley <jabley@@automagic.org>
| Patroklos Argyroudis <argp@@ieee.org>
| Jonathan Auer <jda@@auerfamily.org>
| Jeff Bachtel <jeff@@cepheid.org>
| Marc Balmer <marc@@msys.ch>
| Marc Balmer <marcm@@msys.ch>
| Craig Barraclough <craigba@@creative.com.au>
| Bob Beck <beck@@openbsd.org>
| Han Boetes <han@@linux-mandrake.com>
| Han Boetes <han@@mijncomputer.nl>
| Mathieu Braem <majeu@@bsdaemon.be>
| Henning Brauer <henning@@openbsd.org>
| Marina Brown <marina@@surferz.net>
| Jean-Yves Burlett <jean-yves@@burlett.org>
| Aaron Campbell <aaron@@openbsd.org>
| rich cannings <cannings@@openbsd.org>
| Chris Cappuccio <chris@@openbsd.org>
| Rob Casey <rob@@minauros.com>
| Claudio Castiglia <ccastig@@softhome.net>
| Brian Caswell <bmc@@openbsd.org>
| Sean Cavanaugh <seanc@@cginfo.sk.ca>
| Sungman Cho <smcho@@tsp.korea.ac.kr>
| Wilbern Cobb <wcobb@@openbsd.org>
| Yannick Cote <yanick@@fries.net>
| Damien Couderc <couderc@@openbsd.org>
| Michael Coulter <mjc@@bitz.ca>
| Andrew Dalgleish <openbsd@@andrewdalgleish.dyndns.org>
| Ian Darwin <ian@@openbsd.org>
| Thierry Deval <tdeval@@openbsd.org>
| James Devenish <j-devenish@@users.sourceforge.net>
| Willem Dijkstra <wpd@@xs4all.nl>
| Camiel Dobbelaar <cd@@sentia.nl>
| Matthew Economou <xenophon@@irtnog.org>
| Christian Edward Gruber <cgruber@@israfil.net>
| Marius Eriksen <marius@@monkey.org>
| Jonas Eriksson <je@@sekure.net>
| Can Erkin Acar <canacar@@eee.metu.edu.tr>
| Sean Escriva <eliab@@spack.org>
| Marc Espie <espie@@openbsd.org>
| Alex Feinberg <alex@@strlen.net>
| Markus Friedl <markus@@openbsd.org>
| Pete Fritchman <petef@@databits.net>
| Federico G. Schwindt <fgsch@@openbsd.org>
| Peter Galbavy <peter.galbavy@@knowtion.net>
| Jim Geovedi <jim@@corebsd.or.id>
| Jens Gerlach Christensen <vepjan@@worldonline.dk>
| Lonny Gomes <devel@@n0mansland.net>
| Hugh Graham <hugh@@openbsd.org>
| Lurene Grenier <lurene@@daemonkitty.net>
| Lurene Grenier <lurene@@menagerie.tf>
| Wesley Griffin <wgriffin@@jtan.com>
| Moritz Grimm <gtgbr@@gmx.net>
| Arthur H. Johnson II <arthur@@linuxbox.nu>
| Jun-ichiro itojun Hagino <itojun@@itojun.org>
| Niklas Hallqvist <niklas@@openbsd.org>
| Dan Harnett <danh@@openbsd.org>
| Daniel Hartmeier <dhartmei@@openbsd.org>
| Matthieu Herrb <matthieu@@openbsd.org>
| Xiao Hui LOO <71@@becile.com>
| Shell Hung <shell@@openbsd.org>
| Carsten Ilchmann <ci2@@gmx.net>
| Hans Insulander <hin@@stacken.kth.se>
| Jason Ish <ish@@openbsd.org>
| Reinhard J. Sammer <reinhard@@openbsd.org>
| Paul Janzen <pjanzen@@openbsd.org>
| Claudio Jeker <cjeker@@diehard.n-r-g.com>
| Jose Jimenez Garcia <pluf@@wanadoo.es>
| Wangden Kelsang <wngdn@@src.uchicago.edu>
| Ibrahim Khalifa <ibo@@toontown.org>
| Tom Knienieder <tom@@knienieder.com>
| Matthew Kolb <muk@@msu.edu>
| Heikki Korpela <heko@@openbsd.org>
| Vladimir Kotal <vlada@@openbsd.cz>
| David Krause <david@@openbsd.org>
| Felix Kronlage <fkr@@grummel.net>
| Chris Kuethe <ckuethe@@ualberta.ca>
| Jason L. Wright <jason@@openbsd.org>
| Arnaud Launay <asl@@launay.org>
| David Lebel <lebel@@openbsd.org>
| Jon Leonard <oiler@@unseenedge.net>
| Cameron Lerch <opcode@@skylab.saturn5.yi.org>
| Benjamin Lerman <benjamin.lerman@@ambre.net>
| Michael Lestinsky <michael@@lestinsky.de>
| Morten Liebach <m@@mongers.org>
| Kevin Lo <kevlo@@openbsd.org>
| Chad Loder <cloder@@openbsd.org>
| Jesper Louis Andersen <jlouis@@mongers.org>
| Jolan Luff <jolan@@openbsd.org>
| Anil Madhavapeddy <avsm@@openbsd.org>
| Marc Matteo <marcm@@lectroid.net>
| Marc Matteo <marcm@@openbsd.org>
| Dorqus Maximus <dorqus@@bsdfreek.com>
| Ian McWilliam <i.mcwilliam@@uws.edu.au>
| Jacob Meuser <jakemsr@@jakemsr.com>
| Damien Miller <djm@@openbsd.org>
| Todd Miller <millert@@openbsd.org>
| Toni Mueller <tm@@tonimueller.org>
| Robert Nagy <thuglife@@bsd.hu>
| Nick Nauwelaerts <nick@@nauwelaerts.net>
| Jose Nazario <jose@@crimelabs.net>
| Jeffrey Neitzel <jneitzel@@bluemarble.net>
| Maurice Nonnekes <maurice@@amaze.nl>
| Jon Olsson <jon@@abc.se>
| Michael Paddon <michael@@paddon.org>
| Brandon Palmer <bpalmer@@crimelabs.net>
| Mike Pechkin <mpech@@openbsd.org>
| Jason Peel <jsyn@@openbsd.org>
| Zvezdan Petkovic <zvezdan@@cs.wm.edu>
| Aleksander Piotrowski <aleksander.piotrowski@@piestrak.waw.pl>
| Vladimir Popov <pva48@@mail.ru>
| Olivier Racine <darkroot@@darkroot.net>
| Martin Reindl <mreindl@@catai.org>
| Josh Rivel <dorqus@@freek.com>
| Scott Robinson <scott@@tranzoa.com>
| Manuel Rodrigo Rabade Garcia <mig@@mig-29.net>
| Bruno Rohee <rohee@@openbsd.org>
| Wolfgang Rupprecht <wsr+dgpsip@@wsrcc.com>
| Marco S Hyman <marc@@openbsd.org>
| Andre S. Barbosa <andre@@ravel.ufrj.br>
| Bjorn Sandell <biorn@@dce.chalmers.se>
| Gerardo Santana Gomez Garrido <santana@@openbsd.org.mx>
| Xavier Santolaria <xavier@@santolaria.net>
| Jakob Schlyter <jakob@@openbsd.org>
| Tom Schutter <t.schutter@@att.net>
| Federico Schwindt <fgsch@@openbsd.org>
| Srebrenko Sehic <haver@@insecure.dk>
| Margarida Sequeira <margarida@@openbsd.org>
| Michael Shalayeff <mickey@@openbsd.org>
| Steve Shockley <steve.shockley@@shockley.net>
| J Shoemaker <shoemaker@@softhome.net>
| David Simas <davids@@idiom.com>
| Artur Skura <arturs@@iidea.pl>
| Andrey Smagin <andrey@@smagin.com>
| Brad Smith <brad@@openbsd.org>
| Sam Smith <s@@msmith.net>
| Dug Song <dugsong@@monkey.org>
| Joerg Sonnenberger <joerg@@bec.de>
| Sebastian Stark <seb@@todesplanet.de>
| Joshua Stein <jcs@@rt.fm>
| Gregory Steuck <greg@@nest.cx>
| Don Stewart <dons@@cse.unsw.edu.au>
| Peter Stromberg <wilfried@@openbsd.org>
| Nikolay Sturm <sturm@@openbsd.org>
| SUZUKI Hitoshi <sigh@@kuzirabekon.econ.nagasaki-u.ac.jp>
| Todd T. Fries <todd@@openbsd.org>
| David Terrell <dbt@@openbsd.org>
| Yozo Toda <yozo@@v007.vaio.ne.jp>
| Peter Valchev <pvalchev@@openbsd.org>
| Pieter-Augustijn Van Malleghem <geekassault@@planetinternet.be>
| Paul Wang <op21@@squish.org>
| Dave Watson <dave@@elephantride.org>
| Dan Weeks <danimal@@danimal.org>
| Hans-Guenter Weigand <hgw@@d1906.inka.de>
| Tobias Weingartner <weingart@@openbsd.org>
| Christian Weisgerber <naddy@@openbsd.org>
| Peter Werner <peterw@@ifost.org.au>
| Jason Wright <jason@@openbsd.org>
| William Yodlowsky <bsd@@openbsd.rutgers.edu>
| Alexander Yurchenko <grange@@openbsd.org>
| pilot <pilot@@monkey.org>

I have hereby fulfilled my action, unless notified that
not within two weeks (e.g. until 14 Nov 2003, 23:59 UTC).

An rsync will be started pretty immidiately after this commit.

Hm, contest - largest commit message ever? ;-)




  ##
  ##
    ##
    ##
######
######



your MirPorts team
// Thorsten Glaser
in absentia,
// Benny Siegert
// Waldemar Brodkorb
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.31 2003/10/21 15:17:31 tg Exp $
d7 1
a7 1
#	Waldemar Brodkorb <wbx@@openbsd.de>
@


1.31
log
@o change MirPorts mailing list from ports@@66h.42h.de to
	<miros-discuss@@${_DOMAIN_DU_JOUR}>
o while here, nuke HTTPS entry in master sites, and add
  a couple of missing defines for "our" master site
  (XXX the two entries will have to be swapped)
@
text
@d1 1
a1 1
# $MirBSD: bsd.port.mk,v 1.30 2003/10/08 18:07:38 tg Exp $
d6 4
a9 1
# Copyright (c) 2003 Thorsten Glaser <x86@@ePost.de>
d939 2
a940 1
MNTNER=		${RESPONSIBLE} (OpenBSD port contributed by ${MAINTAINER})
@


1.30
log
@o Move job of ${MAINTAINER} to ${RESPONSIBLE} for MirPorts
o Display ${MNTNER}, not ${MAINTAINER} in make describe and friends
o Put the MirBSD licence template on top of MirPorts, because there
  is no such thing as "public domain" in central Europe anyways
o Make even clearer that this is not the OpenBSD ports tree
  (requested by Damien Couderc and co.)
o Move in a quick some ports that we maintain to ${RESPONSIBLE}
  (cleanup will follow on November 1st, 2003)
o regenerate INDEX with the new information from ${MNTNER}

Attention: MirPorts except unified and context diffs, but including
forward (ed) diffs, is now BSD-style licensed. Contextual diffs continue
to share the licence of the file they patch.
@
text
@d1 1
a1 1
# $MirBSD: licence.template,v 1.5 2003/07/26 12:33:13 tg Exp $
d113 1
a113 1
_MIRPORTS_ADDRESS=<ports@@${_DOMAIN_DU_JOUR}>
@


1.29
log
@Merge OpenBSD
@
text
@d1 22
a22 7
#	$MirBSD: bsd.port.mk,v 1.28 2003/10/01 22:04:16 tg Exp $
#	$OpenBSD: bsd.port.mk,v 1.588 2003/09/28 10:57:01 espie Exp $
#	$FreeBSD: bsd.port.mk,v 1.264 1996/12/25 02:27:44 imp Exp $
#	$NetBSD: bsd.port.mk,v 1.62 1998/04/09 12:47:02 hubertf Exp $
#
#	bsd.port.mk - 940820 Jordan K. Hubbard.
#	This file is in the public domain.
d24 1
a24 1
# Each port has a MAINTAINER, which is the email address(es) of the person(s)
d27 1
a27 1
#	make show=MAINTAINER
a28 1
#
a33 5
#
# The ports@@openbsd.org address is the 'default' MAINTAINER (the generic
# OpenBSD ports mailing-list).
# Enquiries as to the bsd.port.mk framework should usually be directed
# to ports@@openbsd.org.
d84 2
a85 2
ERRORS+="Please notify the MirPorts and eventually the OpenBSD port maintainer:"
ERRORS+="    ${MAINTAINER}"
d624 2
a625 1
SUBST_VARS+=MACHINE_ARCH ARCH HOMEPAGE PREFIX SYSCONFDIR FLAVOR_EXT MAINTAINER
d719 1
a719 1
	@@echo "\nMaintainer: ${MAINTAINER}" >>$@@
d935 6
a940 1
MAINTAINER?=	The MirPorts mailing list ${_MIRPORTS_ADDRESS}
d1981 1
d2090 1
a2090 1
	echo -n "${MAINTAINER}|${CATEGORIES}|"
@


1.28
log
@add gmake to FAKE_FLAGS, too
@
text
@d1 2
a2 2
#	$MirBSD: bsd.port.mk,v 1.27 2003/10/01 19:33:35 tg Exp $
#	$OpenBSD: bsd.port.mk,v 1.587 2003/08/28 23:42:44 naddy Exp $
d2369 1
a2369 1
		self=${FULLPKGPATH} ${MAKE} _recurse-run-dir-depends; \
@


1.27
log
@why am I _not_ surprised that adding
 MAKE=gmake
to $(MAKE_FLAGS) helps kdebase building (well, it just
started - kdegames do work just fine though :)?
It overrides, in best GNU tradition, the "MAKE=make"
setting within their Makefile; I now smell why GNU make
is not compatible.
@
text
@d1 1
a1 1
#	$MirBSD: bsd.port.mk,v 1.26 2003/10/01 18:19:34 tg Exp $
d235 1
@


1.26
log
@turns out that it was a kernel bug (that configure stuff)
remove the braces but leave the ${SH} in there, you can't
know for sure...

while here, targets print-all-depends/print-depends which
have been added list all dependencies resp. all build and
run dependencies a port has.
@
text
@d1 1
a1 1
#	$MirBSD: bsd.port.mk,v 1.25 2003/10/01 16:48:09 tg Exp $
d234 1
@


1.25
log
@call the configure script within two subshells (so a SIGchild or SIGKILL
will not terminate the make(1) entirely).

XXX this is a kludge. I hereby define this mis-behaviour of MirBSD
XXX a regression w.r.t. OpenBSD and ask everybody to help fix it.
XXX contact ports@@66h.42h.de for more information about the problem:
# make configure
  [...]
  Killed.
# _
@
text
@d1 1
a1 1
#	$MirBSD: bsd.port.mk,v 1.24 2003/09/24 22:27:53 tg Exp $
d1043 1
a1043 1
.    if ( ${OPSYS_VER} >= ${COMES_WITH} )
d1561 1
a1561 1
	( cd ${WRKBUILD} && ${_SYSTRACE_CMD} ${SETENV} \
d1569 1
a1569 1
		${CONFIGURE_ENV} ${SH} ${_CONFIGURE_SCRIPT} ${CONFIGURE_ARGS} )
d2198 10
@


1.24
log
@better even: alias "cleandir" to "CLEANDEPENDS=Yes clean"
I think this matches its "supposed" function.
@
text
@d1 1
a1 1
#	$MirBSD: bsd.port.mk,v 1.23 2003/09/24 22:23:55 tg Exp $
d1561 1
a1561 1
	cd ${WRKBUILD} && ${_SYSTRACE_CMD} ${SETENV} \
d1569 1
a1569 1
		${CONFIGURE_ENV} ${_CONFIGURE_SCRIPT} ${CONFIGURE_ARGS}
@


1.23
log
@add "make cleandir" (aliased to the "clean" default target)
@
text
@d1 1
a1 1
#	$MirBSD: bsd.port.mk,v 1.22 2003/09/17 13:54:34 tg Exp $
d2466 2
a2467 1
cleandir: clean
@


1.22
log
@tell every single port that uses make/gmake that CC=CC.
this should remove the need to pass it to ports individually.

idea from bsiegert@@ trying to fix anacron
@
text
@d1 1
a1 1
#	$MirBSD: bsd.port.mk,v 1.21 2003/09/10 22:07:51 tg Exp $
d2466 2
d2505 1
a2505 1
	checkpatch checksum clean \
@


1.21
log
@make the MirPorts mailing list (open to subscribe now, mail tg@@66h.42h.de)
the default maintainer, and add an option to show its address, with the
description at the top of this file.
ATTENTION: This needs src/share/mk/sys.mk Revision 1.24 or higher to work!
(not that you should use ports/src out of sync anyways...)
@
text
@d1 1
a1 1
#	$MirBSD: bsd.port.mk,v 1.20 2003/09/03 12:57:48 tg Exp $
d435 1
a435 1
	HOME='${PORTHOME}'
@


1.20
log
@more do-not-bother-the-types-at-OpenBSD-for-my-faults
while here, the usual `...` -> $(...) conversion,
as well as documentary `...' -> '...' and ``...'' -> "..."
@
text
@d1 1
a1 1
#	$MirBSD: bsd.port.mk,v 1.19 2003/09/01 18:28:14 tg Exp $
d16 4
a19 2
# In the case of MirPorts, the contact address is the MirBSD MAINTAINER,
# in general <mirabilos@@web.de>.
d104 1
d923 1
a923 1
MAINTAINER?=	The MirPorts maintainer c/o <mirabilos@@web.de>
@


1.19
log
@'make describe' tells {ONLY,NOT}_FOR_OS now, too.
@
text
@d1 1
a1 1
#	$MirBSD: bsd.port.mk,v 1.18 2003/09/01 17:10:36 tg Exp $
d15 5
a19 1
# The ports@@openbsd.org address is the `default' MAINTAINER (the generic
a20 1

d62 1
a62 1
# pre-patch `real distpatch' post-distpatch `real patch' post-patch
d73 1
a73 1
ERRORS+="Please notify the MirBSD and eventually the OpenBSD port maintainer:"
d909 1
a909 1
EXTRACT_CASES+= *.gz) ${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive >`basename $$archive .gz`;;
d920 1
a920 1
MAINTAINER?=	Used to be the OpenBSD ports mailing-list; now <mirabile@@electric-pickle.net>
d1081 1
a1081 1
	@@if [ `sed -e 's/\=.*$$//' ${CHECKSUM_FILE} | uniq -d | wc -l` -ne 0 ]; then \
d1115 2
a1116 2
		check=`eval $$listlibs| perl \
			${PORTSDIR}/infrastructure/build/resolve-lib ${_noshared} $$d` \
d1162 1
a1162 1
		case "X$$pkg" in X) pkg=`eval $$toset ${MAKE} _print-packagename`; \
d1254 1
a1254 1
	LIB_DEPENDS="`${MAKE} _recurse-lib-depends-check`" \
d1266 1
a1266 1
# fetch is an exception, as it uses the files it fetches as `cookies',
d1310 1
a1310 1
			set -- `grep -i "^$$cipher ($$file)" $$checksum_file` && break || \
d1322 1
a1322 1
			  CKSUM=`$$cipher < $$file`; \
d1335 1
a1335 1
		  set -- `grep "($$file)" $$checksum_file` || \
d1660 2
a1661 2
	@@if [ x`${SUDO} ${SH} -c umask` != x${DEF_UMASK} ]; then \
		echo >&2 "Error: your umask is \"`${SH} -c umask`"\".; \
d1744 1
a1744 1
	@@duplicates=`sort <${WRKPKG}/PLIST${SUBPACKAGE}|egrep -v '@@(comment|mode|owner)'|uniq -d`; \
d1750 1
a1750 1
	    mode=`id -u`:`id -g`; ${SUDO} ${CHOWN} $${mode} ${PKGFILE${SUBPACKAGE}}; \
d1831 1
a1831 1
		if [ -L $$i ]; then ${SUDO} rm -rf `readlink $$i`; fi; \
d1835 1
a1835 1
	@@if [ -L ${WRKDIR} ]; then rm -rf `readlink ${WRKDIR}`; fi
d1899 1
a1899 1
	DEPS="`${MAKE} full-run-depends`" \
d1908 1
a1908 1
	@@toedit=`WRKDIST=${WRKDIST} PATCHDIR=${PATCHDIR} \
d1911 1
a1911 1
		/bin/sh ${PORTSDIR}/infrastructure/build/update-patches`; \
d1949 1
a1949 1
	@@echo "${_FMN}: ${_ALLFILES} "`_FULL_PACKAGE_NAME=Yes ${MAKE} full-all-depends`
d1978 1
a1978 1
		if set -- `grep -i "^$$c (${_F})" $$checksum_file`; then break; fi; \
d2147 1
a2147 1
	@@name=`SUBPACKAGE=${_S} ${MAKE} _print-packagename _FULL_PACKAGE_NAME=No`; \
d2152 1
a2152 1
	@@name=`unset SUBPACKAGE; ${MAKE} _print-packagename _FULL_PACKAGE_NAME=No`; \
d2162 1
a2162 1
			j=`dirname $$n|${HTMLIFY}`; k=`basename $$n|${HTMLIFY}`; \
d2170 1
a2170 1
		sed -e 's|%%PORT%%|'"`echo ${FULLPKGPATH}  | ${HTMLIFY}`"'|g' \
d2232 2
a2233 2
	for spec in `echo '${_${_i}_DEP2}' \
		| tr '\040' '\012' | sort -u`; do \
d2276 1
a2276 1
		default=`eval $$toset ${MAKE} _print-packagename`; \
d2295 2
a2296 2
		default=`eval $$toset ${MAKE} _print-packagename`; \
		case "X$$pkg" in X) pkg=`echo $$default|sed -e 's,-[0-9].*,-*,'`;; esac; \
d2419 1
a2419 1
	@@linkname=${PORTSDIR}/${_CAT}/`basename ${.CURDIR}`; \
d2429 1
a2429 1
	@@linkname=${PORTSDIR}/${_CAT}/`basename ${.CURDIR}`; \
@


1.18
log
@ONLY_FOR_OS=BSD Linux
NOT_FOR_OS=BSD Linux

Application sample: gmake will be in the MirLinux base system
@
text
@d1 1
a1 1
#	$MirBSD: bsd.port.mk,v 1.17 2003/08/31 20:52:48 tg Exp $
d2073 7
@


1.17
log
@Merge import of OpenBSD source, ports and XF4 tree.

While here,
o clean up differences where possible
o whitespace cleanup
o ifdef ./. if defined()
o '...' ./. "..."
o echo foo > bar ./. echo foo >bar
o `...` ./. $(...) ./. $$(...)
o `...' ./. '...'
o modernize "our" tree, e.g. WWW in ports
o fix some typos and brainos introduced when renaming OpenBSD to MirBSD
o use hardware 80387 by default
o migrate Apache 1.3.28 OpenBSD ./. MirBSD ./. KAME
o work around as many CVS bugs as possible (add back/delete files, ...)

Synchronize stuff, ready for ongoing changes.
@
text
@d1 1
a1 1
#	$MirBSD: bsd.port.mk,v 1.16 2003/08/18 15:57:46 tg Exp $
d1021 12
@


1.16
log
@merge OpenBSD
@
text
@d1 2
a2 2
#	$MirBSD: bsd.port.mk,v 1.15 2003/07/26 16:03:58 tg Exp $
#	$OpenBSD: bsd.port.mk,v 1.584 2003/08/15 00:04:45 espie Exp $
a95 1
WRKINST?=${WRKDIR}/fake-${ARCH}${_FLAVOR_EXT2}
d462 6
d917 1
a917 1
MAINTAINER?=	Used to be the OpenBSD ports mailing-list <ports@@openbsd.org>
d1838 1
a1838 1
	-${SUDO} ${PKG_DELETE} ${clean:M-f} ${FULLPKGNAME${_s}}
d1841 1
a1841 1
	-${SUDO} ${PKG_DELETE} ${clean:M-f} ${FULLPKGNAME${SUBPACKAGE}}
d1953 3
d2445 1
a2445 1
	@@cd ${.CURDIR} && exec ${MAKE} clean=install
@


1.15
log
@merge CVS; fix here and there a bit
@
text
@d1 2
a2 2
#	$MirBSD: bsd.port.mk,v 1.14 2003/07/24 17:09:07 tg Exp $
#	$OpenBSD: bsd.port.mk,v 1.564 2003/07/25 12:46:26 espie Exp $
a45 2
# readme		- Create a README.html file describing the category or package
#				  (somewhat broken due to NEW_DEPENDS)
a46 11

# Somewhat obsolete targets:
# list-distfiles- list the distribution and patch files used by a port.
#				  Typical use is (from the top level of the ports tree)
#				  make ECHO_MSG=: list-distfiles | tee some-file
#				  (rely on mirror-maker instead)
# print-depends - print all dependencies for the given package
#				  (for new dependencies, use
#				  build-depends-list/run-depends-list instead)
#
#
d119 6
a124 1
clean?=work
d126 1
a126 1
clean+=depends
d128 2
a129 2
.if ${clean:L:Mwork}
clean+=fake
d131 2
a132 2
.if ${clean:L:Mforce}
clean+=-f
d355 1
d517 1
a517 1
	@@${MAKE} ${_PACKAGE_COOKIE_DEPS}
d531 1
a531 1
	@@${MAKE} ${_PACKAGE_COOKIE_DEPS}
d540 1
a540 5
.if !defined(PKGPATH)
_PORTSDIR!=	cd ${PORTSDIR} && pwd -P
_CURDIR!=	cd ${.CURDIR} && pwd -P
PKGPATH=${_CURDIR:S,${_PORTSDIR}/,,}
.endif
a541 1
PKGDEPTH=${PKGPATH:C|[^./][^/]*|..|g}
d578 23
d683 7
a689 2
	@@touch $@@
	@@self=${FULLPKGNAME${SUBPACKAGE}} _depends_result=$@@ exec ${MAKE} _solve-package-depends
a706 1
_SORT_DEPENDS?=tsort|tail -r
d740 1
a740 1
PKG_ARGS+=		-s ${WRKINST}${PREFIX}
a763 3
# XXX
_DEPEND_ECHO?=		echo

d800 2
d839 1
a839 1
.if make(makesum) || make(addsum) || make(list-distfiles) || defined(__FETCH_ALL)
d956 1
a956 1
.  for _F in ${ALLFILES:S@@^@@${FULLDISTDIR}@@}
a1072 38
# Code to invoke to split dir,-multi,flavor

_flavor_fragment= \
		multi=''; flavor=''; sawflavor=false; \
		case "$$dir" in \
		*,*) \
			IFS=,; first=true; for i in $$dir; do \
				if $$first; then \
					dir=$$i; first=false; \
				else \
					case X"$$i" in \
						X-*) \
							multi="$$i";; \
						*) \
							sawflavor=true; \
							flavor="$$flavor $$i";; \
					esac \
				fi; \
			done; unset IFS;; \
		esac; \
		toset="PKGPATH=$$dir"; \
		case X$$multi in "X");; *) \
			toset="$$toset SUBPACKAGE=\"$$multi\"";; \
		esac; \
		if $$sawflavor; then \
			toset="$$toset FLAVOR=\"$$flavor\""; \
		fi; \
		cd ${PORTSDIR}; \
		if [ -L $$dir ]; then \
			echo 1>&2 ">> Broken dependency: $$dir is a symbolic link"; \
			exit 1; \
		fi; \
		if cd $$dir 2>/dev/null || cd mystuff/$$dir 2>/dev/null; then \
			:; \
		else \
			echo 1>&2 ">> Broken dependency: $$dir non existent"; \
			exit 1; \
		fi
d1077 1
a1077 1
	if pkg dependencies check $$pkg; then \
d1116 1
d1118 3
d1122 1
d1164 1
a1164 1
			if eval $$toset ${MAKE} ${_DEPEND_THRU} $$target; then \
d1218 1
a1218 1
uninstall deinstall fake package lib-depends-check manpages-check:
d1233 3
a1235 1
	@@LIB_DEPENDS="`${MAKE} _recurse-lib-depends`" PKG_DBDIR='${PKG_DBDIR}' \
d1328 1
a1328 1
		  	cd ${.CURDIR} && ${MAKE} refetch _PROBLEMS="$$list"; \
d1340 1
a1340 1
refetch:
d1342 3
a1344 3
		@@rm ${DISTDIR}/${file}
		@@cd ${.CURDIR} && ${MAKE} ${DISTDIR}/${file} \
			MASTER_SITE_OVERRIDE="ftp://ftp.openbsd.org/pub/OpenBSD/distfiles/${cipher}/${value}/"
d1398 1
a1398 1
	@@exec ${MAKE} ${_i} ${BULK_FLAGS}
d1400 1
a1400 1
	@@exec ${SUDO} ${MAKE} clean
d1411 1
a1411 1
${_EXTRACT_COOKIE}: ${_WRKDIR_COOKIE}
d1415 1
a1415 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-extract
d1417 8
a1424 3
.if target(do-extract)
	@@cd ${.CURDIR} && exec ${MAKE} do-extract
.else
a1433 5
.if target(post-extract)
	@@cd ${.CURDIR} && exec ${MAKE} post-extract
.endif
	@@${_MAKE_COOKIE} $@@

d1538 2
a1539 1
	cd ${WRKBUILD} && CC="${CC}" ac_cv_path_CC="${CC}" CFLAGS="${CFLAGS}" \
d1554 1
a1554 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-configure
d1557 1
a1557 1
	@@cd ${.CURDIR} && exec ${MAKE} do-configure
d1561 2
a1562 2
		cd ${.CURDIR} && ${SETENV} ${SCRIPTS_ENV} ${SH} \
		    ${SCRIPTDIR}/configure; \
d1572 1
a1572 1
	@@cd ${.CURDIR} && exec ${MAKE} post-configure
d1597 1
a1597 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-build
d1600 1
a1600 1
	@@cd ${.CURDIR} && exec ${MAKE} do-build
d1603 1
a1603 1
	@@cd ${WRKBUILD} && exec ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} -f ${MAKE_FILE} ${ALL_TARGET}
d1607 1
a1607 1
	@@cd ${.CURDIR} && exec ${MAKE} post-build
d1657 1
a1657 1
	@@cd ${.CURDIR} && exec ${SUDO} ${MAKE} pre-fake ${_FAKE_SETUP}
d1661 1
a1661 1
	@@cd ${.CURDIR} && exec ${SUDO} ${MAKE} pre-install ${_FAKE_SETUP}
d1664 1
a1664 1
	@@cd ${.CURDIR} && exec ${SUDO} ${MAKE} do-install ${_FAKE_SETUP}
d1667 1
a1667 1
	@@cd ${WRKBUILD} && exec ${SUDO} ${SETENV} ${MAKE_ENV} ${_FAKE_SETUP} ${MAKE_PROGRAM} ${FAKE_FLAGS} -f ${MAKE_FILE} ${FAKE_TARGET}
d1671 1
a1671 1
	@@cd ${.CURDIR} && exec ${SUDO} ${MAKE} post-install ${_FAKE_SETUP}
d1731 1
a1731 1
	    ${MAKE} package-links; \
a1770 16
# list the distribution and patch files used by a port.  Typical
# use is		make ECHO_MSG=: list-distfiles | tee some-file
#
list-distfiles:
	@@echo "${FULLPKGNAME}"
	@@for file in ${ALLFILES}; do \
		if [ "$$file" != "${EXTRACT_SUFX}" ]; then \
			if [ -z "${DIST_SUBDIR}" ]; then \
				printf "\t$$file\n"; \
			else \
				printf "\t${DIST_SUBDIR}/$$file\n"; \
			fi \
		fi \
	 done
	@@echo ""

d1773 2
a1774 2
package-links:
	@@cd ${.CURDIR} && exec ${MAKE} delete-package-links
d1787 1
a1787 1
delete-package-links:
d1792 1
a1792 2
delete-package:
	@@cd ${.CURDIR} && exec ${MAKE} clean=package
d1794 1
a1794 41
# Checkpatch
#
# Special target to verify patches

checkpatch:
	@@cd ${.CURDIR} && exec ${MAKE} PATCH_CHECK_ONLY=Yes patch

# Reinstall
#
# Special target to re-run install

reinstall:
	@@cd ${.CURDIR} && exec ${MAKE} clean=install
	@@cd ${.CURDIR} && DEPENDS_TARGET=${DEPENDS_TARGET} exec ${MAKE} install

# Force rebuild of a package
repackage:
	@@cd ${.CURDIR} && exec ${MAKE} clean=packages
	@@cd ${.CURDIR} && exec ${MAKE} package

# Rebuild
#
# Special target to re-run build
rebuild:
	@@rm -f ${_BUILD_COOKIE}
	@@cd ${.CURDIR} && exec ${MAKE} build

# Deinstall
#
# Special target to remove installation

uninstall deinstall:
	@@${ECHO_MSG} "===> Deinstalling for ${FULLPKGNAME${SUBPACKAGE}}"
	@@${SUDO} ${PKG_DELETE} -f ${FULLPKGNAME${SUBPACKAGE}}


################################################################
# Some more targets supplied for users' convenience
################################################################

# Cleaning up
d1797 7
a1803 3
.if ${clean:L:Mdepends}
	@@cd ${.CURDIR} && exec ${MAKE} clean-depends
.endif
d1805 1
a1805 1
.if ${clean:L:Mfake}
d1807 3
a1809 3
.endif
.if ${clean:L:Mwork}
.  if ${clean:L:Mflavors}
d1814 1
a1814 1
.  else
d1817 1
d1819 1
a1819 2
.endif
.if ${clean:L:Mdist}
d1826 1
a1826 1
.  if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
d1828 1
d1830 3
a1832 4
.endif
.if ${clean:L:Minstall}
.  if ${clean:L:Msub}
.    for _s in ${MULTI_PACKAGES}
d1834 2
a1835 2
.    endfor
.  else
d1837 1
d1839 1
a1839 2
.endif
.if ${clean:L:Mpackages} || ${clean:L:Mpackage} && ${clean:L:Msub}
d1841 14
a1854 4
.  if defined(MULTI_PACKAGES)
.    for _s in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' exec ${MAKE} delete-package-links
.    endfor
d1856 1
a1856 5
.elif ${clean:L:Mpackage}
	@@cd ${.CURDIR} && exec ${MAKE} delete-package-links
	rm -f ${PKGFILE${SUBPACKAGE}}
.endif
.if ${clean:L:Mbulk}
d1858 1
a1860 3
distclean:
	@@${MAKE} clean=dist

d1879 1
a1879 1
	DEPS="`${MAKE} package-depends|tsort`" \
d1909 7
d1925 9
a1933 2
	@@echo ":: ${PKGPATH}/${FULLPKGNAME}"
	@@cd ${.CURDIR} && exec ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes _fetch-makefile-helper
d1936 1
a1936 8
_fetch-makefile-helper:
# write generic package dependencies
	@@name='${PKGPATH}/${FULLPKGNAME}'; \
	echo ".PHONY: $${name}"; \
	case '${RECURSIVE_FETCH_LIST:L}' in yes) \
	  echo "$${name}:: "`${MAKE} depends-list package-depends FULL_PACKAGE_NAME=Yes |${_SORT_DEPENDS}`;; \
	esac; \
	echo "$${name}:: ${_ALLFILES}"
a1975 15
# The README.html target needs full information (this is passed via
# depends-list and package-depends)
FULL_PACKAGE_NAME?=No

# Make variables to pass along on recursive builds
_DEPEND_THRU=FULL_PACKAGE_NAME=${FULL_PACKAGE_NAME}

# XXX
package-name:
.  if (${FULL_PACKAGE_NAME:L} == "yes")
	@@${_DEPEND_ECHO} '${PKGPATH}/${FULLPKGNAME${SUBPACKAGE}}'
.  else
	@@${_DEPEND_ECHO} '${FULLPKGNAME${SUBPACKAGE}}'
.  endif

a2004 20
_clean-depends:
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || !empty(_RUN_DEP)
	@@unset FLAVOR SUBPACKAGE || true; \
	for dir in ${_ALWAYS_DEP} ${_RUN_DEP} ${_BUILD_DEP}; do \
		if fgrep -q "|$$dir|" $${_DEPENDS_FILE}; then :; else \
			echo "|$$dir|" >>$${_DEPENDS_FILE}; \
			${_flavor_fragment}; \
			eval $$toset ${MAKE} CLEANDEPENDS=No ${_DEPEND_THRU} clean _clean-depends; \
		fi; \
	done
.endif

clean-depends:
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || !empty(_RUN_DEP)
	@@: $${_DEPENDS_FILE:=`mktemp /tmp/depends.XXXXXXXXXX`}; \
	export _DEPENDS_FILE; \
	${MAKE} _clean-depends; \
	rm -f $${_DEPENDS_FILE}
.endif

d2026 1
a2026 1
.if !defined(PACKAGING) && defined(MULTI_PACKAGES)
d2028 5
d2085 8
a2092 1
.  if defined(MULTI_PACKAGES) && empty(SUBPACKAGE)
d2094 1
a2094 1
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' PACKAGING='${_sub}' exec ${MAKE} describe
d2097 3
d2103 2
a2104 1
README.html:
a2105 6
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP)
	@@cd ${.CURDIR} && ${MAKE} depends-list FULL_PACKAGE_NAME=Yes | ${_SORT_DEPENDS}>$@@.tmp1
.endif
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
	@@cd ${.CURDIR} && ${MAKE} package-depends FULL_PACKAGE_NAME=Yes | ${_SORT_DEPENDS} >$@@.tmp2
.endif
d2111 21
a2131 3
.for I in 1 2
	@@if [ -s $@@.tmp$I ]; then \
		{ cat $@@.tmp$I | while read n; do \
d2133 5
a2137 5
			echo "<li><a href=\"${PKGDEPTH}/$$j/README.html\">$$k</a>"; \
		 done; } >$@@.tmp$Ia; \
    else \
    echo "<li>(none)" > $@@.tmp$Ia; \
	fi
d2140 1
a2140 1
		sed -e 's|%%PORT%%|'"`echo ${PKGPATH}  | ${HTMLIFY}`"'|g' \
d2142 2
a2143 2
			-e '/%%COMMENT%%/r${PKGDIR}/COMMENT' -e '//d' \
			-e '/%%DESCR%%/r${PKGDIR}/DESCR' -e '//d' \
d2145 3
a2147 2
			-e '/%%BUILD_DEPENDS%%/r$@@.tmp1a' -e '//d' \
			-e '/%%RUN_DEPENDS%%/r$@@.tmp2a' -e '//d' \
d2151 2
a2152 1
print-depends-list:
d2155 1
a2155 2
	@@unset FLAVOR SUBPACKAGE || true; \
	echo -n `cd ${.CURDIR} && ${MAKE} ${_DEPEND_THRU} depends-list | ${_SORT_DEPENDS}`
d2159 1
a2159 1
print-package-depends:
d2162 1
a2162 2
	@@unset FLAVOR SUBPACKAGE || true; \
	echo -n `cd ${.CURDIR} && ${MAKE} ${_DEPEND_THRU} package-depends | ${_SORT_DEPENDS}`
d2166 8
d2175 4
a2178 6
recurse-build-depends:
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || !empty(_RUN_DEP)
	@@pname=`cd ${.CURDIR} && ${MAKE} _DEPEND_ECHO='echo -n' package-name ${_DEPEND_THRU}`; \
	unset FLAVOR SUBPACKAGE || true; \
	for dir in `echo ${_ALWAYS_DEP} ${_BUILD_DEP} ${_RUN_DEP} \
		| tr '\040' '\012' | sort -u`; do \
d2180 4
a2183 4
		if ! eval $$toset ${MAKE} _DEPEND_ECHO=\"echo $$pname\" package-name recurse-build-depends ${_DEPEND_THRU}; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
			exit 1; \
		fi; \
a2184 2
.else
	@@pname=`cd ${.CURDIR} && ${MAKE} _DEPEND_ECHO='echo -n' package-name`; echo $$pname $$pname
d2187 10
a2196 2
depends-list:
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP)
d2198 5
a2202 1
	for dir in `echo ${_ALWAYS_DEP} ${_BUILD_DEP} \
d2204 5
a2208 7
		${_flavor_fragment}; \
		if ! eval $$toset ${MAKE} recurse-build-depends ${_DEPEND_THRU}; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
			exit 1; \
		fi; \
	done
.endif
d2210 1
a2210 16
# Build (recursively) a list of package dependencies suitable for tsort
recurse-package-depends:
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
	@@pname=`cd ${.CURDIR} && ${MAKE} _DEPEND_ECHO='echo -n' package-name ${_DEPEND_THRU}`; \
	unset FLAVOR SUBPACKAGE || true; \
	for dir in `echo ${_ALWAYS_DEP} ${_RUN_DEP} \
		| tr '\040' '\012' | sort -u`; do \
		${_flavor_fragment}; \
		if ! eval $$toset ${MAKE} _DEPEND_ECHO=\"echo $$pname\" package-name recurse-package-depends ${_DEPEND_THRU}; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"." ; \
			exit 1; \
		fi; \
	done
.else
	@@pname=`cd ${.CURDIR} && ${MAKE} _DEPEND_ECHO='echo -n' package-name`; echo $$pname $$pname
.endif
d2212 2
a2213 2
# Print list of all libraries we're allowed to depend upon.
_recurse-lib-depends:
a2217 1
		${_flavor_fragment}; \
d2219 5
a2223 1
		eval $$toset ${MAKE} ${_DEPEND_THRU} _recurse-lib-depends; \
d2230 5
a2234 2
		${_flavor_fragment}; \
		eval $$toset ${MAKE} ${_DEPEND_THRU} _recurse-lib-depends; \
d2238 4
a2241 2
package-depends:
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
d2243 2
a2244 2
	for dir in `echo ${_ALWAYS_DEP} ${_RUN_DEP} \
		| tr '\040' '\012' | sort -u`; do \
d2246 14
a2259 10
		if ! eval $$toset ${MAKE} recurse-package-depends ${_DEPEND_THRU}; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"." ; \
			exit 1; \
		fi; \
	done
.endif

# recursively build a list of dirs to pass to tsort...
_recurse-dir-depends:
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || !empty(_RUN_DEP)
d2261 2
a2262 4
	for dir in `echo ${_ALWAYS_DEP} ${_BUILD_DEP} ${_RUN_DEP} \
		| tr '\040' '\012' | sort -u`; do \
		echo "$$self $$dir"; \
		self2="$$dir"; \
d2264 8
a2271 4
		toset="$$toset self=\"$$self2\""; \
		if ! eval $$toset ${MAKE} _recurse-dir-depends ${_DEPEND_THRU}; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
			exit 1; \
d2273 27
a2299 1
	done
d2302 3
a2304 3
# recursively build a list of dirs to pass to tsort...
dir-depends:
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP)
d2306 4
a2309 4
	for dir in `echo ${_ALWAYS_DEP} ${_BUILD_DEP} \
		| tr '\040' '\012' | sort -u`; do \
		echo "${FULLPKGPATH} $$dir"; \
		self2="$$dir"; \
d2311 2
a2312 2
		toset="$$toset self=\"$$self2\""; \
		if ! eval $$toset ${MAKE} _recurse-dir-depends ${_DEPEND_THRU}; then  \
d2316 10
a2325 1
	done
d2330 4
a2333 3
.for _i in RUN BUILD LIB
${_i:L}-depends-list:
.  if !empty(_${_i}_DEP2)
d2335 4
a2338 20
	: $${_INITIAL_ECHO:='echo -n "This port requires \""'}; \
	: $${_ECHO='echo -n'}; \
	: $${_FINAL_ECHO:='echo "\" for ${_i:L}."'}; space=''; \
	eval $${_INITIAL_ECHO}; \
	for spec in `echo '${_${_i}_DEP2}' \
		| tr '\040' '\012' | sort -u`; do \
		$${_ECHO} "$$space$${spec}"; \
		space=' '; \
	done; eval $${_FINAL_ECHO}
.  endif
.endfor

# recursively build a list of dirs to pass to tsort...
_package-recurse-dir-depends:
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
	@@unset FLAVOR SUBPACKAGE || true; \
	for dir in `echo ${_ALWAYS_DEP} ${_RUN_DEP} \
		| tr '\040' '\012' | sort -u`; do \
		echo "$$self $$dir"; \
		self2="$$dir"; \
d2340 2
a2341 2
		toset="$$toset self=\"$$self2\""; \
		if ! eval $$toset ${MAKE} _package-recurse-dir-depends ${_DEPEND_THRU}; then  \
d2345 2
a2346 2
	done
.endif
d2348 3
a2350 3
# recursively build a list of dirs to pass to tsort...
package-dir-depends:
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
d2352 4
a2355 4
	for dir in `echo ${_ALWAYS_DEP} ${_RUN_DEP} \
		| tr '\040' '\012' | sort -u`; do \
		echo "${FULLPKGPATH} $$dir"; \
		self2="$$dir"; \
d2357 2
a2358 2
		toset="$$toset self=\"$$self2\""; \
		if ! eval $$toset ${MAKE} _package-recurse-dir-depends ${_DEPEND_THRU}; then  \
d2362 10
a2371 1
	done
d2376 9
a2384 58
_solve-package-depends:
.if !empty(_RUN_DEP2)
	@@unset FLAVOR SUBPACKAGE || true; \
	: $${self:=self}; \
	for spec in `echo '${_RUN_DEP2}' \
		| tr '\040' '\012' | sort -u`; do \
		dir=$${spec#*:}; pkg=$${spec%:*}; \
		${_flavor_fragment}; \
		default=`eval $$toset ${MAKE} _print-packagename`; \
		: $${pkg:=$$default}; \
		echo "@@newdepend $$self:$$pkg:$$default" >>$${_depends_result}; \
		toset="$$toset self=\"$$default\""; \
		if ! eval $$toset ${MAKE} _solve-package-depends; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"." ; \
			exit 1; \
		fi; \
	done
.endif
.if !defined(NO_SHARED_LIBS) && defined(LIB_DEPENDS) && !empty(LIB_DEPENDS)
.  for _i in ${LIB_DEPENDS}
	@@unset FLAVOR SUBPACKAGE || true; \
	: $${self:=self}; \
		echo '${_i}'|{ \
			IFS=:; read dep pkg dir target; \
			${_flavor_fragment}; \
			libspecs='';comma=''; \
			default=`eval $$toset ${MAKE} _print-packagename`; \
			case "X$$pkg" in X) pkg=`echo $$default|sed -e 's,-[0-9].*,-*,'`;; esac; \
			if pkg dependencies check $$pkg; then \
				listlibs='ls $$shdir 2>/dev/null'; \
			else \
				eval $$toset ${MAKE} ${PKGREPOSITORY}/$$default.tgz; \
				listlibs='pkg_info -L ${PKGREPOSITORY}/$$default.tgz|grep $$shdir|sed -e "s,^$$shdir/,,"'; \
			fi; \
			IFS=,; for d in $$dep; do \
				${_libresolve_fragment}; \
				case "$$check" in \
				*.a) continue;; \
				Missing\ library|Error:*) \
					echo 1>&2 "Can't resolve libspec $$d"; \
					exit 1;; \
				*) \
					libspecs="$$libspecs$$comma$$shprefix$$check"; \
					comma=',';; \
				esac; \
			done; \
			case "X$$libspecs" in \
			X) ;;\
			*) \
				echo "@@libdepend $$self:$$libspecs:$$pkg:$$default" >>$${_depends_result}; \
				toset="$$toset self=\"$$default\""; \
				if ! eval $$toset ${MAKE} _solve-package-depends; then  \
					echo 1>&2 "*** Problem checking deps in \"$$dir\"." ; \
					exit 1; \
				fi;; \
			esac; \
		}
.  endfor
a2386 11
README_NAME?=	${TEMPLATES}/README.port

readme readmes:
	@@rm -f README.html
	@@cd ${.CURDIR} && exec ${MAKE} README_NAME=${README_NAME} README.html

HTMLIFY=	sed -e 's/&/\&amp;/g' -e 's/>/\&gt;/g' -e 's/</\&lt;/g'

print-depends:
	@@cd ${.CURDIR} && exec ${MAKE} FULL_PACKAGE_NAME=Yes print-depends-list print-package-depends

d2420 32
d2463 35
a2497 21
   addsum all build build-depends regress regress-depends checkpatch \
   checksum clean clean-depends configure deinstall \
   delete-package delete-package-links depends depends-list \
   describe distclean do-build do-configure do-extract \
   do-fetch do-install do-package do-patch extract list-distfiles \
   fetch install lib-depends makesum \
   package package-depends package-links package-name \
   package-noinstall patch plist update-plist update-patches post-build \
   post-configure post-extract post-fetch post-install post-package \
   post-patch pre-build pre-configure \
   pre-extract pre-fetch pre-install pre-package pre-patch \
   print-depends-list print-package-depends readme \
   readmes rebuild reinstall \
   repackage run-depends uninstall fetch-all print-depends \
   recurse-build-depends recurse-package-depends \
   distpatch do-distpatch post-distpatch show \
   link-categories unlink-categories _package _solve-package-depends \
   dir-depends _recurse-dir-depends package-dir-depends \
   _package-recurse-dir-depends recursebuild-depends-list run-depends-list \
   _recurse-lib-depends lib-depends-check \
   homepage-links manpages-check unconfigure
@


1.14
log
@rename NO_CXX_INSTALLED to NO_CXX and change semantics:
if NO_CXX_INSTALLED is defined, signal that no c++ compiler is installed
if NO_CXX is defined, additionally don't compile the in-tree g++
@
text
@d1 2
a2 2
#	$MirBSD: bsd.port.mk,v 1.13 2003/07/19 17:45:43 tg Exp $
#	$OpenBSD: bsd.port.mk,v 1.559 2003/07/18 19:02:13 espie Exp $
a39 3
# DEPENDS		- A list of other ports this package depends on being
#				  made first.
#
d394 2
a395 3
${_WRKDIR_COOKIE} ${_DEPlib_COOKIES} ${_DEPmisc_COOKIES} \
${_DEPfetch_COOKIES} ${_DEPbuild_COOKIES} ${_DEPrun_COOKIES} \
${_DEPregress_COOKIES}
d449 2
a450 2
PATCH_ARGS?=	-d ${WRKDIST} -b ${PATCHORIG} -E ${PATCH_STRIP}
PATCH_DIST_ARGS?=	-b ${DISTORIG} -d ${WRKDIST} -E ${PATCH_DIST_STRIP}
d452 2
a453 2
PATCH_ARGS?=	-d ${WRKDIST} -b ${PATCHORIG} --forward --quiet -E ${PATCH_STRIP}
PATCH_DIST_ARGS?=	-b ${DISTORIG} -d ${WRKDIST} --forward --quiet -E ${PATCH_DIST_STRIP}
d938 14
d1100 1
a1100 1
_fetch_depends_fragment= \
d1104 2
a1105 4

_build_depends_fragment=${_fetch_depends_fragment}
_run_depends_fragment=${_fetch_depends_fragment}
_regress_depends_fragment=${_fetch_depends_fragment}
d1136 1
a1136 9
_misc_depends_fragment = :

depends: lib-depends misc-depends fetch-depends build-depends run-depends\
	regress-depends

# Let DEPENDS behave like the others
.if defined(DEPENDS)
MISC_DEPENDS=${DEPENDS:S/^/nonexistent::/}
.endif
d1143 1
a1143 1
.for _DEP in fetch build run lib misc regress
d1273 1
a1273 1
fetch: fetch-depends
d1383 1
a1383 1
patch: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} ${_DEPmisc_COOKIES} \
d1385 1
a1385 1
distpatch: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} ${_DEPmisc_COOKIES} \
d1387 1
a1387 1
configure: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} ${_DEPmisc_COOKIES} \
d1389 1
a1389 1
all build: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} ${_DEPmisc_COOKIES} \
d1429 1
a1429 1
	@@cd ${.CURDIR} && exec ${MAKE} checksum build-depends lib-depends misc-depends
d1765 6
d1784 1
d2051 2
a2052 4
.if defined(LIB_DEPENDS) || defined(MISC_DEPENDS)
_ALWAYS_DEP2 = ${LIB_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/} \
	${MISC_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_ALWAYS_DEP3 = ${MISC_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
a2054 1
_ALWAYS_DEP3=
d2068 2
a2069 3
.if defined(FETCH_DEPENDS) || defined(BUILD_DEPENDS)
_BUILD_DEP2 = ${FETCH_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/} \
	${BUILD_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
a2076 2
_RUN_DEP2+= ${_ALWAYS_DEP3}
_BUILD_DEP2+=${_ALWAYS_DEP3}
d2078 1
a2078 1
clean-depends:
d2081 6
a2086 5
	for dir in \
	   `echo ${_ALWAYS_DEP} ${_BUILD_DEP} ${_RUN_DEP} \
		| tr '\040' '\012' | sort -u`; do \
		${_flavor_fragment}; \
		eval $$toset ${MAKE} CLEANDEPENDS=No ${_DEPEND_THRU} clean clean-depends; \
d2090 8
d2519 2
a2520 2
   fetch fetch-depends install lib-depends makesum \
   misc-depends package package-depends package-links package-name \
@


1.13
log
@merge import
@
text
@d1 1
a1 1
#	$MirBSD: bsd.port.mk,v 1.12 2003/07/19 14:17:57 tg Exp $
d971 1
a971 1
.  elif ${USE_CXX:L} == "yes" && defined(NO_CXX_INSTALLED)
@


1.12
log
@back out systrace-for-ports-builds for now
reasons:
a) update ready
b) maybe integrated by openbsd?
c) eases updates of bsd.port.mk that crazy espie does now
@
text
@d1 2
a2 4
#-*- mode: Fundamental; tab-width: 4; -*-
# ex:ts=4 sw=4 filetype=make:
#	$MirBSD: bsd.port.mk,v 1.11 2003/07/15 13:57:00 tg Exp $
#	$OpenBSD: bsd.port.mk,v 1.554 2003/07/14 14:08:57 espie Exp $
d11 1
a11 1
# To obtain that address, just type 
d14 1
a14 1
# 
d18 1
a18 1
# Enquiries as to the bsd.port.mk framework should usually be directed 
d32 3
a34 3
# Any variable or target starting with an underscore (e.g., _DEPEND_ECHO) 
# is internal to bsd.port.mk, not part of the user's API, and liable to 
# change without notice. 
a37 2
# RESTRICTED	- Port is restricted.  Set this string to the reason why.
#
d41 1
a41 1
#				  made first.  
a48 16
#
# It is assumed that the port installs manpages uncompressed. If this is
# not the case, set MANCOMPRESSED in the port and define MAN<sect> and
# CAT<sect> for the compressed pages.  The pages will then be automatically
# uncompressed.
#
# MANCOMPRESSED - Indicates that the port installs manpages in a compressed
#                 form (default: port installs manpages uncompressed).
# MAN<sect>		- A list of manpages, categorized by section.  For
#				  example, if your port has "man/man1/foo.1" and
#				  "man/mann/bar.n", set "MAN1=foo.1" and "MANN=bar.n".
#				  The available sections chars are "123456789LN".
# CAT<sect>     - The same as MAN<sect>, only for formatted manpages.
# MANPREFIX		 -The directory prefix for ${MAN<sect>} (default: ${PREFIX}).
# CATPREFIX     - The directory prefix for ${CAT<sect>} (default: ${PREFIX}).
#
d73 1
a73 1
# The sequence of hooks actually run is: 
a132 5
# Compatibility kludge for old scripts
.if defined(NOCLEANDEPENDS)
.  if ${NOCLEANDEPENDS:L} == "no"
CLEANDEPENDS?=Yes
.  else
d134 1
a134 4
.  endif
.else
CLEANDEPENDS?=No
.endif
d173 1
a173 1
PACKAGES?=		${PORTSDIR}/packages/${MACHINE_ARCH}
d176 2
a177 2
CDROM_PACKAGES?=	${PORTSDIR}/cdrom-packages/${MACHINE_ARCH}
FTP_PACKAGES?=		${PORTSDIR}/ftp-packages/${MACHINE_ARCH}
a342 1
PKGREPOSITORYSUBDIR?=	All
d344 1
a344 1
PKGREPOSITORY?=		${PACKAGES}/${PKGREPOSITORYSUBDIR}
d409 1
a409 1
_CIPHERS=		sha1 rmd160 md5 
d702 1
a702 1
PKG_ARGS+=-f ${WRKPKG}/PLIST${SUBPACKAGE} -p ${PREFIX} 
d870 1
a870 1
.endif 
d874 1
a874 1
EXTRACT_CASES?= 
a939 24
.if ${FAKE:L} == "yes"
MANPREFIX?=  ${WRKINST}${TRUEPREFIX}
CATPREFIX?=  ${WRKINST}${TRUEPREFIX}
.endif

.for sect in 1 2 3 4 5 6 7 8 9 L N
MAN${sect}PREFIX?=	${MANPREFIX}
CAT${sect}PREFIX?=	${CATPREFIX}
.endfor

MANLANG?=	""	# english only by default

.for lang in ${MANLANG}

.  for sect in 1 2 3 4 5 6 7 8 9 L N
.    if defined(MAN${sect})
_MANPAGES+=	${MAN${sect}:S%^%${MAN${sect}PREFIX}/man/${lang}/man${sect:L}/%}
.    endif
.    if defined(CAT${sect})
_CATPAGES+=	${CAT${sect}:S%^%${CAT${sect}PREFIX}/man/${lang}/cat${sect:L}/%}
.    endif
.  endfor
.endfor

a953 3
# Don't build a port if it's restricted and we don't want to get
# into that.
#
a968 2
.  elif (defined(RESTRICTED) && defined(NO_RESTRICTED))
IGNORE=	"is restricted: ${RESTRICTED}"
d1013 1
a1013 1
.if !defined(NO_CHECKSUM) 
d1022 1
a1022 1
	@@sort -u -o ${CHECKSUM_FILE} ${CHECKSUM_FILE} 
d1036 1
a1036 1
	@@sort -u -o ${CHECKSUM_FILE} ${CHECKSUM_FILE} 
d1200 1
a1200 1
# Do a brute-force ldd/objdump on all files under WRKINST. 
d1242 1
a1242 1
.else 
d1266 1
a1266 1
# 
d1409 1
a1409 1
BULK_TARGETS?= ftp-packages cdrom-packages
d1428 1
a1428 1
${_EXTRACT_COOKIE}: ${_WRKDIR_COOKIE} 
d1509 1
a1509 1
.  if target(do-distpatch) || target(post-distpatch) || defined(PATCHFILES) 
d1511 1
a1511 1
.  endif 
d1610 1
a1610 1
	echo ""; 
a1688 20
.  if defined(_MANPAGES) || defined(_CATPAGES)
.    if defined(MANCOMPRESSED) && defined(NOMANCOMPRESS)
	@@${ECHO_MSG} "===>   Uncompressing manual pages for ${FULLPKGNAME}${_MASTER}"
.      for manpage in ${_MANPAGES} ${_CATPAGES}
	@@${SUDO} ${GUNZIP_CMD} ${manpage}.gz
.      endfor
.    elif !defined(MANCOMPRESSED) && !defined(NOMANCOMPRESS)
	@@${ECHO_MSG} "===>   Compressing manual pages for ${FULLPKGNAME}${_MASTER}"
.      for manpage in ${_MANPAGES} ${_CATPAGES}
	@@if [ -L ${manpage} ]; then \
		set - `file ${manpage}`; \
		shift `expr $$# - 1`; \
		${SUDO} ln -sf $${1}.gz ${manpage}.gz; \
		${SUDO} rm ${manpage}; \
	else \
		${SUDO} ${GZIP_CMD} ${manpage}; \
	fi
.      endfor
.    endif
.  endif
d1718 1
a1718 1
.endif 
d1749 1
a1749 1
	    ${SUDO} ${MAKE} delete-package; \
a1757 1
.if !target(fetch-all)
a1759 1
.endif
a1779 32
# Invoke "make cdrom-packages CDROM_PACKAGES=/cdrom/snapshots/packages"
# Invoke "make ftp-packages FTP_PACKAGES=/pub/OpenBSD/snapshots/packages"

.for _l in FTP CDROM

.  if ${PERMIT_PACKAGE_${_l}:L} == "yes" && !defined(IGNORE)
${_l:L}-packages: ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
.  else
${_l:L}-packages:
.  endif
.  if defined(MULTI_PACKAGES) && empty(SUBPACKAGE)
.    for _sub in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' exec ${MAKE} ${.TARGET}
.    endfor
.  endif

${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}: ${_PACKAGE_COOKIE${SUBPACKAGE}}
.    if ${PERMIT_PACKAGE_${_l}:L} == "yes"
	@@mkdir -p ${${_l}_PACKAGES}
	@@rm -f ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
	@@ln ${PKGFILE${SUBPACKAGE}} \
	  ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX} 2>/dev/null || \
	  cp -p ${PKGFILE${SUBPACKAGE}} \
	  ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
.    else
	@@echo 1>&2 "Internal error: ${_l:L}-packages for a forbidden file ?"
	@@false
.    endif

.endfor


a1795 7
# Obj
#
.if !target(obj)
obj:
.endif


a1797 1
.if !target(package-links)
d1800 11
a1810 11
	@@for cat in ${CATEGORIES}; do \
		if [ ! -d ${PACKAGES}/$$cat ]; then \
			if ! mkdir -p ${PACKAGES}/$$cat; then \
				echo ">> Can't create directory ${PACKAGES}/$$cat."; \
				exit 1; \
			fi; \
		fi; \
		case $$cat in */*/*) parent=../../..;; */*) parent=../..;; *) parent=..;; esac; \
		ln -s $$parent/${PKGREPOSITORYSUBDIR}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX} ${PACKAGES}/$$cat; \
	done;
.endif
a1811 1
.if !target(delete-package-links)
d1813 3
a1815 2
	@@cd ${PACKAGES} && find . -type l -name ${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}|xargs rm -f
.endif
a1816 1
.if !target(delete-package)
d1818 1
a1818 3
	@@cd ${.CURDIR} && exec ${MAKE} delete-package-links
	@@rm -f ${PKGFILE${SUBPACKAGE}}
.endif
a1823 1
.if !target(checkpatch)
a1825 1
.endif
d1862 2
a1863 3
.if !target(clean)
clean: 
.  if ${clean:L:Mdepends}
d1865 1
a1865 1
.  endif
d1867 1
a1867 1
.  if ${clean:L:Mfake}
d1869 3
a1871 3
.  endif
.  if ${clean:L:Mwork}
.    if ${clean:L:Mflavors}
d1876 1
a1876 1
.    else
a1878 1
.    endif 
d1880 2
a1881 1
.  if ${clean:L:Mdist}
d1888 2
a1889 3
.    if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
	-@@rmdir ${FULLDISTDIR}  
.    endif
d1891 4
a1894 3
.  if ${clean:L:Minstall}
.    if ${clean:L:Msub}
.	   for _s in ${MULTI_PACKAGES}
d1896 2
a1897 2
.      endfor
.    else
a1898 1
.    endif
d1900 2
a1901 1
.  if ${clean:L:Mpackages} || ${clean:L:Mpackage} && ${clean:L:Msub}
d1903 7
a1909 1
.  elif ${clean:L:Mpackage}
d1911 2
a1912 2
.  endif
.  if ${clean:L:Mbulk}
a1913 1
.  endif
d1916 1
a1916 1
distclean: 
d1953 1
a1953 1
	
a2024 1
	
d2026 2
a2027 1
# The README.html target needs full information (this is passed via 
d2040 1
a2040 1
.  endif 
d2042 1
a2042 1
# Internal variables, used by dependencies targets 
a2076 1
.if !target(clean-depends)
d2078 1
a2078 1
.  if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || !empty(_RUN_DEP)
a2085 1
.  endif
d2173 1
a2173 1
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || target(depends-list)
d2176 1
a2176 1
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP) || target(package-depends)
a2204 1
.if !target(print-depends-list)
d2206 1
a2206 1
.  if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || target(depends-list)
a2210 1
.  endif
a2212 1
.if !target(print-package-depends)
d2214 1
a2214 1
.  if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP) || target(package-depends)
a2218 1
.  endif
a2221 1
.if !target(recurse-build-depends)
d2223 1
a2223 1
.  if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || !empty(_RUN_DEP)
d2233 2
a2234 2
	done 
.  else
a2235 1
.  endif
a2237 1
.if !target(depends-list)
d2239 1
a2239 1
.  if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP)
d2248 1
a2248 2
	done 
.  endif
a2251 1
.if !target(recurse-package-depends)
d2253 1
a2253 1
.  if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
d2264 1
a2264 1
.  else
a2265 1
.  endif
a2287 1
.if !target(package-depends)
d2289 1
a2289 1
.  if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
a2298 1
.  endif
d2315 1
a2315 1
	done 
d2332 1
a2332 1
	done 
d2367 1
a2367 1
	done 
d2384 1
a2384 1
	done 
d2451 1
a2451 6
.if !target(readmes)
readmes:	readme
.endif

.if !target(readme)
readme:
a2453 2
.endif

d2457 1
a2457 2
.if !target(print-depends)
print-depends: 
a2458 14
.endif

# Depend is generally meaningless for arbitrary ports, but if someone wants
# one they can override this.  This is just to catch people who've gotten into
# the habit of typing `make depend all install' as a matter of course.
#
.if !target(depend)
depend:
.endif

# Same goes for tags
.if !target(tags)
tags:
.endif
d2481 1
a2481 1
    
d2506 1
a2506 1
   delete-package delete-package-links depend depends depends-list \
a2509 1
   cdrom-packages ftp-packages \
d2517 1
a2517 1
   repackage run-depends tags uninstall fetch-all print-depends \
d2519 1
a2519 1
   distpatch real-distpatch do-distpatch post-distpatch show \
@


1.11
log
@merge openbsd ports tree stuff
@
text
@d3 1
a3 1
#	$MirBSD: bsd.port.mk,v 1.10 2003/07/15 12:07:26 tg Exp $
a394 1
_SYSTRACE_COOKIE=	${WRKDIR}/systrace.policy
a622 24
# setup systrace
USE_SYSTRACE?=	No
.if ${USE_SYSTRACE:L} == "yes"
SYSTRACE_PROGRAM?=/bin/systrace
SYSTRACE_FLAGS?=-i -a -f ${_SYSTRACE_COOKIE}
.else
SYSTRACE_PROGRAM=
SYSTRACE_FLAGS=
.endif
ST_DENY?=
ST_PERMIT?=	${PORTSDIR}/infrastructure/db/systrace.permit
ST_POLICIES+=	/usr/bin/env /usr/bin/make ${LOCALBASE}/bin/gmake
ST_SUBST_VARS+=	WRKOBJDIR PORTSDIR DISTDIR
.for _v in ${ST_SUBST_VARS}
_ST_SED_SUBST+=-e 's,$${${_v}},${${_v}},g'
.endfor

${_SYSTRACE_COOKIE}:
	@@rm -f $@@
.for _i in ${ST_POLICIES}
	@@echo "Policy: ${_i}, Emulation: native" >> $@@
	@@sed ${_ST_SED_SUBST} ${ST_PERMIT} ${ST_DENY} >> $@@
.endfor

d931 1
a931 1
MAINTAINER?=	former: The OpenBSD ports mailing-list <ports@@openbsd.org>
d1486 1
a1486 1
${_EXTRACT_COOKIE}: ${_WRKDIR_COOKIE} ${_SYSTRACE_COOKIE}
d1490 1
a1490 1
	@@cd ${.CURDIR} && exec ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${MAKE} pre-extract
d1493 1
a1493 1
	@@cd ${.CURDIR} && exec ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${MAKE} do-extract
d1505 1
a1505 1
	@@cd ${.CURDIR} && exec ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${MAKE} post-extract
d1515 1
a1515 1
	@@cd ${.CURDIR} && exec ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${MAKE} pre-patch
d1549 1
a1549 1
	@@cd ${.CURDIR} && exec ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${MAKE} post-distpatch
d1563 1
a1563 1
	@@cd ${.CURDIR} && exec ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${MAKE} do-patch
d1600 1
a1600 1
	@@cd ${.CURDIR} && exec ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${MAKE} post-patch
d1613 1
a1613 2
	cd ${WRKBUILD} && ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${SETENV} \
		CC="${CC}" ac_cv_path_CC="${CC}" CFLAGS="${CFLAGS}" \
d1628 1
a1628 1
	@@cd ${.CURDIR} && exec ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${MAKE} pre-configure
d1631 1
a1631 1
	@@cd ${.CURDIR} && exec ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${MAKE} do-configure
d1635 2
a1636 2
		cd ${.CURDIR} &&  ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${SETENV} \
		    ${SCRIPTS_ENV} ${SH} ${SCRIPTDIR}/configure; \
d1646 1
a1646 1
	@@cd ${.CURDIR} && exec ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${MAKE} post-configure
d1671 1
a1671 1
	@@cd ${.CURDIR} && exec ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${MAKE} pre-build
d1674 1
a1674 1
	@@cd ${.CURDIR} && exec ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${MAKE} do-build
d1677 1
a1677 1
	@@cd ${WRKBUILD} && exec ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} -f ${MAKE_FILE} ${ALL_TARGET}
d1681 1
a1681 1
	@@cd ${.CURDIR} && exec ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${MAKE} post-build
d1731 1
a1731 1
	@@cd ${.CURDIR} && exec ${SUDO} ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${MAKE} pre-fake ${_FAKE_SETUP}
d1735 1
a1735 1
	@@cd ${.CURDIR} && exec ${SUDO} ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${MAKE} pre-install ${_FAKE_SETUP}
d1738 1
a1738 1
	@@cd ${.CURDIR} && exec ${SUDO} ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${MAKE} do-install ${_FAKE_SETUP}
d1741 1
a1741 1
	@@cd ${WRKBUILD} && exec ${SUDO} ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${SETENV} ${MAKE_ENV} ${_FAKE_SETUP} ${MAKE_PROGRAM} ${FAKE_FLAGS} -f ${MAKE_FILE} ${FAKE_TARGET}
d1745 1
a1745 1
	@@cd ${.CURDIR} && exec ${SUDO} ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${MAKE} post-install ${_FAKE_SETUP}
@


1.10
log
@add (broken) (uses X11) (uses C++) to package descriptions in make index
@
text
@d3 2
a4 2
#	$MirBSD: bsd.port.mk,v 1.9 2003/07/15 11:54:13 tg Exp $
#	$OpenBSD: bsd.port.mk,v 1.548 2003/07/09 11:16:21 espie Exp $
d14 1
a14 1
#	make show VARNAME=MAINTAINER
d31 2
a32 3
# There is a transition in progress. When the dust settles, 
# the definitive source of documentation to this file's working
# should be bsd.port.mk(5).
d34 3
a36 2
# All redundant documentation is being stripped, refer to bsd.port.mk(5),
# really !
a37 3
# IMPORTANT: any variable or target starting with an underscore 
# (e.g., _DEPEND_ECHO) is internal to bsd.port.mk, and 
# liable to change without notice. 
a38 14
# DON'T USE IN INDIVIDUAL PORTS !!!
#
# Some variables that typically apply to all ports:
# 
# MASTER_SITES	- Primary location(s) for distribution files if not found
#				  locally.
# MASTER_SITESn	- Primary location(s) for more distribution files, in case
#				  some distfiles must be fetched from elsewhere.
#
# Some variables that typically apply to an individual port.  Non-Boolean
# variables without defaults are *mandatory*.
#
# NO_DESCRIBE	- Use a dummy (do-nothing) describe target.
# NO_PACKAGE	- Use a dummy (do-nothing) package target.
a39 1
# BROKEN		- Port is broken.  Set this string to the reason why.
a41 2
# PKG_DBDIR		- Where package installation is recorded (default: /var/db/pkg)
#
a46 19
# FETCH_BEFORE_ARGS -
#				  Arguments to ${FETCH_CMD} before filename (default: none).
# FETCH_AFTER_ARGS -
#				  Arguments to ${FETCH_CMD} following filename (default: none).
# NO_IGNORE     - Set this to Yes (most probably in a "make fetch" in
#                 ${PORTSDIR}) if you want to fetch all distfiles,
#                 even for packages not built due to limitation by
#                 absent X or ONLY_FOR_ARCHS...
# NO_WARNINGS	- Set this to Yes to disable warnings regarding variables
#				  to define to control the build.  Automatically set
#				  from the "mirror-distfiles" target.
#
# Motif support:
#
# USE_MOTIF		- Set this to "any" for ports that work with lesstif or
#				  openmotif (automatic flavoring), "openmotif" for ports
#				  that require openmotif, "lesstif" for ports that require
#				  lesstif. "any" will create an extra hidden lesstif
#				  FLAVOR, beware in flavor tests.
a68 18
# Other variables:
#
# Some targets and their behaviors:
#
# package	    - Build package from the fake installation.
# install       - Install the resulting package.
#
# Note that `fake' uses {pre,do,post}-install for its own dark purposes.
# There is also a special pre-fake target that gets run after mtree but
# before making the INSTALL_PRECOOKIE, to finish setting up the fake tree.
#
# describe		- Try to generate a one-line description for each port for
#				  use in INDEX files and the like.
# checkpatch	- Do a "patch -C" instead of a "patch".  Note that it may
#				  give incorrect results if multiple patches deal with
#				  the same file.
# obj			- pre-build ${WRKDIR} -> ${WRKOBJDIR}/${PKGPATH} links
#
a119 1
VARNAME=${show}
d121 2
a301 1
HAVE_MOTIF?=No
a623 6
# The user can override the NO_PACKAGE by specifying this from
# the make command line
.if defined(FORCE_PACKAGE)
.undef NO_PACKAGE
.endif

a647 1

d652 1
a652 1
_SED_SUBST+=-e 's,$${${_v}},${${_v}},g'
d890 1
a890 1
CKSUMFILES=
d893 2
a894 2
.  if empty(CKSUMFILES:M${_file})
CKSUMFILES+=${_file}
d897 1
a897 1
ALLFILES:=${CKSUMFILES}
d901 1
a901 1
CKSUMFILES:=${CKSUMFILES:N${_file}}
d907 1
a907 1
_CKSUMFILES=	${CKSUMFILES:S/^/${DIST_SUBDIR}\//}
d910 1
a910 1
_CKSUMFILES=	${CKSUMFILES}
d1662 1
a1662 1
			${SCRIPTS_ENV} ${SH} ${SCRIPTDIR}/configure; \
d1827 6
a1832 7
.if !defined(NO_PACKAGE)
.  if target(pre-package)
	@@cd ${.CURDIR} && exec ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${MAKE} pre-package
.  endif
.  if target(do-package)
	@@cd ${.CURDIR} && exec ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${MAKE} do-package
.  else
d1857 3
a1859 8
.  endif
.  if target(post-package)
	@@cd ${.CURDIR} && exec ${SYSTRACE_PROGRAM} ${SYSTRACE_FLAGS} ${MAKE} post-package
.  endif
.else
.  if !defined(IGNORE_SILENT)
	@@${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}} may not be packaged: ${NO_PACKAGE}."
.  endif
d1864 1
a1864 1
	@@cd ${.CURDIR} && exec ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes NO_WARNINGS=Yes fetch
d1880 1
a1880 1
		if ${FETCH_CMD} ${FETCH_BEFORE_ARGS} $${site}$$f ${FETCH_AFTER_ARGS}; then \
d1983 1
a1983 1
	@@${SUDO} ${PKG_DELETE} -f ${FULLPKGNAME${SUBPACKAGE}}
d1986 5
a2012 4
.if !target(pre-clean)
pre-clean:
.endif

d2014 1
a2014 1
clean: pre-clean
d2063 1
a2063 6
.if !target(pre-distclean)
pre-distclean:
.endif

.if !target(distclean)
distclean: pre-distclean
a2064 1
.endif
d2124 1
a2124 1
	@@cd ${.CURDIR} && exec ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes NO_WARNINGS=Yes _fetch-makefile-helper
a2188 9
# Build a package but don't check the package cookie

.if !target(repackage)
repackage: pre-repackage package

pre-repackage:
	@@rm -f ${_PACKAGE_COOKIES}
.endif

d2258 1
a2258 2
.if !defined(NO_DESCRIBE) 
.  if !defined(PACKAGING) && defined(MULTI_PACKAGES)
d2260 1
a2260 1
.  else
d2262 1
a2262 1
.    if ${PREFIX} == ${LOCALBASE}
d2264 1
a2264 1
.    else
d2266 1
a2266 1
.    endif
d2274 2
a2275 2
.    for _d in LIB BUILD RUN
.      if !empty(_${_d}_DEP2)
d2277 1
a2277 1
.      endif
d2279 1
a2279 1
.    endfor
d2288 1
a2288 1
.    if defined(_BAD_LICENSING)
d2290 3
a2293 3
.      if ${PERMIT_PACKAGE_CDROM:L} == "yes"
	@@echo -n "y|"
.      else
d2295 2
a2296 2
.      endif
.      if ${PERMIT_PACKAGE_FTP:L} == "yes"
d2298 1
a2298 1
.      else
d2300 2
a2301 2
.      endif
.	   if ${PERMIT_DISTFILES_CDROM:L} == "yes"
d2303 1
a2303 1
.      else
d2305 2
a2306 2
.      endif
.	   if ${PERMIT_DISTFILES_FTP:L} == "yes"
d2308 1
a2308 1
.      else
a2309 1
.      endif
d2311 3
a2313 2
.    if defined(MULTI_PACKAGES) && empty(SUBPACKAGE)
.      for _sub in ${MULTI_PACKAGES}
d2315 1
a2315 2
.      endfor
.    endif
a2629 5
.if defined(VARNAME)
show:
	@@echo ${${VARNAME}:Q}
.endif

d2697 1
a2697 1
   post-patch pre-build pre-clean pre-configure pre-distclean \
d2699 1
a2699 1
   pre-repackage print-depends-list print-package-depends readme \
@


1.9
log
@use NO_CXX_INSTALLED
@
text
@d3 1
a3 1
#	$MirBSD: bsd.port.mk,v 1.8 2003/07/09 18:59:26 tg Exp $
d2328 13
d2352 1
a2352 1
	@@echo -n ${_COMMENT}"|"; \
@


1.8
log
@mop up, sweep clean
@
text
@d3 1
a3 1
#	$MirBSD: bsd.port.mk,v 1.7 2003/07/07 14:38:15 tg Exp $
d1083 1
d1118 2
@


1.7
log
@add systrace policy for ports builds
by Nikolay Sturm
@
text
@d3 2
a4 2
#	$MirBSD: bsd.port.mk,v 1.6 2003/05/22 13:28:24 tg Exp $
#	$OpenBSD: bsd.port.mk,v 1.545 2003/05/18 23:11:21 sturm Exp $
d44 1
a44 1
# Variables that typically apply to all ports:
d51 1
a51 1
# Variables that typically apply to an individual port.  Non-Boolean
a53 5
# COMES_WITH	- The first version that a port was made part of the
#				  standard OpenBSD distribution.  If the current OpenBSD
#				  version is >= this version then a notice will be
#				  displayed instead of the port being generated.
#
a61 2
# USE_X11		- Port uses X11.
#
d110 1
a110 1
# Default targets and their behaviors:
a111 12
# fetch			- Retrieves ${DISTFILES} (and ${PATCHFILES} if defined, and
#                 ${SUPDISTFILES} if needed) into ${DISTDIR} as necessary.
# extract		- Unpacks ${EXTRACT_ONLY} (${DISTFILES} by default)
#                 into ${WRKDIR}.
# patch			- Apply any provided patches to the source.
# distpatch     - Intermediate patch target, apply only distribution patches.
# configure		- Runs either GNU configure, one or more local configure
#				  scripts or nothing, depending on what's available.
# build			- Actually compile the sources.
#
# If ${FAKE} == Yes
# fake			- Perform a fake installation into ${WRKINST}.
a118 2
# plist			- create a file suitable for use as a packing list.  This
#				  is for port maintainers.
a123 4
# checksum		- Use ${CHECKSUM_FILE} to ensure that your distfiles are valid.
# makesum		- Generate ${CHECKSUM_FILE} (only do this for your own ports!).
# addsum		- update ${CHECKSUM_FILE} in a non-destructive way 
#				  (your own ports only!)
a153 3
# For historical reasons, you shouldn't override pre-extract and
# do-extract. Rely on EXTRACT_ONLY and post-extract instead.

d713 1
a713 1
SUBST_VARS+=MACHINE_ARCH ARCH HOMEPAGE PREFIX SYSCONFDIR FLAVOR_EXT
d802 1
d1489 1
a1489 1
		  	cd ${.CURDIR} && ${MAKE} refetch PROBLEMS="$$list"; \
d1502 1
a1502 1
.  for file cipher value in ${PROBLEMS}
@


1.6
log
@merge CVS import conflicts
@
text
@d3 1
a3 1
#	$MirBSD: bsd.port.mk,v 1.5 2003/04/10 20:09:15 tg Exp $
d480 1
d715 24
d1599 1
a1599 1
${_EXTRACT_COOKIE}: ${_WRKDIR_COOKIE} 
d1603 1
a1603 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-extract
d1606 1
a1606 1
	@@cd ${.CURDIR} && exec ${MAKE} do-extract
d1618 1
a1618 1
	@@cd ${.CURDIR} && exec ${MAKE} post-extract
d1628 1
a1628 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-patch
d1662 1
a1662 1
	@@cd ${.CURDIR} && exec ${MAKE} post-distpatch
d1676 1
a1676 1
	@@cd ${.CURDIR} && exec ${MAKE} do-patch
d1713 1
a1713 1
	@@cd ${.CURDIR} && exec ${MAKE} post-patch
d1726 2
a1727 1
	cd ${WRKBUILD} && CC="${CC}" ac_cv_path_CC="${CC}" CFLAGS="${CFLAGS}" \
d1742 1
a1742 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-configure
d1745 1
a1745 1
	@@cd ${.CURDIR} && exec ${MAKE} do-configure
d1749 2
a1750 2
		cd ${.CURDIR} && ${SETENV} ${SCRIPTS_ENV} ${SH} \
		  ${SCRIPTDIR}/configure; \
d1760 1
a1760 1
	@@cd ${.CURDIR} && exec ${MAKE} post-configure
d1785 1
a1785 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-build
d1788 1
a1788 1
	@@cd ${.CURDIR} && exec ${MAKE} do-build
d1791 1
a1791 1
	@@cd ${WRKBUILD} && exec ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} -f ${MAKE_FILE} ${ALL_TARGET}
d1795 1
a1795 1
	@@cd ${.CURDIR} && exec ${MAKE} post-build
d1845 1
a1845 1
	@@cd ${.CURDIR} && exec ${SUDO} ${MAKE} pre-fake ${_FAKE_SETUP}
d1849 1
a1849 1
	@@cd ${.CURDIR} && exec ${SUDO} ${MAKE} pre-install ${_FAKE_SETUP}
d1852 1
a1852 1
	@@cd ${.CURDIR} && exec ${SUDO} ${MAKE} do-install ${_FAKE_SETUP}
d1855 1
a1855 1
	@@cd ${WRKBUILD} && exec ${SUDO} ${SETENV} ${MAKE_ENV} ${_FAKE_SETUP} ${MAKE_PROGRAM} ${FAKE_FLAGS} -f ${MAKE_FILE} ${FAKE_TARGET}
d1859 1
a1859 1
	@@cd ${.CURDIR} && exec ${SUDO} ${MAKE} post-install ${_FAKE_SETUP}
d1917 1
a1917 1
	@@cd ${.CURDIR} && exec ${MAKE} pre-package
d1920 1
a1920 1
	@@cd ${.CURDIR} && exec ${MAKE} do-package
d1948 1
a1948 1
	@@cd ${.CURDIR} && exec ${MAKE} post-package
@


1.5
log
@clean up the cvs import mess

nb, this doesnt mean the tree builds.
its bed time
@
text
@d3 2
a4 2
#	$MirBSD: bsd.port.mk,v 1.4 2003/04/08 17:07:37 tg Exp $
#	$OpenBSD: bsd.port.mk,v 1.544 2003/04/06 14:34:36 espie Exp $
d1867 1
a1867 1
	@@cd ${.CURDIR} && DEPENDS_TARGET=package exec ${MAKE} run-depends lib-depends
@


1.4
log
@helps a lot while testing - make unconfigure
@
text
@d3 2
a4 2
#	$MirBSD: bsd.port.mk,v 1.3 2003/03/23 15:44:06 tg Exp $
#	$OpenBSD: bsd.port.mk,v 1.543 2003/03/02 17:54:27 pvalchev Exp $
d357 1
d359 1
@


1.3
log
@For the sake of easiness, use _our_ cvs tag.
@
text
@d3 1
a3 1
#	$MirBSD: bsd.port.mk,v 1.2 2003/03/23 14:56:58 tg Exp $
d1539 2
d2782 1
a2782 1
   homepage-links manpages-check
@


1.2
log
@add misc. stuff from old:
- bnetd unbreakage
- bsd.port.mk variables
- cdrtools CC
- fetchmail no-kerberos
- mplayer make compile
- quake make compile
@
text
@d3 1
a3 1
#	$MirBSD$
d191 1
a191 1
ERRORS+="Please notify the OpenBSD port maintainer:"
d1020 1
a1020 1
MAINTAINER?=	The OpenBSD ports mailing-list <ports@@openbsd.org>
@


1.1
log
@Initial revision
@
text
@d3 1
d1703 1
a1703 1
		YACC="${YACC}" \
@


1.1.1.1
log
@Import OpenBSD 3.3 ports repository from CTM 3132 the first time
This continues opening an OpenBSD-mirabile (aka MirBSD) repository.

### MirBSD is:
# Copyright (c) 1982-2003 by Thorsten "mirabile" Glaser <x86@@ePost.de>
# Copyright  1968-2003  The authors of And contributors to UNIX, the
#       C Language, BSD/Berkeley Unix; 386BSD, NetBSD 1.1 and OpenBSD.
#
# Anyone who obtained a copy of this work is hereby permitted to freely use,
# distribute, modify, merge, sublicence, give away or sell it as long as the
# authors are given due credit and the following notice is retained:
#
# This work is provided "as is", with no explicit or implicit warranty what-
# soever. Use it only at your own risk. In no event may an author or contri-
# butor be held liable for any damage, directly or indirectly, that origina-
# ted through or is caused by creation or modification of this work.

MirBSD is my private tree. MirBSD does not differ very much from OpenBSD
and intentionally tracks OpenBSD. That's why it _is_ OpenBSD, just not the
official one. It's like with DarrenBSD.

At time of this writing, no advertising for MirBSD must be done,
because the advertising clause has not yet been sorted out.

http://templeofhate.com/tglaser/MirBSD/index.php
@
text
@@


1.1.1.2
log
@Import OpenBSD ports tree as of CTM 3188
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.544 2003/04/06 14:34:36 espie Exp $
a355 1
.  if !${CONFIGURE_STYLE:L:Mgnu}
a356 1
.  endif
@


1.1.1.3
log
@Import OpenBSD-current ports tree
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.545 2003/05/18 23:11:21 sturm Exp $
d1864 1
a1864 1
	@@cd ${.CURDIR} && DEPENDS_TARGET=install exec ${MAKE} run-depends lib-depends
@


1.1.1.4
log
@Bring the entire base system and ports tree in sync with OpenBSD
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.548 2003/07/09 11:16:21 espie Exp $
d43 1
a43 1
# Some variables that typically apply to all ports:
d50 1
a50 1
# Some variables that typically apply to an individual port.  Non-Boolean
d53 5
d66 2
d116 1
a116 1
# Some targets and their behaviors:
d118 12
d137 2
d144 4
d178 3
d715 1
a715 1
SUBST_VARS+=MACHINE_ARCH ARCH HOMEPAGE PREFIX SYSCONFDIR FLAVOR_EXT MAINTAINER
a803 1
	@@echo "\nMaintainer: ${MAINTAINER}" >>$@@
d1490 1
a1490 1
		  	cd ${.CURDIR} && ${MAKE} refetch _PROBLEMS="$$list"; \
d1503 1
a1503 1
.  for file cipher value in ${_PROBLEMS}
@


1.1.1.5
log
@Import OpenBSD ports tree as of today midday,
to get several minor updates and fixes, as well
as the new infrastructure patches
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.554 2003/07/14 14:08:57 espie Exp $
d13 1
a13 1
#	make show=MAINTAINER
d30 3
a32 2
# The definitive source of documentation to this file's user-visible parts
# is bsd.port.mk(5).
d34 2
a35 3
# Any variable or target starting with an underscore (e.g., _DEPEND_ECHO) 
# is internal to bsd.port.mk, not part of the user's API, and liable to 
# change without notice. 
d37 3
d41 14
d56 1
d59 2
d66 19
d107 18
d176 1
a177 2
show:
	@@echo ${${show}:Q}
d357 1
d679 7
d690 1
a690 1
_SED_SUBST+=-e 's|$${${_v}}|${${_v}}|g'
d928 1
a928 1
__CKSUMFILES=
d931 2
a932 2
.  if empty(__CKSUMFILES:M${_file})
__CKSUMFILES+=${_file}
d935 1
a935 1
ALLFILES:=${__CKSUMFILES}
d939 1
a939 1
__CKSUMFILES:=${__CKSUMFILES:N${_file}}
d945 1
a945 1
_CKSUMFILES=	${__CKSUMFILES:S/^/${DIST_SUBDIR}\//}
d948 1
a948 1
_CKSUMFILES=	${__CKSUMFILES}
d1859 2
a1860 1
.if target(pre-package)
d1862 2
a1863 2
.endif
.if target(do-package)
d1865 1
a1865 1
.else
d1890 2
a1891 2
.endif
.if target(post-package)
d1893 5
d1902 1
a1902 1
	@@cd ${.CURDIR} && exec ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes fetch
d1918 1
a1918 1
		if ${FETCH_CMD} $${site}$$f; then \
d2021 1
a2021 1
	@@cd ${.CURDIR} && exec ${MAKE} clean=install
a2023 5
# Force rebuild of a package
repackage:
	@@cd ${.CURDIR} && exec ${MAKE} clean=packages
	@@cd ${.CURDIR} && exec ${MAKE} package

d2046 4
d2051 1
a2051 1
clean: 
d2100 6
a2105 1
distclean: 
d2107 1
d2167 1
a2167 1
	@@cd ${.CURDIR} && exec ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes _fetch-makefile-helper
d2232 9
d2297 2
a2298 1
.if !defined(PACKAGING) && defined(MULTI_PACKAGES)
d2300 1
a2300 1
.else
d2302 1
a2302 1
.  if ${PREFIX} == ${LOCALBASE}
d2304 1
a2304 1
.  else
d2306 1
a2306 1
.  endif
d2314 2
a2315 2
.  for _d in LIB BUILD RUN
.    if !empty(_${_d}_DEP2)
d2317 1
a2317 1
.    endif
d2319 1
a2319 1
.  endfor
d2328 1
a2328 1
.  if defined(_BAD_LICENSING)
d2330 2
a2331 2
.  else
.    if ${PERMIT_PACKAGE_CDROM:L} == "yes"
d2333 1
a2333 1
.    else
d2335 2
a2336 2
.    endif
.    if ${PERMIT_PACKAGE_FTP:L} == "yes"
d2338 1
a2338 1
.    else
d2340 2
a2341 2
.    endif
.    if ${PERMIT_DISTFILES_CDROM:L} == "yes"
d2343 1
a2343 1
.    else
d2345 2
a2346 2
.    endif
.    if ${PERMIT_DISTFILES_FTP:L} == "yes"
d2348 1
a2348 1
.    else
d2350 1
d2352 2
a2353 3
.  endif
.  if defined(MULTI_PACKAGES) && empty(SUBPACKAGE)
.    for _sub in ${MULTI_PACKAGES}
d2355 2
a2356 1
.    endfor
d2671 5
d2743 1
a2743 1
   post-patch pre-build pre-configure \
d2745 1
a2745 1
   print-depends-list print-package-depends readme \
@


1.1.1.6
log
@Synchronize MirBSD ports tree with OpenBSD ports tree
Yields several updates and fixes, among them security ones
@
text
@d1 1
a1 1
#-*- mode: Makefile; tab-width: 4; -*-
d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.559 2003/07/18 19:02:13 espie Exp $
d12 1
a12 1
# To obtain that address, just type
d15 1
a15 1
#
d19 1
a19 1
# Enquiries as to the bsd.port.mk framework should usually be directed
d33 3
a35 3
# Any variable or target starting with an underscore (e.g., _DEPEND_ECHO)
# is internal to bsd.port.mk, not part of the user's API, and liable to
# change without notice.
d39 2
d44 1
a44 1
#				  made first.
d52 16
d92 1
a92 1
# The sequence of hooks actually run is:
d152 5
d158 4
a161 1

d200 1
a200 1
PKGREPOSITORYBASE?=	${PORTSDIR}/packages/${MACHINE_ARCH}
d203 2
a204 2
CDROM_PACKAGES?=	${PKGREPOSITORYBASE}/cdrom
FTP_PACKAGES?=		${PKGREPOSITORYBASE}/ftp
d370 1
d372 1
a372 1
PKGREPOSITORY?=		${PKGREPOSITORYBASE}/all
d437 1
a437 1
_CIPHERS=		sha1 rmd160 md5
d730 1
a730 1
PKG_ARGS+=-f ${WRKPKG}/PLIST${SUBPACKAGE} -p ${PREFIX}
d898 1
a898 1
.endif
d902 1
a902 1
EXTRACT_CASES?=
d968 24
d1005 3
d1023 2
d1067 1
a1067 1
.if !defined(NO_CHECKSUM)
d1076 1
a1076 1
	@@sort -u -o ${CHECKSUM_FILE} ${CHECKSUM_FILE}
d1090 1
a1090 1
	@@sort -u -o ${CHECKSUM_FILE} ${CHECKSUM_FILE}
d1254 1
a1254 1
# Do a brute-force ldd/objdump on all files under WRKINST.
d1296 1
a1296 1
.else
d1320 1
a1320 1
#
d1461 1
a1461 1
BULK_TARGETS?=
d1480 1
a1480 1
${_EXTRACT_COOKIE}: ${_WRKDIR_COOKIE}
d1561 1
a1561 1
.  if target(do-distpatch) || target(post-distpatch) || defined(PATCHFILES)
d1563 1
a1563 1
.  endif
d1662 1
a1662 1
	echo ""
d1741 20
d1790 1
a1790 1
.endif
d1821 1
a1821 1
	    ${SUDO} ${MAKE} clean=package; \
d1830 1
d1833 1
d1854 32
d1902 7
d1911 1
d1914 11
a1924 11
.for _l in FTP CDROM
.  if ${PERMIT_PACKAGE_${_l}:L} == "yes"
	@@echo "Link to ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}"
	@@mkdir -p ${${_l}_PACKAGES}
	@@rm -f ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
	@@ln ${PKGFILE${SUBPACKAGE}} \
	  ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX} 2>/dev/null || \
	  cp -p ${PKGFILE${SUBPACKAGE}} \
	  ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
.  endif
.endfor
d1926 1
d1928 2
a1929 3
.for _l in FTP CDROM
	@@rm -f ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
.endfor
d1931 1
d1933 3
a1935 1
	@@cd ${.CURDIR} && exec ${MAKE} clean=package
d1941 1
d1944 1
d1981 3
a1983 2
clean:
.if ${clean:L:Mdepends}
d1985 1
a1985 1
.endif
d1987 1
a1987 1
.if ${clean:L:Mfake}
d1989 3
a1991 3
.endif
.if ${clean:L:Mwork}
.  if ${clean:L:Mflavors}
d1996 1
a1996 1
.  else
d1999 1
d2001 1
a2001 2
.endif
.if ${clean:L:Mdist}
d2008 3
a2010 2
.  if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
	-@@rmdir ${FULLDISTDIR}
d2012 3
a2014 4
.endif
.if ${clean:L:Minstall}
.  if ${clean:L:Msub}
.    for _s in ${MULTI_PACKAGES}
d2016 2
a2017 2
.    endfor
.  else
d2019 1
d2021 1
a2021 2
.endif
.if ${clean:L:Mpackages} || ${clean:L:Mpackage} && ${clean:L:Msub}
d2023 2
a2024 4
.  if defined(MULTI_PACKAGES)
.    for _s in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' exec ${MAKE} delete-package-links
.    endfor
d2026 1
a2026 5
.elif ${clean:L:Mpackage}
	@@cd ${.CURDIR} && exec ${MAKE} delete-package-links
	rm -f ${PKGFILE${SUBPACKAGE}}
.endif
.if ${clean:L:Mbulk}
d2028 1
d2031 1
a2031 1
distclean:
d2068 1
a2068 1

d2140 1
d2142 1
a2142 2

# The README.html target needs full information (this is passed via
d2155 1
a2155 1
.  endif
d2157 1
a2157 1
# Internal variables, used by dependencies targets
d2192 1
d2194 1
a2194 1
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || !empty(_RUN_DEP)
d2202 1
d2277 1
a2277 1
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP)
d2280 1
a2280 1
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
d2309 1
d2311 1
a2311 1
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP)
d2316 1
d2319 1
d2321 1
a2321 1
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
d2326 1
d2330 1
d2332 1
a2332 1
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || !empty(_RUN_DEP)
d2342 2
a2343 2
	done
.else
d2345 1
d2348 1
d2350 1
a2350 1
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP)
d2359 2
a2360 1
	done
d2364 1
d2366 1
a2366 1
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
d2377 1
a2377 1
.else
d2379 1
d2402 1
d2404 1
a2404 1
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
d2414 1
d2431 1
a2431 1
	done
d2448 1
a2448 1
	done
d2483 1
a2483 1
	done
d2500 1
a2500 1
	done
d2567 6
a2572 1
readme readmes:
d2575 2
d2580 2
a2581 1
print-depends:
d2583 14
d2619 1
a2619 1

d2644 1
a2644 1
   delete-package delete-package-links depends depends-list \
d2648 1
d2656 1
a2656 1
   repackage run-depends uninstall fetch-all print-depends \
d2658 1
a2658 1
   distpatch do-distpatch post-distpatch show \
@


1.1.1.7
log
@Import latest OpenBSD ports, XFree and source in sync
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.564 2003/07/25 12:46:26 espie Exp $
d41 3
d398 3
a400 2
${_WRKDIR_COOKIE} ${_DEPlib_COOKIES} ${_DEPbuild_COOKIES} \
${_DEPrun_COOKIES} ${_DEPregress_COOKIES}
d454 2
a455 2
PATCH_ARGS?=	-d ${WRKDIST} -z ${PATCHORIG} -E ${PATCH_STRIP}
PATCH_DIST_ARGS?=	-z ${DISTORIG} -d ${WRKDIST} -E ${PATCH_DIST_STRIP}
d457 2
a458 2
PATCH_ARGS?=	-d ${WRKDIST} -z ${PATCHORIG} --forward --quiet -E ${PATCH_STRIP}
PATCH_DIST_ARGS?=	-z ${DISTORIG} -d ${WRKDIST} --forward --quiet -E ${PATCH_DIST_STRIP}
a941 14

FETCH_MANUALLY?=No
.if ${FETCH_MANUALLY:L} != "no"
_ALLFILES_PRESENT=Yes
.  for _F in ${ALLFILES:S@@^@@${FULLDISTDIR}@@}
.    if !exists(${_F})
_ALLFILES_PRESENT=No
.    endif
.  endfor
.  if ${_ALLFILES_PRESENT:L} == "no"
IS_INTERACTIVE=Yes
.  endif
.endif

d1088 1
a1088 1
_build_depends_fragment= \
d1092 4
a1095 2
_run_depends_fragment=${_build_depends_fragment}
_regress_depends_fragment=${_build_depends_fragment}
d1126 9
a1134 1
depends: lib-depends build-depends run-depends regress-depends
d1141 1
a1141 1
.for _DEP in build run lib regress
d1271 1
a1271 1
fetch:
d1381 1
a1381 1
patch: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} \
d1383 1
a1383 1
distpatch: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} \
d1385 1
a1385 1
configure: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} \
d1387 1
a1387 1
all build: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} \
d1425 1
a1425 1
	@@cd ${.CURDIR} && exec ${MAKE} checksum build-depends lib-depends
a1760 6
.  if ${FETCH_MANUALLY:L} != "no"
.    for _M in ${FETCH_MANUALLY}
	@@echo "*** ${_M}"
.    endfor
	@@exit 1
.  else
a1773 1
.  endif
d2040 4
a2043 2
.if defined(LIB_DEPENDS)
_ALWAYS_DEP2 = ${LIB_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
d2046 1
d2060 3
a2062 2
.if defined(BUILD_DEPENDS)
_BUILD_DEP2 = ${BUILD_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
d2070 2
d2073 1
a2073 1
_clean-depends:
d2076 5
a2080 6
	for dir in ${_ALWAYS_DEP} ${_RUN_DEP} ${_BUILD_DEP}; do \
		if fgrep -q "|$$dir|" $${_DEPENDS_FILE}; then :; else \
			echo "|$$dir|" >>$${_DEPENDS_FILE}; \
			${_flavor_fragment}; \
			eval $$toset ${MAKE} CLEANDEPENDS=No ${_DEPEND_THRU} clean _clean-depends; \
		fi; \
a2083 8
clean-depends:
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || !empty(_RUN_DEP)
	@@: $${_DEPENDS_FILE:=`mktemp /tmp/depends.XXXXXXXXXX`}; \
	export _DEPENDS_FILE; \
	${MAKE} _clean-depends; \
	rm -f $${_DEPENDS_FILE}
.endif

d2492 2
a2493 2
   fetch install lib-depends makesum \
   package package-depends package-links package-name \
@


1.1.1.8
log
@Import OpenBSD CVS repository (checked out) of roughly 12:00 UTC today,
retrieved from the canadian anoncvs server (due to CTM unavailability)
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.584 2003/08/15 00:04:45 espie Exp $
d47 2
d50 11
d133 1
a133 6
# need to go through an extra var because clean is set in stone, 
# on the cmdline.
_clean=${clean}
.if empty(_clean) || ${_clean:L} == "depends"
_clean+=work
.endif
d135 1
a135 1
_clean+=depends
d137 2
a138 2
.if ${_clean:L:Mwork}
_clean+=fake
d140 2
a141 2
.if ${_clean:L:Mforce}
_clean+=-f
a363 1
_SYSTRACE_COOKIE=	${WRKDIR}/systrace.policy
d525 1
a525 1
	@@cd ${.CURDIR} && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS}
d539 1
a539 1
	@@cd ${.CURDIR} && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS}
d548 5
a552 1
.include "${PORTSDIR}/infrastructure/mk/pkgpath.mk"
d554 1
a590 23
# setup systrace
USE_SYSTRACE?=	No
NO_SYSTRACE?=	No
.if ${USE_SYSTRACE:L} == "yes" && ${NO_SYSTRACE:L} == "no"
_SYSTRACE_CMD?=	/bin/systrace -i -a -f ${_SYSTRACE_COOKIE}
.else
_SYSTRACE_CMD=
.endif
SYSTRACE_FILTER?=		${PORTSDIR}/infrastructure/db/systrace.filter
_SYSTRACE_POLICIES+=	/bin/sh /usr/bin/env /usr/bin/make \
	${LOCALBASE}/bin/gmake
SYSTRACE_SUBST_VARS+=	WRKOBJDIR PORTSDIR DISTDIR
.for _v in ${SYSTRACE_SUBST_VARS}
_SYSTRACE_SED_SUBST+=-e 's,$${${_v}},${${_v}},g'
.endfor

${_SYSTRACE_COOKIE}:
	@@rm -f $@@
.for _i in ${_SYSTRACE_POLICIES}
	@@echo "Policy: ${_i}, Emulation: native" >> $@@
	@@sed ${_SYSTRACE_SED_SUBST} ${SYSTRACE_FILTER} >> $@@
.endfor

d673 2
a674 7
	@@mkdir -p ${WRKPKG}
	@@>$@@
.if (defined(RUN_DEPENDS) && !empty(RUN_DEPENDS)) || (!defined(NO_SHARED_LIBS) && defined(LIB_DEPENDS) && !empty(LIB_DEPENDS))
	@@${_depfile_fragment}; \
	echo "|${FULLPKGNAME${SUBPACKAGE}}|" >>$${_DEPENDS_FILE}; \
	self=${FULLPKGNAME${SUBPACKAGE}} _depends_result=$@@ ${MAKE} _recurse-solve-package-depends
.endif
d692 1
d726 1
a726 1
PKG_ARGS+=		-S ${WRKINST}
d750 3
a788 2
.  else
_SITE_SELECTOR+=*:${_I}) echo >&2 "Error: MASTER_SITES${_I} not defined";;
d826 1
a826 1
.if make(makesum) || make(addsum) || defined(__FETCH_ALL)
d942 1
a942 1
.  for _F in ${ALLFILES:S@@^@@${FULLDISTDIR}/@@}
d1057 38
d1099 1
a1099 1
	if pkg dependencies check "$$pkg"; then \
a1137 1
_FULL_PACKAGE_NAME?=No
a1138 3
.if ${_FULL_PACKAGE_NAME:L} == "yes"
	@@echo '${PKGPATH}/${FULLPKGNAME${SUBPACKAGE}}'
.else
a1139 1
.endif
d1181 1
a1181 1
			if eval $$toset ${MAKE} $$target; then \
d1235 1
a1235 1
uninstall deinstall fake package lib-depends-check manpages-check license-check:
d1250 1
a1250 3
	@@${_depfile_fragment}; \
	LIB_DEPENDS="`${MAKE} _recurse-lib-depends-check`" \
	PKG_DBDIR='${PKG_DBDIR}' \
d1343 1
a1343 1
		  	cd ${.CURDIR} && ${MAKE} _refetch _PROBLEMS="$$list"; \
d1355 1
a1355 1
_refetch:
d1357 3
a1359 3
	@@rm ${DISTDIR}/${file}
	@@cd ${.CURDIR} && exec ${MAKE} ${DISTDIR}/${file} \
		MASTER_SITE_OVERRIDE="ftp://ftp.openbsd.org/pub/OpenBSD/distfiles/${cipher}/${value}/"
d1411 1
a1411 1
	@@cd ${.CURDIR} && exec ${MAKE} ${_i} ${BULK_FLAGS}
d1413 1
a1413 1
	@@cd ${.CURDIR} && exec ${SUDO} ${MAKE} clean
d1424 1
a1424 1
${_EXTRACT_COOKIE}: ${_WRKDIR_COOKIE} ${_SYSTRACE_COOKIE}
d1428 1
a1428 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} pre-extract
d1430 3
a1432 8
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} do-extract
.if target(post-extract)
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} post-extract
.endif
	@@${_MAKE_COOKIE} $@@

.if !target(do-extract)
do-extract:
d1442 5
d1551 1
a1551 2
	cd ${WRKBUILD} && ${_SYSTRACE_CMD} ${SETENV} \
		CC="${CC}" ac_cv_path_CC="${CC}" CFLAGS="${CFLAGS}" \
d1566 1
a1566 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} pre-configure
d1569 1
a1569 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} do-configure
d1573 2
a1574 2
		cd ${.CURDIR} &&  ${_SYSTRACE_CMD} ${SETENV} \
			${SCRIPTS_ENV} ${SH} ${SCRIPTDIR}/configure; \
d1584 1
a1584 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} post-configure
d1609 1
a1609 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} pre-build
d1612 1
a1612 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} do-build
d1615 1
a1615 1
	@@cd ${WRKBUILD} && exec ${_SYSTRACE_CMD} ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} -f ${MAKE_FILE} ${ALL_TARGET}
d1619 1
a1619 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} post-build
d1669 1
a1669 1
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} ${MAKE} pre-fake ${_FAKE_SETUP}
d1673 1
a1673 1
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} ${MAKE} pre-install ${_FAKE_SETUP}
d1676 1
a1676 1
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} ${MAKE} do-install ${_FAKE_SETUP}
d1679 1
a1679 1
	@@cd ${WRKBUILD} && exec ${SUDO} ${_SYSTRACE_CMD} ${SETENV} ${MAKE_ENV} ${_FAKE_SETUP} ${MAKE_PROGRAM} ${FAKE_FLAGS} -f ${MAKE_FILE} ${FAKE_TARGET}
d1683 1
a1683 1
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} ${MAKE} post-install ${_FAKE_SETUP}
d1743 1
a1743 1
	    ${MAKE} _package-links; \
d1783 16
d1801 2
a1802 2
_package-links:
	@@cd ${.CURDIR} && exec ${MAKE} _delete-package-links
d1815 1
a1815 1
_delete-package-links:
d1820 43
a1864 2
_CLEANDEPENDS?=Yes

d1866 3
a1868 7
.if ${_clean:L:Mdepends} && ${_CLEANDEPENDS:L} == "yes"
	@@${MAKE} all-dir-depends|tsort -r|while read dir; do \
		unset FLAVOR SUBPACKAGE || true; \
		${_flavor_fragment}; \
		eval $$toset ${MAKE} _CLEANDEPENDS=No clean; \
	done
.else
d1870 1
a1870 1
.  if ${_clean:L:Mfake}
d1872 3
a1874 3
.  endif
.  if ${_clean:L:Mwork}
.    if ${_clean:L:Mflavors}
d1879 1
a1879 1
.    else
a1881 1
.    endif
d1883 2
a1884 1
.  if ${_clean:L:Mdist}
d1891 1
a1891 1
.    if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
a1892 1
.    endif
d1894 4
a1897 3
.  if ${_clean:L:Minstall}
.    if ${_clean:L:Msub}
.      for _s in ${MULTI_PACKAGES}
d1899 2
a1900 2
.      endfor
.    else
a1901 1
.    endif
d1903 2
a1904 1
.  if ${_clean:L:Mpackages} || ${_clean:L:Mpackage} && ${_clean:L:Msub}
d1906 7
a1912 7
.    if defined(MULTI_PACKAGES)
.      for _s in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' exec ${MAKE} _delete-package-links
.      endfor
.    endif
.  elif ${_clean:L:Mpackage}
	@@cd ${.CURDIR} && exec ${MAKE} _delete-package-links
d1914 2
a1915 8
.  endif
.  if ${_clean:L:Mreadmes}
	rm -f ${.CURDIR}/${FULLPKGNAME}.html
.      for _s in ${MULTI_PACKAGES}
	rm -f ${.CURDIR}/${FULLPKGNAME${_s}}.html
.      endfor
.  endif
.  if ${_clean:L:Mbulk}
a1916 1
.  endif
d1919 3
d1940 1
a1940 1
	DEPS="`${MAKE} full-run-depends`" \
a1969 7
_FMN=${PKGPATH}/${FULLPKGNAME}
.if defined(MULTI_PACKAGES)
.  for _S in ${MULTI_PACKAGES}
_FMN+= ${PKGPATH}/${FULLPKGNAME${_S}}
.  endfor
.endif

d1979 2
a1980 9
	@@echo ":: ${_FMN}"
# write generic package dependencies
	@@echo ".PHONY: ${_FMN}"
.  if ${RECURSIVE_FETCH_LIST:L} == "yes"
	@@echo "${_FMN}: ${_ALLFILES} "`_FULL_PACKAGE_NAME=Yes ${MAKE} full-all-depends`
.  else
	@@echo "${_FMN}: ${_ALLFILES}"
.  endif
	@@exec ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes NO_IGNORE=Yes _fetch-makefile
d1983 8
a1990 1
_fetch-makefile:
d2030 15
d2074 20
d2102 1
a2102 1
.if defined(MULTI_PACKAGES) && !defined(PACKAGING)
a2103 5
.  if empty(SUBPACKAGE)
.    for _sub in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' PACKAGING='${_sub}' exec ${MAKE} describe
.    endfor
.  endif
d2156 1
a2156 8
.endif

README_NAME?=	${TEMPLATES}/README.port

readmes:
.if defined(MULTI_PACKAGES) && !defined(PACKAGING)
	@@cd ${.CURDIR} && SUBPACKAGE='${SUBPACKAGE}' FLAVOR='${FLAVOR}' PACKAGING='${SUBPACKAGE}' exec ${MAKE} readmes
.  if empty(SUBPACKAGE)
d2158 1
a2158 1
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' PACKAGING='${_sub}' exec ${MAKE} readmes
a2160 3
.else
	@@rm -f ${FULLPKGNAME${SUBPACKAGE}}.html
	@@cd ${.CURDIR} && exec ${MAKE} README_NAME=${README_NAME} ${FULLPKGNAME${SUBPACKAGE}}.html
d2164 1
a2164 2
${FULLPKGNAME${SUBPACKAGE}}.html:
	@@echo ${_COMMENT} | ${HTMLIFY} >$@@.tmp-comment
d2166 6
d2177 3
a2179 21
.if defined(MULTI_PACKAGES) 
.  if empty(SUBPACKAGE)
	@@echo "<h2>Subpackages</h2>" >$@@.tmp-subpackages
	@@echo "<ul>" >>$@@.tmp-subpackages

.    for _S in ${MULTI_PACKAGES}
	@@name=`SUBPACKAGE=${_S} ${MAKE} _print-packagename _FULL_PACKAGE_NAME=No`; \
	echo "<li><a href=\"$$name.html\">$$name</a>" >>$@@.tmp-subpackages
.    endfor
	@@echo "</ul>" >>$@@.tmp-subpackages
.  else
	@@name=`unset SUBPACKAGE; ${MAKE} _print-packagename _FULL_PACKAGE_NAME=No`; \
	echo "<h2>Subpackage of <a href=\"$$name.html\">$$name</a></h2>" >$@@.tmp-subpackages
.  endif
.else
	@@>$@@.tmp-subpackages
.endif
.for _I in build run
.  if !empty(_ALWAYS_DEP) || !empty(_${_I:U}_DEP)
	@@cd ${.CURDIR} && ${MAKE} full-${_I}-depends _FULL_PACKAGE_NAME=Yes| \
		while read n; do \
d2181 5
a2185 5
			echo "<li><a href=\"${PKGDEPTH}$$j/$$k.html\">$$k</a>"; \
		 done  >$@@.tmp-${_I}
.  else
	@@echo "<li>none" >$@@.tmp-${_I}
.  endif
d2188 1
a2188 1
		sed -e 's|%%PORT%%|'"`echo ${FULLPKGPATH}  | ${HTMLIFY}`"'|g' \
d2190 2
a2191 2
			-e '/%%COMMENT%%/r$@@.tmp-comment' -e '//d' \
			-e '/%%DESCR%%/r${PKGDIR}/DESCR${SUBPACKAGE}' -e '//d' \
d2193 2
a2194 3
			-e '/%%BUILD_DEPENDS%%/r$@@.tmp-build' -e '//d' \
			-e '/%%RUN_DEPENDS%%/r$@@.tmp-run' -e '//d' \
 			-e '/%%SUBPACKAGES%%/r$@@.tmp-subpackages' -e '//d' \
d2198 1
a2198 2

print-build-depends:
d2201 2
a2202 1
	@@${MAKE} full-build-depends|tr '\012' '\040'|sed -e 's, $$,,'
d2206 1
a2206 1
print-run-depends:
d2209 2
a2210 1
	@@${MAKE} full-run-depends|tr '\012' '\040'|sed -e 's, $$,,'
d2214 7
a2220 4
.for _i in build all run
full-${_i}-depends:
	@@${MAKE} ${_i}-dir-depends|tsort -r|sed -e '$$d'|while read dir; do \
		unset FLAVOR SUBPACKAGE || true; \
d2222 4
a2225 1
		eval $$toset ${MAKE} _print-packagename ; \
d2227 3
a2229 1
.endfor
d2231 5
a2235 4
license-check:
.if ${PERMIT_PACKAGE_CDROM:L} == "yes" || ${PERMIT_PACKAGE_FTP:L} == "yes"
	@@${MAKE} all-dir-depends|tsort -r|sed -e '$$d'|while read dir; do \
		unset FLAVOR SUBPACKAGE || true; \
d2237 4
a2240 4
		_MASTER_PERMIT_CDROM=${PERMIT_PACKAGE_CDROM:Q}; \
		_MASTER_PERMIT_FTP=${PERMIT_PACKAGE_FTP:Q}; \
		export _MASTER_PERMIT_CDROM _MASTER_PERMIT_FTP; \
		eval $$toset ${MAKE} _license-check; \
d2244 6
a2249 16
_license-check:
.for _i in FTP CDROM
.  if defined(_MASTER_PERMIT_${_i}) && ${_MASTER_PERMIT_${_i}:L} == "yes" && ${PERMIT_PACKAGE_${_i}:L} != "yes"
	@@echo >&2 "Warning: dependency ${PKGPATH} is not allowed for ${_i}"
.  endif
.endfor

.for _i in RUN BUILD LIB
${_i:L}-depends-list:
.  if !empty(_${_i}_DEP2)
	@@unset FLAVOR SUBPACKAGE || true; \
	: $${_INITIAL_ECHO:='echo -n "This port requires \""'}; \
	: $${_ECHO='echo -n'}; \
	: $${_FINAL_ECHO:='echo "\" for ${_i:L}."'}; space=''; \
	eval $${_INITIAL_ECHO}; \
	for spec in `echo '${_${_i}_DEP2}' \
d2251 9
a2259 5
		$${_ECHO} "$$space$${spec}"; \
		space=' '; \
	done; eval $${_FINAL_ECHO}
.  endif
.endfor
d2261 2
a2262 4
# recursive depend targets

# Print list of all libraries that we may depend upon.
_recurse-lib-depends-check:
d2267 1
d2269 1
a2269 5
		if fgrep -q "|$$dir|" $${_DEPENDS_FILE}; then :; else \
			echo "|$$dir|" >>$${_DEPENDS_FILE}; \
			${_flavor_fragment}; \
			eval $$toset ${MAKE} _recurse-lib-depends-check; \
		fi; \
d2276 2
a2277 5
		if fgrep -q "|$$dir|" $${_DEPENDS_FILE}; then :; else \
			echo "|$$dir|" >>$${_DEPENDS_FILE}; \
			${_flavor_fragment}; \
			eval $$toset ${MAKE} _recurse-lib-depends-check; \
		fi; \
d2281 2
a2282 4

# Write a correct list of dependencies for packages.
_recurse-solve-package-depends:
.for _i in ${RUN_DEPENDS}
d2284 2
a2285 2
	echo '${_i}' |{ \
		IFS=:; read dep pkg dir target; \
d2287 10
a2296 14
		default=`eval $$toset ${MAKE} _print-packagename`; \
		: $${pkg:=$$default}; \
		echo "@@newdepend $$self:$$pkg:$$default" >>$${_depends_result}; \
		if fgrep -q "|$$default|" $${_DEPENDS_FILE}; then : ; else \
			echo "|$$default|" >>$${_DEPENDS_FILE}; \
			toset="$$toset self=\"$$default\""; \
			if ! eval $$toset ${MAKE} _recurse-solve-package-depends; then  \
				echo 1>&2 "*** Problem checking deps in \"$$dir\"." ; \
				exit 1; \
			fi; \
		fi; }
.endfor
.if !defined(NO_SHARED_LIBS)
.  for _i in ${LIB_DEPENDS}
d2298 4
a2301 2
	echo '${_i}'|{ \
		IFS=:; read dep pkg dir target; \
d2303 4
a2306 8
		libspecs='';comma=''; \
		default=`eval $$toset ${MAKE} _print-packagename`; \
		case "X$$pkg" in X) pkg=`echo $$default|sed -e 's,-[0-9].*,-*,'`;; esac; \
		if pkg dependencies check $$pkg; then \
			listlibs='ls $$shdir 2>/dev/null'; \
		else \
			eval $$toset ${MAKE} ${PKGREPOSITORY}/$$default.tgz; \
			listlibs='pkg_info -L ${PKGREPOSITORY}/$$default.tgz|grep $$shdir|sed -e "s,^$$shdir/,,"'; \
d2308 1
a2308 27
		IFS=,; for d in $$dep; do \
			${_libresolve_fragment}; \
			case "$$check" in \
			*.a) continue;; \
			Missing\ library|Error:*) \
				echo 1>&2 "Can't resolve libspec $$d"; \
				exit 1;; \
			*) \
				libspecs="$$libspecs$$comma$$shprefix$$check"; \
				comma=',';; \
			esac; \
		done; \
		case "X$$libspecs" in \
		X) ;;\
		*) \
			echo "@@libdepend $$self:$$libspecs:$$pkg:$$default" >>$${_depends_result}; \
			if ! fgrep -q "|$$default|" $${_DEPENDS_FILE}; then \
				echo "lib|$$default|" >>$${_DEPENDS_FILE}; \
				toset="$$toset self=\"$$default\""; \
				if ! eval $$toset ${MAKE} _recurse-solve-package-depends; then  \
					echo 1>&2 "*** Problem checking deps in \"$$dir\"." ; \
					exit 1; \
				fi; \
			fi;; \
		esac; \
	}
.  endfor
d2311 3
a2313 3
# recursively build a list of dirs for package running, ready for tsort
_recurse-run-dir-depends:
.for _dir in ${_ALWAYS_DEP} ${_RUN_DEP}
d2315 4
a2318 4
	echo "$$self ${_dir}"; \
	if ! fgrep -q "|${_dir}|" $${_DEPENDS_FILE}; then \
		echo "|${_dir}|" >> $${_DEPENDS_FILE}; \
		dir=${_dir}; \
d2320 2
a2321 2
		toset="$$toset self=\"${_dir}\""; \
		if ! eval $$toset ${MAKE} _recurse-run-dir-depends; then  \
d2325 1
a2325 10
	fi
.endfor

run-dir-depends:
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
	@@${_depfile_fragment}; \
	if ! fgrep -q "|${FULLPKGPATH}|" $${_DEPENDS_FILE}; then \
		echo "|${FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
		self=${FULLPKGPATH} ${MAKE} _recurse-run-dir-depends; \
	fi
d2330 3
a2332 4
# recursively build a list of dirs for package building, ready for tsort
# second and further stages need _RUN_DEP.
_recurse-all-dir-depends:
.for _dir in ${_ALWAYS_DEP} ${_BUILD_DEP} ${_RUN_DEP}
d2334 20
a2353 4
	echo "$$self ${_dir}"; \
	if ! fgrep -q "|${_dir}|" $${_DEPENDS_FILE}; then \
		echo "|${_dir}|" >> $${_DEPENDS_FILE}; \
		dir=${_dir}; \
d2355 2
a2356 2
		toset="$$toset self=\"${_dir}\""; \
		if ! eval $$toset ${MAKE} _recurse-all-dir-depends; then  \
d2360 2
a2361 2
	fi
.endfor
d2363 3
a2365 3
# first stage does not need _RUN_DEP
_build-dir-depends:
.for _dir in ${_ALWAYS_DEP} ${_BUILD_DEP}
d2367 4
a2370 4
	echo "$$self ${_dir}"; \
	if ! fgrep -q "|${_dir}|" $${_DEPENDS_FILE}; then \
		echo "|${_dir}|" >> $${_DEPENDS_FILE}; \
		dir=${_dir}; \
d2372 2
a2373 2
		toset="$$toset self=\"${_dir}\""; \
		if ! eval $$toset ${MAKE} _recurse-all-dir-depends; then  \
d2377 1
a2377 10
	fi
.endfor

build-dir-depends:
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP)
	@@${_depfile_fragment}; \
	if ! fgrep -q "|${FULLPKGPATH}|" $${_DEPENDS_FILE}; then \
		echo "|${FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
		self=${FULLPKGPATH} ${MAKE} _build-dir-depends; \
	fi
d2382 58
a2439 9
all-dir-depends:
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || !empty(_RUN_DEP)
	@@${_depfile_fragment}; \
	if ! fgrep -q "|${FULLPKGPATH}|" $${_DEPENDS_FILE}; then \
		echo "|${FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
		self=${FULLPKGPATH} ${MAKE} _recurse-all-dir-depends; \
	fi
.else
	@@echo "${FULLPKGPATH} ${FULLPKGPATH}"
d2442 11
a2485 32
#####################################################
# convenience targets, not really needed
#####################################################

checkpatch:
	@@cd ${.CURDIR} && exec ${MAKE} PATCH_CHECK_ONLY=Yes patch

clean-depends:
	@@cd ${.CURDIR} && exec ${MAKE} clean=depends

distclean:
	@@cd ${.CURDIR} && exec ${MAKE} clean=dist

delete-package:
	@@cd ${.CURDIR} && exec ${MAKE} clean=package

reinstall:
	@@cd ${.CURDIR} && exec ${MAKE} clean=install
	@@cd ${.CURDIR} && DEPENDS_TARGET=${DEPENDS_TARGET} exec ${MAKE} install

repackage:
	@@cd ${.CURDIR} && exec ${MAKE} clean=packages
	@@cd ${.CURDIR} && exec ${MAKE} package

rebuild:
	@@rm -f ${_BUILD_COOKIE}
	@@cd ${.CURDIR} && exec ${MAKE} build

uninstall deinstall:
	@@${ECHO_MSG} "===> Deinstalling for ${FULLPKGNAME${SUBPACKAGE}}"
	@@${SUDO} ${PKG_DELETE} -f ${FULLPKGNAME${SUBPACKAGE}}

d2497 21
a2517 35
	_build-dir-depends _delete-package-links _fetch-makefile \
	_package _package-links _print-packagename \
	_recurse-all-dir-depends _recurse-lib-depends-check \ 
	_recurse-run-dir-depends _recurse-solve-package-depends _refetch \
	addsum \
	all all-dir-depends build \
	build-depends build-depends-list build-dir-depends \
	checkpatch checksum clean \
	clean-depends configure deinstall \
	delete-package \
	depends \
	describe distclean distpatch \
	do-build do-configure do-distpatch \
	do-extract do-fetch do-install \
	do-package do-regress extract \
	fake fetch fetch-all \
	fetch-makefile full-all-depends full-build-depends \
	full-run-depends homepage-links install \
	lib-depends lib-depends-check lib-depends-list \
	link-categories makesum manpages-check \
	package patch \
	plist post-build post-configure \
	post-distpatch post-extract post-fetch \
	post-install post-package post-patch \
	post-regress pre-build pre-configure \
	pre-extract pre-fake pre-fetch \
	pre-install pre-package pre-patch \
	pre-regress print-build-depends print-run-depends \
	readmes rebuild \
	regress regress-depends \
	reinstall repackage run-depends \
	run-depends-list run-dir-depends show \
	uninstall unlink-categories update-patches \
	update-plist \
	license-check _license-check
@


1.1.1.9
log
@Pull in a bit of current OpenBSD, to the least
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.585 2003/08/21 20:22:45 espie Exp $
d97 1
a462 6

.if defined(FAKEOBJDIR)
WRKINST?=	${FAKEOBJDIR}/${PKGNAME}${_FLAVOR_EXT2}
.else
WRKINST?=	${WRKDIR}/fake-${ARCH}${_FLAVOR_EXT2}
.endif
@


1.1.1.10
log
@Synchronize with OpenBSD 3.4-beta
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.587 2003/08/28 23:42:44 naddy Exp $
d1834 1
a1834 1
	-${SUDO} ${PKG_DELETE} ${_clean:M-f} ${FULLPKGNAME${_s}}
d1837 1
a1837 1
	-${SUDO} ${PKG_DELETE} ${_clean:M-f} ${FULLPKGNAME${SUBPACKAGE}}
a1948 3
.    if ${FETCH_MANUALLY:L} != "no"
	@@echo '\t FETCH_MANUALLY="Yes" \\'
.    endif
d2425 1
a2425 1
	@@cd ${.CURDIR} && exec ${MAKE} clean='install force'
@


1.1.1.11
log
@OpenBSD-current ports tree; with a few security fixes too.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.588 2003/09/28 10:57:01 espie Exp $
d2315 1
a2315 1
		self=${FULLPKGPATH} PACKAGING='${SUBPACKAGE}' ${MAKE} _recurse-run-dir-depends; \
@


1.1.1.12
log
@By request of bsiegert@@, import OpenBSD ports tree again.
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.589 2003/11/22 12:03:44 espie Exp $
d1677 4
d1722 7
@


1.1.1.13
log
@Now we can update MirPorts from OpenBSD ports tree again,
that we have fixed pkg_install tools accordingly in both
stable and current, and that these tools are compatible.

Consider MirPorts locked until next commit of ports/INDEX,v
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.599 2004/01/11 15:04:01 sturm Exp $
a62 51
# User settings
TRUST_PACKAGES?=No
BIN_PACKAGES?=No
CLEANDEPENDS?=No
USE_SYSTRACE?=	No
BULK?=No
RECURSIVE_FETCH_LIST?=	Yes

# special purpose user settings
PATCH_CHECK_ONLY?=No
REFETCH?=false

# Constants used by the ports tree
ARCH!=	uname -m
OPSYS=	OpenBSD
OPSYS_VER=	${OSREV}

NO_SHARED_ARCHS=hppa m88k vax

# Define NO_SHARED_LIBS for those machines that don't support shared libraries.
.for _m in ${MACHINE_ARCH}
.  if !empty(NO_SHARED_ARCHS:M${_m})
NO_SHARED_LIBS=	Yes
.  endif
.endfor

# Global path locations.
PORTSDIR?=		/usr/ports
LOCALBASE?=		/usr/local
X11BASE?=		/usr/X11R6
DISTDIR?=		${PORTSDIR}/distfiles
BULK_COOKIES_DIR?= ${PORTSDIR}/bulk/${MACHINE_ARCH}
TEMPLATES?=		${PORTSDIR}/infrastructure/templates

PKGREPOSITORYBASE?=	${PORTSDIR}/packages/${MACHINE_ARCH}
PKGREPOSITORY?=		${PKGREPOSITORYBASE}/all
CDROM_PACKAGES?=	${PKGREPOSITORYBASE}/cdrom
FTP_PACKAGES?=		${PKGREPOSITORYBASE}/ftp

# Commands and command settings.
PKG_DBDIR?=		/var/db/pkg

FETCH_CMD?=		/usr/bin/ftp -V -m

PKG_TMPDIR?=	/var/tmp
PKG_CMD?=		/usr/sbin/pkg_create
PKG_DELETE?=	/usr/sbin/pkg_delete

# remount those mount points ro before fake.
# XXX tends to panic the OS
PROTECT_MOUNT_POINTS?=
d95 2
d101 18
d140 2
a141 1
.elif exists(${.CURDIR}/Makefile.${MACHINE_ARCH})
d144 1
d150 7
d162 5
d183 1
a183 1
.  if exists(${.CURDIR}/scripts.${MACHINE_ARCH})
d185 1
a185 1
.  else
d187 1
a187 1
.  endif
d248 4
d333 3
d432 2
d449 1
a510 4
###
### Variable setup that can happen after modules
###

d521 11
d535 7
d544 4
d584 2
a585 1
# setup systrace variables
d588 1
a588 1
_SYSTRACE_CMD?=	/bin/systrace -e -i -a -f ${_SYSTRACE_COOKIE}
d595 1
a595 1
SYSTRACE_SUBST_VARS+=	WRKDIR PORTSDIR DISTDIR
d600 7
d650 7
d663 34
d700 14
d723 2
d729 2
d735 2
d741 2
a747 3
.if !defined(_COMMENT)
ERRORS+="Fatal: Missing comment."
.endif
d944 10
a953 301
# Passed to configure invocations, and user scripts
SCRIPTS_ENV+= CURDIR=${.CURDIR} DISTDIR=${DISTDIR} \
          PATH=${PORTPATH} WRKDIR=${WRKDIR} WRKDIST=${WRKDIST} \
		  WRKSRC=${WRKSRC} WRKBUILD=${WRKBUILD} \
		  PATCHDIR=${PATCHDIR} SCRIPTDIR=${SCRIPTDIR} FILESDIR=${FILESDIR} \
		  PORTSDIR=${PORTSDIR} DEPENDS="${DEPENDS}" \
		  PREFIX=${PREFIX} LOCALBASE=${LOCALBASE} X11BASE=${X11BASE}

.if defined(BATCH)
SCRIPTS_ENV+=	BATCH=yes
.endif

USE_X11?=No

FETCH_MANUALLY?=No
.if ${FETCH_MANUALLY:L} != "no"
_ALLFILES_PRESENT=Yes
.  for _F in ${ALLFILES:S@@^@@${FULLDISTDIR}/@@}
.    if !exists(${_F})
_ALLFILES_PRESENT=No
.    endif
.  endfor
.  if ${_ALLFILES_PRESENT:L} == "no"
IS_INTERACTIVE=Yes
.  endif
.endif

################################################################
# Many ways to disable a port.
#
# If we're in BATCH mode and the port is interactive, or we're
# in interactive mode and the port is non-interactive, skip all
# the important targets.  The reason we have two modes is that
# one might want to leave a build in BATCH mode running
# overnight, then come back in the morning and do _only_ the
# interactive ones that required your intervention.
#
# Ignore ports that can't be resold if building for a CDROM.
#
# Don't build a port if it's broken.
#
# Don't build a port if it comes with the base system.
################################################################

.if !defined(NO_IGNORE)
.  if (defined(REGRESS_IS_INTERACTIVE) && defined(BATCH))
_IGNORE_REGRESS=	"has interactive tests"
.  elif (!defined(REGRESS_IS_INTERACTIVE) && defined(INTERACTIVE))
_IGNORE_REGRESS=	"does not have interactive tests"
.  endif
.  if (defined(IS_INTERACTIVE) && defined(BATCH))
IGNORE=	"is an interactive port"
.  elif (!defined(IS_INTERACTIVE) && defined(INTERACTIVE))
IGNORE=	"is not an interactive port"
.  elif ${USE_X11:L} == "yes" && !exists(${X11BASE})
IGNORE=	"uses X11, but ${X11BASE} not found"
.  elif defined(BROKEN)
IGNORE=	"is marked as broken: ${BROKEN}"
.  elif defined(ONLY_FOR_ARCHS)
.    for __ARCH in ${MACHINE_ARCH} ${ARCH}
.      if !empty(ONLY_FOR_ARCHS:M${__ARCH})
_ARCH_OK=1
.      endif
.    endfor
.    if !defined(_ARCH_OK)
.      if ${MACHINE_ARCH} == "${ARCH}"
IGNORE= "is only for ${ONLY_FOR_ARCHS}, not ${MACHINE_ARCH}"
.      else
IGNORE= "is only for ${ONLY_FOR_ARCHS}, not ${MACHINE_ARCH} \(${ARCH}\)"
.      endif
.    endif
.  elif defined(NOT_FOR_ARCHS)
.    for __ARCH in ${MACHINE_ARCH} ${ARCH}
.      if !empty(NOT_FOR_ARCHS:M${__ARCH})
IGNORE= "is not for ${NOT_FOR_ARCHS}"
.      endif
.    endfor
.  endif
.  if !defined(IGNORE) && defined(COMES_WITH)
.    if ( ${OPSYS_VER} >= ${COMES_WITH} )
IGNORE= "-- ${FULLPKGNAME${SUBPACKAGE}:C/-[0-9].*//g} comes with ${OPSYS} as of release ${COMES_WITH}"
.    endif
.  endif

.endif		# NO_IGNORE


.if !defined(DEPENDS_TARGET)
.  if make(reinstall)
DEPENDS_TARGET=	reinstall
.  else
DEPENDS_TARGET=	install
.  endif
.endif

################################################################
# Dependency checking
################################################################

# Various dependency styles

_build_depends_fragment= \
	if pkg dependencies check "$$pkg"; then \
		found=true; \
	fi
_run_depends_fragment=${_build_depends_fragment}
_regress_depends_fragment=${_build_depends_fragment}

.if defined(NO_SHARED_LIBS)
_noshared=-noshared
.else
_noshared=
.endif

_libresolve_fragment = \
		case "$$d" in \
		*/*) shprefix="$${d%/*}/"; shdir="${LOCALBASE}/$${d%/*}"; \
			d=$${d\#\#*/};; \
		*) shprefix="" shdir="${LOCALBASE}/lib";; \
		esac; \
		check=`eval $$listlibs| perl \
			${PORTSDIR}/infrastructure/build/resolve-lib ${_noshared} $$d` \
			|| true


_lib_depends_fragment = \
	what=$$dep; \
	IFS=,; bad=false; for d in $$dep; do \
		listlibs='ls $$shdir 2>/dev/null'; \
		${_libresolve_fragment}; \
		case "$$check" in \
		Missing\ library) bad=true; msg="$$msg $$d missing...";; \
		Error:*) bad=true; msg="$$msg $$d unsolvable...";; \
		esac; \
	done; $$bad || found=true

_FULL_PACKAGE_NAME?=No

.for _DEP in build run lib regress
_DEP${_DEP}_COOKIES=
.  if defined(${_DEP:U}_DEPENDS) && ${NO_DEPENDS:L} == "no"
.    for _i in ${${_DEP:U}_DEPENDS}
_DEP${_DEP}_COOKIES+=${WRKDIR}/.${_DEP}${_i:C,[|:./<=>*],-,g}
.    endfor
.  endif
.endfor

# Normal user-mode targets are PHONY targets, e.g., don't create the
# corresponding file. However, there is nothing phony about the cookie.

_INSTALL_DEPS=${_INSTALL_COOKIE}
_PACKAGE_DEPS=${_PACKAGE_COOKIES}
.if defined(ALWAYS_PACKAGE)
_INSTALL_DEPS+=${_PACKAGE_COOKIES}
.endif
.if ${BULK:L} == "yes"
_INSTALL_DEPS+=${_BULK_COOKIE}
_PACKAGE_DEPS+=${_BULK_COOKIE}
.endif

BULK_TARGETS?=

MODSIMPLE_configure= \
	cd ${WRKBUILD} && ${_SYSTRACE_CMD} ${SETENV} \
		CC="${CC}" ac_cv_path_CC="${CC}" CFLAGS="${CFLAGS}" \
		CXX="${CXX}" ac_cv_path_CXX="${CXX}" CXXFLAGS="${CXXFLAGS}" \
		INSTALL="/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}" \
		ac_given_INSTALL="/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}" \
		INSTALL_PROGRAM="${INSTALL_PROGRAM}" INSTALL_MAN="${INSTALL_MAN}" \
		INSTALL_SCRIPT="${INSTALL_SCRIPT}" INSTALL_DATA="${INSTALL_DATA}" \
		YACC="${YACC}" \
		${CONFIGURE_ENV} ${_CONFIGURE_SCRIPT} ${CONFIGURE_ARGS}

VMEM_WARNING?=	No

_FAKE_SETUP=TRUEPREFIX=${PREFIX} PREFIX=${WRKINST}${PREFIX} ${DESTDIRNAME}=${WRKINST}

_CLEANDEPENDS?=Yes

_tmpvars:=
.  for _v in ${SUBST_VARS}
_tmpvars += ${_v}='${${_v}}'
.  endfor

# mirroring utilities
.if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
_ALLFILES=${ALLFILES:S/^/${DIST_SUBDIR}\//}
.else
_ALLFILES=${ALLFILES}
.endif

_FMN=${PKGPATH}/${FULLPKGNAME}
.if defined(MULTI_PACKAGES)
.  for _S in ${MULTI_PACKAGES}
_FMN+= ${PKGPATH}/${FULLPKGNAME${_S}}
.  endfor
.endif

# Internal variables, used by dependencies targets
# Only keep pkg:dir spec
.if defined(LIB_DEPENDS)
_ALWAYS_DEP2 = ${LIB_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_ALWAYS_DEP= ${_ALWAYS_DEP2:C/[^:]*://}
.else
_ALWAYS_DEP2=
_ALWAYS_DEP=
.endif

.if defined(RUN_DEPENDS)
_RUN_DEP2 = ${RUN_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_RUN_DEP = ${_RUN_DEP2:C/[^:]*://}
.else
_RUN_DEP2=
_RUN_DEP=
.endif


.if defined(BUILD_DEPENDS)
_BUILD_DEP2 = ${BUILD_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_BUILD_DEP = ${_BUILD_DEP2:C/[^:]*://}
.else
_BUILD_DEP2=
_BUILD_DEP=
.endif

_LIB_DEP2= ${LIB_DEPENDS}

README_NAME?=	${TEMPLATES}/README.port

.include "${PORTSDIR}/infrastructure/mk/pkgpath.mk"

###
### end of variable setup. Only targets now
###

.if ${BIN_PACKAGES:L} == "yes"
${_PACKAGE_COOKIE}:
	@@cd ${.CURDIR} && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS}
.else
${_PACKAGE_COOKIE}: ${_PACKAGE_COOKIE_DEPS}
.endif
	@@cd ${.CURDIR} && SUBPACKAGE='' FLAVOR='${FLAVOR}' PACKAGING='' exec ${MAKE} _package
.if !defined(PACKAGE_NOINSTALL)
	@@${_MAKE_COOKIE} $@@
.endif

.for _s in ${MULTI_PACKAGES}
.  if ${BIN_PACKAGES:L} == "yes"
${_PACKAGE_COOKIE${_s}}:
	@@cd ${.CURDIR} && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS}
.  else
${_PACKAGE_COOKIE${_s}}: ${_PACKAGE_COOKIE_DEPS}
.  endif
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' FLAVOR='${FLAVOR}' PACKAGING='${_s}' exec ${MAKE} _package
.endfor

.PRECIOUS: ${_PACKAGE_COOKIES} ${_INSTALL_COOKIE}

${_SYSTRACE_COOKIE}:
	@@rm -f $@@
.for _i in ${_SYSTRACE_POLICIES}
	@@echo "Policy: ${_i}, Emulation: native" >> $@@
	@@sed ${_SYSTRACE_SED_SUBST} ${SYSTRACE_FILTER} >> $@@
.endfor


# create the packing stuff from source
${WRKPKG}/COMMENT${SUBPACKAGE}:
	@@echo ${_COMMENT} >$@@

${WRKPKG}/PLIST${SUBPACKAGE}: ${PLIST} ${WRKPKG}/depends${SUBPACKAGE}
	@@echo "@@comment subdir=${FULLPKGPATH} cdrom=${PERMIT_PACKAGE_CDROM:L} ftp=${PERMIT_PACKAGE_FTP:L}" >$@@.tmp
	@@sort -u <${WRKPKG}/depends${SUBPACKAGE}>>$@@.tmp
.if defined(NO_SHARED_LIBS)
	@@sed -e '/^!%%SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' \
		-e '/^%%!SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' \
		-e '//d' -e '/^%%SHARED%%$$/d' <${PLIST} \
		${SED_PLIST} >>$@@.tmp && mv -f $@@.tmp $@@
.else
	@@if [ -x /sbin/ldconfig ]; then \
		sed -e '/^!%%SHARED%%$$/d' \
			-e '/^%%!SHARED%%$$/d' \
			-e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' \
			-e '//d' <${PLIST} ${SED_PLIST} \
			| sed -f ${LDCONFIG_SED_SCRIPT} >>$@@.tmp && mv -f $@@.tmp $@@; \
	else \
		sed -e '/^!%%SHARED%%$$/d' \
			-e '/^%%!SHARED%%$$/d' \
			-e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' \
			-e '//d' <${PLIST} \
			${SED_PLIST} >>$@@.tmp && mv -f $@@.tmp $@@; \
	fi
.endif

${WRKPKG}/depends${SUBPACKAGE}:
	@@mkdir -p ${WRKPKG}
	@@>$@@
.if (defined(RUN_DEPENDS) && !empty(RUN_DEPENDS)) || (!defined(NO_SHARED_LIBS) && defined(LIB_DEPENDS) && !empty(LIB_DEPENDS))
	@@${_depfile_fragment}; \
	echo "|${FULLPKGNAME${SUBPACKAGE}}|" >>$${_DEPENDS_FILE}; \
	self=${FULLPKGNAME${SUBPACKAGE}} _depends_result=$@@ ${MAKE} _solve-package-depends
d956 13
a968 5
${WRKPKG}/DESCR${SUBPACKAGE}: ${DESCR}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
	@@echo "\nMaintainer: ${MAINTAINER}" >>$@@
.if defined(HOMEPAGE)
	@@fgrep -q '$${HOMEPAGE}' $? || echo "\nWWW: ${HOMEPAGE}" >>$@@
d971 16
a986 2
${WRKPKG}/mtree.spec: ${MTREE_FILE}
	@@${_SED_SUBST} ${MTREE_FILE}>$@@.tmp && mv -f $@@.tmp $@@
d988 38
a1025 5
# substitute 
.for _subst_file in INSTALL DEINSTALL REQ
.  if exists(${PKGDIR}/${_subst_file}${SUBPACKAGE})
${WRKPKG}/${_subst_file}${SUBPACKAGE}: ${PKGDIR}/${_subst_file}${SUBPACKAGE}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
a1026 1
.endfor
d1028 9
a1036 3
.if defined(MESSAGE)
${WRKPKG}/MESSAGE${SUBPACKAGE}: ${MESSAGE}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
d1045 1
a1045 1
	    done
d1059 1
a1059 1
	    done
d1077 37
d1119 1
d1128 1
d1178 1
d1279 5
d1352 14
d1393 2
d1538 11
d1577 2
d1634 4
d1784 2
d1851 2
d1860 4
d1874 1
a1874 2
	OKAY_FILES='${_FAKE_COOKIE} ${_INSTALL_PRE_COOKIE}' \
	perl ${PORTSDIR}/infrastructure/install/make-plist ${PKGDIR} ${_tmpvars}
d1887 4
d1893 13
a1928 12
	@@if ! fgrep -q "|${_F}|" $${_DONE_FILES}; then \
		echo "|${_F}|" >>$${_DONE_FILES}; \
		${MAKE} _fetch-onefile _file=${_F}; \
	fi
.  endfor
.endif
	@@echo


_fetch-onefile:
# XXX loop so that M${_F} will work
.for _F in ${_file}
d1931 1
a1931 1
.  if defined(DIST_SUBDIR) && !empty(DIST_SUBDIR)
d1933 1
a1933 1
.  endif
d1938 1
a1938 1
.  if ${FETCH_MANUALLY:L} != "no"
d1940 2
a1941 2
.  endif
.  if !defined(NO_CHECKSUM) && !empty(_CKSUMFILES:M${_F})
d1962 1
a1962 1
.  endif
d1964 31
a1994 1
.endfor
d1996 1
d2067 2
d2199 1
a2199 1
		if ! fgrep -q "|$$dir|" $${_DEPENDS_FILE}; then \
d2210 1
a2210 1
		if ! fgrep -q "|$$dir|" $${_DEPENDS_FILE}; then \
d2220 1
a2220 1
_solve-package-depends:
d2228 9
a2236 1
		echo "@@newdepend $$self:$$pkg:$$default" >>$${_depends_result}; }
d2269 8
d2443 1
a2443 1
	_build-dir-depends _delete-package-links _fetch-makefile _fetch-onefile \
d2446 1
a2446 1
	_recurse-run-dir-depends _solve-package-depends _refetch \
@


1.1.1.14
log
@Improvements in the systrace infrastructure, again
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.600 2004/01/18 07:52:49 sturm Exp $
a1126 3
	@@if [ -f ${.CURDIR}/systrace.filter ]; then \
		cat ${.CURDIR}/systrace.filter >> $@@; \
	fi
@


1.1.1.15
log
@Import ports from OpenBSD CVS, 26.01.2004 17:25 CET
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.602 2004/01/22 21:28:49 espie Exp $
a109 5
.if ${MACHINE_ARCH} != ${ARCH}
PKG_ARCH?=${MACHINE_ARCH},${ARCH}
.else
PKG_ARCH?=${MACHINE_ARCH}
.endif
d321 1
a321 1
SED_PLIST+=|sed -e '/^!%%${_i}%%$$/r${PKGDIR}/PFRAG.no-${_i}${SUBPACKAGE}' -e '//d' -e '/^%%${_i}%%$$/d'
d327 1
a327 1
SED_PLIST+=|sed -e '/^!%%${_i}%%$$/d' -e '/^%%${_i}%%$$/r${PKGDIR}/PFRAG.${_i}${SUBPACKAGE}' -e '//d'
a665 1
PKG_ARGS+=-A'${PKG_ARCH}'
@


1.1.1.16
log
@Import OpenBSD ports again. This will give us lots of new toys :).
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.611 2004/02/07 22:36:13 espie Exp $
a69 3
WRKOBJDIR?=
FAKEOBJDIR?=
BULK_TARGETS?=
a101 9
# local path locations
.include "${PORTSDIR}/infrastructure/mk/pkgpath.mk"

WRKOBJDIR_${PKGPATH}?= ${WRKOBJDIR}
FAKEOBJDIR_${PKGPATH}?= ${FAKEOBJDIR}
BULK_${PKGPATH}?= ${BULK}
BULK_TARGETS_${PKGPATH}?= ${BULK_TARGETS}
CLEANDEPENDS_${PKGPATH}?= ${CLEANDEPENDS}

d143 1
a143 3
.  for _s in ${show}
	@@echo ${${_s}:Q}
.  endfor
d161 1
a161 1
.if ${CLEANDEPENDS_${PKGPATH}:L} == "yes"
a182 1
DIST_SUBDIR?=
d184 1
a184 1
.if !empty(DIST_SUBDIR)
d192 2
a193 1
.elif exists(${.CURDIR}/patches.${MACHINE_ARCH})
d198 1
d204 2
a205 1
.elif exists(${.CURDIR}/scripts.${MACHINE_ARCH})
d207 1
a207 1
.else
d209 1
d214 2
a215 1
.elif exists(${.CURDIR}/files.${MACHINE_ARCH})
d220 1
d224 2
a225 1
.elif exists(${.CURDIR}/pkg.${MACHINE_ARCH})
d230 1
d475 2
a476 2
.if !empty(FAKEOBJDIR_${PKGPATH})
WRKINST?=	${FAKEOBJDIR_${PKGPATH}}/${PKGNAME}${_FLAVOR_EXT2}
d481 1
a481 1
.if !empty(WRKOBJDIR_${PKGPATH})
d483 1
a483 1
WRKDIR?=		${WRKOBJDIR_${PKGPATH}}/${PKGNAME}
d485 1
a485 1
WRKDIR?=		${WRKOBJDIR_${PKGPATH}}/${PKGNAME}${_FLAVOR_EXT2}
a671 3
.if ${LOCALBASE} != "/usr/local"
PKG_ARGS+=-L${LOCALBASE}
.endif
d744 3
a746 1
CDROM_SITE?=	/cdrom/distfiles/${DIST_SUBDIR}
d748 1
a748 1
.if !empty(CDROM_SITE)
d795 1
a795 1
.if !empty(DIST_SUBDIR)
d1026 1
a1026 1
.if ${BULK_${PKGPATH}:L} == "yes"
d1031 2
d1056 1
a1056 1
.if !empty(DIST_SUBDIR)
d1100 2
a1306 1
_CHECK_LIBS_SCRIPT=${PORTSDIR}/infrastructure/install/check-libs
a1317 1
_CHECK_LIBS_SCRIPT=${PORTSDIR}/infrastructure/install/check-libs-elf
d1321 5
a1325 3
		sed -n \
			-e '/^ *NEEDED *\(.*\)\.so\.\([0-9][0-9]*\)\.\([0-9][0-9]*\)$$/s//\1 \2 \3/p' \
			-e '/^ *NEEDED *\(.*\)\.so$$/s//\1/p'| \
d1336 1
a1336 1
		egrep '(\.so\.|\.so$$)'|${SUDO} xargs file -L|fgrep 'shared'|cut -d\: -f1|sort -u >$@@
d1360 1
a1360 1
		perl ${_CHECK_LIBS_SCRIPT} \
d1497 1
a1497 1
.for _i in ${BULK_TARGETS_${PKGPATH}}
d1897 1
a1897 1
.    if !empty(DIST_SUBDIR)
d1904 1
a1904 1
	-${SUDO} ${PKG_DELETE} ${FULLPKGNAME${_s}}
d1907 1
a1907 1
	-${SUDO} ${PKG_DELETE} ${FULLPKGNAME${SUBPACKAGE}}
d2002 1
a2002 1
.  if !empty(DIST_SUBDIR)
d2452 1
a2452 1
	@@${SUDO} ${PKG_DELETE} ${FULLPKGNAME${SUBPACKAGE}}
@


1.1.1.17
log
@Import OpenBSD ports tree checked out from anoncvs.ca.openbsd.org at
2004-05-28 15:30 UTC.

Lots of SECURITY fixes, at least:

 * databases/mysql: tmpfile issue
 * www/squid: acl bypass
 * games/xonix: privilege escalation
 * archivers/lha: buffer overflow
 * mail/exim: buffer overflows
 * net/rsync: path checking issue
 * net/icecast: buffer overflow
 * www/opera
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.614 2004/05/16 23:14:44 pvalchev Exp $
a82 1
LP64_ARCHS=sparc64 alpha amd64
d1142 1
a1142 3
	@@if [ -f ${.CURDIR}/systrace.policy ]; then \
		sed ${_SYSTRACE_SED_SUBST} ${.CURDIR}/systrace.policy >> $@@; \
	fi
d1152 3
a1154 3
	@@sed -e '/^!%%SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' -e '//d' \
		-e '/^%%!SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' -e '//d' \
		-e '/^%%SHARED%%$$/d' <${PLIST} \
d1160 2
a1161 2
			-e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' -e '//d' \
			<${PLIST} ${SED_PLIST} \
d1166 2
a1167 2
			-e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' -e '//d' \
			<${PLIST} \
@


1.1.1.18
log
@current OpenBSD ports infrastructure
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.615 2004/05/31 12:27:07 sturm Exp $
a99 1
TMPDIR?=		/tmp
d596 1
a596 1
SYSTRACE_SUBST_VARS+=	WRKDIR PORTSDIR DISTDIR TMPDIR PKG_TMPDIR
@


1.1.1.19
log
@Bugfixes in the ports Infrastructure
@
text
@d3 1
a3 1
#	$OpenBSD: bsd.port.mk,v 1.617 2004/06/06 11:49:08 espie Exp $
d83 2
a84 2
LP64_ARCHS=alpha amd64 sparc64
NO_SHARED_ARCHS=m88k vax
a1107 1
REORDER_DEPENDENCIES?=
a1640 16
.if !empty(REORDER_DEPENDENCIES)
	sed -e '/^#/d' ${REORDER_DEPENDENCIES} | \
	  tsort -r|while read f; do \
	    cd ${WRKSRC}; \
		case $$f in \
		/*) \
			find . -name $${f#/} -print| while read i; \
				do echo "Touching $$i"; touch $$i; done \
			;; \
		*) \
			if test -e $$f ; then \
				echo "Touching $$f"; touch $$f; \
			fi \
			;; \
		esac; done
.endif
@


