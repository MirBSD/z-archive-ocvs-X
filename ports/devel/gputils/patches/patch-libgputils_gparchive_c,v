head	1.1;
branch	1.1.1;
access;
symbols
	cvs-200405281530:1.1.1.3
	cvs-200402211630:1.1.1.3
	cvs-200401261625:1.1.1.2
	cvs-200401162142:1.1.1.2
	cvs-200301141450:1.1.1.1
	cvs-200312021610:1.1.1.1
	cvs-200311151930:1.1.1.1
	openbsd:1.1.1;
locks; strict;
comment	@# @;


1.1
date	2003.11.15.19.59.46;	author tg;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2003.11.15.19.59.46;	author tg;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2004.01.16.22.09.11;	author tg;	state Exp;
branches;
next	1.1.1.3;

1.1.1.3
date	2004.02.21.17.02.08;	author bsiegert;	state Stab;
branches;
next	;


desc
@@


1.1
log
@Initial revision
@
text
@$OpenBSD: patch-libgputils_gparchive_c,v 1.1.1.1 2003/11/03 01:02:36 naddy Exp $
--- libgputils/gparchive.c.orig	2003-03-31 16:49:39.000000000 +1000
+++ libgputils/gparchive.c	2003-10-14 23:08:45.000000000 +1000
@@@@ -50,7 +50,7 @@@@ gp_archive_member_name(gp_archive_type *
   char name[256];
   char *end;
 
-  sscanf(archive->header.ar_name, "%s/", name);
+  sscanf(archive->header.ar_name, "%256s/", name);
   end = strchr(&name[0], '/');
   if (end != NULL) 
     *end = '\0';
@@@@ -73,7 +73,7 @@@@ gp_archive_list_members(gp_archive_type 
     archive = archive->next;
 
   while (archive != NULL) {
-    sscanf(archive->header.ar_name, "%s/", name);
+    sscanf(archive->header.ar_name, "%256s/", name);
     sscanf(archive->header.ar_date, "%il", &date);
     sscanf(archive->header.ar_size, "%il", &size);
     end = strchr(&name[0], '/');
@@@@ -99,7 +99,7 @@@@ gp_archive_find_member(gp_archive_type *
     archive = archive->next;
 
   while (archive != NULL) {
-    sscanf(archive->header.ar_name, "%s/", name);
+    sscanf(archive->header.ar_name, "%256s/", name);
     end = strrchr(&name[0], '/');
     if (end != NULL) 
       *end = '\0';
@@@@ -182,16 +182,16 @@@@ gp_archive_add_member(gp_archive_type *a
 
   timer = (int)time(NULL);
   
-  sprintf(name, "%s/", objectname);
-  sprintf(date, "%il", timer);
-  sprintf(size, "%lil", newobject->size);
+  snprintf(name, sizeof(name), "%s/", objectname);
+  snprintf(date, sizeof(date), "%il", timer);
+  snprintf(size, sizeof(size), "%lil", newobject->size);
 
   /* FIXME:  These functions over right the 0x20 that the header is filled 
      with. */ 
-  strncpy(&newmember->header.ar_name[0], &name[0], 256);
-  strncpy(&newmember->header.ar_date[0], &date[0], 12);
-  strncpy(&newmember->header.ar_size[0], &size[0], 10);
-  strncpy(&newmember->header.ar_fmag[0], ARMAG, 2);
+  strlcpy(newmember->header.ar_name, &name[0], sizeof(newmember->header.ar_name));
+  strlcpy(newmember->header.ar_date, &date[0], sizeof(newmember->header.ar_date));
+  strlcpy(newmember->header.ar_size, &size[0], sizeof(newmember->header.ar_size));
+  strlcpy(newmember->header.ar_fmag, ARMAG, sizeof(newmember->header.ar_fmag));
 
   oldmember = gp_archive_find_member(archive, objectname);
   
@@@@ -230,9 +230,9 @@@@ gp_archive_extract_member(gp_archive_typ
   /* if the object doesn't have an extension, add one.  This is done for
      some libs generated with other tools.  It should not be necessary
      for libs generated by gplib. */
-  strcpy(filename, objectname);
+  strlcpy(filename, objectname, sizeof(filename));
   if (strrchr(filename, '.') == NULL)
-    strcat(filename, ".o");
+    strlcat(filename, ".o", sizeof(filename));
 
   output_file = fopen(filename, "wb");
   if (output_file == NULL) {
@@@@ -412,7 +412,7 @@@@ gp_archive_make_index(gp_archive_type *a
     archive = archive->next;
         
   while (archive != NULL) {
-    sscanf(archive->header.ar_name, "%s/", name);
+    sscanf(archive->header.ar_name, "%256s/", name);
     end = strchr(&name[0], '/');
     if (end != NULL) 
       *end = '\0';
@@@@ -460,17 +460,25 @@@@ gp_archive_add_index(struct symbol_table
 
   /* create a new member for the index and place it in the archive */
   newmember = (gp_archive_type *)malloc(sizeof(*newmember));
+  if (!newmember) {
+    err(1, NULL);
+    exit(1);
+  }
   newmember->file = (char *)malloc(sizeof(char)*indexsize);
+  if(!newmember->file) {
+    err(1, NULL);
+    exit(1);
+  }
   newmember->next = NULL;  
 
   /* fill in the archive header */
   memset(&newmember->header, 0x20, AR_HDR_SIZ); /* fill the header with space */
 
   newmember->header.ar_name[0] = '/';
-  sprintf(size, "%lil", indexsize);
+  snprintf(size, sizeof(size), "%lil", indexsize);
 
-  strncpy(&newmember->header.ar_size[0], &size[0], 10);
-  strncpy(&newmember->header.ar_fmag[0], ARMAG, 2);
+  strlcpy(newmember->header.ar_size, &size[0], sizeof(newmember->header.ar_size));
+  strlcpy(newmember->header.ar_fmag, ARMAG, sizeof(newmember->header.ar_fmag));
 
   newmember->next = archive;
   archive = newmember;
@@@@ -601,7 +609,7 @@@@ gp_archive_print_table(struct symbol_tab
     member = get_symbol_annotation(lst[i]);
     assert(member != NULL);
     /* determine the archive member name */
-    sscanf(member->header.ar_name, "%s/", name);
+    sscanf(member->header.ar_name, "%256s/", name);
     end = strchr(&name[0], '/');
     if (end != NULL) 
       *end = '\0';
@


1.1.1.1
log
@Import the OpenBSD ports tree into the MirPorts Framework again, in order
to introduce recent security fixes.
@
text
@@


1.1.1.2
log
@Another sync. Mostly for infrastructure fixes.
But I'm "just" at it, so...
@
text
@d1 1
a1 1
$OpenBSD: patch-libgputils_gparchive_c,v 1.2 2004/01/14 22:19:29 naddy Exp $
d3 1
a3 1
+++ libgputils/gparchive.c	2003-11-23 12:55:02.000000000 +1100
d105 1
a105 14
@@@@ -493,8 +501,10 @@@@ gp_archive_add_index(struct symbol_table
 
   /* write the symbol names to the member */
   for (i = 0; i < table->count; i++) {
-    strcpy(ptr, get_symbol_name(lst[i]));
-    ptr += strlen(get_symbol_name(lst[i])) + 1;
+    const char*  symbol_name = get_symbol_name(lst[i]);
+    const size_t symbol_len  = strlen(symbol_name) + 1;
+    memcpy(ptr, symbol_name, symbol_len);
+    ptr += symbol_len;
   }
   
   return archive;
@@@@ -601,7 +611,7 @@@@ gp_archive_print_table(struct symbol_tab
@


1.1.1.3
log
@Import OpenBSD ports again. This will give us lots of new toys :).
@
text
@d1 3
a3 3
$OpenBSD: patch-libgputils_gparchive_c,v 1.4 2004/02/14 15:09:44 avsm Exp $
--- libgputils/gparchive.c.orig	2004-01-09 08:10:37.000000000 +0000
+++ libgputils/gparchive.c	2004-02-13 20:02:41.000000000 +0000
d9 1
a9 1
+  sscanf(archive->header.ar_name, "%255s/", name);
d18 1
a18 1
+    sscanf(archive->header.ar_name, "%255s/", name);
d27 1
a27 1
+    sscanf(archive->header.ar_name, "%255s/", name);
d31 1
a31 1
@@@@ -183,16 +183,16 @@@@ gp_archive_add_member(gp_archive_type *a
d55 1
a55 1
@@@@ -231,9 +231,9 @@@@ gp_archive_extract_member(gp_archive_typ
d67 1
a67 1
@@@@ -413,7 +413,7 @@@@ gp_archive_make_index(gp_archive_type *a
d72 1
a72 1
+    sscanf(archive->header.ar_name, "%255s/", name);
d76 1
a76 1
@@@@ -461,17 +461,25 @@@@ gp_archive_add_index(struct symbol_table
d105 1
a105 1
@@@@ -494,8 +502,10 @@@@ gp_archive_add_index(struct symbol_table
d118 1
a118 1
@@@@ -602,7 +612,7 @@@@ gp_archive_print_table(struct symbol_tab
d123 1
a123 1
+    sscanf(member->header.ar_name, "%255s/", name);
@


